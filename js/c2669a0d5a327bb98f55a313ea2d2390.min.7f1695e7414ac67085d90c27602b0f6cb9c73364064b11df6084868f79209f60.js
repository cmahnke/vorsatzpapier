/*! Bundled license information:

openseadragon/build/openseadragon/openseadragon.js:
  (*! openseadragon 5.0.1 *)
  (*! Built on 2024-12-09 *)
  (*! Git commit: v5.0.1-0-480de92d *)
  (*! http://openseadragon.github.io *)
  (*! License: http://openseadragon.github.io/license/ *)
*/(()=>{j4=Object.create,Us=Object.defineProperty,pl=Object.getOwnPropertyDescriptor,Rc=Object.getOwnPropertyNames,jl=Object.getPrototypeOf,_l=Object.prototype.hasOwnProperty,Is=(e,t)=>function(){return t||(0,e[Rc(e)[0]])((t={exports:{}}).exports,t),t.exports},xl=(e,t)=>{for(var n in t)Us(e,n,{get:t[n],enumerable:!0})},kl=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Rc(t))!_l.call(e,o)&&o!==n&&Us(e,o,{get:()=>t[o],enumerable:!(s=pl(t,o))||s.enumerable});return e},Oc=(e,t,n)=>(n=e!=null?j4(jl(e)):{},kl(t||!e||!e.__esModule?Us(n,"default",{value:e,enumerable:!0}):n,e)),Qs=Is({"node_modules/openseadragon/build/openseadragon/openseadragon.js"(e,t){function n(e){return new n.Viewer(e)}(function(e){e.version={versionStr:"5.0.1",major:parseInt("5",10),minor:parseInt("0",10),revision:parseInt("1",10)};var s={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object AsyncFunction]":"function","[object Promise]":"promise","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},o=Object.prototype.toString,t=Object.prototype.hasOwnProperty;e.isFunction=function(t){return e.type(t)==="function"},e.isArray=Array.isArray||function(t){return e.type(t)==="array"},e.isWindow=function(e){return e&&typeof e=="object"&&"setInterval"in e},e.type=function(e){return e==null?String(e):s[o.call(e)]||"object"},e.isPlainObject=function(s){if(!s||n.type(s)!=="object"||s.nodeType||e.isWindow(s))return!1;if(s.constructor&&!t.call(s,"constructor")&&!t.call(s.constructor.prototype,"isPrototypeOf"))return!1;var o,i;for(i in s)o=i;return o===0[0]||t.call(s,o)},e.isEmptyObject=function(e){for(var t in e)return!1;return!0},e.freezeObject=function(t){return Object.freeze?e.freezeObject=Object.freeze:e.freezeObject=function(e){return e},e.freezeObject(t)},e.supportsCanvas=function(){var t=document.createElement("canvas");return!!(e.isFunction(t.getContext)&&t.getContext("2d"))}(),e.isCanvasTainted=function(e){var t=!1;try{e.getContext("2d").getImageData(0,0,1,1)}catch{t=!0}return t},e.supportsAddEventListener=function(){return!!(document.documentElement.addEventListener&&document.addEventListener)}(),e.supportsRemoveEventListener=function(){return!!(document.documentElement.removeEventListener&&document.removeEventListener)}(),e.supportsEventListenerOptions=function(){var n,t=0;if(e.supportsAddEventListener)try{n={get capture(){return t++,!1},get once(){return t++,!1},get passive(){return t++,!1}},window.addEventListener("test",null,n),window.removeEventListener("test",null,n)}catch{t=0}return t>=3}(),e.getCurrentPixelDensityRatio=function(){if(e.supportsCanvas){var t=document.createElement("canvas").getContext("2d"),n=window.devicePixelRatio||1,s=t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;return Math.max(n,1)/s}return 1},e.pixelDensityRatio=e.getCurrentPixelDensityRatio()})(n),function(e){e.extend=function(){var s,o,i,r,c,l,d,t=arguments[0]||{},h=arguments.length,u=!1,a=1;for(typeof t=="boolean"&&(u=t,t=arguments[1]||{},a=2),typeof t!="object"&&!n.isFunction(t)&&(t={}),h===a&&(t=this,--a);a<h;a++)if(c=arguments[a],c!==null||c!==0[0])for(o in c){if(r=Object.getOwnPropertyDescriptor(c,o),r!==0[0]){if(r.get||r.set){Object.defineProperty(t,o,r);continue}s=r.value}else{e.console.warn('Could not copy inherited property "'+o+'".');continue}if(t===s)continue;u&&s&&(n.isPlainObject(s)||(l=n.isArray(s)))?(i=t[o],l?(l=!1,d=i&&n.isArray(i)?i:[]):d=i&&n.isPlainObject(i)?i:{},t[o]=n.extend(u,d,s)):s!==0[0]&&(t[o]=s)}return t},s=function(){if(typeof navigator!="object")return!1;var e=navigator.userAgent;return typeof e=="string"&&(e.indexOf("iPhone")!==-1||e.indexOf("iPad")!==-1||e.indexOf("iPod")!==-1)},e.extend(e,{DEFAULT_SETTINGS:{xmlPath:null,tileSources:null,tileHost:null,initialPage:0,crossOriginPolicy:!1,ajaxWithCredentials:!1,loadTilesWithAjax:!1,ajaxHeaders:{},splitHashDataForPost:!1,panHorizontal:!0,panVertical:!0,constrainDuringPan:!1,wrapHorizontal:!1,wrapVertical:!1,visibilityRatio:.5,minPixelRatio:.5,defaultZoomLevel:0,minZoomLevel:null,maxZoomLevel:null,homeFillsViewer:!1,clickTimeThreshold:300,clickDistThreshold:5,dblClickTimeThreshold:300,dblClickDistThreshold:20,springStiffness:6.5,animationTime:1.2,gestureSettingsMouse:{dragToPan:!0,scrollToZoom:!0,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsTouch:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!0,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsPen:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsUnknown:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!1,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},zoomPerClick:2,zoomPerScroll:1.2,zoomPerDblClickDrag:1.2,zoomPerSecond:1,blendTime:0,alwaysBlend:!1,autoHideControls:!0,immediateRender:!1,minZoomImageRatio:.9,maxZoomPixelRatio:1.1,smoothTileEdgesMinZoom:1.1,iOSDevice:s(),pixelsPerWheelLine:40,pixelsPerArrowPress:40,autoResize:!0,preserveImageSizeOnResize:!1,minScrollDeltaTime:50,rotationIncrement:90,maxTilesPerFrame:1,showSequenceControl:!0,sequenceControlAnchor:null,preserveViewport:!1,preserveOverlays:!1,navPrevNextWrap:!1,showNavigationControl:!0,navigationControlAnchor:null,showZoomControl:!0,showHomeControl:!0,showFullPageControl:!0,showRotationControl:!1,showFlipControl:!1,controlsFadeDelay:2e3,controlsFadeLength:1500,mouseNavEnabled:!0,showNavigator:!1,navigatorElement:null,navigatorId:null,navigatorPosition:null,navigatorSizeRatio:.2,navigatorMaintainSizeRatio:!1,navigatorTop:null,navigatorLeft:null,navigatorHeight:null,navigatorWidth:null,navigatorAutoResize:!0,navigatorAutoFade:!0,navigatorRotate:!0,navigatorBackground:"#000",navigatorOpacity:.8,navigatorBorderColor:"#555",navigatorDisplayRegionColor:"#900",degrees:0,flipped:!1,overlayPreserveContentDirection:!0,opacity:1,compositeOperation:null,drawer:["webgl","canvas","html"],drawerOptions:{webgl:{},canvas:{},html:{},custom:{}},preload:!1,imageSmoothingEnabled:!0,placeholderFillStyle:null,subPixelRoundingForTransparency:null,showReferenceStrip:!1,referenceStripScroll:"horizontal",referenceStripElement:null,referenceStripHeight:null,referenceStripWidth:null,referenceStripPosition:"BOTTOM_LEFT",referenceStripSizeRatio:.2,collectionRows:3,collectionColumns:0,collectionLayout:"horizontal",collectionMode:!1,collectionTileSize:800,collectionTileMargin:80,imageLoaderLimit:0,maxImageCacheCount:200,timeout:3e4,tileRetryMax:0,tileRetryDelay:2500,prefixUrl:"/images/",navImages:{zoomIn:{REST:"zoomin_rest.png",GROUP:"zoomin_grouphover.png",HOVER:"zoomin_hover.png",DOWN:"zoomin_pressed.png"},zoomOut:{REST:"zoomout_rest.png",GROUP:"zoomout_grouphover.png",HOVER:"zoomout_hover.png",DOWN:"zoomout_pressed.png"},home:{REST:"home_rest.png",GROUP:"home_grouphover.png",HOVER:"home_hover.png",DOWN:"home_pressed.png"},fullpage:{REST:"fullpage_rest.png",GROUP:"fullpage_grouphover.png",HOVER:"fullpage_hover.png",DOWN:"fullpage_pressed.png"},rotateleft:{REST:"rotateleft_rest.png",GROUP:"rotateleft_grouphover.png",HOVER:"rotateleft_hover.png",DOWN:"rotateleft_pressed.png"},rotateright:{REST:"rotateright_rest.png",GROUP:"rotateright_grouphover.png",HOVER:"rotateright_hover.png",DOWN:"rotateright_pressed.png"},flip:{REST:"flip_rest.png",GROUP:"flip_grouphover.png",HOVER:"flip_hover.png",DOWN:"flip_pressed.png"},previous:{REST:"previous_rest.png",GROUP:"previous_grouphover.png",HOVER:"previous_hover.png",DOWN:"previous_pressed.png"},next:{REST:"next_rest.png",GROUP:"next_grouphover.png",HOVER:"next_hover.png",DOWN:"next_pressed.png"}},debugMode:!1,debugGridColor:["#437AB2","#1B9E77","#D95F02","#7570B3","#E7298A","#66A61E","#E6AB02","#A6761D","#666666"],silenceMultiImageWarnings:!1},delegate:function(e,t){return function(){var n=arguments;return n===0[0]&&(n=[]),t.apply(e,n)}},BROWSERS:{UNKNOWN:0,IE:1,FIREFOX:2,SAFARI:3,CHROME:4,OPERA:5,EDGE:6,CHROMEEDGE:7},SUBPIXEL_ROUNDING_OCCURRENCES:{NEVER:0,ONLY_AT_REST:1,ALWAYS:2},_viewers:new Map,getViewer:function(t){return e._viewers.get(this.getElement(t))},getElement:function(e){return typeof e=="string"&&(e=document.getElementById(e)),e},getElementPosition:function(t){var s,o,n=new e.Point;for(t=e.getElement(t),s=e.getElementStyle(t).position==="fixed",o=a(t,s);o;)n.x+=t.offsetLeft,n.y+=t.offsetTop,s&&(n=n.plus(e.getPageScroll())),t=o,s=e.getElementStyle(t).position==="fixed",o=a(t,s);return n},getElementOffset:function(t){t=e.getElement(t);var s,o,n=t&&t.ownerDocument,i={top:0,left:0};return n?(s=n.documentElement,typeof t.getBoundingClientRect!="undefined"&&(i=t.getBoundingClientRect()),o=n===n.window?n:n.nodeType===9&&(n.defaultView||n.parentWindow),new e.Point(i.left+(o.pageXOffset||s.scrollLeft)-(s.clientLeft||0),i.top+(o.pageYOffset||s.scrollTop)-(s.clientTop||0))):new e.Point},getElementSize:function(t){return t=e.getElement(t),new e.Point(t.clientWidth,t.clientHeight)},getElementStyle:document.documentElement.currentStyle?function(t){return t=e.getElement(t),t.currentStyle}:function(t){return t=e.getElement(t),window.getComputedStyle(t,"")},getCssPropertyWithVendorPrefix:function(t){var n={};return e.getCssPropertyWithVendorPrefix=function(t){if(n[t]!==0[0])return n[t];var o,i,a,c,r=document.createElement("div").style,s=null;if(r[t]!==0[0])s=t;else for(i=["Webkit","Moz","MS","O","webkit","moz","ms","o"],c=e.capitalizeFirstLetter(t),o=0;o<i.length;o++)if(a=i[o]+c,r[a]!==0[0]){s=a;break}return n[t]=s,s},e.getCssPropertyWithVendorPrefix(t)},capitalizeFirstLetter:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},positiveModulo:function(e,t){var n=e%t;return n<0&&(n+=t),n},pointInElement:function(t,n){t=e.getElement(t);var s=e.getElementOffset(t),o=e.getElementSize(t);return n.x>=s.x&&n.x<s.x+o.x&&n.y<s.y+o.y&&n.y>=s.y},getMousePosition:function(t){if(typeof t.pageX=="number")e.getMousePosition=function(t){var n=new e.Point;return n.x=t.pageX,n.y=t.pageY,n};else if(typeof t.clientX=="number")e.getMousePosition=function(t){var n=new e.Point;return n.x=t.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,n.y=t.clientY+document.body.scrollTop+document.documentElement.scrollTop,n};else throw new Error("Unknown event mouse position, no known technique.");return e.getMousePosition(t)},getPageScroll:function(){var t=document.documentElement||{},n=document.body||{};if(typeof window.pageXOffset=="number")e.getPageScroll=function(){return new e.Point(window.pageXOffset,window.pageYOffset)};else if(n.scrollLeft||n.scrollTop)e.getPageScroll=function(){return new e.Point(document.body.scrollLeft,document.body.scrollTop)};else if(t.scrollLeft||t.scrollTop)e.getPageScroll=function(){return new e.Point(document.documentElement.scrollLeft,document.documentElement.scrollTop)};else return new e.Point(0,0);return e.getPageScroll()},setPageScroll:function(t){if(typeof window.scrollTo!="undefined")e.setPageScroll=function(e){window.scrollTo(e.x,e.y)};else{var s,n=e.getPageScroll();if(n.x===t.x&&n.y===t.y)return;if(document.body.scrollLeft=t.x,document.body.scrollTop=t.y,s=e.getPageScroll(),s.x!==n.x&&s.y!==n.y){e.setPageScroll=function(e){document.body.scrollLeft=e.x,document.body.scrollTop=e.y};return}if(document.documentElement.scrollLeft=t.x,document.documentElement.scrollTop=t.y,s=e.getPageScroll(),s.x!==n.x&&s.y!==n.y){e.setPageScroll=function(e){document.documentElement.scrollLeft=e.x,document.documentElement.scrollTop=e.y};return}e.setPageScroll=function(){}}e.setPageScroll(t)},getWindowSize:function(){var t=document.documentElement||{},n=document.body||{};if(typeof window.innerWidth=="number")e.getWindowSize=function(){return new e.Point(window.innerWidth,window.innerHeight)};else if(t.clientWidth||t.clientHeight)e.getWindowSize=function(){return new e.Point(document.documentElement.clientWidth,document.documentElement.clientHeight)};else if(n.clientWidth||n.clientHeight)e.getWindowSize=function(){return new e.Point(document.body.clientWidth,document.body.clientHeight)};else throw new Error("Unknown window size, no known technique.");return e.getWindowSize()},makeCenteredNode:function(t){t=e.getElement(t);var n=[e.makeNeutralElement("div"),e.makeNeutralElement("div"),e.makeNeutralElement("div")];return e.extend(n[0].style,{display:"table",height:"100%",width:"100%"}),e.extend(n[1].style,{display:"table-row"}),e.extend(n[2].style,{display:"table-cell",verticalAlign:"middle",textAlign:"center"}),n[0].appendChild(n[1]),n[1].appendChild(n[2]),n[2].appendChild(t),n[0]},makeNeutralElement:function(e){var n=document.createElement(e),t=n.style;return t.background="transparent none",t.border="none",t.margin="0px",t.padding="0px",t.position="static",n},now:function(){return Date.now?e.now=Date.now:e.now=function(){return(new Date).getTime()},e.now()},makeTransparentImage:function(t){var n=e.makeNeutralElement("img");return n.src=t,n},setElementOpacity:function(t,n,s){var o,i;t=e.getElement(t),s&&!e.Browser.alpha&&(n=Math.round(n)),e.Browser.opacity?t.style.opacity=n<1?n:"":n<1?(o=Math.round(100*n),i="alpha(opacity="+o+")",t.style.filter=i):t.style.filter=""},setElementTouchActionNone:function(t){t=e.getElement(t),typeof t.style.touchAction!="undefined"?t.style.touchAction="none":typeof t.style.msTouchAction!="undefined"&&(t.style.msTouchAction="none")},setElementPointerEvents:function(t,n){t=e.getElement(t),typeof t.style!="undefined"&&typeof t.style.pointerEvents!="undefined"&&(t.style.pointerEvents=n)},setElementPointerEventsNone:function(t){e.setElementPointerEvents(t,"none")},addClass:function(t,n){t=e.getElement(t),t.className?(" "+t.className+" ").indexOf(" "+n+" ")===-1&&(t.className+=" "+n):t.className=n},indexOf:function(e,t,n){return Array.prototype.indexOf?this.indexOf=function(e,t,n){return e.indexOf(t,n)}:this.indexOf=function(e,t,n){var s,i,o=n||0;if(!e)throw new TypeError;if(i=e.length,i===0||o>=i)return-1;o<0&&(o=i-Math.abs(o));for(s=o;s<i;s++)if(e[s]===t)return s;return-1},this.indexOf(e,t,n)},removeClass:function(t,n){var s,o,i=[];t=e.getElement(t),o=t.className.split(/\s+/);for(s=0;s<o.length;s++)o[s]&&o[s]!==n&&i.push(o[s]);t.className=i.join(" ")},normalizeEventListenerOptions:function(t){var n;return typeof t!="undefined"?typeof t=="boolean"?n=e.supportsEventListenerOptions?{capture:t}:t:n=e.supportsEventListenerOptions?t:typeof t.capture!="undefined"&&t.capture:n=!!e.supportsEventListenerOptions&&{capture:!1},n},addEvent:function(){if(e.supportsAddEventListener)return function(t,n,s,o){o=e.normalizeEventListenerOptions(o),t=e.getElement(t),t.addEventListener(n,s,o)};if(document.documentElement.attachEvent&&document.attachEvent)return function(t,n,s){t=e.getElement(t),t.attachEvent("on"+n,s)};throw new Error("No known event model.")}(),removeEvent:function(){if(e.supportsRemoveEventListener)return function(t,n,s,o){o=e.normalizeEventListenerOptions(o),t=e.getElement(t),t.removeEventListener(n,s,o)};if(document.documentElement.detachEvent&&document.detachEvent)return function(t,n,s){t=e.getElement(t),t.detachEvent("on"+n,s)};throw new Error("No known event model.")}(),cancelEvent:function(e){e.preventDefault()},eventIsCanceled:function(e){return e.defaultPrevented},stopEvent:function(e){e.stopPropagation()},createCallback:function(e,t){console.error("The createCallback function is deprecated and will be removed in future versions. Please use alternativeFunction instead.");var n,s=[];for(n=2;n<arguments.length;n++)s.push(arguments[n]);return function(){var n,o=s.concat([]);for(n=0;n<arguments.length;n++)o.push(arguments[n]);return t.apply(e,o)}},getUrlParameter:function(e){var t=i[e];return t||null},getUrlProtocol:function(e){var t=e.match(/^([a-z]+:)\/\//i);return t===null?window.location.protocol:t[1].toLowerCase()},createAjaxRequest:function(){if(window.XMLHttpRequest)return e.createAjaxRequest=function(){return new XMLHttpRequest},new XMLHttpRequest;throw new Error("Browser doesn't support XMLHttpRequest.")},makeAjaxRequest:function(t,n,s){e.isPlainObject(t)&&(n=t.success,s=t.error,l=t.withCredentials,i=t.headers,r=t.responseType||null,c=t.postData||null,t=t.url);var i,a,r,c,l,u,d=e.getUrlProtocol(t),o=e.createAjaxRequest();if(!e.isFunction(n))throw new Error("makeAjaxRequest requires a success callback");o.onreadystatechange=function(){o.readyState===4&&(o.onreadystatechange=function(){},o.status>=200&&o.status<300||o.status===0&&d!=="http:"&&d!=="https:"?n(o):e.isFunction(s)?s(o):e.console.error("AJAX request returned %d: %s",o.status,t))},u=c?"POST":"GET";try{if(o.open(u,t,!0),r&&(o.responseType=r),i)for(a in i)Object.prototype.hasOwnProperty.call(i,a)&&i[a]&&o.setRequestHeader(a,i[a]);l&&(o.withCredentials=!0),o.send(c)}catch(t){e.console.error("%s while making AJAX request: %s",t.name,t.message),o.onreadystatechange=function(){},e.isFunction(s)&&s(o,t)}return o},jsonp:function(t){var n,o=t.url,i=document.head||document.getElementsByTagName("head")[0]||document.documentElement,s=t.callbackName||"openseadragon"+e.now(),r=window[s],c="$1"+s+"$2",l=t.param||"callback",a=t.callback,o=o.replace(/(=)\?(&|$)|\?\?/i,c);o+=(/\?/.test(o)?"&":"?")+l+"="+s,window[s]=function(t){if(r)window[s]=r;else try{delete window[s]}catch{}a&&e.isFunction(a)&&a(t)},n=document.createElement("script"),(0[0]!==t.async||!1!==t.async)&&(n.async="async"),t.scriptCharset&&(n.charset=t.scriptCharset),n.src=o,n.onload=n.onreadystatechange=function(e,t){(t||!n.readyState||/loaded|complete/.test(n.readyState))&&(n.onload=n.onreadystatechange=null,i&&n.parentNode&&i.removeChild(n),n=0[0])},i.insertBefore(n,i.firstChild)},createFromDZI:function(){throw"OpenSeadragon.createFromDZI is deprecated, use Viewer.open."},parseXml:function(t){if(window.DOMParser)e.parseXml=function(e){var t=null,n=new DOMParser,t=n.parseFromString(e,"text/xml");return t};else throw new Error("Browser doesn't support XML DOM.");return e.parseXml(t)},parseJSON:function(t){return e.parseJSON=window.JSON.parse,e.parseJSON(t)},imageFormatSupported:function(e){return e=e||"",!!o[e.toLowerCase()]},setImageFormatsSupported:function(t){e.extend(o,t)}}),t=function(){},e.console=window.console||{log:t,debug:t,info:t,warn:t,error:t,assert:t},e.Browser={vendor:e.BROWSERS.UNKNOWN,version:0,alpha:!0};var t,s,o={avif:!0,bmp:!1,jpeg:!0,jpg:!0,png:!0,tif:!1,wdp:!1,webp:!0},i={};(function(){var n,s,o,a,r,c,l,d,u=navigator.appVersion,t=navigator.userAgent;switch(navigator.appName){case"Microsoft Internet Explorer":!!window.attachEvent&&!!window.ActiveXObject&&(e.Browser.vendor=e.BROWSERS.IE,e.Browser.version=parseFloat(t.substring(t.indexOf("MSIE")+5,t.indexOf(";",t.indexOf("MSIE")))));break;case"Netscape":window.addEventListener&&(t.indexOf("Edge")>=0?(e.Browser.vendor=e.BROWSERS.EDGE,e.Browser.version=parseFloat(t.substring(t.indexOf("Edge")+5))):t.indexOf("Edg")>=0?(e.Browser.vendor=e.BROWSERS.CHROMEEDGE,e.Browser.version=parseFloat(t.substring(t.indexOf("Edg")+4))):t.indexOf("Firefox")>=0?(e.Browser.vendor=e.BROWSERS.FIREFOX,e.Browser.version=parseFloat(t.substring(t.indexOf("Firefox")+8))):t.indexOf("Safari")>=0?(e.Browser.vendor=t.indexOf("Chrome")>=0?e.BROWSERS.CHROME:e.BROWSERS.SAFARI,e.Browser.version=parseFloat(t.substring(t.substring(0,t.indexOf("Safari")).lastIndexOf("/")+1,t.indexOf("Safari")))):(l=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})"),l.exec(t)!==null&&(e.Browser.vendor=e.BROWSERS.IE,e.Browser.version=parseFloat(RegExp.$1))));break;case"Opera":e.Browser.vendor=e.BROWSERS.OPERA,e.Browser.version=parseFloat(u);break}d=window.location.search.substring(1),a=d.split("&");for(o=0;o<a.length;o++)if(n=a[o],s=n.indexOf("="),s>0){r=n.substring(0,s),c=n.substring(s+1);try{i[r]=decodeURIComponent(c)}catch{e.console.error("Ignoring malformed URL parameter: %s=%s",r,c)}}e.Browser.alpha=!(e.Browser.vendor===e.BROWSERS.CHROME&&e.Browser.version<2),e.Browser.opacity=!0,e.Browser.vendor===e.BROWSERS.IE&&e.console.error("Internet Explorer is not supported by OpenSeadragon")})(),function(t){if(i=t.requestAnimationFrame||t.mozRequestAnimationFrame||t.webkitRequestAnimationFrame||t.msRequestAnimationFrame,a=t.cancelAnimationFrame||t.mozCancelAnimationFrame||t.webkitCancelAnimationFrame||t.msCancelAnimationFrame,i&&a)e.requestAnimationFrame=function(){return i.apply(t,arguments)},e.cancelAnimationFrame=function(){return a.apply(t,arguments)};else{var o,i,a,n=[],s=[],r=0;e.requestAnimationFrame=function(t){return n.push([++r,t]),o||(o=setInterval(function(){if(n.length){var t=e.now(),i=s;for(s=n,n=i;s.length;)s.shift()[1](t)}else clearInterval(o),o=0[0]},1e3/50)),r},e.cancelAnimationFrame=function(e){var t,o;for(t=0,o=n.length;t<o;t+=1)if(n[t][0]===e){n.splice(t,1);return}for(t=0,o=s.length;t<o;t+=1)if(s[t][0]===e){s.splice(t,1);return}}}}(window);function a(e,t){return t&&e!==document.body?document.body:e.offsetParent}}(n),function(e,n){typeof define=="function"&&define.amd?define([],n):typeof t=="object"&&t.exports?t.exports=n():e.OpenSeadragon=n()}(e,function(){return n}),function(e){class t{constructor(e){e||(e=[0,0,0,0,0,0,0,0,0]),this.values=e}static makeIdentity(){return new t([1,0,0,0,1,0,0,0,1])}static makeTranslation(e,n){return new t([1,0,0,0,1,0,e,n,1])}static makeRotation(e){var n=Math.cos(e),s=Math.sin(e);return new t([n,-s,0,s,n,0,0,0,1])}static makeScaling(e,n){return new t([e,0,0,0,n,0,0,0,1])}multiply(e){let n=this.values,s=e.values;var o=n[0*3+0],i=n[0*3+1],a=n[0*3+2],r=n[1*3+0],c=n[1*3+1],l=n[1*3+2],d=n[2*3+0],u=n[2*3+1],h=n[2*3+2],m=s[0*3+0],f=s[0*3+1],p=s[0*3+2],g=s[1*3+0],v=s[1*3+1],b=s[1*3+2],j=s[2*3+0],y=s[2*3+1],_=s[2*3+2];return new t([m*o+f*r+p*d,m*i+f*c+p*u,m*a+f*l+p*h,g*o+v*r+b*d,g*i+v*c+b*u,g*a+v*l+b*h,j*o+y*r+_*d,j*i+y*c+_*u,j*a+y*l+_*h])}}e.Mat3=t}(n),function(e){var t={supportsFullScreen:!1,isFullScreen:function(){return!1},getFullScreenElement:function(){return null},requestFullScreen:function(){},exitFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",fullScreenErrorEventName:""};document.exitFullscreen?(t.supportsFullScreen=!0,t.getFullScreenElement=function(){return document.fullscreenElement},t.requestFullScreen=function(t){return t.requestFullscreen().catch(function(t){e.console.error("Fullscreen request failed: ",t)})},t.exitFullScreen=function(){document.exitFullscreen().catch(function(t){e.console.error("Error while exiting fullscreen: ",t)})},t.fullScreenEventName="fullscreenchange",t.fullScreenErrorEventName="fullscreenerror"):document.msExitFullscreen?(t.supportsFullScreen=!0,t.getFullScreenElement=function(){return document.msFullscreenElement},t.requestFullScreen=function(e){return e.msRequestFullscreen()},t.exitFullScreen=function(){document.msExitFullscreen()},t.fullScreenEventName="MSFullscreenChange",t.fullScreenErrorEventName="MSFullscreenError"):document.webkitExitFullscreen?(t.supportsFullScreen=!0,t.getFullScreenElement=function(){return document.webkitFullscreenElement},t.requestFullScreen=function(e){return e.webkitRequestFullscreen()},t.exitFullScreen=function(){document.webkitExitFullscreen()},t.fullScreenEventName="webkitfullscreenchange",t.fullScreenErrorEventName="webkitfullscreenerror"):document.webkitCancelFullScreen?(t.supportsFullScreen=!0,t.getFullScreenElement=function(){return document.webkitCurrentFullScreenElement},t.requestFullScreen=function(e){return e.webkitRequestFullScreen()},t.exitFullScreen=function(){document.webkitCancelFullScreen()},t.fullScreenEventName="webkitfullscreenchange",t.fullScreenErrorEventName="webkitfullscreenerror"):document.mozCancelFullScreen&&(t.supportsFullScreen=!0,t.getFullScreenElement=function(){return document.mozFullScreenElement},t.requestFullScreen=function(e){return e.mozRequestFullScreen()},t.exitFullScreen=function(){document.mozCancelFullScreen()},t.fullScreenEventName="mozfullscreenchange",t.fullScreenErrorEventName="mozfullscreenerror"),t.isFullScreen=function(){return t.getFullScreenElement()!==null},t.cancelFullScreen=function(){e.console.error("cancelFullScreen is deprecated. Use exitFullScreen instead."),t.exitFullScreen()},e.extend(e,t)}(n),function(e){e.EventSource=function(){this.events={},this._rejectedEventList={}},e.EventSource.prototype={addOnceHandler:function(e,t,n,s,o){var i,a,r=this;return s=s||1,i=0,a=function(n){return i++,i===s&&r.removeHandler(e,a),t(n)},this.addHandler(e,a,n,o)},addHandler:function(t,n,s,o){if(Object.prototype.hasOwnProperty.call(this._rejectedEventList,t))return e.console.error(`Error adding handler for ${t}. ${this._rejectedEventList[t]}`),!1;if(i=this.events[t],i||(this.events[t]=i=[]),n&&e.isFunction(n)){var i,a=i.length,r={handler:n,userData:s||null,priority:o||0};for(i[a]=r;a>0&&i[a-1].priority<i[a].priority;)i[a]=i[a-1],i[a-1]=r,a--}return!0},removeHandler:function(t,n){var o,s=this.events[t],i=[];if(!s)return;if(e.isArray(s)){for(o=0;o<s.length;o++)s[o].handler!==n&&i.push(s[o]);this.events[t]=i}},numberOfHandlers:function(e){var t=this.events[e];return t?t.length:0},removeAllHandlers:function(e){if(e)this.events[e]=[];else for(var t in this.events)this.events[t]=[]},getHandler:function(e){var t=this.events[e];return!t||!t.length?null:(t=t.length===1?[t[0]]:Array.apply(null,t),function(e,n){var s,o=t.length;for(s=0;s<o;s++)t[s]&&(n.eventSource=e,n.userData=t[s].userData,t[s].handler(n))})},raiseEvent:function(t,n){if(Object.prototype.hasOwnProperty.call(this._rejectedEventList,t))return e.console.error(`Error adding handler for ${t}. ${this._rejectedEventList[t]}`),!1;var s=this.getHandler(t);return s&&s(this,n||{}),!0},rejectEventHandler(e,t=""){this._rejectedEventList[e]=t},allowEventHandler(e){delete this._rejectedEventList[e]}}}(n),function(e){var f,d=[],o={};e.MouseTracker=function(t){d.push(this);var n,s=arguments;e.isPlainObject(t)||(t={element:s[0],clickTimeThreshold:s[1],clickDistThreshold:s[2]}),this.hash=Math.random(),this.element=e.getElement(t.element),this.clickTimeThreshold=t.clickTimeThreshold||e.DEFAULT_SETTINGS.clickTimeThreshold,this.clickDistThreshold=t.clickDistThreshold||e.DEFAULT_SETTINGS.clickDistThreshold,this.dblClickTimeThreshold=t.dblClickTimeThreshold||e.DEFAULT_SETTINGS.dblClickTimeThreshold,this.dblClickDistThreshold=t.dblClickDistThreshold||e.DEFAULT_SETTINGS.dblClickDistThreshold,this.userData=t.userData||null,this.stopDelay=t.stopDelay||50,this.preProcessEventHandler=t.preProcessEventHandler||null,this.contextMenuHandler=t.contextMenuHandler||null,this.enterHandler=t.enterHandler||null,this.leaveHandler=t.leaveHandler||null,this.exitHandler=t.exitHandler||null,this.overHandler=t.overHandler||null,this.outHandler=t.outHandler||null,this.pressHandler=t.pressHandler||null,this.nonPrimaryPressHandler=t.nonPrimaryPressHandler||null,this.releaseHandler=t.releaseHandler||null,this.nonPrimaryReleaseHandler=t.nonPrimaryReleaseHandler||null,this.moveHandler=t.moveHandler||null,this.scrollHandler=t.scrollHandler||null,this.clickHandler=t.clickHandler||null,this.dblClickHandler=t.dblClickHandler||null,this.dragHandler=t.dragHandler||null,this.dragEndHandler=t.dragEndHandler||null,this.pinchHandler=t.pinchHandler||null,this.stopHandler=t.stopHandler||null,this.keyDownHandler=t.keyDownHandler||null,this.keyUpHandler=t.keyUpHandler||null,this.keyHandler=t.keyHandler||null,this.focusHandler=t.focusHandler||null,this.blurHandler=t.blurHandler||null,n=this,o[this.hash]={click:function(e){ce(n,e)},dblclick:function(e){P(n,e)},keydown:function(e){ae(n,e)},keyup:function(e){ie(n,e)},keypress:function(e){ne(n,e)},focus:function(e){te(n,e)},blur:function(e){ee(n,e)},contextmenu:function(e){J(n,e)},wheel:function(e){re(n,e)},mousewheel:function(e){h(n,e)},DOMMouseScroll:function(e){h(n,e)},MozMousePixelScroll:function(e){h(n,e)},losecapture:function(e){K(n,e)},mouseenter:function(e){L(n,e)},mouseleave:function(e){N(n,e)},mouseover:function(e){g(n,e)},mouseout:function(e){z(n,e)},mousedown:function(e){T(n,e)},mouseup:function(e){F(n,e)},mousemove:function(e){p(n,e)},touchstart:function(e){U(n,e)},touchend:function(e){$(n,e)},touchmove:function(e){V(n,e)},touchcancel:function(e){B(n,e)},gesturestart:function(e){I(n,e)},gesturechange:function(e){H(n,e)},gotpointercapture:function(e){G(n,e)},lostpointercapture:function(e){X(n,e)},pointerenter:function(e){L(n,e)},pointerleave:function(e){N(n,e)},pointerover:function(e){g(n,e)},pointerout:function(e){z(n,e)},pointerdown:function(e){T(n,e)},pointerup:function(e){F(n,e)},pointermove:function(e){p(n,e)},pointercancel:function(e){R(n,e)},pointerupcaptured:function(e){W(n,e)},pointermovecaptured:function(e){q(n,e)},tracking:!1,activePointersLists:[],lastClickPos:null,dblClickTimeOut:null,pinchGPoints:[],lastPinchDist:0,currentPinchDist:0,lastPinchCenter:null,currentPinchCenter:null,sentDragEvent:!1},this.hasGestureHandlers=!!(this.pressHandler||this.nonPrimaryPressHandler||this.releaseHandler||this.nonPrimaryReleaseHandler||this.clickHandler||this.dblClickHandler||this.dragHandler||this.dragEndHandler||this.pinchHandler),this.hasScrollHandler=!!this.scrollHandler,e.MouseTracker.havePointerEvents&&e.setElementPointerEvents(this.element,"auto"),this.exitHandler&&e.console.error("MouseTracker.exitHandler is deprecated. Use MouseTracker.leaveHandler instead."),t.startDisabled||this.setTracking(!0)},e.MouseTracker.prototype={destroy:function(){var e;E(this),this.element=null;for(e=0;e<d.length;e++)if(d[e]===this){d.splice(e,1);break}o[this.hash]=null,delete o[this.hash]},isTracking:function(){return o[this.hash].tracking},setTracking:function(e){return e?Y(this):E(this),this},getActivePointersListByType:function(t){var s,i,n=o[this.hash],a=n?n.activePointersLists.length:0;for(s=0;s<a;s++)if(n.activePointersLists[s].type===t)return n.activePointersLists[s];return i=new e.MouseTracker.GesturePointList(t),n&&n.activePointersLists.push(i),i},getActivePointerCount:function(){var e,t=o[this.hash],s=t.activePointersLists.length,n=0;for(e=0;e<s;e++)n+=t.activePointersLists[e].getLength();return n},preProcessEventHandler:function(){},contextMenuHandler:function(){},enterHandler:function(){},leaveHandler:function(){},exitHandler:function(){},overHandler:function(){},outHandler:function(){},pressHandler:function(){},nonPrimaryPressHandler:function(){},releaseHandler:function(){},nonPrimaryReleaseHandler:function(){},moveHandler:function(){},scrollHandler:function(){},clickHandler:function(){},dblClickHandler:function(){},dragHandler:function(){},dragEndHandler:function(){},pinchHandler:function(){},stopHandler:function(){},keyDownHandler:function(){},keyUpHandler:function(){},keyHandler:function(){},focusHandler:function(){},blurHandler:function(){}},f=function(){try{return window.self!==window.top}catch{return!0}}();function x(e){try{return e.addEventListener&&e.removeEventListener}catch{return!1}}e.MouseTracker.gesturePointVelocityTracker=function(){var t=[],s=0,n=0,o=function(e,t){return e.hash.toString()+t.type+t.id.toString()},i=function(){var s,o,i,r,c,l=t.length,a=e.now(),d=a-n;n=a;for(i=0;i<l;i++)o=t[i],s=o.gPoint,s.direction=Math.atan2(s.currentPos.y-o.lastPos.y,s.currentPos.x-o.lastPos.x),r=o.lastPos.distanceTo(s.currentPos),o.lastPos=s.currentPos,c=1e3*r/(d+1),s.speed=.75*c+.25*s.speed},a=function(a,r){var c=o(a,r);t.push({guid:c,gPoint:r,lastPos:r.currentPos}),t.length===1&&(n=e.now(),s=window.setInterval(i,50))},r=function(e,n){var i,r=o(e,n),a=t.length;for(i=0;i<a;i++)if(t[i].guid===r){t.splice(i,1),a--,a===0&&window.clearInterval(s);break}};return{addPoint:a,removePoint:r}}(),e.MouseTracker.captureElement=document,e.MouseTracker.wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==0[0]?"mousewheel":"DOMMouseScroll",e.MouseTracker.subscribeEvents=["click","dblclick","keydown","keyup","keypress","focus","blur","contextmenu",e.MouseTracker.wheelEventName],e.MouseTracker.wheelEventName==="DOMMouseScroll"&&e.MouseTracker.subscribeEvents.push("MozMousePixelScroll"),window.PointerEvent?(e.MouseTracker.havePointerEvents=!0,e.MouseTracker.subscribeEvents.push("pointerenter","pointerleave","pointerover","pointerout","pointerdown","pointerup","pointermove","pointercancel"),e.MouseTracker.havePointerCapture=function(){var t=document.createElement("div");return e.isFunction(t.setPointerCapture)&&e.isFunction(t.releasePointerCapture)}(),e.MouseTracker.havePointerCapture&&e.MouseTracker.subscribeEvents.push("gotpointercapture","lostpointercapture")):(e.MouseTracker.havePointerEvents=!1,e.MouseTracker.subscribeEvents.push("mouseenter","mouseleave","mouseover","mouseout","mousedown","mouseup","mousemove"),e.MouseTracker.mousePointerId="legacy-mouse",e.MouseTracker.havePointerCapture=function(){var t=document.createElement("div");return e.isFunction(t.setCapture)&&e.isFunction(t.releaseCapture)}(),e.MouseTracker.havePointerCapture&&e.MouseTracker.subscribeEvents.push("losecapture"),"ontouchstart"in window&&e.MouseTracker.subscribeEvents.push("touchstart","touchend","touchmove","touchcancel"),"ongesturestart"in window&&e.MouseTracker.subscribeEvents.push("gesturestart","gesturechange")),e.MouseTracker.GesturePointList=function(e){this._gPoints=[],this.type=e,this.buttons=0,this.contacts=0,this.clicks=0,this.captureCount=0},e.MouseTracker.GesturePointList.prototype={getLength:function(){return this._gPoints.length},asArray:function(){return this._gPoints},add:function(e){return this._gPoints.push(e)},removeById:function(e){var t,n=this._gPoints.length;for(t=0;t<n;t++)if(this._gPoints[t].id===e){this._gPoints.splice(t,1);break}return this._gPoints.length},getByIndex:function(e){return e<this._gPoints.length?this._gPoints[e]:null},getById:function(e){var t,n=this._gPoints.length;for(t=0;t<n;t++)if(this._gPoints[t].id===e)return this._gPoints[t];return null},getPrimary:function(){var t,n=this._gPoints.length;for(t=0;t<n;t++)if(this._gPoints[t].isPrimary)return this._gPoints[t];return null},addContact:function(){++this.contacts,this.contacts>1&&(this.type==="mouse"||this.type==="pen")&&(e.console.warn("GesturePointList.addContact() Implausible contacts value"),this.contacts=1)},removeContact:function(){--this.contacts,this.contacts<0&&(this.contacts=0)}};function C(e){var t,n,i,a,r,s=o[e.hash],c=s.activePointersLists.length;for(n=0;n<c;n++)if(i=s.activePointersLists[n],i.getLength()>0){a=[],r=i.asArray();for(t=0;t<r.length;t++)a.push(r[t]);for(t=0;t<a.length;t++)u(e,i,a[t])}for(n=0;n<c;n++)s.activePointersLists.pop();s.sentDragEvent=!1}function Y(t){var n,s,i=o[t.hash];if(!i.tracking){for(s=0;s<e.MouseTracker.subscribeEvents.length;s++)n=e.MouseTracker.subscribeEvents[s],e.addEvent(t.element,n,i[n],n===e.MouseTracker.wheelEventName&&{passive:!1,capture:!1});C(t),i.tracking=!0}}function E(t){var n,i,s=o[t.hash];if(s.tracking){for(n=0;n<e.MouseTracker.subscribeEvents.length;n++)i=e.MouseTracker.subscribeEvents[n],e.removeEvent(t.element,i,s[i],!1);C(t),s.tracking=!1}}function S(e,t){var n=o[e.hash];if(t==="pointerevent")return{upName:"pointerup",upHandler:n.pointerupcaptured,moveName:"pointermove",moveHandler:n.pointermovecaptured};if(t==="mouse")return{upName:"pointerup",upHandler:n.pointerupcaptured,moveName:"pointermove",moveHandler:n.pointermovecaptured};if(t==="touch")return{upName:"touchend",upHandler:n.touchendcaptured,moveName:"touchmove",moveHandler:n.touchmovecaptured};throw new Error("MouseTracker.getCaptureEventParams: Unknown pointer type.")}function Q(t,n){var s;if(e.MouseTracker.havePointerCapture)if(e.MouseTracker.havePointerEvents)try{t.element.setPointerCapture(n.id)}catch{e.console.warn("setPointerCapture() called on invalid pointer ID");return}else t.element.setCapture(!0);else s=S(t,e.MouseTracker.havePointerEvents?"pointerevent":n.type),f&&x(window.top)&&e.addEvent(window.top,s.upName,s.upHandler,!0),e.addEvent(e.MouseTracker.captureElement,s.upName,s.upHandler,!0),e.addEvent(e.MouseTracker.captureElement,s.moveName,s.moveHandler,!0);a(t,n,!0)}function v(t,n){var s,o,i;if(e.MouseTracker.havePointerCapture)if(e.MouseTracker.havePointerEvents){if(i=t.getActivePointersListByType(n.type),o=i.getById(n.id),!o||!o.captured)return;try{t.element.releasePointerCapture(n.id)}catch{}}else t.element.releaseCapture();else s=S(t,e.MouseTracker.havePointerEvents?"pointerevent":n.type),f&&x(window.top)&&e.removeEvent(window.top,s.upName,s.upHandler,!0),e.removeEvent(e.MouseTracker.captureElement,s.moveName,s.moveHandler,!0),e.removeEvent(e.MouseTracker.captureElement,s.upName,s.upHandler,!0);a(t,n,!1)}function c(t){return e.MouseTracker.havePointerEvents?t.pointerId:e.MouseTracker.mousePointerId}function s(t){return e.MouseTracker.havePointerEvents&&t.pointerType?t.pointerType:"mouse"}function r(t){return!e.MouseTracker.havePointerEvents||t.isPrimary}function i(t){return e.getMousePosition(t)}function D(e,t){return n(i(e),t)}function n(t,n){var s=e.getElementOffset(n);return t.minus(s)}function l(t,n){return new e.Point((t.x+n.x)/2,(t.y+n.y)/2)}function ce(n,s){var o={originalEvent:s,eventType:"click",pointerType:"mouse",isEmulated:!1};t(n,o),o.preventDefault&&!o.defaultPrevented&&e.cancelEvent(s),o.stopPropagation&&e.stopEvent(s)}function P(n,s){var o={originalEvent:s,eventType:"dblclick",pointerType:"mouse",isEmulated:!1};t(n,o),o.preventDefault&&!o.defaultPrevented&&e.cancelEvent(s),o.stopPropagation&&e.stopEvent(s)}function ae(n,s){var i=null,o={originalEvent:s,eventType:"keydown",pointerType:"",isEmulated:!1};t(n,o),n.keyDownHandler&&!o.preventGesture&&!o.defaultPrevented&&(i={eventSource:n,keyCode:s.keyCode?s.keyCode:s.charCode,ctrl:s.ctrlKey,shift:s.shiftKey,alt:s.altKey,meta:s.metaKey,originalEvent:s,preventDefault:o.preventDefault||o.defaultPrevented,userData:n.userData},n.keyDownHandler(i)),(i&&i.preventDefault||o.preventDefault&&!o.defaultPrevented)&&e.cancelEvent(s),o.stopPropagation&&e.stopEvent(s)}function ie(n,s){var i=null,o={originalEvent:s,eventType:"keyup",pointerType:"",isEmulated:!1};t(n,o),n.keyUpHandler&&!o.preventGesture&&!o.defaultPrevented&&(i={eventSource:n,keyCode:s.keyCode?s.keyCode:s.charCode,ctrl:s.ctrlKey,shift:s.shiftKey,alt:s.altKey,meta:s.metaKey,originalEvent:s,preventDefault:o.preventDefault||o.defaultPrevented,userData:n.userData},n.keyUpHandler(i)),(i&&i.preventDefault||o.preventDefault&&!o.defaultPrevented)&&e.cancelEvent(s),o.stopPropagation&&e.stopEvent(s)}function ne(n,s){var i=null,o={originalEvent:s,eventType:"keypress",pointerType:"",isEmulated:!1};t(n,o),n.keyHandler&&!o.preventGesture&&!o.defaultPrevented&&(i={eventSource:n,keyCode:s.keyCode?s.keyCode:s.charCode,ctrl:s.ctrlKey,shift:s.shiftKey,alt:s.altKey,meta:s.metaKey,originalEvent:s,preventDefault:o.preventDefault||o.defaultPrevented,userData:n.userData},n.keyHandler(i)),(i&&i.preventDefault||o.preventDefault&&!o.defaultPrevented)&&e.cancelEvent(s),o.stopPropagation&&e.stopEvent(s)}function te(e,n){var s={originalEvent:n,eventType:"focus",pointerType:"",isEmulated:!1};t(e,s),e.focusHandler&&!s.preventGesture&&e.focusHandler({eventSource:e,originalEvent:n,userData:e.userData})}function ee(e,n){var s={originalEvent:n,eventType:"blur",pointerType:"",isEmulated:!1};t(e,s),e.blurHandler&&!s.preventGesture&&e.blurHandler({eventSource:e,originalEvent:n,userData:e.userData})}function J(s,o){var r=null,a={originalEvent:o,eventType:"contextmenu",pointerType:"mouse",isEmulated:!1};t(s,a),s.contextMenuHandler&&!a.preventGesture&&!a.defaultPrevented&&(r={eventSource:s,position:n(i(o),s.element),originalEvent:a.originalEvent,preventDefault:a.preventDefault||a.defaultPrevented,userData:s.userData},s.contextMenuHandler(r)),(r&&r.preventDefault||a.preventDefault&&!a.defaultPrevented)&&e.cancelEvent(o),a.stopPropagation&&e.stopEvent(o)}function re(e,t){A(e,t,t)}function h(t,n){var s={target:n.target||n.srcElement,type:"wheel",shiftKey:n.shiftKey||!1,clientX:n.clientX,clientY:n.clientY,pageX:n.pageX?n.pageX:n.clientX,pageY:n.pageY?n.pageY:n.clientY,deltaMode:n.type==="MozMousePixelScroll"?0:1,deltaX:0,deltaZ:0};e.MouseTracker.wheelEventName==="mousewheel"?s.deltaY=-n.wheelDelta/e.DEFAULT_SETTINGS.pixelsPerWheelLine:s.deltaY=n.detail,A(t,s,n)}function A(n,s,o){var r=0,a=null,r=s.deltaY?s.deltaY<0?1:-1:0,i={originalEvent:s,eventType:"wheel",pointerType:"mouse",isEmulated:s!==o};t(n,i),n.scrollHandler&&!i.preventGesture&&!i.defaultPrevented&&(a={eventSource:n,pointerType:"mouse",position:D(s,n.element),scroll:r,shift:s.shiftKey,isTouchEvent:!1,originalEvent:o,preventDefault:i.preventDefault||i.defaultPrevented,userData:n.userData},n.scrollHandler(a)),i.stopPropagation&&e.stopEvent(o),(a&&a.preventDefault||i.preventDefault&&!i.defaultPrevented)&&e.cancelEvent(o)}function K(n,s){var i={id:e.MouseTracker.mousePointerId,type:"mouse"},o={originalEvent:s,eventType:"lostpointercapture",pointerType:"mouse",isEmulated:!1};t(n,o),s.target===n.element&&a(n,i,!1),o.stopPropagation&&e.stopEvent(s)}function U(n,s){var o,r,c,l=s.changedTouches.length,d=n.getActivePointersListByType("touch"),u=e.now();d.getLength()>s.touches.length-l&&e.console.warn("Tracked touch contact count doesn't match event.touches.length"),o={originalEvent:s,eventType:"pointerdown",pointerType:"touch",isEmulated:!1},t(n,o);for(r=0;r<l;r++)c={id:s.changedTouches[r].identifier,type:"touch",isPrimary:d.getLength()===0,currentPos:i(s.changedTouches[r]),currentTime:u},O(n,o,c),_(n,o,c,0),a(n,c,!0);o.preventDefault&&!o.defaultPrevented&&e.cancelEvent(s),o.stopPropagation&&e.stopEvent(s)}function $(n,s){var r,c,d=s.changedTouches.length,l=e.now(),o={originalEvent:s,eventType:"pointerup",pointerType:"touch",isEmulated:!1};t(n,o);for(r=0;r<d;r++)c={id:s.changedTouches[r].identifier,type:"touch",currentPos:i(s.changedTouches[r]),currentTime:l},y(n,o,c,0),a(n,c,!1),w(n,o,c);o.preventDefault&&!o.defaultPrevented&&e.cancelEvent(s),o.stopPropagation&&e.stopEvent(s)}function V(n,s){var o,r,l=s.changedTouches.length,c=e.now(),a={originalEvent:s,eventType:"pointermove",pointerType:"touch",isEmulated:!1};t(n,a);for(o=0;o<l;o++)r={id:s.changedTouches[o].identifier,type:"touch",currentPos:i(s.changedTouches[o]),currentTime:c},j(n,a,r);a.preventDefault&&!a.defaultPrevented&&e.cancelEvent(s),a.stopPropagation&&e.stopEvent(s)}function B(n,s){var o,a,r=s.changedTouches.length,i={originalEvent:s,eventType:"pointercancel",pointerType:"touch",isEmulated:!1};t(n,i);for(o=0;o<r;o++)a={id:s.changedTouches[o].identifier,type:"touch"},b(n,i,a);i.stopPropagation&&e.stopEvent(s)}function I(t,n){return e.eventIsCanceled(n)||n.preventDefault(),!1}function H(t,n){return e.eventIsCanceled(n)||n.preventDefault(),!1}function G(n,o){var i={originalEvent:o,eventType:"gotpointercapture",pointerType:s(o),isEmulated:!1};t(n,i),o.target===n.element&&a(n,{id:o.pointerId,type:s(o)},!0),i.stopPropagation&&e.stopEvent(o)}function X(n,o){var i={originalEvent:o,eventType:"lostpointercapture",pointerType:s(o),isEmulated:!1};t(n,i),o.target===n.element&&a(n,{id:o.pointerId,type:s(o)},!1),i.stopPropagation&&e.stopEvent(o)}function L(n,o){var a={id:c(o),type:s(o),isPrimary:r(o),currentPos:i(o),currentTime:e.now()},l={originalEvent:o,eventType:"pointerenter",pointerType:a.type,isEmulated:!1};t(n,l),O(n,l,a)}function N(n,o){var a={id:c(o),type:s(o),isPrimary:r(o),currentPos:i(o),currentTime:e.now()},l={originalEvent:o,eventType:"pointerleave",pointerType:a.type,isEmulated:!1};t(n,l),w(n,l,a)}function g(n,o){var l={id:c(o),type:s(o),isPrimary:r(o),currentPos:i(o),currentTime:e.now()},a={originalEvent:o,eventType:"pointerover",pointerType:l.type,isEmulated:!1};t(n,a),se(n,a,l),a.preventDefault&&!a.defaultPrevented&&e.cancelEvent(o),a.stopPropagation&&e.stopEvent(o)}function z(n,o){var l={id:c(o),type:s(o),isPrimary:r(o),currentPos:i(o),currentTime:e.now()},a={originalEvent:o,eventType:"pointerout",pointerType:l.type,isEmulated:!1};t(n,a),oe(n,a,l),a.preventDefault&&!a.defaultPrevented&&e.cancelEvent(o),a.stopPropagation&&e.stopEvent(o)}function T(n,o){var d={id:c(o),type:s(o),isPrimary:r(o),currentPos:i(o),currentTime:e.now()},u=e.MouseTracker.havePointerEvents&&d.type==="touch",l={originalEvent:o,eventType:"pointerdown",pointerType:d.type,isEmulated:!1};t(n,l),_(n,l,d,o.button),l.preventDefault&&!l.defaultPrevented&&e.cancelEvent(o),l.stopPropagation&&e.stopEvent(o),l.shouldCapture&&(u?a(n,d,!0):Q(n,d))}function F(e,t){M(e,t)}function W(t,n){var o=t.getActivePointersListByType(s(n));o.getById(n.pointerId)&&M(t,n),e.stopEvent(n)}function M(n,o){var d={id:c(o),type:s(o),isPrimary:r(o),currentPos:i(o),currentTime:e.now()},l={originalEvent:o,eventType:"pointerup",pointerType:d.type,isEmulated:!1};t(n,l),y(n,l,d,o.button),l.preventDefault&&!l.defaultPrevented&&e.cancelEvent(o),l.stopPropagation&&e.stopEvent(o),l.shouldReleaseCapture&&(o.target===n.element?v(n,d):a(n,d,!1))}function p(e,t){k(e,t)}function q(t,n){var o=t.getActivePointersListByType(s(n));o.getById(n.pointerId)&&k(t,n),e.stopEvent(n)}function k(n,o){var l={id:c(o),type:s(o),isPrimary:r(o),currentPos:i(o),currentTime:e.now()},a={originalEvent:o,eventType:"pointermove",pointerType:l.type,isEmulated:!1};t(n,a),j(n,a,l),a.preventDefault&&!a.defaultPrevented&&e.cancelEvent(o),a.stopPropagation&&e.stopEvent(o)}function R(n,o){var a={id:o.pointerId,type:s(o)},i={originalEvent:o,eventType:"pointercancel",pointerType:a.type,isEmulated:!1};t(n,i),b(n,i,a),i.stopPropagation&&e.stopEvent(o)}function m(e,t){return t.speed=0,t.direction=0,t.contactPos=t.currentPos,t.contactTime=t.currentTime,t.lastPos=t.currentPos,t.lastTime=t.currentTime,e.add(t)}function u(t,n,s){var o,i=n.getById(s.id);return i?(i.captured&&(e.console.warn("stopTrackingPointer() called on captured pointer"),v(t,i)),n.removeContact(),o=n.removeById(s.id)):o=n.getLength(),o}function Z(e,t){switch(t.eventType){case"pointermove":t.isStoppable=!0,t.isCancelable=!0,t.preventDefault=!1,t.preventGesture=!e.hasGestureHandlers,t.stopPropagation=!1;break;case"pointerover":case"pointerout":case"contextmenu":case"keydown":case"keyup":case"keypress":t.isStoppable=!0,t.isCancelable=!0,t.preventDefault=!1,t.preventGesture=!1,t.stopPropagation=!1;break;case"pointerdown":t.isStoppable=!0,t.isCancelable=!0,t.preventDefault=!1,t.preventGesture=!e.hasGestureHandlers,t.stopPropagation=!1;break;case"pointerup":t.isStoppable=!0,t.isCancelable=!0,t.preventDefault=!1,t.preventGesture=!e.hasGestureHandlers,t.stopPropagation=!1;break;case"wheel":t.isStoppable=!0,t.isCancelable=!0,t.preventDefault=!1,t.preventGesture=!e.hasScrollHandler,t.stopPropagation=!1;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":t.isStoppable=!0,t.isCancelable=!1,t.preventDefault=!1,t.preventGesture=!1,t.stopPropagation=!1;break;case"click":t.isStoppable=!0,t.isCancelable=!0,t.preventDefault=!!e.clickHandler,t.preventGesture=!1,t.stopPropagation=!1;break;case"dblclick":t.isStoppable=!0,t.isCancelable=!0,t.preventDefault=!!e.dblClickHandler,t.preventGesture=!1,t.stopPropagation=!1;break;case"focus":case"blur":case"pointerenter":case"pointerleave":default:t.isStoppable=!1,t.isCancelable=!1,t.preventDefault=!1,t.preventGesture=!1,t.stopPropagation=!1;break}}function t(t,n){n.eventSource=t,n.eventPhase=n.originalEvent?typeof n.originalEvent.eventPhase!="undefined"?n.originalEvent.eventPhase:0:0,n.defaultPrevented=e.eventIsCanceled(n.originalEvent),n.shouldCapture=!1,n.shouldReleaseCapture=!1,n.userData=t.userData,Z(t,n),t.preProcessEventHandler&&t.preProcessEventHandler(n)}function a(t,n,s){var o=t.getActivePointersListByType(n.type),i=o.getById(n.id);i?s&&!i.captured?(i.captured=!0,o.captureCount++):!s&&i.captured&&(i.captured=!1,o.captureCount--,o.captureCount<0&&(o.captureCount=0,e.console.warn("updatePointerCaptured() - pointsList.captureCount went negative"))):e.console.warn("updatePointerCaptured() called on untracked pointer")}function O(e,t,s){var i=e.getActivePointersListByType(s.type),o=i.getById(s.id);o?(o.insideElement=!0,o.lastPos=o.currentPos,o.lastTime=o.currentTime,o.currentPos=s.currentPos,o.currentTime=s.currentTime,s=o):(s.captured=!1,s.insideElementPressed=!1,s.insideElement=!0,m(i,s)),e.enterHandler&&e.enterHandler({eventSource:e,pointerType:s.type,position:n(s.currentPos,e.element),buttons:i.buttons,pointers:e.getActivePointerCount(),insideElementPressed:s.insideElementPressed,buttonDownAny:i.buttons!==0,isTouchEvent:s.type==="touch",originalEvent:t.originalEvent,userData:e.userData})}function w(e,t,s){var a,i=e.getActivePointersListByType(s.type),o=i.getById(s.id);o?(o.captured?(o.insideElement=!1,o.lastPos=o.currentPos,o.lastTime=o.currentTime,o.currentPos=s.currentPos,o.currentTime=s.currentTime):u(e,i,o),s=o):(s.captured=!1,s.insideElementPressed=!1),(e.leaveHandler||e.exitHandler)&&(a={eventSource:e,pointerType:s.type,position:s.currentPos&&n(s.currentPos,e.element),buttons:i.buttons,pointers:e.getActivePointerCount(),insideElementPressed:s.insideElementPressed,buttonDownAny:i.buttons!==0,isTouchEvent:s.type==="touch",originalEvent:t.originalEvent,userData:e.userData},e.leaveHandler&&e.leaveHandler(a),e.exitHandler&&e.exitHandler(a))}function se(e,t,s){var o=e.getActivePointersListByType(s.type),i=o.getById(s.id);i?s=i:(s.captured=!1,s.insideElementPressed=!1),e.overHandler&&e.overHandler({eventSource:e,pointerType:s.type,position:n(s.currentPos,e.element),buttons:o.buttons,pointers:e.getActivePointerCount(),insideElementPressed:s.insideElementPressed,buttonDownAny:o.buttons!==0,isTouchEvent:s.type==="touch",originalEvent:t.originalEvent,userData:e.userData})}function oe(e,t,s){var o=e.getActivePointersListByType(s.type),i=o.getById(s.id);i?s=i:(s.captured=!1,s.insideElementPressed=!1),e.outHandler&&e.outHandler({eventSource:e,pointerType:s.type,position:s.currentPos&&n(s.currentPos,e.element),buttons:o.buttons,pointers:e.getActivePointerCount(),insideElementPressed:s.insideElementPressed,buttonDownAny:o.buttons!==0,isTouchEvent:s.type==="touch",originalEvent:t.originalEvent,userData:e.userData})}function _(t,s,i,a){var c,d=o[t.hash],r=t.getActivePointersListByType(i.type);if(typeof s.originalEvent.buttons!="undefined"?r.buttons=s.originalEvent.buttons:a===0?r.buttons|=1:a===1?r.buttons|=4:a===2?r.buttons|=2:a===3?r.buttons|=8:a===4?r.buttons|=16:a===5&&(r.buttons|=32),a!==0){s.shouldCapture=!1,s.shouldReleaseCapture=!1,t.nonPrimaryPressHandler&&!s.preventGesture&&!s.defaultPrevented&&(s.preventDefault=!0,t.nonPrimaryPressHandler({eventSource:t,pointerType:i.type,position:n(i.currentPos,t.element),button:a,buttons:r.buttons,isTouchEvent:i.type==="touch",originalEvent:s.originalEvent,userData:t.userData}));return}c=r.getById(i.id),c?(c.insideElementPressed=!0,c.insideElement=!0,c.originalTarget=s.originalEvent.target,c.contactPos=i.currentPos,c.contactTime=i.currentTime,c.lastPos=c.currentPos,c.lastTime=c.currentTime,c.currentPos=i.currentPos,c.currentTime=i.currentTime,i=c):(i.captured=!1,i.insideElementPressed=!0,i.insideElement=!0,i.originalTarget=s.originalEvent.target,m(r,i)),r.addContact(),!s.preventGesture&&!s.defaultPrevented?(s.shouldCapture=!0,s.shouldReleaseCapture=!1,s.preventDefault=!0,(t.dragHandler||t.dragEndHandler||t.pinchHandler)&&e.MouseTracker.gesturePointVelocityTracker.addPoint(t,i),r.contacts===1?t.pressHandler&&!s.preventGesture&&t.pressHandler({eventSource:t,pointerType:i.type,position:n(i.contactPos,t.element),buttons:r.buttons,isTouchEvent:i.type==="touch",originalEvent:s.originalEvent,userData:t.userData}):r.contacts===2&&t.pinchHandler&&i.type==="touch"&&(d.pinchGPoints=r.asArray(),d.lastPinchDist=d.currentPinchDist=d.pinchGPoints[0].currentPos.distanceTo(d.pinchGPoints[1].currentPos),d.lastPinchCenter=d.currentPinchCenter=l(d.pinchGPoints[0].currentPos,d.pinchGPoints[1].currentPos))):(s.shouldCapture=!1,s.shouldReleaseCapture=!1)}function y(t,s,i,a){var r,h,f,p,d=o[t.hash],c=t.getActivePointersListByType(i.type),g=!1;if(typeof s.originalEvent.buttons!="undefined"?c.buttons=s.originalEvent.buttons:a===0?c.buttons^=~1:a===1?c.buttons^=~4:a===2?c.buttons^=~2:a===3?c.buttons^=~8:a===4?c.buttons^=~16:a===5&&(c.buttons^=~32),s.shouldCapture=!1,a!==0){s.shouldReleaseCapture=!1,t.nonPrimaryReleaseHandler&&!s.preventGesture&&!s.defaultPrevented&&(s.preventDefault=!0,t.nonPrimaryReleaseHandler({eventSource:t,pointerType:i.type,position:n(i.currentPos,t.element),button:a,buttons:c.buttons,isTouchEvent:i.type==="touch",originalEvent:s.originalEvent,userData:t.userData}));return}r=c.getById(i.id),r?(c.removeContact(),r.captured&&(g=!0),r.lastPos=r.currentPos,r.lastTime=r.currentTime,r.currentPos=i.currentPos,r.currentTime=i.currentTime,r.insideElement||u(t,c,r),h=r.currentPos,p=r.currentTime):(i.captured=!1,i.insideElementPressed=!1,i.insideElement=!0,m(c,i),r=i),!s.preventGesture&&!s.defaultPrevented&&(g?(s.shouldReleaseCapture=!0,s.preventDefault=!0,(t.dragHandler||t.dragEndHandler||t.pinchHandler)&&e.MouseTracker.gesturePointVelocityTracker.removePoint(t,r),c.contacts===0?(t.releaseHandler&&h&&t.releaseHandler({eventSource:t,pointerType:r.type,position:n(h,t.element),buttons:c.buttons,insideElementPressed:r.insideElementPressed,insideElementReleased:r.insideElement,isTouchEvent:r.type==="touch",originalEvent:s.originalEvent,userData:t.userData}),t.dragEndHandler&&d.sentDragEvent&&t.dragEndHandler({eventSource:t,pointerType:r.type,position:n(r.currentPos,t.element),speed:r.speed,direction:r.direction,shift:s.originalEvent.shiftKey,isTouchEvent:r.type==="touch",originalEvent:s.originalEvent,userData:t.userData}),d.sentDragEvent=!1,(t.clickHandler||t.dblClickHandler)&&r.insideElement&&(f=p-r.contactTime<=t.clickTimeThreshold&&r.contactPos.distanceTo(h)<=t.clickDistThreshold,t.clickHandler&&t.clickHandler({eventSource:t,pointerType:r.type,position:n(r.currentPos,t.element),quick:f,shift:s.originalEvent.shiftKey,isTouchEvent:r.type==="touch",originalEvent:s.originalEvent,originalTarget:r.originalTarget,userData:t.userData}),t.dblClickHandler&&f&&(c.clicks++,c.clicks===1?(d.lastClickPos=h,d.dblClickTimeOut=setTimeout(function(){c.clicks=0},t.dblClickTimeThreshold)):c.clicks===2&&(clearTimeout(d.dblClickTimeOut),c.clicks=0,d.lastClickPos.distanceTo(h)<=t.dblClickDistThreshold&&t.dblClickHandler({eventSource:t,pointerType:r.type,position:n(r.currentPos,t.element),shift:s.originalEvent.shiftKey,isTouchEvent:r.type==="touch",originalEvent:s.originalEvent,userData:t.userData}),d.lastClickPos=null)))):c.contacts===2&&t.pinchHandler&&r.type==="touch"&&(d.pinchGPoints=c.asArray(),d.lastPinchDist=d.currentPinchDist=d.pinchGPoints[0].currentPos.distanceTo(d.pinchGPoints[1].currentPos),d.lastPinchCenter=d.currentPinchCenter=l(d.pinchGPoints[0].currentPos,d.pinchGPoints[1].currentPos))):(s.shouldReleaseCapture=!1,t.releaseHandler&&h&&(t.releaseHandler({eventSource:t,pointerType:r.type,position:n(h,t.element),buttons:c.buttons,insideElementPressed:r.insideElementPressed,insideElementReleased:r.insideElement,isTouchEvent:r.type==="touch",originalEvent:s.originalEvent,userData:t.userData}),s.preventDefault=!0)))}function j(e,t,s){var i,c,d,a=o[e.hash],r=e.getActivePointersListByType(s.type);if(typeof t.originalEvent.buttons!="undefined"&&(r.buttons=t.originalEvent.buttons),i=r.getById(s.id),i)i.lastPos=i.currentPos,i.lastTime=i.currentTime,i.currentPos=s.currentPos,i.currentTime=s.currentTime;else return;t.shouldCapture=!1,t.shouldReleaseCapture=!1,e.stopHandler&&s.type==="mouse"&&(clearTimeout(e.stopTimeOut),e.stopTimeOut=setTimeout(function(){le(e,t.originalEvent,s.type)},e.stopDelay)),r.contacts===0?e.moveHandler&&e.moveHandler({eventSource:e,pointerType:s.type,position:n(s.currentPos,e.element),buttons:r.buttons,isTouchEvent:s.type==="touch",originalEvent:t.originalEvent,userData:e.userData}):r.contacts===1?(e.moveHandler&&(i=r.asArray()[0],e.moveHandler({eventSource:e,pointerType:i.type,position:n(i.currentPos,e.element),buttons:r.buttons,isTouchEvent:i.type==="touch",originalEvent:t.originalEvent,userData:e.userData})),e.dragHandler&&!t.preventGesture&&!t.defaultPrevented&&(i=r.asArray()[0],d=i.currentPos.minus(i.lastPos),e.dragHandler({eventSource:e,pointerType:i.type,position:n(i.currentPos,e.element),buttons:r.buttons,delta:d,speed:i.speed,direction:i.direction,shift:t.originalEvent.shiftKey,isTouchEvent:i.type==="touch",originalEvent:t.originalEvent,userData:e.userData}),t.preventDefault=!0,a.sentDragEvent=!0)):r.contacts===2&&(e.moveHandler&&(c=r.asArray(),e.moveHandler({eventSource:e,pointerType:c[0].type,position:n(l(c[0].currentPos,c[1].currentPos),e.element),buttons:r.buttons,isTouchEvent:c[0].type==="touch",originalEvent:t.originalEvent,userData:e.userData})),e.pinchHandler&&s.type==="touch"&&!t.preventGesture&&!t.defaultPrevented&&(d=a.pinchGPoints[0].currentPos.distanceTo(a.pinchGPoints[1].currentPos),d!==a.currentPinchDist&&(a.lastPinchDist=a.currentPinchDist,a.currentPinchDist=d,a.lastPinchCenter=a.currentPinchCenter,a.currentPinchCenter=l(a.pinchGPoints[0].currentPos,a.pinchGPoints[1].currentPos),e.pinchHandler({eventSource:e,pointerType:"touch",gesturePoints:a.pinchGPoints,lastCenter:n(a.lastPinchCenter,e.element),center:n(a.currentPinchCenter,e.element),lastDistance:a.lastPinchDist,distance:a.currentPinchDist,shift:t.originalEvent.shiftKey,originalEvent:t.originalEvent,userData:e.userData}),t.preventDefault=!0)))}function b(e,t,n){var s=e.getActivePointersListByType(n.type),o=s.getById(n.id);o&&u(e,s,o)}function le(e,t,n){e.stopHandler&&e.stopHandler({eventSource:e,pointerType:n,position:D(t,e.element),buttons:e.getActivePointersListByType(n).buttons,isTouchEvent:n==="touch",originalEvent:t,userData:e.userData})}}(n),function(e){e.ControlAnchor={NONE:0,TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_RIGHT:3,BOTTOM_LEFT:4,ABSOLUTE:5},e.Control=function(t,n,s){var o=t.parentNode;typeof n=="number"&&(e.console.error("Passing an anchor directly into the OpenSeadragon.Control constructor is deprecated; please use an options object instead.  Support for this deprecated variant is scheduled for removal in December 2013"),n={anchor:n}),n.attachToViewer=typeof n.attachToViewer=="undefined"||n.attachToViewer,this.autoFade=typeof n.autoFade=="undefined"||n.autoFade,this.element=t,this.anchor=n.anchor,this.container=s,this.anchor===e.ControlAnchor.ABSOLUTE?(this.wrapper=e.makeNeutralElement("div"),this.wrapper.style.position="absolute",this.wrapper.style.top=typeof n.top=="number"?n.top+"px":n.top,this.wrapper.style.left=typeof n.left=="number"?n.left+"px":n.left,this.wrapper.style.height=typeof n.height=="number"?n.height+"px":n.height,this.wrapper.style.width=typeof n.width=="number"?n.width+"px":n.width,this.wrapper.style.margin="0px",this.wrapper.style.padding="0px",this.element.style.position="relative",this.element.style.top="0px",this.element.style.left="0px",this.element.style.height="100%",this.element.style.width="100%"):(this.wrapper=e.makeNeutralElement("div"),this.wrapper.style.display="inline-block",this.anchor===e.ControlAnchor.NONE&&(this.wrapper.style.width=this.wrapper.style.height="100%")),this.wrapper.appendChild(this.element),n.attachToViewer?this.anchor===e.ControlAnchor.TOP_RIGHT||this.anchor===e.ControlAnchor.BOTTOM_RIGHT?this.container.insertBefore(this.wrapper,this.container.firstChild):this.container.appendChild(this.wrapper):o.appendChild(this.wrapper)},e.Control.prototype={destroy:function(){this.wrapper.removeChild(this.element),this.anchor!==e.ControlAnchor.NONE&&this.container.removeChild(this.wrapper)},isVisible:function(){return this.wrapper.style.display!=="none"},setVisible:function(t){this.wrapper.style.display=t?this.anchor===e.ControlAnchor.ABSOLUTE?"block":"inline-block":"none"},setOpacity:function(t){e.setElementOpacity(this.wrapper,t,!0)}}}(n),function(e){e.ControlDock=function(t){var n,s,o=["topleft","topright","bottomright","bottomleft"];e.extend(!0,this,{id:"controldock-"+e.now()+"-"+Math.floor(Math.random()*1e6),container:e.makeNeutralElement("div"),controls:[]},t),this.container.onsubmit=function(){return!1},this.element&&(this.element=e.getElement(this.element),this.element.appendChild(this.container),e.getElementStyle(this.element).position==="static"&&(this.element.style.position="relative"),this.container.style.width="100%",this.container.style.height="100%");for(s=0;s<o.length;s++)n=o[s],this.controls[n]=e.makeNeutralElement("div"),this.controls[n].style.position="absolute",n.match("left")&&(this.controls[n].style.left="0px"),n.match("right")&&(this.controls[n].style.right="0px"),n.match("top")&&(this.controls[n].style.top="0px"),n.match("bottom")&&(this.controls[n].style.bottom="0px");this.container.appendChild(this.controls.topleft),this.container.appendChild(this.controls.topright),this.container.appendChild(this.controls.bottomright),this.container.appendChild(this.controls.bottomleft)},e.ControlDock.prototype={addControl:function(n,s){n=e.getElement(n);var o=null;if(t(this,n)>=0)return;switch(s.anchor){case e.ControlAnchor.TOP_RIGHT:o=this.controls.topright,n.style.position="relative",n.style.paddingRight="0px",n.style.paddingTop="0px";break;case e.ControlAnchor.BOTTOM_RIGHT:o=this.controls.bottomright,n.style.position="relative",n.style.paddingRight="0px",n.style.paddingBottom="0px";break;case e.ControlAnchor.BOTTOM_LEFT:o=this.controls.bottomleft,n.style.position="relative",n.style.paddingLeft="0px",n.style.paddingBottom="0px";break;case e.ControlAnchor.TOP_LEFT:o=this.controls.topleft,n.style.position="relative",n.style.paddingLeft="0px",n.style.paddingTop="0px";break;case e.ControlAnchor.ABSOLUTE:o=this.container,n.style.margin="0px",n.style.padding="0px";break;default:case e.ControlAnchor.NONE:o=this.container,n.style.margin="0px",n.style.padding="0px";break}this.controls.push(new e.Control(n,s,o)),n.style.display="inline-block"},removeControl:function(n){n=e.getElement(n);var s=t(this,n);return s>=0&&(this.controls[s].destroy(),this.controls.splice(s,1)),this},clearControls:function(){for(;this.controls.length>0;)this.controls.pop().destroy();return this},areControlsEnabled:function(){var e;for(e=this.controls.length-1;e>=0;e--)if(this.controls[e].isVisible())return!0;return!1},setControlsEnabled:function(e){var t;for(t=this.controls.length-1;t>=0;t--)this.controls[t].setVisible(e);return this}};function t(e,t){var n,s=e.controls;for(n=s.length-1;n>=0;n--)if(s[n].element===t)return n;return-1}}(n),function(e){e.Placement=e.freezeObject({CENTER:0,TOP_LEFT:1,TOP:2,TOP_RIGHT:3,RIGHT:4,BOTTOM_RIGHT:5,BOTTOM:6,BOTTOM_LEFT:7,LEFT:8,properties:{0:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1},1:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},2:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},3:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!0,isVerticallyCentered:!1,isBottom:!1},4:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!0,isBottom:!1},5:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!1,isBottom:!0},6:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},7:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},8:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1}}})}(n),function(e){var t={},V=1;e.Viewer=function(n){var a,i=arguments,s=this;e.isPlainObject(n)||(n={id:i[0],xmlPath:i.length>1?i[1]:0[0],prefixUrl:i.length>2?i[2]:0[0],controls:i.length>3?i[3]:0[0],overlays:i.length>4?i[4]:0[0]}),n.config&&(e.extend(!0,n,n.config),delete n.config);let d=["useCanvas"];if(n.drawerOptions=Object.assign({},d.reduce((e,t)=>(e[t]=n[t],delete n[t],e),{}),n.drawerOptions),e.extend(!0,this,{id:n.id,hash:n.hash||V++,initialPage:0,element:null,container:null,canvas:null,overlays:[],overlaysContainer:null,previousBody:[],customControls:[],source:null,drawer:null,world:null,viewport:null,navigator:null,collectionViewport:null,collectionDrawer:null,navImages:null,buttonGroup:null,profiler:null},e.DEFAULT_SETTINGS,n),typeof this.hash=="undefined")throw new Error("A hash must be defined, either by specifying options.id or options.hash.");typeof t[this.hash]!="undefined"&&e.console.warn("Hash "+this.hash+" has already been used."),t[this.hash]={fsBoundsDelta:new e.Point(1,1),prevContainerSize:null,animating:!1,forceRedraw:!1,needsResize:!1,forceResize:!1,mouseInside:!1,group:null,zooming:!1,zoomFactor:null,lastZoomTime:null,fullPage:!1,onfullscreenchange:null,lastClickTime:null,draggingToZoom:!1},this._sequenceIndex=0,this._firstOpen=!0,this._updateRequestId=null,this._loadQueue=[],this.currentOverlays=[],this._updatePixelDensityRatioBind=null,this._lastScrollTime=e.now(),e.EventSource.call(this),this.addHandler("open-failed",function(t){var n=e.getString("Errors.OpenFailed",t.eventSource,t.message);s._showMessage(n)}),e.ControlDock.call(this,n),this.xmlPath&&(this.tileSources=[this.xmlPath]),this.element=this.element||document.getElementById(this.id),this.canvas=e.makeNeutralElement("div"),this.canvas.className="openseadragon-canvas",function(e){e.width="100%",e.height="100%",e.overflow="hidden",e.position="absolute",e.top="0px",e.left="0px"}(this.canvas.style),e.setElementTouchActionNone(this.canvas),n.tabIndex!==""&&(this.canvas.tabIndex=n.tabIndex===0[0]?0:n.tabIndex),this.container.className="openseadragon-container",function(e){e.width="100%",e.height="100%",e.position="relative",e.overflow="hidden",e.left="0px",e.top="0px",e.textAlign="left"}(this.container.style),e.setElementTouchActionNone(this.container),this.container.insertBefore(this.canvas,this.container.firstChild),this.element.appendChild(this.container),this.bodyWidth=document.body.style.width,this.bodyHeight=document.body.style.height,this.bodyOverflow=document.body.style.overflow,this.docOverflow=document.documentElement.style.overflow,this.innerTracker=new e.MouseTracker({userData:"Viewer.innerTracker",element:this.canvas,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,contextMenuHandler:e.delegate(this,z),keyDownHandler:e.delegate(this,T),keyHandler:e.delegate(this,E),clickHandler:e.delegate(this,D),dblClickHandler:e.delegate(this,j),dragHandler:e.delegate(this,y),dragEndHandler:e.delegate(this,_),enterHandler:e.delegate(this,w),leaveHandler:e.delegate(this,O),pressHandler:e.delegate(this,x),releaseHandler:e.delegate(this,C),nonPrimaryPressHandler:e.delegate(this,v),nonPrimaryReleaseHandler:e.delegate(this,k),scrollHandler:e.delegate(this,F),pinchHandler:e.delegate(this,A),focusHandler:e.delegate(this,S),blurHandler:e.delegate(this,M)}),this.outerTracker=new e.MouseTracker({userData:"Viewer.outerTracker",element:this.container,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,enterHandler:e.delegate(this,g),leaveHandler:e.delegate(this,p)}),this.toolbar&&(this.toolbar=new e.ControlDock({element:this.toolbar})),this.bindStandardControls(),t[this.hash].prevContainerSize=c(this.container),window.ResizeObserver?(this._autoResizePolling=!1,this._resizeObserver=new ResizeObserver(function(){t[s.hash].needsResize=!0}),this._resizeObserver.observe(this.container,{})):this._autoResizePolling=!0,this.world=new e.World({viewer:this}),this.world.addHandler("add-item",function(){s.source=s.world.getItemAt(0).source,t[s.hash].forceRedraw=!0,s._updateRequestId||(s._updateRequestId=l(s,u))}),this.world.addHandler("remove-item",function(){s.world.getItemCount()?s.source=s.world.getItemAt(0).source:s.source=null,t[s.hash].forceRedraw=!0}),this.world.addHandler("metrics-change",function(){s.viewport&&s.viewport._setContentBounds(s.world.getHomeBounds(),s.world.getContentFactor())}),this.world.addHandler("item-index-change",function(){s.source=s.world.getItemAt(0).source}),this.viewport=new e.Viewport({containerSize:t[this.hash].prevContainerSize,springStiffness:this.springStiffness,animationTime:this.animationTime,minZoomImageRatio:this.minZoomImageRatio,maxZoomPixelRatio:this.maxZoomPixelRatio,visibilityRatio:this.visibilityRatio,wrapHorizontal:this.wrapHorizontal,wrapVertical:this.wrapVertical,defaultZoomLevel:this.defaultZoomLevel,minZoomLevel:this.minZoomLevel,maxZoomLevel:this.maxZoomLevel,viewer:this,degrees:this.degrees,flipped:this.flipped,overlayPreserveContentDirection:this.overlayPreserveContentDirection,navigatorRotate:this.navigatorRotate,homeFillsViewer:this.homeFillsViewer,margins:this.viewportMargins,silenceMultiImageWarnings:this.silenceMultiImageWarnings}),this.viewport._setContentBounds(this.world.getHomeBounds(),this.world.getContentFactor()),this.imageLoader=new e.ImageLoader({jobLimit:this.imageLoaderLimit,timeout:n.timeout,tileRetryMax:this.tileRetryMax,tileRetryDelay:this.tileRetryDelay}),this.tileCache=new e.TileCache({maxImageCacheCount:this.maxImageCacheCount}),Object.prototype.hasOwnProperty.call(this.drawerOptions,"useCanvas")&&(e.console.error('useCanvas is deprecated, use the "drawer" option to indicate preferred drawer(s)'),this.drawerOptions.useCanvas||(this.drawer=e.HTMLDrawer),delete this.drawerOptions.useCanvas);let r=Array.isArray(this.drawer)?this.drawer:[this.drawer];r.length===0&&(r=[e.DEFAULT_SETTINGS.drawer].flat(),e.console.warn("No valid drawers were selected. Using the default value.")),this.drawer=null;for(const e of r){let t=this.requestDrawer(e,{mainDrawer:!0,redrawImmediately:!1});if(t)break}if(!this.drawer)throw e.console.error("No drawer could be created!"),"Error with creating the selected drawer(s)";this.drawer.setImageSmoothingEnabled(this.imageSmoothingEnabled),this.overlaysContainer=e.makeNeutralElement("div"),this.canvas.appendChild(this.overlaysContainer),this.drawer.canRotate()||(this.rotateLeft&&(a=this.buttonGroup.buttons.indexOf(this.rotateLeft),this.buttonGroup.buttons.splice(a,1),this.buttonGroup.element.removeChild(this.rotateLeft.element)),this.rotateRight&&(a=this.buttonGroup.buttons.indexOf(this.rotateRight),this.buttonGroup.buttons.splice(a,1),this.buttonGroup.element.removeChild(this.rotateRight.element))),this._addUpdatePixelDensityRatioEvent(),this.showNavigator&&(this.navigator=new e.Navigator({element:this.navigatorElement,id:this.navigatorId,position:this.navigatorPosition,sizeRatio:this.navigatorSizeRatio,maintainSizeRatio:this.navigatorMaintainSizeRatio,top:this.navigatorTop,left:this.navigatorLeft,width:this.navigatorWidth,height:this.navigatorHeight,autoResize:this.navigatorAutoResize,autoFade:this.navigatorAutoFade,prefixUrl:this.prefixUrl,viewer:this,navigatorRotate:this.navigatorRotate,background:this.navigatorBackground,opacity:this.navigatorOpacity,borderColor:this.navigatorBorderColor,displayRegionColor:this.navigatorDisplayRegionColor,crossOriginPolicy:this.crossOriginPolicy,animationTime:this.animationTime,drawer:this.drawer.getType(),loadTilesWithAjax:this.loadTilesWithAjax,ajaxHeaders:this.ajaxHeaders,ajaxWithCredentials:this.ajaxWithCredentials})),this.sequenceMode&&this.bindSequenceControls(),this.tileSources&&this.open(this.tileSources);for(a=0;a<this.customControls.length;a++)this.addControl(this.customControls[a].id,{anchor:this.customControls[a].anchor});e.requestAnimationFrame(function(){o(s)}),e._viewers.set(this.element,this)},e.extend(e.Viewer.prototype,e.EventSource.prototype,e.ControlDock.prototype,{isOpen:function(){return!!this.world.getItemCount()},openDzi:function(t){return e.console.error("[Viewer.openDzi] this function is deprecated; use Viewer.open() instead."),this.open(t)},openTileSource:function(t){return e.console.error("[Viewer.openTileSource] this function is deprecated; use Viewer.open() instead."),this.open(t)},get buttons(){return e.console.warn("Viewer.buttons is deprecated; Please use Viewer.buttonGroup"),this.buttonGroup},open:function(t,n){var o,i,a,r,c,l,d,s=this;if(this.close(),!t)return this;if(this.sequenceMode&&e.isArray(t))return this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),typeof n!="undefined"&&!isNaN(n)&&(this.initialPage=n),this.tileSources=t,this._sequenceIndex=Math.max(0,Math.min(this.tileSources.length-1,this.initialPage)),this.tileSources.length&&(this.open(this.tileSources[this._sequenceIndex]),this.showReferenceStrip&&this.addReferenceStrip()),this._updateSequenceButtons(this._sequenceIndex),this;if(e.isArray(t)||(t=[t]),!t.length)return this;this._opening=!0;for(l=t.length,o=0,a=0,c=function(){if(o+a===l)if(o){(s._firstOpen||!s.preserveViewport)&&(s.viewport.goHome(!0),s.viewport.update()),s._firstOpen=!1;var e,n=t[0];if(n.tileSource&&(n=n.tileSource),s.overlays&&!s.preserveOverlays)for(e=0;e<s.overlays.length;e++)s.currentOverlays[e]=h(s,s.overlays[e]);s._drawOverlays(),s._opening=!1,s.raiseEvent("open",{source:n})}else s._opening=!1,s.raiseEvent("open-failed",r)},d=function(t){(!e.isPlainObject(t)||!t.tileSource)&&(t={tileSource:t}),t.index!==0[0]&&(e.console.error("[Viewer.open] setting indexes here is not supported; use addTiledImage instead"),delete t.index),t.collectionImmediately===0[0]&&(t.collectionImmediately=!0);var n,i=t.success;t.success=function(e){if(o++,t.tileSource.overlays)for(var n=0;n<t.tileSource.overlays.length;n++)s.addOverlay(t.tileSource.overlays[n]);i&&i(e),c()},n=t.error,t.error=function(e){a++,r||(r=e),n&&n(e),c()},s.addTiledImage(t)},i=0;i<t.length;i++)d(t[i]);return this},close:function(){return t[this.hash]?(this._opening=!1,this.navigator&&this.navigator.close(),this.preserveOverlays||(this.clearOverlays(),this.overlaysContainer.innerHTML=""),t[this.hash].animating=!1,this.world.removeAll(),this.imageLoader.clear(),this.raiseEvent("close"),this):this},destroy:function(){if(!t[this.hash])return;if(this.raiseEvent("before-destroy"),this._removeUpdatePixelDensityRatioEvent(),this.close(),this.clearOverlays(),this.overlaysContainer.innerHTML="",this._resizeObserver&&this._resizeObserver.disconnect(),this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),this._updateRequestId!==null&&(e.cancelAnimationFrame(this._updateRequestId),this._updateRequestId=null),this.drawer&&this.drawer.destroy(),this.navigator&&(this.navigator.destroy(),t[this.navigator.hash]=null,delete t[this.navigator.hash],this.navigator=null),this.buttonGroup)this.buttonGroup.destroy();else if(this.customButtons)for(;this.customButtons.length;)this.customButtons.pop().destroy();if(this.paging&&this.paging.destroy(),this.element)for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild);this.container.onsubmit=null,this.clearControls(),this.innerTracker&&this.innerTracker.destroy(),this.outerTracker&&this.outerTracker.destroy(),t[this.hash]=null,delete t[this.hash],this.canvas=null,this.container=null,e._viewers.delete(this.element),this.element=null,this.raiseEvent("destroy"),this.removeAllHandlers()},requestDrawer(t,n){const a={mainDrawer:!0,redrawImmediately:!0,drawerOptions:null};n=e.extend(!0,a,n);const o=n.mainDrawer,r=n.redrawImmediately,c=n.drawerOptions,i=this.drawer;let s=null;if(t&&t.prototype instanceof e.DrawerBase?(s=t,t="custom"):typeof t=="string"&&(s=e.determineDrawer(t)),s||e.console.warn("Unsupported drawer! Drawer must be an existing string type, or a class that extends OpenSeadragon.DrawerBase."),s&&s.isSupported()){i&&o&&i.destroy();const e=new s({viewer:this,viewport:this.viewport,element:this.canvas,debugGridColor:this.debugGridColor,options:c||this.drawerOptions[t]});return o&&(this.drawer=e,r&&this.forceRedraw()),e}return!1},isMouseNavEnabled:function(){return this.innerTracker.isTracking()},setMouseNavEnabled:function(e){return this.innerTracker.setTracking(e),this.outerTracker.setTracking(e),this.raiseEvent("mouse-enabled",{enabled:e}),this},areControlsEnabled:function(){var e,t=this.controls.length;for(e=0;e<this.controls.length;e++)t=t&&this.controls[e].isVisible();return t},setControlsEnabled:function(e){return e?i(this):o(this),this.raiseEvent("controls-enabled",{enabled:e}),this},setDebugMode:function(e){for(var t=0;t<this.world.getItemCount();t++)this.world.getItemAt(t).debugMode=e;this.debugMode=e,this.forceRedraw()},setAjaxHeaders:function(t,n){if(t===null&&(t={}),!e.isPlainObject(t)){console.error("[Viewer.setAjaxHeaders] Ignoring invalid headers, must be a plain object");return}if(n===0[0]&&(n=!0),this.ajaxHeaders=t,n){for(var o,s=0;s<this.world.getItemCount();s++)this.world.getItemAt(s)._updateAjaxHeaders(!0);if(this.navigator&&this.navigator.setAjaxHeaders(this.ajaxHeaders,!0),this.referenceStrip&&this.referenceStrip.miniViewers)for(o in this.referenceStrip.miniViewers)this.referenceStrip.miniViewers[o].setAjaxHeaders(this.ajaxHeaders,!0)}},addButton:function(e){this.buttonGroup.addButton(e)},isFullPage:function(){return t[this.hash]&&t[this.hash].fullPage},setFullPage:function(n){var a,r,l,d,u,i=document.body,s=i.style,o=document.documentElement.style,c=this;if(n===this.isFullPage())return this;if(l={fullPage:n,preventDefaultAction:!1},this.raiseEvent("pre-full-page",l),l.preventDefaultAction)return this;if(n&&this.element){this.elementSize=e.getElementSize(this.element),this.pageScroll=e.getPageScroll(),this.elementMargin=this.element.style.margin,this.element.style.margin="0",this.elementPadding=this.element.style.padding,this.element.style.padding="0",this.bodyMargin=s.margin,this.docMargin=o.margin,s.margin="0",o.margin="0",this.bodyPadding=s.padding,this.docPadding=o.padding,s.padding="0",o.padding="0",this.bodyWidth=s.width,this.docWidth=o.width,s.width="100%",o.width="100%",this.bodyHeight=s.height,this.docHeight=o.height,s.height="100%",o.height="100%",this.bodyDisplay=s.display,s.display="block",this.previousBody=[],t[this.hash].prevElementParent=this.element.parentNode,t[this.hash].prevNextSibling=this.element.nextSibling,t[this.hash].prevElementWidth=this.element.style.width,t[this.hash].prevElementHeight=this.element.style.height,r=i.childNodes.length;for(a=0;a<r;a++)this.previousBody.push(i.childNodes[0]),i.removeChild(i.childNodes[0]);this.toolbar&&this.toolbar.element&&(this.toolbar.parentNode=this.toolbar.element.parentNode,this.toolbar.nextSibling=this.toolbar.element.nextSibling,i.appendChild(this.toolbar.element),e.addClass(this.toolbar.element,"fullpage")),e.addClass(this.element,"fullpage"),i.appendChild(this.element),this.element.style.height="100vh",this.element.style.width="100vw",this.toolbar&&this.toolbar.element&&(this.element.style.height=e.getElementSize(this.element).y-e.getElementSize(this.toolbar.element).y+"px"),t[this.hash].fullPage=!0,e.delegate(this,g)({})}else{this.element.style.margin=this.elementMargin,this.element.style.padding=this.elementPadding,s.margin=this.bodyMargin,o.margin=this.docMargin,s.padding=this.bodyPadding,o.padding=this.docPadding,s.width=this.bodyWidth,o.width=this.docWidth,s.height=this.bodyHeight,o.height=this.docHeight,s.display=this.bodyDisplay,i.removeChild(this.element),r=this.previousBody.length;for(a=0;a<r;a++)i.appendChild(this.previousBody.shift());e.removeClass(this.element,"fullpage"),t[this.hash].prevElementParent.insertBefore(this.element,t[this.hash].prevNextSibling),this.toolbar&&this.toolbar.element&&(i.removeChild(this.toolbar.element),e.removeClass(this.toolbar.element,"fullpage"),this.toolbar.parentNode.insertBefore(this.toolbar.element,this.toolbar.nextSibling),delete this.toolbar.parentNode,delete this.toolbar.nextSibling),this.element.style.width=t[this.hash].prevElementWidth,this.element.style.height=t[this.hash].prevElementHeight,d=0,u=function(){e.setPageScroll(c.pageScroll);var t=e.getPageScroll();d++,d<10&&(t.x!==c.pageScroll.x||t.y!==c.pageScroll.y)&&e.requestAnimationFrame(u)},e.requestAnimationFrame(u),t[this.hash].fullPage=!1,e.delegate(this,p)({})}return this.navigator&&this.viewport&&this.navigator.update(this.viewport),this.raiseEvent("full-page",{fullPage:n}),this},setFullScreen:function(t){var s,o,n=this;if(!e.supportsFullScreen)return this.setFullPage(t);if(e.isFullScreen()===t)return this;if(o={fullScreen:t,preventDefaultAction:!1},this.raiseEvent("pre-full-screen",o),o.preventDefaultAction)return this;if(t){if(this.setFullPage(!0),!this.isFullPage())return this;this.fullPageStyleWidth=this.element.style.width,this.fullPageStyleHeight=this.element.style.height,this.element.style.width="100%",this.element.style.height="100%",s=function(){var t=e.isFullScreen();t||(e.removeEvent(document,e.fullScreenEventName,s),e.removeEvent(document,e.fullScreenErrorEventName,s),n.setFullPage(!1),n.isFullPage()&&(n.element.style.width=n.fullPageStyleWidth,n.element.style.height=n.fullPageStyleHeight)),n.navigator&&n.viewport&&setTimeout(function(){n.navigator.update(n.viewport)}),n.raiseEvent("full-screen",{fullScreen:t})},e.addEvent(document,e.fullScreenEventName,s),e.addEvent(document,e.fullScreenErrorEventName,s),e.requestFullScreen(document.body)}else e.exitFullScreen();return this},isVisible:function(){return this.container.style.visibility!=="hidden"},isFullScreen:function(){return e.isFullScreen()&&this.isFullPage()},setVisible:function(e){return this.container.style.visibility=e?"":"hidden",this.raiseEvent("visible",{visible:e}),this},addTiledImage:function(t){e.console.assert(t,"[Viewer.addTiledImage] options is required"),e.console.assert(t.tileSource,"[Viewer.addTiledImage] options.tileSource is required"),e.console.assert(!t.replace||t.index>-1&&t.index<this.world.getItemCount(),"[Viewer.addTiledImage] if options.replace is used, options.index must be a valid index in Viewer.world");var s,n=this;t.replace&&(t.replaceItem=n.world.getItemAt(t.index)),this._hideMessage(),t.placeholderFillStyle===0[0]&&(t.placeholderFillStyle=this.placeholderFillStyle),t.opacity===0[0]&&(t.opacity=this.opacity),t.preload===0[0]&&(t.preload=this.preload),t.compositeOperation===0[0]&&(t.compositeOperation=this.compositeOperation),t.crossOriginPolicy===0[0]&&(t.crossOriginPolicy=t.tileSource.crossOriginPolicy!==0[0]?t.tileSource.crossOriginPolicy:this.crossOriginPolicy),t.ajaxWithCredentials===0[0]&&(t.ajaxWithCredentials=this.ajaxWithCredentials),t.loadTilesWithAjax===0[0]&&(t.loadTilesWithAjax=this.loadTilesWithAjax),e.isPlainObject(t.ajaxHeaders)||(t.ajaxHeaders={}),s={options:t};function o(e){for(var o=0;o<n._loadQueue.length;o++)if(n._loadQueue[o]===s){n._loadQueue.splice(o,1);break}n._loadQueue.length===0&&i(s),n.raiseEvent("add-item-failed",e),t.error&&t.error(e)}function i(e){n.collectionMode&&(n.world.arrange({immediately:e.options.collectionImmediately,rows:n.collectionRows,columns:n.collectionColumns,layout:n.collectionLayout,tileSize:n.collectionTileSize,tileMargin:n.collectionTileMargin}),n.world.setAutoRefigureSizes(!0))}if(e.isArray(t.tileSource)){setTimeout(function(){o({message:"[Viewer.addTiledImage] Sequences can not be added; add them one at a time instead.",source:t.tileSource,options:t})});return}this._loadQueue.push(s);function a(){for(;n._loadQueue.length;){if(t=n._loadQueue[0],!t.tileSource)break;if(n._loadQueue.splice(0,1),t.options.replace){var t,s,o,a=n.world.getIndexOfItem(t.options.replaceItem);a!==-1&&(t.options.index=a),n.world.removeItem(t.options.replaceItem)}s=new e.TiledImage({viewer:n,source:t.tileSource,viewport:n.viewport,drawer:n.drawer,tileCache:n.tileCache,imageLoader:n.imageLoader,x:t.options.x,y:t.options.y,width:t.options.width,height:t.options.height,fitBounds:t.options.fitBounds,fitBoundsPlacement:t.options.fitBoundsPlacement,clip:t.options.clip,placeholderFillStyle:t.options.placeholderFillStyle,opacity:t.options.opacity,preload:t.options.preload,degrees:t.options.degrees,flipped:t.options.flipped,compositeOperation:t.options.compositeOperation,springStiffness:n.springStiffness,animationTime:n.animationTime,minZoomImageRatio:n.minZoomImageRatio,wrapHorizontal:n.wrapHorizontal,wrapVertical:n.wrapVertical,maxTilesPerFrame:n.maxTilesPerFrame,immediateRender:n.immediateRender,blendTime:n.blendTime,alwaysBlend:n.alwaysBlend,minPixelRatio:n.minPixelRatio,smoothTileEdgesMinZoom:n.smoothTileEdgesMinZoom,iOSDevice:n.iOSDevice,crossOriginPolicy:t.options.crossOriginPolicy,ajaxWithCredentials:t.options.ajaxWithCredentials,loadTilesWithAjax:t.options.loadTilesWithAjax,ajaxHeaders:t.options.ajaxHeaders,debugMode:n.debugMode,subPixelRoundingForTransparency:n.subPixelRoundingForTransparency}),n.collectionMode&&n.world.setAutoRefigureSizes(!1),n.navigator&&(o=e.extend({},t.options,{replace:!1,originalTiledImage:s,tileSource:t.tileSource}),n.navigator.addTiledImage(o)),n.world.addItem(s,{index:t.options.index}),n._loadQueue.length===0&&i(t),n.world.getItemCount()===1&&!n.preserveViewport&&n.viewport.goHome(!0),t.options.success&&t.options.success({item:s})}}P(this,t.tileSource,t,function(e){s.tileSource=e,a()},function(e){e.options=t,o(e),a()})},addSimpleImage:function(t){e.console.assert(t,"[Viewer.addSimpleImage] options is required"),e.console.assert(t.url,"[Viewer.addSimpleImage] options.url is required");var n=e.extend({},t,{tileSource:{type:"image",url:t.url}});delete n.url,this.addTiledImage(n)},addLayer:function(t){var s,n=this;return e.console.error("[Viewer.addLayer] this function is deprecated; use Viewer.addTiledImage() instead."),s=e.extend({},t,{success:function(e){n.raiseEvent("add-layer",{options:t,drawer:e.item})},error:function(e){n.raiseEvent("add-layer-failed",e)}}),this.addTiledImage(s),this},getLayerAtLevel:function(t){return e.console.error("[Viewer.getLayerAtLevel] this function is deprecated; use World.getItemAt() instead."),this.world.getItemAt(t)},getLevelOfLayer:function(t){return e.console.error("[Viewer.getLevelOfLayer] this function is deprecated; use World.getIndexOfItem() instead."),this.world.getIndexOfItem(t)},getLayersCount:function(){return e.console.error("[Viewer.getLayersCount] this function is deprecated; use World.getItemCount() instead."),this.world.getItemCount()},setLayerLevel:function(t,n){return e.console.error("[Viewer.setLayerLevel] this function is deprecated; use World.setItemIndex() instead."),this.world.setItemIndex(t,n)},removeLayer:function(t){return e.console.error("[Viewer.removeLayer] this function is deprecated; use World.removeItem() instead."),this.world.removeItem(t)},forceRedraw:function(){return t[this.hash].forceRedraw=!0,this},forceResize:function(){t[this.hash].needsResize=!0,t[this.hash].forceResize=!0},bindSequenceControls:function(){var n=e.delegate(this,m),o=e.delegate(this,f),a=e.delegate(this,this.goToNextPage),r=e.delegate(this,this.goToPreviousPage),t=this.navImages,i=!0;return this.showSequenceControl&&((this.previousButton||this.nextButton)&&(i=!1),this.previousButton=new e.Button({element:this.previousButton?e.getElement(this.previousButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.PreviousPage"),srcRest:s(this.prefixUrl,t.previous.REST),srcGroup:s(this.prefixUrl,t.previous.GROUP),srcHover:s(this.prefixUrl,t.previous.HOVER),srcDown:s(this.prefixUrl,t.previous.DOWN),onRelease:r,onFocus:n,onBlur:o}),this.nextButton=new e.Button({element:this.nextButton?e.getElement(this.nextButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.NextPage"),srcRest:s(this.prefixUrl,t.next.REST),srcGroup:s(this.prefixUrl,t.next.GROUP),srcHover:s(this.prefixUrl,t.next.HOVER),srcDown:s(this.prefixUrl,t.next.DOWN),onRelease:a,onFocus:n,onBlur:o}),this.navPrevNextWrap||this.previousButton.disable(),(!this.tileSources||!this.tileSources.length)&&this.nextButton.disable(),i&&(this.paging=new e.ButtonGroup({buttons:[this.previousButton,this.nextButton],clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.pagingControl=this.paging.element,this.toolbar?this.toolbar.addControl(this.pagingControl,{anchor:e.ControlAnchor.BOTTOM_RIGHT}):this.addControl(this.pagingControl,{anchor:this.sequenceControlAnchor||e.ControlAnchor.TOP_LEFT}))),this},bindStandardControls:function(){var l=e.delegate(this,H),a=e.delegate(this,B),b=e.delegate(this,W),c=e.delegate(this,I),v=e.delegate(this,U),g=e.delegate(this,q),d=e.delegate(this,Y),p=e.delegate(this,G),h=e.delegate(this,X),u=e.delegate(this,Q),o=e.delegate(this,m),i=e.delegate(this,f),t=this.navImages,n=[],r=!0;return this.showNavigationControl&&((this.zoomInButton||this.zoomOutButton||this.homeButton||this.fullPageButton||this.rotateLeftButton||this.rotateRightButton||this.flipButton)&&(r=!1),this.showZoomControl&&(n.push(this.zoomInButton=new e.Button({element:this.zoomInButton?e.getElement(this.zoomInButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.ZoomIn"),srcRest:s(this.prefixUrl,t.zoomIn.REST),srcGroup:s(this.prefixUrl,t.zoomIn.GROUP),srcHover:s(this.prefixUrl,t.zoomIn.HOVER),srcDown:s(this.prefixUrl,t.zoomIn.DOWN),onPress:l,onRelease:a,onClick:b,onEnter:l,onExit:a,onFocus:o,onBlur:i})),n.push(this.zoomOutButton=new e.Button({element:this.zoomOutButton?e.getElement(this.zoomOutButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.ZoomOut"),srcRest:s(this.prefixUrl,t.zoomOut.REST),srcGroup:s(this.prefixUrl,t.zoomOut.GROUP),srcHover:s(this.prefixUrl,t.zoomOut.HOVER),srcDown:s(this.prefixUrl,t.zoomOut.DOWN),onPress:c,onRelease:a,onClick:v,onEnter:c,onExit:a,onFocus:o,onBlur:i}))),this.showHomeControl&&n.push(this.homeButton=new e.Button({element:this.homeButton?e.getElement(this.homeButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.Home"),srcRest:s(this.prefixUrl,t.home.REST),srcGroup:s(this.prefixUrl,t.home.GROUP),srcHover:s(this.prefixUrl,t.home.HOVER),srcDown:s(this.prefixUrl,t.home.DOWN),onRelease:g,onFocus:o,onBlur:i})),this.showFullPageControl&&n.push(this.fullPageButton=new e.Button({element:this.fullPageButton?e.getElement(this.fullPageButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.FullPage"),srcRest:s(this.prefixUrl,t.fullpage.REST),srcGroup:s(this.prefixUrl,t.fullpage.GROUP),srcHover:s(this.prefixUrl,t.fullpage.HOVER),srcDown:s(this.prefixUrl,t.fullpage.DOWN),onRelease:d,onFocus:o,onBlur:i})),this.showRotationControl&&(n.push(this.rotateLeftButton=new e.Button({element:this.rotateLeftButton?e.getElement(this.rotateLeftButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.RotateLeft"),srcRest:s(this.prefixUrl,t.rotateleft.REST),srcGroup:s(this.prefixUrl,t.rotateleft.GROUP),srcHover:s(this.prefixUrl,t.rotateleft.HOVER),srcDown:s(this.prefixUrl,t.rotateleft.DOWN),onRelease:p,onFocus:o,onBlur:i})),n.push(this.rotateRightButton=new e.Button({element:this.rotateRightButton?e.getElement(this.rotateRightButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.RotateRight"),srcRest:s(this.prefixUrl,t.rotateright.REST),srcGroup:s(this.prefixUrl,t.rotateright.GROUP),srcHover:s(this.prefixUrl,t.rotateright.HOVER),srcDown:s(this.prefixUrl,t.rotateright.DOWN),onRelease:h,onFocus:o,onBlur:i}))),this.showFlipControl&&n.push(this.flipButton=new e.Button({element:this.flipButton?e.getElement(this.flipButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.Flip"),srcRest:s(this.prefixUrl,t.flip.REST),srcGroup:s(this.prefixUrl,t.flip.GROUP),srcHover:s(this.prefixUrl,t.flip.HOVER),srcDown:s(this.prefixUrl,t.flip.DOWN),onRelease:u,onFocus:o,onBlur:i})),r?(this.buttonGroup=new e.ButtonGroup({buttons:n,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.navControl=this.buttonGroup.element,this.addHandler("open",e.delegate(this,K)),this.toolbar?this.toolbar.addControl(this.navControl,{anchor:this.navigationControlAnchor||e.ControlAnchor.TOP_LEFT}):this.addControl(this.navControl,{anchor:this.navigationControlAnchor||e.ControlAnchor.TOP_LEFT})):this.customButtons=n),this},currentPage:function(){return this._sequenceIndex},goToPage:function(e){return this.tileSources&&e>=0&&e<this.tileSources.length&&(this._sequenceIndex=e,this._updateSequenceButtons(e),this.open(this.tileSources[e]),this.referenceStrip&&this.referenceStrip.setFocus(e),this.raiseEvent("page",{page:e})),this},addOverlay:function(t,n,s,o){if(e.isPlainObject(t)?i=t:i={element:t,location:n,placement:s,onDraw:o},t=e.getElement(i.element),a(this.currentOverlays,t)>=0)return this;var i,r=h(this,i);return this.currentOverlays.push(r),r.drawHTML(this.overlaysContainer,this.viewport),this.raiseEvent("add-overlay",{element:t,location:i.location,placement:i.placement}),this},updateOverlay:function(n,s,o){var i;return n=e.getElement(n),i=a(this.currentOverlays,n),i>=0&&(this.currentOverlays[i].update(s,o),t[this.hash].forceRedraw=!0,this.raiseEvent("update-overlay",{element:n,location:s,placement:o})),this},removeOverlay:function(n){var s;return n=e.getElement(n),s=a(this.currentOverlays,n),s>=0&&(this.currentOverlays[s].destroy(),this.currentOverlays.splice(s,1),t[this.hash].forceRedraw=!0,this.raiseEvent("remove-overlay",{element:n})),this},clearOverlays:function(){for(;this.currentOverlays.length>0;)this.currentOverlays.pop().destroy();return t[this.hash].forceRedraw=!0,this.raiseEvent("clear-overlay",{}),this},getOverlayById:function(t){var n;return t=e.getElement(t),n=a(this.currentOverlays,t),n>=0?this.currentOverlays[n]:null},_updateSequenceButtons:function(e){this.nextButton&&(!this.tileSources||this.tileSources.length-1===e?this.navPrevNextWrap||this.nextButton.disable():this.nextButton.enable()),this.previousButton&&(e>0?this.previousButton.enable():this.navPrevNextWrap||this.previousButton.disable())},_showMessage:function(t){this._hideMessage();var n=e.makeNeutralElement("div");n.appendChild(document.createTextNode(t)),this.messageDiv=e.makeCenteredNode(n),e.addClass(this.messageDiv,"openseadragon-message"),this.container.appendChild(this.messageDiv)},_hideMessage:function(){var e=this.messageDiv;e&&(e.parentNode.removeChild(e),delete this.messageDiv)},gestureSettingsByDeviceType:function(e){switch(e){case"mouse":return this.gestureSettingsMouse;case"touch":return this.gestureSettingsTouch;case"pen":return this.gestureSettingsPen;default:return this.gestureSettingsUnknown}},_drawOverlays:function(){var e,t=this.currentOverlays.length;for(e=0;e<t;e++)this.currentOverlays[e].drawHTML(this.overlaysContainer,this.viewport)},_cancelPendingImages:function(){this._loadQueue=[]},removeReferenceStrip:function(){this.showReferenceStrip=!1,this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null)},addReferenceStrip:function(){if(this.showReferenceStrip=!0,this.sequenceMode){if(this.referenceStrip)return;this.tileSources.length&&this.tileSources.length>1&&(this.referenceStrip=new e.ReferenceStrip({id:this.referenceStripElement,position:this.referenceStripPosition,sizeRatio:this.referenceStripSizeRatio,scroll:this.referenceStripScroll,height:this.referenceStripHeight,width:this.referenceStripWidth,tileSources:this.tileSources,prefixUrl:this.prefixUrl,viewer:this}),this.referenceStrip.setFocus(this._sequenceIndex))}else e.console.warn('Attempting to display a reference strip while "sequenceMode" is off.')},_addUpdatePixelDensityRatioEvent:function(){this._updatePixelDensityRatioBind=this._updatePixelDensityRatio.bind(this),e.addEvent(window,"resize",this._updatePixelDensityRatioBind)},_removeUpdatePixelDensityRatioEvent:function(){e.removeEvent(window,"resize",this._updatePixelDensityRatioBind)},_updatePixelDensityRatio:function(){var n=e.pixelDensityRatio,t=e.getCurrentPixelDensityRatio();n!==t&&(e.pixelDensityRatio=t,this.forceResize())},goToPreviousPage:function(){var e=this._sequenceIndex-1;this.navPrevNextWrap&&e<0&&(e+=this.tileSources.length),this.goToPage(e)},goToNextPage:function(){var e=this._sequenceIndex+1;this.navPrevNextWrap&&e>=this.tileSources.length&&(e=0),this.goToPage(e)},isAnimating:function(){return t[this.hash].animating}});function c(t){return t=e.getElement(t),new e.Point(t.clientWidth===0?1:t.clientWidth,t.clientHeight===0?1:t.clientHeight)}function P(t,n,s,o,i){var r,a=t;if(e.type(n)==="string")if(n.match(/^\s*<.*>\s*$/))n=e.parseXml(n);else if(n.match(/^\s*[{[].*[}\]]\s*$/))try{r=e.parseJSON(n),n=r}catch{}function c(e,t){e.ready?o(e):(e.addHandler("ready",function(){o(e)}),e.addHandler("open-failed",function(e){i({message:e.message,source:t})}))}setTimeout(function(){if(e.type(n)==="string")n=new e.TileSource({url:n,crossOriginPolicy:s.crossOriginPolicy!==0[0]?s.crossOriginPolicy:t.crossOriginPolicy,ajaxWithCredentials:t.ajaxWithCredentials,ajaxHeaders:s.ajaxHeaders?s.ajaxHeaders:t.ajaxHeaders,splitHashDataForPost:t.splitHashDataForPost,success:function(e){o(e.tileSource)}}),n.addHandler("open-failed",function(e){i(e)});else if(e.isPlainObject(n)||n.nodeType)if(n.crossOriginPolicy===0[0]&&(s.crossOriginPolicy!==0[0]||t.crossOriginPolicy!==0[0])&&(n.crossOriginPolicy=s.crossOriginPolicy!==0[0]?s.crossOriginPolicy:t.crossOriginPolicy),n.ajaxWithCredentials===0[0]&&(n.ajaxWithCredentials=t.ajaxWithCredentials),e.isFunction(n.getTileUrl)){var r,d,l=new e.TileSource(n);l.getTileUrl=n.getTileUrl,o(l)}else{if(r=e.TileSource.determineType(a,n),!r){i({message:"Unable to load TileSource",source:n});return}d=r.prototype.configure.apply(a,[n]),c(new r(d),n)}else c(n,n)})}function h(t,n){if(n instanceof e.Overlay)return n;var o,i,a,r,c,l,d,u,s=null;return n.element?s=e.getElement(n.element):(l=n.id?n.id:"openseadragon-overlay-"+Math.floor(Math.random()*1e7),s=e.getElement(n.id),s||(s=document.createElement("a"),s.href="#/overlay/"+l),s.id=l,e.addClass(s,n.className?n.className:"openseadragon-overlay")),c=n.location,o=n.width,i=n.height,c||(d=n.x,u=n.y,n.px!==0[0]&&(a=t.viewport.imageToViewportRectangle(new e.Rect(n.px,n.py,o||0,i||0)),d=a.x,u=a.y,o=o!==0[0]?a.width:0[0],i=i!==0[0]?a.height:0[0]),c=new e.Point(d,u)),r=n.placement,r&&e.type(r)==="string"&&(r=e.Placement[n.placement.toUpperCase()]),new e.Overlay({element:s,location:c,placement:r,onDraw:n.onDraw,checkResize:n.checkResize,width:o,height:i,rotationMode:n.rotationMode})}function a(e,t){var n;for(n=e.length-1;n>=0;n--)if(e[n].element===t)return n;return-1}function l(t,n){return e.requestAnimationFrame(function(){n(t)})}function d(t){e.requestAnimationFrame(function(){b(t)})}function o(t){if(!t.autoHideControls)return;t.controlsShouldFade=!0,t.controlsFadeBeginTime=e.now()+t.controlsFadeDelay,window.setTimeout(function(){d(t)},t.controlsFadeDelay)}function b(t){var n,s,o,i;if(t.controlsShouldFade){o=e.now(),i=o-t.controlsFadeBeginTime,n=1-i/t.controlsFadeLength,n=Math.min(1,n),n=Math.max(0,n);for(s=t.controls.length-1;s>=0;s--)t.controls[s].autoFade&&t.controls[s].setOpacity(n);n>0&&d(t)}}function i(e){var t;e.controlsShouldFade=!1;for(t=e.controls.length-1;t>=0;t--)e.controls[t].setOpacity(1)}function m(){i(this)}function f(){o(this)}function z(e){var t={tracker:e.eventSource,position:e.position,originalEvent:e.originalEvent,preventDefault:e.preventDefault};this.raiseEvent("canvas-contextmenu",t),e.preventDefault=t.preventDefault}function T(t){var n={originalEvent:t.originalEvent,preventDefaultAction:!1,preventVerticalPan:t.preventVerticalPan||!this.panVertical,preventHorizontalPan:t.preventHorizontalPan||!this.panHorizontal};if(this.raiseEvent("canvas-key",n),!n.preventDefaultAction&&!t.ctrl&&!t.alt&&!t.meta)switch(t.keyCode){case 38:n.preventVerticalPan||(t.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,-this.pixelsPerArrowPress))),this.viewport.applyConstraints()),t.preventDefault=!0;break;case 40:n.preventVerticalPan||(t.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,this.pixelsPerArrowPress))),this.viewport.applyConstraints()),t.preventDefault=!0;break;case 37:n.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(-this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),t.preventDefault=!0;break;case 39:n.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),t.preventDefault=!0;break;case 187:this.viewport.zoomBy(1.1),this.viewport.applyConstraints(),t.preventDefault=!0;break;case 189:this.viewport.zoomBy(.9),this.viewport.applyConstraints(),t.preventDefault=!0;break;case 48:this.viewport.goHome(),this.viewport.applyConstraints(),t.preventDefault=!0;break;case 87:n.preventVerticalPan||(t.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,-40))),this.viewport.applyConstraints()),t.preventDefault=!0;break;case 83:n.preventVerticalPan||(t.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,40))),this.viewport.applyConstraints()),t.preventDefault=!0;break;case 65:n.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(-40,0))),this.viewport.applyConstraints()),t.preventDefault=!0;break;case 68:n.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(40,0))),this.viewport.applyConstraints()),t.preventDefault=!0;break;case 82:t.shift?this.viewport.flipped?this.viewport.setRotation(this.viewport.getRotation()+this.rotationIncrement):this.viewport.setRotation(this.viewport.getRotation()-this.rotationIncrement):this.viewport.flipped?this.viewport.setRotation(this.viewport.getRotation()-this.rotationIncrement):this.viewport.setRotation(this.viewport.getRotation()+this.rotationIncrement),this.viewport.applyConstraints(),t.preventDefault=!0;break;case 70:this.viewport.toggleFlip(),t.preventDefault=!0;break;case 74:this.goToPreviousPage();break;case 75:this.goToNextPage();break;default:t.preventDefault=!1;break}else t.preventDefault=!1}function E(e){var t={originalEvent:e.originalEvent};this.raiseEvent("canvas-key-press",t)}function D(n){var s,o,i=document.activeElement===this.canvas;i||this.canvas.focus(),this.viewport.flipped&&(n.position.x=this.viewport.getContainerSize().x-n.position.x),o={tracker:n.eventSource,position:n.position,quick:n.quick,shift:n.shift,originalEvent:n.originalEvent,originalTarget:n.originalTarget,preventDefaultAction:!1},this.raiseEvent("canvas-click",o),!o.preventDefaultAction&&this.viewport&&n.quick&&(s=this.gestureSettingsByDeviceType(n.pointerType),s.clickToZoom===!0&&(this.viewport.zoomBy(n.shift?1/this.zoomPerClick:this.zoomPerClick,s.zoomToRefPoint?this.viewport.pointFromPixel(n.position,!0):null),this.viewport.applyConstraints()),s.dblClickDragToZoom&&(t[this.hash].draggingToZoom===!0?(t[this.hash].lastClickTime=null,t[this.hash].draggingToZoom=!1):t[this.hash].lastClickTime=e.now()))}function j(e){var t,n={tracker:e.eventSource,position:e.position,shift:e.shift,originalEvent:e.originalEvent,preventDefaultAction:!1};this.raiseEvent("canvas-double-click",n),!n.preventDefaultAction&&this.viewport&&(t=this.gestureSettingsByDeviceType(e.pointerType),t.dblClickToZoom&&(this.viewport.zoomBy(e.shift?1/this.zoomPerClick:this.zoomPerClick,t.zoomToRefPoint?this.viewport.pointFromPixel(e.position,!0):null),this.viewport.applyConstraints()))}function y(e){var n,s,o,a,i={tracker:e.eventSource,pointerType:e.pointerType,position:e.position,delta:e.delta,speed:e.speed,direction:e.direction,shift:e.shift,originalEvent:e.originalEvent,preventDefaultAction:!1};this.raiseEvent("canvas-drag",i),s=this.gestureSettingsByDeviceType(e.pointerType),!i.preventDefaultAction&&this.viewport&&(s.dblClickDragToZoom&&t[this.hash].draggingToZoom?(a=this.zoomPerDblClickDrag**(e.delta.y/50),this.viewport.zoomBy(a)):s.dragToPan&&!t[this.hash].draggingToZoom&&(this.panHorizontal||(e.delta.x=0),this.panVertical||(e.delta.y=0),this.viewport.flipped&&(e.delta.x=-e.delta.x),this.constrainDuringPan&&(n=this.viewport.deltaPointsFromPixels(e.delta.negate()),this.viewport.centerSpringX.target.value+=n.x,this.viewport.centerSpringY.target.value+=n.y,o=this.viewport.getConstrainedBounds(),this.viewport.centerSpringX.target.value-=n.x,this.viewport.centerSpringY.target.value-=n.y,o.xConstrained&&(e.delta.x=0),o.yConstrained&&(e.delta.y=0)),this.viewport.panBy(this.viewport.deltaPointsFromPixels(e.delta.negate()),s.flickEnabled&&!this.constrainDuringPan)))}function _(n){var s,o,i,a,c,r={tracker:n.eventSource,pointerType:n.pointerType,position:n.position,speed:n.speed,direction:n.direction,shift:n.shift,originalEvent:n.originalEvent,preventDefaultAction:!1};this.raiseEvent("canvas-drag-end",r),s=this.gestureSettingsByDeviceType(n.pointerType),!r.preventDefaultAction&&this.viewport&&(!t[this.hash].draggingToZoom&&s.dragToPan&&s.flickEnabled&&n.speed>=s.flickMinSpeed&&(o=0,this.panHorizontal&&(o=s.flickMomentum*n.speed*Math.cos(n.direction)),i=0,this.panVertical&&(i=s.flickMomentum*n.speed*Math.sin(n.direction)),a=this.viewport.pixelFromPoint(this.viewport.getCenter(!0)),c=this.viewport.pointFromPixel(new e.Point(a.x-o,a.y-i)),this.viewport.panTo(c,!1)),this.viewport.applyConstraints()),s.dblClickDragToZoom&&t[this.hash].draggingToZoom===!0&&(t[this.hash].draggingToZoom=!1)}function w(e){this.raiseEvent("canvas-enter",{tracker:e.eventSource,pointerType:e.pointerType,position:e.position,buttons:e.buttons,pointers:e.pointers,insideElementPressed:e.insideElementPressed,buttonDownAny:e.buttonDownAny,originalEvent:e.originalEvent})}function O(e){this.raiseEvent("canvas-exit",{tracker:e.eventSource,pointerType:e.pointerType,position:e.position,buttons:e.buttons,pointers:e.pointers,insideElementPressed:e.insideElementPressed,buttonDownAny:e.buttonDownAny,originalEvent:e.originalEvent})}function x(n){if(this.raiseEvent("canvas-press",{tracker:n.eventSource,pointerType:n.pointerType,position:n.position,insideElementPressed:n.insideElementPressed,insideElementReleased:n.insideElementReleased,originalEvent:n.originalEvent}),s=this.gestureSettingsByDeviceType(n.pointerType),s.dblClickDragToZoom){var s,o=t[this.hash].lastClickTime,i=e.now();if(o===null)return;i-o<this.dblClickTimeThreshold&&(t[this.hash].draggingToZoom=!0),t[this.hash].lastClickTime=null}}function C(e){this.raiseEvent("canvas-release",{tracker:e.eventSource,pointerType:e.pointerType,position:e.position,insideElementPressed:e.insideElementPressed,insideElementReleased:e.insideElementReleased,originalEvent:e.originalEvent})}function v(e){this.raiseEvent("canvas-nonprimary-press",{tracker:e.eventSource,position:e.position,pointerType:e.pointerType,button:e.button,buttons:e.buttons,originalEvent:e.originalEvent})}function k(e){this.raiseEvent("canvas-nonprimary-release",{tracker:e.eventSource,position:e.position,pointerType:e.pointerType,button:e.button,buttons:e.buttons,originalEvent:e.originalEvent})}function A(e){var n,s,o,i,a,r,t={tracker:e.eventSource,pointerType:e.pointerType,gesturePoints:e.gesturePoints,lastCenter:e.lastCenter,center:e.center,lastDistance:e.lastDistance,distance:e.distance,shift:e.shift,originalEvent:e.originalEvent,preventDefaultPanAction:!1,preventDefaultZoomAction:!1,preventDefaultRotateAction:!1};this.raiseEvent("canvas-pinch",t),this.viewport&&(s=this.gestureSettingsByDeviceType(e.pointerType),s.pinchToZoom&&(!t.preventDefaultPanAction||!t.preventDefaultZoomAction)&&(n=this.viewport.pointFromPixel(e.center,!0),s.zoomToRefPoint&&!t.preventDefaultPanAction&&(i=this.viewport.pointFromPixel(e.lastCenter,!0),o=i.minus(n),this.panHorizontal||(o.x=0),this.panVertical||(o.y=0),this.viewport.panBy(o,!0)),t.preventDefaultZoomAction||this.viewport.zoomBy(e.distance/e.lastDistance,n,!0),this.viewport.applyConstraints()),s.pinchRotate&&!t.preventDefaultRotateAction&&(a=Math.atan2(e.gesturePoints[0].currentPos.y-e.gesturePoints[1].currentPos.y,e.gesturePoints[0].currentPos.x-e.gesturePoints[1].currentPos.x),r=Math.atan2(e.gesturePoints[0].lastPos.y-e.gesturePoints[1].lastPos.y,e.gesturePoints[0].lastPos.x-e.gesturePoints[1].lastPos.x),n=this.viewport.pointFromPixel(e.center,!0),this.viewport.rotateTo(this.viewport.getRotation(!0)+(a-r)*(180/Math.PI),n,!0)))}function S(e){this.raiseEvent("canvas-focus",{tracker:e.eventSource,originalEvent:e.originalEvent})}function M(e){this.raiseEvent("canvas-blur",{tracker:e.eventSource,originalEvent:e.originalEvent})}function F(t){var n,s,o,i=e.now(),a=i-this._lastScrollTime;a>this.minScrollDeltaTime?(this._lastScrollTime=i,n={tracker:t.eventSource,position:t.position,scroll:t.scroll,shift:t.shift,originalEvent:t.originalEvent,preventDefaultAction:!1,preventDefault:!0},this.raiseEvent("canvas-scroll",n),!n.preventDefaultAction&&this.viewport&&(this.viewport.flipped&&(t.position.x=this.viewport.getContainerSize().x-t.position.x),s=this.gestureSettingsByDeviceType(t.pointerType),s.scrollToZoom&&(o=this.zoomPerScroll**t.scroll,this.viewport.zoomBy(o,s.zoomToRefPoint?this.viewport.pointFromPixel(t.position,!0):null),this.viewport.applyConstraints())),t.preventDefault=n.preventDefault):t.preventDefault=!0}function g(e){t[this.hash].mouseInside=!0,i(this),this.raiseEvent("container-enter",{tracker:e.eventSource,pointerType:e.pointerType,position:e.position,buttons:e.buttons,pointers:e.pointers,insideElementPressed:e.insideElementPressed,buttonDownAny:e.buttonDownAny,originalEvent:e.originalEvent})}function p(e){e.pointers<1&&(t[this.hash].mouseInside=!1,t[this.hash].animating||o(this)),this.raiseEvent("container-exit",{tracker:e.eventSource,pointerType:e.pointerType,position:e.position,buttons:e.buttons,pointers:e.pointers,insideElementPressed:e.insideElementPressed,buttonDownAny:e.buttonDownAny,originalEvent:e.originalEvent})}function u(e){L(e),e.isOpen()?e._updateRequestId=l(e,u):e._updateRequestId=!1}function N(n,s){var i,a,r,c,o=n.viewport,l=o.getZoom(),d=o.getCenter();o.resize(s,n.preserveImageSizeOnResize),o.panTo(d,!0),n.preserveImageSizeOnResize?i=t[n.hash].prevContainerSize.x/s.x:(a=new e.Point(0,0),r=new e.Point(t[n.hash].prevContainerSize.x,t[n.hash].prevContainerSize.y).distanceTo(a),c=new e.Point(s.x,s.y).distanceTo(a),i=c/r*t[n.hash].prevContainerSize.x/s.x),o.zoomTo(l*i,null,!0),t[n.hash].prevContainerSize=s,t[n.hash].forceRedraw=!0,t[n.hash].needsResize=!1,t[n.hash].forceResize=!1}function L(e){if(e._opening||!t[e.hash])return;if(e.autoResize||t[e.hash].forceResize){if(e._autoResizePolling){r=c(e.container);var n,s,a,r,l,d=t[e.hash].prevContainerSize;r.equals(d)||(t[e.hash].needsResize=!0)}t[e.hash].needsResize&&N(e,r||c(e.container))}s=e.viewport.update(),n=e.world.update(s)||s,s&&e.raiseEvent("viewport-change"),e.referenceStrip&&(n=e.referenceStrip.update(e.viewport)||n),l=t[e.hash].animating,!l&&n&&(e.raiseEvent("animation-start"),i(e)),a=l&&!n,a&&(t[e.hash].animating=!1),(n||a||t[e.hash].forceRedraw||e.world.needsDraw())&&(R(e),e._drawOverlays(),e.navigator&&e.navigator.update(e.viewport),t[e.hash].forceRedraw=!1,n&&e.raiseEvent("animation")),a&&(e.raiseEvent("animation-finish"),t[e.hash].mouseInside||o(e)),t[e.hash].animating=n}function R(e){e.imageLoader.clear(),e.world.draw(),e.raiseEvent("update-viewport",{})}function s(e,t){return e?e+t:t}function H(){t[this.hash].lastZoomTime=e.now(),t[this.hash].zoomFactor=this.zoomPerSecond,t[this.hash].zooming=!0,r(this)}function I(){t[this.hash].lastZoomTime=e.now(),t[this.hash].zoomFactor=1/this.zoomPerSecond,t[this.hash].zooming=!0,r(this)}function B(){t[this.hash].zooming=!1}function r(t){e.requestAnimationFrame(e.delegate(t,$))}function $(){var n,s,o;t[this.hash].zooming&&this.viewport&&(n=e.now(),s=n-t[this.hash].lastZoomTime,o=t[this.hash].zoomFactor**(s/1e3),this.viewport.zoomBy(o),this.viewport.applyConstraints(),t[this.hash].lastZoomTime=n,r(this))}function W(){this.viewport&&(t[this.hash].zooming=!1,this.viewport.zoomBy(this.zoomPerClick/1),this.viewport.applyConstraints())}function U(){this.viewport&&(t[this.hash].zooming=!1,this.viewport.zoomBy(1/this.zoomPerClick),this.viewport.applyConstraints())}function K(){this.buttonGroup&&(this.buttonGroup.emulateEnter(),this.buttonGroup.emulateLeave())}function q(){this.viewport&&this.viewport.goHome()}function Y(){this.isFullPage()&&!e.isFullScreen()?this.setFullPage(!1):this.setFullScreen(!this.isFullPage()),this.buttonGroup&&this.buttonGroup.emulateLeave(),this.fullPageButton.element.focus(),this.viewport&&this.viewport.applyConstraints()}function G(){if(this.viewport){var e=this.viewport.getRotation();this.viewport.flipped?e+=this.rotationIncrement:e-=this.rotationIncrement,this.viewport.setRotation(e)}}function X(){if(this.viewport){var e=this.viewport.getRotation();this.viewport.flipped?e-=this.rotationIncrement:e+=this.rotationIncrement,this.viewport.setRotation(e)}}function Q(){this.viewport.toggleFlip()}e.determineDrawer=function(t){for(let i in n){const o=n[i],s=o.prototype;if(s&&s instanceof n.DrawerBase&&e.isFunction(s.getType)&&s.getType.call(o)===t)return o}return null}}(n),function(e){e.Navigator=function(n){var l,d,h,c=n.viewer,r=this;n.element||n.id?(n.element?(n.id&&e.console.warn("Given option.id for Navigator was ignored since option.element was provided and is being used instead."),n.element.id?n.id=n.element.id:n.id="navigator-"+e.now(),this.element=n.element):this.element=document.getElementById(n.id),n.controlOptions={anchor:e.ControlAnchor.NONE,attachToViewer:!1,autoFade:!1}):(n.id="navigator-"+e.now(),this.element=e.makeNeutralElement("div"),n.controlOptions={anchor:e.ControlAnchor.TOP_RIGHT,attachToViewer:!0,autoFade:n.autoFade},n.position&&("BOTTOM_RIGHT"===n.position?n.controlOptions.anchor=e.ControlAnchor.BOTTOM_RIGHT:"BOTTOM_LEFT"===n.position?n.controlOptions.anchor=e.ControlAnchor.BOTTOM_LEFT:"TOP_RIGHT"===n.position?n.controlOptions.anchor=e.ControlAnchor.TOP_RIGHT:"TOP_LEFT"===n.position?n.controlOptions.anchor=e.ControlAnchor.TOP_LEFT:"ABSOLUTE"===n.position&&(n.controlOptions.anchor=e.ControlAnchor.ABSOLUTE,n.controlOptions.top=n.top,n.controlOptions.left=n.left,n.controlOptions.height=n.height,n.controlOptions.width=n.width))),this.element.id=n.id,this.element.className+=" navigator",n=e.extend(!0,{sizeRatio:e.DEFAULT_SETTINGS.navigatorSizeRatio},n,{element:this.element,tabIndex:-1,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:n.animationTime,autoResize:!1,minZoomImageRatio:1,background:n.background,opacity:n.opacity,borderColor:n.borderColor,displayRegionColor:n.displayRegionColor}),n.minPixelRatio=this.minPixelRatio=c.minPixelRatio,e.setElementTouchActionNone(this.element),this.borderWidth=2,this.fudge=new e.Point(1,1),this.totalBorderWidths=new e.Point(this.borderWidth*2,this.borderWidth*2).minus(this.fudge),n.controlOptions.anchor!==e.ControlAnchor.NONE&&function(e,t){e.margin="0px",e.border=t+"px solid "+n.borderColor,e.padding="0px",e.background=n.background,e.opacity=n.opacity,e.overflow="hidden"}(this.element.style,this.borderWidth),this.displayRegion=e.makeNeutralElement("div"),this.displayRegion.id=this.element.id+"-displayregion",this.displayRegion.className="displayregion",function(e,t){e.position="relative",e.top="0px",e.left="0px",e.fontSize="0px",e.overflow="hidden",e.border=t+"px solid "+n.displayRegionColor,e.margin="0px",e.padding="0px",e.background="transparent",e.float="left",e.cssFloat="left",e.zIndex=999999999,e.cursor="default",e.boxSizing="content-box"}(this.displayRegion.style,this.borderWidth),e.setElementPointerEventsNone(this.displayRegion),e.setElementTouchActionNone(this.displayRegion),this.displayRegionContainer=e.makeNeutralElement("div"),this.displayRegionContainer.id=this.element.id+"-displayregioncontainer",this.displayRegionContainer.className="displayregioncontainer",this.displayRegionContainer.style.width="100%",this.displayRegionContainer.style.height="100%",e.setElementPointerEventsNone(this.displayRegionContainer),e.setElementTouchActionNone(this.displayRegionContainer),c.addControl(this.element,n.controlOptions),this._resizeWithViewer=n.controlOptions.anchor!==e.ControlAnchor.ABSOLUTE&&n.controlOptions.anchor!==e.ControlAnchor.NONE,n.width&&n.height?(this.setWidth(n.width),this.setHeight(n.height)):this._resizeWithViewer&&(l=e.getElementSize(c.element),this.element.style.height=Math.round(l.y*n.sizeRatio)+"px",this.element.style.width=Math.round(l.x*n.sizeRatio)+"px",this.oldViewerSize=l,d=e.getElementSize(this.element),this.elementArea=d.x*d.y),this.oldContainerSize=new e.Point(0,0),e.Viewer.apply(this,[n]),this.displayRegionContainer.appendChild(this.displayRegion),this.element.getElementsByTagName("div")[0].appendChild(this.displayRegionContainer);function u(e,n){t(r.displayRegionContainer,e),t(r.displayRegion,-e),r.viewport.setRotation(e,n)}n.navigatorRotate&&(h=n.viewer.viewport?n.viewer.viewport.getRotation():n.viewer.degrees||0,u(h,!0),n.viewer.addHandler("rotate",function(e){u(e.degrees,e.immediately)})),this.innerTracker.destroy(),this.innerTracker=new e.MouseTracker({userData:"Navigator.innerTracker",element:this.element,dragHandler:e.delegate(this,o),clickHandler:e.delegate(this,s),releaseHandler:e.delegate(this,i),scrollHandler:e.delegate(this,a),preProcessEventHandler:function(e){e.eventType==="wheel"&&(e.preventDefault=!0)}}),this.outerTracker.userData="Navigator.outerTracker",e.setElementPointerEventsNone(this.canvas),e.setElementPointerEventsNone(this.container),this.addHandler("reset-size",function(){r.viewport&&r.viewport.goHome(!0)}),c.world.addHandler("item-index-change",function(e){window.setTimeout(function(){var t=r.world.getItemAt(e.previousIndex);r.world.setItemIndex(t,e.newIndex)},1)}),c.world.addHandler("remove-item",function(e){var n=e.item,t=r._getMatchingItem(n);t&&r.world.removeItem(t)}),this.update(c.viewport)},e.extend(e.Navigator.prototype,e.EventSource.prototype,e.Viewer.prototype,{updateSize:function(){if(this.viewport){var t=new e.Point(this.container.clientWidth===0?1:this.container.clientWidth,this.container.clientHeight===0?1:this.container.clientHeight);t.equals(this.oldContainerSize)||(this.viewport.resize(t,!0),this.viewport.goHome(!0),this.oldContainerSize=t,this.world.update(),this.world.draw(),this.update(this.viewer.viewport))}},setWidth:function(e){this.width=e,this.element.style.width=typeof e=="number"?e+"px":e,this._resizeWithViewer=!1,this.updateSize()},setHeight:function(e){this.height=e,this.element.style.height=typeof e=="number"?e+"px":e,this._resizeWithViewer=!1,this.updateSize()},setFlip:function(e){return this.viewport.setFlip(e),this.setDisplayTransform(this.viewer.viewport.getFlip()?"scale(-1,1)":"scale(1,1)"),this},setDisplayTransform:function(e){n(this.canvas,e),n(this.element,e)},update:function(n){if(n||(n=this.viewer.viewport),s=e.getElementSize(this.viewer.element),this._resizeWithViewer&&s.x&&s.y&&!s.equals(this.oldViewerSize)&&(this.oldViewerSize=s,this.maintainSizeRatio||!this.elementArea?(i=s.x*this.sizeRatio,r=s.y*this.sizeRatio):(i=Math.sqrt(this.elementArea*(s.x/s.y)),r=this.elementArea/i),this.element.style.width=Math.round(i)+"px",this.element.style.height=Math.round(r)+"px",this.elementArea||(this.elementArea=i*r),this.updateSize()),n&&this.viewport){if(c=n.getBoundsNoRotate(!0),a=this.viewport.pixelFromPointNoRotate(c.getTopLeft(),!1),l=this.viewport.pixelFromPointNoRotate(c.getBottomRight(),!1).minus(this.totalBorderWidths),!this.navigatorRotate){var s,o,i,a,r,c,l,d,u,h=n.getRotation(!0);t(this.displayRegion,-h)}o=this.displayRegion.style,o.display=this.world.getItemCount()?"block":"none",o.top=a.y.toFixed(2)+"px",o.left=a.x.toFixed(2)+"px",d=l.x-a.x,u=l.y-a.y,o.width=Math.round(Math.max(d,0))+"px",o.height=Math.round(Math.max(u,0))+"px"}},addTiledImage:function(t){var o,s=this,n=t.originalTiledImage;return delete t.original,o=e.extend({},t,{success:function(e){var t=e.item;t._originalForNavigator=n,s._matchBounds(t,n,!0),s._matchOpacity(t,n),s._matchCompositeOperation(t,n);function o(){s._matchBounds(t,n)}function i(){s._matchOpacity(t,n)}function a(){s._matchCompositeOperation(t,n)}n.addHandler("bounds-change",o),n.addHandler("clip-change",o),n.addHandler("opacity-change",i),n.addHandler("composite-operation-change",a)}}),e.Viewer.prototype.addTiledImage.apply(this,[o])},destroy:function(){return e.Viewer.prototype.destroy.apply(this)},_getMatchingItem:function(e){for(var t,s=this.world.getItemCount(),n=0;n<s;n++)if(t=this.world.getItemAt(n),t._originalForNavigator===e)return t;return null},_matchBounds:function(e,t,n){var s=t.getBoundsNoRotate();e.setPosition(s.getTopLeft(),n),e.setWidth(s.width,n),e.setRotation(t.getRotation(),n),e.setClip(t.getClip()),e.setFlip(t.getFlip())},_matchOpacity:function(e,t){e.setOpacity(t.opacity)},_matchCompositeOperation:function(e,t){e.setCompositeOperation(t.compositeOperation)}});function s(e){var t,n={tracker:e.eventSource,position:e.position,quick:e.quick,shift:e.shift,originalEvent:e.originalEvent,preventDefaultAction:!1};this.viewer.raiseEvent("navigator-click",n),!n.preventDefaultAction&&e.quick&&this.viewer.viewport&&(this.panVertical||this.panHorizontal)&&(this.viewer.viewport.flipped&&(e.position.x=this.viewport.getContainerSize().x-e.position.x),t=this.viewport.pointFromPixel(e.position),this.panVertical?this.panHorizontal||(t.x=this.viewer.viewport.getCenter(!0).x):t.y=this.viewer.viewport.getCenter(!0).y,this.viewer.viewport.panTo(t),this.viewer.viewport.applyConstraints())}function o(e){var t={tracker:e.eventSource,position:e.position,delta:e.delta,speed:e.speed,direction:e.direction,shift:e.shift,originalEvent:e.originalEvent,preventDefaultAction:!1};this.viewer.raiseEvent("navigator-drag",t),!t.preventDefaultAction&&this.viewer.viewport&&(this.panHorizontal||(e.delta.x=0),this.panVertical||(e.delta.y=0),this.viewer.viewport.flipped&&(e.delta.x=-e.delta.x),this.viewer.viewport.panBy(this.viewport.deltaPointsFromPixels(e.delta)),this.viewer.constrainDuringPan&&this.viewer.viewport.applyConstraints())}function i(e){e.insideElementPressed&&this.viewer.viewport&&this.viewer.viewport.applyConstraints()}function a(e){var t={tracker:e.eventSource,position:e.position,scroll:e.scroll,shift:e.shift,originalEvent:e.originalEvent,preventDefault:e.preventDefault};this.viewer.raiseEvent("navigator-scroll",t),e.preventDefault=t.preventDefault}function t(e,t){n(e,"rotate("+t+"deg)")}function n(e,t){e.style.webkitTransform=t,e.style.mozTransform=t,e.style.msTransform=t,e.style.oTransform=t,e.style.transform=t}}(n),function(e){var t={Errors:{Dzc:"Sorry, we don't support Deep Zoom Collections!",Dzi:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",Xml:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",ImageFormat:"Sorry, we don't support {0}-based Deep Zoom Images.",Security:"It looks like a security restriction stopped us from loading this Deep Zoom Image.",Status:"This space unintentionally left blank ({0} {1}).",OpenFailed:"Unable to open {0}: {1}"},Tooltips:{FullPage:"Toggle full page",Home:"Go home",ZoomIn:"Zoom in",ZoomOut:"Zoom out",NextPage:"Next page",PreviousPage:"Previous page",RotateLeft:"Rotate left",RotateRight:"Rotate right",Flip:"Flip Horizontally"}};e.extend(e,{getString:function(n){var s,i=n.split("."),o=null,r=arguments,a=t;for(s=0;s<i.length-1;s++)a=a[i[s]]||{};return o=a[i[s]],typeof o!="string"&&(e.console.error("Untranslated source string:",n),o=""),o.replace(/\{\d+\}/g,function(e){var t=parseInt(e.match(/\d+/),10)+1;return t<r.length?r[t]:""})},setString:function(e,n){var s,o=e.split("."),i=t;for(s=0;s<o.length-1;s++)i[o[s]]||(i[o[s]]={}),i=i[o[s]];i[o[s]]=n}})}(n),function(e){e.Point=function(e,t){this.x=typeof e=="number"?e:0,this.y=typeof t=="number"?t:0},e.Point.prototype={clone:function(){return new e.Point(this.x,this.y)},plus:function(t){return new e.Point(this.x+t.x,this.y+t.y)},minus:function(t){return new e.Point(this.x-t.x,this.y-t.y)},times:function(t){return new e.Point(this.x*t,this.y*t)},divide:function(t){return new e.Point(this.x/t,this.y/t)},negate:function(){return new e.Point(-this.x,-this.y)},distanceTo:function(e){return Math.sqrt((this.x-e.x)**2+(this.y-e.y)**2)},squaredDistanceTo:function(e){return(this.x-e.x)**2+(this.y-e.y)**2},apply:function(t){return new e.Point(t(this.x),t(this.y))},equals:function(t){return t instanceof e.Point&&this.x===t.x&&this.y===t.y},rotate:function(t,n){if(n=n||new e.Point(0,0),t%90===0){var s,o,i,a,r,c=e.positiveModulo(t,360);switch(c){case 0:s=1,o=0;break;case 90:s=0,o=1;break;case 180:s=-1,o=0;break;case 270:s=0,o=-1;break}}else i=t*Math.PI/180,s=Math.cos(i),o=Math.sin(i);return a=s*(this.x-n.x)-o*(this.y-n.y)+n.x,r=o*(this.x-n.x)+s*(this.y-n.y)+n.y,new e.Point(a,r)},toString:function(){return"("+Math.round(this.x*100)/100+","+Math.round(this.y*100)/100+")"}}}(n),function(e){e.TileSource=function(t){var r,l,d=this,c=arguments;if(e.isPlainObject(t)?r=t:r={width:c[0],height:c[1],tileSize:c[2],tileOverlap:c[3],minLevel:c[4],maxLevel:c[5]},e.EventSource.call(this),e.extend(!0,this,r),!this.success)for(l=0;l<arguments.length;l++)if(e.isFunction(arguments[l])){this.success=arguments[l];break}this.success&&this.addHandler("ready",function(e){d.success(e)}),"string"===e.type(arguments[0])&&(this.url=arguments[0]),this.url?(this.aspectRatio=1,this.dimensions=new e.Point(10,10),this._tileWidth=0,this._tileHeight=0,this.tileOverlap=0,this.minLevel=0,this.maxLevel=0,this.ready=!1,this.getImageInfo(this.url)):(this.ready=!0,this.aspectRatio=r.width&&r.height?r.width/r.height:1,this.dimensions=new e.Point(r.width,r.height),this.tileSize?(this._tileWidth=this._tileHeight=this.tileSize,delete this.tileSize):(this.tileWidth?(this._tileWidth=this.tileWidth,delete this.tileWidth):this._tileWidth=0,this.tileHeight?(this._tileHeight=this.tileHeight,delete this.tileHeight):this._tileHeight=0),this.tileOverlap=r.tileOverlap?r.tileOverlap:0,this.minLevel=r.minLevel?r.minLevel:0,this.maxLevel=0[0]!==r.maxLevel&&null!==r.maxLevel?r.maxLevel:r.width&&r.height?Math.ceil(Math.log(Math.max(r.width,r.height))/Math.log(2)):0,this.success&&e.isFunction(this.success)&&this.success(this))},e.TileSource.prototype={getTileSize:function(){return e.console.error("[TileSource.getTileSize] is deprecated. Use TileSource.getTileWidth() and TileSource.getTileHeight() instead"),this._tileWidth},getTileWidth:function(e){return this._tileWidth?this._tileWidth:this.getTileSize(e)},getTileHeight:function(e){return this._tileHeight?this._tileHeight:this.getTileSize(e)},setMaxLevel:function(e){this.maxLevel=e,this._memoizeLevelScale()},getLevelScale:function(e){return this._memoizeLevelScale(),this.getLevelScale(e)},_memoizeLevelScale:function(){var e,t={};for(e=0;e<=this.maxLevel;e++)t[e]=1/2**(this.maxLevel-e);this.getLevelScale=function(e){return t[e]}},getNumTiles:function(t){var n=this.getLevelScale(t),s=Math.ceil(n*this.dimensions.x/this.getTileWidth(t)),o=Math.ceil(n*this.dimensions.y/this.getTileHeight(t));return new e.Point(s,o)},getPixelRatio:function(t){var n=this.dimensions.times(this.getLevelScale(t)),s=1/n.x*e.pixelDensityRatio,o=1/n.y*e.pixelDensityRatio;return new e.Point(s,o)},getClosestLevel:function(){var e,t;for(e=this.minLevel+1;e<=this.maxLevel;e++)if(t=this.getNumTiles(e),t.x>1||t.y>1)break;return e-1},getTileAtPoint:function(t,n){var s,o,i,a,r,c,l=n.x>=0&&n.x<=1&&n.y>=0&&n.y<=1/this.aspectRatio;return e.console.assert(l,"[TileSource.getTileAtPoint] must be called with a valid point."),s=this.dimensions.x*this.getLevelScale(t),a=n.x*s,r=n.y*s,o=Math.floor(a/this.getTileWidth(t)),i=Math.floor(r/this.getTileHeight(t)),n.x>=1&&(o=this.getNumTiles(t).x-1),c=1e-15,n.y>=1/this.aspectRatio-c&&(i=this.getNumTiles(t).y-1),new e.Point(o,i)},getTileBounds:function(t,n,s,o){var c=this.dimensions.times(this.getLevelScale(t)),l=this.getTileWidth(t),d=this.getTileHeight(t),u=n===0?0:l*n-this.tileOverlap,h=s===0?0:d*s-this.tileOverlap,i=l+(n===0?1:2)*this.tileOverlap,a=d+(s===0?1:2)*this.tileOverlap,r=1/c.x,i=Math.min(i,c.x-u),a=Math.min(a,c.y-h);return o?new e.Rect(0,0,i,a):new e.Rect(u*r,h*r,i*r,a*r)},getImageInfo:function(n){var o,i,a,r,c,l,d,u,h,s=this;n&&(o=n.split("/"),l=o[o.length-1],d=l.lastIndexOf("."),d>-1&&(o[o.length-1]=l.slice(0,d))),i=null,this.splitHashDataForPost&&(r=n.indexOf("#"),r!==-1&&(i=n.substring(r+1),n=n.substr(0,r))),c=function(t){typeof t=="string"&&(t=e.parseXml(t));var o=e.TileSource.determineType(s,t,n);if(!o){s.raiseEvent("open-failed",{message:"Unable to load TileSource",source:n});return}a=o.prototype.configure.apply(s,[t,n,i]),a.ajaxWithCredentials===0[0]&&(a.ajaxWithCredentials=s.ajaxWithCredentials),h=new o(a),s.ready=!0,s.raiseEvent("ready",{tileSource:h})},n.match(/\.js$/)?(u=n.split("/").pop().replace(".js",""),e.jsonp({url:n,async:!1,callbackName:u,callback:c})):e.makeAjaxRequest({url:n,postData:i,withCredentials:this.ajaxWithCredentials,headers:this.ajaxHeaders,success:function(e){var n=t(e);c(n)},error:function(t,o){var a,r;try{a="HTTP "+t.status+" attempting to load TileSource: "+n}catch{typeof o=="undefined"||!o.toString?r="Unknown error":r=o.toString(),a=r+" attempting to load TileSource: "+n}e.console.error(a),s.raiseEvent("open-failed",{message:a,source:n,postData:i})}})},supports:function(){return!1},configure:function(){throw new Error("Method not implemented.")},getTileUrl:function(){throw new Error("Method not implemented.")},getTilePostData:function(){return null},getTileAjaxHeaders:function(){return{}},getTileHashKey:function(e,t,n,s,o){function a(e){return o?e+"+"+JSON.stringify(o):e}return a(typeof s!="string"?e+"/"+t+"_"+n:s)},tileExists:function(e,t,n){var s=this.getNumTiles(e);return e>=this.minLevel&&e<=this.maxLevel&&t>=0&&n>=0&&t<s.x&&n<s.y},hasTransparency:function(e,t){return!!e||t.match(".png")},downloadTileStart:function(t){var o,s=t.userData,n=new Image;s.image=n,s.request=null,o=function(e){if(!n){t.finish(null,s.request,"Image load failed: undefined Image instance.");return}n.onload=n.onerror=n.onabort=null,t.finish(e?null:n,s.request,e)},n.onload=function(){o()},n.onabort=n.onerror=function(){o("Image load aborted.")},t.loadWithAjax?s.request=e.makeAjaxRequest({url:t.src,withCredentials:t.ajaxWithCredentials,headers:t.ajaxHeaders,responseType:"arraybuffer",postData:t.postData,success:function(e){try{t=new window.Blob([e.response])}catch(n){var t,s,i=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;n.name==="TypeError"&&i&&(s=new i,s.append(e.response),t=s.getBlob())}t.size===0?o("Empty image response."):n.src=(window.URL||window.webkitURL).createObjectURL(t)},error:function(){o("Image load aborted - XHR error")}}):(t.crossOriginPolicy!==!1&&(n.crossOrigin=t.crossOriginPolicy),n.src=t.src)},downloadTileAbort:function(e){e.userData.request&&e.userData.request.abort();var t=e.userData.image;e.userData.image&&(t.onload=t.onerror=t.onabort=null)},createTileCache:function(e,t){e._data=t},destroyTileCache:function(e){e._data=null,e._renderedContext=null},getTileCacheData:function(e){return e._data},getTileCacheDataAsImage:function(e){return e._data},getTileCacheDataAsContext2D:function(e){if(!e._renderedContext){var t=document.createElement("canvas");t.width=e._data.width,t.height=e._data.height,e._renderedContext=t.getContext("2d"),e._renderedContext.drawImage(e._data,0,0),e._data=null}return e._renderedContext}},e.extend(!0,e.TileSource.prototype,e.EventSource.prototype);function t(t){var s,i,n=t.responseText,o=t.status;if(!t)throw new Error(e.getString("Errors.Security"));if(t.status!==200&&t.status!==0)throw o=t.status,i=o===404?"Not Found":t.statusText,new Error(e.getString("Errors.Status",o,i));if(n.match(/^\s*<.*/))try{s=t.responseXML&&t.responseXML.documentElement?t.responseXML:e.parseXml(n)}catch{s=t.responseText}else if(n.match(/\s*[{[].*/))try{s=e.parseJSON(n)}catch{s=n}else s=n;return s}e.TileSource.determineType=function(t,s,o){var i;for(i in n)if(i.match(/.+TileSource$/)&&e.isFunction(n[i])&&e.isFunction(n[i].prototype.supports)&&n[i].prototype.supports.call(t,s,o))return n[i];return e.console.error("No TileSource was able to open %s %s",o,s),null}}(n),function(e){e.DziTileSource=function(t){var d,u,h,m;if(e.isPlainObject(t)?u=t:u={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4],fileFormat:arguments[5],displayRects:arguments[6],minLevel:arguments[7],maxLevel:arguments[8]},this._levelRects={},this.tilesUrl=u.tilesUrl,this.fileFormat=u.fileFormat,this.displayRects=u.displayRects,this.displayRects)for(h=this.displayRects.length-1;h>=0;h--){m=this.displayRects[h];for(d=m.minLevel;d<=m.maxLevel;d++)this._levelRects[d]||(this._levelRects[d]=[]),this._levelRects[d].push(m)}e.TileSource.apply(this,[u])},e.extend(e.DziTileSource.prototype,e.TileSource.prototype,{supports:function(e){var n;return e.Image?n=e.Image.xmlns:e.documentElement&&("Image"===e.documentElement.localName||"Image"===e.documentElement.tagName)&&(n=e.documentElement.namespaceURI),n=(n||"").toLowerCase(),n.indexOf("schemas.microsoft.com/deepzoom/2008")!==-1||n.indexOf("schemas.microsoft.com/deepzoom/2009")!==-1},configure:function(s,o){var a;return e.isPlainObject(s)?a=t(this,s):a=n(this,s),o&&!a.tilesUrl&&(a.tilesUrl=o.replace(/([^/]+?)(\.(dzi|xml|js)?(\?[^/]*)?)?\/?$/,"$1_files/"),o.search(/\.(dzi|xml|js)\?/)!==-1?a.queryParams=o.match(/\?.*/):a.queryParams=""),a},getTileUrl:function(e,t,n){return[this.tilesUrl,e,"/",t,"_",n,".",this.fileFormat,this.queryParams].join("")},tileExists:function(e,t,n){var s,o,i,a,c,l,d,r=this._levelRects[e];if(this.minLevel&&e<this.minLevel||this.maxLevel&&e>this.maxLevel)return!1;if(!r||!r.length)return!0;for(d=r.length-1;d>=0;d--){if(s=r[d],e<s.minLevel||e>s.maxLevel)continue;if(o=this.getLevelScale(e),i=s.x*o,a=s.y*o,c=i+s.width*o,l=a+s.height*o,i=Math.floor(i/this._tileWidth),a=Math.floor(a/this._tileWidth),c=Math.ceil(c/this._tileWidth),l=Math.ceil(l/this._tileWidth),i<=t&&t<c&&a<=n&&n<l)return!0}return!1}});function n(n,s){if(!s||!s.documentElement)throw new Error(e.getString("Errors.Xml"));var i,r,c,l,d,f,p,o=s.documentElement,u=o.localName||o.tagName,h=s.documentElement.namespaceURI,a=null,m=[];if(u==="Image")try{if(l=o.getElementsByTagName("Size")[0],l===0[0]&&(l=o.getElementsByTagNameNS(h,"Size")[0]),a={Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:o.getAttribute("Url"),Format:o.getAttribute("Format"),DisplayRect:null,Overlap:parseInt(o.getAttribute("Overlap"),10),TileSize:parseInt(o.getAttribute("TileSize"),10),Size:{Height:parseInt(l.getAttribute("Height"),10),Width:parseInt(l.getAttribute("Width"),10)}}},!e.imageFormatSupported(a.Image.Format))throw new Error(e.getString("Errors.ImageFormat",a.Image.Format.toUpperCase()));r=o.getElementsByTagName("DisplayRect"),r===0[0]&&(r=o.getElementsByTagNameNS(h,"DisplayRect")[0]);for(d=0;d<r.length;d++)c=r[d],i=c.getElementsByTagName("Rect")[0],i===0[0]&&(i=c.getElementsByTagNameNS(h,"Rect")[0]),m.push({Rect:{X:parseInt(i.getAttribute("X"),10),Y:parseInt(i.getAttribute("Y"),10),Width:parseInt(i.getAttribute("Width"),10),Height:parseInt(i.getAttribute("Height"),10),MinLevel:parseInt(c.getAttribute("MinLevel"),10),MaxLevel:parseInt(c.getAttribute("MaxLevel"),10)}});return m.length&&(a.Image.DisplayRect=m),t(n,a)}catch(t){throw t instanceof Error?t:new Error(e.getString("Errors.Dzi"))}else if(u==="Collection")throw new Error(e.getString("Errors.Dzc"));else if(u==="Error")throw f=o.getElementsByTagName("Message")[0],p=f.firstChild.nodeValue,new Error(p);throw new Error(e.getString("Errors.Dzi"))}function t(t,n){var s,i,o=n.Image,l=o.Url,d=o.Format,a=o.Size,r=o.DisplayRect||[],u=parseInt(a.Width,10),h=parseInt(a.Height,10),m=parseInt(o.TileSize,10),f=parseInt(o.Overlap,10),c=[];for(i=0;i<r.length;i++)s=r[i].Rect,c.push(new e.DisplayRect(parseInt(s.X,10),parseInt(s.Y,10),parseInt(s.Width,10),parseInt(s.Height,10),parseInt(s.MinLevel,10),parseInt(s.MaxLevel,10)));return e.extend(!0,{width:u,height:h,tileSize:m,tileOverlap:f,minLevel:null,maxLevel:null,tilesUrl:l,fileFormat:d,displayRects:c},n)}}(n),function(e){e.IIIFTileSource=function(n){if(e.extend(!0,this,n),this._id=this["@id"]||this.id||this.identifier||null,!(this.height&&this.width&&this._id))throw new Error("IIIF required parameters (width, height, or id) not provided.");if(n.tileSizePerScaleFactor={},this.tileFormat=this.tileFormat||"jpg",this.version=n.version,this.tile_width&&this.tile_height)n.tileWidth=this.tile_width,n.tileHeight=this.tile_height;else if(this.tile_width)n.tileSize=this.tile_width;else if(this.tile_height)n.tileSize=this.tile_height;else if(this.tiles)if(this.tiles.length===1)n.tileWidth=this.tiles[0].width,n.tileHeight=this.tiles[0].height||this.tiles[0].width,this.scale_factors=this.tiles[0].scaleFactors;else{this.scale_factors=[];for(o=0;o<this.tiles.length;o++)for(i=0;i<this.tiles[o].scaleFactors.length;i++)c=this.tiles[o].scaleFactors[i],this.scale_factors.push(c),n.tileSizePerScaleFactor[c]={width:this.tiles[o].width,height:this.tiles[o].height||this.tiles[o].width}}else if(t(n)){for(var o,i,r,c,h,u=Math.min(this.height,this.width),l=[256,512,1024],d=[],a=0;a<l.length;a++)l[a]<=u&&d.push(l[a]);d.length>0?n.tileSize=Math.max.apply(null,d):n.tileSize=u}else this.sizes&&this.sizes.length>0?(this.emulateLegacyImagePyramid=!0,n.levels=s(this),e.extend(!0,n,{width:n.levels[n.levels.length-1].width,height:n.levels[n.levels.length-1].height,tileSize:Math.max(n.height,n.width),tileOverlap:0,minLevel:0,maxLevel:n.levels.length-1}),this.levels=n.levels):e.console.error("Nothing in the info.json to construct image pyramids from");!n.maxLevel&&!this.emulateLegacyImagePyramid&&(this.scale_factors?(h=Math.max.apply(null,this.scale_factors),n.maxLevel=Math.round(Math.log(h)*Math.LOG2E)):n.maxLevel=Number(Math.round(Math.log(Math.max(this.width,this.height),2)))),this.sizes&&(r=this.sizes.length,(r===n.maxLevel||r===n.maxLevel+1)&&(this.levelSizes=this.sizes.slice().sort((e,t)=>e.width-t.width),r===n.maxLevel&&this.levelSizes.push({width:this.width,height:this.height}))),e.TileSource.apply(this,[n])},e.extend(e.IIIFTileSource.prototype,e.TileSource.prototype,{supports:function(e){return!!(e.protocol&&e.protocol==="http://iiif.io/api/image")||!!(e["@context"]&&(e["@context"]==="http://library.stanford.edu/iiif/image-api/1.1/context.json"||e["@context"]==="http://iiif.io/api/image/1/context.json"))||!!(e.profile&&e.profile.indexOf("http://library.stanford.edu/iiif/image-api/compliance.html")===0)||!!(e.identifier&&e.width&&e.height)||!!(e.documentElement&&"info"===e.documentElement.tagName&&"http://library.stanford.edu/iiif/image-api/ns/"===e.documentElement.namespaceURI)},configure:function(t,s){if(e.isPlainObject(t)){if(t["@context"]){if(a=t["@context"],Array.isArray(a))for(r=0;r<a.length;r++)if(typeof a[r]=="string"&&(/^http:\/\/iiif\.io\/api\/image\/[1-3]\/context\.json$/.test(a[r])||a[r]==="http://library.stanford.edu/iiif/image-api/1.1/context.json")){a=a[r];break}switch(a){case"http://iiif.io/api/image/1/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/context.json":t.version=1;break;case"http://iiif.io/api/image/2/context.json":t.version=2;break;case"http://iiif.io/api/image/3/context.json":t.version=3;break;default:e.console.error("Data has a @context property which contains no known IIIF context URI.")}}else t["@context"]="http://iiif.io/api/image/1.0/context.json",t["@id"]=s.replace("/info.json",""),t.version=1;if(t.preferredFormats)for(c=0;c<t.preferredFormats.length;c++)if(n.imageFormatSupported(t.preferredFormats[c])){t.tileFormat=t.preferredFormats[c];break}return t}var a,r,c,l=i(t);return l["@context"]="http://iiif.io/api/image/1.0/context.json",l["@id"]=s.replace("/info.xml",""),l.version=1,l},getTileWidth:function(t){if(this.emulateLegacyImagePyramid)return e.TileSource.prototype.getTileWidth.call(this,t);var n=2**(this.maxLevel-t);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[n]?this.tileSizePerScaleFactor[n].width:this._tileWidth},getTileHeight:function(t){if(this.emulateLegacyImagePyramid)return e.TileSource.prototype.getTileHeight.call(this,t);var n=2**(this.maxLevel-t);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[n]?this.tileSizePerScaleFactor[n].height:this._tileHeight},getLevelScale:function(t){if(this.emulateLegacyImagePyramid){var n=NaN;return this.levels.length>0&&t>=this.minLevel&&t<=this.maxLevel&&(n=this.levels[t].width/this.levels[this.maxLevel].width),n}return e.TileSource.prototype.getLevelScale.call(this,t)},getNumTiles:function(t){if(this.emulateLegacyImagePyramid)return n=this.getLevelScale(t),n?new e.Point(1,1):new e.Point(0,0);if(this.levelSizes){var n,s=this.levelSizes[t],o=Math.ceil(s.width/this.getTileWidth(t)),i=Math.ceil(s.height/this.getTileHeight(t));return new e.Point(o,i)}return e.TileSource.prototype.getNumTiles.call(this,t)},getTileAtPoint:function(t,n){if(this.emulateLegacyImagePyramid)return new e.Point(0,0);if(this.levelSizes){var s,o,i,a,r,c,l=n.x>=0&&n.x<=1&&n.y>=0&&n.y<=1/this.aspectRatio;return e.console.assert(l,"[TileSource.getTileAtPoint] must be called with a valid point."),s=this.levelSizes[t].width,a=n.x*s,r=n.y*s,o=Math.floor(a/this.getTileWidth(t)),i=Math.floor(r/this.getTileHeight(t)),n.x>=1&&(o=this.getNumTiles(t).x-1),c=1e-15,n.y>=1/this.aspectRatio-c&&(i=this.getNumTiles(t).y-1),new e.Point(o,i)}return e.TileSource.prototype.getTileAtPoint.call(this,t,n)},getTileUrl:function(e,t,n){if(this.emulateLegacyImagePyramid)return h=null,this.levels.length>0&&e>=this.minLevel&&e<=this.maxLevel&&(h=this.levels[e].url),h;var s,o,i,a,r,c,l,u,h,m,f,p,g,v,b,j,y,_="0",d=.5**(this.maxLevel-e);return this.levelSizes?(o=this.levelSizes[e].width,i=this.levelSizes[e].height):(o=Math.ceil(this.width*d),i=Math.ceil(this.height*d)),r=this.getTileWidth(e),c=this.getTileHeight(e),v=Math.round(r/d),u=Math.round(c/d),this.version===1?j="native."+this.tileFormat:j="default."+this.tileFormat,o<r&&i<c?(this.version===2&&o===this.width?s="full":this.version===3&&o===this.width&&i===this.height?s="max":this.version===3?s=o+","+i:s=o+",",l="full"):(m=t*v,f=n*u,p=Math.min(v,this.width-m),g=Math.min(u,this.height-f),t===0&&n===0&&p===this.width&&g===this.height?l="full":l=[m,f,p,g].join(","),a=Math.min(r,o-t*r),b=Math.min(c,i-n*c),this.version===2&&a===this.width?s="full":this.version===3&&a===this.width&&b===this.height?s="max":this.version===3?s=a+","+b:s=a+","),y=[this._id,l,s,_,j].join("/"),y},__testonly__:{canBeTiled:t,constructLevels:s}});function t(e){var n=["http://library.stanford.edu/iiif/image-api/compliance.html#level0","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0","http://iiif.io/api/image/2/level0.json","level0","https://iiif.io/api/image/3/level0.json"],s=Array.isArray(e.profile)?e.profile[0]:e.profile,o=n.indexOf(s)!==-1,t=!1;return e.version===2&&e.profile.length>1&&e.profile[1].supports&&(t=e.profile[1].supports.indexOf("sizeByW")!==-1),e.version===3&&e.extraFeatures&&(t=e.extraFeatures.indexOf("sizeByWh")!==-1),!o||t}function s(e){for(var n=[],t=0;t<e.sizes.length;t++)n.push({url:e._id+"/full/"+e.sizes[t].width+","+(e.version===3?e.sizes[t].height:"")+"/0/default."+e.tileFormat,width:e.sizes[t].width,height:e.sizes[t].height});return n.sort(function(e,t){return e.width-t.width})}function i(t){if(!t||!t.documentElement)throw new Error(e.getString("Errors.Xml"));var s=t.documentElement,i=s.tagName,n=null;if(i==="info")try{return n={},o(s,n),n}catch(t){throw t instanceof Error?t:new Error(e.getString("Errors.IIIF"))}throw new Error(e.getString("Errors.IIIF"))}function o(t,n,s){var i,a;if(t.nodeType===3&&s)i=t.nodeValue.trim(),i.match(/^\d*$/)&&(i=Number(i)),n[s]?(e.isArray(n[s])||(n[s]=[n[s]]),n[s].push(i)):n[s]=i;else if(t.nodeType===1)for(a=0;a<t.childNodes.length;a++)o(t.childNodes[a],n,t.nodeName)}}(n),function(e){e.OsmTileSource=function(t){var a;e.isPlainObject(t)?a=t:a={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]},(!a.width||!a.height)&&(a.width=65572864,a.height=65572864),a.tileSize||(a.tileSize=256,a.tileOverlap=0),a.tilesUrl||(a.tilesUrl="http://tile.openstreetmap.org/"),a.minLevel=8,e.TileSource.apply(this,[a])},e.extend(e.OsmTileSource.prototype,e.TileSource.prototype,{supports:function(e){return e.type&&"openstreetmaps"===e.type},configure:function(e){return e},getTileUrl:function(e,t,n){return this.tilesUrl+(e-8)+"/"+t+"/"+n+".png"}})}(n),function(e){e.TmsTileSource=function(t){e.isPlainObject(t)?a=t:a={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]};var a,l,r=Math.ceil(a.width/256)*256,c=Math.ceil(a.height/256)*256;r>c?l=r/256:l=c/256,a.maxLevel=Math.ceil(Math.log(l)/Math.log(2))-1,a.tileSize=256,a.width=r,a.height=c,e.TileSource.apply(this,[a])},e.extend(e.TmsTileSource.prototype,e.TileSource.prototype,{supports:function(e){return e.type&&"tiledmapservice"===e.type},configure:function(e){return e},getTileUrl:function(e,t,n){var s=this.getNumTiles(e).y-1;return this.tilesUrl+e+"/"+t+"/"+(s-n)+".png"}})}(n),function(e){e.ZoomifyTileSource=function(e){typeof e.tileSize=="undefined"&&(e.tileSize=256),typeof e.fileFormat=="undefined"&&(e.fileFormat="jpg",this.fileFormat=e.fileFormat);var t={x:e.width,y:e.height};for(e.imageSizes=[{x:e.width,y:e.height}],e.gridSize=[this._getGridSize(e.width,e.height,e.tileSize)];parseInt(t.x,10)>e.tileSize||parseInt(t.y,10)>e.tileSize;)t.x=Math.floor(t.x/2),t.y=Math.floor(t.y/2),e.imageSizes.push({x:t.x,y:t.y}),e.gridSize.push(this._getGridSize(t.x,t.y,e.tileSize));e.imageSizes.reverse(),e.gridSize.reverse(),e.minLevel=0,e.maxLevel=e.gridSize.length-1,n.TileSource.apply(this,[e])},e.extend(e.ZoomifyTileSource.prototype,e.TileSource.prototype,{_getGridSize:function(e,t,n){return{x:Math.ceil(e/n),y:Math.ceil(t/n)}},_calculateAbsoluteTileNumber:function(e,t,n){for(var o=0,s={},i=0;i<e;i++)s=this.gridSize[i],o+=s.x*s.y;return s=this.gridSize[e],o+=s.x*n+t,o},supports:function(e){return e.type&&"zoomifytileservice"===e.type},configure:function(e){return e},getTileUrl:function(e,t,n){var s=0,o=this._calculateAbsoluteTileNumber(e,t,n),s=Math.floor(o/256);return this.tilesUrl+"TileGroup"+s+"/"+e+"-"+t+"-"+n+"."+this.fileFormat}})}(n),function(e){e.LegacyTileSource=function(t){var s,o,i;e.isArray(t)&&(s={type:"legacy-image-pyramid",levels:t}),s.levels=n(s.levels),s.levels.length>0?(o=s.levels[s.levels.length-1].width,i=s.levels[s.levels.length-1].height):(o=0,i=0,e.console.error("No supported image formats found")),e.extend(!0,s,{width:o,height:i,tileSize:Math.max(i,o),tileOverlap:0,minLevel:0,maxLevel:s.levels.length>0?s.levels.length-1:0}),e.TileSource.apply(this,[s]),this.levels=s.levels},e.extend(e.LegacyTileSource.prototype,e.TileSource.prototype,{supports:function(e){return e.type&&"legacy-image-pyramid"===e.type||e.documentElement&&"legacy-image-pyramid"===e.documentElement.getAttribute("type")},configure:function(n){var a;return e.isPlainObject(n)?a=t(this,n):a=s(this,n),a},getLevelScale:function(e){var t=NaN;return this.levels.length>0&&e>=this.minLevel&&e<=this.maxLevel&&(t=this.levels[e].width/this.levels[this.maxLevel].width),t},getNumTiles:function(t){var n=this.getLevelScale(t);return n?new e.Point(1,1):new e.Point(0,0)},getTileUrl:function(e){var s=null;return this.levels.length>0&&e>=this.minLevel&&e<=this.maxLevel&&(s=this.levels[e].url),s}});function n(t){var n,s,o=[];for(s=0;s<t.length;s++)n=t[s],n.height&&n.width&&n.url?o.push({url:n.url,width:Number(n.width),height:Number(n.height)}):e.console.error("Unsupported image format: %s",n.url?n.url:"<no URL>");return o.sort(function(e,t){return e.height-t.height})}function s(n,s){if(!s||!s.documentElement)throw new Error(e.getString("Errors.Xml"));var i,a,r=s.documentElement,o=r.tagName,c=null,l=[];if(o==="image")try{c={type:r.getAttribute("type"),levels:[]},l=r.getElementsByTagName("level");for(a=0;a<l.length;a++)i=l[a],c.levels.push({url:i.getAttribute("url"),width:parseInt(i.getAttribute("width"),10),height:parseInt(i.getAttribute("height"),10)});return t(n,c)}catch(e){throw e instanceof Error?e:new Error("Unknown error parsing Legacy Image Pyramid XML.")}else if(o==="collection")throw new Error("Legacy Image Pyramid Collections not yet supported.");else if(o==="error")throw new Error("Error: "+s);throw new Error("Unknown element "+o)}function t(e,t){return t.levels}}(n),function(e){e.ImageTileSource=function(t){t=e.extend({buildPyramid:!0,crossOriginPolicy:!1,ajaxWithCredentials:!1},t),e.TileSource.apply(this,[t])},e.extend(e.ImageTileSource.prototype,e.TileSource.prototype,{supports:function(e){return e.type&&e.type==="image"},configure:function(e){return e},getImageInfo:function(t){var s=this._image=new Image,n=this;this.crossOriginPolicy&&(s.crossOrigin=this.crossOriginPolicy),this.ajaxWithCredentials&&(s.useCredentials=this.ajaxWithCredentials),e.addEvent(s,"load",function(){n.width=s.naturalWidth,n.height=s.naturalHeight,n.aspectRatio=n.width/n.height,n.dimensions=new e.Point(n.width,n.height),n._tileWidth=n.width,n._tileHeight=n.height,n.tileOverlap=0,n.minLevel=0,n.levels=n._buildLevels(),n.maxLevel=n.levels.length-1,n.ready=!0,n.raiseEvent("ready",{tileSource:n})}),e.addEvent(s,"error",function(){n.raiseEvent("open-failed",{message:"Error loading image at "+t,source:t})}),s.src=t},getLevelScale:function(e){var t=NaN;return e>=this.minLevel&&e<=this.maxLevel&&(t=this.levels[e].width/this.levels[this.maxLevel].width),t},getNumTiles:function(t){var n=this.getLevelScale(t);return n?new e.Point(1,1):new e.Point(0,0)},getTileUrl:function(e){var s=null;return e>=this.minLevel&&e<=this.maxLevel&&(s=this.levels[e].url),s},getContext2D:function(e){var s=null;return e>=this.minLevel&&e<=this.maxLevel&&(s=this.levels[e].context2D),s},destroy:function(e){this._freeupCanvasMemory(e)},_buildLevels:function(){var t,n,s,i,a,r,o=[{url:this._image.src,width:this._image.naturalWidth,height:this._image.naturalHeight}];if(!this.buildPyramid||!e.supportsCanvas)return delete this._image,o;if(t=this._image.naturalWidth,n=this._image.naturalHeight,s=document.createElement("canvas"),a=s.getContext("2d"),s.width=t,s.height=n,a.drawImage(this._image,0,0,t,n),o[0].context2D=a,delete this._image,e.isCanvasTainted(s))return o;for(;t>=2&&n>=2;)t=Math.floor(t/2),n=Math.floor(n/2),i=document.createElement("canvas"),r=i.getContext("2d"),i.width=t,i.height=n,r.drawImage(s,0,0,t,n),o.splice(0,0,{context2D:r,width:t,height:n}),s=i,a=r;return o},_freeupCanvasMemory:function(e){for(var t=0;t<this.levels.length;t++)this.levels[t].context2D&&(this.levels[t].context2D.canvas.height=0,this.levels[t].context2D.canvas.width=0,e&&e.raiseEvent("image-unloaded",{context2D:this.levels[t].context2D}))}})}(n),function(e){e.TileSourceCollection=function(){e.console.error("TileSourceCollection is deprecated; use World instead")}}(n),function(e){e.ButtonState={REST:0,GROUP:1,HOVER:2,DOWN:3},e.Button=function(s){var o=this;e.EventSource.call(this),e.extend(!0,this,{tooltip:null,srcRest:null,srcGroup:null,srcHover:null,srcDown:null,clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:e.DEFAULT_SETTINGS.clickDistThreshold,fadeDelay:0,fadeLength:2e3,onPress:null,onRelease:null,onClick:null,onEnter:null,onExit:null,onFocus:null,onBlur:null,userData:null},s),this.element=s.element||e.makeNeutralElement("div"),s.element||(this.imgRest=e.makeTransparentImage(this.srcRest),this.imgGroup=e.makeTransparentImage(this.srcGroup),this.imgHover=e.makeTransparentImage(this.srcHover),this.imgDown=e.makeTransparentImage(this.srcDown),this.imgRest.alt=this.imgGroup.alt=this.imgHover.alt=this.imgDown.alt=this.tooltip,e.setElementPointerEventsNone(this.imgRest),e.setElementPointerEventsNone(this.imgGroup),e.setElementPointerEventsNone(this.imgHover),e.setElementPointerEventsNone(this.imgDown),this.element.style.position="relative",e.setElementTouchActionNone(this.element),this.imgGroup.style.position=this.imgHover.style.position=this.imgDown.style.position="absolute",this.imgGroup.style.top=this.imgHover.style.top=this.imgDown.style.top="0px",this.imgGroup.style.left=this.imgHover.style.left=this.imgDown.style.left="0px",this.imgHover.style.visibility=this.imgDown.style.visibility="hidden",this.element.appendChild(this.imgRest),this.element.appendChild(this.imgGroup),this.element.appendChild(this.imgHover),this.element.appendChild(this.imgDown)),this.addHandler("press",this.onPress),this.addHandler("release",this.onRelease),this.addHandler("click",this.onClick),this.addHandler("enter",this.onEnter),this.addHandler("exit",this.onExit),this.addHandler("focus",this.onFocus),this.addHandler("blur",this.onBlur),this.currentState=e.ButtonState.GROUP,this.fadeBeginTime=null,this.shouldFade=!1,this.element.style.display="inline-block",this.element.style.position="relative",this.element.title=this.tooltip,this.tracker=new e.MouseTracker({userData:"Button.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(n){n.insideElementPressed?(t(o,e.ButtonState.DOWN),o.raiseEvent("enter",{originalEvent:n.originalEvent})):n.buttonDownAny||t(o,e.ButtonState.HOVER)},focusHandler:function(e){o.tracker.enterHandler(e),o.raiseEvent("focus",{originalEvent:e.originalEvent})},leaveHandler:function(t){n(o,e.ButtonState.GROUP),t.insideElementPressed&&o.raiseEvent("exit",{originalEvent:t.originalEvent})},blurHandler:function(e){o.tracker.leaveHandler(e),o.raiseEvent("blur",{originalEvent:e.originalEvent})},pressHandler:function(n){t(o,e.ButtonState.DOWN),o.raiseEvent("press",{originalEvent:n.originalEvent})},releaseHandler:function(s){s.insideElementPressed&&s.insideElementReleased?(n(o,e.ButtonState.HOVER),o.raiseEvent("release",{originalEvent:s.originalEvent})):s.insideElementPressed?n(o,e.ButtonState.GROUP):t(o,e.ButtonState.HOVER)},clickHandler:function(e){e.quick&&o.raiseEvent("click",{originalEvent:e.originalEvent})},keyHandler:function(e){13===e.keyCode?(o.raiseEvent("click",{originalEvent:e.originalEvent}),o.raiseEvent("release",{originalEvent:e.originalEvent}),e.preventDefault=!0):e.preventDefault=!1}}),n(this,e.ButtonState.REST)},e.extend(e.Button.prototype,e.EventSource.prototype,{notifyGroupEnter:function(){t(this,e.ButtonState.GROUP)},notifyGroupExit:function(){n(this,e.ButtonState.REST)},disable:function(){this.notifyGroupExit(),this.element.disabled=!0,this.tracker.setTracking(!1),e.setElementOpacity(this.element,.2,!0)},enable:function(){this.element.disabled=!1,this.tracker.setTracking(!0),e.setElementOpacity(this.element,1,!0),this.notifyGroupEnter()},destroy:function(){this.imgRest&&(this.element.removeChild(this.imgRest),this.imgRest=null),this.imgGroup&&(this.element.removeChild(this.imgGroup),this.imgGroup=null),this.imgHover&&(this.element.removeChild(this.imgHover),this.imgHover=null),this.imgDown&&(this.element.removeChild(this.imgDown),this.imgDown=null),this.removeAllHandlers(),this.tracker.destroy(),this.element=null}});function s(t){e.requestAnimationFrame(function(){o(t)})}function o(t){var n,o,i;t.shouldFade&&(o=e.now(),i=o-t.fadeBeginTime,n=1-i/t.fadeLength,n=Math.min(1,n),n=Math.max(0,n),t.imgGroup&&e.setElementOpacity(t.imgGroup,n,!0),n>0&&s(t))}function i(t){t.shouldFade=!0,t.fadeBeginTime=e.now()+t.fadeDelay,window.setTimeout(function(){s(t)},t.fadeDelay)}function a(t){t.shouldFade=!1,t.imgGroup&&e.setElementOpacity(t.imgGroup,1,!0)}function t(t,n){if(t.element.disabled)return;n>=e.ButtonState.GROUP&&t.currentState===e.ButtonState.REST&&(a(t),t.currentState=e.ButtonState.GROUP),n>=e.ButtonState.HOVER&&t.currentState===e.ButtonState.GROUP&&(t.imgHover&&(t.imgHover.style.visibility=""),t.currentState=e.ButtonState.HOVER),n>=e.ButtonState.DOWN&&t.currentState===e.ButtonState.HOVER&&(t.imgDown&&(t.imgDown.style.visibility=""),t.currentState=e.ButtonState.DOWN)}function n(t,n){if(t.element.disabled)return;n<=e.ButtonState.HOVER&&t.currentState===e.ButtonState.DOWN&&(t.imgDown&&(t.imgDown.style.visibility="hidden"),t.currentState=e.ButtonState.HOVER),n<=e.ButtonState.GROUP&&t.currentState===e.ButtonState.HOVER&&(t.imgHover&&(t.imgHover.style.visibility="hidden"),t.currentState=e.ButtonState.GROUP),n<=e.ButtonState.REST&&t.currentState===e.ButtonState.GROUP&&(i(t),t.currentState=e.ButtonState.REST)}}(n),function(e){e.ButtonGroup=function(t){e.extend(!0,this,{buttons:[],clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:e.DEFAULT_SETTINGS.clickDistThreshold,labelText:""},t);var s,o=this.buttons.concat([]),n=this;if(this.element=t.element||e.makeNeutralElement("div"),!t.group){this.element.style.display="inline-block";for(s=0;s<o.length;s++)this.element.appendChild(o[s].element)}e.setElementTouchActionNone(this.element),this.tracker=new e.MouseTracker({userData:"ButtonGroup.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(){var t;for(t=0;t<n.buttons.length;t++)n.buttons[t].notifyGroupEnter()},leaveHandler:function(e){var t;if(!e.insideElementPressed)for(t=0;t<n.buttons.length;t++)n.buttons[t].notifyGroupExit()}})},e.ButtonGroup.prototype={addButton:function(e){this.buttons.push(e),this.element.appendChild(e.element)},emulateEnter:function(){this.tracker.enterHandler({eventSource:this.tracker})},emulateLeave:function(){this.tracker.leaveHandler({eventSource:this.tracker})},destroy:function(){for(;this.buttons.length;){var e=this.buttons.pop();this.element.removeChild(e.element),e.destroy()}this.tracker.destroy(),this.element=null}}}(n),function(e){e.Rect=function(t,n,s,o,i){this.x=typeof t=="number"?t:0,this.y=typeof n=="number"?n:0,this.width=typeof s=="number"?s:0,this.height=typeof o=="number"?o:0,this.degrees=typeof i=="number"?i:0,this.degrees=e.positiveModulo(this.degrees,360);var a,r;this.degrees>=270?(a=this.getTopRight(),this.x=a.x,this.y=a.y,r=this.height,this.height=this.width,this.width=r,this.degrees-=270):this.degrees>=180?(a=this.getBottomRight(),this.x=a.x,this.y=a.y,this.degrees-=180):this.degrees>=90&&(a=this.getBottomLeft(),this.x=a.x,this.y=a.y,r=this.height,this.height=this.width,this.width=r,this.degrees-=90)},e.Rect.fromSummits=function(t,n,s){var a=t.distanceTo(n),r=t.distanceTo(s),o=n.minus(t),i=Math.atan(o.y/o.x);return o.x<0?i+=Math.PI:o.y<0&&(i+=2*Math.PI),new e.Rect(t.x,t.y,a,r,i/Math.PI*180)},e.Rect.prototype={clone:function(){return new e.Rect(this.x,this.y,this.width,this.height,this.degrees)},getAspectRatio:function(){return this.width/this.height},getTopLeft:function(){return new e.Point(this.x,this.y)},getBottomRight:function(){return new e.Point(this.x+this.width,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getTopRight:function(){return new e.Point(this.x+this.width,this.y).rotate(this.degrees,this.getTopLeft())},getBottomLeft:function(){return new e.Point(this.x,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getCenter:function(){return new e.Point(this.x+this.width/2,this.y+this.height/2).rotate(this.degrees,this.getTopLeft())},getSize:function(){return new e.Point(this.width,this.height)},equals:function(t){return t instanceof e.Rect&&this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height&&this.degrees===t.degrees},times:function(t){return new e.Rect(this.x*t,this.y*t,this.width*t,this.height*t,this.degrees)},translate:function(t){return new e.Rect(this.x+t.x,this.y+t.y,this.width,this.height,this.degrees)},union:function(t){var n=this.getBoundingBox(),s=t.getBoundingBox(),o=Math.min(n.x,s.x),i=Math.min(n.y,s.y),a=Math.max(n.x+n.width,s.x+s.width),r=Math.max(n.y+n.height,s.y+s.height);return new e.Rect(o,i,a-o,r-i)},intersection:function(t){var o,i,a,r,c,l,d,u,h,m,f,p,g,v,b,j,y,_,w,O,s=1e-10,n=[],x=this.getTopLeft();t.containsPoint(x,s)&&n.push(x),m=this.getTopRight(),t.containsPoint(m,s)&&n.push(m),y=this.getBottomLeft(),t.containsPoint(y,s)&&n.push(y),f=this.getBottomRight(),t.containsPoint(f,s)&&n.push(f),g=t.getTopLeft(),this.containsPoint(g,s)&&n.push(g),j=t.getTopRight(),this.containsPoint(j,s)&&n.push(j),O=t.getBottomLeft(),this.containsPoint(O,s)&&n.push(O),_=t.getBottomRight(),this.containsPoint(_,s)&&n.push(_);for(h=this._getSegments(),w=t._getSegments(),r=0;r<h.length;r++)for(p=h[r],c=0;c<w.length;c++)v=w[c],b=C(p[0],p[1],v[0],v[1]),b&&n.push(b);function C(t,n,o,i){var r,d,a=n.minus(t),c=i.minus(o),l=-c.x*a.y+a.x*c.y;return l===0?null:(d=(a.x*(t.y-o.y)-a.y*(t.x-o.x))/l,r=(c.x*(t.y-o.y)-c.y*(t.x-o.x))/l,-s<=d&&d<=1-s&&-s<=r&&r<=1-s?new e.Point(t.x+r*a.x,t.y+r*a.y):null)}if(n.length===0)return null;for(a=n[0].x,u=n[0].x,i=n[0].y,d=n[0].y,l=1;l<n.length;l++)o=n[l],o.x<a&&(a=o.x),o.x>u&&(u=o.x),o.y<i&&(i=o.y),o.y>d&&(d=o.y);return new e.Rect(a,i,u-a,d-i)},_getSegments:function(){var e=this.getTopLeft(),t=this.getTopRight(),n=this.getBottomLeft(),s=this.getBottomRight();return[[e,t],[t,s],[s,n],[n,e]]},rotate:function(t,n){if(t=e.positiveModulo(t,360),t===0)return this.clone();n=n||this.getCenter();var o=this.getTopLeft().rotate(t,n),a=this.getTopRight().rotate(t,n),s=a.minus(o),s=s.apply(function(e){var t=1e-15;return(e<0?-e:e)<t?0:e}),i=Math.atan(s.y/s.x);return s.x<0?i+=Math.PI:s.y<0&&(i+=2*Math.PI),new e.Rect(o.x,o.y,this.width,this.height,i/Math.PI*180)},getBoundingBox:function(){if(this.degrees===0)return this.clone();var t=this.getTopLeft(),n=this.getTopRight(),s=this.getBottomLeft(),o=this.getBottomRight(),i=Math.min(t.x,n.x,s.x,o.x),r=Math.max(t.x,n.x,s.x,o.x),a=Math.min(t.y,n.y,s.y,o.y),c=Math.max(t.y,n.y,s.y,o.y);return new e.Rect(i,a,r-i,c-a)},getIntegerBoundingBox:function(){var t=this.getBoundingBox(),n=Math.floor(t.x),s=Math.floor(t.y),o=Math.ceil(t.width+t.x-n),i=Math.ceil(t.height+t.y-s);return new e.Rect(n,s,o,i)},containsPoint:function(e,t){t=t||0;var n=this.getTopLeft(),i=this.getTopRight(),a=this.getBottomLeft(),s=i.minus(n),o=a.minus(n);return(e.x-n.x)*s.x+(e.y-n.y)*s.y>=-t&&(e.x-i.x)*s.x+(e.y-i.y)*s.y<=t&&(e.x-n.x)*o.x+(e.y-n.y)*o.y>=-t&&(e.x-a.x)*o.x+(e.y-a.y)*o.y<=t},toString:function(){return"["+Math.round(this.x*100)/100+", "+Math.round(this.y*100)/100+", "+Math.round(this.width*100)/100+"x"+Math.round(this.height*100)/100+", "+Math.round(this.degrees*100)/100+"deg]"}}}(n),function(e){var s={};e.ReferenceStrip=function(d){var u,m,p,g=this,h=d.viewer,f=e.getElementSize(h.element);d.id||(d.id="referencestrip-"+e.now(),this.element=e.makeNeutralElement("div"),this.element.id=d.id,this.element.className="referencestrip"),d=e.extend(!0,{sizeRatio:e.DEFAULT_SETTINGS.referenceStripSizeRatio,position:e.DEFAULT_SETTINGS.referenceStripPosition,scroll:e.DEFAULT_SETTINGS.referenceStripScroll,clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold},d,{element:this.element}),e.extend(this,d),s[this.id]={animating:!1},this.minPixelRatio=this.viewer.minPixelRatio,this.element.tabIndex=0,m=this.element.style,m.marginTop="0px",m.marginRight="0px",m.marginBottom="0px",m.marginLeft="0px",m.left="0px",m.bottom="0px",m.border="0px",m.background="#000",m.position="relative",e.setElementTouchActionNone(this.element),e.setElementOpacity(this.element,.8),this.viewer=h,this.tracker=new e.MouseTracker({userData:"ReferenceStrip.tracker",element:this.element,clickHandler:e.delegate(this,i),dragHandler:e.delegate(this,a),scrollHandler:e.delegate(this,n),enterHandler:e.delegate(this,o),leaveHandler:e.delegate(this,r),keyDownHandler:e.delegate(this,c),keyHandler:e.delegate(this,l),preProcessEventHandler:function(e){e.eventType==="wheel"&&(e.preventDefault=!0)}}),d.width&&d.height?(this.element.style.width=d.width+"px",this.element.style.height=d.height+"px",h.addControl(this.element,{anchor:e.ControlAnchor.BOTTOM_LEFT})):"horizontal"===d.scroll?(this.element.style.width=f.x*d.sizeRatio*h.tileSources.length+12*h.tileSources.length+"px",this.element.style.height=f.y*d.sizeRatio+"px",h.addControl(this.element,{anchor:e.ControlAnchor.BOTTOM_LEFT})):(this.element.style.height=f.y*d.sizeRatio*h.tileSources.length+12*h.tileSources.length+"px",this.element.style.width=f.x*d.sizeRatio+"px",h.addControl(this.element,{anchor:e.ControlAnchor.TOP_LEFT})),this.panelWidth=f.x*this.sizeRatio+8,this.panelHeight=f.y*this.sizeRatio+8,this.panels=[],this.miniViewers={};for(p=0;p<h.tileSources.length;p++)u=e.makeNeutralElement("div"),u.id=this.element.id+"-"+p,u.style.width=g.panelWidth+"px",u.style.height=g.panelHeight+"px",u.style.display="inline",u.style.float="left",u.style.cssFloat="left",u.style.padding="2px",e.setElementTouchActionNone(u),e.setElementPointerEventsNone(u),this.element.appendChild(u),u.activePanel=!1,this.panels.push(u);t(this,this.scroll==="vertical"?f.y:f.x,0),this.setFocus(0)},e.ReferenceStrip.prototype={setFocus:function(n){var s,a=this.element.querySelector("#"+this.element.id+"-"+n),i=e.getElementSize(this.viewer.canvas),l=Number(this.element.style.width.replace("px","")),d=Number(this.element.style.height.replace("px","")),r=-Number(this.element.style.marginLeft.replace("px","")),c=-Number(this.element.style.marginTop.replace("px",""));this.currentSelected!==a&&(this.currentSelected&&(this.currentSelected.style.background="#000"),this.currentSelected=a,this.currentSelected.style.background="#999","horizontal"===this.scroll?(s=Number(n)*(this.panelWidth+3),s>r+i.x-this.panelWidth?(s=Math.min(s,l-i.x),this.element.style.marginLeft=-s+"px",t(this,i.x,-s)):s<r&&(s=Math.max(0,s-i.x/2),this.element.style.marginLeft=-s+"px",t(this,i.x,-s))):(s=Number(n)*(this.panelHeight+3),s>c+i.y-this.panelHeight?(s=Math.min(s,d-i.y),this.element.style.marginTop=-s+"px",t(this,i.y,-s)):s<c&&(s=Math.max(0,s-i.y/2),this.element.style.marginTop=-s+"px",t(this,i.y,-s))),this.currentPage=n,o.call(this,{eventSource:this.tracker}))},update:function(){return!!s[this.id].animating},destroy:function(){if(this.miniViewers)for(var e in this.miniViewers)this.miniViewers[e].destroy();this.tracker.destroy(),this.element&&this.viewer.removeControl(this.element)}};function i(e){if(e.quick){var t;"horizontal"===this.scroll?t=Math.floor(e.position.x/(this.panelWidth+4)):t=Math.floor(e.position.y/this.panelHeight),this.viewer.goToPage(t)}this.element.focus()}function a(n){if(this.dragging=!0,this.element){var s=Number(this.element.style.marginLeft.replace("px","")),o=Number(this.element.style.marginTop.replace("px","")),a=Number(this.element.style.width.replace("px","")),r=Number(this.element.style.height.replace("px","")),i=e.getElementSize(this.viewer.canvas);"horizontal"===this.scroll?-n.delta.x>0?s>-(a-i.x)&&(this.element.style.marginLeft=s+n.delta.x*2+"px",t(this,i.x,s+n.delta.x*2)):-n.delta.x<0&&s<0&&(this.element.style.marginLeft=s+n.delta.x*2+"px",t(this,i.x,s+n.delta.x*2)):-n.delta.y>0?o>-(r-i.y)&&(this.element.style.marginTop=o+n.delta.y*2+"px",t(this,i.y,o+n.delta.y*2)):-n.delta.y<0&&o<0&&(this.element.style.marginTop=o+n.delta.y*2+"px",t(this,i.y,o+n.delta.y*2))}}function n(n){if(this.element){var s=Number(this.element.style.marginLeft.replace("px","")),o=Number(this.element.style.marginTop.replace("px","")),a=Number(this.element.style.width.replace("px","")),r=Number(this.element.style.height.replace("px","")),i=e.getElementSize(this.viewer.canvas);"horizontal"===this.scroll?n.scroll>0?s>-(a-i.x)&&(this.element.style.marginLeft=s-n.scroll*60+"px",t(this,i.x,s-n.scroll*60)):n.scroll<0&&s<0&&(this.element.style.marginLeft=s-n.scroll*60+"px",t(this,i.x,s-n.scroll*60)):n.scroll<0?o>i.y-r&&(this.element.style.marginTop=o+n.scroll*60+"px",t(this,i.y,o+n.scroll*60)):n.scroll>0&&o<0&&(this.element.style.marginTop=o+n.scroll*60+"px",t(this,i.y,o+n.scroll*60)),n.preventDefault=!0}}function t(t,n,s){"horizontal"===t.scroll?c=t.panelWidth:c=t.panelHeight,o=Math.ceil(n/c)+5,l=Math.ceil((Math.abs(s)+n)/c)+1,o=l-o,o=o<0?0:o;for(a=o;a<l&&a<t.panels.length;a++)if(r=t.panels[a],!r.activePanel){var o,i,a,r,c,l,d,u=t.viewer.tileSources[a];u.referenceStripThumbnailUrl?d={type:"image",url:u.referenceStripThumbnailUrl}:d=u,i=new e.Viewer({id:r.id,tileSources:[d],element:r,navigatorSizeRatio:t.sizeRatio,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:0,loadTilesWithAjax:t.viewer.loadTilesWithAjax,ajaxHeaders:t.viewer.ajaxHeaders,drawer:"canvas"}),e.setElementPointerEventsNone(i.canvas),e.setElementPointerEventsNone(i.container),i.innerTracker.setTracking(!1),i.outerTracker.setTracking(!1),t.miniViewers[r.id]=i,r.activePanel=!0}}function o(e){var t=e.eventSource.element;"horizontal"===this.scroll?t.style.marginBottom="0px":t.style.marginLeft="0px"}function r(t){var n=t.eventSource.element;"horizontal"===this.scroll?n.style.marginBottom="-"+e.getElementSize(n).y/2+"px":n.style.marginLeft="-"+e.getElementSize(n).x/2+"px"}function c(e){if(!e.ctrl&&!e.alt&&!e.meta)switch(e.keyCode){case 38:n.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),e.preventDefault=!0;break;case 40:n.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),e.preventDefault=!0;break;case 37:n.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),e.preventDefault=!0;break;case 39:n.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),e.preventDefault=!0;break;default:e.preventDefault=!1;break}else e.preventDefault=!1}function l(e){if(!e.ctrl&&!e.alt&&!e.meta)switch(e.keyCode){case 61:n.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),e.preventDefault=!0;break;case 45:n.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),e.preventDefault=!0;break;case 48:case 119:case 87:n.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),e.preventDefault=!0;break;case 115:case 83:n.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),e.preventDefault=!0;break;case 97:n.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),e.preventDefault=!0;break;case 100:n.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),e.preventDefault=!0;break;default:e.preventDefault=!1;break}else e.preventDefault=!1}}(n),function(e){e.DisplayRect=function(t,n,s,o,i,a){e.Rect.apply(this,[t,n,s,o]),this.minLevel=i,this.maxLevel=a},e.extend(e.DisplayRect.prototype,e.Rect.prototype)}(n),function(e){e.Spring=function(t){var n=arguments;typeof t!="object"&&(t={initial:n.length&&typeof n[0]=="number"?n[0]:0[0],springStiffness:n.length>1?n[1].springStiffness:5,animationTime:n.length>1?n[1].animationTime:1.5}),e.console.assert(typeof t.springStiffness=="number"&&t.springStiffness!==0,"[OpenSeadragon.Spring] options.springStiffness must be a non-zero number"),e.console.assert(typeof t.animationTime=="number"&&t.animationTime>=0,"[OpenSeadragon.Spring] options.animationTime must be a number greater than or equal to 0"),t.exponential&&(this._exponential=!0,delete t.exponential),e.extend(!0,this,t),this.current={value:typeof this.initial=="number"?this.initial:this._exponential?0:1,time:e.now()},e.console.assert(!this._exponential||this.current.value!==0,"[OpenSeadragon.Spring] value must be non-zero for exponential springs"),this.start={value:this.current.value,time:this.current.time},this.target={value:this.current.value,time:this.current.time},this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},e.Spring.prototype={resetTo:function(t){e.console.assert(!this._exponential||t!==0,"[OpenSeadragon.Spring.resetTo] target must be non-zero for exponential springs"),this.start.value=this.target.value=this.current.value=t,this.start.time=this.target.time=this.current.time=e.now(),this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},springTo:function(t){e.console.assert(!this._exponential||t!==0,"[OpenSeadragon.Spring.springTo] target must be non-zero for exponential springs"),this.start.value=this.current.value,this.start.time=this.current.time,this.target.value=t,this.target.time=this.start.time+1e3*this.animationTime,this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},shiftBy:function(t){this.start.value+=t,this.target.value+=t,this._exponential&&(e.console.assert(this.target.value!==0&&this.start.value!==0,"[OpenSeadragon.Spring.shiftBy] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},setExponential:function(t){this._exponential=t,this._exponential&&(e.console.assert(this.current.value!==0&&this.target.value!==0&&this.start.value!==0,"[OpenSeadragon.Spring.setExponential] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},update:function(){this.current.time=e.now();let n,s;if(this._exponential?(n=this.start._logValue,s=this.target._logValue):(n=this.start.value,s=this.target.value),this.current.time>=this.target.time)this.current.value=this.target.value;else{let e=n+(s-n)*t(this.springStiffness,(this.current.time-this.start.time)/(this.target.time-this.start.time));this._exponential?this.current.value=Math.exp(e):this.current.value=e}return this.current.value!==this.target.value},isAtTargetValue:function(){return this.current.value===this.target.value}};function t(e,t){return(1-Math.exp(e*-t))/(1-Math.exp(-e))}}(n),function(e){e.ImageJob=function(t){e.extend(!0,this,{timeout:e.DEFAULT_SETTINGS.timeout,jobId:null,tries:0},t),this.data=null,this.userData={},this.errorMsg=null},e.ImageJob.prototype={start:function(){this.tries++;var e=this,t=this.abort;this.jobId=window.setTimeout(function(){e.finish(null,null,"Image load exceeded timeout ("+e.timeout+" ms)")},this.timeout),this.abort=function(){e.source.downloadTileAbort(e),typeof t=="function"&&t()},this.source.downloadTileStart(this)},finish:function(e,t,n){this.data=e,this.request=t,this.errorMsg=n,this.jobId&&window.clearTimeout(this.jobId),this.callback(this)}},e.ImageLoader=function(t){e.extend(!0,this,{jobLimit:e.DEFAULT_SETTINGS.imageLoaderLimit,timeout:e.DEFAULT_SETTINGS.timeout,jobQueue:[],failedTiles:[],jobsInProgress:0},t)},e.ImageLoader.prototype={addJob:function(n){n.source||(e.console.error("ImageLoader.prototype.addJob() requires [options.source]. TileSource since new API defines how images are fetched. Creating a dummy TileSource."),s=e.TileSource.prototype,n.source={downloadTileStart:s.downloadTileStart,downloadTileAbort:s.downloadTileAbort});var s,i=this,a=function(e){t(i,e,n.callback)},r={src:n.src,tile:n.tile||{},source:n.source,loadWithAjax:n.loadWithAjax,ajaxHeaders:n.loadWithAjax?n.ajaxHeaders:null,crossOriginPolicy:n.crossOriginPolicy,ajaxWithCredentials:n.ajaxWithCredentials,postData:n.postData,callback:a,abort:n.abort,timeout:this.timeout},o=new e.ImageJob(r);!this.jobLimit||this.jobsInProgress<this.jobLimit?(o.start(),this.jobsInProgress++):this.jobQueue.push(o)},clear:function(){for(var t,e=0;e<this.jobQueue.length;e++)t=this.jobQueue[e],typeof t.abort=="function"&&t.abort();this.jobQueue=[]}};function t(e,t,n){t.errorMsg!==""&&(t.data===null||t.data===0[0])&&t.tries<1+e.tileRetryMax&&e.failedTiles.push(t);var s;e.jobsInProgress--,(!e.jobLimit||e.jobsInProgress<e.jobLimit)&&e.jobQueue.length>0&&(s=e.jobQueue.shift(),s.start(),e.jobsInProgress++),e.tileRetryMax>0&&e.jobQueue.length===0&&(!e.jobLimit||e.jobsInProgress<e.jobLimit)&&e.failedTiles.length>0&&(s=e.failedTiles.shift(),setTimeout(function(){s.start()},e.tileRetryDelay),e.jobsInProgress++),n(t.data,t.errorMsg,t.request)}}(n),function(e){e.Tile=function(t,s,o,i,a,r,c,l,d,u,h,m){this.level=t,this.x=s,this.y=o,this.bounds=i,this.positionedBounds=new n.Rect(i.x,i.y,i.width,i.height),this.sourceBounds=u,this.exists=a,this._url=r,this.postData=h,this.context2D=c,this.loadWithAjax=l,this.ajaxHeaders=d,m===0[0]&&(e.console.warn("Tile constructor needs 'cacheKey' variable: creation tile cache in Tile class is deprecated. TileSource.prototype.getTileHashKey will be used."),m=e.TileSource.prototype.getTileHashKey(t,s,o,r,d,h)),this.cacheKey=m,this.loaded=!1,this.loading=!1,this.element=null,this.imgElement=null,this.style=null,this.position=null,this.size=null,this.flipped=!1,this.blendStart=null,this.opacity=null,this.squaredDistance=null,this.visibility=null,this.hasTransparency=!1,this.beingDrawn=!1,this.lastTouchTime=0,this.isRightMost=!1,this.isBottomMost=!1},e.Tile.prototype={toString:function(){return this.level+"/"+this.x+"_"+this.y},_hasTransparencyChannel:function(){return console.warn("Tile.prototype._hasTransparencyChannel() has been deprecated and will be removed in the future. Use TileSource.prototype.hasTransparency() instead."),!!this.context2D||this.getUrl().match(".png")},get image(){return e.console.error("[Tile.image] property has been deprecated. Use [Tile.prototype.getImage] instead."),this.getImage()},get url(){return e.console.error("[Tile.url] property has been deprecated. Use [Tile.prototype.getUrl] instead."),this.getUrl()},getImage:function(){return this.cacheImageRecord.getImage()},getUrl:function(){return typeof this._url=="function"?this._url():this._url},getCanvasContext:function(){return this.context2D||this.cacheImageRecord&&this.cacheImageRecord.getRenderedContext()},getScaleForEdgeSmoothing:function(){var t;if(this.cacheImageRecord)t=this.cacheImageRecord.getRenderedContext();else if(this.context2D)t=this.context2D;else return e.console.warn("[Tile.drawCanvas] attempting to get tile scale %s when tile's not cached",this.toString()),1;return t.canvas.width/(this.size.x*e.pixelDensityRatio)},getTranslationForEdgeSmoothing:function(t,n,s){var o=Math.max(1,Math.ceil((s.x-n.x)/2)),i=Math.max(1,Math.ceil((s.y-n.y)/2));return new e.Point(o,i).minus(this.position.times(e.pixelDensityRatio).times(t||1).apply(function(e){return e%1}))},unload:function(){this.imgElement&&this.imgElement.parentNode&&this.imgElement.parentNode.removeChild(this.imgElement),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,this.imgElement=null,this.loaded=!1,this.loading=!1}}}(n),function(e){e.OverlayPlacement=e.Placement,e.OverlayRotationMode=e.freezeObject({NO_ROTATION:1,EXACT:2,BOUNDING_BOX:3}),e.Overlay=function(t,n,s){var o;e.isPlainObject(t)?o=t:o={element:t,location:n,placement:s},this.elementWrapper=document.createElement("div"),this.element=o.element,this.elementWrapper.appendChild(this.element),this.element.id?this.elementWrapper.id="overlay-wrapper-"+this.element.id:this.elementWrapper.id="overlay-wrapper",this.style=this.elementWrapper.style,this._init(o)},e.Overlay.prototype={_init:function(t){this.location=t.location,this.placement=t.placement===0[0]?e.Placement.TOP_LEFT:t.placement,this.onDraw=t.onDraw,this.checkResize=t.checkResize===0[0]||t.checkResize,this.width=t.width===0[0]?null:t.width,this.height=t.height===0[0]?null:t.height,this.rotationMode=t.rotationMode||e.OverlayRotationMode.EXACT,this.location instanceof e.Rect&&(this.width=this.location.width,this.height=this.location.height,this.location=this.location.getTopLeft(),this.placement=e.Placement.TOP_LEFT),this.scales=this.width!==null&&this.height!==null,this.bounds=new e.Rect(this.location.x,this.location.y,this.width,this.height),this.position=this.location},adjust:function(t,n){var s=e.Placement.properties[this.placement];if(!s)return;s.isHorizontallyCentered?t.x-=n.x/2:s.isRight&&(t.x-=n.x),s.isVerticallyCentered?t.y-=n.y/2:s.isBottom&&(t.y-=n.y)},destroy:function(){var s,o,n=this.elementWrapper,t=this.style;n.parentNode&&(n.parentNode.removeChild(n),n.prevElementParent&&(t.display="none",document.body.appendChild(n))),this.onDraw=null,t.top="",t.left="",t.position="",this.width!==null&&(t.width=""),this.height!==null&&(t.height=""),s=e.getCssPropertyWithVendorPrefix("transformOrigin"),o=e.getCssPropertyWithVendorPrefix("transform"),s&&o&&(t[s]="",t[o]="")},drawHTML:function(t,n){var s,o,i,r,c,l,d,u,h,m,a=this.elementWrapper;a.parentNode!==t&&(a.prevElementParent=a.parentNode,a.prevNextSibling=a.nextSibling,t.appendChild(a),this.style.position="absolute",this.size=e.getElementSize(this.elementWrapper)),l=this._getOverlayPositionAndSize(n),d=l.position,u=this.size=l.size,h="",n.overlayPreserveContentDirection&&(h=n.flipped?" scaleX(-1)":" scaleX(1)"),r=n.flipped?-l.rotate:l.rotate,m=n.flipped?" scaleX(-1)":"",this.onDraw?this.onDraw(d,u,this.element):(s=this.style,i=this.element.style,i.display="block",s.left=d.x+"px",s.top=d.y+"px",this.width!==null&&(i.width=u.x+"px"),this.height!==null&&(i.height=u.y+"px"),c=e.getCssPropertyWithVendorPrefix("transformOrigin"),o=e.getCssPropertyWithVendorPrefix("transform"),c&&o&&(r&&!n.flipped?(i[o]="",s[c]=this._getTransformOrigin(),s[o]="rotate("+r+"deg)"):!r&&n.flipped?(i[o]=h,s[c]=this._getTransformOrigin(),s[o]=m):r&&n.flipped?(i[o]=h,s[c]=this._getTransformOrigin(),s[o]="rotate("+r+"deg)"+m):(i[o]="",s[c]="",s[o]="")),s.display="flex")},_getOverlayPositionAndSize:function(t){var o,i,a,n=t.pixelFromPoint(this.location,!0),s=this._getSizeInPixels(t);return this.adjust(n,s),o=0,t.getRotation(!0)&&this.rotationMode!==e.OverlayRotationMode.NO_ROTATION&&(this.rotationMode===e.OverlayRotationMode.BOUNDING_BOX&&this.width!==null&&this.height!==null?(a=new e.Rect(n.x,n.y,s.x,s.y),i=this._getBoundingBox(a,t.getRotation(!0)),n=i.getTopLeft(),s=i.getSize()):o=t.getRotation(!0)),t.flipped&&(n.x=t.getContainerSize().x-n.x),{position:n,size:s,rotate:o}},_getSizeInPixels:function(t){var o,i,n=this.size.x,s=this.size.y;return(this.width!==null||this.height!==null)&&(o=t.deltaPixelsFromPointsNoRotate(new e.Point(this.width||0,this.height||0),!0),this.width!==null&&(n=o.x),this.height!==null&&(s=o.y)),this.checkResize&&(this.width===null||this.height===null)&&(i=this.size=e.getElementSize(this.elementWrapper),this.width===null&&(n=i.x),this.height===null&&(s=i.y)),new e.Point(n,s)},_getBoundingBox:function(e,t){var n=this._getPlacementPoint(e);return e.rotate(t,n).getBoundingBox()},_getPlacementPoint:function(t){var n=new e.Point(t.x,t.y),s=e.Placement.properties[this.placement];return s&&(s.isHorizontallyCentered?n.x+=t.width/2:s.isRight&&(n.x+=t.width),s.isVerticallyCentered?n.y+=t.height/2:s.isBottom&&(n.y+=t.height)),n},_getTransformOrigin:function(){var t="",n=e.Placement.properties[this.placement];return n?(n.isLeft?t="left":n.isRight&&(t="right"),n.isTop?t+=" top":n.isBottom&&(t+=" bottom"),t):t},update:function(t,n){var s=e.isPlainObject(t)?t:{location:t,placement:n};this._init({location:s.location||this.location,placement:s.placement!==0[0]?s.placement:this.placement,onDraw:s.onDraw||this.onDraw,checkResize:s.checkResize||this.checkResize,width:s.width!==0[0]?s.width:this.width,height:s.height!==0[0]?s.height:this.height,rotationMode:s.rotationMode||this.rotationMode})},getBounds:function(t){e.console.assert(t,"A viewport must now be passed to Overlay.getBounds.");var o,i,n=this.width,s=this.height;return(n===null||s===null)&&(i=t.deltaPointsFromPixelsNoRotate(this.size,!0),n===null&&(n=i.x),s===null&&(s=i.y)),o=this.location.clone(),this.adjust(o,new e.Point(n,s)),this._adjustBoundsForRotation(t,new e.Rect(o.x,o.y,n,s))},_adjustBoundsForRotation:function(t,n){if(!t||t.getRotation(!0)===0||this.rotationMode===e.OverlayRotationMode.EXACT)return n;if(this.rotationMode===e.OverlayRotationMode.BOUNDING_BOX){if(this.width===null||this.height===null)return n;var s=this._getOverlayPositionAndSize(t);return t.viewerElementToViewportRectangle(new e.Rect(s.position.x,s.position.y,s.size.x,s.size.y))}return n.rotate(-t.getRotation(!0),this._getPlacementPoint(n))}}}(n),function(e){const t=e;t.DrawerBase=class DrawerBase{constructor(t){e.console.assert(t.viewer,"[Drawer] options.viewer is required"),e.console.assert(t.viewport,"[Drawer] options.viewport is required"),e.console.assert(t.element,"[Drawer] options.element is required"),this.viewer=t.viewer,this.viewport=t.viewport,this.debugGridColor=typeof t.debugGridColor=="string"?[t.debugGridColor]:t.debugGridColor||e.DEFAULT_SETTINGS.debugGridColor,this.options=t.options||{},this.container=e.getElement(t.element),this._renderingTarget=this._createDrawingElement(),this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="absolute",this.canvas.style.left="0",e.setElementOpacity(this.canvas,this.viewer.opacity,!0),e.setElementPointerEventsNone(this.canvas),e.setElementTouchActionNone(this.canvas),this.container.style.textAlign="left",this.container.appendChild(this.canvas),this._checkForAPIOverrides()}get canvas(){return this._renderingTarget}get element(){return e.console.error("Drawer.element is deprecated. Use Drawer.container instead."),this.container}getType(){e.console.error("Drawer.getType must be implemented by child class")}static isSupported(){e.console.error("Drawer.isSupported must be implemented by child class")}_createDrawingElement(){return e.console.error("Drawer._createDrawingElement must be implemented by child class"),null}draw(){e.console.error("Drawer.draw must be implemented by child class")}canRotate(){e.console.error("Drawer.canRotate must be implemented by child class")}destroy(){e.console.error("Drawer.destroy must be implemented by child class")}minimumOverlapRequired(){return!1}setImageSmoothingEnabled(){e.console.error("Drawer.setImageSmoothingEnabled must be implemented by child class")}drawDebuggingRect(){e.console.warn("[drawer].drawDebuggingRect is not implemented by this drawer")}clear(){e.console.warn("[drawer].clear() is deprecated. The drawer is responsible for clearing itself as needed before drawing tiles.")}_checkForAPIOverrides(){if(this._createDrawingElement===e.DrawerBase.prototype._createDrawingElement)throw new Error("[drawer]._createDrawingElement must be implemented by child class");if(this.draw===e.DrawerBase.prototype.draw)throw new Error("[drawer].draw must be implemented by child class");if(this.canRotate===e.DrawerBase.prototype.canRotate)throw new Error("[drawer].canRotate must be implemented by child class");if(this.destroy===e.DrawerBase.prototype.destroy)throw new Error("[drawer].destroy must be implemented by child class");if(this.setImageSmoothingEnabled===e.DrawerBase.prototype.setImageSmoothingEnabled)throw new Error("[drawer].setImageSmoothingEnabled must be implemented by child class")}viewportToDrawerRectangle(t){var n=this.viewport.pixelFromPointNoRotate(t.getTopLeft(),!0),s=this.viewport.deltaPixelsFromPointsNoRotate(t.getSize(),!0);return new e.Rect(n.x*e.pixelDensityRatio,n.y*e.pixelDensityRatio,s.x*e.pixelDensityRatio,s.y*e.pixelDensityRatio)}viewportCoordToDrawerCoord(t){var n=this.viewport.pixelFromPointNoRotate(t,!0);return new e.Point(n.x*e.pixelDensityRatio,n.y*e.pixelDensityRatio)}_calculateCanvasSize(){var n=e.pixelDensityRatio,s=this.viewport.getContainerSize();return new t.Point(Math.round(s.x*n),Math.round(s.y*n))}_raiseTiledImageDrawnEvent(e,t){if(!this.viewer)return;this.viewer.raiseEvent("tiled-image-drawn",{tiledImage:e,tiles:t})}_raiseDrawerErrorEvent(e,t){if(!this.viewer)return;this.viewer.raiseEvent("drawer-error",{tiledImage:e,drawer:this,error:t})}}}(n),function(e){const t=e;class n extends t.DrawerBase{constructor(e){super(e),this.viewer.rejectEventHandler("tile-drawing","The HTMLDrawer does not raise the tile-drawing event"),this.viewer.allowEventHandler("tile-drawn")}static isSupported(){return!0}getType(){return"html"}minimumOverlapRequired(){return!0}_createDrawingElement(){let t=e.makeNeutralElement("div");return t}draw(e){var t=this;this._prepareNewFrame(),e.forEach(function(e){e.opacity!==0&&t._drawTiles(e)})}canRotate(){return!1}destroy(){this.container.removeChild(this.canvas)}setImageSmoothingEnabled(){}_prepareNewFrame(){this.canvas.innerHTML=""}_drawTiles(e){var t,s,n=e.getTilesToDraw().map(e=>e.tile);if(e.opacity===0||n.length===0&&!e.placeholderFillStyle)return;for(t=n.length-1;t>=0;t--)s=n[t],this._drawTile(s),this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:e,tile:s})}_drawTile(t){e.console.assert(t,"[Drawer._drawTile] tile is required");let n=this.canvas;if(!t.cacheImageRecord){e.console.warn("[Drawer._drawTileToHTML] attempting to draw tile %s when it's not cached",t.toString());return}if(!t.loaded){e.console.warn("Attempting to draw tile %s when it's not yet loaded.",t.toString());return}if(!t.element){var s=t.getImage();if(!s)return;t.element=e.makeNeutralElement("div"),t.imgElement=s.cloneNode(),t.imgElement.style.msInterpolationMode="nearest-neighbor",t.imgElement.style.width="100%",t.imgElement.style.height="100%",t.style=t.element.style,t.style.position="absolute"}t.element.parentNode!==n&&n.appendChild(t.element),t.imgElement.parentNode!==t.element&&t.element.appendChild(t.imgElement),t.style.top=t.position.y+"px",t.style.left=t.position.x+"px",t.style.height=t.size.y+"px",t.style.width=t.size.x+"px",t.flipped&&(t.style.transform="scaleX(-1)"),e.setElementOpacity(t.element,t.opacity)}}e.HTMLDrawer=n}(n),function(e){const o=e;class i extends o.DrawerBase{constructor(e){super(e),this.context=this.canvas.getContext("2d"),this.sketchCanvas=null,this.sketchContext=null,this._imageSmoothingEnabled=!0,this.viewer.allowEventHandler("tile-drawn"),this.viewer.allowEventHandler("tile-drawing")}static isSupported(){return e.supportsCanvas}getType(){return"canvas"}_createDrawingElement(){let t=e.makeNeutralElement("canvas"),n=this._calculateCanvasSize();return t.width=n.x,t.height=n.y,t}draw(e){this._prepareNewFrame(),this.viewer.viewport.getFlip()!==this._viewportFlipped&&this._flip();for(const t of e)t.opacity!==0&&this._drawTiles(t)}canRotate(){return!0}destroy(){this.canvas.width=1,this.canvas.height=1,this.sketchCanvas=null,this.sketchContext=null,this.container.removeChild(this.canvas)}minimumOverlapRequired(){return!0}setImageSmoothingEnabled(e){this._imageSmoothingEnabled=!!e,this._updateImageSmoothingEnabled(this.context),this.viewer.forceRedraw()}drawDebuggingRect(t){var n=this.context;n.save(),n.lineWidth=2*e.pixelDensityRatio,n.strokeStyle=this.debugGridColor[0],n.fillStyle=this.debugGridColor[0],n.strokeRect(t.x*e.pixelDensityRatio,t.y*e.pixelDensityRatio,t.width*e.pixelDensityRatio,t.height*e.pixelDensityRatio),n.restore()}get _viewportFlipped(){return this.context.getTransform().a<0}_raiseTileDrawingEvent(e,t,n,s){this.viewer.raiseEvent("tile-drawing",{tiledImage:e,context:t,tile:n,rendered:s})}_prepareNewFrame(){var t,e=this._calculateCanvasSize();(this.canvas.width!==e.x||this.canvas.height!==e.y)&&(this.canvas.width=e.x,this.canvas.height=e.y,this._updateImageSmoothingEnabled(this.context),this.sketchCanvas!==null&&(t=this._calculateSketchCanvasSize(),this.sketchCanvas.width=t.x,this.sketchCanvas.height=t.y,this._updateImageSmoothingEnabled(this.sketchContext))),this._clear()}_clear(e,t){var s,n=this._getContext(e);t?n.clearRect(t.x,t.y,t.width,t.height):(s=n.canvas,n.clearRect(0,0,s.width,s.height))}_drawTiles(t){var n,s,o,i,c,l,d,u,h,m,f,p,g,v,b,j,r=t.getTilesToDraw().map(e=>e.tile);if(t.opacity===0||r.length===0&&!t.placeholderFillStyle)return;if(o=r[0],o&&(s=t.opacity<1||t.compositeOperation&&t.compositeOperation!=="source-over"||!t._isBottomItem()&&t.source.hasTransparency(o.context2D,o.getUrl(),o.ajaxHeaders,o.postData)),g=this.viewport.getZoom(!0),p=t.viewportToImageZoom(g),r.length>1&&p>t.smoothTileEdgesMinZoom&&!t.iOSDevice&&t.getRotation(!0)%360===0&&(s=!0,n=o.getScaleForEdgeSmoothing(),i=o.getTranslationForEdgeSmoothing(n,this._getCanvasSize(!1),this._getCanvasSize(!0))),s&&(n||(d=this.viewport.viewportToViewerElementRectangle(t.getClippedBounds(!0)).getIntegerBoundingBox(),d=d.times(e.pixelDensityRatio)),this._clear(!0,d)),n||this._setRotations(t,s),l=!1,t._clip&&(this._saveContext(s),u=t.imageToViewportRectangle(t._clip,!0),u=u.rotate(-t.getRotation(!0),t._getRotationPoint(!0)),c=this.viewportToDrawerRectangle(u),n&&(c=c.times(n)),i&&(c=c.translate(i)),this._setClip(c,s),l=!0),t._croppingPolygons){v=this,l||this._saveContext(s);try{b=t._croppingPolygons.map(function(e){return e.map(function(e){var o=t.imageToViewportCoordinates(e.x,e.y,!0).rotate(-t.getRotation(!0),t._getRotationPoint(!0)),s=v.viewportCoordToDrawerCoord(o);return n&&(s=s.times(n)),i&&(s=s.plus(i)),s})}),this._clipWithPolygons(b,s)}catch(t){e.console.error(t)}l=!0}if(t._hasOpaqueTile=!1,t.placeholderFillStyle&&t._hasOpaqueTile===!1){let e=this.viewportToDrawerRectangle(t.getBoundsNoRotate(!0));n&&(e=e.times(n)),i&&(e=e.translate(i));let o=null;typeof t.placeholderFillStyle=="function"?o=t.placeholderFillStyle(t,this.context):o=t.placeholderFillStyle,this._drawRectangle(e,o,s)}f=a(t.subPixelRoundingForTransparency),h=!1,f===e.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS?h=!0:f===e.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST&&(j=this.viewer&&this.viewer.isAnimating(),h=!j);for(m=0;m<r.length;m++)o=r[m],this._drawTile(o,t,s,n,i,h,t.source),this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:t,tile:o});l&&this._restoreContext(s),n||(t.getRotation(!0)%360!==0&&this._restoreRotationChanges(s),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(s)),s&&(n&&this._setRotations(t),this.blendSketch({opacity:t.opacity,scale:n,translate:i,compositeOperation:t.compositeOperation,bounds:d}),n&&(t.getRotation(!0)%360!==0&&this._restoreRotationChanges(!1),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(!1))),this._drawDebugInfo(t,r),this._raiseTiledImageDrawnEvent(t,r)}_drawDebugInfo(t,n){if(t.debugMode)for(var o,s=n.length-1;s>=0;s--){o=n[s];try{this._drawDebugInfoOnTile(o,n.length,s,t)}catch(t){e.console.error(t)}}}_clipWithPolygons(e,t){var n=this._getContext(t);n.beginPath();for(const t of e)for(const[s,e]of t.entries())n[s===0?"moveTo":"lineTo"](e.x,e.y);n.clip()}_drawTile(t,n,s,o,i,a,r){e.console.assert(t,"[Drawer._drawTile] tile is required"),e.console.assert(n,"[Drawer._drawTile] drawingHandler is required");var c=this._getContext(s);o=o||1,this._drawTileToCanvas(t,c,n,o,i,a,r)}_drawTileToCanvas(t,n,s,o,i,a){var d,u,h,c=t.position.times(e.pixelDensityRatio),l=t.size.times(e.pixelDensityRatio);if(!t.context2D&&!t.cacheImageRecord){e.console.warn("[Drawer._drawTileToCanvas] attempting to draw tile %s when it's not cached",t.toString());return}if(d=t.getCanvasContext(),!t.loaded||!d){e.console.warn("Attempting to draw tile %s when it's not yet loaded.",t.toString());return}n.save(),typeof o=="number"&&o!==1&&(c=c.times(o),l=l.times(o)),i instanceof e.Point&&(c=c.plus(i)),n.globalAlpha===1&&t.hasTransparency&&(a&&(c.x=Math.round(c.x),c.y=Math.round(c.y),l.x=Math.round(l.x),l.y=Math.round(l.y)),n.clearRect(c.x,c.y,l.x,l.y)),this._raiseTileDrawingEvent(s,n,t,d),t.sourceBounds?(u=Math.min(t.sourceBounds.width,d.canvas.width),h=Math.min(t.sourceBounds.height,d.canvas.height)):(u=d.canvas.width,h=d.canvas.height),n.translate(c.x+l.x/2,0),t.flipped&&n.scale(-1,1),n.drawImage(d.canvas,0,0,u,h,-l.x/2,c.y,l.x,l.y),n.restore()}_getContext(e){var t,n,s=this.context;return e&&(this.sketchCanvas===null&&(this.sketchCanvas=document.createElement("canvas"),n=this._calculateSketchCanvasSize(),this.sketchCanvas.width=n.x,this.sketchCanvas.height=n.y,this.sketchContext=this.sketchCanvas.getContext("2d"),this.viewport.getRotation()===0&&(t=this,this.viewer.addHandler("rotate",function e(){if(t.viewport.getRotation()===0)return;t.viewer.removeHandler("rotate",e);var n=t._calculateSketchCanvasSize();t.sketchCanvas.width=n.x,t.sketchCanvas.height=n.y})),this._updateImageSmoothingEnabled(this.sketchContext)),s=this.sketchContext),s}_saveContext(e){this._getContext(e).save()}_restoreContext(e){this._getContext(e).restore()}_setClip(e,t){var n=this._getContext(t);n.beginPath(),n.rect(e.x,e.y,e.width,e.height),n.clip()}_drawRectangle(e,t,n){var s=this._getContext(n);s.save(),s.fillStyle=t,s.fillRect(e.x,e.y,e.width,e.height),s.restore()}blendSketch(t,n,s,o){var i,r,c,l,d,u,a=t;e.isPlainObject(a)||(a={opacity:t,scale:n,translate:s,compositeOperation:o}),t=a.opacity,o=a.compositeOperation,i=a.bounds,this.context.save(),this.context.globalAlpha=t,o&&(this.context.globalCompositeOperation=o),i?(i.x<0&&(i.width+=i.x,i.x=0),i.x+i.width>this.canvas.width&&(i.width=this.canvas.width-i.x),i.y<0&&(i.height+=i.y,i.y=0),i.y+i.height>this.canvas.height&&(i.height=this.canvas.height-i.y),this.context.drawImage(this.sketchCanvas,i.x,i.y,i.width,i.height,i.x,i.y,i.width,i.height)):(n=a.scale||1,s=a.translate,l=s instanceof e.Point?s:new e.Point(0,0),r=0,c=0,s&&(d=this.sketchCanvas.width-this.canvas.width,u=this.sketchCanvas.height-this.canvas.height,r=Math.round(d/2),c=Math.round(u/2)),this.context.drawImage(this.sketchCanvas,l.x-r*n,l.y-c*n,(this.canvas.width+2*r)*n,(this.canvas.height+2*c)*n,-r,-c,this.canvas.width+2*r,this.canvas.height+2*c)),this.context.restore()}_drawDebugInfoOnTile(t,n,s,o){var a,r,c=this.viewer.world.getIndexOfItem(o)%this.debugGridColor.length,i=this.context;i.save(),i.lineWidth=2*e.pixelDensityRatio,i.font="small-caps bold "+13*e.pixelDensityRatio+"px arial",i.strokeStyle=this.debugGridColor[c],i.fillStyle=this.debugGridColor[c],this._setRotations(o),this._viewportFlipped&&this._flip({point:t.position.plus(t.size.divide(2))}),i.strokeRect(t.position.x*e.pixelDensityRatio,t.position.y*e.pixelDensityRatio,t.size.x*e.pixelDensityRatio,t.size.y*e.pixelDensityRatio),a=(t.position.x+t.size.x/2)*e.pixelDensityRatio,r=(t.position.y+t.size.y/2)*e.pixelDensityRatio,i.translate(a,r);const l=this.viewport.getRotation(!0);i.rotate(Math.PI/180*-l),i.translate(-a,-r),t.x===0&&t.y===0&&(i.fillText("Zoom: "+this.viewport.getZoom(),t.position.x*e.pixelDensityRatio,(t.position.y-30)*e.pixelDensityRatio),i.fillText("Pan: "+this.viewport.getBounds().toString(),t.position.x*e.pixelDensityRatio,(t.position.y-20)*e.pixelDensityRatio)),i.fillText("Level: "+t.level,(t.position.x+10)*e.pixelDensityRatio,(t.position.y+20)*e.pixelDensityRatio),i.fillText("Column: "+t.x,(t.position.x+10)*e.pixelDensityRatio,(t.position.y+30)*e.pixelDensityRatio),i.fillText("Row: "+t.y,(t.position.x+10)*e.pixelDensityRatio,(t.position.y+40)*e.pixelDensityRatio),i.fillText("Order: "+s+" of "+n,(t.position.x+10)*e.pixelDensityRatio,(t.position.y+50)*e.pixelDensityRatio),i.fillText("Size: "+t.size.toString(),(t.position.x+10)*e.pixelDensityRatio,(t.position.y+60)*e.pixelDensityRatio),i.fillText("Position: "+t.position.toString(),(t.position.x+10)*e.pixelDensityRatio,(t.position.y+70)*e.pixelDensityRatio),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(),o.getRotation(!0)%360!==0&&this._restoreRotationChanges(),i.restore()}_updateImageSmoothingEnabled(e){e.msImageSmoothingEnabled=this._imageSmoothingEnabled,e.imageSmoothingEnabled=this._imageSmoothingEnabled}_getCanvasSize(t){var n=this._getContext(t).canvas;return new e.Point(n.width,n.height)}_getCanvasCenter(){return new e.Point(this.canvas.width/2,this.canvas.height/2)}_setRotations(e,t=!1){var n=!1;this.viewport.getRotation(!0)%360!==0&&(this._offsetForRotation({degrees:this.viewport.getRotation(!0),useSketch:t,saveContext:n}),n=!1),e.getRotation(!0)%360!==0&&this._offsetForRotation({degrees:e.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(e._getRotationPoint(!0),!0),useSketch:t,saveContext:n})}_offsetForRotation(t){var n=t.point?t.point.times(e.pixelDensityRatio):this._getCanvasCenter(),s=this._getContext(t.useSketch);s.save(),s.translate(n.x,n.y),s.rotate(Math.PI/180*t.degrees),s.translate(-n.x,-n.y)}_flip(t){t=t||{};var s=t.point?t.point.times(e.pixelDensityRatio):this._getCanvasCenter(),n=this._getContext(t.useSketch);n.translate(s.x,0),n.scale(-1,1),n.translate(-s.x,0)}_restoreRotationChanges(e){var t=this._getContext(e);t.restore()}_calculateCanvasSize(){var t=e.pixelDensityRatio,n=this.viewport.getContainerSize();return{x:Math.round(n.x*t),y:Math.round(n.y*t)}}_calculateSketchCanvasSize(){var t,e=this._calculateCanvasSize();return this.viewport.getRotation()===0?e:(t=Math.ceil(Math.sqrt(e.x*e.x+e.y*e.y)),{x:t,y:t})}}e.CanvasDrawer=i;var t=e.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER;function n(t){return t!==e.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS&&t!==e.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST&&t!==e.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER}function s(e){return n(e)?t:e}function a(o){if(typeof o=="number")return s(o);if(!o||!e.Browser)return t;var i=o[e.Browser.vendor];return n(i)&&(i=o["*"]),s(i)}}(n),function(e){const t=e;t.WebGLDrawer=class WebGLDrawer extends t.DrawerBase{constructor(e){super(e),this._destroyed=!1,this._TextureMap=new Map,this._TileMap=new Map,this._gl=null,this._firstPass=null,this._secondPass=null,this._glFrameBuffer=null,this._renderToTexture=null,this._glFramebufferToCanvasTransform=null,this._outputCanvas=null,this._outputContext=null,this._clippingCanvas=null,this._clippingContext=null,this._renderingCanvas=null,this._backupCanvasDrawer=null,this._imageSmoothingEnabled=!0,this._boundToTileReady=e=>this._tileReadyHandler(e),this._boundToImageUnloaded=e=>this._imageUnloadedHandler(e),this.viewer.addHandler("tile-ready",this._boundToTileReady),this.viewer.addHandler("image-unloaded",this._boundToImageUnloaded),this.viewer.rejectEventHandler("tile-drawn","The WebGLDrawer does not raise the tile-drawn event"),this.viewer.rejectEventHandler("tile-drawing","The WebGLDrawer does not raise the tile-drawing event"),this._setupCanvases(),this._setupRenderer(),this.context=this._outputContext}destroy(){if(this._destroyed)return;let e=this._gl;var n=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS);for(let t=0;t<n;++t)e.activeTexture(e.TEXTURE0+t),e.bindTexture(e.TEXTURE_2D,null),e.bindTexture(e.TEXTURE_CUBE_MAP,null);e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null),this._unloadTextures(),e.deleteBuffer(this._secondPass.bufferOutputPosition),e.deleteFramebuffer(this._glFrameBuffer),this._renderingCanvas.width=this._renderingCanvas.height=1,this._clippingCanvas.width=this._clippingCanvas.height=1,this._outputCanvas.width=this._outputCanvas.height=1,this._renderingCanvas=null,this._clippingCanvas=this._clippingContext=null,this._outputCanvas=this._outputContext=null;let t=e.getExtension("WEBGL_lose_context");t&&t.loseContext(),this.viewer.removeHandler("tile-ready",this._boundToTileReady),this.viewer.removeHandler("image-unloaded",this._boundToImageUnloaded),this.viewer.removeHandler("resize",this._resizeHandler),this._gl=null,this._backupCanvasDrawer&&(this._backupCanvasDrawer.destroy(),this._backupCanvasDrawer=null),this.container.removeChild(this.canvas),this.viewer.drawer===this&&(this.viewer.drawer=null),this._destroyed=!0}canRotate(){return!0}static isSupported(){let n=document.createElement("canvas"),t=e.isFunction(n.getContext)&&n.getContext("webgl"),s=t&&t.getExtension("WEBGL_lose_context");return s&&s.loseContext(),!!t}getType(){return"webgl"}minimumOverlapRequired(e){return e.isTainted()}_createDrawingElement(){let t=e.makeNeutralElement("canvas"),n=this._calculateCanvasSize();return t.width=n.x,t.height=n.y,t}_getBackupCanvasDrawer(){return this._backupCanvasDrawer||(this._backupCanvasDrawer=this.viewer.requestDrawer("canvas",{mainDrawer:!1}),this._backupCanvasDrawer.canvas.style.setProperty("visibility","hidden")),this._backupCanvasDrawer}draw(n){let s=this._gl;const i=this.viewport.getBoundsNoRotateWithMargins(!0);let a={bounds:i,center:new t.Point(i.x+i.width/2,i.y+i.height/2),rotation:this.viewport.getRotation(!0)*Math.PI/180},c=this.viewport.flipped?-1:1,l=e.Mat3.makeTranslation(-a.center.x,-a.center.y),d=e.Mat3.makeScaling(2/a.bounds.width*c,-2/a.bounds.height),u=e.Mat3.makeRotation(-a.rotation),r=d.multiply(u).multiply(l);s.bindFramebuffer(s.FRAMEBUFFER,null),s.clear(s.COLOR_BUFFER_BIT),this._outputContext.clearRect(0,0,this._outputCanvas.width,this._outputCanvas.height);let o=!1;n.forEach((t,n)=>{if(t.isTainted()){o&&(this._outputContext.drawImage(this._renderingCanvas,0,0),s.bindFramebuffer(s.FRAMEBUFFER,null),s.clear(s.COLOR_BUFFER_BIT),o=!1);const e=this._getBackupCanvasDrawer();e.draw([t]),this._outputContext.drawImage(e.canvas,0,0)}else{let a=t.getTilesToDraw();if(t.placeholderFillStyle&&t._hasOpaqueTile===!1&&this._drawPlaceholder(t),a.length===0||t.getOpacity()===0)return;let g=a[0],c=t.compositeOperation||this.viewer.compositeOperation||t._clip||t._croppingPolygons||t.debugMode,l=c||t.opacity<1||g.hasTransparency;c&&(o&&this._outputContext.drawImage(this._renderingCanvas,0,0),s.bindFramebuffer(s.FRAMEBUFFER,null),s.clear(s.COLOR_BUFFER_BIT)),s.useProgram(this._firstPass.shaderProgram),l?(s.bindFramebuffer(s.FRAMEBUFFER,this._glFrameBuffer),s.clear(s.COLOR_BUFFER_BIT)):s.bindFramebuffer(s.FRAMEBUFFER,null);let d=r,u=t.getRotation(!0);if(u%360!==0){let s=e.Mat3.makeRotation(-u*Math.PI/180),n=t.getBoundsNoRotate(!0).getCenter(),o=e.Mat3.makeTranslation(n.x,n.y),i=e.Mat3.makeTranslation(-n.x,-n.y),a=o.multiply(s).multiply(i);d=r.multiply(a)}let i=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS);if(i<=0)throw new Error(`WegGL error: bad value for gl parameter MAX_TEXTURE_IMAGE_UNITS (${i}). This could happen
                        if too many contexts have been created and not released, or there is another problem with the graphics card.`);let h=new Float32Array(i*12),m=new Array(i),f=new Array(i),p=new Array(i);for(let e=0;e<a.length;e++){let r=a[e].tile,l=e%i,c=l+1,n=r.getCanvasContext(),o=n?this._TextureMap.get(n.canvas):null;if(o||(this._tileReadyHandler({tile:r,tiledImage:t}),o=n?this._TextureMap.get(n.canvas):null),o&&this._getTileData(r,t,o,d,l,h,m,f,p),c===i||e===a.length-1){for(let e=0;e<=c;e++)s.activeTexture(s.TEXTURE0+e),s.bindTexture(s.TEXTURE_2D,m[e]);s.bindBuffer(s.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),s.bufferData(s.ARRAY_BUFFER,h,s.DYNAMIC_DRAW),f.forEach((e,t)=>{s.uniformMatrix3fv(this._firstPass.uTransformMatrices[t],!1,e)}),s.uniform1fv(this._firstPass.uOpacities,new Float32Array(p)),s.bindBuffer(s.ARRAY_BUFFER,this._firstPass.bufferOutputPosition),s.vertexAttribPointer(this._firstPass.aOutputPosition,2,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),s.vertexAttribPointer(this._firstPass.aTexturePosition,2,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._firstPass.bufferIndex),s.vertexAttribPointer(this._firstPass.aIndex,1,s.FLOAT,!1,0,0),s.drawArrays(s.TRIANGLES,0,6*c)}}l&&(s.useProgram(this._secondPass.shaderProgram),s.bindFramebuffer(s.FRAMEBUFFER,null),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._renderToTexture),this._gl.uniform1f(this._secondPass.uOpacityMultiplier,t.opacity),s.bindBuffer(s.ARRAY_BUFFER,this._secondPass.bufferTexturePosition),s.vertexAttribPointer(this._secondPass.aTexturePosition,2,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._secondPass.bufferOutputPosition),s.vertexAttribPointer(this._secondPass.aOutputPosition,2,s.FLOAT,!1,0,0),s.drawArrays(s.TRIANGLES,0,6)),o=!0,c&&(this._applyContext2dPipeline(t,a,n),o=!1,s.bindFramebuffer(s.FRAMEBUFFER,null),s.clear(s.COLOR_BUFFER_BIT)),n===0&&this._raiseTiledImageDrawnEvent(t,a.map(e=>e.tile))}}),o&&this._outputContext.drawImage(this._renderingCanvas,0,0)}setImageSmoothingEnabled(e){this._imageSmoothingEnabled!==e&&(this._imageSmoothingEnabled=e,this._unloadTextures(),this.viewer.world.draw())}drawDebuggingRect(t){let n=this._outputContext;n.save(),n.lineWidth=2*e.pixelDensityRatio,n.strokeStyle=this.debugGridColor[0],n.fillStyle=this.debugGridColor[0],n.strokeRect(t.x*e.pixelDensityRatio,t.y*e.pixelDensityRatio,t.width*e.pixelDensityRatio,t.height*e.pixelDensityRatio),n.restore()}_getTextureDataFromTile(e){return e.getCanvasContext().canvas}_applyContext2dPipeline(e,t,n){if(this._outputContext.save(),this._outputContext.globalCompositeOperation=n===0?null:e.compositeOperation||this.viewer.compositeOperation,e._croppingPolygons||e._clip?(this._renderToClippingCanvas(e),this._outputContext.drawImage(this._clippingCanvas,0,0)):this._outputContext.drawImage(this._renderingCanvas,0,0),this._outputContext.restore(),e.debugMode){const n=this.viewer.viewport.getFlip();n&&this._flip(),this._drawDebugInfo(t,e,n),n&&this._flip()}}_getTileData(t,n,s,o,i,a,r,c,l){let g=s.texture,_=s.position;a.set(_,i*12);let h=this._calculateOverlapFraction(t,n),m=t.positionedBounds.width*h.x,f=t.positionedBounds.height*h.y,p=t.positionedBounds.x+(t.x===0?0:m),u=t.positionedBounds.y+(t.y===0?0:f),v=t.positionedBounds.x+t.positionedBounds.width-(t.isRightMost?0:m),b=t.positionedBounds.y+t.positionedBounds.height-(t.isBottomMost?0:f),j=v-p,y=b-u,d=new e.Mat3([j,0,0,0,y,0,p,u,1]);if(t.flipped){let t=e.Mat3.makeTranslation(.5,0),n=e.Mat3.makeTranslation(-.5,0),s=t.multiply(e.Mat3.makeScaling(-1,1)).multiply(n);d=d.multiply(s)}let w=o.multiply(d);l[i]=t.opacity,r[i]=g,c[i]=w.values}_textureFilter(){return this._imageSmoothingEnabled?this._gl.LINEAR:this._gl.NEAREST}_setupRenderer(){let t=this._gl;t||e.console.error("_setupCanvases must be called before _setupRenderer"),this._unitQuad=this._makeQuadVertexBuffer(0,1,0,1),this._makeFirstPassShaderProgram(),this._makeSecondPassShaderProgram(),this._renderToTexture=t.createTexture(),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._renderToTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this._renderingCanvas.width,this._renderingCanvas.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,this._textureFilter()),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),this._glFrameBuffer=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._glFrameBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this._renderToTexture,0),t.enable(t.BLEND),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA)}_makeFirstPassShaderProgram(){let t=this._glNumTextures=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),o=()=>[...Array(t).keys()].map(e=>`uniform mat3 u_matrix_${e};`).join(`
`),i=()=>[...Array(t).keys()].map(e=>`${e>0?"else ":""}if(int(a_index) == ${e}) { transform_matrix = u_matrix_${e}; }`).join(`
`);const a=`
            attribute vec2 a_output_position;
            attribute vec2 a_texture_position;
            attribute float a_index;

            ${o()} // create a uniform mat3 for each potential tile to draw

            varying vec2 v_texture_position;
            varying float v_image_index;

            void main() {

                mat3 transform_matrix; // value will be set by the if/elses in makeConditional()

                ${i()}

                gl_Position = vec4(transform_matrix * vec3(a_output_position, 1), 1);

                v_texture_position = a_texture_position;
                v_image_index = a_index;
            }
            `,r=`
            precision mediump float;

            // our textures
            uniform sampler2D u_images[${t}];
            // our opacities
            uniform float u_opacities[${t}];

            // the varyings passed in from the vertex shader.
            varying vec2 v_texture_position;
            varying float v_image_index;

            void main() {
                // can't index directly with a variable, need to use a loop iterator hack
                for(int i = 0; i < ${t}; ++i){
                    if(i == int(v_image_index)){
                        gl_FragColor = texture2D(u_images[i], v_texture_position) * u_opacities[i];
                    }
                }
            }
            `;let e=this._gl,n=this.constructor.initShaderProgram(e,a,r);e.useProgram(n),this._firstPass={shaderProgram:n,aOutputPosition:e.getAttribLocation(n,"a_output_position"),aTexturePosition:e.getAttribLocation(n,"a_texture_position"),aIndex:e.getAttribLocation(n,"a_index"),uTransformMatrices:[...Array(this._glNumTextures).keys()].map(t=>e.getUniformLocation(n,`u_matrix_${t}`)),uImages:e.getUniformLocation(n,"u_images"),uOpacities:e.getUniformLocation(n,"u_opacities"),bufferOutputPosition:e.createBuffer(),bufferTexturePosition:e.createBuffer(),bufferIndex:e.createBuffer()},e.uniform1iv(this._firstPass.uImages,[...Array(t).keys()]);let s=new Float32Array(t*12);for(let e=0;e<t;++e)s.set(Float32Array.from(this._unitQuad),e*12);e.bindBuffer(e.ARRAY_BUFFER,this._firstPass.bufferOutputPosition),e.bufferData(e.ARRAY_BUFFER,s,e.STATIC_DRAW),e.enableVertexAttribArray(this._firstPass.aOutputPosition),e.bindBuffer(e.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),e.enableVertexAttribArray(this._firstPass.aTexturePosition),e.bindBuffer(e.ARRAY_BUFFER,this._firstPass.bufferIndex);let c=[...Array(this._glNumTextures).keys()].map(e=>Array(6).fill(e)).flat();e.bufferData(e.ARRAY_BUFFER,new Float32Array(c),e.STATIC_DRAW),e.enableVertexAttribArray(this._firstPass.aIndex)}_makeSecondPassShaderProgram(){const s=`
            attribute vec2 a_output_position;
            attribute vec2 a_texture_position;

            uniform mat3 u_matrix;

            varying vec2 v_texture_position;

            void main() {
                gl_Position = vec4(u_matrix * vec3(a_output_position, 1), 1);

                v_texture_position = a_texture_position;
            }
            `,o=`
            precision mediump float;

            // our texture
            uniform sampler2D u_image;

            // the texCoords passed in from the vertex shader.
            varying vec2 v_texture_position;

            // the opacity multiplier for the image
            uniform float u_opacity_multiplier;

            void main() {
                gl_FragColor = texture2D(u_image, v_texture_position);
                gl_FragColor *= u_opacity_multiplier;
            }
            `;let t=this._gl,n=this.constructor.initShaderProgram(t,s,o);t.useProgram(n),this._secondPass={shaderProgram:n,aOutputPosition:t.getAttribLocation(n,"a_output_position"),aTexturePosition:t.getAttribLocation(n,"a_texture_position"),uMatrix:t.getUniformLocation(n,"u_matrix"),uImage:t.getUniformLocation(n,"u_image"),uOpacityMultiplier:t.getUniformLocation(n,"u_opacity_multiplier"),bufferOutputPosition:t.createBuffer(),bufferTexturePosition:t.createBuffer()},t.bindBuffer(t.ARRAY_BUFFER,this._secondPass.bufferOutputPosition),t.bufferData(t.ARRAY_BUFFER,this._unitQuad,t.STATIC_DRAW),t.enableVertexAttribArray(this._secondPass.aOutputPosition),t.bindBuffer(t.ARRAY_BUFFER,this._secondPass.bufferTexturePosition),t.bufferData(t.ARRAY_BUFFER,this._unitQuad,t.DYNAMIC_DRAW),t.enableVertexAttribArray(this._secondPass.aTexturePosition);let i=e.Mat3.makeScaling(2,2).multiply(e.Mat3.makeTranslation(-.5,-.5));t.uniformMatrix3fv(this._secondPass.uMatrix,!1,i.values)}_resizeRenderer(){let e=this._gl,t=this._renderingCanvas.width,n=this._renderingCanvas.height;e.viewport(0,0,t,n),e.deleteTexture(this._renderToTexture),this._renderToTexture=e.createTexture(),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this._renderToTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,n,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,this._textureFilter()),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindFramebuffer(e.FRAMEBUFFER,this._glFrameBuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this._renderToTexture,0)}_setupCanvases(){let e=this;this._outputCanvas=this.canvas,this._outputContext=this._outputCanvas.getContext("2d"),this._renderingCanvas=document.createElement("canvas"),this._clippingCanvas=document.createElement("canvas"),this._clippingContext=this._clippingCanvas.getContext("2d"),this._renderingCanvas.width=this._clippingCanvas.width=this._outputCanvas.width,this._renderingCanvas.height=this._clippingCanvas.height=this._outputCanvas.height,this._gl=this._renderingCanvas.getContext("webgl"),this._resizeHandler=function(){e._outputCanvas!==e.viewer.drawer.canvas&&(e._outputCanvas.style.width=e.viewer.drawer.canvas.clientWidth+"px",e._outputCanvas.style.height=e.viewer.drawer.canvas.clientHeight+"px");let t=e._calculateCanvasSize();(e._outputCanvas.width!==t.x||e._outputCanvas.height!==t.y)&&(e._outputCanvas.width=t.x,e._outputCanvas.height=t.y),e._renderingCanvas.style.width=e._outputCanvas.clientWidth+"px",e._renderingCanvas.style.height=e._outputCanvas.clientHeight+"px",e._renderingCanvas.width=e._clippingCanvas.width=e._outputCanvas.width,e._renderingCanvas.height=e._clippingCanvas.height=e._outputCanvas.height,e._resizeRenderer()},this.viewer.addHandler("resize",this._resizeHandler)}_makeQuadVertexBuffer(e,t,n,s){return new Float32Array([e,s,t,s,e,n,e,n,t,s,t,n])}_tileReadyHandler(t){let n=t.tile,o=t.tiledImage;if(o.isTainted())return;let i=n.getCanvasContext(),s=i&&i.canvas;if(!s||e.isCanvasTainted(s)){const t=o.isTainted();t||(o.setTainted(!0),e.console.warn("WebGL cannot be used to draw this TiledImage because it has tainted data. Does crossOriginPolicy need to be set?"),this._raiseDrawerErrorEvent(o,"Tainted data cannot be used by the WebGLDrawer. Falling back to CanvasDrawer for this TiledImage."));return}let a=this._TextureMap.get(s);if(!a){let e=this._gl,c=e.createTexture(),r,l=o.source.tileOverlap,t,a;if(n.sourceBounds?(t=Math.min(n.sourceBounds.width,s.width)/s.width,a=Math.min(n.sourceBounds.height,s.height)/s.height):(t=1,a=1),l>0){let e=this._calculateOverlapFraction(n,o),s=(n.x===0?0:e.x)*t,i=(n.y===0?0:e.y)*a,c=(n.isRightMost?1:1-e.x)*t,l=(n.isBottomMost?1:1-e.y)*a;r=this._makeQuadVertexBuffer(s,c,i,l)}else t===1&&a===1?r=this._unitQuad:r=this._makeQuadVertexBuffer(0,t,0,a);let d={texture:c,position:r};this._TextureMap.set(s,d),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,c),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,this._textureFilter()),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,this._textureFilter()),this._uploadImageData(i)}}_calculateOverlapFraction(e,t){let n=t.source.tileOverlap,s=e.sourceBounds.width,o=e.sourceBounds.height,i=(e.x===0?0:n)+(e.isRightMost?0:n),a=(e.y===0?0:n)+(e.isBottomMost?0:n),r=n/(s+i),c=n/(o+a);return{x:r,y:c}}_unloadTextures(){let e=Array.from(this._TextureMap.keys());e.forEach(e=>{this._cleanupImageData(e)})}_uploadImageData(t){let n=this._gl,s=t.canvas;try{if(!s)throw"Tile context does not have a canvas",t;n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,s)}catch(t){e.console.error("Error uploading image data to WebGL",t)}}_imageUnloadedHandler(e){let t=e.context2D.canvas;this._cleanupImageData(t)}_cleanupImageData(e){let t=this._TextureMap.get(e);this._TextureMap.delete(e),t&&this._gl.deleteTexture(t.texture)}_setClip(){}_renderToClippingCanvas(t){if(this._clippingContext.clearRect(0,0,this._clippingCanvas.width,this._clippingCanvas.height),this._clippingContext.save(),this.viewer.viewport.getFlip()){const t=new e.Point(this.canvas.width/2,this.canvas.height/2);this._clippingContext.translate(t.x,0),this._clippingContext.scale(-1,1),this._clippingContext.translate(-t.x,0)}if(t._clip){const e=[{x:t._clip.x,y:t._clip.y},{x:t._clip.x+t._clip.width,y:t._clip.y},{x:t._clip.x+t._clip.width,y:t._clip.y+t._clip.height},{x:t._clip.x,y:t._clip.y+t._clip.height}];let n=e.map(e=>{let n=t.imageToViewportCoordinates(e.x,e.y,!0).rotate(this.viewer.viewport.getRotation(!0),this.viewer.viewport.getCenter(!0)),s=this.viewportCoordToDrawerCoord(n);return s});this._clippingContext.beginPath(),n.forEach((e,t)=>{this._clippingContext[t===0?"moveTo":"lineTo"](e.x,e.y)}),this._clippingContext.clip(),this._setClip()}if(t._croppingPolygons){let e=t._croppingPolygons.map(e=>e.map(e=>{let n=t.imageToViewportCoordinates(e.x,e.y,!0).rotate(this.viewer.viewport.getRotation(!0),this.viewer.viewport.getCenter(!0)),s=this.viewportCoordToDrawerCoord(n);return s}));this._clippingContext.beginPath(),e.forEach(e=>{e.forEach((e,t)=>{this._clippingContext[t===0?"moveTo":"lineTo"](e.x,e.y)})}),this._clippingContext.clip()}if(this.viewer.viewport.getFlip()){const t=new e.Point(this.canvas.width/2,this.canvas.height/2);this._clippingContext.translate(t.x,0),this._clippingContext.scale(-1,1),this._clippingContext.translate(-t.x,0)}this._clippingContext.drawImage(this._renderingCanvas,0,0),this._clippingContext.restore()}_setRotations(e){var t=!1;this.viewport.getRotation(!0)%360!==0&&(this._offsetForRotation({degrees:this.viewport.getRotation(!0),saveContext:t}),t=!1),e.getRotation(!0)%360!==0&&this._offsetForRotation({degrees:e.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(e._getRotationPoint(!0),!0),saveContext:t})}_offsetForRotation(t){var n=t.point?t.point.times(e.pixelDensityRatio):this._getCanvasCenter(),s=this._outputContext;s.save(),s.translate(n.x,n.y),s.rotate(Math.PI/180*t.degrees),s.translate(-n.x,-n.y)}_flip(t){t=t||{};var s=t.point?t.point.times(e.pixelDensityRatio):this._getCanvasCenter(),n=this._outputContext;n.translate(s.x,0),n.scale(-1,1),n.translate(-s.x,0)}_drawDebugInfo(t,n,s){for(var i,o=t.length-1;o>=0;o--){i=t[o].tile;try{this._drawDebugInfoOnTile(i,t.length,o,n,s)}catch(t){e.console.error(t)}}}_drawDebugInfoOnTile(t,n,s,o,i){var r,c,l=this.viewer.world.getIndexOfItem(o)%this.debugGridColor.length,a=this.context;a.save(),a.lineWidth=2*e.pixelDensityRatio,a.font="small-caps bold "+13*e.pixelDensityRatio+"px arial",a.strokeStyle=this.debugGridColor[l],a.fillStyle=this.debugGridColor[l],this._setRotations(o),i&&this._flip({point:t.position.plus(t.size.divide(2))}),a.strokeRect(t.position.x*e.pixelDensityRatio,t.position.y*e.pixelDensityRatio,t.size.x*e.pixelDensityRatio,t.size.y*e.pixelDensityRatio),r=(t.position.x+t.size.x/2)*e.pixelDensityRatio,c=(t.position.y+t.size.y/2)*e.pixelDensityRatio,a.translate(r,c);const d=this.viewport.getRotation(!0);a.rotate(Math.PI/180*-d),a.translate(-r,-c),t.x===0&&t.y===0&&(a.fillText("Zoom: "+this.viewport.getZoom(),t.position.x*e.pixelDensityRatio,(t.position.y-30)*e.pixelDensityRatio),a.fillText("Pan: "+this.viewport.getBounds().toString(),t.position.x*e.pixelDensityRatio,(t.position.y-20)*e.pixelDensityRatio)),a.fillText("Level: "+t.level,(t.position.x+10)*e.pixelDensityRatio,(t.position.y+20)*e.pixelDensityRatio),a.fillText("Column: "+t.x,(t.position.x+10)*e.pixelDensityRatio,(t.position.y+30)*e.pixelDensityRatio),a.fillText("Row: "+t.y,(t.position.x+10)*e.pixelDensityRatio,(t.position.y+40)*e.pixelDensityRatio),a.fillText("Order: "+s+" of "+n,(t.position.x+10)*e.pixelDensityRatio,(t.position.y+50)*e.pixelDensityRatio),a.fillText("Size: "+t.size.toString(),(t.position.x+10)*e.pixelDensityRatio,(t.position.y+60)*e.pixelDensityRatio),a.fillText("Position: "+t.position.toString(),(t.position.x+10)*e.pixelDensityRatio,(t.position.y+70)*e.pixelDensityRatio),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(),o.getRotation(!0)%360!==0&&this._restoreRotationChanges(),a.restore()}_drawPlaceholder(e){const o=e.getBounds(!0),t=this.viewportToDrawerRectangle(e.getBounds(!0)),n=this._outputContext;let s;typeof e.placeholderFillStyle=="function"?s=e.placeholderFillStyle(e,n):s=e.placeholderFillStyle,this._offsetForRotation({degrees:this.viewer.viewport.getRotation(!0)}),n.fillStyle=s,n.translate(t.x,t.y),n.rotate(Math.PI/180*o.degrees),n.translate(-t.x,-t.y),n.fillRect(t.x,t.y,t.width,t.height),this._restoreRotationChanges()}_getCanvasCenter(){return new e.Point(this.canvas.width/2,this.canvas.height/2)}_restoreRotationChanges(){var e=this._outputContext;e.restore()}static initShaderProgram(t,n,s){function i(t,n,s){const o=t.createShader(n);return t.shaderSource(o,s),t.compileShader(o),t.getShaderParameter(o,t.COMPILE_STATUS)?o:(e.console.error(`An error occurred compiling the shaders: ${t.getShaderInfoLog(o)}`),t.deleteShader(o),null)}const a=i(t,t.VERTEX_SHADER,n),r=i(t,t.FRAGMENT_SHADER,s),o=t.createProgram();return t.attachShader(o,a),t.attachShader(o,r),t.linkProgram(o),t.getProgramParameter(o,t.LINK_STATUS)?o:(e.console.error(`Unable to initialize the shader program: ${t.getProgramInfoLog(o)}`),null)}}}(n),function(e){e.Viewport=function(t){var n=arguments;n.length&&n[0]instanceof e.Point&&(t={containerSize:n[0],contentSize:n[1],config:n[2]}),t.config&&(e.extend(!0,t,t.config),delete t.config),this._margins=e.extend({left:0,top:0,right:0,bottom:0},t.margins||{}),delete t.margins,t.initialDegrees=t.degrees,delete t.degrees,e.extend(!0,this,{containerSize:null,contentSize:null,zoomPoint:null,rotationPivot:null,viewer:null,springStiffness:e.DEFAULT_SETTINGS.springStiffness,animationTime:e.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:e.DEFAULT_SETTINGS.minZoomImageRatio,maxZoomPixelRatio:e.DEFAULT_SETTINGS.maxZoomPixelRatio,visibilityRatio:e.DEFAULT_SETTINGS.visibilityRatio,wrapHorizontal:e.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:e.DEFAULT_SETTINGS.wrapVertical,defaultZoomLevel:e.DEFAULT_SETTINGS.defaultZoomLevel,minZoomLevel:e.DEFAULT_SETTINGS.minZoomLevel,maxZoomLevel:e.DEFAULT_SETTINGS.maxZoomLevel,initialDegrees:e.DEFAULT_SETTINGS.degrees,flipped:e.DEFAULT_SETTINGS.flipped,homeFillsViewer:e.DEFAULT_SETTINGS.homeFillsViewer,silenceMultiImageWarnings:e.DEFAULT_SETTINGS.silenceMultiImageWarnings},t),this._updateContainerInnerSize(),this.centerSpringX=new e.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.centerSpringY=new e.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.zoomSpring=new e.Spring({exponential:!0,initial:1,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.degreesSpring=new e.Spring({initial:t.initialDegrees,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._oldDegrees=this.degreesSpring.current.value,this._setContentBounds(new e.Rect(0,0,1,1),1),this.goHome(!0),this.update()},e.Viewport.prototype={get degrees(){return e.console.warn("Accessing [Viewport.degrees] is deprecated. Use viewport.getRotation instead."),this.getRotation()},set degrees(t){e.console.warn("Setting [Viewport.degrees] is deprecated. Use viewport.rotateTo, viewport.rotateBy, or viewport.setRotation instead."),this.rotateTo(t)},resetContentSize:function(t){return e.console.assert(t,"[Viewport.resetContentSize] contentSize is required"),e.console.assert(t instanceof e.Point,"[Viewport.resetContentSize] contentSize must be an OpenSeadragon.Point"),e.console.assert(t.x>0,"[Viewport.resetContentSize] contentSize.x must be greater than 0"),e.console.assert(t.y>0,"[Viewport.resetContentSize] contentSize.y must be greater than 0"),this._setContentBounds(new e.Rect(0,0,1,t.y/t.x),t.x),this},setHomeBounds:function(t,n){e.console.error("[Viewport.setHomeBounds] this function is deprecated; The content bounds should not be set manually."),this._setContentBounds(t,n)},_setContentBounds:function(t,n){e.console.assert(t,"[Viewport._setContentBounds] bounds is required"),e.console.assert(t instanceof e.Rect,"[Viewport._setContentBounds] bounds must be an OpenSeadragon.Rect"),e.console.assert(t.width>0,"[Viewport._setContentBounds] bounds.width must be greater than 0"),e.console.assert(t.height>0,"[Viewport._setContentBounds] bounds.height must be greater than 0"),this._contentBoundsNoRotate=t.clone(),this._contentSizeNoRotate=this._contentBoundsNoRotate.getSize().times(n),this._contentBounds=t.rotate(this.getRotation()).getBoundingBox(),this._contentSize=this._contentBounds.getSize().times(n),this._contentAspectRatio=this._contentSize.x/this._contentSize.y,this.viewer&&this.viewer.raiseEvent("reset-size",{contentSize:this._contentSizeNoRotate.clone(),contentFactor:n,homeBounds:this._contentBoundsNoRotate.clone(),contentBounds:this._contentBounds.clone()})},getHomeZoom:function(){if(this.defaultZoomLevel)return this.defaultZoomLevel;var t,e=this._contentAspectRatio/this.getAspectRatio();return this.homeFillsViewer?t=e>=1?e:1:t=e>=1?1:e,t/this._contentBounds.width},getHomeBounds:function(){return this.getHomeBoundsNoRotate().rotate(-this.getRotation())},getHomeBoundsNoRotate:function(){var n=this._contentBounds.getCenter(),t=1/this.getHomeZoom(),s=t/this.getAspectRatio();return new e.Rect(n.x-t/2,n.y-s/2,t,s)},goHome:function(e){return this.viewer&&this.viewer.raiseEvent("home",{immediately:e}),this.fitBounds(this.getHomeBounds(),e)},getMinZoom:function(){var e=this.getHomeZoom(),t=this.minZoomLevel?this.minZoomLevel:this.minZoomImageRatio*e;return t},getMaxZoom:function(){var e=this.maxZoomLevel;return e||(e=this._contentSize.x*this.maxZoomPixelRatio/this._containerInnerSize.x,e/=this._contentBounds.width),Math.max(e,this.getHomeZoom())},getAspectRatio:function(){return this._containerInnerSize.x/this._containerInnerSize.y},getContainerSize:function(){return new e.Point(this.containerSize.x,this.containerSize.y)},getMargins:function(){return e.extend({},this._margins)},setMargins:function(t){e.console.assert(e.type(t)==="object","[Viewport.setMargins] margins must be an object"),this._margins=e.extend({left:0,top:0,right:0,bottom:0},t),this._updateContainerInnerSize(),this.viewer&&this.viewer.forceRedraw()},getBounds:function(e){return this.getBoundsNoRotate(e).rotate(-this.getRotation(e))},getBoundsNoRotate:function(t){var s=this.getCenter(t),n=1/this.getZoom(t),o=n/this.getAspectRatio();return new e.Rect(s.x-n/2,s.y-o/2,n,o)},getBoundsWithMargins:function(e){return this.getBoundsNoRotateWithMargins(e).rotate(-this.getRotation(e),this.getCenter(e))},getBoundsNoRotateWithMargins:function(e){var t=this.getBoundsNoRotate(e),n=this._containerInnerSize.x*this.getZoom(e);return t.x-=this._margins.left/n,t.y-=this._margins.top/n,t.width+=(this._margins.left+this._margins.right)/n,t.height+=(this._margins.top+this._margins.bottom)/n,t},getCenter:function(t){var n,o,i,r,c,l,d,u,s=new e.Point(this.centerSpringX.current.value,this.centerSpringY.current.value),a=new e.Point(this.centerSpringX.target.value,this.centerSpringY.target.value);return t?s:this.zoomPoint?(r=this.pixelFromPoint(this.zoomPoint,!0),o=this.getZoom(),n=1/o,i=n/this.getAspectRatio(),c=new e.Rect(s.x-n/2,s.y-i/2,n,i),l=this._pixelFromPoint(this.zoomPoint,c),d=l.minus(r).rotate(-this.getRotation(!0)),u=d.divide(this._containerInnerSize.x*o),a.plus(u)):a},getZoom:function(e){return e?this.zoomSpring.current.value:this.zoomSpring.target.value},_applyZoomConstraints:function(e){return Math.max(Math.min(e,this.getMaxZoom()),this.getMinZoom())},_applyBoundaryConstraints:function(e){var s,a,r,c,l,d,u,h,m,f,p,g,t=this.viewportToViewerElementRectangle(e).getBoundingBox(),n=this.viewportToViewerElementRectangle(this._contentBoundsNoRotate).getBoundingBox(),o=!1,i=!1;return this.wrapHorizontal||(g=t.x+t.width,p=n.x+n.width,t.width>n.width?r=this.visibilityRatio*n.width:r=this.visibilityRatio*t.width,d=n.x-g+r,l=p-t.x-r,r>n.width?(t.x+=(d+l)/2,o=!0):l<0?(t.x+=l,o=!0):d>0&&(t.x+=d,o=!0)),this.wrapVertical||(m=t.y+t.height,f=n.y+n.height,t.height>n.height?s=this.visibilityRatio*n.height:s=this.visibilityRatio*t.height,c=n.y-m+s,u=f-t.y-s,s>n.height?(t.y+=(c+u)/2,i=!0):u<0?(t.y+=u,i=!0):c>0&&(t.y+=c,i=!0)),h=o||i,a=h?this.viewerElementToViewportRectangle(t):e.clone(),a.xConstrained=o,a.yConstrained=i,a.constraintApplied=h,a},_raiseConstraintsEvent:function(e){this.viewer&&this.viewer.raiseEvent("constrain",{immediately:e})},applyConstraints:function(e){var t,n=this.getZoom(),s=this._applyZoomConstraints(n);return n!==s&&this.zoomTo(s,this.zoomPoint,e),t=this.getConstrainedBounds(!1),t.constraintApplied&&(this.fitBounds(t,e),this._raiseConstraintsEvent(e)),this},ensureVisible:function(e){return this.applyConstraints(e)},_fitBounds:function(t,n){n=n||{};var o,i,l,d,h,m,f,p,u=n.immediately||!1,c=n.constraints||!1,r=this.getAspectRatio(),a=t.getCenter(),s=new e.Rect(t.x,t.y,t.width,t.height,t.degrees+this.getRotation()).getBoundingBox();return s.getAspectRatio()>=r?s.height=s.width/r:s.width=s.height*r,s.x=a.x-s.width/2,s.y=a.y-s.height/2,o=1/s.width,u?(this.panTo(a,!0),this.zoomTo(o,null,!0),c&&this.applyConstraints(!0),this):(l=this.getCenter(!0),d=this.getZoom(!0),this.panTo(l,!0),this.zoomTo(d,null,!0),h=this.getBounds(),i=this.getZoom(),i===0||Math.abs(o/i-1)<1e-8?(this.zoomTo(o,null,!0),this.panTo(a,u),c&&this.applyConstraints(!1),this):(c?(this.panTo(a,!1),o=this._applyZoomConstraints(o),this.zoomTo(o,null,!1),m=this.getConstrainedBounds(),this.panTo(l,!0),this.zoomTo(d,null,!0),this.fitBounds(m)):(f=s.rotate(-this.getRotation()),p=f.getTopLeft().times(o).minus(h.getTopLeft().times(i)).divide(o-i),this.zoomTo(o,p,u)),this))},fitBounds:function(e,t){return this._fitBounds(e,{immediately:t,constraints:!1})},fitBoundsWithConstraints:function(e,t){return this._fitBounds(e,{immediately:t,constraints:!0})},fitVertically:function(t){var n=new e.Rect(this._contentBounds.x+this._contentBounds.width/2,this._contentBounds.y,0,this._contentBounds.height);return this.fitBounds(n,t)},fitHorizontally:function(t){var n=new e.Rect(this._contentBounds.x,this._contentBounds.y+this._contentBounds.height/2,this._contentBounds.width,0);return this.fitBounds(n,t)},getConstrainedBounds:function(e){var t=this.getBounds(e),n=this._applyBoundaryConstraints(t);return n},panBy:function(t,n){var s=new e.Point(this.centerSpringX.target.value,this.centerSpringY.target.value);return this.panTo(s.plus(t),n)},panTo:function(e,t){return t?(this.centerSpringX.resetTo(e.x),this.centerSpringY.resetTo(e.y)):(this.centerSpringX.springTo(e.x),this.centerSpringY.springTo(e.y)),this.viewer&&this.viewer.raiseEvent("pan",{center:e,immediately:t}),this},zoomBy:function(e,t,n){return this.zoomTo(this.zoomSpring.target.value*e,t,n)},zoomTo:function(t,n,s){var o=this;return this.zoomPoint=n instanceof e.Point&&!isNaN(n.x)&&!isNaN(n.y)?n:null,s?this._adjustCenterSpringsForZoomPoint(function(){o.zoomSpring.resetTo(t)}):this.zoomSpring.springTo(t),this.viewer&&this.viewer.raiseEvent("zoom",{zoom:t,refPoint:n,immediately:s}),this},setRotation:function(e,t){return this.rotateTo(e,null,t)},getRotation:function(e){return e?this.degreesSpring.current.value:this.degreesSpring.target.value},setRotationWithPivot:function(e,t,n){return this.rotateTo(e,t,n)},rotateTo:function(t,n,s){if(!this.viewer||!this.viewer.drawer.canRotate())return this;if(this.degreesSpring.target.value===t&&this.degreesSpring.isAtTargetValue())return this;if(this.rotationPivot=n instanceof e.Point&&!isNaN(n.x)&&!isNaN(n.y)?n:null,s)if(this.rotationPivot){var o,i,a,r,c=t-this._oldDegrees;if(!c)return this.rotationPivot=null,this;this._rotateAboutPivot(t)}else this.degreesSpring.resetTo(t);else i=e.positiveModulo(this.degreesSpring.current.value,360),o=e.positiveModulo(t,360),a=o-i,a>180?o-=360:a<-180&&(o+=360),r=i-o,this.degreesSpring.resetTo(t+r),this.degreesSpring.springTo(t);return this._setContentBounds(this.viewer.world.getHomeBounds(),this.viewer.world.getContentFactor()),this.viewer.forceRedraw(),this.viewer.raiseEvent("rotate",{degrees:t,immediately:!!s,pivot:this.rotationPivot||this.getCenter()}),this},rotateBy:function(e,t,n){return this.rotateTo(this.degreesSpring.target.value+e,t,n)},resize:function(e,t){var o,i,s=this.getBoundsNoRotate(),n=s;return this.containerSize.x=e.x,this.containerSize.y=e.y,this._updateContainerInnerSize(),t&&(o=e.x/this.containerSize.x,n.width=s.width*o,n.height=n.width/this.getAspectRatio()),this.viewer&&this.viewer.raiseEvent("resize",{newContainerSize:e,maintain:t}),i=this.fitBounds(n,!0),this.viewer&&this.viewer.raiseEvent("after-resize",{newContainerSize:e,maintain:t}),i},_updateContainerInnerSize:function(){this._containerInnerSize=new e.Point(Math.max(1,this.containerSize.x-(this._margins.left+this._margins.right)),Math.max(1,this.containerSize.y-(this._margins.top+this._margins.bottom)))},update:function(){var e,t,n=this;return this._adjustCenterSpringsForZoomPoint(function(){n.zoomSpring.update()}),this.degreesSpring.isAtTargetValue()&&(this.rotationPivot=null),this.centerSpringX.update(),this.centerSpringY.update(),this.rotationPivot?this._rotateAboutPivot(!0):this.degreesSpring.update(),e=this.centerSpringX.current.value!==this._oldCenterX||this.centerSpringY.current.value!==this._oldCenterY||this.zoomSpring.current.value!==this._oldZoom||this.degreesSpring.current.value!==this._oldDegrees,this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._oldDegrees=this.degreesSpring.current.value,t=e||!this.zoomSpring.isAtTargetValue()||!this.centerSpringX.isAtTargetValue()||!this.centerSpringY.isAtTargetValue()||!this.degreesSpring.isAtTargetValue(),t},_rotateAboutPivot:function(e){var n,s,o=e===!0,t=this.rotationPivot.minus(this.getCenter());this.centerSpringX.shiftBy(t.x),this.centerSpringY.shiftBy(t.y),o?this.degreesSpring.update():this.degreesSpring.resetTo(e),s=this.degreesSpring.current.value-this._oldDegrees,n=t.rotate(s*-1).times(-1),this.centerSpringX.shiftBy(n.x),this.centerSpringY.shiftBy(n.y)},_adjustCenterSpringsForZoomPoint:function(e){if(this.zoomPoint){var t,n,s,o=this.pixelFromPoint(this.zoomPoint,!0);e(),n=this.pixelFromPoint(this.zoomPoint,!0),s=n.minus(o),t=this.deltaPointsFromPixels(s,!0),this.centerSpringX.shiftBy(t.x),this.centerSpringY.shiftBy(t.y),this.zoomSpring.isAtTargetValue()&&(this.zoomPoint=null)}else e()},deltaPixelsFromPointsNoRotate:function(e,t){return e.times(this._containerInnerSize.x*this.getZoom(t))},deltaPixelsFromPoints:function(e,t){return this.deltaPixelsFromPointsNoRotate(e.rotate(this.getRotation(t)),t)},deltaPointsFromPixelsNoRotate:function(e,t){return e.divide(this._containerInnerSize.x*this.getZoom(t))},deltaPointsFromPixels:function(e,t){return this.deltaPointsFromPixelsNoRotate(e,t).rotate(-this.getRotation(t))},pixelFromPointNoRotate:function(e,t){return this._pixelFromPointNoRotate(e,this.getBoundsNoRotate(t))},pixelFromPoint:function(e,t){return this._pixelFromPoint(e,this.getBoundsNoRotate(t))},_pixelFromPointNoRotate:function(t,n){return t.minus(n.getTopLeft()).times(this._containerInnerSize.x/n.width).plus(new e.Point(this._margins.left,this._margins.top))},_pixelFromPoint:function(e,t){return this._pixelFromPointNoRotate(e.rotate(this.getRotation(!0),this.getCenter(!0)),t)},pointFromPixelNoRotate:function(t,n){var s=this.getBoundsNoRotate(n);return t.minus(new e.Point(this._margins.left,this._margins.top)).divide(this._containerInnerSize.x/s.width).plus(s.getTopLeft())},pointFromPixel:function(e,t){return this.pointFromPixelNoRotate(e,t).rotate(-this.getRotation(t),this.getCenter(t))},_viewportToImageDelta:function(t,n){var s=this._contentBoundsNoRotate.width;return new e.Point(t*this._contentSizeNoRotate.x/s,n*this._contentSizeNoRotate.x/s)},viewportToImageCoordinates:function(t,n){if(t instanceof e.Point)return this.viewportToImageCoordinates(t.x,t.y);if(this.viewer){var o,s=this.viewer.world.getItemCount();if(s>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageCoordinates] is not accurate with multi-image; use TiledImage.viewportToImageCoordinates instead.");else if(s===1)return o=this.viewer.world.getItemAt(0),o.viewportToImageCoordinates(t,n,!0)}return this._viewportToImageDelta(t-this._contentBoundsNoRotate.x,n-this._contentBoundsNoRotate.y)},_imageToViewportDelta:function(t,n){var s=this._contentBoundsNoRotate.width;return new e.Point(t/this._contentSizeNoRotate.x*s,n/this._contentSizeNoRotate.x*s)},imageToViewportCoordinates:function(t,n){if(t instanceof e.Point)return this.imageToViewportCoordinates(t.x,t.y);if(this.viewer){var s,i,o=this.viewer.world.getItemCount();if(o>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportCoordinates] is not accurate with multi-image; use TiledImage.imageToViewportCoordinates instead.");else if(o===1)return i=this.viewer.world.getItemAt(0),i.imageToViewportCoordinates(t,n,!0)}return s=this._imageToViewportDelta(t,n),s.x+=this._contentBoundsNoRotate.x,s.y+=this._contentBoundsNoRotate.y,s},imageToViewportRectangle:function(t,n,s,o){var a,r,c,l,i=t;if(i instanceof e.Rect||(i=new e.Rect(t,n,s,o)),this.viewer)if(a=this.viewer.world.getItemCount(),a>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportRectangle] is not accurate with multi-image; use TiledImage.imageToViewportRectangle instead.");else if(a===1)return l=this.viewer.world.getItemAt(0),l.imageToViewportRectangle(t,n,s,o,!0);return r=this.imageToViewportCoordinates(i.x,i.y),c=this._imageToViewportDelta(i.width,i.height),new e.Rect(r.x,r.y,c.x,c.y,i.degrees)},viewportToImageRectangle:function(t,n,s,o){var a,r,c,l,i=t;if(i instanceof e.Rect||(i=new e.Rect(t,n,s,o)),this.viewer)if(a=this.viewer.world.getItemCount(),a>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageRectangle] is not accurate with multi-image; use TiledImage.viewportToImageRectangle instead.");else if(a===1)return l=this.viewer.world.getItemAt(0),l.viewportToImageRectangle(t,n,s,o,!0);return r=this.viewportToImageCoordinates(i.x,i.y),c=this._viewportToImageDelta(i.width,i.height),new e.Rect(r.x,r.y,c.x,c.y,i.degrees)},viewerElementToImageCoordinates:function(e){var t=this.pointFromPixel(e,!0);return this.viewportToImageCoordinates(t)},imageToViewerElementCoordinates:function(e){var t=this.imageToViewportCoordinates(e);return this.pixelFromPoint(t,!0)},windowToImageCoordinates:function(t){e.console.assert(this.viewer,"[Viewport.windowToImageCoordinates] the viewport must have a viewer.");var n=t.minus(e.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(n)},imageToWindowCoordinates:function(t){e.console.assert(this.viewer,"[Viewport.imageToWindowCoordinates] the viewport must have a viewer.");var n=this.imageToViewerElementCoordinates(t);return n.plus(e.getElementPosition(this.viewer.element))},viewerElementToViewportCoordinates:function(e){return this.pointFromPixel(e,!0)},viewportToViewerElementCoordinates:function(e){return this.pixelFromPoint(e,!0)},viewerElementToViewportRectangle:function(t){return e.Rect.fromSummits(this.pointFromPixel(t.getTopLeft(),!0),this.pointFromPixel(t.getTopRight(),!0),this.pointFromPixel(t.getBottomLeft(),!0))},viewportToViewerElementRectangle:function(t){return e.Rect.fromSummits(this.pixelFromPoint(t.getTopLeft(),!0),this.pixelFromPoint(t.getTopRight(),!0),this.pixelFromPoint(t.getBottomLeft(),!0))},windowToViewportCoordinates:function(t){e.console.assert(this.viewer,"[Viewport.windowToViewportCoordinates] the viewport must have a viewer.");var n=t.minus(e.getElementPosition(this.viewer.element));return this.viewerElementToViewportCoordinates(n)},viewportToWindowCoordinates:function(t){e.console.assert(this.viewer,"[Viewport.viewportToWindowCoordinates] the viewport must have a viewer.");var n=this.viewportToViewerElementCoordinates(t);return n.plus(e.getElementPosition(this.viewer.element))},viewportToImageZoom:function(t){if(this.viewer){var s,o,i,a,r,n=this.viewer.world.getItemCount();if(n>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageZoom] is not accurate with multi-image.");else if(n===1)return s=this.viewer.world.getItemAt(0),s.viewportToImageZoom(t)}return o=this._contentSizeNoRotate.x,i=this._containerInnerSize.x,a=this._contentBoundsNoRotate.width,r=i/o*a,t*r},imageToViewportZoom:function(t){if(this.viewer){var s,o,i,a,r,n=this.viewer.world.getItemCount();if(n>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportZoom] is not accurate with multi-image. Instead, use [TiledImage.imageToViewportZoom] for the specific image of interest");else if(n===1)return s=this.viewer.world.getItemAt(0),s.imageToViewportZoom(t)}return o=this._contentSizeNoRotate.x,i=this._containerInnerSize.x,a=this._contentBoundsNoRotate.width,r=o/i/a,t*r},toggleFlip:function(){return this.setFlip(!this.getFlip()),this},getFlip:function(){return this.flipped},setFlip:function(e){return this.flipped===e?this:(this.flipped=e,this.viewer.navigator&&this.viewer.navigator.setFlip(this.getFlip()),this.viewer.forceRedraw(),this.viewer.raiseEvent("flip",{flipped:e}),this)},getMaxZoomPixelRatio:function(){return this.maxZoomPixelRatio},setMaxZoomPixelRatio:function(t,n=!0,s=!1){if(e.console.assert(!isNaN(t),"[Viewport.setMaxZoomPixelRatio] ratio must be a number"),isNaN(t))return;this.maxZoomPixelRatio=t,n&&this.getZoom()>this.getMaxZoom()&&this.applyConstraints(s)}}}(n),function(e){e.TiledImage=function(t){this._initialized=!1,e.console.assert(t.tileCache,"[TiledImage] options.tileCache is required"),e.console.assert(t.drawer,"[TiledImage] options.drawer is required"),e.console.assert(t.viewer,"[TiledImage] options.viewer is required"),e.console.assert(t.imageLoader,"[TiledImage] options.imageLoader is required"),e.console.assert(t.source,"[TiledImage] options.source is required"),e.console.assert(!t.clip||t.clip instanceof e.Rect,"[TiledImage] options.clip must be an OpenSeadragon.Rect if present"),e.EventSource.call(this),this._tileCache=t.tileCache,delete t.tileCache,this._drawer=t.drawer,delete t.drawer,this._imageLoader=t.imageLoader,delete t.imageLoader,t.clip instanceof e.Rect&&(this._clip=t.clip.clone()),delete t.clip;var s,o,i,a,r,c,l=t.x||0;delete t.x,i=t.y||0,delete t.y,this.normHeight=t.source.dimensions.y/t.source.dimensions.x,this.contentAspectX=t.source.dimensions.x/t.source.dimensions.y,s=1,t.width?(s=t.width,delete t.width,t.height&&(e.console.error("specifying both width and height to a tiledImage is not supported"),delete t.height)):t.height&&(s=t.height/this.normHeight,delete t.height),o=t.fitBounds,delete t.fitBounds,a=t.fitBoundsPlacement||n.Placement.CENTER,delete t.fitBoundsPlacement,r=t.degrees||0,delete t.degrees,c=t.ajaxHeaders,delete t.ajaxHeaders,e.extend(!0,this,{viewer:null,tilesMatrix:{},coverage:{},loadingCoverage:{},lastDrawn:[],lastResetTime:0,_needsDraw:!0,_needsUpdate:!0,_hasOpaqueTile:!1,_tilesLoading:0,_tilesToDraw:[],_lastDrawn:[],_isBlending:!1,_wasBlending:!1,_isTainted:!1,springStiffness:e.DEFAULT_SETTINGS.springStiffness,animationTime:e.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:e.DEFAULT_SETTINGS.minZoomImageRatio,wrapHorizontal:e.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:e.DEFAULT_SETTINGS.wrapVertical,immediateRender:e.DEFAULT_SETTINGS.immediateRender,blendTime:e.DEFAULT_SETTINGS.blendTime,alwaysBlend:e.DEFAULT_SETTINGS.alwaysBlend,minPixelRatio:e.DEFAULT_SETTINGS.minPixelRatio,smoothTileEdgesMinZoom:e.DEFAULT_SETTINGS.smoothTileEdgesMinZoom,iOSDevice:e.DEFAULT_SETTINGS.iOSDevice,debugMode:e.DEFAULT_SETTINGS.debugMode,crossOriginPolicy:e.DEFAULT_SETTINGS.crossOriginPolicy,ajaxWithCredentials:e.DEFAULT_SETTINGS.ajaxWithCredentials,placeholderFillStyle:e.DEFAULT_SETTINGS.placeholderFillStyle,opacity:e.DEFAULT_SETTINGS.opacity,preload:e.DEFAULT_SETTINGS.preload,compositeOperation:e.DEFAULT_SETTINGS.compositeOperation,subPixelRoundingForTransparency:e.DEFAULT_SETTINGS.subPixelRoundingForTransparency,maxTilesPerFrame:e.DEFAULT_SETTINGS.maxTilesPerFrame},t),this._preload=this.preload,delete this.preload,this._fullyLoaded=!1,this._xSpring=new e.Spring({initial:l,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._ySpring=new e.Spring({initial:i,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._scaleSpring=new e.Spring({initial:s,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._degreesSpring=new e.Spring({initial:r,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._updateForScale(),o&&this.fitBounds(o,a,!0),this._ownAjaxHeaders={},this.setAjaxHeaders(c,!1),this._initialized=!0},e.extend(e.TiledImage.prototype,e.EventSource.prototype,{needsDraw:function(){return this._needsDraw},redraw:function(){this._needsDraw=!0},getFullyLoaded:function(){return this._fullyLoaded},_setFullyLoaded:function(e){if(e===this._fullyLoaded)return;this._fullyLoaded=e,this.raiseEvent("fully-loaded-change",{fullyLoaded:this._fullyLoaded})},reset:function(){this._tileCache.clearTilesFor(this),this.lastResetTime=e.now(),this._needsDraw=!0},update:function(e){let n=this._xSpring.update(),s=this._ySpring.update(),o=this._scaleSpring.update(),i=this._degreesSpring.update(),t=n||s||o||i||this._needsUpdate;if(t||e||!this._fullyLoaded){let e=this._updateLevelsForViewport();this._setFullyLoaded(e)}return this._needsUpdate=!1,!!t&&(this._updateForScale(),this._raiseBoundsChange(),this._needsDraw=!0,!0)},setDrawn:function(){return this._needsDraw=this._isBlending||this._wasBlending,this._needsDraw},setTainted(e){this._isTainted=e},isTainted(){return this._isTainted},destroy:function(){this.reset(),this.source.destroy&&this.source.destroy(this.viewer)},getBounds:function(e){return this.getBoundsNoRotate(e).rotate(this.getRotation(e),this._getRotationPoint(e))},getBoundsNoRotate:function(t){return t?new e.Rect(this._xSpring.current.value,this._ySpring.current.value,this._worldWidthCurrent,this._worldHeightCurrent):new e.Rect(this._xSpring.target.value,this._ySpring.target.value,this._worldWidthTarget,this._worldHeightTarget)},getWorldBounds:function(){return e.console.error("[TiledImage.getWorldBounds] is deprecated; use TiledImage.getBounds instead"),this.getBounds()},getClippedBounds:function(t){var n,o,i,s=this.getBoundsNoRotate(t);return this._clip&&(o=t?this._worldWidthCurrent:this._worldWidthTarget,i=o/this.source.dimensions.x,n=this._clip.times(i),s=new e.Rect(s.x+n.x,s.y+n.y,n.width,n.height)),s.rotate(this.getRotation(t),this._getRotationPoint(t))},getTileBounds:function(e,t,n){var s=this.source.getNumTiles(e),i=(s.x+t%s.x)%s.x,a=(s.y+n%s.y)%s.y,o=this.source.getTileBounds(e,i,a);return this.getFlip()&&(o.x=Math.max(0,1-o.x-o.width)),o.x+=(t-i)/s.x,o.y+=this._worldHeightCurrent/this._worldWidthCurrent*((n-a)/s.y),o},getContentSize:function(){return new e.Point(this.source.dimensions.x,this.source.dimensions.y)},getSizeInWindowCoordinates:function(){var t=this.imageToWindowCoordinates(new e.Point(0,0)),n=this.imageToWindowCoordinates(this.getContentSize());return new e.Point(n.x-t.x,n.y-t.y)},_viewportToImageDelta:function(t,n,s){var o=s?this._scaleSpring.current.value:this._scaleSpring.target.value;return new e.Point(t*(this.source.dimensions.x/o),n*(this.source.dimensions.y*this.contentAspectX/o))},viewportToImageCoordinates:function(t,n,s){var o;return t instanceof e.Point?(s=n,o=t):o=new e.Point(t,n),o=o.rotate(-this.getRotation(s),this._getRotationPoint(s)),s?this._viewportToImageDelta(o.x-this._xSpring.current.value,o.y-this._ySpring.current.value):this._viewportToImageDelta(o.x-this._xSpring.target.value,o.y-this._ySpring.target.value)},_imageToViewportDelta:function(t,n,s){var o=s?this._scaleSpring.current.value:this._scaleSpring.target.value;return new e.Point(t/this.source.dimensions.x*o,n/this.source.dimensions.y/this.contentAspectX*o)},imageToViewportCoordinates:function(t,n,s){t instanceof e.Point&&(s=n,n=t.y,t=t.x);var o=this._imageToViewportDelta(t,n,s);return s?(o.x+=this._xSpring.current.value,o.y+=this._ySpring.current.value):(o.x+=this._xSpring.target.value,o.y+=this._ySpring.target.value),o.rotate(this.getRotation(s),this._getRotationPoint(s))},imageToViewportRectangle:function(t,n,s,o,i){var r,c,a=t;return a instanceof e.Rect?i=n:a=new e.Rect(t,n,s,o),r=this.imageToViewportCoordinates(a.getTopLeft(),i),c=this._imageToViewportDelta(a.width,a.height,i),new e.Rect(r.x,r.y,c.x,c.y,a.degrees+this.getRotation(i))},viewportToImageRectangle:function(t,n,s,o,i){var r,c,a=t;return t instanceof e.Rect?i=n:a=new e.Rect(t,n,s,o),r=this.viewportToImageCoordinates(a.getTopLeft(),i),c=this._viewportToImageDelta(a.width,a.height,i),new e.Rect(r.x,r.y,c.x,c.y,a.degrees-this.getRotation(i))},viewerElementToImageCoordinates:function(e){var t=this.viewport.pointFromPixel(e,!0);return this.viewportToImageCoordinates(t)},imageToViewerElementCoordinates:function(e){var t=this.imageToViewportCoordinates(e);return this.viewport.pixelFromPoint(t,!0)},windowToImageCoordinates:function(e){var t=e.minus(n.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(t)},imageToWindowCoordinates:function(e){var t=this.imageToViewerElementCoordinates(e);return t.plus(n.getElementPosition(this.viewer.element))},_viewportToTiledImageRectangle:function(t){var n=this._scaleSpring.current.value;return t=t.rotate(-this.getRotation(!0),this._getRotationPoint(!0)),new e.Rect((t.x-this._xSpring.current.value)/n,(t.y-this._ySpring.current.value)/n,t.width/n,t.height/n,t.degrees)},viewportToImageZoom:function(e){var t=this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x;return t*e},imageToViewportZoom:function(e){var t=this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x;return e/t},setPosition:function(e,t){var n=this._xSpring.target.value===e.x&&this._ySpring.target.value===e.y;if(t){if(n&&this._xSpring.current.value===e.x&&this._ySpring.current.value===e.y)return;this._xSpring.resetTo(e.x),this._ySpring.resetTo(e.y),this._needsDraw=!0,this._needsUpdate=!0}else{if(n)return;this._xSpring.springTo(e.x),this._ySpring.springTo(e.y),this._needsDraw=!0,this._needsUpdate=!0}n||this._raiseBoundsChange()},setWidth:function(e,t){this._setScale(e,t)},setHeight:function(e,t){this._setScale(e/this.normHeight,t)},setCroppingPolygons:function(t){var n=function(t){return t instanceof e.Point||typeof t.x=="number"&&typeof t.y=="number"},s=function(e){return e.map(function(e){try{if(n(e))return{x:e.x,y:e.y};throw new Error}catch{throw new Error("A Provided cropping polygon point is not supported")}})};try{if(!e.isArray(t))throw new Error("Provided cropping polygon is not an array");this._croppingPolygons=t.map(function(e){return s(e)}),this._needsDraw=!0}catch(t){e.console.error("[TiledImage.setCroppingPolygons] Cropping polygon format not supported"),e.console.error(t),this.resetCroppingPolygons()}},resetCroppingPolygons:function(){this._croppingPolygons=null,this._needsDraw=!0},fitBounds:function(t,n,s){n=n||e.Placement.CENTER;var c,l,h,m,i=e.Placement.properties[n],o=this.contentAspectX,a=0,r=0,d=1,u=1;this._clip&&(o=this._clip.getAspectRatio(),d=this._clip.width/this.source.dimensions.x,u=this._clip.height/this.source.dimensions.y,t.getAspectRatio()>o?(a=this._clip.x/this._clip.height*t.height,r=this._clip.y/this._clip.height*t.height):(a=this._clip.x/this._clip.width*t.width,r=this._clip.y/this._clip.width*t.width)),t.getAspectRatio()>o?(h=t.height/u,c=0,i.isHorizontallyCentered?c=(t.width-t.height*o)/2:i.isRight&&(c=t.width-t.height*o),this.setPosition(new e.Point(t.x-a+c,t.y-r),s),this.setHeight(h,s)):(m=t.width/d,l=0,i.isVerticallyCentered?l=(t.height-t.width/o)/2:i.isBottom&&(l=t.height-t.width/o),this.setPosition(new e.Point(t.x-a,t.y-r+l),s),this.setWidth(m,s))},getClip:function(){return this._clip?this._clip.clone():null},setClip:function(t){e.console.assert(!t||t instanceof e.Rect,"[TiledImage.setClip] newClip must be an OpenSeadragon.Rect or null"),t instanceof e.Rect?this._clip=t.clone():this._clip=null,this._needsUpdate=!0,this._needsDraw=!0,this.raiseEvent("clip-change")},getFlip:function(){return this.flipped},setFlip:function(e){this.flipped=e},get flipped(){return this._flipped},set flipped(e){let t=this._flipped!==!!e;this._flipped=!!e,t&&(this.update(!0),this._needsDraw=!0,this._raiseBoundsChange())},get wrapHorizontal(){return this._wrapHorizontal},set wrapHorizontal(e){let t=this._wrapHorizontal!==!!e;this._wrapHorizontal=!!e,this._initialized&&t&&(this.update(!0),this._needsDraw=!0)},get wrapVertical(){return this._wrapVertical},set wrapVertical(e){let t=this._wrapVertical!==!!e;this._wrapVertical=!!e,this._initialized&&t&&(this.update(!0),this._needsDraw=!0)},get debugMode(){return this._debugMode},set debugMode(e){this._debugMode=!!e,this._needsDraw=!0},getOpacity:function(){return this.opacity},setOpacity:function(e){this.opacity=e},get opacity(){return this._opacity},set opacity(e){if(e===this.opacity)return;this._opacity=e,this._needsDraw=!0,this.raiseEvent("opacity-change",{opacity:this.opacity})},getPreload:function(){return this._preload},setPreload:function(e){this._preload=!!e,this._needsDraw=!0},getRotation:function(e){return e?this._degreesSpring.current.value:this._degreesSpring.target.value},setRotation:function(e,t){if(this._degreesSpring.target.value===e&&this._degreesSpring.isAtTargetValue())return;t?this._degreesSpring.resetTo(e):this._degreesSpring.springTo(e),this._needsDraw=!0,this._needsUpdate=!0,this._raiseBoundsChange()},getDrawArea:function(){if(this._opacity===0&&!this._preload)return!1;var t,e=this._viewportToTiledImageRectangle(this.viewport.getBoundsWithMargins(!0));return!this.wrapHorizontal&&!this.wrapVertical&&(t=this._viewportToTiledImageRectangle(this.getClippedBounds(!0)),e=e.intersection(t)),e},getTilesToDraw:function(){let e=this._tilesToDraw.flat();return this._updateTilesInViewport(e),e=this._tilesToDraw.flat(),e.forEach(e=>{e.tile.beingDrawn=!0}),this._lastDrawn=e,e},_getRotationPoint:function(e){return this.getBoundsNoRotate(e).getCenter()},get compositeOperation(){return this._compositeOperation},set compositeOperation(e){if(e===this._compositeOperation)return;this._compositeOperation=e,this._needsDraw=!0,this.raiseEvent("composite-operation-change",{compositeOperation:this._compositeOperation})},getCompositeOperation:function(){return this._compositeOperation},setCompositeOperation:function(e){this.compositeOperation=e},setAjaxHeaders:function(t,n){if(t===null&&(t={}),!e.isPlainObject(t)){console.error("[TiledImage.setAjaxHeaders] Ignoring invalid headers, must be a plain object");return}this._ownAjaxHeaders=t,this._updateAjaxHeaders(n)},_updateAjaxHeaders:function(t){if(t===0[0]&&(t=!0),e.isPlainObject(this.viewer.ajaxHeaders)?this.ajaxHeaders=e.extend({},this.viewer.ajaxHeaders,this._ownAjaxHeaders):this.ajaxHeaders=this._ownAjaxHeaders,t){for(i in this.tilesMatrix){n=this.source.getNumTiles(i);for(r in this.tilesMatrix[i]){c=(n.x+r%n.x)%n.x;for(d in this.tilesMatrix[i][r])if(l=(n.y+d%n.y)%n.y,o=this.tilesMatrix[i][r][d],o.loadWithAjax=this.loadTilesWithAjax,o.loadWithAjax){var n,s,o,i,a,r,c,l,d,u=this.source.getTileAjaxHeaders(i,c,l);o.ajaxHeaders=e.extend({},this.ajaxHeaders,u)}else o.ajaxHeaders=null}}for(a=0;a<this._imageLoader.jobQueue.length;a++)s=this._imageLoader.jobQueue[a],s.loadWithAjax=s.tile.loadWithAjax,s.ajaxHeaders=s.tile.loadWithAjax?s.tile.ajaxHeaders:null}},_setScale:function(e,t){var n=this._scaleSpring.target.value===e;if(t){if(n&&this._scaleSpring.current.value===e)return;this._scaleSpring.resetTo(e),this._updateForScale(),this._needsDraw=!0,this._needsUpdate=!0}else{if(n)return;this._scaleSpring.springTo(e),this._updateForScale(),this._needsDraw=!0,this._needsUpdate=!0}n||this._raiseBoundsChange()},_updateForScale:function(){this._worldWidthTarget=this._scaleSpring.target.value,this._worldHeightTarget=this.normHeight*this._scaleSpring.target.value,this._worldWidthCurrent=this._scaleSpring.current.value,this._worldHeightCurrent=this.normHeight*this._scaleSpring.current.value},_raiseBoundsChange:function(){this.raiseEvent("bounds-change")},_isBottomItem:function(){return this.viewer.world.getItemAt(0)===this},_getLevelsInterval:function(){var t=Math.max(this.source.minLevel,Math.floor(Math.log(this.minZoomImageRatio)/Math.log(2))),n=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(0),!0).x*this._scaleSpring.current.value,e=Math.min(Math.abs(this.source.maxLevel),Math.abs(Math.floor(Math.log(n/this.minPixelRatio)/Math.log(2)))),e=Math.max(e,this.source.minLevel||0),t=Math.min(t,e);return{lowestLevel:t,highestLevel:e}},_updateLevelsForViewport:function(){var t,s,o,i,r,l,u,h,p,v,b,f=this._getLevelsInterval(),g=f.lowestLevel,a=f.highestLevel,n=[],d=this.getDrawArea(),c=e.now();if(this._lastDrawn.forEach(e=>{e.tile.beingDrawn=!1}),this._tilesToDraw=[],this._tilesLoading=0,this.loadingCoverage={},!d)return this._needsDraw=!1,this._fullyLoaded;t=new Array(a-g+1);for(let n=0,e=a;e>=g;e--,n++)t[n]=e;for(let e=a+1;e<=this.source.maxLevel;e++)if(s=this.tilesMatrix[e]&&this.tilesMatrix[e][0]&&this.tilesMatrix[e][0][0],s&&s.isBottomMost&&s.isRightMost&&s.loaded){t.push(e);break}let m=!1;for(let s=0;s<t.length;s++){let e=t[s];if(o=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(e),!0).x*this._scaleSpring.current.value,s===t.length-1||o>=this.minPixelRatio)m=!0;else if(!m)continue;if(u=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(e),!1).x*this._scaleSpring.current.value,h=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(Math.max(this.source.getClosestLevel(),0)),!1).x*this._scaleSpring.current.value,l=this.immediateRender?1:h,r=Math.min(1,(o-.5)/.5),p=l/Math.abs(l-u),i=this._updateLevel(e,r,p,d,c,n),n=i.bestTiles,v=i.updatedTiles.filter(e=>e.loaded),b=function(e,t,n){return function(s){return{tile:s,level:e,levelOpacity:t,currentTime:n}}}(e,r,c),this._tilesToDraw[e]=v.map(b),this._providesCoverage(this.coverage,e))break}return n&&n.length>0?(n.forEach(function(e){e&&!e.context2D&&this._loadTile(e,c)},this),this._needsDraw=!0,!1):this._tilesLoading===0},_updateTilesInViewport:function(t){let o=e.now(),n=this;this._tilesLoading=0,this._wasBlending=this._isBlending,this._isBlending=!1,this.loadingCoverage={};let i=t.length?t[0].level:0,a=this.getDrawArea();if(!a)return;function r(e){let t=e.tile;if(t&&t.loaded){let s=n._blendTile(t,t.x,t.y,e.level,e.levelOpacity,o,i);n._isBlending=n._isBlending||s,n._needsDraw=n._needsDraw||s||n._wasBlending}}let s=0;for(let e=0;e<t.length;e++){let n=t[e];r(n),this._providesCoverage(this.coverage,n.level)&&(s=Math.max(s,n.level))}if(s>0)for(let e in this._tilesToDraw)e<s&&delete this._tilesToDraw[e]},_blendTile:function(e,t,n,s,o,i,a){let c=1e3*this.blendTime,l,r;return e.blendStart||(e.blendStart=i),l=i-e.blendStart,r=c?Math.min(1,l/c):1,s===a&&(r=1,l=c),this.alwaysBlend&&(r*=o),e.opacity=r,r===1&&(this._setCoverage(this.coverage,s,t,n,!0),this._hasOpaqueTile=!0),l<c},_updateLevel:function(e,t,n,s,o,i){var a,r,c,l,d,u,h,m,f,p,g,v,j,b=s.getBoundingBox().getTopLeft(),y=s.getBoundingBox().getBottomRight();this.viewer&&this.viewer.raiseEvent("update-level",{tiledImage:this,havedrawn:!0,level:e,opacity:t,visibility:n,drawArea:s,topleft:b,bottomright:y,currenttime:o,best:i}),this._resetCoverage(this.coverage,e),this._resetCoverage(this.loadingCoverage,e),f=this._getCornerTiles(e,b,y),d=f.topLeft,a=f.bottomRight,r=this.source.getNumTiles(e),j=this.viewport.pixelFromPoint(this.viewport.getCenter()),this.getFlip()&&(a.x+=1,this.wrapHorizontal||(a.x=Math.min(a.x,r.x-1)));for(v=Math.max(0,(a.x-d.x)*(a.y-d.y)),m=new Array(v),h=0,c=d.x;c<=a.x;c++)for(l=d.y;l<=a.y;l++){if(this.getFlip()?(p=(r.x+c%r.x)%r.x,u=c+r.x-p-p-1):u=c,s.intersection(this.getTileBounds(e,u,l))===null)continue;g=this._updateTile(u,l,e,n,j,r,o,i),i=g.bestTiles,m[h]=g.tile,h+=1}return{bestTiles:i,updatedTiles:m}},_positionTile:function(t,n,s,o,i){a=t.bounds.getTopLeft(),a.x*=this._scaleSpring.current.value,a.y*=this._scaleSpring.current.value,a.x+=this._xSpring.current.value,a.y+=this._ySpring.current.value,r=t.bounds.getSize(),r.x*=this._scaleSpring.current.value,r.y*=this._scaleSpring.current.value,t.positionedBounds.x=a.x,t.positionedBounds.y=a.y,t.positionedBounds.width=r.x,t.positionedBounds.height=r.y;var a,r,l=s.pixelFromPointNoRotate(a,!0),d=s.pixelFromPointNoRotate(a,!1),c=s.deltaPixelsFromPointsNoRotate(r,!0),u=s.deltaPixelsFromPointsNoRotate(r,!1),h=d.plus(u.divide(2)),m=o.squaredDistanceTo(h);this.viewer.drawer.minimumOverlapRequired(this)&&(n||(c=c.plus(new e.Point(1,1))),t.isRightMost&&this.wrapHorizontal&&(c.x+=.75),t.isBottomMost&&this.wrapVertical&&(c.y+=.75)),t.position=l,t.size=c,t.squaredDistance=m,t.visibility=i},_updateTile:function(e,t,n,s,o,i,a,r){var l,d,c=this._getTile(e,t,n,a,i);return this.viewer&&this.viewer.raiseEvent("update-tile",{tiledImage:this,tile:c}),this._setCoverage(this.coverage,n,e,t,!1),l=c.loaded||c.loading||this._isCovered(this.loadingCoverage,n,e,t),this._setCoverage(this.loadingCoverage,n,e,t,l),c.exists?(c.loaded&&c.opacity===1&&this._setCoverage(this.coverage,n,e,t,!0),this._positionTile(c,this.source.tileOverlap,this.viewport,o,s),c.loaded||(c.context2D?this._setTileLoaded(c):(d=this._tileCache.getImageRecord(c.cacheKey),d&&this._setTileLoaded(c,d.getData()))),c.loading?this._tilesLoading++:l||(r=this._compareTiles(r,c,this.maxTilesPerFrame)),{bestTiles:r,tile:c}):{bestTiles:r,tile:c}},_getCornerTiles:function(t,n,s){this.wrapHorizontal?(c=e.positiveModulo(n.x,1),l=e.positiveModulo(s.x,1)):(c=Math.max(0,n.x),l=Math.min(1,s.x));var i,a,r,c,l,d,u,o=1/this.source.aspectRatio;return this.wrapVertical?(d=e.positiveModulo(n.y,o),u=e.positiveModulo(s.y,o)):(d=Math.max(0,n.y),u=Math.min(o,s.y)),a=this.source.getTileAtPoint(t,new e.Point(c,d)),r=this.source.getTileAtPoint(t,new e.Point(l,u)),i=this.source.getNumTiles(t),this.wrapHorizontal&&(a.x+=i.x*Math.floor(n.x),r.x+=i.x*Math.floor(s.x)),this.wrapVertical&&(a.y+=i.y*Math.floor(n.y/o),r.y+=i.y*Math.floor(s.y/o)),{topLeft:a,bottomRight:r}},_getTile:function(t,n,s,o,i){var a,r,c,u,h,m,f,p,g,v,l=this.tilesMatrix,d=this.source;return l[s]||(l[s]={}),l[s][t]||(l[s][t]={}),(!l[s][t][n]||!l[s][t][n].flipped!==!this.flipped)&&(a=(i.x+t%i.x)%i.x,r=(i.y+n%i.y)%i.y,f=this.getTileBounds(s,t,n),p=d.getTileBounds(s,a,r,!0),g=d.tileExists(s,a,r),h=d.getTileUrl(s,a,r),m=d.getTilePostData(s,a,r),this.loadTilesWithAjax?(u=d.getTileAjaxHeaders(s,a,r),e.isPlainObject(this.ajaxHeaders)&&(u=e.extend({},this.ajaxHeaders,u))):u=null,v=d.getContext2D?d.getContext2D(s,a,r):0[0],c=new e.Tile(s,t,n,f,g,h,v,this.loadTilesWithAjax,u,p,m,d.getTileHashKey(s,a,r,h,u,m)),this.getFlip()?a===0&&(c.isRightMost=!0):a===i.x-1&&(c.isRightMost=!0),r===i.y-1&&(c.isBottomMost=!0),c.flipped=this.flipped,l[s][t][n]=c),c=l[s][t][n],c.lastTouchTime=o,c},_loadTile:function(e,t){var n=this;e.loading=!0,this._imageLoader.addJob({src:e.getUrl(),tile:e,source:this.source,postData:e.postData,loadWithAjax:e.loadWithAjax,ajaxHeaders:e.ajaxHeaders,crossOriginPolicy:this.crossOriginPolicy,ajaxWithCredentials:this.ajaxWithCredentials,callback:function(s,o,i){n._onTileLoad(e,t,s,o,i)},abort:function(){e.loading=!1}})},_onTileLoad:function(t,n,s,o,i){if(!s){e.console.error("Tile %s failed to load: %s - error: %s",t,t.getUrl(),o),this.viewer.raiseEvent("tile-load-failed",{tile:t,tiledImage:this,time:n,message:o,tileRequest:i}),t.loading=!1,t.exists=!1;return}if(t.exists=!0,n<this.lastResetTime){e.console.warn("Ignoring tile %s loaded before reset: %s",t,t.getUrl()),t.loading=!1;return}var a=this,r=function(){var e=a.source,n=e.getClosestLevel();a._setTileLoaded(t,s,n,i)};r()},_setTileLoaded:function(t,n,s,o){var l,a=0,r=!1,i=this;function c(){return r&&e.console.error("Event 'tile-loaded' argument getCompletionCallback must be called synchronously. Its return value should be called asynchronously."),a++,d}function d(){a--,a===0&&(t.loading=!1,t.loaded=!0,t.hasTransparency=i.source.hasTransparency(t.context2D,t.getUrl(),t.ajaxHeaders,t.postData),t.context2D||i._tileCache.cacheTile({data:n,tile:t,cutoff:s,tiledImage:i}),i.viewer.raiseEvent("tile-ready",{tile:t,tiledImage:i,tileRequest:o}),i._needsDraw=!0)}l=c(),this.viewer.raiseEvent("tile-loaded",{tile:t,tiledImage:this,tileRequest:o,get image(){return e.console.error("[tile-loaded] event 'image' has been deprecated. Use 'data' property instead."),n},data:n,getCompletionCallback:c}),r=!0,l()},_compareTiles:function(e,t,n){return e?(e.push(t),this._sortTiles(e),e.length>n&&e.pop(),e):[t]},_sortTiles:function(e){e.sort(function(e,t){return e===null?1:t===null?-1:e.visibility===t.visibility?e.squaredDistance-t.squaredDistance:t.visibility-e.visibility})},_providesCoverage:function(e,t,n,s){var o,i,a,r;if(!e[t])return!1;if(n===0[0]||s===0[0]){o=e[t];for(a in o)if(Object.prototype.hasOwnProperty.call(o,a)){i=o[a];for(r in i)if(Object.prototype.hasOwnProperty.call(i,r)&&!i[r])return!1}return!0}return e[t][n]===0[0]||e[t][n][s]===0[0]||e[t][n][s]===!0},_isCovered:function(e,t,n,s){return n===0[0]||s===0[0]?this._providesCoverage(e,t+1):this._providesCoverage(e,t+1,2*n,2*s)&&this._providesCoverage(e,t+1,2*n,2*s+1)&&this._providesCoverage(e,t+1,2*n+1,2*s)&&this._providesCoverage(e,t+1,2*n+1,2*s+1)},_setCoverage:function(t,n,s,o,i){if(!t[n]){e.console.warn("Setting coverage for a tile before its level's coverage has been reset: %s",n);return}t[n][s]||(t[n][s]={}),t[n][s][o]=i},_resetCoverage:function(e,t){e[t]={}}})}(n),function(e){var n=function(t){e.console.assert(t,"[TileCache.cacheTile] options is required"),e.console.assert(t.tile,"[TileCache.cacheTile] options.tile is required"),e.console.assert(t.tiledImage,"[TileCache.cacheTile] options.tiledImage is required"),this.tile=t.tile,this.tiledImage=t.tiledImage},t=function(t){e.console.assert(t,"[ImageRecord] options is required"),e.console.assert(t.data,"[ImageRecord] options.data is required"),this._tiles=[],t.create.apply(null,[this,t.data,t.ownerTile]),this._destroyImplementation=t.destroy.bind(null,this),this.getImage=t.getImage.bind(null,this),this.getData=t.getData.bind(null,this),this.getRenderedContext=t.getRenderedContext.bind(null,this)};t.prototype={destroy:function(){this._destroyImplementation(),this._tiles=null},addTile:function(t){e.console.assert(t,"[ImageRecord.addTile] tile is required"),this._tiles.push(t)},removeTile:function(t){for(var n=0;n<this._tiles.length;n++)if(this._tiles[n]===t){this._tiles.splice(n,1);return}e.console.warn("[ImageRecord.removeTile] trying to remove unknown tile",t)},getTileCount:function(){return this._tiles.length}},e.TileCache=function(t){t=t||{},this._maxImageCacheCount=t.maxImageCacheCount||e.DEFAULT_SETTINGS.maxImageCacheCount,this._tilesLoaded=[],this._imagesLoaded=[],this._imagesLoadedCount=0},e.TileCache.prototype={numTilesLoaded:function(){return this._tilesLoaded.length},cacheTile:function(s){e.console.assert(s,"[TileCache.cacheTile] options is required"),e.console.assert(s.tile,"[TileCache.cacheTile] options.tile is required"),e.console.assert(s.tile.cacheKey,"[TileCache.cacheTile] options.tile.cacheKey is required"),e.console.assert(s.tiledImage,"[TileCache.cacheTile] options.tiledImage is required");var o,i,a,r,l,d,u,h,f,p,g=s.cutoff||0,m=this._tilesLoaded.length,c=this._imagesLoaded[s.tile.cacheKey];if(c||(s.data||(e.console.error("[TileCache.cacheTile] options.image was renamed to options.data. '.image' attribute has been deprecated and will be removed in the future."),s.data=s.image),e.console.assert(s.data,"[TileCache.cacheTile] options.data is required to create an ImageRecord"),c=this._imagesLoaded[s.tile.cacheKey]=new t({data:s.data,ownerTile:s.tile,create:s.tiledImage.source.createTileCache,destroy:s.tiledImage.source.destroyTileCache,getImage:s.tiledImage.source.getTileCacheDataAsImage,getData:s.tiledImage.source.getTileCacheData,getRenderedContext:s.tiledImage.source.getTileCacheDataAsContext2D}),this._imagesLoadedCount++),c.addTile(s.tile),s.tile.cacheImageRecord=c,this._imagesLoadedCount>this._maxImageCacheCount){for(i=null,r=-1,l=null,a=this._tilesLoaded.length-1;a>=0;a--){if(d=this._tilesLoaded[a],o=d.tile,o.level<=g||o.beingDrawn)continue;if(!i){i=o,r=a,l=d;continue}h=o.lastTouchTime,u=i.lastTouchTime,p=o.level,f=i.level,(h<u||h===u&&p>f)&&(i=o,r=a,l=d)}i&&r>=0&&(this._unloadTile(l),m=r)}this._tilesLoaded[m]=new n({tile:s.tile,tiledImage:s.tiledImage})},clearTilesFor:function(t){e.console.assert(t,"[TileCache.clearTilesFor] tiledImage is required");for(var s,n=0;n<this._tilesLoaded.length;++n)s=this._tilesLoaded[n],s.tiledImage===t&&(this._unloadTile(s),this._tilesLoaded.splice(n,1),n--)},getImageRecord:function(t){return e.console.assert(t,"[TileCache.getImageRecord] cacheKey is required"),this._imagesLoaded[t]},_unloadTile:function(t){e.console.assert(t,"[TileCache._unloadTile] tileRecord is required");var s,n=t.tile,i=t.tiledImage;let o=n.getCanvasContext&&n.getCanvasContext();if(n.unload(),n.cacheImageRecord=null,s=this._imagesLoaded[n.cacheKey],!s)return;s.removeTile(n),s.getTileCount()||(s.destroy(),delete this._imagesLoaded[n.cacheKey],this._imagesLoadedCount--,o&&(o.canvas.width=0,o.canvas.height=0,i.viewer.raiseEvent("image-unloaded",{context2D:o,tile:n}))),i.viewer.raiseEvent("tile-unloaded",{tile:n,tiledImage:i})}}}(n),function(e){e.World=function(t){var n=this;e.console.assert(t.viewer,"[World] options.viewer is required"),e.EventSource.call(this),this.viewer=t.viewer,this._items=[],this._needsDraw=!1,this._autoRefigureSizes=!0,this._needsSizesFigured=!1,this._delegatedFigureSizes=function(){n._autoRefigureSizes?n._figureSizes():n._needsSizesFigured=!0},this._figureSizes()},e.extend(e.World.prototype,e.EventSource.prototype,{addItem:function(t,n){if(e.console.assert(t,"[World.addItem] item is required"),e.console.assert(t instanceof e.TiledImage,"[World.addItem] only TiledImages supported at this time"),n=n||{},n.index!==0[0]){var s=Math.max(0,Math.min(this._items.length,n.index));this._items.splice(s,0,t)}else this._items.push(t);this._autoRefigureSizes?this._figureSizes():this._needsSizesFigured=!0,this._needsDraw=!0,t.addHandler("bounds-change",this._delegatedFigureSizes),t.addHandler("clip-change",this._delegatedFigureSizes),this.raiseEvent("add-item",{item:t})},getItemAt:function(t){return e.console.assert(t!==0[0],"[World.getItemAt] index is required"),this._items[t]},getIndexOfItem:function(t){return e.console.assert(t,"[World.getIndexOfItem] item is required"),e.indexOf(this._items,t)},getItemCount:function(){return this._items.length},setItemIndex:function(t,n){e.console.assert(t,"[World.setItemIndex] item is required"),e.console.assert(n!==0[0],"[World.setItemIndex] index is required");var s=this.getIndexOfItem(t);if(n>=this._items.length)throw new Error("Index bigger than number of layers.");if(n===s||s===-1)return;this._items.splice(s,1),this._items.splice(n,0,t),this._needsDraw=!0,this.raiseEvent("item-index-change",{item:t,previousIndex:s,newIndex:n})},removeItem:function(t){e.console.assert(t,"[World.removeItem] item is required");var n=e.indexOf(this._items,t);if(n===-1)return;t.removeHandler("bounds-change",this._delegatedFigureSizes),t.removeHandler("clip-change",this._delegatedFigureSizes),t.destroy(),this._items.splice(n,1),this._figureSizes(),this._needsDraw=!0,this._raiseRemoveItem(t)},removeAll:function(){this.viewer._cancelPendingImages();for(e=0;e<this._items.length;e++)t=this._items[e],t.removeHandler("bounds-change",this._delegatedFigureSizes),t.removeHandler("clip-change",this._delegatedFigureSizes),t.destroy();var e,t,n=this._items;this._items=[],this._figureSizes(),this._needsDraw=!0;for(e=0;e<n.length;e++)t=n[e],this._raiseRemoveItem(t)},resetItems:function(){for(var e=0;e<this._items.length;e++)this._items[e].reset()},update:function(e){for(var t=!1,n=0;n<this._items.length;n++)t=this._items[n].update(e)||t;return t},draw:function(){this.viewer.drawer.draw(this._items),this._needsDraw=!1,this._items.forEach(e=>{this._needsDraw=e.setDrawn()||this._needsDraw})},needsDraw:function(){for(var e=0;e<this._items.length;e++)if(this._items[e].needsDraw())return!0;return this._needsDraw},getHomeBounds:function(){return this._homeBounds.clone()},getContentFactor:function(){return this._contentFactor},setAutoRefigureSizes:function(e){this._autoRefigureSizes=e,e&this._needsSizesFigured&&(this._figureSizes(),this._needsSizesFigured=!1)},arrange:function(t){t=t||{};var n,s,o,i,r,l,d,m,f,u=t.immediately||!1,p=t.layout||e.DEFAULT_SETTINGS.collectionLayout,v=t.rows||e.DEFAULT_SETTINGS.collectionRows,h=t.columns||e.DEFAULT_SETTINGS.collectionColumns,a=t.tileSize||e.DEFAULT_SETTINGS.collectionTileSize,g=t.tileMargin||e.DEFAULT_SETTINGS.collectionTileMargin,c=a+g;!t.rows&&h?d=h:d=Math.ceil(this._items.length/v),o=0,r=0,this.setAutoRefigureSizes(!1);for(s=0;s<this._items.length;s++)s&&s%d===0&&(p==="horizontal"?(r+=c,o=0):(o+=c,r=0)),l=this._items[s],n=l.getBounds(),n.width>n.height?i=a:i=a*(n.width/n.height),m=i*(n.height/n.width),f=new e.Point(o+(a-i)/2,r+(a-m)/2),l.setPosition(f,u),l.setWidth(i,u),p==="horizontal"?o+=c:r+=c;this.setAutoRefigureSizes(!0)},_figureSizes:function(){var t,n,s,o,i,a,r,c,l=this._homeBounds?this._homeBounds.clone():null,d=this._contentSize?this._contentSize.clone():null,u=this._contentFactor||0;if(this._items.length){n=this._items[0],i=n.getBounds(),this._contentFactor=n.getContentSize().x/i.width;for(t=n.getClippedBounds().getBoundingBox(),s=t.x,o=t.y,a=t.x+t.width,r=t.y+t.height,c=1;c<this._items.length;c++)n=this._items[c],i=n.getBounds(),this._contentFactor=Math.max(this._contentFactor,n.getContentSize().x/i.width),t=n.getClippedBounds().getBoundingBox(),s=Math.min(s,t.x),o=Math.min(o,t.y),a=Math.max(a,t.x+t.width),r=Math.max(r,t.y+t.height);this._homeBounds=new e.Rect(s,o,a-s,r-o),this._contentSize=new e.Point(this._homeBounds.width*this._contentFactor,this._homeBounds.height*this._contentFactor)}else this._homeBounds=new e.Rect(0,0,1,1),this._contentSize=new e.Point(1,1),this._contentFactor=1;(this._contentFactor!==u||!this._homeBounds.equals(l)||!this._contentSize.equals(d))&&this.raiseEvent("metrics-change",{})},_raiseRemoveItem:function(e){this.raiseEvent("remove-item",{item:e})}})}(n)}}),gc=Is({"node_modules/fabric/dist/index.min.js"(e,t){!function(n,s){"object"==typeof e&&"undefined"!=typeof t?s(e):"function"==typeof define&&define.amd?define(["exports"],s):s((n="undefined"!=typeof globalThis?globalThis:n||self).fabric={})}(e,function(e){"use strict";function t(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n,s=e[Symbol.toPrimitive];if(0[0]!==s){if(n=s.call(e,t||"default"),"object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Vs(e,t){var n,s=Object.keys(e);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(e),t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),s.push.apply(s,n)),s}function n(e){for(var n,s=1;s<arguments.length;s++)n=null!=arguments[s]?arguments[s]:{},s%2?Vs(Object(n),!0).forEach(function(s){t(e,s,n[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Vs(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))});return e}function d(e,t){if(e==null)return{};var n,s,o,i=function(e,t){if(e==null)return{};var n,s={};for(n in e)if({}.hasOwnProperty.call(e,n)){if(t.indexOf(n)>=0)continue;s[n]=e[n]}return s}(e,t);if(Object.getOwnPropertySymbols){o=Object.getOwnPropertySymbols(e);for(s=0;s<o.length;s++)n=o[s],t.indexOf(n)>=0||{}.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}function ne(e,t){return t||(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}class Ws{constructor(){t(this,"browserShadowBlurConstant",1),t(this,"DPI",96),t(this,"devicePixelRatio","undefined"!=typeof window?window.devicePixelRatio:1),t(this,"perfLimitSizeTotal",2097152),t(this,"maxCacheSideLimit",4096),t(this,"minCacheSideLimit",256),t(this,"disableStyleCopyPaste",!1),t(this,"enableGLFiltering",!0),t(this,"textureSize",4096),t(this,"forceGLPutImageData",!1),t(this,"cachesBoundsOfCurve",!1),t(this,"fontPaths",{}),t(this,"NUM_FRACTION_DIGITS",4)}}const a=new class extends Ws{constructor(e){super(),this.configure(e)}configure(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};Object.assign(this,e)}addFonts(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};this.fontPaths=n(n({},this.fontPaths),e)}removeFonts(){(arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[]).forEach(e=>{delete this.fontPaths[e]})}clearFonts(){this.fontPaths={}}restoreDefaults(e){const t=new Ws,n=e?.reduce((e,n)=>(e[n]=t[n],e),{})||t;this.configure(n)}},ie=function(e){for(var n=arguments.length,s=new Array(n>1?n-1:0),t=1;t<n;t++)s[t-1]=arguments[t];return console[e]("fabric",...s)};class G extends Error{constructor(e,t){super("fabric: ".concat(e),t)}}class ks extends G{constructor(e){super("".concat(e," 'options.signal' is in 'aborted' state"))}}class mc{}class hc extends mc{testPrecision(e,t){const s="precision ".concat(t,` float;
void main(){}`),n=e.createShader(e.FRAGMENT_SHADER);return!!n&&(e.shaderSource(n,s),e.compileShader(n),!!e.getShaderParameter(n,e.COMPILE_STATUS))}queryWebGL(e){const t=e.getContext("webgl");t&&(this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.GLPrecision=["highp","mediump","lowp"].find(e=>this.testPrecision(t,e)),t.getExtension("WEBGL_lose_context").loseContext(),ie("log","WebGL: max texture size ".concat(this.maxTextureSize)))}isSupported(e){return!!this.maxTextureSize&&this.maxTextureSize>=e}}const uc={};let Es;const W=()=>Es||(Es={document,window,isTouchSupported:"ontouchstart"in window||"ontouchstart"in document||window&&window.navigator&&window.navigator.maxTouchPoints>0,WebGLProbe:new hc,dispose(){},copyPasteData:uc}),we=()=>W().document,$=()=>W().window,Ks=()=>{var e;return Math.max(null!==(e=a.devicePixelRatio)&&0[0]!==e?e:$().devicePixelRatio,1)},Be=new class{constructor(){t(this,"charWidthsCache",{}),t(this,"boundsOfCurveCache",{})}getFontCache(e){let{fontFamily:t,fontStyle:o,fontWeight:i}=e;t=t.toLowerCase(),this.charWidthsCache[t]||(this.charWidthsCache[t]={});const n=this.charWidthsCache[t],s="".concat(o.toLowerCase(),"_").concat((i+"").toLowerCase());return n[s]||(n[s]={}),n[s]}clearFontCache(e){(e=(e||"").toLowerCase())?this.charWidthsCache[e]&&delete this.charWidthsCache[e]:this.charWidthsCache={}}limitDimsByArea(e){const{perfLimitSizeTotal:t}=a,n=Math.sqrt(t*e);return[Math.floor(n),Math.floor(t/n)]}},Ht="6.7.1";function be(){}const ge=Math.PI/2,le=2*Math.PI,Os=Math.PI/180,_=Object.freeze([1,0,0,1,0,0]),ws=16,me=.4477152502,i="center",c="left",A="top",_s="bottom",f="right",x="none",bs=/\r?\n/,qs="moving",Kt="scaling",Zs="rotating",hs="rotate",eo="skewing",dt="resizing",to="modifyPoly",nc="modifyPath",Xt="changed",Qt="scale",O="scaleX",z="scaleY",Ie="skewX",He="skewY",v="fill",C="stroke",Zt="modified",Re="json",is="svg",o=new class{constructor(){this[Re]=new Map,this[is]=new Map}has(e){return this[Re].has(e)}getClass(e){const t=this[Re].get(e);if(!t)throw new G("No class registered for ".concat(e));return t}setClass(e,t){t?this[Re].set(t,e):(this[Re].set(e.type,e),this[Re].set(e.type.toLowerCase(),e))}getSVGClass(e){return this[is].get(e)}setSVGClass(e,t){this[is].set(t??e.type.toLowerCase(),e)}},Ot=new class extends Array{remove(e){const t=this.indexOf(e);t>-1&&this.splice(t,1)}cancelAll(){const e=this.splice(0);return e.forEach(e=>e.abort()),e}cancelByCanvas(e){if(!e)return[];const t=this.filter(t=>{var n;return t.target===e||"object"==typeof t.target&&(null===(n=t.target)||0[0]===n?0[0]:n.canvas)===e});return t.forEach(e=>e.abort()),t}cancelByTarget(e){if(!e)return[];const t=this.filter(t=>t.target===e);return t.forEach(e=>e.abort()),t}};class so{constructor(){t(this,"__eventListeners",{})}on(e,t){if(this.__eventListeners||(this.__eventListeners={}),"object"==typeof e)return Object.entries(e).forEach(e=>{let[t,n]=e;this.on(t,n)}),()=>this.off(e);if(t){const n=e;return this.__eventListeners[n]||(this.__eventListeners[n]=[]),this.__eventListeners[n].push(t),()=>this.off(n,t)}return()=>!1}once(e,t){if("object"==typeof e){const t=[];return Object.entries(e).forEach(e=>{let[n,s]=e;t.push(this.once(n,s))}),()=>t.forEach(e=>e())}if(t){const n=this.on(e,function(){for(var s=arguments.length,o=new Array(s),e=0;e<s;e++)o[e]=arguments[e];t.call(this,...o),n()});return n}return()=>!1}_removeEventListener(e,t){if(this.__eventListeners[e])if(t){const n=this.__eventListeners[e],s=n.indexOf(t);s>-1&&n.splice(s,1)}else this.__eventListeners[e]=[]}off(e,t){if(this.__eventListeners)if(0[0]===e)for(const e in this.__eventListeners)this._removeEventListener(e);else"object"==typeof e?Object.entries(e).forEach(e=>{let[t,n]=e;this._removeEventListener(t,n)}):this._removeEventListener(e,t)}fire(e,t){var n;if(!this.__eventListeners)return;const s=null===(n=this.__eventListeners[e])||0[0]===n?0[0]:n.concat();if(s)for(let e=0;e<s.length;e++)s[e].call(this,t||{})}}const Ee=(e,t)=>{const n=e.indexOf(t);return-1!==n&&e.splice(n,1),e},I=e=>{if(0===e)return 1;switch((e<0?-e:e)/ge){case 1:case 3:return 0;case 2:return-1}return Math.cos(e)},V=e=>{if(0===e)return 0;const n=e/ge,t=Math.sign(e);switch(n){case 1:return t;case 2:return 0;case 3:return-t}return Math.sin(e)};class s{constructor(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:0,t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:0;"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e,this.y=t)}add(e){return new s(this.x+e.x,this.y+e.y)}addEquals(e){return this.x+=e.x,this.y+=e.y,this}scalarAdd(e){return new s(this.x+e,this.y+e)}scalarAddEquals(e){return this.x+=e,this.y+=e,this}subtract(e){return new s(this.x-e.x,this.y-e.y)}subtractEquals(e){return this.x-=e.x,this.y-=e.y,this}scalarSubtract(e){return new s(this.x-e,this.y-e)}scalarSubtractEquals(e){return this.x-=e,this.y-=e,this}multiply(e){return new s(this.x*e.x,this.y*e.y)}scalarMultiply(e){return new s(this.x*e,this.y*e)}scalarMultiplyEquals(e){return this.x*=e,this.y*=e,this}divide(e){return new s(this.x/e.x,this.y/e.y)}scalarDivide(e){return new s(this.x/e,this.y/e)}scalarDivideEquals(e){return this.x/=e,this.y/=e,this}eq(e){return this.x===e.x&&this.y===e.y}lt(e){return this.x<e.x&&this.y<e.y}lte(e){return this.x<=e.x&&this.y<=e.y}gt(e){return this.x>e.x&&this.y>e.y}gte(e){return this.x>=e.x&&this.y>=e.y}lerp(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:.5;return t=Math.max(Math.min(1,t),0),new s(this.x+(e.x-this.x)*t,this.y+(e.y-this.y)*t)}distanceFrom(e){const t=this.x-e.x,n=this.y-e.y;return Math.sqrt(t*t+n*n)}midPointFrom(e){return this.lerp(e)}min(e){return new s(Math.min(this.x,e.x),Math.min(this.y,e.y))}max(e){return new s(Math.max(this.x,e.x),Math.max(this.y,e.y))}toString(){return"".concat(this.x,",").concat(this.y)}setXY(e,t){return this.x=e,this.y=t,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setFromPoint(e){return this.x=e.x,this.y=e.y,this}swap(e){const t=this.x,n=this.y;this.x=e.x,this.y=e.y,e.x=t,e.y=n}clone(){return new s(this.x,this.y)}rotate(e){let n=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:os;const o=V(e),i=I(e),t=this.subtract(n);return new s(t.x*i-t.y*o,t.x*o+t.y*i).add(n)}transform(e){let t=arguments.length>1&&0[0]!==arguments[1]&&arguments[1];return new s(e[0]*this.x+e[2]*this.y+(t?0:e[4]),e[1]*this.x+e[3]*this.y+(t?0:e[5]))}}const os=new s(0,0),Jt=e=>!!e&&Array.isArray(e._objects);function ts(e){class n extends e{constructor(){super(...arguments),t(this,"_objects",[])}_onObjectAdded(){}_onObjectRemoved(){}_onStackOrderChanged(){}add(){for(var n=arguments.length,t=new Array(n),e=0;e<n;e++)t[e]=arguments[e];const s=this._objects.push(...t);return t.forEach(e=>this._onObjectAdded(e)),s}insertAt(e){for(var n=arguments.length,s=new Array(n>1?n-1:0),t=1;t<n;t++)s[t-1]=arguments[t];return this._objects.splice(e,0,...s),s.forEach(e=>this._onObjectAdded(e)),this._objects.length}remove(){const t=this._objects,n=[];for(var s=arguments.length,o=new Array(s),e=0;e<s;e++)o[e]=arguments[e];return o.forEach(e=>{const s=t.indexOf(e);-1!==s&&(t.splice(s,1),n.push(e),this._onObjectRemoved(e))}),n}forEachObject(e){this.getObjects().forEach((t,n,s)=>e(t,n,s))}getObjects(){for(var n=arguments.length,t=new Array(n),e=0;e<n;e++)t[e]=arguments[e];return 0===t.length?[...this._objects]:this._objects.filter(e=>e.isType(...t))}item(e){return this._objects[e]}isEmpty(){return 0===this._objects.length}size(){return this._objects.length}contains(e,t){return!!this._objects.includes(e)||!!t&&this._objects.some(t=>t instanceof n&&t.contains(e,!0))}complexity(){return this._objects.reduce((e,t)=>e+=t.complexity?t.complexity():0,0)}sendObjectToBack(e){return!!e&&e!==this._objects[0]&&(Ee(this._objects,e),this._objects.unshift(e),this._onStackOrderChanged(e),!0)}bringObjectToFront(e){return!!e&&e!==this._objects[this._objects.length-1]&&(Ee(this._objects,e),this._objects.push(e),this._onStackOrderChanged(e),!0)}sendObjectBackwards(e,t){if(!e)return!1;const n=this._objects.indexOf(e);if(0!==n){const s=this.findNewLowerIndex(e,n,t);return Ee(this._objects,e),this._objects.splice(s,0,e),this._onStackOrderChanged(e),!0}return!1}bringObjectForward(e,t){if(!e)return!1;const n=this._objects.indexOf(e);if(n!==this._objects.length-1){const s=this.findNewUpperIndex(e,n,t);return Ee(this._objects,e),this._objects.splice(s,0,e),this._onStackOrderChanged(e),!0}return!1}moveObjectTo(e,t){return e!==this._objects[t]&&(Ee(this._objects,e),this._objects.splice(t,0,e),this._onStackOrderChanged(e),!0)}findNewLowerIndex(e,t,n){let s;if(n){{s=t;for(let n=t-1;n>=0;--n)if(e.isOverlapping(this._objects[n])){s=n;break}}}else s=t-1;return s}findNewUpperIndex(e,t,n){let s;if(n){{s=t;for(let n=t+1;n<this._objects.length;++n)if(e.isOverlapping(this._objects[n])){s=n;break}}}else s=t+1;return s}collectObjects(e){let{left:a,top:r,width:c,height:l}=e,{includeIntersecting:n=!0}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};const i=[],t=new s(a,r),o=t.add(new s(c,l));for(let s=this._objects.length-1;s>=0;s--){const e=this._objects[s];e.selectable&&e.visible&&(n&&e.intersectsWithRect(t,o)||e.isContainedWithinRect(t,o)||n&&e.containsPoint(t)||n&&e.containsPoint(o))&&i.push(e)}return i}}return n}class mo extends so{_setOptions(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};for(const t in e)this.set(t,e[t])}_setObject(e){for(const t in e)this._set(t,e[t])}set(e,t){return"object"==typeof e?this._setObject(e):this._set(e,t),this}_set(e,t){this[e]=t}toggle(e){const t=this.get(e);return"boolean"==typeof t&&this.set(e,!t),this}get(e){return this[e]}}function Ze(e){return $().requestAnimationFrame(e)}function fo(e){return $().cancelAnimationFrame(e)}let Wr=0;const fe=()=>Wr++,N=()=>{const e=we().createElement("canvas");if(!e||0[0]===e.getContext)throw new G("Failed to create `canvas` element");return e},go=()=>we().createElement("img"),M=e=>{const t=N();return t.width=e.width,t.height=e.height,t},Jn=(e,t,n)=>e.toDataURL("image/".concat(t),n),Xn=(e,t,n)=>new Promise((s)=>{e.toBlob(s,"image/".concat(t),n)}),m=e=>e*Os,Z=e=>e/Os,vo=e=>e.every((e,t)=>e===_[t]),j=(e,t,n)=>new s(e).transform(t,n),k=e=>{const t=1/(e[0]*e[3]-e[1]*e[2]),n=[t*e[3],-t*e[1],-t*e[2],t*e[0],0,0],{x:o,y:i}=new s(e[4],e[5]).transform(n,!0);return n[4]=-o,n[5]=-i,n},u=(e,t,n)=>[e[0]*t[0]+e[2]*t[1],e[1]*t[0]+e[3]*t[1],e[0]*t[2]+e[2]*t[3],e[1]*t[2]+e[3]*t[3],n?0:e[0]*t[4]+e[2]*t[5]+e[4],n?0:e[1]*t[4]+e[3]*t[5]+e[5]],nn=(e,t)=>e.reduceRight((e,n)=>n&&e?u(n,e,t):n||e,0[0])||_.concat(),bo=e=>{let[t,n]=e;return Math.atan2(n,t)},Ae=e=>{const s=bo(e),t=e[0]**2+e[1]**2,n=Math.sqrt(t),o=(e[0]*e[3]-e[2]*e[1])/n,i=Math.atan2(e[0]*e[2]+e[1]*e[3],t);return{angle:Z(s),scaleX:n,scaleY:o,skewX:Z(i),skewY:0,translateX:e[4]||0,translateY:e[5]||0}},Ue=function(e){return[1,0,0,1,e,arguments.length>1&&0[0]!==arguments[1]?arguments[1]:0]};function Me(){let{angle:i=0}=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{},{x:e=0,y:t=0}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};const o=m(i),n=I(o),s=V(o);return[n,s,-s,n,e?e-(n*e-s*t):0,t?t-(s*e+n*t):0]}const rn=function(e){return[e,0,0,arguments.length>1&&0[0]!==arguments[1]?arguments[1]:e,0,0]},yo=e=>Math.tan(m(e)),$n=e=>[1,0,yo(e),1,0,0],Bn=e=>[1,yo(e),0,1,0,0],gt=e=>{let{scaleX:n=1,scaleY:s=1,flipX:a=!1,flipY:r=!1,skewX:o=0,skewY:i=0}=e,t=rn(a?-n:n,r?-s:s);return o&&(t=u(t,$n(o),!0)),i&&(t=u(t,Bn(i),!0)),t},_o=e=>{const{translateX:o=0,translateY:i=0,angle:n=0}=e;let t=Ue(o,i);n&&(t=u(t,Me({angle:n})));const s=gt(e);return vo(s)||(t=u(t,s)),t},wt=function(e){let{signal:t,crossOrigin:n=null}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};return new Promise(function(s,o){if(t&&t.aborted)return o(new ks("loadImage"));const i=go();let a;t&&(a=function(e){i.src="",o(e)},t.addEventListener("abort",a,{once:!0}));const r=function(){i.onload=i.onerror=null,a&&(t==null||t.removeEventListener("abort",a)),s(i)};e?(i.onload=r,i.onerror=function(){a&&(t==null||t.removeEventListener("abort",a)),o(new G("Error loading ".concat(i.src)))},n&&(i.crossOrigin=n),i.src=e):r()})},Pe=function(e){let{signal:t,reviver:n=be}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};return new Promise((s,i)=>{const a=[];t&&t.addEventListener("abort",i,{once:!0}),Promise.all(e.map(e=>o.getClass(e.type).fromObject(e,{signal:t}).then(t=>(n(e,t),a.push(t),t)))).then(s).catch(e=>{a.forEach(e=>{e.dispose&&e.dispose()}),i(e)}).finally(()=>{t&&t.removeEventListener("abort",i)})})},vt=function(e){let{signal:t}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};return new Promise((n,s)=>{const i=[];t&&t.addEventListener("abort",s,{once:!0});const a=Object.values(e).map(e=>e&&e.type&&o.has(e.type)?Pe([e],{signal:t}).then(e=>{let[t]=e;return i.push(t),t}):e),r=Object.keys(e);Promise.all(a).then(e=>e.reduce((e,t,n)=>(e[r[n]]=t,e),{})).then(n).catch(e=>{i.forEach(e=>{e.dispose&&e.dispose()}),s(e)}).finally(()=>{t&&t.removeEventListener("abort",s)})})},Ce=function(e){return(arguments.length>1&&0[0]!==arguments[1]?arguments[1]:[]).reduce((t,n)=>(n in e&&(t[n]=e[n]),t),{})},zn=(e,t)=>Object.keys(e).reduce((n,s)=>(t(e[s],s,e)&&(n[s]=e[s]),n),{}),l=(e,t)=>parseFloat(Number(e).toFixed(t)),$e=e=>"matrix("+e.map(e=>l(e,a.NUM_FRACTION_DIGITS)).join(" ")+")",D=e=>!!e&&0[0]!==e.toLive,wo=e=>!!e&&"function"==typeof e.toObject,Oo=e=>!!e&&0[0]!==e.offsetX&&"source"in e,Te=e=>!!e&&"multiSelectionStacking"in e;function Eo(e){const n=e&&H(e);let s=0,o=0;if(!e||!n)return{left:s,top:o};let t=e;const i=n.documentElement,a=n.body||{scrollLeft:0,scrollTop:0};for(;t&&(t.parentNode||t.host)&&(t=t.parentNode||t.host,t===n?(s=a.scrollLeft||i.scrollLeft||0,o=a.scrollTop||i.scrollTop||0):(s+=t.scrollLeft||0,o+=t.scrollTop||0),1!==t.nodeType||"fixed"!==t.style.position););return{left:s,top:o}}const H=e=>e.ownerDocument||null,To=e=>{var t;return(null===(t=e.ownerDocument)||0[0]===t?0[0]:t.defaultView)||null},$o=function(e,t,n){let{width:o,height:i}=n,s=arguments.length>3&&0[0]!==arguments[3]?arguments[3]:1;e.width=o,e.height=i,s>1&&(e.setAttribute("width",(o*s).toString()),e.setAttribute("height",(i*s).toString()),t.scale(s,s))},Cn=(e,t)=>{let{width:n,height:s}=t;n&&(e.style.width="number"==typeof n?"".concat(n,"px"):n),s&&(e.style.height="number"==typeof s?"".concat(s,"px"):s)};function Uo(e){return 0[0]!==e.onselectstart&&(e.onselectstart=()=>!1),e.style.userSelect=x,e}class wn{constructor(e){t(this,"_originalCanvasStyle",0[0]),t(this,"lower",0[0]);const n=this.createLowerCanvas(e);this.lower={el:n,ctx:n.getContext("2d")}}createLowerCanvas(e){const t=(n=e)&&0[0]!==n.getContext?e:e&&we().getElementById(e)||N();var n;if(t.hasAttribute("data-fabric"))throw new G("Trying to initialize a canvas that has already been initialized. Did you forget to dispose the canvas?");return this._originalCanvasStyle=t.style.cssText,t.setAttribute("data-fabric","main"),t.classList.add("lower-canvas"),t}cleanupDOM(e){let{width:n,height:s}=e;const{el:t}=this.lower;t.classList.remove("lower-canvas"),t.removeAttribute("data-fabric"),t.setAttribute("width","".concat(n)),t.setAttribute("height","".concat(s)),t.style.cssText=this._originalCanvasStyle||"",this._originalCanvasStyle=0[0]}setDimensions(e,t){const{el:n,ctx:s}=this.lower;$o(n,s,e,t)}setCSSDimensions(e){Cn(this.lower.el,e)}calcOffset(){return function(e){var s;const i=e&&H(e),t={left:0,top:0};if(!i)return t;const n=(null===(s=To(e))||0[0]===s?0[0]:s.getComputedStyle(e,null))||{};t.left+=parseInt(n.borderLeftWidth,10)||0,t.top+=parseInt(n.borderTopWidth,10)||0,t.left+=parseInt(n.paddingLeft,10)||0,t.top+=parseInt(n.paddingTop,10)||0;let o={left:0,top:0};const a=i.documentElement;0[0]!==e.getBoundingClientRect&&(o=e.getBoundingClientRect());const r=Eo(e);return{left:o.left+r.left-(a.clientLeft||0)+t.left,top:o.top+r.top-(a.clientTop||0)+t.top}}(this.lower.el)}dispose(){W().dispose(this.lower.el),delete this.lower}}const cr={backgroundVpt:!0,backgroundColor:"",overlayVpt:!0,overlayColor:"",includeDefaultValues:!0,svgViewportTransformation:!0,renderOnAddRemove:!0,skipOffscreen:!0,enableRetinaScaling:!0,imageSmoothingEnabled:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,viewportTransform:[..._]};class nt extends ts(mo){get lowerCanvasEl(){var e;return null===(e=this.elements.lower)||0[0]===e?0[0]:e.el}get contextContainer(){var e;return null===(e=this.elements.lower)||0[0]===e?0[0]:e.ctx}static getDefaults(){return nt.ownDefaults}constructor(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};super(),Object.assign(this,this.constructor.getDefaults()),this.set(t),this.initElements(e),this._setDimensionsImpl({width:this.width||this.elements.lower.el.width||0,height:this.height||this.elements.lower.el.height||0}),this.skipControlsDrawing=!1,this.viewportTransform=[...this.viewportTransform],this.calcViewportBoundaries()}initElements(e){this.elements=new wn(e)}add(){const e=super.add(...arguments);return arguments.length>0&&this.renderOnAddRemove&&this.requestRenderAll(),e}insertAt(e){for(var n=arguments.length,s=new Array(n>1?n-1:0),t=1;t<n;t++)s[t-1]=arguments[t];const o=super.insertAt(e,...s);return s.length>0&&this.renderOnAddRemove&&this.requestRenderAll(),o}remove(){const e=super.remove(...arguments);return e.length>0&&this.renderOnAddRemove&&this.requestRenderAll(),e}_onObjectAdded(e){e.canvas&&e.canvas!==this&&(ie("warn",`Canvas is trying to add an object that belongs to a different canvas.
Resulting to default behavior: removing object from previous canvas and adding to new canvas`),e.canvas.remove(e)),e._set("canvas",this),e.setCoords(),this.fire("object:added",{target:e}),e.fire("added",{target:this})}_onObjectRemoved(e){e._set("canvas",0[0]),this.fire("object:removed",{target:e}),e.fire("removed",{target:this})}_onStackOrderChanged(){this.renderOnAddRemove&&this.requestRenderAll()}getRetinaScaling(){return this.enableRetinaScaling?Ks():1}calcOffset(){return this._offset=this.elements.calcOffset()}getWidth(){return this.width}getHeight(){return this.height}setWidth(e,t){return this.setDimensions({width:e},t)}setHeight(e,t){return this.setDimensions({height:e},t)}_setDimensionsImpl(e){let{cssOnly:t=!1,backstoreOnly:s=!1}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};if(!t){const t=n({width:this.width,height:this.height},e);this.elements.setDimensions(t,this.getRetinaScaling()),this.hasLostContext=!0,this.width=t.width,this.height=t.height}s||this.elements.setCSSDimensions(e),this.calcOffset()}setDimensions(e,t){this._setDimensionsImpl(e,t),t&&t.cssOnly||this.requestRenderAll()}getZoom(){return this.viewportTransform[0]}setViewportTransform(e){this.viewportTransform=e,this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll()}zoomToPoint(e,t){const s=e,n=[...this.viewportTransform],i=j(e,k(n));n[0]=t,n[3]=t;const o=j(i,n);n[4]+=s.x-o.x,n[5]+=s.y-o.y,this.setViewportTransform(n)}setZoom(e){this.zoomToPoint(new s(0,0),e)}absolutePan(e){const t=[...this.viewportTransform];return t[4]=-e.x,t[5]=-e.y,this.setViewportTransform(t)}relativePan(e){return this.absolutePan(new s(-e.x-this.viewportTransform[4],-e.y-this.viewportTransform[5]))}getElement(){return this.elements.lower.el}clearContext(e){e.clearRect(0,0,this.width,this.height)}getContext(){return this.elements.lower.ctx}clear(){this.remove(...this.getObjects()),this.backgroundImage=0[0],this.overlayImage=0[0],this.backgroundColor="",this.overlayColor="",this.clearContext(this.getContext()),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll()}renderAll(){this.cancelRequestedRender(),this.destroyed||this.renderCanvas(this.getContext(),this._objects)}renderAndReset(){this.nextRenderHandle=0,this.renderAll()}requestRenderAll(){this.nextRenderHandle||this.disposed||this.destroyed||(this.nextRenderHandle=Ze(()=>this.renderAndReset()))}calcViewportBoundaries(){const a=this.width,r=this.height,n=k(this.viewportTransform),o=j({x:0,y:0},n),i=j({x:a,y:r},n),e=o.min(i),t=o.max(i);return this.vptCoords={tl:e,tr:new s(t.x,e.y),bl:new s(e.x,t.y),br:t}}cancelRequestedRender(){this.nextRenderHandle&&(fo(this.nextRenderHandle),this.nextRenderHandle=0)}drawControls(){}renderCanvas(e,t){if(this.destroyed)return;const n=this.viewportTransform,s=this.clipPath;this.calcViewportBoundaries(),this.clearContext(e),e.imageSmoothingEnabled=this.imageSmoothingEnabled,e.patternQuality="best",this.fire("before:render",{ctx:e}),this._renderBackground(e),e.save(),e.transform(n[0],n[1],n[2],n[3],n[4],n[5]),this._renderObjects(e,t),e.restore(),this.controlsAboveOverlay||this.skipControlsDrawing||this.drawControls(e),s&&(s._set("canvas",this),s.shouldCache(),s._transformDone=!0,s.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(e,s)),this._renderOverlay(e),this.controlsAboveOverlay&&!this.skipControlsDrawing&&this.drawControls(e),this.fire("after:render",{ctx:e}),this.__cleanupTask&&(this.__cleanupTask(),this.__cleanupTask=0[0])}drawClipPathOnCanvas(e,t){const n=this.viewportTransform;e.save(),e.transform(...n),e.globalCompositeOperation="destination-in",t.transform(e),e.scale(1/t.zoomX,1/t.zoomY),e.drawImage(t._cacheCanvas,-t.cacheTranslationX,-t.cacheTranslationY),e.restore()}_renderObjects(e,t){for(let n=0,s=t.length;n<s;++n)t[n]&&t[n].render(e)}_renderBackgroundOrOverlay(e,t){const n=this["".concat(t,"Color")],s=this["".concat(t,"Image")],i=this.viewportTransform,o=this["".concat(t,"Vpt")];if(!n&&!s)return;const a=D(n);if(n){if(e.save(),e.beginPath(),e.moveTo(0,0),e.lineTo(this.width,0),e.lineTo(this.width,this.height),e.lineTo(0,this.height),e.closePath(),e.fillStyle=a?n.toLive(e):n,o&&e.transform(...i),a){e.transform(1,0,0,1,n.offsetX||0,n.offsetY||0);const t=n.gradientTransform||n.patternTransform;t&&e.transform(...t)}e.fill(),e.restore()}if(s){e.save();const{skipOffscreen:t}=this;this.skipOffscreen=o,o&&e.transform(...i),s.render(e),this.skipOffscreen=t,e.restore()}}_renderBackground(e){this._renderBackgroundOrOverlay(e,"background")}_renderOverlay(e){this._renderBackgroundOrOverlay(e,"overlay")}getCenter(){return{top:this.height/2,left:this.width/2}}getCenterPoint(){return new s(this.width/2,this.height/2)}centerObjectH(e){return this._centerObject(e,new s(this.getCenterPoint().x,e.getCenterPoint().y))}centerObjectV(e){return this._centerObject(e,new s(e.getCenterPoint().x,this.getCenterPoint().y))}centerObject(e){return this._centerObject(e,this.getCenterPoint())}viewportCenterObject(e){return this._centerObject(e,this.getVpCenter())}viewportCenterObjectH(e){return this._centerObject(e,new s(this.getVpCenter().x,e.getCenterPoint().y))}viewportCenterObjectV(e){return this._centerObject(e,new s(e.getCenterPoint().x,this.getVpCenter().y))}getVpCenter(){return j(this.getCenterPoint(),k(this.viewportTransform))}_centerObject(e,t){e.setXY(t,i,i),e.setCoords(),this.renderOnAddRemove&&this.requestRenderAll()}toDatalessJSON(e){return this.toDatalessObject(e)}toObject(e){return this._toObjectMethod("toObject",e)}toJSON(){return this.toObject()}toDatalessObject(e){return this._toObjectMethod("toDatalessObject",e)}_toObjectMethod(e,t){const s=this.clipPath,o=s&&!s.excludeFromExport?this._toObject(s,e,t):null;return n(n(n({version:Ht},Ce(this,t)),{},{objects:this._objects.filter(e=>!e.excludeFromExport).map(n=>this._toObject(n,e,t))},this.__serializeBgOverlay(e,t)),o?{clipPath:o}:null)}_toObject(e,t,n){let s;this.includeDefaultValues||(s=e.includeDefaultValues,e.includeDefaultValues=!1);const o=e[t](n);return this.includeDefaultValues||(e.includeDefaultValues=!!s),o}__serializeBgOverlay(e,t){const n={},i=this.backgroundImage,a=this.overlayImage,s=this.backgroundColor,o=this.overlayColor;return D(s)?s.excludeFromExport||(n.background=s.toObject(t)):s&&(n.background=s),D(o)?o.excludeFromExport||(n.overlay=o.toObject(t)):o&&(n.overlay=o),i&&!i.excludeFromExport&&(n.backgroundImage=this._toObject(i,e,t)),a&&!a.excludeFromExport&&(n.overlayImage=this._toObject(a,e,t)),n}toSVG(){let n=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:0[0];n.reviver=t;const e=[];return this._setSVGPreamble(e,n),this._setSVGHeader(e,n),this.clipPath&&e.push('<g clip-path="url(#'.concat(this.clipPath.clipPathId,`)" >
`)),this._setSVGBgOverlayColor(e,"background"),this._setSVGBgOverlayImage(e,"backgroundImage",t),this._setSVGObjects(e,t),this.clipPath&&e.push(`</g>
`),this._setSVGBgOverlayColor(e,"overlay"),this._setSVGBgOverlayImage(e,"overlayImage",t),e.push("</svg>"),e.join("")}_setSVGPreamble(e,t){t.suppressPreamble||e.push('<?xml version="1.0" encoding="',t.encoding||"UTF-8",`" standalone="no" ?>
`,'<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ',`"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
`)}_setSVGHeader(e,t){const i=t.width||"".concat(this.width),r=t.height||"".concat(this.height),s=a.NUM_FRACTION_DIGITS,n=t.viewBox;let o;if(n)o='viewBox="'.concat(n.x," ").concat(n.y," ").concat(n.width," ").concat(n.height,'" ');else if(this.svgViewportTransformation){const e=this.viewportTransform;o='viewBox="'.concat(l(-e[4]/e[0],s)," ").concat(l(-e[5]/e[3],s)," ").concat(l(this.width/e[0],s)," ").concat(l(this.height/e[3],s),'" ')}else o='viewBox="0 0 '.concat(this.width," ").concat(this.height,'" ');e.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',i,'" ','height="',r,'" ',o,`xml:space="preserve">
`,"<desc>Created with Fabric.js ",Ht,`</desc>
`,`<defs>
`,this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(t),`</defs>
`)}createSVGClipPathMarkup(e){const t=this.clipPath;return t?(t.clipPathId="CLIPPATH_".concat(fe()),'<clipPath id="'.concat(t.clipPathId,`" >
`).concat(t.toClipPathSVG(e.reviver),`</clipPath>
`)):""}createSVGRefElementsMarkup(){return["background","overlay"].map(e=>{const t=this["".concat(e,"Color")];if(D(t)){const n=this["".concat(e,"Vpt")],s=this.viewportTransform,o={isType:()=>!1,width:this.width/(n?s[0]:1),height:this.height/(n?s[3]:1)};return t.toSVG(o,{additionalTransform:n?$e(s):""})}}).join("")}createSVGFontFacesMarkup(){const n=[],e={},t=a.fontPaths;this._objects.forEach(function e(t){n.push(t),Jt(t)&&t._objects.forEach(e)}),n.forEach(n=>{if(!(o=n)||"function"!=typeof o._renderText)return;var o;const{styles:i,fontFamily:s}=n;!e[s]&&t[s]&&(e[s]=!0,i&&Object.values(i).forEach(n=>{Object.values(n).forEach(n=>{let{fontFamily:s=""}=n;!e[s]&&t[s]&&(e[s]=!0)})}))});const s=Object.keys(e).map(e=>`		@font-face {
			font-family: '`.concat(e,`';
			src: url('`).concat(t[e],`');
		}
`)).join("");return s?`	<style type="text/css"><![CDATA[
`.concat(s,`]]></style>
`):""}_setSVGObjects(e,t){this.forEachObject(n=>{n.excludeFromExport||this._setSVGObject(e,n,t)})}_setSVGObject(e,t,n){e.push(t.toSVG(n))}_setSVGBgOverlayImage(e,t,n){const s=this[t];s&&!s.excludeFromExport&&s.toSVG&&e.push(s.toSVG(n))}_setSVGBgOverlayColor(e,t){const n=this["".concat(t,"Color")];if(n)if(D(n)){const s=n.repeat||"",o=this.width,i=this.height,a=this["".concat(t,"Vpt")]?$e(k(this.viewportTransform)):"";e.push('<rect transform="'.concat(a," translate(").concat(o/2,",").concat(i/2,')" x="').concat(n.offsetX-o/2,'" y="').concat(n.offsetY-i/2,'" width="').concat("repeat-y"!==s&&"no-repeat"!==s||!Oo(n)?o:n.source.width,'" height="').concat("repeat-x"!==s&&"no-repeat"!==s||!Oo(n)?i:n.source.height,'" fill="url(#SVGID_').concat(n.id,`)"></rect>
`))}else e.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',n,'"',`></rect>
`)}loadFromJSON(e,t){let{signal:n}=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:{};if(!e)return Promise.reject(new G("`json` is undefined"));const s="string"==typeof e?JSON.parse(e):e,{objects:o=[],backgroundImage:i,background:a,overlayImage:r,overlay:c,clipPath:l}=s,d=this.renderOnAddRemove;return this.renderOnAddRemove=!1,Promise.all([Pe(o,{reviver:t,signal:n}),vt({backgroundImage:i,backgroundColor:a,overlayImage:r,overlayColor:c,clipPath:l},{signal:n})]).then(e=>{let[t,n]=e;return this.clear(),this.add(...t),this.set(s),this.set(n),this.renderOnAddRemove=d,this})}clone(e){const t=this.toObject(e);return this.cloneWithoutData().loadFromJSON(t)}cloneWithoutData(){const e=M(this);return new this.constructor(e)}toDataURL(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};const{format:t="png",quality:n=1,multiplier:s=1,enableRetinaScaling:o=!1}=e,i=s*(o?this.getRetinaScaling():1);return Jn(this.toCanvasElement(i,e),t,n)}toBlob(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};const{format:t="png",quality:n=1,multiplier:s=1,enableRetinaScaling:o=!1}=e,i=s*(o?this.getRetinaScaling():1);return Xn(this.toCanvasElement(i,e),t,n)}toCanvasElement(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:1,{width:g,height:m,left:h,top:r,filter:i}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};const a=(g||this.width)*e,n=(m||this.height)*e,c=this.getZoom(),l=this.width,d=this.height,u=this.skipControlsDrawing,o=c*e,t=this.viewportTransform,f=[o,0,0,o,(t[4]-(h||0))*e,(t[5]-(r||0))*e],p=this.enableRetinaScaling,s=M({width:a,height:n}),v=i?this._objects.filter(e=>i(e)):this._objects;return this.enableRetinaScaling=!1,this.viewportTransform=f,this.width=a,this.height=n,this.skipControlsDrawing=!0,this.calcViewportBoundaries(),this.renderCanvas(s.getContext("2d"),v),this.viewportTransform=t,this.width=l,this.height=d,this.calcViewportBoundaries(),this.enableRetinaScaling=p,this.skipControlsDrawing=u,s}dispose(){return!this.disposed&&this.elements.cleanupDOM({width:this.width,height:this.height}),Ot.cancelByCanvas(this),this.disposed=!0,new Promise((e,t)=>{const n=()=>{this.destroy(),e(!0)};n.kill=t,this.__cleanupTask&&this.__cleanupTask.kill("aborted"),this.destroyed?e(!1):this.nextRenderHandle?this.__cleanupTask=n:n()})}destroy(){this.destroyed=!0,this.cancelRequestedRender(),this.forEachObject(e=>e.dispose()),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose(),this.backgroundImage=0[0],this.overlayImage&&this.overlayImage.dispose(),this.overlayImage=0[0],this.elements.dispose()}toString(){return"#<Canvas (".concat(this.complexity(),"): { objects: ").concat(this._objects.length," }>")}}t(nt,"ownDefaults",cr);const or=["touchstart","touchmove","touchend"],Jo=e=>{const t=Eo(e.target),n=function(e){const t=e.changedTouches;return t&&t[0]?t[0]:e}(e);return new s(n.clientX+t.left,n.clientY+t.top)},un=e=>or.includes(e.type)||"touch"===e.pointerType,ei=e=>{e.preventDefault(),e.stopPropagation()},te=e=>{let t=0,n=0,s=0,o=0;for(let i=0,c=e.length;i<c;i++){const{x:a,y:r}=e[i];(a>s||!i)&&(s=a),(a<t||!i)&&(t=a),(r>o||!i)&&(o=r),(r<n||!i)&&(n=r)}return{left:t,top:n,width:s-t,height:o-n}},Ja=["translateX","translateY","scaleX","scaleY"],oi=(e,t)=>Ve(e,u(t,e.calcOwnMatrix())),Ve=(e,t)=>{const n=Ae(t),{translateX:o,translateY:a,scaleX:r,scaleY:c}=n,l=d(n,Ja),u=new s(o,a);e.flipX=!1,e.flipY=!1,Object.assign(e,l),e.set({scaleX:r,scaleY:c}),e.setPositionByOrigin(u,i,i)},ai=e=>{e.scaleX=1,e.scaleY=1,e.skewX=0,e.skewY=0,e.flipX=!1,e.flipY=!1,e.rotate(0)},Gn=e=>({scaleX:e.scaleX,scaleY:e.scaleY,skewX:e.skewX,skewY:e.skewY,angle:e.angle,left:e.left,flipX:e.flipX,flipY:e.flipY,top:e.top}),zt=(e,t,n)=>{const o=e/2,i=t/2,r=[new s(-o,-i),new s(o,-i),new s(-o,i),new s(o,i)].map(e=>e.transform(n)),a=te(r);return new s(a.width,a.height)},Xe=function(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:_;return u(k(arguments.length>1&&0[0]!==arguments[1]?arguments[1]:_),e)},re=function(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:_,n=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:_;return e.transform(Xe(t,n))},hi=function(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:_,n=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:_;return e.transform(Xe(t,n),!0)},rs=(e,t,n)=>{const s=Xe(t,n);return Ve(e,u(s,e.calcOwnMatrix())),s},ls=(e,t)=>{var s;const{transform:{target:o}}=t;null===(s=o.canvas)||0[0]===s||s.fire("object:".concat(e),n(n({},t),{},{target:o})),o.fire(e,t)},Ka={left:-.5,top:-.5,center:0,bottom:.5,right:.5},g=e=>"string"==typeof e?Ka[e]:e-.5,Yt="not-allowed";function mi(e){return g(e.originX)===g(i)&&g(e.originY)===g(i)}function pi(e){return.5-g(e)}const Y=(e,t)=>e[t],ps=(e,t,n,o)=>({e,transform:t,pointer:new s(n,o)});function gi(e,t){const n=e.getTotalAngle()+Z(Math.atan2(t.y,t.x))+360;return Math.round(n%360/45)}function Ut(e,t,n,o,a){var d;let{target:l,corner:h}=e;const u=l.controls[h],f=(null===(d=l.canvas)||0[0]===d?0[0]:d.getZoom())||1,c=l.padding/f,r=function(e,t,n,o){const a=e.getRelativeCenterPoint(),r=0[0]!==n&&0[0]!==o?e.translateToGivenOrigin(a,i,i,n,o):new s(e.left,e.top);return(e.angle?t.rotate(-m(e.angle),a):t).subtract(r)}(l,new s(o,a),t,n);return r.x>=c&&(r.x-=c),r.x<=-c&&(r.x+=c),r.y>=c&&(r.y-=c),r.y<=c&&(r.y+=c),r.x-=u.offsetX,r.y-=u.offsetY,r}const yi=(e,t,n,s)=>{const{target:o,offsetX:d,offsetY:u}=t,r=n-d,l=s-u,i=!Y(o,"lockMovementX")&&o.left!==r,a=!Y(o,"lockMovementY")&&o.top!==l;return i&&o.set(c,r),a&&o.set(A,l),(i||a)&&ls(qs,ps(e,t,n,s)),i||a},_i={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#0FF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000",blanchedalmond:"#FFEBCD",blue:"#00F",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#0FF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#F0F",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#789",lightslategrey:"#789",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#0F0",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#F0F",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#639",red:"#F00",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFF",whitesmoke:"#F5F5F5",yellow:"#FF0",yellowgreen:"#9ACD32"},xs=(e,t,n)=>(n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e),Ai=(e,t,n,s)=>{e/=255,t/=255,n/=255;const o=Math.max(e,t,n),a=Math.min(e,t,n);let i,r;const c=(o+a)/2;if(o===a)i=r=0;else{const s=o-a;switch(r=c>.5?s/(2-o-a):s/(o+a),o){case e:i=(t-n)/s+(t<n?6:0);break;case t:i=(n-e)/s+2;break;case n:i=(e-t)/s+4}i/=6}return[Math.round(360*i),Math.round(100*r),Math.round(100*c),s]},Fi=function(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:"1";return parseFloat(e)/(e.endsWith("%")?100:1)},Nt=e=>Math.min(Math.round(e),255).toString(16).toUpperCase().padStart(2,"0"),Ti=e=>{let[n,s,o,i=1]=e;const t=Math.round(.3*n+.59*s+.11*o);return[t,t,t,i]};class r{constructor(e){if(t(this,"isUnrecognised",!1),e)if(e instanceof r)this.setSource([...e._source]);else if(Array.isArray(e)){const[t,n,s,o=1]=e;this.setSource([t,n,s,o])}else this.setSource(this._tryParsingColor(e));else this.setSource([0,0,0,1])}_tryParsingColor(e){return(e=e.toLowerCase())in _i&&(e=_i[e]),"transparent"===e?[255,255,255,0]:r.sourceFromHex(e)||r.sourceFromRgb(e)||r.sourceFromHsl(e)||(this.isUnrecognised=!0)&&[0,0,0,1]}getSource(){return this._source}setSource(e){this._source=e}toRgb(){const[e,t,n]=this.getSource();return"rgb(".concat(e,",").concat(t,",").concat(n,")")}toRgba(){return"rgba(".concat(this.getSource().join(","),")")}toHsl(){const[e,t,n]=Ai(...this.getSource());return"hsl(".concat(e,",").concat(t,"%,").concat(n,"%)")}toHsla(){const[e,t,n,s]=Ai(...this.getSource());return"hsla(".concat(e,",").concat(t,"%,").concat(n,"%,").concat(s,")")}toHex(){return this.toHexa().slice(0,6)}toHexa(){const[e,t,n,s]=this.getSource();return"".concat(Nt(e)).concat(Nt(t)).concat(Nt(n)).concat(Nt(Math.round(255*s)))}getAlpha(){return this.getSource()[3]}setAlpha(e){return this._source[3]=e,this}toGrayscale(){return this.setSource(Ti(this.getSource())),this}toBlackWhite(e){const[n,,,s]=Ti(this.getSource()),t=n<(e||127)?0:255;return this.setSource([t,t,t,s]),this}overlayWith(e){e instanceof r||(e=new r(e));const t=this.getSource(),n=e.getSource(),[s,o,i]=t.map((e,t)=>Math.round(.5*e+.5*n[t]));return this.setSource([s,o,i,t[3]]),this}static fromRgb(e){return r.fromRgba(e)}static fromRgba(e){return new r(r.sourceFromRgb(e))}static sourceFromRgb(e){const t=e.match(/^rgba?\(\s*(\d{0,3}(?:\.\d+)?%?)\s*[\s|,]\s*(\d{0,3}(?:\.\d+)?%?)\s*[\s|,]\s*(\d{0,3}(?:\.\d+)?%?)\s*(?:\s*[,/]\s*(\d{0,3}(?:\.\d+)?%?)\s*)?\)$/i);if(t){const[e,n,s]=t.slice(1,4).map(e=>{const t=parseFloat(e);return e.endsWith("%")?Math.round(2.55*t):t});return[e,n,s,Fi(t[4])]}}static fromHsl(e){return r.fromHsla(e)}static fromHsla(e){return new r(r.sourceFromHsl(e))}static sourceFromHsl(e){const n=e.match(/^hsla?\(\s*([+-]?\d{0,3}(?:\.\d+)?(?:deg|turn|rad)?)\s*[\s|,]\s*(\d{0,3}(?:\.\d+)?%?)\s*[\s|,]\s*(\d{0,3}(?:\.\d+)?%?)\s*(?:\s*[,/]\s*(\d*(?:\.\d+)?%?)\s*)?\)$/i);if(!n)return;const o=(r.parseAngletoDegrees(n[1])%360+360)%360/360,s=parseFloat(n[2])/100,t=parseFloat(n[3])/100;let i,a,c;if(0===s)i=a=c=t;else{const e=t<=.5?t*(s+1):t+s-t*s,n=2*t-e;i=xs(n,e,o+1/3),a=xs(n,e,o),c=xs(n,e,o-1/3)}return[Math.round(255*i),Math.round(255*a),Math.round(255*c),Fi(n[4])]}static fromHex(e){return new r(r.sourceFromHex(e))}static sourceFromHex(e){if(e.match(/^#?(([0-9a-f]){3,4}|([0-9a-f]{2}){3,4})$/i)){const t=e.slice(e.indexOf("#")+1);let n;n=t.length<=4?t.split("").map(e=>e+e):t.match(/.{2}/g);const[s,o,i,a=255]=n.map(e=>parseInt(e,16));return[s,o,i,a/255]}}static parseAngletoDegrees(e){const t=e.toLowerCase(),n=parseFloat(t);return t.includes("rad")?Z(n):t.includes("turn")?360*n:n}}const E=function(e){let o=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:ws;const s=/\D{0,2}$/.exec(e),t=parseFloat(e),n=a.DPI;switch(s?.[0]){case"mm":return t*n/25.4;case"cm":return t*n/2.54;case"in":return t*n;case"pt":return t*n/72;case"pc":return t*n/72*12;case"em":return t*o;default:return t}},Cs=e=>{const[n,s]=e.trim().split(" "),[o,i]=(t=n)&&t!==x?[t.slice(1,4),t.slice(5,8)]:t===x?[t,t]:["Mid","Mid"];var t;return{meetOrSlice:s||"meet",alignX:o,alignY:i}},Ft=function(e,t){let n,s,o=!(arguments.length>2&&0[0]!==arguments[2])||arguments[2];if(t)if(t.toLive)n="url(#SVGID_".concat(t.id,")");else{const e=new r(t),o=e.getAlpha();n=e.toRgb(),1!==o&&(s=o.toString())}else n="none";return o?"".concat(e,": ").concat(n,"; ").concat(s?"".concat(e,"-opacity: ").concat(s,"; "):""):"".concat(e,'="').concat(n,'" ').concat(s?"".concat(e,'-opacity="').concat(s,'" '):"")};class Bi{getSvgStyles(e){const t=this.fillRule?this.fillRule:"nonzero",n=this.strokeWidth?this.strokeWidth:"0",s=this.strokeDashArray?this.strokeDashArray.join(" "):x,o=this.strokeDashOffset?this.strokeDashOffset:"0",i=this.strokeLineCap?this.strokeLineCap:"butt",a=this.strokeLineJoin?this.strokeLineJoin:"miter",r=this.strokeMiterLimit?this.strokeMiterLimit:"4",c=0[0]!==this.opacity?this.opacity:"1",l=this.visible?"":" visibility: hidden;",d=e?"":this.getSvgFilter(),u=Ft(v,this.fill);return[Ft(C,this.stroke),"stroke-width: ",n,"; ","stroke-dasharray: ",s,"; ","stroke-linecap: ",i,"; ","stroke-dashoffset: ",o,"; ","stroke-linejoin: ",a,"; ","stroke-miterlimit: ",r,"; ",u,"fill-rule: ",t,"; ","opacity: ",c,";",d,l].join("")}getSvgFilter(){return this.shadow?"filter: url(#SVGID_".concat(this.shadow.id,");"):""}getSvgCommons(){return[this.id?'id="'.concat(this.id,'" '):"",this.clipPath?'clip-path="url(#'.concat(this.clipPath.clipPathId,')" '):""].join("")}getSvgTransform(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:"";const n=e?this.calcTransformMatrix():this.calcOwnMatrix(),s='transform="'.concat($e(n));return"".concat(s).concat(t,'" ')}_toSVG(){return[""]}toSVG(e){return this._createBaseSVGMarkup(this._toSVG(e),{reviver:e})}toClipPathSVG(e){return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(e),{reviver:e})}_createBaseClipPathSVGMarkup(e){let{reviver:t,additionalTransform:n=""}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};const s=[this.getSvgTransform(!0,n),this.getSvgCommons()].join(""),o=e.indexOf("COMMON_PARTS");return e[o]=s,t?t(e.join("")):e.join("")}_createBaseSVGMarkup(e){let{noStyle:r,reviver:o,withShadow:h,additionalTransform:c}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};const f=r?"":'style="'.concat(this.getSvgStyles(),'" '),a=h?'style="'.concat(this.getSvgFilter(),'" '):"",n=this.clipPath,m=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",s=n&&n.absolutePositioned,i=this.stroke,l=this.fill,d=this.shadow,t=[],p=e.indexOf("COMMON_PARTS");let u;n&&(n.clipPathId="CLIPPATH_".concat(fe()),u='<clipPath id="'.concat(n.clipPathId,`" >
`).concat(n.toClipPathSVG(o),`</clipPath>
`)),s&&t.push("<g ",a,this.getSvgCommons(),` >
`),t.push("<g ",this.getSvgTransform(!1),s?"":a+this.getSvgCommons(),` >
`);const g=[f,m,r?"":this.addPaintOrder()," ",c?'transform="'.concat(c,'" '):""].join("");return e[p]=g,D(l)&&t.push(l.toSVG(this)),D(i)&&t.push(i.toSVG(this)),d&&t.push(d.toSVG(this)),n&&t.push(u),t.push(e.join("")),t.push(`</g>
`),s&&t.push(`</g>
`),o?o(t.join("")):t.join("")}addPaintOrder(){return this.paintFirst!==v?' paint-order="'.concat(this.paintFirst,'" '):""}}function It(e){return new RegExp("^("+e.join("|")+")\\b","i")}const ke="textDecorationThickness",Vi=["fontSize","fontWeight","fontFamily","fontStyle"],$i=["underline","overline","linethrough"],qi=[...Vi,"lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide","pathAlign"],Yi=[...qi,...$i,"textBackgroundColor","direction",ke],va=[...Vi,...$i,C,"strokeWidth",v,"deltaY","textBackgroundColor",ke],pa={_reNewline:bs,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:c,fontStyle:"normal",lineHeight:1.16,textBackgroundColor:"",stroke:null,shadow:null,path:0[0],pathStartOffset:0,pathSide:c,pathAlign:"baseline",charSpacing:0,deltaY:0,direction:"ltr",CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.28167,overline:-.81333},_fontSizeMult:1.13,[ke]:66.667},ee="justify",Gt="justify-left",jt="justify-right",bt="justify-center",q=String.raw(na||(na=ne(["[-+]?(?:d*.d+|d+.?)(?:[eE][-+]?d+)?"],["[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?"]))),qn=String.raw(sa||(sa=ne(["(?:s*,?s+|s*,s*)"],["(?:\\s*,?\\s+|\\s*,\\s*)"]))),Un="http://www.w3.org/2000/svg",ra=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+q+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+q+"))?\\s+(.*)"),aa={cx:c,x:c,r:"radius",cy:A,y:A,display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing","text-decoration-thickness":ke},Wn="font-size",Pn="clip-path",ma=It(["path","circle","polygon","polyline","ellipse","rect","line","image","text"]),fa=It(["symbol","image","marker","pattern","view","svg"]),ea=It(["symbol","g","a","svg","clipPath","defs"]),Zi=new RegExp(String.raw(oa||(oa=ne(["^s*(",")","(",")","(",")","(",")s*$"],["^\\s*(",")","(",")","(",")","(",")\\s*$"])),q,qn,q,qn,q,qn,q)),Aa=new s(1,0),Hi=new s,Mn=(e,t)=>e.rotate(t),gn=(e,t)=>new s(t).subtract(e),vn=e=>e.distanceFrom(Hi),bn=(e,t)=>Math.atan2(qe(e,t),Li(e,t)),Ri=e=>bn(Aa,e),Dt=e=>e.eq(Hi)?e:e.scalarDivide(vn(e)),Qn=function(e){let t=!(arguments.length>1&&0[0]!==arguments[1])||arguments[1];return Dt(new s(-e.y,e.x).scalarMultiply(t?1:-1))},qe=(e,t)=>e.x*t.y-e.y*t.x,Li=(e,t)=>e.x*t.x+e.y*t.y,xn=(e,t,n)=>{if(e.eq(t)||e.eq(n))return!0;const i=qe(t,n),s=qe(t,e),o=qe(n,e);return i>=0?s>=0&&o<=0:!(s<=0&&o>=0)},Ni="(-?\\d+(?:\\.\\d*)?(?:px)?(?:\\s?|$))?",Di=new RegExp("(?:\\s|^)"+Ni+Ni+"("+q+"?(?:px)?)?(?:\\s?|$)(?:$|\\s)");class R{constructor(e){const t="string"==typeof e?R.parseShadow(e):e;Object.assign(this,R.ownDefaults,t),this.id=fe()}static parseShadow(e){const t=e.trim(),[,n=0,s=0,o=0]=(Di.exec(t)||[]).map(e=>parseFloat(e)||0);return{color:(t.replace(Di,"")||"rgb(0,0,0)").trim(),offsetX:n,offsetY:s,blur:o}}toString(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")}toSVG(e){const t=Mn(new s(this.offsetX,this.offsetY),m(-e.angle)),i=new r(this.color);let n=40,o=40;return e.width&&e.height&&(n=100*l((Math.abs(t.x)+this.blur)/e.width,a.NUM_FRACTION_DIGITS)+20,o=100*l((Math.abs(t.y)+this.blur)/e.height,a.NUM_FRACTION_DIGITS)+20),e.flipX&&(t.x*=-1),e.flipY&&(t.y*=-1),'<filter id="SVGID_'.concat(this.id,'" y="-').concat(o,'%" height="').concat(100+2*o,'%" x="-').concat(n,'%" width="').concat(100+2*n,`%" >
	<feGaussianBlur in="SourceAlpha" stdDeviation="`).concat(l(this.blur?this.blur/2:0,a.NUM_FRACTION_DIGITS),`"></feGaussianBlur>
	<feOffset dx="`).concat(l(t.x,a.NUM_FRACTION_DIGITS),'" dy="').concat(l(t.y,a.NUM_FRACTION_DIGITS),`" result="oBlur" ></feOffset>
	<feFlood flood-color="`).concat(i.toRgb(),'" flood-opacity="').concat(i.getAlpha(),`"/>
	<feComposite in2="oBlur" operator="in" />
	<feMerge>
		<feMergeNode></feMergeNode>
		<feMergeNode in="SourceGraphic"></feMergeNode>
	</feMerge>
</filter>
`)}toObject(){const e={color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling,type:this.constructor.type},t=R.ownDefaults;return this.includeDefaultValues?e:zn(e,(e,n)=>e!==t[n])}static async fromObject(e){return new this(e)}}t(R,"ownDefaults",{color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1}),t(R,"type","shadow"),o.setClass(R,"shadow");const Fe=(e,t,n)=>Math.max(e,Math.min(t,n)),Ra=[A,c,O,z,"flipX","flipY","originX","originY","angle","opacity","globalCompositeOperation","shadow","visible",Ie,He],se=[v,C,"strokeWidth","strokeDashArray","width","height","paintFirst","strokeUniform","strokeLineCap","strokeDashOffset","strokeLineJoin","strokeMiterLimit","backgroundColor","clipPath"],Pa={top:0,left:0,width:0,height:0,angle:0,flipX:!1,flipY:!1,scaleX:1,scaleY:1,minScaleLimit:0,skewX:0,skewY:0,originX:c,originY:A,strokeWidth:1,strokeUniform:!1,padding:0,opacity:1,paintFirst:v,fill:"rgb(0,0,0)",fillRule:"nonzero",stroke:null,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,globalCompositeOperation:"source-over",backgroundColor:"",shadow:null,visible:!0,includeDefaultValues:!0,excludeFromExport:!1,objectCaching:!0,clipPath:0[0],inverted:!1,absolutePositioned:!1,centeredRotation:!0,centeredScaling:!1,dirty:!0},Tn=(e,t,n,s)=>(e<Math.abs(t)?(e=t,s=n/4):s=0===t&&0===e?n/le*Math.asin(1):n/le*Math.asin(t/e),{a:e,c:t,p:n,s}),Ei=(e,t,n,s,o)=>e*2**(10*(s-=1))*Math.sin((s*o-t)*le/n),Ci=(e,t,n,s)=>-n*Math.cos(e/s*ge)+n+t,Nn=(e,t,n,s)=>(e/=s)<1/2.75?n*(7.5625*e*e)+t:e<2/2.75?n*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?n*(7.5625*(e-=2.25/2.75)*e+.9375)+t:n*(7.5625*(e-=2.625/2.75)*e+.984375)+t,xi=(e,t,n,s)=>n-Nn(s-e,0,n,s)+t;var na,sa,oa,Ys,oo,io,ao,ro,co,lo,uo,Si,xo,Ps,$a=Object.freeze({__proto__:null,defaultEasing:Ci,easeInBack:function(e,t,n,s){let o=arguments.length>4&&0[0]!==arguments[4]?arguments[4]:1.70158;return n*(e/=s)*e*((o+1)*e-o)+t},easeInBounce:xi,easeInCirc:(e,t,n,s)=>-n*(Math.sqrt(1-(e/=s)*e)-1)+t,easeInCubic:(e,t,n,s)=>n*(e/s)**3+t,easeInElastic:(e,t,n,s)=>{const i=n;let o=0;if(0===e)return t;if(1===(e/=s))return t+n;o||(o=.3*s);const{a,s:r,p:c}=Tn(i,n,o,1.70158);return-Ei(a,r,c,e,s)+t},easeInExpo:(e,t,n,s)=>0===e?t:n*2**(10*(e/s-1))+t,easeInOutBack:function(e,t,n,s){let o=arguments.length>4&&0[0]!==arguments[4]?arguments[4]:1.70158;return(e/=s/2)<1?n/2*(e*e*((1+(o*=1.525))*e-o))+t:n/2*((e-=2)*e*((1+(o*=1.525))*e+o)+2)+t},easeInOutBounce:(e,t,n,s)=>e<s/2?.5*xi(2*e,0,n,s)+t:.5*Nn(2*e-s,0,n,s)+.5*n+t,easeInOutCirc:(e,t,n,s)=>(e/=s/2)<1?-n/2*(Math.sqrt(1-e**2)-1)+t:n/2*(Math.sqrt(1-(e-=2)*e)+1)+t,easeInOutCubic:(e,t,n,s)=>(e/=s/2)<1?n/2*e**3+t:n/2*((e-2)**3+2)+t,easeInOutElastic:(e,t,n,s)=>{const c=n;let o=0;if(0===e)return t;if(2===(e/=s/2))return t+n;o||(o=s*(.3*1.5));const{a:i,s:a,p:r,c:l}=Tn(c,n,o,1.70158);return e<1?-.5*Ei(i,a,r,e,s)+t:i*2**(-10*(e-=1))*Math.sin((e*s-a)*le/r)*.5+l+t},easeInOutExpo:(e,t,n,s)=>0===e?t:e===s?t+n:(e/=s/2)<1?n/2*2**(10*(e-1))+t:n/2*-(2**(-10*--e)+2)+t,easeInOutQuad:(e,t,n,s)=>(e/=s/2)<1?n/2*e**2+t:-n/2*(--e*(e-2)-1)+t,easeInOutQuart:(e,t,n,s)=>(e/=s/2)<1?n/2*e**4+t:-n/2*((e-=2)*e**3-2)+t,easeInOutQuint:(e,t,n,s)=>(e/=s/2)<1?n/2*e**5+t:n/2*((e-2)**5+2)+t,easeInOutSine:(e,t,n,s)=>-n/2*(Math.cos(Math.PI*e/s)-1)+t,easeInQuad:(e,t,n,s)=>n*(e/=s)*e+t,easeInQuart:(e,t,n,s)=>n*(e/=s)*e**3+t,easeInQuint:(e,t,n,s)=>n*(e/s)**5+t,easeInSine:(e,t,n,s)=>-n*Math.cos(e/s*ge)+n+t,easeOutBack:function(e,t,n,s){let o=arguments.length>4&&0[0]!==arguments[4]?arguments[4]:1.70158;return n*((e=e/s-1)*e*((o+1)*e+o)+1)+t},easeOutBounce:Nn,easeOutCirc:(e,t,n,s)=>n*Math.sqrt(1-(e=e/s-1)*e)+t,easeOutCubic:(e,t,n,s)=>n*((e/s-1)**3+1)+t,easeOutElastic:(e,t,n,s)=>{const i=n;let o=0;if(0===e)return t;if(1===(e/=s))return t+n;o||(o=.3*s);const{a,s:r,p:c,c:l}=Tn(i,n,o,1.70158);return a*2**(-10*e)*Math.sin((e*s-r)*le/c)+l+t},easeOutExpo:(e,t,n,s)=>e===s?t+n:n*-(2**(-10*e/s)+1)+t,easeOutQuad:(e,t,n,s)=>-n*(e/=s)*(e-2)+t,easeOutQuart:(e,t,n,s)=>-n*((e=e/s-1)*e**3-1)+t,easeOutQuint:(e,t,n,s)=>n*((e/s-1)**5+1)+t,easeOutSine:(e,t,n,s)=>n*Math.sin(e/s*ge)+t});const Xa=()=>!1;class Hn{constructor(e){let{startValue:n,byValue:s,duration:o=500,delay:i=0,easing:a=Ci,onStart:r=be,onChange:c=be,onComplete:l=be,abort:d=Xa,target:u}=e;t(this,"_state","pending"),t(this,"durationProgress",0),t(this,"valueProgress",0),this.tick=this.tick.bind(this),this.duration=o,this.delay=i,this.easing=a,this._onStart=r,this._onChange=c,this._onComplete=l,this._abort=d,this.target=u,this.startValue=n,this.byValue=s,this.value=this.startValue,this.endValue=Object.freeze(this.calculate(this.duration).value)}get state(){return this._state}isDone(){return"aborted"===this._state||"completed"===this._state}start(){const e=e=>{"pending"===this._state&&(this.startTime=e||+new Date,this._state="running",this._onStart(),this.tick(this.startTime))};this.register(),this.delay>0?setTimeout(()=>Ze(e),this.delay):Ze(e)}tick(e){const t=(e||+new Date)-this.startTime,n=Math.min(t,this.duration);this.durationProgress=n/this.duration;const{value:s,valueProgress:o}=this.calculate(n);this.value=Object.freeze(s),this.valueProgress=o,"aborted"!==this._state&&(this._abort(this.value,this.valueProgress,this.durationProgress)?(this._state="aborted",this.unregister()):t>=this.duration?(this.durationProgress=this.valueProgress=1,this._onChange(this.endValue,this.valueProgress,this.durationProgress),this._state="completed",this._onComplete(this.endValue,this.valueProgress,this.durationProgress),this.unregister()):(this._onChange(this.value,this.valueProgress,this.durationProgress),Ze(this.tick)))}register(){Ot.push(this)}unregister(){Ot.remove(this)}abort(){this._state="aborted",this.unregister()}}const Za=["startValue","endValue"];class ar extends Hn{constructor(e){let{startValue:t=0,endValue:s=100}=e;super(n(n({},d(e,Za)),{},{startValue:t,byValue:s-t}))}calculate(e){const t=this.easing(e,this.startValue,this.byValue,this.duration);return{value:t,valueProgress:Math.abs((t-this.startValue)/this.byValue)}}}const lr=["startValue","endValue"];class ur extends Hn{constructor(e){let{startValue:t=[0],endValue:s=[100]}=e;super(n(n({},d(e,lr)),{},{startValue:t,byValue:s.map((e,n)=>e-t[n])}))}calculate(e){const t=this.startValue.map((t,n)=>this.easing(e,t,this.byValue[n],this.duration,n));return{value:t,valueProgress:Math.abs((t[0]-this.startValue[0])/this.byValue[0])}}}const pr=["startValue","endValue","easing","onChange","onComplete","abort"],ia=(e,t,n,s)=>t+n*(1-Math.cos(e/s*ge)),Kn=e=>e&&((t,n,s)=>e(new r(t).toRgba(),n,s));class br extends Hn{constructor(e){let{startValue:s,endValue:o,easing:i=ia,onChange:a,onComplete:c,abort:l}=e,u=d(e,pr);const t=new r(s).getSource(),h=new r(o).getSource();super(n(n({},u),{},{startValue:t,byValue:h.map((e,n)=>e-t[n]),easing:i,onChange:Kn(a),onComplete:Kn(c),abort:Kn(l)}))}calculate(e){const[n,s,o,i]=this.startValue.map((t,n)=>this.easing(e,t,this.byValue[n],this.duration,n)),t=[...[n,s,o].map(Math.round),Fe(0,i,1)];return{value:t,valueProgress:t.map((e,t)=>0!==this.byValue[t]?Math.abs((e-this.startValue[t])/this.byValue[t]):0).find(e=>0!==e)||0}}}function Yn(e){const t=(e=>Array.isArray(e.startValue)||Array.isArray(e.endValue))(e)?new ur(e):new ar(e);return t.start(),t}function Po(e){const t=new br(e);return t.start(),t}class h{constructor(e){this.status=e,this.points=[]}includes(e){return this.points.some(t=>t.eq(e))}append(){for(var t=arguments.length,n=new Array(t),e=0;e<t;e++)n[e]=arguments[e];return this.points=this.points.concat(n.filter(e=>!this.includes(e))),this}static isPointContained(e,t,n){let s=arguments.length>3&&0[0]!==arguments[3]&&arguments[3];if(t.eq(n))return e.eq(t);if(t.x===n.x)return e.x===t.x&&(s||e.y>=Math.min(t.y,n.y)&&e.y<=Math.max(t.y,n.y));if(t.y===n.y)return e.y===t.y&&(s||e.x>=Math.min(t.x,n.x)&&e.x<=Math.max(t.x,n.x));{const i=gn(t,n),o=gn(t,e).divide(i);return s?Math.abs(o.x)===Math.abs(o.y):o.x===o.y&&o.x>=0&&o.x<=1}}static isPointInPolygon(e,t){const o=new s(e).setX(Math.min(e.x-1,...t.map(e=>e.x)));let n=0;for(let s=0;s<t.length;s++){const i=this.intersectSegmentSegment(t[s],t[(s+1)%t.length],e,o);if(i.includes(e))return!0;n+=Number("Intersection"===i.status)}return n%2==1}static intersectLineLine(e,t,n,o){let c=!(arguments.length>4&&0[0]!==arguments[4])||arguments[4],l=!(arguments.length>5&&0[0]!==arguments[5])||arguments[5];const i=t.x-e.x,a=t.y-e.y,d=o.x-n.x,u=o.y-n.y,m=e.x-n.x,f=e.y-n.y,p=d*f-u*m,g=i*f-a*m,r=u*i-d*a;if(0!==r){const t=p/r,n=g/r;return(c||0<=t&&t<=1)&&(l||0<=n&&n<=1)?new h("Intersection").append(new s(e.x+t*i,e.y+t*a)):new h}if(0===p||0===g){const s=c||l||h.isPointContained(e,n,o)||h.isPointContained(t,n,o)||h.isPointContained(n,e,t)||h.isPointContained(o,e,t);return new h(s?"Coincident":0[0])}return new h("Parallel")}static intersectSegmentLine(e,t,n,s){return h.intersectLineLine(e,t,n,s,!1,!0)}static intersectSegmentSegment(e,t,n,s){return h.intersectLineLine(e,t,n,s,!1,!1)}static intersectLinePolygon(e,t,n){let i=!(arguments.length>3&&0[0]!==arguments[3])||arguments[3];const s=new h,o=n.length;for(let c,l,a,r=0;r<o;r++){if(c=n[r],l=n[(r+1)%o],a=h.intersectLineLine(e,t,c,l,i,!1),"Coincident"===a.status)return a;s.append(...a.points)}return s.points.length>0&&(s.status="Intersection"),s}static intersectSegmentPolygon(e,t,n){return h.intersectLinePolygon(e,t,n,!1)}static intersectPolygonPolygon(e,t){const n=new h,o=e.length,s=[];for(let i=0;i<o;i++){const r=e[i],c=e[(i+1)%o],a=h.intersectSegmentPolygon(r,c,t);"Coincident"===a.status?(s.push(a),n.append(r,c)):n.append(...a.points)}return s.length>0&&s.length===e.length?new h("Coincident"):(n.points.length>0&&(n.status="Intersection"),n)}static intersectPolygonRectangle(e,t,n){const o=t.min(n),i=t.max(n),a=new s(i.x,o.y),r=new s(o.x,i.y);return h.intersectPolygonPolygon(e,[o,a,i,r])}}class jr extends mo{getX(){return this.getXY().x}setX(e){this.setXY(this.getXY().setX(e))}getY(){return this.getXY().y}setY(e){this.setXY(this.getXY().setY(e))}getRelativeX(){return this.left}setRelativeX(e){this.left=e}getRelativeY(){return this.top}setRelativeY(e){this.top=e}getXY(){const e=this.getRelativeXY();return this.group?j(e,this.group.calcTransformMatrix()):e}setXY(e,t,n){this.group&&(e=j(e,k(this.group.calcTransformMatrix()))),this.setRelativeXY(e,t,n)}getRelativeXY(){return new s(this.left,this.top)}setRelativeXY(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:this.originX,n=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:this.originY;this.setPositionByOrigin(e,t,n)}isStrokeAccountedForInDimensions(){return!1}getCoords(){const{tl:t,tr:n,br:s,bl:o}=this.aCoords||(this.aCoords=this.calcACoords()),e=[t,n,s,o];if(this.group){const t=this.group.calcTransformMatrix();return e.map(e=>j(e,t))}return e}intersectsWithRect(e,t){return"Intersection"===h.intersectPolygonRectangle(this.getCoords(),e,t).status}intersectsWithObject(e){const t=h.intersectPolygonPolygon(this.getCoords(),e.getCoords());return"Intersection"===t.status||"Coincident"===t.status||e.isContainedWithinObject(this)||this.isContainedWithinObject(e)}isContainedWithinObject(e){return this.getCoords().every(t=>e.containsPoint(t))}isContainedWithinRect(e,t){const{left:n,top:s,width:o,height:i}=this.getBoundingRect();return n>=e.x&&n+o<=t.x&&s>=e.y&&s+i<=t.y}isOverlapping(e){return this.intersectsWithObject(e)||this.isContainedWithinObject(e)||e.isContainedWithinObject(this)}containsPoint(e){return h.isPointInPolygon(e,this.getCoords())}isOnScreen(){if(!this.canvas)return!1;const{tl:e,br:t}=this.canvas.vptCoords;return!!this.getCoords().some(n=>n.x<=t.x&&n.x>=e.x&&n.y<=t.y&&n.y>=e.y)||!!this.intersectsWithRect(e,t)||this.containsPoint(e.midPointFrom(t))}isPartiallyOnScreen(){if(!this.canvas)return!1;const{tl:e,br:t}=this.canvas.vptCoords;return!!this.intersectsWithRect(e,t)||this.getCoords().every(n=>(n.x>=t.x||n.x<=e.x)&&(n.y>=t.y||n.y<=e.y))&&this.containsPoint(e.midPointFrom(t))}getBoundingRect(){return te(this.getCoords())}getScaledWidth(){return this._getTransformedDimensions().x}getScaledHeight(){return this._getTransformedDimensions().y}scale(e){this._set(O,e),this._set(z,e),this.setCoords()}scaleToWidth(e){const t=this.getBoundingRect().width/this.getScaledWidth();return this.scale(e/this.width/t)}scaleToHeight(e){const t=this.getBoundingRect().height/this.getScaledHeight();return this.scale(e/this.height/t)}getCanvasRetinaScaling(){var e;return(null===(e=this.canvas)||0[0]===e?0[0]:e.getRetinaScaling())||1}getTotalAngle(){return this.group?Z(bo(this.calcTransformMatrix())):this.angle}getViewportTransform(){var e;return(null===(e=this.canvas)||0[0]===e?0[0]:e.viewportTransform)||_.concat()}calcACoords(){const o=Me({angle:this.angle}),{x:i,y:a}=this.getRelativeCenterPoint(),r=Ue(i,a),e=u(r,o),s=this._getTransformedDimensions(),t=s.x/2,n=s.y/2;return{tl:j({x:-t,y:-n},e),tr:j({x:t,y:-n},e),bl:j({x:-t,y:n},e),br:j({x:t,y:n},e)}}setCoords(){this.aCoords=this.calcACoords()}transformMatrixKey(){let t=arguments.length>0&&0[0]!==arguments[0]&&arguments[0],e=[];return!t&&this.group&&(e=this.group.transformMatrixKey(t)),e.push(this.top,this.left,this.width,this.height,this.scaleX,this.scaleY,this.angle,this.strokeWidth,this.skewX,this.skewY,+this.flipX,+this.flipY,g(this.originX),g(this.originY)),e}calcTransformMatrix(){let n=arguments.length>0&&0[0]!==arguments[0]&&arguments[0],e=this.calcOwnMatrix();if(n||!this.group)return e;const s=this.transformMatrixKey(n),t=this.matrixCache;return t&&t.key.every((e,t)=>e===s[t])?t.value:(this.group&&(e=u(this.group.calcTransformMatrix(!1),e)),this.matrixCache={key:s,value:e},e)}calcOwnMatrix(){const t=this.transformMatrixKey(!0),e=this.ownMatrixCache;if(e&&e.key===t)return e.value;const n=this.getRelativeCenterPoint(),o={angle:this.angle,translateX:n.x,translateY:n.y,scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY},s=_o(o);return this.ownMatrixCache={key:t,value:s},s}_getNonTransformedDimensions(){return new s(this.width,this.height).scalarAdd(this.strokeWidth)}_calculateCurrentDimensions(e){return this._getTransformedDimensions(e).transform(this.getViewportTransform(),!0).scalarAdd(2*this.padding)}_getTransformedDimensions(){let l=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};const e=n({scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,width:this.width,height:this.height,strokeWidth:this.strokeWidth},l),o=e.strokeWidth;let t=o,i=0;this.strokeUniform&&(t=0,i=o);const a=e.width+t,r=e.height+t;let c;return c=0===e.skewX&&0===e.skewY?new s(a*e.scaleX,r*e.scaleY):zt(a,r,gt(e)),c.scalarAdd(i)}translateToGivenOrigin(e,t,n,o,i){let a=e.x,r=e.y;const c=g(o)-g(t),l=g(i)-g(n);if(c||l){const e=this._getTransformedDimensions();a+=c*e.x,r+=l*e.y}return new s(a,r)}translateToCenterPoint(e,t,n){if(t===i&&n===i)return e;const s=this.translateToGivenOrigin(e,t,n,i,i);return this.angle?s.rotate(m(this.angle),e):s}translateToOriginPoint(e,t,n){const s=this.translateToGivenOrigin(e,i,i,t,n);return this.angle?s.rotate(m(this.angle),e):s}getCenterPoint(){const e=this.getRelativeCenterPoint();return this.group?j(e,this.group.calcTransformMatrix()):e}getRelativeCenterPoint(){return this.translateToCenterPoint(new s(this.left,this.top),this.originX,this.originY)}getPointByOrigin(e,t){return this.translateToOriginPoint(this.getRelativeCenterPoint(),e,t)}setPositionByOrigin(e,t,n){const o=this.translateToCenterPoint(e,t,n),s=this.translateToOriginPoint(o,this.originX,this.originY);this.set({left:s.x,top:s.y})}_getLeftTopCoords(){return this.translateToOriginPoint(this.getRelativeCenterPoint(),c,A)}}const yr=["type"],_r=["extraParam"];let Q=class t4 extends jr{static getDefaults(){return t4.ownDefaults}get type(){const e=this.constructor.type;return"FabricObject"===e?"object":e.toLowerCase()}set type(e){ie("warn","Setting type has no effect",e)}constructor(e){super(),t(this,"_cacheContext",null),Object.assign(this,t4.ownDefaults),this.setOptions(e)}_createCacheCanvas(){this._cacheCanvas=N(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0}_limitCacheSize(e){const t=e.width,n=e.height,o=a.maxCacheSideLimit,s=a.minCacheSideLimit;if(t<=o&&n<=o&&t*n<=a.perfLimitSizeTotal)return t<s&&(e.width=s),n<s&&(e.height=s),e;const c=t/n,[l,d]=Be.limitDimsByArea(c),i=Fe(s,l,o),r=Fe(s,d,o);return t>i&&(e.zoomX/=t/i,e.width=i,e.capped=!0),n>r&&(e.zoomY/=n/r,e.height=r,e.capped=!0),e}_getCacheCanvasDimensions(){const e=this.getTotalObjectScaling(),t=this._getTransformedDimensions({skewX:0,skewY:0}),n=t.x*e.x/this.scaleX,s=t.y*e.y/this.scaleY;return{width:Math.ceil(n+2),height:Math.ceil(s+2),zoomX:e.x,zoomY:e.y,x:n,y:s}}_updateCacheCanvas(){const e=this._cacheCanvas,t=this._cacheContext,{width:n,height:s,zoomX:o,zoomY:i,x:a,y:r}=this._limitCacheSize(this._getCacheCanvasDimensions()),c=n!==e.width||s!==e.height,l=this.zoomX!==o||this.zoomY!==i;if(!e||!t)return!1;if(c||l){n!==e.width||s!==e.height?(e.width=n,e.height=s):(t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,e.width,e.height));const c=a/2,l=r/2;return this.cacheTranslationX=Math.round(e.width/2-c)+c,this.cacheTranslationY=Math.round(e.height/2-l)+l,t.translate(this.cacheTranslationX,this.cacheTranslationY),t.scale(o,i),this.zoomX=o,this.zoomY=i,!0}return!1}setOptions(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};this._setOptions(e)}transform(e){const n=this.group&&!this.group._transformDone||this.group&&this.canvas&&e===this.canvas.contextTop,t=this.calcTransformMatrix(!n);e.transform(t[0],t[1],t[2],t[3],t[4],t[5])}getObjectScaling(){if(!this.group)return new s(Math.abs(this.scaleX),Math.abs(this.scaleY));const e=Ae(this.calcTransformMatrix());return new s(Math.abs(e.scaleX),Math.abs(e.scaleY))}getTotalObjectScaling(){const e=this.getObjectScaling();if(this.canvas){const t=this.canvas.getZoom(),n=this.getCanvasRetinaScaling();return e.scalarMultiply(t*n)}return e}getObjectOpacity(){let e=this.opacity;return this.group&&(e*=this.group.getObjectOpacity()),e}_constrainScale(e){return(e<0?-e:e)<this.minScaleLimit?e<0?-this.minScaleLimit:this.minScaleLimit:0===e?1e-4:e}_set(e,t){e!==O&&e!==z||(t=this._constrainScale(t)),e===O&&t<0?(this.flipX=!this.flipX,t*=-1):"scaleY"===e&&t<0?(this.flipY=!this.flipY,t*=-1):"shadow"!==e||!t||t instanceof R||(t=new R(t));const n=this[e]!==t;return this[e]=t,n&&this.constructor.cacheProperties.includes(e)&&(this.dirty=!0),this.parent&&(this.dirty||n&&this.constructor.stateProperties.includes(e))&&this.parent._set("dirty",!0),this}isNotVisible(){return 0===this.opacity||!this.width&&!this.height&&0===this.strokeWidth||!this.visible}render(e){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(e.save(),this._setupCompositeOperation(e),this.drawSelectionBackground(e),this.transform(e),this._setOpacity(e),this._setShadow(e),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(e)):(this._removeCacheCanvas(),this.drawObject(e,!1,{}),this.dirty=!1),e.restore())}drawSelectionBackground(){}renderCache(e){if(e=e||{},this._cacheCanvas&&this._cacheContext||this._createCacheCanvas(),this.isCacheDirty()&&this._cacheContext){const{zoomX:t,zoomY:n,cacheTranslationX:s,cacheTranslationY:o}=this,{width:i,height:a}=this._cacheCanvas;this.drawObject(this._cacheContext,e.forClipping,{zoomX:t,zoomY:n,cacheTranslationX:s,cacheTranslationY:o,width:i,height:a,parentClipPaths:[]}),this.dirty=!1}}_removeCacheCanvas(){this._cacheCanvas=0[0],this._cacheContext=null}hasStroke(){return this.stroke&&"transparent"!==this.stroke&&0!==this.strokeWidth}hasFill(){return this.fill&&"transparent"!==this.fill}needsItsOwnCache(){return!!(this.paintFirst===C&&this.hasFill()&&this.hasStroke()&&this.shadow)||!!this.clipPath}shouldCache(){return this.ownCaching=this.objectCaching&&(!this.parent||!this.parent.isOnACache())||this.needsItsOwnCache(),this.ownCaching}willDrawShadow(){return!!this.shadow&&(0!==this.shadow.offsetX||0!==this.shadow.offsetY)}drawClipPathOnCache(e,t,n){e.save(),t.inverted?e.globalCompositeOperation="destination-out":e.globalCompositeOperation="destination-in",e.setTransform(1,0,0,1,0,0),e.drawImage(n,0,0),e.restore()}drawObject(e,t,n){const s=this.fill,o=this.stroke;t?(this.fill="black",this.stroke="",this._setClippingProperties(e)):this._renderBackground(e),this._render(e),this._drawClipPath(e,this.clipPath,n),this.fill=s,this.stroke=o}createClipPathLayer(e,t){const s=M(t),n=s.getContext("2d");if(n.translate(t.cacheTranslationX,t.cacheTranslationY),n.scale(t.zoomX,t.zoomY),e._cacheCanvas=s,t.parentClipPaths.forEach(e=>{e.transform(n)}),t.parentClipPaths.push(e),e.absolutePositioned){const e=k(this.calcTransformMatrix());n.transform(e[0],e[1],e[2],e[3],e[4],e[5])}return e.transform(n),e.drawObject(n,!0,t),s}_drawClipPath(e,t,n){if(!t)return;t._transformDone=!0;const s=this.createClipPathLayer(t,n);this.drawClipPathOnCache(e,t,s)}drawCacheOnCanvas(e){e.scale(1/this.zoomX,1/this.zoomY),e.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)}isCacheDirty(){let n=arguments.length>0&&0[0]!==arguments[0]&&arguments[0];if(this.isNotVisible())return!1;const t=this._cacheCanvas,e=this._cacheContext;return!(!t||!e||n||!this._updateCacheCanvas())||!!(this.dirty||this.clipPath&&this.clipPath.absolutePositioned)&&(t&&e&&!n&&(e.save(),e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,t.width,t.height),e.restore()),!0)}_renderBackground(e){if(!this.backgroundColor)return;const t=this._getNonTransformedDimensions();e.fillStyle=this.backgroundColor,e.fillRect(-t.x/2,-t.y/2,t.x,t.y),this._removeShadow(e)}_setOpacity(e){this.group&&!this.group._transformDone?e.globalAlpha=this.getObjectOpacity():e.globalAlpha*=this.opacity}_setStrokeStyles(e,t){const n=t.stroke;n&&(e.lineWidth=t.strokeWidth,e.lineCap=t.strokeLineCap,e.lineDashOffset=t.strokeDashOffset,e.lineJoin=t.strokeLineJoin,e.miterLimit=t.strokeMiterLimit,D(n)?"percentage"===n.gradientUnits||n.gradientTransform||n.patternTransform?this._applyPatternForTransformedGradient(e,n):(e.strokeStyle=n.toLive(e),this._applyPatternGradientTransform(e,n)):e.strokeStyle=t.stroke)}_setFillStyles(e,t){let{fill:n}=t;n&&(D(n)?(e.fillStyle=n.toLive(e),this._applyPatternGradientTransform(e,n)):e.fillStyle=n)}_setClippingProperties(e){e.globalAlpha=1,e.strokeStyle="transparent",e.fillStyle="#000000"}_setLineDash(e,t){t&&0!==t.length&&e.setLineDash(t)}_setShadow(e){if(!this.shadow)return;const t=this.shadow,o=this.canvas,i=this.getCanvasRetinaScaling(),[l,,,d]=o?.viewportTransform||_,r=l*i,c=d*i,n=t.nonScaling?new s(1,1):this.getObjectScaling();e.shadowColor=t.color,e.shadowBlur=t.blur*a.browserShadowBlurConstant*(r+c)*(n.x+n.y)/4,e.shadowOffsetX=t.offsetX*r*n.x,e.shadowOffsetY=t.offsetY*c*n.y}_removeShadow(e){this.shadow&&(e.shadowColor="",e.shadowBlur=e.shadowOffsetX=e.shadowOffsetY=0)}_applyPatternGradientTransform(e,t){if(!D(t))return{offsetX:0,offsetY:0};const n=t.gradientTransform||t.patternTransform,s=-this.width/2+t.offsetX||0,o=-this.height/2+t.offsetY||0;return"percentage"===t.gradientUnits?e.transform(this.width,0,0,this.height,s,o):e.transform(1,0,0,1,s,o),n&&e.transform(n[0],n[1],n[2],n[3],n[4],n[5]),{offsetX:s,offsetY:o}}_renderPaintInOrder(e){this.paintFirst===C?(this._renderStroke(e),this._renderFill(e)):(this._renderFill(e),this._renderStroke(e))}_render(){}_renderFill(e){this.fill&&(e.save(),this._setFillStyles(e,this),"evenodd"===this.fillRule?e.fill("evenodd"):e.fill(),e.restore())}_renderStroke(e){if(this.stroke&&0!==this.strokeWidth){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(e),e.save(),this.strokeUniform){const t=this.getObjectScaling();e.scale(1/t.x,1/t.y)}this._setLineDash(e,this.strokeDashArray),this._setStrokeStyles(e,this),e.stroke(),e.restore()}}_applyPatternForTransformedGradient(e,t){var r;const s=this._limitCacheSize(this._getCacheCanvasDimensions()),o=this.getCanvasRetinaScaling(),i=s.x/this.scaleX/o,a=s.y/this.scaleY/o,c=M({width:Math.ceil(i),height:Math.ceil(a)}),n=c.getContext("2d");n&&(n.beginPath(),n.moveTo(0,0),n.lineTo(i,0),n.lineTo(i,a),n.lineTo(0,a),n.closePath(),n.translate(i/2,a/2),n.scale(s.zoomX/this.scaleX/o,s.zoomY/this.scaleY/o),this._applyPatternGradientTransform(n,t),n.fillStyle=t.toLive(e),n.fill(),e.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),e.scale(o*this.scaleX/s.zoomX,o*this.scaleY/s.zoomY),e.strokeStyle=null!==(r=n.createPattern(c,"no-repeat"))&&0[0]!==r?r:"")}_findCenterFromElement(){return new s(this.left+this.width/2,this.top+this.height/2)}clone(e){const t=this.toObject(e);return this.constructor.fromObject(t)}cloneAsImage(e){const t=this.toCanvasElement(e);return new(o.getClass("image"))(t)}toCanvasElement(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};const g=Gn(this),l=this.group,m=this.shadow,a=Math.abs,h=e.enableRetinaScaling?Ks():1,d=(e.multiplier||1)*h,u=e.canvasProvider||(e=>new nt(e,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1}));delete this.group,e.withoutTransform&&ai(this),e.withoutShadow&&(this.shadow=null),e.viewportTransform&&rs(this,this.getViewportTransform()),this.setCoords();const r=N(),c=this.getBoundingRect(),n=this.shadow,o=new s;if(n){const e=n.blur,t=n.nonScaling?new s(1,1):this.getObjectScaling();o.x=2*Math.round(a(n.offsetX)+e)*a(t.x),o.y=2*Math.round(a(n.offsetY)+e)*a(t.y)}const f=c.width+o.x,p=c.height+o.y;r.width=Math.ceil(f),r.height=Math.ceil(p);const t=u(r);"jpeg"===e.format&&(t.backgroundColor="#fff"),this.setPositionByOrigin(new s(t.width/2,t.height/2),i,i);const v=this.canvas;t._objects=[this],this.set("canvas",t),this.setCoords();const b=t.toCanvasElement(d||1,e);return this.set("canvas",v),this.shadow=m,l&&(this.group=l),this.set(g),this.setCoords(),t._objects=[],t.destroy(),b}toDataURL(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};return Jn(this.toCanvasElement(e),e.format||"png",e.quality||1)}toBlob(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};return Xn(this.toCanvasElement(e),e.format||"png",e.quality||1)}isType(){for(var n=arguments.length,t=new Array(n),e=0;e<n;e++)t[e]=arguments[e];return t.includes(this.constructor.type)||t.includes(this.type)}complexity(){return 1}toJSON(){return this.toObject()}rotate(e){const{centeredRotation:t,originX:n,originY:s}=this;if(t){const{x:e,y:t}=this.getRelativeCenterPoint();this.originX=i,this.originY=i,this.left=e,this.top=t}if(this.set("angle",e),t){const{x:e,y:t}=this.translateToOriginPoint(this.getRelativeCenterPoint(),n,s);this.left=e,this.top=t,this.originX=n,this.originY=s}}setOnGroup(){}_setupCompositeOperation(e){this.globalCompositeOperation&&(e.globalCompositeOperation=this.globalCompositeOperation)}dispose(){Ot.cancelByTarget(this),this.off(),this._set("canvas",0[0]),this._cacheCanvas&&W().dispose(this._cacheCanvas),this._cacheCanvas=0[0],this._cacheContext=null}animate(e,t){return Object.entries(e).reduce((e,n)=>{let[s,o]=n;return e[s]=this._animate(s,o,t),e},{})}_animate(e,t){let o=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:{};const s=e.split("."),d=this.constructor.colorProperties.includes(s[s.length-1]),{abort:i,startValue:a,onChange:r,onComplete:c}=o,l=n(n({},o),{},{target:this,startValue:a??s.reduce((e,t)=>e[t],this),endValue:t,abort:i?.bind(this),onChange:(e,t,n)=>{s.reduce((t,n,o)=>(o===s.length-1&&(t[n]=e),t[n]),this),r&&r(e,t,n)},onComplete:(e,t,n)=>{this.setCoords(),c&&c(e,t,n)}});return d?Po(l):Yn(l)}isDescendantOf(e){const{parent:t,group:n}=this;return t===e||n===e||!!t&&t.isDescendantOf(e)||!!n&&n!==t&&n.isDescendantOf(e)}getAncestors(){const t=[];let e=this;do e=e.parent,e&&t.push(e);while(e)return t}findCommonAncestors(e){if(this===e)return{fork:[],otherFork:[],common:[this,...this.getAncestors()]};const n=this.getAncestors(),t=e.getAncestors();if(0===n.length&&t.length>0&&this===t[t.length-1])return{fork:[],otherFork:[e,...t.slice(0,t.length-1)],common:[this]};for(let o,s=0;s<n.length;s++){if(o=n[s],o===e)return{fork:[this,...n.slice(0,s)],otherFork:[],common:n.slice(s)};for(let i=0;i<t.length;i++){if(this===t[i])return{fork:[],otherFork:[e,...t.slice(0,i)],common:[this,...n]};if(o===t[i])return{fork:[this,...n.slice(0,s)],otherFork:[e,...t.slice(0,i)],common:n.slice(s)}}}return{fork:[this,...n],otherFork:[e,...t],common:[]}}hasCommonAncestors(e){const t=this.findCommonAncestors(e);return t&&!!t.common.length}isInFrontOf(e){if(this===e)return;const t=this.findCommonAncestors(e);if(t.fork.includes(e))return!0;if(t.otherFork.includes(this))return!1;const n=t.common[0]||this.canvas;if(!n)return;const o=t.fork.pop(),i=t.otherFork.pop(),s=n._objects.indexOf(o),a=n._objects.indexOf(i);return s>-1&&s>a}toObject(){const d=(arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[]).concat(t4.customProperties,this.constructor.customProperties||[]);let t;const R=a.NUM_FRACTION_DIGITS,{clipPath:s,fill:o,stroke:i,shadow:r,strokeDashArray:c,left:L,top:j,originX:C,originY:f,width:p,height:g,strokeWidth:v,strokeLineCap:b,strokeDashOffset:h,strokeLineJoin:y,strokeUniform:_,strokeMiterLimit:w,scaleX:O,scaleY:x,angle:m,flipX:E,flipY:k,opacity:A,visible:S,backgroundColor:M,fillRule:F,paintFirst:T,globalCompositeOperation:z,skewX:D,skewY:N}=this;s&&!s.excludeFromExport&&(t=s.toObject(d.concat("inverted","absolutePositioned")));const e=e=>l(e,R),u=n(n({},Ce(this,d)),{},{type:this.constructor.type,version:Ht,originX:C,originY:f,left:e(L),top:e(j),width:e(p),height:e(g),fill:wo(o)?o.toObject():o,stroke:wo(i)?i.toObject():i,strokeWidth:e(v),strokeDashArray:c&&c.concat(),strokeLineCap:b,strokeDashOffset:h,strokeLineJoin:y,strokeUniform:_,strokeMiterLimit:e(w),scaleX:e(O),scaleY:e(x),angle:e(m),flipX:E,flipY:k,opacity:e(A),shadow:r&&r.toObject(),visible:S,backgroundColor:M,fillRule:F,paintFirst:T,globalCompositeOperation:z,skewX:e(D),skewY:e(N)},t?{clipPath:t}:null);return this.includeDefaultValues?u:this._removeDefaultValues(u)}toDatalessObject(e){return this.toObject(e)}_removeDefaultValues(e){const t=this.constructor.getDefaults(),n=Object.keys(t).length>0?t:Object.getPrototypeOf(this);return zn(e,(e,t)=>{if(t===c||t===A||"type"===t)return!0;const s=n[t];return e!==s&&!(Array.isArray(e)&&Array.isArray(s)&&0===e.length&&0===s.length)})}toString(){return"#<".concat(this.constructor.type,">")}static _fromObject(e){let n=d(e,yr),s=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{},{extraParam:t}=s,o=d(s,_r);return vt(n,o).then(e=>t?(delete e[t],new this(n[t],e)):new this(e))}static fromObject(e,t){return this._fromObject(e,t)}};t(Q,"stateProperties",Ra),t(Q,"cacheProperties",se),t(Q,"ownDefaults",Pa),t(Q,"type","FabricObject"),t(Q,"colorProperties",[v,C,"backgroundColor"]),t(Q,"customProperties",[]),o.setClass(Q),o.setClass(Q,"object");const pe=(e,t,s)=>(o,i,a,r)=>{const c=t(o,i,a,r);return c&&ls(e,n(n({},ps(o,i,a,r)),s)),c};function ve(e){return(t,n,s,o)=>{const{target:i,originX:a,originY:r}=n,c=i.getRelativeCenterPoint(),l=i.translateToOriginPoint(c,a,r),d=e(t,n,s,o);return i.setPositionByOrigin(l,n.originX,n.originY),d}}const ss=pe(dt,ve((e,t,n,s)=>{const o=Ut(t,t.originX,t.originY,n,s);if(g(t.originX)===g(i)||g(t.originX)===g(f)&&o.x<0||g(t.originX)===g(c)&&o.x>0){const{target:e}=t,n=e.strokeWidth/(e.strokeUniform?e.scaleX:1),s=mi(t)?2:1,i=e.width,a=Math.abs(o.x*s/e.scaleX)-n;return e.set("width",Math.max(a,1)),i!==e.width}return!1}));function Do(e,t,n,s,o){s=s||{};const i=this.sizeX||s.cornerSize||o.cornerSize,a=this.sizeY||s.cornerSize||o.cornerSize,c=0[0]!==s.transparentCorners?s.transparentCorners:o.transparentCorners,u=c?C:v,h=!c&&(s.cornerStrokeColor||o.cornerStrokeColor);let r,l=t,d=n;e.save(),e.fillStyle=s.cornerColor||o.cornerColor||"",e.strokeStyle=s.cornerStrokeColor||o.cornerStrokeColor||"",i>a?(r=i,e.scale(1,a/i),d=n*i/a):a>i?(r=a,e.scale(i/a,1),l=t*a/i):r=i,e.beginPath(),e.arc(l,d,r/2,0,le,!1),e[u](),h&&e.stroke(),e.restore()}function Fo(e,t,n,s,o){s=s||{};const i=this.sizeX||s.cornerSize||o.cornerSize,a=this.sizeY||s.cornerSize||o.cornerSize,r=0[0]!==s.transparentCorners?s.transparentCorners:o.transparentCorners,d=r?C:v,u=!r&&(s.cornerStrokeColor||o.cornerStrokeColor),c=i/2,l=a/2;e.save(),e.fillStyle=s.cornerColor||o.cornerColor||"",e.strokeStyle=s.cornerStrokeColor||o.cornerStrokeColor||"",e.translate(t,n);const h=o.getTotalAngle();e.rotate(m(h)),e["".concat(d,"Rect")](-c,-l,i,a),u&&e.strokeRect(-c,-l,i,a),e.restore()}class F{constructor(e){t(this,"visible",!0),t(this,"actionName",Qt),t(this,"angle",0),t(this,"x",0),t(this,"y",0),t(this,"offsetX",0),t(this,"offsetY",0),t(this,"sizeX",0),t(this,"sizeY",0),t(this,"touchSizeX",0),t(this,"touchSizeY",0),t(this,"cursorStyle","crosshair"),t(this,"withConnection",!1),Object.assign(this,e)}shouldActivate(e,t,n,s){var o;let{tl:i,tr:a,br:r,bl:c}=s;return(null===(o=t.canvas)||0[0]===o?0[0]:o.getActiveObject())===t&&t.isControlVisible(e)&&h.isPointInPolygon(n,[i,a,r,c])}getActionHandler(){return this.actionHandler}getMouseDownHandler(){return this.mouseDownHandler}getMouseUpHandler(){return this.mouseUpHandler}cursorStyleHandler(e,t){return t.cursorStyle}getActionName(e,t){return t.actionName}getVisibility(e,t){var n,s;return null!==(n=null===(s=e._controlsVisibility)||0[0]===s?0[0]:s[t])&&0[0]!==n?n:this.visible}setVisibility(e){this.visible=e}positionHandler(e,t){return new s(this.x*e.x+this.offsetX,this.y*e.y+this.offsetY).transform(t)}calcCornerCoords(e,t,n,o,i){const r=nn([Ue(n,o),Me({angle:e}),rn((i?this.touchSizeX:this.sizeX)||t,(i?this.touchSizeY:this.sizeY)||t)]);return{tl:new s(-.5,-.5).transform(r),tr:new s(.5,-.5).transform(r),br:new s(.5,.5).transform(r),bl:new s(-.5,.5).transform(r)}}render(e,t,n,s,o){"circle"===((s=s||{}).cornerStyle||o.cornerStyle)?Do.call(this,e,t,n,s,o):Fo.call(this,e,t,n,s,o)}}const Ao=(e,t,n)=>n.lockRotation?Yt:t.cursorStyle,Co=pe(Zs,ve((e,t,n,s)=>{let{target:i,ex:r,ey:c,theta:l,originX:d,originY:u}=t;const a=i.translateToOriginPoint(i.getRelativeCenterPoint(),d,u);if(Y(i,"lockRotation"))return!1;const h=Math.atan2(c-a.y,r-a.x),m=Math.atan2(s-a.y,n-a.x);let o=Z(m-h+l);if(i.snapAngle&&i.snapAngle>0){const e=i.snapAngle,t=i.snapThreshold||e,n=Math.ceil(o/e)*e,s=Math.floor(o/e)*e;Math.abs(o-s)<t?o=s:Math.abs(o-n)<t&&(o=n)}o<0&&(o=360+o),o%=360;const f=i.angle!==o;return i.angle=o,f}));function jo(e,t){const n=t.canvas,s=e[n.uniScaleKey];return n.uniformScaling&&!s||!n.uniformScaling&&s}function ho(e,t,n){const s=Y(e,"lockScalingX"),o=Y(e,"lockScalingY");if(s&&o)return!0;if(!t&&(s||o)&&n)return!0;if(s&&"x"===t)return!0;if(o&&"y"===t)return!0;const{width:a,height:r,strokeWidth:i}=e;return 0===a&&0===i&&"y"!==t||0===r&&0===i&&"x"!==t}const cc=["e","se","s","sw","w","nw","n","ne","e"],Ne=(e,t,n)=>{const s=jo(e,n);if(ho(n,0!==t.x&&0===t.y?"x":0===t.x&&0!==t.y?"y":"",s))return Yt;const o=gi(n,t);return"".concat(cc[o],"-resize")};function fs(e,t,n,s){let m=arguments.length>4&&0[0]!==arguments[4]?arguments[4]:{};const o=t.target,i=m.by,h=jo(e,o);let a,r,c,l,d,u;if(ho(o,i,h))return!1;if(t.gestureScale)r=t.scaleX*t.gestureScale,c=t.scaleY*t.gestureScale;else{if(a=Ut(t,t.originX,t.originY,n,s),d="y"!==i?Math.sign(a.x||t.signX||1):1,u="x"!==i?Math.sign(a.y||t.signY||1):1,t.signX||(t.signX=d),t.signY||(t.signY=u),Y(o,"lockScalingFlip")&&(t.signX!==d||t.signY!==u))return!1;if(l=o._getTransformedDimensions(),h&&!i){const s=Math.abs(a.x)+Math.abs(a.y),{original:e}=t,n=s/(Math.abs(l.x*e.scaleX/o.scaleX)+Math.abs(l.y*e.scaleY/o.scaleY));r=e.scaleX*n,c=e.scaleY*n}else r=Math.abs(a.x*o.scaleX/l.x),c=Math.abs(a.y*o.scaleY/l.y);mi(t)&&(r*=2,c*=2),t.signX!==d&&"y"!==i&&(t.originX=pi(t.originX),r*=-1,t.signX=d),t.signY!==u&&"x"!==i&&(t.originY=pi(t.originY),c*=-1,t.signY=u)}const f=o.scaleX,p=o.scaleY;return i?("x"===i&&o.set(O,r),"y"===i&&o.set(z,c)):(!Y(o,"lockScalingX")&&o.set(O,r),!Y(o,"lockScalingY")&&o.set(z,c)),f!==o.scaleX||p!==o.scaleY}const ft=pe(Kt,ve((e,t,n,s)=>fs(e,t,n,s))),Gs=pe(Kt,ve((e,t,n,s)=>fs(e,t,n,s,{by:"x"}))),Us=pe(Kt,ve((e,t,n,s)=>fs(e,t,n,s,{by:"y"}))),fc=["target","ex","ey","skewingSide"],js={x:{counterAxis:"y",scale:O,skew:Ie,lockSkewing:"lockSkewingX",origin:"originX",flip:"flipX"},y:{counterAxis:"x",scale:z,skew:He,lockSkewing:"lockSkewingY",origin:"originY",flip:"flipY"}},pc=["ns","nesw","ew","nwse"],Hs=(e,t,n)=>{if(0!==t.x&&Y(n,"lockSkewingY"))return Yt;if(0!==t.y&&Y(n,"lockSkewingX"))return Yt;const s=gi(n,t)%4;return"".concat(pc[s],"-resize")};function Ns(e,t,o,a,r){const{target:c}=o,{counterAxis:h,origin:f,lockSkewing:p,skew:l,flip:v}=js[e];if(Y(c,p))return!1;const{origin:b,flip:j}=js[h],y=g(o[b])*(c[j]?-1:1),u=-Math.sign(y)*(c[v]?-1:1),_=.5*-((0===c[l]&&Ut(o,i,i,a,r)[e]>0||c[l]>0?1:-1)*u)+.5,w=pe(eo,ve((t,n,o,i)=>function(e,t,n){let{target:o,ex:j,ey:h,skewingSide:u}=t,l=d(t,fc);const{skew:i}=js[e],c=n.subtract(new s(j,h)).divide(new s(o.scaleX,o.scaleY))[e],r=o[i],f=l[i],p=Math.tan(m(f)),g="y"===e?o._getTransformedDimensions({scaleX:1,scaleY:1,skewX:0}).x:o._getTransformedDimensions({scaleX:1,scaleY:1}).y,v=2*c*u/Math.max(g,1)+p,b=Z(Math.atan(v));o.set(i,b);const a=r!==o[i];if(a&&"y"===e){const{skewX:t,scaleX:n}=o,s=o._getTransformedDimensions({skewY:r}),i=o._getTransformedDimensions(),e=0!==t?s.x/i.x:1;1!==e&&o.set(O,e*n)}return a}(e,n,new s(o,i))));return w(t,n(n({},o),{},{[f]:_,skewingSide:u}),a,r)}const Ds=(e,t,n,s)=>Ns("x",e,t,n,s),zs=(e,t,n,s)=>Ns("y",e,t,n,s);function Rt(e,t){return e[t.canvas.altActionKey]}const _t=(e,t,n)=>{const s=Rt(e,n);return 0===t.x?s?Ie:z:0===t.y?s?He:O:""},je=(e,t,n)=>Rt(e,n)?Hs(0,t,n):Ne(e,t,n),As=(e,t,n,s)=>Rt(e,t.target)?zs(e,t,n,s):Gs(e,t,n,s),Ss=(e,t,n,s)=>Rt(e,t.target)?Ds(e,t,n,s):Us(e,t,n,s),Zn=()=>({ml:new F({x:-.5,y:0,cursorStyleHandler:je,actionHandler:As,getActionName:_t}),mr:new F({x:.5,y:0,cursorStyleHandler:je,actionHandler:As,getActionName:_t}),mb:new F({x:0,y:.5,cursorStyleHandler:je,actionHandler:Ss,getActionName:_t}),mt:new F({x:0,y:-.5,cursorStyleHandler:je,actionHandler:Ss,getActionName:_t}),tl:new F({x:-.5,y:-.5,cursorStyleHandler:Ne,actionHandler:ft}),tr:new F({x:.5,y:-.5,cursorStyleHandler:Ne,actionHandler:ft}),bl:new F({x:-.5,y:.5,cursorStyleHandler:Ne,actionHandler:ft}),br:new F({x:.5,y:.5,cursorStyleHandler:Ne,actionHandler:ft}),mtr:new F({x:0,y:-.5,actionHandler:Co,cursorStyleHandler:Ao,offsetY:-40,withConnection:!0,actionName:hs})}),Bo=()=>({mr:new F({x:.5,y:0,actionHandler:ss,cursorStyleHandler:je,actionName:dt}),ml:new F({x:-.5,y:0,actionHandler:ss,cursorStyleHandler:je,actionName:dt})}),Ts=()=>n(n({},Zn()),Bo());class ht extends Q{static getDefaults(){return n(n({},super.getDefaults()),ht.ownDefaults)}constructor(e){super(),Object.assign(this,this.constructor.createControls(),ht.ownDefaults),this.setOptions(e)}static createControls(){return{controls:Zn()}}_updateCacheCanvas(){const e=this.canvas;if(this.noScaleCache&&e&&e._currentTransform){const t=e._currentTransform,s=t.target,n=t.action;if(this===s&&n&&n.startsWith(Qt))return!1}return super._updateCacheCanvas()}getActiveControl(){const e=this.__corner;return e?{key:e,control:this.controls[e],coord:this.oCoords[e]}:0[0]}findControl(e){let n=arguments.length>1&&0[0]!==arguments[1]&&arguments[1];if(!this.hasControls||!this.canvas)return;this.__corner=0[0];const t=Object.entries(this.oCoords);for(let o=t.length-1;o>=0;o--){const[s,i]=t[o],a=this.controls[s];if(a.shouldActivate(s,this,e,n?i.touchCorner:i.corner))return this.__corner=s,{key:s,control:a,coord:this.oCoords[s]}}}calcOCoords(){const t=this.getViewportTransform(),n=this.getCenterPoint(),o=Ue(n.x,n.y),i=Me({angle:this.getTotalAngle()-(this.group&&this.flipX?180:0)}),a=u(o,i),r=u(t,a),c=u(r,[1/t[0],0,0,1/t[3],0,0]),e=this.group?Ae(this.calcTransformMatrix()):0[0];e&&(e.scaleX=Math.abs(e.scaleX),e.scaleY=Math.abs(e.scaleY));const l=this._calculateCurrentDimensions(e),s={};return this.forEachControl((e,t)=>{const n=e.positionHandler(l,c,this,e);s[t]=Object.assign(n,this._calcCornerCoords(e,n))}),s}_calcCornerCoords(e,t){const n=this.getTotalAngle();return{corner:e.calcCornerCoords(n,this.cornerSize,t.x,t.y,!1,this),touchCorner:e.calcCornerCoords(n,this.touchCornerSize,t.x,t.y,!0,this)}}setCoords(){super.setCoords(),this.canvas&&(this.oCoords=this.calcOCoords())}forEachControl(e){for(const t in this.controls)e(this.controls[t],t,this)}drawSelectionBackground(e){if(!this.selectionBackgroundColor||this.canvas&&this.canvas._activeObject!==this)return;e.save();const n=this.getRelativeCenterPoint(),t=this._calculateCurrentDimensions(),s=this.getViewportTransform();e.translate(n.x,n.y),e.scale(1/s[0],1/s[3]),e.rotate(m(this.angle)),e.fillStyle=this.selectionBackgroundColor,e.fillRect(-t.x/2,-t.y/2,t.x,t.y),e.restore()}strokeBorders(e,t){e.strokeRect(-t.x/2,-t.y/2,t.x,t.y)}_drawBorders(e,t){let o=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:{};const s=n({hasControls:this.hasControls,borderColor:this.borderColor,borderDashArray:this.borderDashArray},o);e.save(),e.strokeStyle=s.borderColor,this._setLineDash(e,s.borderDashArray),this.strokeBorders(e,t),s.hasControls&&this.drawControlsConnectingLines(e,t),e.restore()}_renderControls(e){let s=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};const{hasBorders:i,hasControls:a}=this,o=n({hasBorders:i,hasControls:a},s),r=this.getViewportTransform(),c=o.hasBorders,l=o.hasControls,d=u(r,this.calcTransformMatrix()),t=Ae(d);e.save(),e.translate(t.translateX,t.translateY),e.lineWidth=this.borderScaleFactor,this.group===this.parent&&(e.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),this.flipX&&(t.angle-=180),e.rotate(m(this.group?t.angle:this.angle)),c&&this.drawBorders(e,t,s),l&&this.drawControls(e,s),e.restore()}drawBorders(e,t,n){let o;if(n&&n.forActiveSelection||this.group){const e=zt(this.width,this.height,gt(t)),n=this.isStrokeAccountedForInDimensions()?os:(this.strokeUniform?(new s).scalarAdd(this.canvas?this.canvas.getZoom():1):new s(t.scaleX,t.scaleY)).scalarMultiply(this.strokeWidth);o=e.add(n).scalarAdd(this.borderScaleFactor).scalarAdd(2*this.padding)}else o=this._calculateCurrentDimensions().scalarAdd(this.borderScaleFactor);this._drawBorders(e,o,n)}drawControlsConnectingLines(e,t){let n=!1;e.beginPath(),this.forEachControl((s,o)=>{s.withConnection&&s.getVisibility(this,o)&&(n=!0,e.moveTo(s.x*t.x,s.y*t.y),e.lineTo(s.x*t.x+s.offsetX,s.y*t.y+s.offsetY))}),n&&e.stroke()}drawControls(e){let o=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};e.save();const s=this.getCanvasRetinaScaling(),{cornerStrokeColor:i,cornerDashArray:a,cornerColor:r}=this,t=n({cornerStrokeColor:i,cornerDashArray:a,cornerColor:r},o);e.setTransform(s,0,0,s,0,0),e.strokeStyle=e.fillStyle=t.cornerColor,this.transparentCorners||(e.strokeStyle=t.cornerStrokeColor),this._setLineDash(e,t.cornerDashArray),this.forEachControl((n,s)=>{if(n.getVisibility(this,s)){const o=this.oCoords[s];n.render(e,o.x,o.y,t,this)}}),e.restore()}isControlVisible(e){return this.controls[e]&&this.controls[e].getVisibility(this,e)}setControlVisible(e,t){this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[e]=t}setControlsVisibility(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};Object.entries(e).forEach(e=>{let[t,n]=e;return this.setControlVisible(t,n)})}clearContextTop(e){if(!this.canvas)return;const t=this.canvas.contextTop;if(!t)return;const n=this.canvas.viewportTransform;t.save(),t.transform(n[0],n[1],n[2],n[3],n[4],n[5]),this.transform(t);const s=this.width+4,o=this.height+4;return t.clearRect(-s/2,-o/2,s,o),e||t.restore(),t}onDeselect(){return!1}onSelect(){return!1}shouldStartDragging(){return!1}onDragStart(){return!1}canDrop(){return!1}renderDragSourceEffect(){}renderDropTargetEffect(){}}function Ms(e,t){return t.forEach(t=>{Object.getOwnPropertyNames(t.prototype).forEach(n=>{"constructor"!==n&&Object.defineProperty(e.prototype,n,Object.getOwnPropertyDescriptor(t.prototype,n)||Object.create(null))})}),e}t(ht,"ownDefaults",{noScaleCache:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,cornerSize:13,touchCornerSize:24,transparentCorners:!0,cornerColor:"rgb(178,204,255)",cornerStrokeColor:"",cornerStyle:"rect",cornerDashArray:null,hasControls:!0,borderColor:"rgb(178,204,255)",borderDashArray:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,hasBorders:!0,selectionBackgroundColor:"",selectable:!0,evented:!0,perPixelTargetFind:!1,activeOn:"down",hoverCursor:null,moveCursor:null});class b extends ht{}Ms(b,[Bi]),o.setClass(b),o.setClass(b,"object");const Ls=(e,t,n,s)=>{const o=2*(s=Math.round(s))+1,{data:i}=e.getImageData(t-s,n-s,o,o);for(let e=3;e<i.length;e+=4)if(i[e]>0)return!1;return!0};class Rs{constructor(e){this.options=e,this.strokeProjectionMagnitude=this.options.strokeWidth/2,this.scale=new s(this.options.scaleX,this.options.scaleY),this.strokeUniformScalar=this.options.strokeUniform?new s(1/this.options.scaleX,1/this.options.scaleY):new s(1,1)}createSideVector(e,t){const n=gn(e,t);return this.options.strokeUniform?n.multiply(this.scale):n}projectOrthogonally(e,t,n){return this.applySkew(e.add(this.calcOrthogonalProjection(e,t,n)))}isSkewed(){return 0!==this.options.skewX||0!==this.options.skewY}applySkew(e){const t=new s(e);return t.y+=t.x*Math.tan(m(this.options.skewY)),t.x+=t.y*Math.tan(m(this.options.skewX)),t}scaleUnitVector(e,t){return e.multiply(this.strokeUniformScalar).scalarMultiply(t)}}const gc=new s;class tt extends Rs{static getOrthogonalRotationFactor(e,t){const n=t?bn(e,t):Ri(e);return(n<0?-n:n)<ge?-1:1}constructor(e,n,o,i){super(i),t(this,"AB",0[0]),t(this,"AC",0[0]),t(this,"alpha",0[0]),t(this,"bisector",0[0]),this.A=new s(e),this.B=new s(n),this.C=new s(o),this.AB=this.createSideVector(this.A,this.B),this.AC=this.createSideVector(this.A,this.C),this.alpha=bn(this.AB,this.AC),this.bisector=Dt(Mn(this.AB.eq(gc)?this.AC:this.AB,this.alpha/2))}calcOrthogonalProjection(e,t){let s=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:this.strokeProjectionMagnitude;const o=this.createSideVector(e,t),n=Qn(o),i=tt.getOrthogonalRotationFactor(n,this.bisector);return this.scaleUnitVector(n,s*i)}projectBevel(){const e=[];return(this.alpha%le==0?[this.B]:[this.B,this.C]).forEach(t=>{e.push(this.projectOrthogonally(this.A,t)),e.push(this.projectOrthogonally(this.A,t,-this.strokeProjectionMagnitude))}),e}projectMiter(){const e=[],n=Math.abs(this.alpha),s=1/Math.sin(n/2),t=this.scaleUnitVector(this.bisector,-this.strokeProjectionMagnitude*s),o=this.options.strokeUniform?vn(this.scaleUnitVector(this.bisector,this.options.strokeMiterLimit)):this.options.strokeMiterLimit;return vn(t)/this.strokeProjectionMagnitude<=o&&e.push(this.applySkew(this.A.add(t))),e.push(...this.projectBevel()),e}projectRoundNoSkew(e,t){const n=[],o=new s(tt.getOrthogonalRotationFactor(this.bisector),tt.getOrthogonalRotationFactor(new s(this.bisector.y,this.bisector.x)));return[new s(1,0).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar).multiply(o),new s(0,1).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar).multiply(o)].forEach(s=>{xn(s,e,t)&&n.push(this.A.add(s))}),n}projectRoundWithSkew(e,t){const c=[],{skewX:f,skewY:p,scaleX:i,scaleY:a,strokeUniform:r}=this.options,n=new s(Math.tan(m(f)),Math.tan(m(p))),o=this.strokeProjectionMagnitude,l=r?o/a/Math.sqrt(1/a**2+1/i**2*n.y**2):o/Math.sqrt(1+n.y**2),d=new s(Math.sqrt(Math.max(o**2-l**2,0)),l),u=r?o/Math.sqrt(1+n.x**2*(1/a)**2/(1/i+1/i*n.x*n.y)**2):o/Math.sqrt(1+n.x**2/(1+n.x*n.y)**2),h=new s(u,Math.sqrt(Math.max(o**2-u**2,0)));return[h,h.scalarMultiply(-1),d,d.scalarMultiply(-1)].map(e=>this.applySkew(r?e.multiply(this.strokeUniformScalar):e)).forEach(n=>{xn(n,e,t)&&c.push(this.applySkew(this.A).add(n))}),c}projectRound(){const e=[];e.push(...this.projectBevel());const t=this.alpha%le==0,s=this.applySkew(this.A),n=e[t?0:2].subtract(s),o=e[t?1:0].subtract(s),c=t?this.applySkew(this.AB.scalarMultiply(-1)):this.applySkew(this.bisector.multiply(this.strokeUniformScalar).scalarMultiply(-1)),i=qe(n,c)>0,a=i?n:o,r=i?o:n;return this.isSkewed()?e.push(...this.projectRoundWithSkew(a,r)):e.push(...this.projectRoundNoSkew(a,r)),e}projectPoints(){switch(this.options.strokeLineJoin){case"miter":return this.projectMiter();case"round":return this.projectRound();default:return this.projectBevel()}}project(){return this.projectPoints().map(e=>({originPoint:this.A,projectedPoint:e,angle:this.alpha,bisector:this.bisector}))}}class Is extends Rs{constructor(e,t,n){super(n),this.A=new s(e),this.T=new s(t)}calcOrthogonalProjection(e,t){let n=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:this.strokeProjectionMagnitude;const s=this.createSideVector(e,t);return this.scaleUnitVector(Qn(s),n)}projectButt(){return[this.projectOrthogonally(this.A,this.T,this.strokeProjectionMagnitude),this.projectOrthogonally(this.A,this.T,-this.strokeProjectionMagnitude)]}projectRound(){const e=[];if(!this.isSkewed()&&this.A.eq(this.T)){const t=new s(1,1).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar);e.push(this.applySkew(this.A.add(t)),this.applySkew(this.A.subtract(t)))}else e.push(...new tt(this.A,this.T,this.T,this.options).projectRound());return e}projectSquare(){const e=[];if(this.A.eq(this.T)){const t=new s(1,1).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar);e.push(this.A.add(t),this.A.subtract(t))}else{const t=this.calcOrthogonalProjection(this.A,this.T,this.strokeProjectionMagnitude),s=this.scaleUnitVector(Dt(this.createSideVector(this.A,this.T)),-this.strokeProjectionMagnitude),n=this.A.add(s);e.push(n.add(t),n.subtract(t))}return e.map(e=>this.applySkew(e))}projectPoints(){switch(this.options.strokeLineCap){case"round":return this.projectRound();case"square":return this.projectSquare();default:return this.projectButt()}}project(){return this.projectPoints().map(e=>({originPoint:this.A,projectedPoint:e}))}}const Bs=function(e,t){let n=arguments.length>2&&0[0]!==arguments[2]&&arguments[2];const o=[];if(0===e.length)return o;const i=e.reduce((e,t)=>(e[e.length-1].eq(t)||e.push(new s(t)),e),[new s(e[0])]);if(1===i.length)n=!0;else if(!n){const e=i[0],t=((e,t)=>{for(let n=e.length-1;n>=0;n--)if(t(e[n],n,e))return n;return-1})(i,t=>!t.eq(e));i.splice(t+1)}return i.forEach((e,s,i)=>{let a,r;0===s?(r=i[1],a=n?e:i[i.length-1]):s===i.length-1?(a=i[s-1],r=n?e:i[0]):(a=i[s-1],r=i[s+1]),n&&1===i.length?o.push(...new Is(e,e,t).project()):!n||0!==s&&s!==i.length-1?o.push(...new tt(e,a,r,t).project()):o.push(...new Is(e,0===s?r:a,t).project())}),o},ys=e=>{const t={};return Object.keys(e).forEach(s=>{t[s]={},Object.keys(e[s]).forEach(o=>{t[s][o]=n({},e[s][o])})}),t},$s=e=>e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;");let Je;const Vt=e=>{if(Je||Je||(Je="Intl"in $()&&"Segmenter"in Intl&&new Intl.Segmenter(0[0],{granularity:"grapheme"})),Je){const t=Je.segment(e);return Array.from(t).map(e=>{let{segment:t}=e;return t})}return dc(e)},dc=e=>{const t=[];for(let s,n=0;n<e.length;n++)!1!==(s=lc(e,n))&&t.push(s);return t},lc=(e,t)=>{const n=e.charCodeAt(t);if(isNaN(n))return"";if(n<55296||n>57343)return e.charAt(t);if(55296<=n&&n<=56319){if(e.length<=t+1)throw"High surrogate without following low surrogate";const n=e.charCodeAt(t+1);if(56320>n||n>57343)throw"High surrogate without following low surrogate";return e.charAt(t)+e.charAt(t+1)}if(0===t)throw"Low surrogate without preceding high surrogate";const s=e.charCodeAt(t-1);if(55296>s||s>56319)throw"Low surrogate without preceding high surrogate";return!1};Ys=Object.freeze({__proto__:null,capitalize:function(e){let t=arguments.length>1&&0[0]!==arguments[1]&&arguments[1];return"".concat(e.charAt(0).toUpperCase()).concat(t?e.slice(1):e.slice(1).toLowerCase())},escapeXml:$s,graphemeSplit:Vt});const $t=function(e,t){let n=arguments.length>2&&0[0]!==arguments[2]&&arguments[2];return e.fill!==t.fill||e.stroke!==t.stroke||e.strokeWidth!==t.strokeWidth||e.fontSize!==t.fontSize||e.fontFamily!==t.fontFamily||e.fontWeight!==t.fontWeight||e.fontStyle!==t.fontStyle||e.textDecorationThickness!==t.textDecorationThickness||e.textBackgroundColor!==t.textBackgroundColor||e.deltaY!==t.deltaY||n&&(e.overline!==t.overline||e.underline!==t.underline||e.linethrough!==t.linethrough)},Xs=(e,t)=>{const i=t.split(`
`),n=[];let s=-1,o={};e=ys(e);for(let t=0;t<i.length;t++){const a=Vt(i[t]);if(e[t])for(let r=0;r<a.length;r++){s++;const i=e[t][r];i&&Object.keys(i).length>0&&($t(o,i,!0)?n.push({start:s,end:s+1,style:i}):n[n.length-1].end++),o=i||{}}else s+=a.length,o={}}return n},Qs=(e,t)=>{if(!Array.isArray(e))return ys(e);const a=t.split(bs),o={};let i=-1,s=0;for(let t=0;t<a.length;t++){const r=Vt(a[t]);for(let a=0;a<r.length;a++)i++,e[s]&&e[s].start<=i&&i<e[s].end&&(o[t]=o[t]||{},o[t][a]=n({},e[s].style),i===e[s].end-1&&s++)}return o},he=["display","transform",v,"fill-opacity","fill-rule","opacity",C,"stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"];function Js(e,t){const a=e.nodeName,s=e.getAttribute("class"),o=e.getAttribute("id"),i="(?![a-zA-Z\\-]+)";let n;if(n=new RegExp("^"+a,"i"),t=t.replace(n,""),o&&t.length&&(n=new RegExp("#"+o+i,"i"),t=t.replace(n,"")),s&&t.length){const e=s.split(" ");for(let s=e.length;s--;)n=new RegExp("\\."+e[s]+i,"i"),t=t.replace(n,"")}return 0===t.length}function ac(e,t){let n=!0;const s=Js(e,t.pop());return s&&t.length&&(n=function(e,t){let n,s=!0;for(;e.parentElement&&1===e.parentElement.nodeType&&t.length;)s&&(n=t.pop()),s=Js(e=e.parentElement,n);return 0===t.length}(e,t)),s&&n&&0===t.length}const oc=e=>{var t;return null!==(t=aa[e])&&0[0]!==t?t:e},sc=new RegExp("(".concat(q,")"),"gi"),ec=e=>e.replace(sc," $1 ").replace(/,/gi," ").replace(/\s+/gi," "),w="(".concat(q,")"),Jr=String.raw(oo||(oo=ne(["(skewX)(",")"],["(skewX)\\(","\\)"])),w),Ur=String.raw(io||(io=ne(["(skewY)(",")"],["(skewY)\\(","\\)"])),w),$r=String.raw(ao||(ao=ne(["(rotate)(","(?: "," ",")?)"],["(rotate)\\(","(?: "," ",")?\\)"])),w,w,w),Vr=String.raw(ro||(ro=ne(["(scale)(","(?: ",")?)"],["(scale)\\(","(?: ",")?\\)"])),w,w),Br=String.raw(co||(co=ne(["(translate)(","(?: ",")?)"],["(translate)\\(","(?: ",")?\\)"])),w,w),Ir=String.raw(lo||(lo=ne(["(matrix)("," "," "," "," "," ",")"],["(matrix)\\("," "," "," "," "," ","\\)"])),w,w,w,w,w,w),ds="(?:".concat(Ir,"|").concat(Br,"|").concat($r,"|").concat(Vr,"|").concat(Jr,"|").concat(Ur,")"),Rr="(?:".concat(ds,"*)"),Nr=String.raw(uo||(uo=ne(["^s*(?:","?)s*$"],["^\\s*(?:","?)\\s*$"])),Rr),Mr=new RegExp(Nr),Sr=new RegExp(ds),Ar=new RegExp(ds,"g");function lt(e){const t=[];if(!(e=ec(e).replace(/\s*([()])\s*/gi,"$1"))||e&&!Mr.test(e))return[..._];for(const r of e.matchAll(Ar)){const i=Sr.exec(r[0]);if(!i)continue;let n=_;const c=i.filter(e=>!!e),[,l,...d]=c,[s,o,a,u,h,m]=d.map(e=>parseFloat(e));switch(l){case"translate":n=Ue(s,o);break;case hs:n=Me({angle:s},{x:o,y:a});break;case Qt:n=rn(s,o);break;case Ie:n=$n(s);break;case He:n=Bn(s);break;case"matrix":n=[s,o,a,u,h,m]}t.push(n)}return nn(t)}function kr(e,t,n,s){const r=Array.isArray(t);let a,o=t;if(e!==v&&e!==C||t!==x){if("strokeUniform"===e)return"non-scaling-stroke"===t;if("strokeDashArray"===e)o=t===x?null:t.replace(/,/g," ").split(/\s+/).map(parseFloat);else if("transformMatrix"===e)o=n&&n.transformMatrix?u(n.transformMatrix,lt(t)):lt(t);else if("visible"===e)o=t!==x&&"hidden"!==t,n&&!1===n.visible&&(o=!1);else if("opacity"===e)o=parseFloat(t),n&&0[0]!==n.opacity&&(o*=n.opacity);else if("textAnchor"===e)o="start"===t?c:"end"===t?f:i;else if("charSpacing"===e||e===ke)a=E(t,s)/s*1e3;else if("paintFirst"===e){const e=t.indexOf(v),n=t.indexOf(C);o=v,(e>-1&&n>-1&&n<e||-1===e&&n>-1)&&(o=C)}else{if("href"===e||"xlink:href"===e||"font"===e||"id"===e)return t;if("imageSmoothing"===e)return"optimizeQuality"===t;a=r?t.map(E):E(t,s)}}else o="";return!r&&isNaN(a)?o:a}function ko(e,t){const n=e.match(ra);if(!n)return;const i=n[1],s=n[3],a=n[4],o=n[5],r=n[6];i&&(t.fontStyle=i),s&&(t.fontWeight=isNaN(parseFloat(s))?s:parseFloat(s)),a&&(t.fontSize=E(a)),r&&(t.fontFamily=r),o&&(t.lineHeight="normal"===o?1:o)}function cs(e,t){e.replace(/;\s*$/,"").split(";").forEach(e=>{if(!e)return;const[n,s]=e.split(":");t[n.trim().toLowerCase()]=s.trim()})}function So(e){const t={},n=e.getAttribute("style");return n?("string"==typeof n?cs(n,t):function(e,t){Object.entries(e).forEach(e=>{let[s,n]=e;0[0]!==n&&(t[s.toLowerCase()]=n)})}(n,t),t):t}const Cr={stroke:"strokeOpacity",fill:"fillOpacity"};function J(e,t,s){if(!e)return{};let c,a={},d=ws;e.parentNode&&ea.test(e.parentNode.nodeName)&&(a=J(e.parentElement,t,s),a.fontSize&&(c=d=E(a.fontSize)));const o=n(n(n({},t.reduce((t,n)=>{const s=e.getAttribute(n);return s&&(t[n]=s),t},{})),function(e){let s=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{},t={};for(const o in s)ac(e,o.split(" "))&&(t=n(n({},t),s[o]));return t}(e,s)),So(e));o[Pn]&&e.setAttribute(Pn,o[Pn]),o[Wn]&&(c=E(o[Wn],d),o[Wn]="".concat(c));const i={};for(const e in o){const t=oc(e),n=kr(t,o[e],a,c);i[t]=n}i&&i.font&&ko(i.font,i);const u=n(n({},a),i);return ea.test(e.nodeName)?u:function(e){const t=b.getDefaults();return Object.entries(Cr).forEach(n=>{let[s,o]=n;if(0[0]===e[o]||""===e[s])return;if(0[0]===e[s]){if(!t[s])return;e[s]=t[s]}if(0===e[s].indexOf("url("))return;const i=new r(e[s]);e[s]=i.setAlpha(l(i.getAlpha()*e[o],2)).toRgba()}),e}(u)}const wr=["left","top","width","height","visible"],zo=["rx","ry"];class B extends b{static getDefaults(){return n(n({},super.getDefaults()),B.ownDefaults)}constructor(e){super(),Object.assign(this,B.ownDefaults),this.setOptions(e),this._initRxRy()}_initRxRy(){const{rx:e,ry:t}=this;e&&!t?this.ry=e:t&&!e&&(this.rx=t)}_render(e){const{width:s,height:o}=this,t=-s/2,n=-o/2,i=this.rx?Math.min(this.rx,s/2):0,a=this.ry?Math.min(this.ry,o/2):0,r=0!==i||0!==a;e.beginPath(),e.moveTo(t+i,n),e.lineTo(t+s-i,n),r&&e.bezierCurveTo(t+s-me*i,n,t+s,n+me*a,t+s,n+a),e.lineTo(t+s,n+o-a),r&&e.bezierCurveTo(t+s,n+o-me*a,t+s-me*i,n+o,t+s-i,n+o),e.lineTo(t+i,n+o),r&&e.bezierCurveTo(t+me*i,n+o,t,n+o-me*a,t,n+o-a),e.lineTo(t,n+a),r&&e.bezierCurveTo(t,n+me*a,t+me*i,n,t+i,n),e.closePath(),this._renderPaintInOrder(e)}toObject(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];return super.toObject([...zo,...e])}_toSVG(){const{width:e,height:t,rx:n,ry:s}=this;return["<rect ","COMMON_PARTS",'x="'.concat(-e/2,'" y="').concat(-t/2,'" rx="').concat(n,'" ry="').concat(s,'" width="').concat(e,'" height="').concat(t,`" />
`)]}static async fromElement(e,t,s){const o=J(e,this.ATTRIBUTE_NAMES,s),{left:r=0,top:c=0,width:i=0,height:a=0,visible:l=!0}=o,u=d(o,wr);return new this(n(n(n({},t),u),{},{left:r,top:c,width:i,height:a,visible:Boolean(l&&i&&a)}))}}t(B,"type","Rect"),t(B,"cacheProperties",[...se,...zo]),t(B,"ownDefaults",{rx:0,ry:0}),t(B,"ATTRIBUTE_NAMES",[...he,"x","y","rx","ry","width","height"]),o.setClass(B),o.setSVGClass(B);const ae="initialization",en="added",_n="removed",tn="imperative",Ho=(e,t)=>{const{strokeUniform:a,strokeWidth:n,width:u,height:h,group:o}=t,i=o&&o!==e?Xe(o.calcTransformMatrix(),e.calcTransformMatrix()):null,r=i?t.getRelativeCenterPoint().transform(i):t.getRelativeCenterPoint(),c=!t.isStrokeAccountedForInDimensions(),m=a&&c?hi(new s(n,n),0[0],e.calcTransformMatrix()):os,l=!a&&c?n:0,d=zt(u+l,h+l,nn([i,t.calcOwnMatrix()],!0)).add(m).scalarDivide(2);return[r.subtract(d),r.add(d)]};class rt{calcLayoutResult(e,t){if(this.shouldPerformLayout(e))return this.calcBoundingBox(t,e)}shouldPerformLayout(e){let{type:t,prevStrategy:n,strategy:s}=e;return t===ae||t===tn||!!n&&s!==n}shouldLayoutClipPath(e){let{type:n,target:{clipPath:t}}=e;return n!==ae&&t&&!t.absolutePositioned}getInitialSize(e,t){return t.size}calcBoundingBox(e,t){const{type:i,target:a}=t;if(i===tn&&t.overrides)return t.overrides;if(0===e.length)return;const{left:r,top:c,width:l,height:d}=te(e.map(e=>Ho(a,e)).reduce((e,t)=>e.concat(t),[])),n=new s(l,d),o=new s(r,c).add(n.scalarDivide(2));if(i===ae){const e=this.getInitialSize(t,{size:n,center:o});return{center:o,relativeCorrection:new s(0,0),size:e}}return{center:o.transform(a.calcOwnMatrix()),size:n}}}t(rt,"type","strategy");class sn extends rt{shouldPerformLayout(){return!0}}t(sn,"type","fit-content"),o.setClass(sn);const vr=["strategy"],gr=["target","strategy","bubbles","prevStrategy"],Fs="layoutManager";class Ye{constructor(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:new sn;t(this,"strategy",0[0]),this.strategy=e,this._subscriptions=new Map}performLayout(e){const t=n(n({bubbles:!0,strategy:this.strategy},e),{},{prevStrategy:this._prevLayoutStrategy,stopPropagation(){this.bubbles=!1}});this.onBeforeLayout(t);const s=this.getLayoutResult(t);s&&this.commitLayout(t,s),this.onAfterLayout(t,s),this._prevLayoutStrategy=t.strategy}attachHandlers(e,t){const{target:n}=t;return[Zt,qs,dt,Zs,Kt,eo,Xt,to,nc].map(t=>e.on(t,e=>this.performLayout(t===Zt?{type:"object_modified",trigger:t,e,target:n}:{type:"object_modifying",trigger:t,e,target:n})))}subscribe(e,t){this.unsubscribe(e,t);const n=this.attachHandlers(e,t);this._subscriptions.set(e,n)}unsubscribe(e){(this._subscriptions.get(e)||[]).forEach(e=>e()),this._subscriptions.delete(e)}unsubscribeTargets(e){e.targets.forEach(t=>this.unsubscribe(t,e))}subscribeTargets(e){e.targets.forEach(t=>this.subscribe(t,e))}onBeforeLayout(e){const{target:t,type:s}=e,{canvas:o}=t;if(s===ae||s===en?this.subscribeTargets(e):s===_n&&this.unsubscribeTargets(e),t.fire("layout:before",{context:e}),o&&o.fire("object:layout:before",{target:t,context:e}),s===tn&&e.deep){const s=d(e,vr);t.forEachObject(e=>e.layoutManager&&e.layoutManager.performLayout(n(n({},s),{},{bubbles:!1,target:e})))}}getLayoutResult(e){const{target:t,strategy:r,type:o}=e,n=r.calcLayoutResult(e,t.getObjects());if(!n)return;const i=o===ae?new s:t.getRelativeCenterPoint(),{center:a,correction:c=new s,relativeCorrection:l=new s}=n,d=i.subtract(a).add(c).transform(o===ae?_:k(t.calcOwnMatrix()),!0).add(l);return{result:n,prevCenter:i,nextCenter:a,offset:d}}commitLayout(e,t){const{target:n}=e,{result:{size:s},nextCenter:o}=t;var a,r;n.set({width:s.x,height:s.y}),this.layoutObjects(e,t),e.type===ae?n.set({left:null!==(a=e.x)&&0[0]!==a?a:o.x+s.x*g(n.originX),top:null!==(r=e.y)&&0[0]!==r?r:o.y+s.y*g(n.originY)}):(n.setPositionByOrigin(o,i,i),n.setCoords(),n.set("dirty",!0))}layoutObjects(e,t){const{target:n}=e;n.forEachObject(s=>{s.group===n&&this.layoutObject(e,t,s)}),e.strategy.shouldLayoutClipPath(e)&&this.layoutObject(e,t,n.clipPath)}layoutObject(e,t,n){let{offset:s}=t;n.set({left:n.left+s.x,top:n.top+s.y})}onAfterLayout(e,t){const{target:s,strategy:c,bubbles:r,prevStrategy:l}=e,i=d(e,gr),{canvas:a}=s;s.fire("layout:after",{context:e,result:t}),a&&a.fire("object:layout:after",{context:e,result:t,target:s});const o=s.parent;r&&o!=null&&o.layoutManager&&((i.path||(i.path=[])).push(s),o.layoutManager.performLayout(n(n({},i),{},{target:o}))),s.set("dirty",!0)}dispose(){const{_subscriptions:e}=this;e.forEach(e=>e.forEach(e=>e())),e.clear()}toObject(){return{type:Fs,strategy:this.strategy.constructor.type}}toJSON(){return this.toObject()}}o.setClass(Ye,Fs);const fr=["type","objects","layoutManager"];class hr extends Ye{performLayout(){}}class P extends ts(b){static getDefaults(){return n(n({},super.getDefaults()),P.ownDefaults)}constructor(){let n=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[],e=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};super(),t(this,"_activeObjects",[]),t(this,"__objectSelectionTracker",0[0]),t(this,"__objectSelectionDisposer",0[0]),Object.assign(this,P.ownDefaults),this.setOptions(e),this.groupInit(n,e)}groupInit(e,t){var n;this._objects=[...e],this.__objectSelectionTracker=this.__objectSelectionMonitor.bind(this,!0),this.__objectSelectionDisposer=this.__objectSelectionMonitor.bind(this,!1),this.forEachObject(e=>{this.enterGroup(e,!1)}),this.layoutManager=null!==(n=t.layoutManager)&&0[0]!==n?n:new Ye,this.layoutManager.performLayout({type:ae,target:this,targets:[...e],x:t.left,y:t.top})}canEnterGroup(e){return e===this||this.isDescendantOf(e)?(ie("error","Group: circular object trees are not supported, this call has no effect"),!1):-1===this._objects.indexOf(e)||(ie("error","Group: duplicate objects are not supported inside group, this call has no effect"),!1)}_filterObjectsBeforeEnteringGroup(e){return e.filter((e,t,n)=>this.canEnterGroup(e)&&n.indexOf(e)===t)}add(){for(var t=arguments.length,n=new Array(t),e=0;e<t;e++)n[e]=arguments[e];const s=this._filterObjectsBeforeEnteringGroup(n),o=super.add(...s);return this._onAfterObjectsChange(en,s),o}insertAt(e){for(var n=arguments.length,s=new Array(n>1?n-1:0),t=1;t<n;t++)s[t-1]=arguments[t];const o=this._filterObjectsBeforeEnteringGroup(s),i=super.insertAt(e,...o);return this._onAfterObjectsChange(en,o),i}remove(){const e=super.remove(...arguments);return this._onAfterObjectsChange(_n,e),e}_onObjectAdded(e){this.enterGroup(e,!0),this.fire("object:added",{target:e}),e.fire("added",{target:this})}_onObjectRemoved(e,t){this.exitGroup(e,t),this.fire("object:removed",{target:e}),e.fire("removed",{target:this})}_onAfterObjectsChange(e,t){this.layoutManager.performLayout({type:e,targets:t,target:this})}_onStackOrderChanged(){this._set("dirty",!0)}_set(e,t){const n=this[e];return super._set(e,t),"canvas"===e&&n!==t&&(this._objects||[]).forEach(n=>{n._set(e,t)}),this}_shouldSetNestedCoords(){return this.subTargetCheck}removeAll(){return this._activeObjects=[],this.remove(...this._objects)}__objectSelectionMonitor(e,t){let{target:s}=t;const n=this._activeObjects;if(e)n.push(s),this._set("dirty",!0);else if(n.length>0){const e=n.indexOf(s);e>-1&&(n.splice(e,1),this._set("dirty",!0))}}_watchObject(e,t){e&&this._watchObject(!1,t),e?(t.on("selected",this.__objectSelectionTracker),t.on("deselected",this.__objectSelectionDisposer)):(t.off("selected",this.__objectSelectionTracker),t.off("deselected",this.__objectSelectionDisposer))}enterGroup(e,t){e.group&&e.group.remove(e),e._set("parent",this),this._enterGroup(e,t)}_enterGroup(e,t){t&&Ve(e,u(k(this.calcTransformMatrix()),e.calcTransformMatrix())),this._shouldSetNestedCoords()&&e.setCoords(),e._set("group",this),e._set("canvas",this.canvas),this._watchObject(!0,e);const n=this.canvas&&this.canvas.getActiveObject&&this.canvas.getActiveObject();n&&(n===e||e.isDescendantOf(n))&&this._activeObjects.push(e)}exitGroup(e,t){this._exitGroup(e,t),e._set("parent",0[0]),e._set("canvas",0[0])}_exitGroup(e,t){e._set("group",0[0]),t||(Ve(e,u(this.calcTransformMatrix(),e.calcTransformMatrix())),e.setCoords()),this._watchObject(!1,e);const n=this._activeObjects.length>0?this._activeObjects.indexOf(e):-1;n>-1&&this._activeObjects.splice(n,1)}shouldCache(){const e=b.prototype.shouldCache.call(this);if(e)for(let e=0;e<this._objects.length;e++)if(this._objects[e].willDrawShadow())return this.ownCaching=!1,!1;return e}willDrawShadow(){if(super.willDrawShadow())return!0;for(let e=0;e<this._objects.length;e++)if(this._objects[e].willDrawShadow())return!0;return!1}isOnACache(){return this.ownCaching||!!this.parent&&this.parent.isOnACache()}drawObject(e,t,n){this._renderBackground(e);for(let n=0;n<this._objects.length;n++){var s;const t=this._objects[n];null!==(s=this.canvas)&&0[0]!==s&&s.preserveObjectStacking&&t.group!==this?(e.save(),e.transform(...k(this.calcTransformMatrix())),t.render(e),e.restore()):t.group===this&&t.render(e)}this._drawClipPath(e,this.clipPath,n)}setCoords(){super.setCoords(),this._shouldSetNestedCoords()&&this.forEachObject(e=>e.setCoords())}triggerLayout(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};this.layoutManager.performLayout(n({target:this,type:tn},e))}render(e){this._transformDone=!0,super.render(e),this._transformDone=!1}__serializeObjects(e,t){const n=this.includeDefaultValues;return this._objects.filter(function(e){return!e.excludeFromExport}).map(function(s){const o=s.includeDefaultValues;s.includeDefaultValues=n;const i=s[e||"toObject"](t);return s.includeDefaultValues=o,i})}toObject(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];const t=this.layoutManager.toObject();return n(n(n({},super.toObject(["subTargetCheck","interactive",...e])),"fit-content"!==t.strategy||this.includeDefaultValues?{layoutManager:t}:{}),{},{objects:this.__serializeObjects("toObject",e)})}toString(){return"#<Group: (".concat(this.complexity(),")>")}dispose(){this.layoutManager.unsubscribeTargets({targets:this.getObjects(),target:this}),this._activeObjects=[],this.forEachObject(e=>{this._watchObject(!1,e),e.dispose()}),super.dispose()}_createSVGBgRect(e){if(!this.backgroundColor)return"";const t=B.prototype._toSVG.call(this),s=t.indexOf("COMMON_PARTS");t[s]='for="group" ';const n=t.join("");return e?e(n):n}_toSVG(e){const t=["<g ","COMMON_PARTS",` >
`],n=this._createSVGBgRect(e);n&&t.push("		",n);for(let n=0;n<this._objects.length;n++)t.push("		",this._objects[n].toSVG(e));return t.push(`</g>
`),t}getSvgStyles(){const e=0[0]!==this.opacity&&1!==this.opacity?"opacity: ".concat(this.opacity,";"):"",t=this.visible?"":" visibility: hidden;";return[e,this.getSvgFilter(),t].join("")}toClipPathSVG(e){const t=[],n=this._createSVGBgRect(e);n&&t.push("	",n);for(let n=0;n<this._objects.length;n++)t.push("	",this._objects[n].toClipPathSVG(e));return this._createBaseClipPathSVGMarkup(t,{reviver:e})}static fromObject(e,t){let{type:r,objects:a=[],layoutManager:s}=e,i=d(e,fr);return Promise.all([Pe(a,t),vt(i,t)]).then(e=>{let[a,r]=e;const t=new this(a,n(n(n({},i),r),{},{layoutManager:new hr}));if(s){const e=o.getClass(s.type),n=o.getClass(s.strategy);t.layoutManager=new e(new n)}else t.layoutManager=new Ye;return t.layoutManager.subscribeTargets({type:ae,target:t,targets:t.getObjects()}),t.setCoords(),t})}}t(P,"type","Group"),t(P,"ownDefaults",{strokeWidth:0,subTargetCheck:!1,interactive:!1}),o.setClass(P);const Go=(e,t)=>Math.min(t.width/e.width,t.height/e.height),Xo=(e,t)=>Math.max(t.width/e.width,t.height/e.height),Vn="\\s*,?\\s*",mt="".concat(Vn,"(").concat(q,")"),sr="".concat(mt).concat(mt).concat(mt).concat(Vn,"([01])").concat(Vn,"([01])").concat(mt).concat(mt),nr={m:"l",M:"L"},tr=(e,t,n,s,o,i,a,r,c,l,d)=>{const m=I(e),f=V(e),u=I(t),h=V(t),p=n*o*u-s*i*h+a,g=s*o*u+n*i*h+r;return["C",l+c*(-n*o*f-s*i*m),d+c*(-s*o*f+n*i*m),p+c*(n*o*h+s*i*u),g+c*(s*o*h-n*i*u),p,g]},ni=(e,t,n,s)=>{const o=Math.atan2(t,e),i=Math.atan2(s,n);return i>=o?i-o:2*Math.PI-(o-i)};function In(e,t,n,o,i,r,c,l){let p;if(a.cachesBoundsOfCurve&&(p=[...arguments].join(),Be.boundsOfCurveCache[p]))return Be.boundsOfCurveCache[p];const y=Math.sqrt,b=Math.abs,h=[],d=[[0,0],[0,0]];let u=6*e-12*n+6*i,m=-3*e+9*n-9*i+3*c,v=3*n-3*e;for(let e=0;e<2;++e){if(e>0&&(u=6*t-12*o+6*r,m=-3*t+9*o-9*r+3*l,v=3*o-3*t),b(m)<1e-12){if(b(u)<1e-12)continue;const e=-v/u;0<e&&e<1&&h.push(e);continue}const i=u*u-4*v*m;if(i<0)continue;const a=y(i),n=(-u+a)/(2*m);0<n&&n<1&&h.push(n);const s=(-u-a)/(2*m);0<s&&s<1&&h.push(s)}let f=h.length;const g=f,_=ri(e,t,n,o,i,r,c,l);for(;f--;){const{x:e,y:t}=_(h[f]);d[0][f]=e,d[1][f]=t}d[0][g]=e,d[1][g]=t,d[0][g+1]=c,d[1][g+1]=l;const j=[new s(Math.min(...d[0]),Math.min(...d[1])),new s(Math.max(...d[0]),Math.max(...d[1]))];return a.cachesBoundsOfCurve&&(Be.boundsOfCurveCache[p]=j),j}const Qa=(e,t,n)=>{let[u,o,i,a,r,c,l,d]=n;const s=((e,t,n,s,o,i,a)=>{if(0===n||0===s)return[];let E=0,M=0,w=0;const y=Math.PI,S=a*Os,h=V(S),m=I(S),f=.5*(-m*e-h*t),p=.5*(-m*t+h*e),j=n**2,v=s**2,A=p**2,C=f**2,_=j*v-j*A-v*C;let c=n<0?-n:n,r=s<0?-s:s;if(_<0){const e=Math.sqrt(1-_/(j*v));c*=e,r*=e}else w=(o===i?-1:1)*Math.sqrt(_/(j*A+v*C));const u=w*c*p/r,g=-w*r*f/c,T=m*u-h*g+.5*e,F=h*u+m*g+.5*t;let x=ni(1,0,(f-u)/c,(p-g)/r),l=ni((f-u)/c,(p-g)/r,(-f-u)/c,(-p-g)/r);0===i&&l>0?l-=2*y:1===i&&l<0&&(l+=2*y);const k=Math.ceil(Math.abs(l/y*2)),b=[],d=l/k,z=8/3*Math.sin(d/4)*Math.sin(d/4)/Math.sin(d/2);let O=x+d;for(let e=0;e<k;e++)b[e]=tr(x,O,m,h,c,r,T,F,z,E,M),E=b[e][5],M=b[e][6],x=O,O+=d;return b})(l-e,d-t,o,i,r,c,a);for(let n=0,o=s.length;n<o;n++)s[n][1]+=e,s[n][2]+=t,s[n][3]+=e,s[n][4]+=t,s[n][5]+=e,s[n][6]+=t;return s},ii=e=>{let t=0,n=0,r=0,c=0;const a=[];let i,s=0,o=0;for(const u of e){const l=[...u];let d;switch(l[0]){case"l":l[1]+=t,l[2]+=n;case"L":t=l[1],n=l[2],d=["L",t,n];break;case"h":l[1]+=t;case"H":t=l[1],d=["L",t,n];break;case"v":l[1]+=n;case"V":n=l[1],d=["L",t,n];break;case"m":l[1]+=t,l[2]+=n;case"M":t=l[1],n=l[2],r=l[1],c=l[2],d=["M",t,n];break;case"c":l[1]+=t,l[2]+=n,l[3]+=t,l[4]+=n,l[5]+=t,l[6]+=n;case"C":s=l[3],o=l[4],t=l[5],n=l[6],d=["C",l[1],l[2],s,o,t,n];break;case"s":l[1]+=t,l[2]+=n,l[3]+=t,l[4]+=n;case"S":"C"===i?(s=2*t-s,o=2*n-o):(s=t,o=n),t=l[3],n=l[4],d=["C",s,o,l[1],l[2],t,n],s=d[3],o=d[4];break;case"q":l[1]+=t,l[2]+=n,l[3]+=t,l[4]+=n;case"Q":s=l[1],o=l[2],t=l[3],n=l[4],d=["Q",s,o,t,n];break;case"t":l[1]+=t,l[2]+=n;case"T":"Q"===i?(s=2*t-s,o=2*n-o):(s=t,o=n),t=l[1],n=l[2],d=["Q",s,o,t,n];break;case"a":l[6]+=t,l[7]+=n;case"A":Qa(t,n,l).forEach(e=>a.push(e)),t=l[6],n=l[7];break;case"z":case"Z":t=r,n=c,d=["Z"]}d?(a.push(d),i=d[0]):i=""}return a},cn=(e,t,n,s)=>Math.sqrt((n-e)**2+(s-t)**2),ri=(e,t,n,o,i,a,r,c)=>l=>{const d=l**3,u=(e=>3*e**2*(1-e))(l),h=(e=>3*e*(1-e)**2)(l),m=(e=>(1-e)**3)(l);return new s(r*d+i*u+n*h+e*m,c*d+a*u+o*h+t*m)},ci=e=>e**2,li=e=>2*e*(1-e),di=e=>(1-e)**2,Ga=(e,t,n,s,o,i,a,r)=>c=>{const l=ci(c),d=li(c),u=di(c),h=3*(u*(n-e)+d*(o-n)+l*(a-o)),m=3*(u*(s-t)+d*(i-s)+l*(r-i));return Math.atan2(m,h)},Ya=(e,t,n,o,i,a)=>r=>{const c=ci(r),l=li(r),d=di(r);return new s(i*c+n*l+e*d,a*c+o*l+t*d)},Ua=(e,t,n,s,o,i)=>a=>{const r=1-a,c=2*(r*(n-e)+a*(o-n)),l=2*(r*(s-t)+a*(i-s));return Math.atan2(l,c)},fi=(e,t,n)=>{let o=new s(t,n),i=0;for(let t=1;t<=100;t+=1){const n=e(t/100);i+=cn(o.x,o.y,n.x,n.y),o=n}return i},Wa=(e,t)=>{let r,o=0,c=0,i={x:e.x,y:e.y},s=n({},i),a=.01,l=0;const d=e.iterator,u=e.angleFinder;for(;c<t&&a>1e-4;)s=d(o),l=o,r=cn(i.x,i.y,s.x,s.y),r+c>t?(o-=a,a/=2):(i=s,o+=a,c+=r);return n(n({},s),{},{angle:u(l)})},Rn=e=>{let o,t,c=0,n=0,s=0,i=0,a=0;const r=[];for(const l of e){const d={x:n,y:s,command:l[0],length:0};switch(l[0]){case"M":t=d,t.x=i=n=l[1],t.y=a=s=l[2];break;case"L":t=d,t.length=cn(n,s,l[1],l[2]),n=l[1],s=l[2];break;case"C":o=ri(n,s,l[1],l[2],l[3],l[4],l[5],l[6]),t=d,t.iterator=o,t.angleFinder=Ga(n,s,l[1],l[2],l[3],l[4],l[5],l[6]),t.length=fi(o,n,s),n=l[5],s=l[6];break;case"Q":o=Ya(n,s,l[1],l[2],l[3],l[4]),t=d,t.iterator=o,t.angleFinder=Ua(n,s,l[1],l[2],l[3],l[4]),t.length=fi(o,n,s),n=l[3],s=l[4];break;case"Z":t=d,t.destX=i,t.destY=a,t.length=cn(n,s,i,a),n=i,s=a}c+=t.length,r.push(t)}return r.push({length:c,x:n,y:s}),r},vi=function(e,t){let a=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:Rn(e),i=0;for(;t-a[i].length>0&&i<a.length-2;)t-=a[i].length,i++;const o=a[i],c=t/o.length,r=e[i];switch(o.command){case"M":return{x:o.x,y:o.y,angle:0};case"Z":return n(n({},new s(o.x,o.y).lerp(new s(o.destX,o.destY),c)),{},{angle:Math.atan2(o.destY-o.y,o.destX-o.x)});case"L":return n(n({},new s(o.x,o.y).lerp(new s(r[1],r[2]),c)),{},{angle:Math.atan2(r[2]-o.y,r[1]-o.x)});case"C":case"Q":return Wa(o,t)}},Ba=new RegExp("[mzlhvcsqta][^mzlhvcsqta]*","gi"),ji=new RegExp(sr,"g"),Ia=new RegExp(q,"gi"),Ha={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},wi=e=>{var t;const n=[],s=null!==(t=e.match(Ba))&&0[0]!==t?t:[];for(const o of s){const e=o[0];if("z"===e||"Z"===e){n.push([e]);continue}const i=Ha[e.toLowerCase()];let t=[];if("a"===e||"A"===e){ji.lastIndex=0;for(let e=null;e=ji.exec(o);)t.push(...e.slice(1))}else t=o.match(Ia)||[];for(let s=0;s<t.length;s+=i){const o=new Array(i),a=nr[e];o[0]=s>0&&a?a:e;for(let e=0;e<i;e++)o[e+1]=parseFloat(t[s+e]);n.push(o)}}return n},Oi=function(e){let i=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:0,t=new s(e[0]),o=new s(e[1]),a=1,r=0;const c=[],l=e.length,d=l>2;let n;for(d&&(a=e[2].x<o.x?-1:e[2].x===o.x?0:1,r=e[2].y<o.y?-1:e[2].y===o.y?0:1),c.push(["M",t.x-a*i,t.y-r*i]),n=1;n<l;n++){if(!t.eq(o)){const e=t.midPointFrom(o);c.push(["Q",t.x,t.y,e.x,e.y])}t=e[n],n+1<e.length&&(o=e[n+1])}return d&&(a=t.x>e[n-2].x?1:t.x===e[n-2].x?0:-1,r=t.y>e[n-2].y?1:t.y===e[n-2].y?0:-1),c.push(["L",t.x+a*i,t.y+r*i]),c},Ln=(e,t)=>e.map(e=>e.map((e,n)=>0===n||0[0]===t?e:l(e,t)).join(" ")).join(" ");function hn(e,t){const n=e.style;n&&t&&("string"==typeof t?n.cssText+=";"+t:Object.entries(t).forEach(e=>{let[t,s]=e;return n.setProperty(t,s)}))}const De=(e,t)=>Math.floor(Math.random()*(t-e+1))+e;function ki(e){let s=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};const a=s.onComplete||be,t=new $().XMLHttpRequest,n=s.signal,o=function(){t.abort()},i=function(){n&&n.removeEventListener("abort",o),t.onerror=t.ontimeout=be};if(n&&n.aborted)throw new ks("request");return n&&n.addEventListener("abort",o,{once:!0}),t.onreadystatechange=function(){4===t.readyState&&(i(),a(t),t.onreadystatechange=be)},t.onerror=t.ontimeout=i,t.open("get",e,!0),t.send(),t}const fn=(e,t)=>{let n=e._findCenterFromElement();e.transformMatrix&&((e=>{if(e.transformMatrix){const{scaleX:t,scaleY:n,angle:s,skewX:o}=Ae(e.transformMatrix);e.flipX=!1,e.flipY=!1,e.set(O,t),e.set(z,n),e.angle=s,e.skewX=o,e.skewY=0}})(e),n=n.transform(e.transformMatrix)),delete e.transformMatrix,t&&(e.scaleX*=t.scaleX,e.scaleY*=t.scaleY,e.cropX=t.cropX,e.cropY=t.cropY,n.x+=t.offsetLeft,n.y+=t.offsetTop,e.width=t.width,e.height=t.height),e.setPositionByOrigin(n,i,i)};Si=Object.freeze({__proto__:null,addTransformToObject:oi,animate:Yn,animateColor:Po,applyTransformToObject:Ve,calcAngleBetweenVectors:bn,calcDimensionsMatrix:gt,calcPlaneChangeMatrix:Xe,calcVectorRotation:Ri,cancelAnimFrame:fo,capValue:Fe,composeMatrix:_o,copyCanvasElement:e=>{var t;const n=M(e);return null===(t=n.getContext("2d"))||0[0]===t||t.drawImage(e,0,0),n},cos:I,createCanvasElement:N,createImage:go,createRotateMatrix:Me,createScaleMatrix:rn,createSkewXMatrix:$n,createSkewYMatrix:Bn,createTranslateMatrix:Ue,createVector:gn,crossProduct:qe,degreesToRadians:m,dotProduct:Li,ease:$a,enlivenObjectEnlivables:vt,enlivenObjects:Pe,findScaleToCover:Xo,findScaleToFit:Go,getBoundsOfCurve:In,getOrthonormalVector:Qn,getPathSegmentsInfo:Rn,getPointOnPath:vi,getPointer:Jo,getRandomInt:De,getRegularPolygonPath:(e,t)=>{const o=2*Math.PI/e;let i=-ge;e%2==0&&(i+=o/2);const n=new Array(e+1);for(let a=0;a<e;a++){const r=a*o+i,{x:c,y:l}=new s(I(r),V(r)).scalarMultiply(t);n[a]=[0===a?"M":"L",c,l]}return n[e]=["Z"],n},getSmoothPathFromPoints:Oi,getSvgAttributes:e=>{const t=["instantiated_by_use","style","id","class"];switch(e){case"linearGradient":return t.concat(["x1","y1","x2","y2","gradientUnits","gradientTransform"]);case"radialGradient":return t.concat(["gradientUnits","gradientTransform","cx","cy","r","fx","fy","fr"]);case"stop":return t.concat(["offset","stop-color","stop-opacity"])}return t},getUnitVector:Dt,groupSVGElements:(e,t)=>e&&1===e.length?e[0]:new P(e,t),hasStyleChanged:$t,invertTransform:k,isBetweenVectors:xn,isIdentityMatrix:vo,isTouchEvent:un,isTransparent:Ls,joinPath:Ln,loadImage:wt,magnitude:vn,makeBoundingBoxFromPoints:te,makePathSimpler:ii,matrixToSVG:$e,mergeClipPaths:(e,t)=>{var o;let s=e,n=t;s.inverted&&!n.inverted&&(s=t,n=e),rs(n,null===(o=n.group)||0[0]===o?0[0]:o.calcTransformMatrix(),s.calcTransformMatrix());const i=s.inverted&&n.inverted;return i&&(s.inverted=n.inverted=!1),new P([s],{clipPath:n,inverted:i})},multiplyTransformMatrices:u,multiplyTransformMatrixArray:nn,parsePath:wi,parsePreserveAspectRatioAttribute:Cs,parseUnit:E,pick:Ce,projectStrokeOnPoints:Bs,qrDecompose:Ae,radiansToDegrees:Z,removeFromArray:Ee,removeTransformFromObject:(e,t)=>{const n=k(t),s=u(n,e.calcOwnMatrix());Ve(e,s)},removeTransformMatrixForSvgParsing:fn,request:ki,requestAnimFrame:Ze,resetObjectTransform:ai,rotatePoint:(e,t,n)=>e.rotate(n,t),rotateVector:Mn,saveObjectTransform:Gn,sendObjectToPlane:rs,sendPointToPlane:re,sendVectorToPlane:hi,setStyle:hn,sin:V,sizeAfterTransform:zt,string:Ys,stylesFromArray:Qs,stylesToArray:Xs,toBlob:Xn,toDataURL:Jn,toFixed:l,transformPath:(e,t,n)=>(n&&(t=u(t,[1,0,0,1,-n.x,-n.y])),e.map(e=>{const n=[...e];for(let s=1;s<e.length-1;s+=2){const{x:o,y:i}=j({x:e[s],y:e[s+1]},t);n[s]=o,n[s+1]=i}return n})),transformPoint:j});class Mi extends wn{constructor(e){let{allowTouchScrolling:i=!1,containerClass:a=""}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};super(e),t(this,"upper",0[0]),t(this,"container",0[0]);const{el:n}=this.lower,s=this.createUpperCanvas();this.upper={el:s,ctx:s.getContext("2d")},this.applyCanvasStyle(n,{allowTouchScrolling:i}),this.applyCanvasStyle(s,{allowTouchScrolling:i,styles:{position:"absolute",left:"0",top:"0"}});const o=this.createContainerElement();o.classList.add(a),n.parentNode&&n.parentNode.replaceChild(o,n),o.append(n,s),this.container=o}createUpperCanvas(){const{el:t}=this.lower,e=N();return e.className=t.className,e.classList.remove("lower-canvas"),e.classList.add("upper-canvas"),e.setAttribute("data-fabric","top"),e.style.cssText=t.style.cssText,e.setAttribute("draggable","true"),e}createContainerElement(){const e=we().createElement("div");return e.setAttribute("data-fabric","wrapper"),hn(e,{position:"relative"}),Uo(e),e}applyCanvasStyle(e,t){const{styles:s,allowTouchScrolling:o}=t;hn(e,n(n({},s),{},{"touch-action":o?"manipulation":x})),Uo(e)}setDimensions(e,t){super.setDimensions(e,t);const{el:n,ctx:s}=this.upper;$o(n,s,e,t)}setCSSDimensions(e){super.setCSSDimensions(e),Cn(this.upper.el,e),Cn(this.container,e)}cleanupDOM(e){const t=this.container,{el:n}=this.lower,{el:s}=this.upper;super.cleanupDOM(e),t.removeChild(s),t.removeChild(n),t.parentNode&&t.parentNode.replaceChild(n,t)}dispose(){super.dispose(),W().dispose(this.upper.el),delete this.upper,delete this.container}}class Sn extends nt{constructor(){super(...arguments),t(this,"targets",[]),t(this,"_hoveredTargets",[]),t(this,"_objectsToRender",0[0]),t(this,"_currentTransform",null),t(this,"_groupSelector",null),t(this,"contextTopDirty",!1)}static getDefaults(){return n(n({},super.getDefaults()),Sn.ownDefaults)}get upperCanvasEl(){var e;return null===(e=this.elements.upper)||0[0]===e?0[0]:e.el}get contextTop(){var e;return null===(e=this.elements.upper)||0[0]===e?0[0]:e.ctx}get wrapperEl(){return this.elements.container}initElements(e){this.elements=new Mi(e,{allowTouchScrolling:this.allowTouchScrolling,containerClass:this.containerClass}),this._createCacheCanvas()}_onObjectAdded(e){this._objectsToRender=0[0],super._onObjectAdded(e)}_onObjectRemoved(e){this._objectsToRender=0[0],e===this._activeObject&&(this.fire("before:selection:cleared",{deselected:[e]}),this._discardActiveObject(),this.fire("selection:cleared",{deselected:[e]}),e.fire("deselected",{target:e})),e===this._hoveredTarget&&(this._hoveredTarget=0[0],this._hoveredTargets=[]),super._onObjectRemoved(e)}_onStackOrderChanged(){this._objectsToRender=0[0],super._onStackOrderChanged()}_chooseObjectsToRender(){const e=this._activeObject;return!this.preserveObjectStacking&&e?this._objects.filter(t=>!t.group&&t!==e).concat(e):this._objects}renderAll(){this.cancelRequestedRender(),this.destroyed||(!this.contextTopDirty||this._groupSelector||this.isDrawingMode||(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&(this.renderTopLayer(this.contextTop),this.hasLostContext=!1),!this._objectsToRender&&(this._objectsToRender=this._chooseObjectsToRender()),this.renderCanvas(this.getContext(),this._objectsToRender))}renderTopLayer(e){e.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(e),this.contextTopDirty=!0),e.restore()}renderTop(){const e=this.contextTop;this.clearContext(e),this.renderTopLayer(e),this.fire("after:render",{ctx:e})}setTargetFindTolerance(e){e=Math.round(e),this.targetFindTolerance=e;const t=this.getRetinaScaling(),n=Math.ceil((2*e+1)*t);this.pixelFindCanvasEl.width=this.pixelFindCanvasEl.height=n,this.pixelFindContext.scale(t,t)}isTargetTransparent(e,t,n){const o=this.targetFindTolerance,s=this.pixelFindContext;this.clearContext(s),s.save(),s.translate(-t+o,-n+o),s.transform(...this.viewportTransform);const a=e.selectionBackgroundColor;e.selectionBackgroundColor="",e.render(s),e.selectionBackgroundColor=a,s.restore();const i=Math.round(o*this.getRetinaScaling());return Ls(s,i,i,i)}_isSelectionKeyPressed(e){const t=this.selectionKey;return!!t&&(Array.isArray(t)?!!t.find(t=>!!t&&!0===e[t]):e[t])}_shouldClearSelection(e,t){const s=this.getActiveObjects(),n=this._activeObject;return!!(!t||t&&n&&s.length>1&&-1===s.indexOf(t)&&n!==t&&!this._isSelectionKeyPressed(e)||t&&!t.evented||t&&!t.selectable&&n&&n!==t)}_shouldCenterTransform(e,t,n){if(!e)return;let s;return t===Qt||t===O||t===z||t===dt?s=this.centeredScaling||e.centeredScaling:t===hs&&(s=this.centeredRotation||e.centeredRotation),s?!n:n}_getOriginFromCorner(e,t){const n={x:e.originX,y:e.originY};return t?(["ml","tl","bl"].includes(t)?n.x=f:["mr","tr","br"].includes(t)&&(n.x=c),["tl","mt","tr"].includes(t)?n.y=_s:["bl","mb","br"].includes(t)&&(n.y=A),n):n}_setupCurrentTransform(e,t,s){var c;const o=t.group?re(this.getScenePoint(e),0[0],t.group.calcTransformMatrix()):this.getScenePoint(e),{key:l="",control:a}=t.getActiveControl()||{},f=s&&a?null===(c=a.getActionHandler(e,t,a))||0[0]===c?0[0]:c.bind(a):yi,d=((e,t,n,s)=>{if(!t||!e)return"drag";const o=s.controls[t];return o.getActionName(n,o,s)})(s,l,e,t),u=e[this.centeredKey],r=this._shouldCenterTransform(t,d,u)?{x:i,y:i}:this._getOriginFromCorner(t,l),h={target:t,action:d,actionHandler:f,actionPerformed:!1,corner:l,scaleX:t.scaleX,scaleY:t.scaleY,skewX:t.skewX,skewY:t.skewY,offsetX:o.x-t.left,offsetY:o.y-t.top,originX:r.x,originY:r.y,ex:o.x,ey:o.y,lastX:o.x,lastY:o.y,theta:m(t.angle),width:t.width,height:t.height,shiftKey:e.shiftKey,altKey:u,original:n(n({},Gn(t)),{},{originX:r.x,originY:r.y})};this._currentTransform=h,this.fire("before:transform",{e,transform:h})}setCursor(e){this.upperCanvasEl.style.cursor=e}_drawSelection(e){const{x:l,y:d,deltaX:u,deltaY:h}=this._groupSelector,o=new s(l,d).transform(this.viewportTransform),i=new s(l+u,d+h).transform(this.viewportTransform),a=this.selectionLineWidth/2;let t=Math.min(o.x,i.x),n=Math.min(o.y,i.y),r=Math.max(o.x,i.x),c=Math.max(o.y,i.y);this.selectionColor&&(e.fillStyle=this.selectionColor,e.fillRect(t,n,r-t,c-n)),this.selectionLineWidth&&this.selectionBorderColor&&(e.lineWidth=this.selectionLineWidth,e.strokeStyle=this.selectionBorderColor,t+=a,n+=a,r-=a,c-=a,b.prototype._setLineDash.call(this,e,this.selectionDashArray),e.strokeRect(t,n,r-t,c-n))}findTarget(e){if(this.skipTargetFind)return;const n=this.getViewportPoint(e),t=this._activeObject,s=this.getActiveObjects();if(this.targets=[],t&&s.length>=1){if(t.findControl(n,un(e)))return t;if(s.length>1&&this.searchPossibleTargets([t],n))return t;if(t===this.searchPossibleTargets([t],n)){if(this.preserveObjectStacking){const o=this.targets;this.targets=[];const s=this.searchPossibleTargets(this._objects,n);return e[this.altSelectionKey]&&s&&s!==t?(this.targets=o,t):s}return t}}return this.searchPossibleTargets(this._objects,n)}_pointIsInObjectSelectionArea(e,t){let n=e.getCoords();const i=this.getZoom(),o=e.padding/i;if(o){const[e,t,r,c]=n,l=Math.atan2(t.y-e.y,t.x-e.x),d=I(l)*o,u=V(l)*o,i=d+u,a=d-u;n=[new s(e.x-a,e.y-i),new s(t.x+i,t.y-a),new s(r.x+a,r.y+i),new s(c.x-i,c.y+a)]}return h.isPointInPolygon(t,n)}_checkTarget(e,t){if(e&&e.visible&&e.evented&&this._pointIsInObjectSelectionArea(e,re(t,0[0],this.viewportTransform))){if(!this.perPixelTargetFind&&!e.perPixelTargetFind||e.isEditing)return!0;if(!this.isTargetTransparent(e,t.x,t.y))return!0}return!1}_searchPossibleTargets(e,t){let n=e.length;for(;n--;){const s=e[n];if(this._checkTarget(s,t)){if(Jt(s)&&s.subTargetCheck){const e=this._searchPossibleTargets(s._objects,t);e&&this.targets.push(e)}return s}}}searchPossibleTargets(e,t){const n=this._searchPossibleTargets(e,t);if(n&&Jt(n)&&n.interactive&&this.targets[0]){const e=this.targets;for(let t=e.length-1;t>0;t--){const n=e[t];if(!Jt(n)||!n.interactive)return n}return e[0]}return n}getViewportPoint(e){return this._pointer?this._pointer:this.getPointer(e,!0)}getScenePoint(e){return this._absolutePointer?this._absolutePointer:this.getPointer(e)}getPointer(e){let l=arguments.length>1&&0[0]!==arguments[1]&&arguments[1];const a=this.upperCanvasEl,t=a.getBoundingClientRect();let n=Jo(e),o=t.width||0,i=t.height||0;o&&i||(A in t&&_s in t&&(i=Math.abs(t.top-t.bottom)),f in t&&c in t&&(o=Math.abs(t.right-t.left))),this.calcOffset(),n.x=n.x-this._offset.left,n.y=n.y-this._offset.top,l||(n=re(n,0[0],this.viewportTransform));const r=this.getRetinaScaling();1!==r&&(n.x/=r,n.y/=r);const d=0===o||0===i?new s(1,1):new s(a.width/o,a.height/i);return n.multiply(d)}_setDimensionsImpl(e,t){this._resetTransformEventData(),super._setDimensionsImpl(e,t),this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(this.contextTop)}_createCacheCanvas(){this.pixelFindCanvasEl=N(),this.pixelFindContext=this.pixelFindCanvasEl.getContext("2d",{willReadFrequently:!0}),this.setTargetFindTolerance(this.targetFindTolerance)}getTopContext(){return this.elements.upper.ctx}getSelectionContext(){return this.elements.upper.ctx}getSelectionElement(){return this.elements.upper.el}getActiveObject(){return this._activeObject}getActiveObjects(){const e=this._activeObject;return Te(e)?e.getObjects():e?[e]:[]}_fireSelectionEvents(e,t){let o=!1,n=!1;const s=this.getActiveObjects(),i=[],a=[];e.forEach(e=>{s.includes(e)||(o=!0,e.fire("deselected",{e:t,target:e}),a.push(e))}),s.forEach(n=>{e.includes(n)||(o=!0,n.fire("selected",{e:t,target:n}),i.push(n))}),e.length>0&&s.length>0?(n=!0,o&&this.fire("selection:updated",{e:t,selected:i,deselected:a})):s.length>0?(n=!0,this.fire("selection:created",{e:t,selected:i})):e.length>0&&(n=!0,this.fire("selection:cleared",{e:t,deselected:a})),n&&(this._objectsToRender=0[0])}setActiveObject(e,t){const n=this.getActiveObjects(),s=this._setActiveObject(e,t);return this._fireSelectionEvents(n,t),s}_setActiveObject(e,t){const n=this._activeObject;return n!==e&&!(!this._discardActiveObject(t,e)&&this._activeObject)&&!e.onSelect({e:t})&&(this._activeObject=e,Te(e)&&n!==e&&e.set("canvas",this),e.setCoords(),!0)}_discardActiveObject(e,t){const n=this._activeObject;return!!n&&!n.onDeselect({e,object:t})&&(this._currentTransform&&this._currentTransform.target===n&&this.endCurrentTransform(e),Te(n)&&n===this._hoveredTarget&&(this._hoveredTarget=0[0]),this._activeObject=0[0],!0)}discardActiveObject(e){const t=this.getActiveObjects(),n=this.getActiveObject();t.length&&this.fire("before:selection:cleared",{e,deselected:[n]});const s=this._discardActiveObject(e);return this._fireSelectionEvents(t,e),s}endCurrentTransform(e){const t=this._currentTransform;this._finalizeCurrentTransform(e),t&&t.target&&(t.target.isMoving=!1),this._currentTransform=null}_finalizeCurrentTransform(e){const n=this._currentTransform,t=n.target,s={e,target:t,transform:n,action:n.action};t._scaling&&(t._scaling=!1),t.setCoords(),n.actionPerformed&&(this.fire("object:modified",s),t.fire(Zt,s))}setViewportTransform(e){super.setViewportTransform(e);const t=this._activeObject;t&&t.setCoords()}destroy(){const e=this._activeObject;Te(e)&&(e.removeAll(),e.dispose()),delete this._activeObject,super.destroy(),this.pixelFindContext=null,this.pixelFindCanvasEl=0[0]}clear(){this.discardActiveObject(),this._activeObject=0[0],this.clearContext(this.contextTop),super.clear()}drawControls(e){const t=this._activeObject;t&&t._renderControls(e)}_toObject(e,t,n){const s=this._realizeGroupTransformOnObject(e),o=super._toObject(e,t,n);return e.set(s),o}_realizeGroupTransformOnObject(e){const{group:t}=e;if(t&&Te(t)&&this._activeObject===t){const n=Ce(e,["angle","flipX","flipY",c,O,z,Ie,He,A]);return oi(e,t.calcOwnMatrix()),n}return{}}_setSVGObject(e,t,n){const s=this._realizeGroupTransformOnObject(t);super._setSVGObject(e,t,n),t.set(s)}}t(Sn,"ownDefaults",{uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",selection:!0,selectionKey:"shiftKey",selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",notAllowedCursor:"not-allowed",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,enablePointerEvents:!1,containerClass:"canvas-container",preserveObjectStacking:!1});class La{constructor(e){t(this,"targets",[]),t(this,"__disposer",0[0]);const n=()=>{const{hiddenTextarea:t}=e.getActiveObject()||{};t&&t.focus()},s=e.upperCanvasEl;s.addEventListener("click",n),this.__disposer=()=>s.removeEventListener("click",n)}exitTextEditing(){this.target=0[0],this.targets.forEach(e=>{e.isEditing&&e.exitEditing()})}add(e){this.targets.push(e)}remove(e){this.unregister(e),Ee(this.targets,e)}register(e){this.target=e}unregister(e){e===this.target&&(this.target=0[0])}onMouseMove(e){var t;(null===(t=this.target)||0[0]===t?0[0]:t.isEditing)&&this.target.updateSelectionOnMouseMove(e)}clear(){this.targets=[],this.target=0[0]}dispose(){this.clear(),this.__disposer(),delete this.__disposer}}const Da=["target","oldTarget","fireCanvas","e"],T={passive:!1},Le=(e,t)=>{const n=e.getViewportPoint(t),s=e.getScenePoint(t);return{viewportPoint:n,scenePoint:s,pointer:n,absolutePointer:s}},de=function(e){for(var n=arguments.length,s=new Array(n>1?n-1:0),t=1;t<n;t++)s[t-1]=arguments[t];return e.addEventListener(...s)},L=function(e){for(var n=arguments.length,s=new Array(n>1?n-1:0),t=1;t<n;t++)s[t-1]=arguments[t];return e.removeEventListener(...s)},Fa={mouse:{in:"over",out:"out",targetIn:"mouseover",targetOut:"mouseout",canvasIn:"mouse:over",canvasOut:"mouse:out"},drag:{in:"enter",out:"leave",targetIn:"dragenter",targetOut:"dragleave",canvasIn:"drag:enter",canvasOut:"drag:leave"}};class Fn extends Sn{constructor(e){super(e,arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{}),t(this,"_isClick",0[0]),t(this,"textEditingManager",new La(this)),["_onMouseDown","_onTouchStart","_onMouseMove","_onMouseUp","_onTouchEnd","_onResize","_onMouseWheel","_onMouseOut","_onMouseEnter","_onContextMenu","_onClick","_onDragStart","_onDragEnd","_onDragProgress","_onDragOver","_onDragEnter","_onDragLeave","_onDrop"].forEach(e=>{this[e]=this[e].bind(this)}),this.addOrRemove(de,"add")}_getEventPrefix(){return this.enablePointerEvents?"pointer":"mouse"}addOrRemove(e){const n=this.upperCanvasEl,s=this._getEventPrefix();e(To(n),"resize",this._onResize),e(n,s+"down",this._onMouseDown),e(n,"".concat(s,"move"),this._onMouseMove,T),e(n,"".concat(s,"out"),this._onMouseOut),e(n,"".concat(s,"enter"),this._onMouseEnter),e(n,"wheel",this._onMouseWheel),e(n,"contextmenu",this._onContextMenu),e(n,"click",this._onClick),e(n,"dblclick",this._onClick),e(n,"dragstart",this._onDragStart),e(n,"dragend",this._onDragEnd),e(n,"dragover",this._onDragOver),e(n,"dragenter",this._onDragEnter),e(n,"dragleave",this._onDragLeave),e(n,"drop",this._onDrop),this.enablePointerEvents||e(n,"touchstart",this._onTouchStart,T)}removeListeners(){this.addOrRemove(L,"remove");const t=this._getEventPrefix(),e=H(this.upperCanvasEl);L(e,"".concat(t,"up"),this._onMouseUp),L(e,"touchend",this._onTouchEnd,T),L(e,"".concat(t,"move"),this._onMouseMove,T),L(e,"touchmove",this._onMouseMove,T),clearTimeout(this._willAddMouseDown)}_onMouseWheel(e){this.__onMouseWheel(e)}_onMouseOut(e){const s=this._hoveredTarget,t=n({e},Le(this,e));this.fire("mouse:out",n(n({},t),{},{target:s})),this._hoveredTarget=0[0],s&&s.fire("mouseout",n({},t)),this._hoveredTargets.forEach(e=>{this.fire("mouse:out",n(n({},t),{},{target:e})),e&&e.fire("mouseout",n({},t))}),this._hoveredTargets=[]}_onMouseEnter(e){this._currentTransform||this.findTarget(e)||(this.fire("mouse:over",n({e},Le(this,e))),this._hoveredTarget=0[0],this._hoveredTargets=[])}_onDragStart(e){this._isClick=!1;const t=this.getActiveObject();if(t&&t.onDragStart(e)){this._dragSource=t;const n={e,target:t};return this.fire("dragstart",n),t.fire("dragstart",n),void de(this.upperCanvasEl,"drag",this._onDragProgress)}ei(e)}_renderDragEffects(e,t,n){let o=!1;const i=this._dropTarget;i&&i!==t&&i!==n&&(i.clearContextTop(),o=!0),t==null||t.clearContextTop(),n!==t&&(n==null||n.clearContextTop());const s=this.contextTop;s.save(),s.transform(...this.viewportTransform),t&&(s.save(),t.transform(s),t.renderDragSourceEffect(e),s.restore(),o=!0),n&&(s.save(),n.transform(s),n.renderDropTargetEffect(e),s.restore(),o=!0),s.restore(),o&&(this.contextTopDirty=!0)}_onDragEnd(e){const t=!!e.dataTransfer&&e.dataTransfer.dropEffect!==x,s=t?this._activeObject:0[0],n={e,target:this._dragSource,subTargets:this.targets,dragSource:this._dragSource,didDrop:t,dropTarget:s};L(this.upperCanvasEl,"drag",this._onDragProgress),this.fire("dragend",n),this._dragSource&&this._dragSource.fire("dragend",n),delete this._dragSource,this._onMouseUp(e)}_onDragProgress(e){const t={e,target:this._dragSource,dragSource:this._dragSource,dropTarget:this._draggedoverTarget};this.fire("drag",t),this._dragSource&&this._dragSource.fire("drag",t)}findDragTargets(e){return this.targets=[],{target:this._searchPossibleTargets(this._objects,this.getViewportPoint(e)),targets:[...this.targets]}}_onDragOver(e){const o="dragover",{target:t,targets:i}=this.findDragTargets(e),a=this._dragSource,n={e,target:t,subTargets:i,dragSource:a,canDrop:!1,dropTarget:0[0]};let s;this.fire(o,n),this._fireEnterLeaveEvents(t,n),t&&(t.canDrop(e)&&(s=t),t.fire(o,n));for(let t=0;t<i.length;t++){const a=i[t];a.canDrop(e)&&(s=a),a.fire(o,n)}this._renderDragEffects(e,a,s),this._dropTarget=s}_onDragEnter(e){const{target:t,targets:s}=this.findDragTargets(e),n={e,target:t,subTargets:s,dragSource:this._dragSource};this.fire("dragenter",n),this._fireEnterLeaveEvents(t,n)}_onDragLeave(e){const t={e,target:this._draggedoverTarget,subTargets:this.targets,dragSource:this._dragSource};this.fire("dragleave",t),this._fireEnterLeaveEvents(0[0],t),this._renderDragEffects(e,this._dragSource),this._dropTarget=0[0],this.targets=[],this._hoveredTargets=[]}_onDrop(e){const{target:s,targets:o}=this.findDragTargets(e),t=this._basicEventHandler("drop:before",n({e,target:s,subTargets:o,dragSource:this._dragSource},Le(this,e)));t.didDrop=!1,t.dropTarget=0[0],this._basicEventHandler("drop",t),this.fire("drop:after",t)}_onContextMenu(e){const t=this.findTarget(e),n=this.targets||[],s=this._basicEventHandler("contextmenu:before",{e,target:t,subTargets:n});return this.stopContextMenu&&ei(e),this._basicEventHandler("contextmenu",s),!1}_onClick(e){const t=e.detail;t>3||t<2||(this._cacheTransformEventData(e),2==t&&"dblclick"===e.type&&this._handleEvent(e,"dblclick"),3==t&&this._handleEvent(e,"tripleclick"),this._resetTransformEventData())}getPointerId(e){const t=e.changedTouches;return t?t[0]&&t[0].identifier:this.enablePointerEvents?e.pointerId:-1}_isMainEvent(e){return!0===e.isPrimary||!1!==e.isPrimary&&("touchend"===e.type&&0===e.touches.length||!e.changedTouches||e.changedTouches[0].identifier===this.mainTouchId)}_onTouchStart(e){let t=!this.allowTouchScrolling;const n=this._activeObject;0[0]===this.mainTouchId&&(this.mainTouchId=this.getPointerId(e)),this.__onMouseDown(e),(this.isDrawingMode||n&&this._target===n)&&(t=!0),t&&e.preventDefault(),this._resetTransformEventData();const s=this.upperCanvasEl,i=this._getEventPrefix(),o=H(s);de(o,"touchend",this._onTouchEnd,T),t&&de(o,"touchmove",this._onMouseMove,T),L(s,"".concat(i,"down"),this._onMouseDown)}_onMouseDown(e){this.__onMouseDown(e),this._resetTransformEventData();const n=this.upperCanvasEl,t=this._getEventPrefix();L(n,"".concat(t,"move"),this._onMouseMove,T);const s=H(n);de(s,"".concat(t,"up"),this._onMouseUp),de(s,"".concat(t,"move"),this._onMouseMove,T)}_onTouchEnd(e){if(e.touches.length>0)return;this.__onMouseUp(e),this._resetTransformEventData(),delete this.mainTouchId;const n=this._getEventPrefix(),t=H(this.upperCanvasEl);L(t,"touchend",this._onTouchEnd,T),L(t,"touchmove",this._onMouseMove,T),this._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout(()=>{de(this.upperCanvasEl,"".concat(n,"down"),this._onMouseDown),this._willAddMouseDown=0},400)}_onMouseUp(e){this.__onMouseUp(e),this._resetTransformEventData();const n=this.upperCanvasEl,t=this._getEventPrefix();if(this._isMainEvent(e)){const e=H(this.upperCanvasEl);L(e,"".concat(t,"up"),this._onMouseUp),L(e,"".concat(t,"move"),this._onMouseMove,T),de(n,"".concat(t,"move"),this._onMouseMove,T)}}_onMouseMove(e){const t=this.getActiveObject();!this.allowTouchScrolling&&(!t||!t.shouldStartDragging(e))&&e.preventDefault&&e.preventDefault(),this.__onMouseMove(e)}_onResize(){this.calcOffset(),this._resetTransformEventData()}_shouldRender(e){const t=this.getActiveObject();return!!t!=!!e||t&&e&&t!==e}__onMouseUp(e){var i;this._cacheTransformEventData(e),this._handleEvent(e,"up:before");const n=this._currentTransform,r=this._isClick,t=this._target,{button:a}=e;if(a)return(this.fireMiddleClick&&1===a||this.fireRightClick&&2===a)&&this._handleEvent(e,"up"),void this._resetTransformEventData();if(this.isDrawingMode&&this._isCurrentlyDrawing)return void this._onMouseUpInDrawingMode(e);if(!this._isMainEvent(e))return;let s,c,o=!1;if(n&&(this._finalizeCurrentTransform(e),o=n.actionPerformed),!r){const n=t===this._activeObject;this.handleSelection(e),o||(o=this._shouldRender(t)||!n&&t===this._activeObject)}if(t){const a=t.findControl(this.getViewportPoint(e),un(e)),{key:r,control:i}=a||{};if(c=r,t.selectable&&t!==this._activeObject&&"up"===t.activeOn)this.setActiveObject(t,e),o=!0;else if(i){const o=i.getMouseUpHandler(e,t,i);o&&(s=this.getScenePoint(e),o.call(i,e,n,s.x,s.y))}t.isMoving=!1}if(n&&(n.target!==t||n.corner!==c)){const t=n.target&&n.target.controls[n.corner],o=t&&t.getMouseUpHandler(e,n.target,t);s=s||this.getScenePoint(e),o&&o.call(t,e,n,s.x,s.y)}this._setCursorFromEvent(e,t),this._handleEvent(e,"up"),this._groupSelector=null,this._currentTransform=null,t&&(t.__corner=0[0]),o?this.requestRenderAll():r||null!==(i=this._activeObject)&&0[0]!==i&&i.isEditing||this.renderTop()}_basicEventHandler(e,t){const{target:n,subTargets:s=[]}=t;this.fire(e,t),n&&n.fire(e,t);for(let o=0;o<s.length;o++)s[o]!==n&&s[o].fire(e,t);return t}_handleEvent(e,t,s){const o=this._target,i=this.targets||[],a=n(n(n({e,target:o,subTargets:i},Le(this,e)),{},{transform:this._currentTransform},"up:before"===t||"up"===t?{isClick:this._isClick,currentTarget:this.findTarget(e),currentSubTargets:this.targets}:{}),"down:before"===t||"down"===t?s:{});this.fire("mouse:".concat(t),a),o&&o.fire("mouse".concat(t),a);for(let e=0;e<i.length;e++)i[e]!==o&&i[e].fire("mouse".concat(t),a)}_onMouseDownInDrawingMode(e){this._isCurrentlyDrawing=!0,this.getActiveObject()&&(this.discardActiveObject(e),this.requestRenderAll());const t=this.getScenePoint(e);this.freeDrawingBrush&&this.freeDrawingBrush.onMouseDown(t,{e,pointer:t}),this._handleEvent(e,"down",{alreadySelected:!1})}_onMouseMoveInDrawingMode(e){if(this._isCurrentlyDrawing){const t=this.getScenePoint(e);this.freeDrawingBrush&&this.freeDrawingBrush.onMouseMove(t,{e,pointer:t})}this.setCursor(this.freeDrawingCursor),this._handleEvent(e,"move")}_onMouseUpInDrawingMode(e){const t=this.getScenePoint(e);this.freeDrawingBrush?this._isCurrentlyDrawing=!!this.freeDrawingBrush.onMouseUp({e,pointer:t}):this._isCurrentlyDrawing=!1,this._handleEvent(e,"up")}__onMouseDown(e){this._isClick=!0,this._cacheTransformEventData(e),this._handleEvent(e,"down:before");let t=this._target,n=!!t&&t===this._activeObject;const{button:s}=e;if(s)return(this.fireMiddleClick&&1===s||this.fireRightClick&&2===s)&&this._handleEvent(e,"down",{alreadySelected:n}),void this._resetTransformEventData();if(this.isDrawingMode)return void this._onMouseDownInDrawingMode(e);if(!this._isMainEvent(e))return;if(this._currentTransform)return;let o=this._shouldRender(t),i=!1;if(this.handleMultiSelection(e,t)?(t=this._activeObject,i=!0,o=!0):this._shouldClearSelection(e,t)&&this.discardActiveObject(e),this.selection&&(!t||!t.selectable&&!t.isEditing&&t!==this._activeObject)){const t=this.getScenePoint(e);this._groupSelector={x:t.x,y:t.y,deltaY:0,deltaX:0}}if(n=!!t&&t===this._activeObject,t){t.selectable&&"down"===t.activeOn&&this.setActiveObject(t,e);const s=t.findControl(this.getViewportPoint(e),un(e));if(t===this._activeObject&&(s||!i)){this._setupCurrentTransform(e,t,n);const o=s?s.control:0[0],i=this.getScenePoint(e),a=o&&o.getMouseDownHandler(e,t,o);a&&a.call(o,e,this._currentTransform,i.x,i.y)}}o&&(this._objectsToRender=0[0]),this._handleEvent(e,"down",{alreadySelected:n}),o&&this.requestRenderAll()}_resetTransformEventData(){this._target=this._pointer=this._absolutePointer=0[0]}_cacheTransformEventData(e){this._resetTransformEventData(),this._pointer=this.getViewportPoint(e),this._absolutePointer=re(this._pointer,0[0],this.viewportTransform),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(e)}__onMouseMove(e){if(this._isClick=!1,this._cacheTransformEventData(e),this._handleEvent(e,"move:before"),this.isDrawingMode)return void this._onMouseMoveInDrawingMode(e);if(!this._isMainEvent(e))return;const t=this._groupSelector;if(t){const n=this.getScenePoint(e);t.deltaX=n.x-t.x,t.deltaY=n.y-t.y,this.renderTop()}else if(this._currentTransform)this._transformObject(e);else{const t=this.findTarget(e);this._setCursorFromEvent(e,t),this._fireOverOutEvents(e,t)}this.textEditingManager.onMouseMove(e),this._handleEvent(e,"move"),this._resetTransformEventData()}_fireOverOutEvents(e,t){const o=this._hoveredTarget,n=this._hoveredTargets,s=this.targets,i=Math.max(n.length,s.length);this.fireSyntheticInOutEvents("mouse",{e,target:t,oldTarget:o,fireCanvas:!0});for(let t=0;t<i;t++)this.fireSyntheticInOutEvents("mouse",{e,target:s[t],oldTarget:n[t]});this._hoveredTarget=t,this._hoveredTargets=this.targets.concat()}_fireEnterLeaveEvents(e,t){const i=this._draggedoverTarget,s=this._hoveredTargets,o=this.targets,a=Math.max(s.length,o.length);this.fireSyntheticInOutEvents("drag",n(n({},t),{},{target:e,oldTarget:i,fireCanvas:!0}));for(let e=0;e<a;e++)this.fireSyntheticInOutEvents("drag",n(n({},t),{},{target:o[e],oldTarget:s[e]}));this._draggedoverTarget=e}fireSyntheticInOutEvents(e,t){let{target:s,oldTarget:o,fireCanvas:a,e:i}=t,r=d(t,Da);const{targetIn:l,targetOut:u,canvasIn:h,canvasOut:m}=Fa[e],c=o!==s;if(o&&c){const e=n(n({},r),{},{e:i,target:o,nextTarget:s},Le(this,i));a&&this.fire(m,e),o.fire(u,e)}if(s&&c){const e=n(n({},r),{},{e:i,target:s,previousTarget:o},Le(this,i));a&&this.fire(h,e),s.fire(l,e)}}__onMouseWheel(e){this._cacheTransformEventData(e),this._handleEvent(e,"wheel"),this._resetTransformEventData()}_transformObject(e){const n=this.getScenePoint(e),t=this._currentTransform,s=t.target,o=s.group?re(n,0[0],s.group.calcTransformMatrix()):n;t.shiftKey=e.shiftKey,t.altKey=!!this.centeredKey&&e[this.centeredKey],this._performTransformAction(e,t,o),t.actionPerformed&&this.requestRenderAll()}_performTransformAction(e,t,n){const{action:i,actionHandler:o,target:a}=t,s=!!o&&o(e,t,n.x,n.y);s&&a.setCoords(),"drag"===i&&s&&(t.target.isMoving=!0,this.setCursor(t.target.moveCursor||this.moveCursor)),t.actionPerformed=t.actionPerformed||s}_setCursorFromEvent(e,t){if(!t)return void this.setCursor(this.defaultCursor);let n=t.hoverCursor||this.hoverCursor;const s=Te(this._activeObject)?this._activeObject:null,o=(!s||t.group!==s)&&t.findControl(this.getViewportPoint(e));if(o){const n=o.control;this.setCursor(n.cursorStyleHandler(e,n,t))}else t.subTargetCheck&&this.targets.concat().reverse().map(e=>{n=e.hoverCursor||n}),this.setCursor(n)}handleMultiSelection(e,t){const n=this._activeObject,s=Te(n);if(n&&this._isSelectionKeyPressed(e)&&this.selection&&t&&t.selectable&&(n!==t||s)&&(s||!t.isDescendantOf(n)&&!n.isDescendantOf(t))&&!t.onSelect({e})&&!n.getActiveControl()){if(s){const s=n.getObjects();if(t===n){const n=this.getViewportPoint(e);if(!(t=this.searchPossibleTargets(s,n)||this.searchPossibleTargets(this._objects,n))||!t.selectable)return!1}t.group===n?(n.remove(t),this._hoveredTarget=t,this._hoveredTargets=[...this.targets],1===n.size()&&this._setActiveObject(n.item(0),e)):(n.multiSelectAdd(t),this._hoveredTarget=n,this._hoveredTargets=[...this.targets]),this._fireSelectionEvents(s,e)}else{n.isEditing&&n.exitEditing();const s=new(o.getClass("ActiveSelection"))([],{canvas:this});s.multiSelectAdd(n,t),this._hoveredTarget=s,this._setActiveObject(s,e),this._fireSelectionEvents([n],e)}return!0}return!1}handleSelection(e){if(!this.selection||!this._groupSelector)return!1;const{x:l,y:d,deltaX:u,deltaY:h}=this._groupSelector,n=new s(l,d),a=n.add(new s(u,h)),r=n.min(a),c=n.max(a).subtract(r),t=this.collectObjects({left:r.x,top:r.y,width:c.x,height:c.y},{includeIntersecting:!this.selectionFullyContained}),i=n.eq(a)?t[0]?[t[0]]:[]:t.length>1?t.filter(t=>!t.onSelect({e})).reverse():t;if(1===i.length)this.setActiveObject(i[0],e);else if(i.length>1){const t=o.getClass("ActiveSelection");this.setActiveObject(new t(i,{canvas:this}),e)}return this._groupSelector=null,!0}clear(){this.textEditingManager.clear(),super.clear()}destroy(){this.removeListeners(),this.textEditingManager.dispose(),super.destroy()}}const Ii={x1:0,y1:0,x2:0,y2:0},Sa=n(n({},Ii),{},{r1:0,r2:0}),Ke=(e,t)=>isNaN(e)&&"number"==typeof t?t:e,Ea=/^(\d+\.\d+)%|(\d+)%$/;function Wi(e){return e&&Ea.test(e)}function Ui(e,t){const n="number"==typeof e?e:"string"==typeof e?parseFloat(e)/(Wi(e)?100:1):NaN;return Fe(0,Ke(n,t),1)}const Oa=/\s*;\s*/,wa=/\s*:\s*/;function _a(e,t){let n,s;const o=e.getAttribute("style");if(o){const e=o.split(Oa);""===e[e.length-1]&&e.pop();for(let t=e.length;t--;){const[o,i]=e[t].split(wa).map(e=>e.trim());"stop-color"===o?n=i:"stop-opacity"===o&&(s=i)}}const i=new r(n||e.getAttribute("stop-color")||"rgb(0,0,0)");return{offset:Ui(e.getAttribute("offset"),0),color:i.toRgb(),opacity:Ke(parseFloat(s||e.getAttribute("stop-opacity")||""),1)*i.getAlpha()*t}}function ya(e,t){const n=[],s=e.getElementsByTagName("stop"),o=Ui(t,1);for(let e=s.length;e--;)n.push(_a(s[e],o));return n}function Xi(e){return"linearGradient"===e.nodeName||"LINEARGRADIENT"===e.nodeName?"linear":"radial"}function Qi(e){return"userSpaceOnUse"===e.getAttribute("gradientUnits")?"pixels":"percentage"}function K(e,t){return e.getAttribute(t)}function ba(e,t){return function(e,t){let n,{width:s,height:o,gradientUnits:i}=t;return Object.keys(e).reduce((t,a)=>{const r=e[a];return"Infinity"===r?n=1:"-Infinity"===r?n=0:(n="string"==typeof r?parseFloat(r):r,"string"==typeof r&&Wi(r)&&(n*=.01,"pixels"===i&&("x1"!==a&&"x2"!==a&&"r2"!==a||(n*=s),"y1"!==a&&"y2"!==a||(n*=o)))),t[a]=n,t},{})}("linear"===Xi(e)?function(e){return{x1:K(e,"x1")||0,y1:K(e,"y1")||0,x2:K(e,"x2")||"100%",y2:K(e,"y2")||0}}(e):function(e){return{x1:K(e,"fx")||K(e,"cx")||"50%",y1:K(e,"fy")||K(e,"cy")||"50%",r1:0,x2:K(e,"cx")||"50%",y2:K(e,"cy")||"50%",r2:K(e,"r")||"50%"}}(e),n(n({},t),{},{gradientUnits:Qi(e)}))}class We{constructor(e){const{type:t="linear",gradientUnits:o="pixels",coords:i={},colorStops:a=[],offsetX:r=0,offsetY:c=0,gradientTransform:l,id:s}=e||{};Object.assign(this,{type:t,gradientUnits:o,coords:n(n({},"radial"===t?Sa:Ii),i),colorStops:a,offsetX:r,offsetY:c,gradientTransform:l,id:s?"".concat(s,"_").concat(fe()):fe()})}addColorStop(e){for(const t in e){const n=new r(e[t]);this.colorStops.push({offset:parseFloat(t),color:n.toRgb(),opacity:n.getAlpha()})}return this}toObject(e){return n(n({},Ce(this,e)),{},{type:this.type,coords:n({},this.coords),colorStops:this.colorStops.map(e=>n({},e)),offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform?[...this.gradientTransform]:0[0]})}toSVG(e){let{additionalTransform:r}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};const t=[],a=this.gradientTransform?this.gradientTransform.concat():_.concat(),c="pixels"===this.gradientUnits?"userSpaceOnUse":"objectBoundingBox",s=this.colorStops.map(e=>n({},e)).sort((e,t)=>e.offset-t.offset);let o=-this.offsetX,i=-this.offsetY;var l;"objectBoundingBox"===c?(o/=e.width,i/=e.height):(o+=e.width/2,i+=e.height/2),(l=e)&&"function"==typeof l._renderPathCommands&&"percentage"!==this.gradientUnits&&(o-=e.pathOffset.x,i-=e.pathOffset.y),a[4]-=o,a[5]-=i;const d=['id="SVGID_'.concat(this.id,'"'),'gradientUnits="'.concat(c,'"'),'gradientTransform="'.concat(r?r+" ":"").concat($e(a),'"'),""].join(" ");if("linear"===this.type){const{x1:e,y1:n,x2:s,y2:o}=this.coords;t.push("<linearGradient ",d,' x1="',e,'" y1="',n,'" x2="',s,'" y2="',o,`">
`)}else if("radial"===this.type){const{x1:i,y1:a,x2:r,y2:c,r1:n,r2:o}=this.coords,e=n>o;t.push("<radialGradient ",d,' cx="',e?i:r,'" cy="',e?a:c,'" r="',e?n:o,'" fx="',e?r:i,'" fy="',e?c:a,`">
`),e&&(s.reverse(),s.forEach(e=>{e.offset=1-e.offset}));const l=Math.min(n,o);if(l>0){const e=l/Math.max(n,o);s.forEach(t=>{t.offset+=e*(1-t.offset)})}}return s.forEach(e=>{let{color:s,offset:o,opacity:n}=e;t.push("<stop ",'offset="',100*o+"%",'" style="stop-color:',s,0[0]!==n?";stop-opacity: "+n:";",`"/>
`)}),t.push("linear"===this.type?"</linearGradient>":"</radialGradient>",`
`),t.join("")}toLive(e){const{x1:t,y1:n,x2:s,y2:o,r1:a,r2:c}=this.coords,i="linear"===this.type?e.createLinearGradient(t,n,s,o):e.createRadialGradient(t,n,a,s,o,c);return this.colorStops.forEach(e=>{let{color:t,opacity:n,offset:s}=e;i.addColorStop(s,0[0]!==n?new r(t).setAlpha(n).toRgba():t)}),i}static async fromObject(e){const{colorStops:t,gradientTransform:s}=e;return new this(n(n({},e),{},{colorStops:t?t.map(e=>n({},e)):0[0],gradientTransform:s?[...s]:0[0]}))}static fromElement(e,t,s){const o=Qi(e),i=t._findCenterFromElement();return new this(n({id:e.getAttribute("id")||0[0],type:Xi(e),coords:ba(e,{width:s.viewBoxWidth||s.width,height:s.viewBoxHeight||s.height}),colorStops:ya(e,s.opacity),gradientUnits:o,gradientTransform:lt(e.getAttribute("gradientTransform")||"")},"pixels"===o?{offsetX:t.width/2-i.x,offsetY:t.height/2-i.y}:{offsetX:0,offsetY:0}))}}t(We,"type","Gradient"),o.setClass(We,"gradient"),o.setClass(We,"linear"),o.setClass(We,"radial");const ga=["type","source","patternTransform"];class ct{get type(){return"pattern"}set type(e){ie("warn","Setting type has no effect",e)}constructor(e){t(this,"repeat","repeat"),t(this,"offsetX",0),t(this,"offsetY",0),t(this,"crossOrigin",""),this.id=fe(),Object.assign(this,e)}isImageSource(){return!!this.source&&"string"==typeof this.source.src}isCanvasSource(){return!!this.source&&!!this.source.toDataURL}sourceToString(){return this.isImageSource()?this.source.src:this.isCanvasSource()?this.source.toDataURL():""}toLive(e){return this.source&&(!this.isImageSource()||this.source.complete&&0!==this.source.naturalWidth&&0!==this.source.naturalHeight)?e.createPattern(this.source,this.repeat):null}toObject(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];const{repeat:t,crossOrigin:s}=this;return n(n({},Ce(this,e)),{},{type:"pattern",source:this.sourceToString(),repeat:t,crossOrigin:s,offsetX:l(this.offsetX,a.NUM_FRACTION_DIGITS),offsetY:l(this.offsetY,a.NUM_FRACTION_DIGITS),patternTransform:this.patternTransform?[...this.patternTransform]:null})}toSVG(e){let{width:s,height:o}=e;const{source:t,repeat:n,id:r}=this,i=Ke(this.offsetX/s,0),a=Ke(this.offsetY/o,0),c="repeat-y"===n||"no-repeat"===n?1+Math.abs(i||0):Ke(t.width/s,0),l="repeat-x"===n||"no-repeat"===n?1+Math.abs(a||0):Ke(t.height/o,0);return['<pattern id="SVGID_'.concat(r,'" x="').concat(i,'" y="').concat(a,'" width="').concat(c,'" height="').concat(l,'">'),'<image x="0" y="0" width="'.concat(t.width,'" height="').concat(t.height,'" xlink:href="').concat(this.sourceToString(),'"></image>'),"</pattern>",""].join(`
`)}static async fromObject(e,t){let{type:r,source:i,patternTransform:s}=e,o=d(e,ga);const a=await wt(i,n(n({},t),{},{crossOrigin:o.crossOrigin}));return new this(n(n({},o),{},{patternTransform:s&&s.slice(0),source:a}))}}t(ct,"type","Pattern"),o.setClass(ct),o.setClass(ct,"pattern");class ln{constructor(e){t(this,"color","rgb(0, 0, 0)"),t(this,"width",1),t(this,"shadow",null),t(this,"strokeLineCap","round"),t(this,"strokeLineJoin","round"),t(this,"strokeMiterLimit",10),t(this,"strokeDashArray",null),t(this,"limitedToCanvasSize",!1),this.canvas=e}_setBrushStyles(e){e.strokeStyle=this.color,e.lineWidth=this.width,e.lineCap=this.strokeLineCap,e.miterLimit=this.strokeMiterLimit,e.lineJoin=this.strokeLineJoin,e.setLineDash(this.strokeDashArray||[])}_saveAndTransform(e){const t=this.canvas.viewportTransform;e.save(),e.transform(t[0],t[1],t[2],t[3],t[4],t[5])}needsFullRender(){return new r(this.color).getAlpha()<1||!!this.shadow}_setShadow(){if(!this.shadow||!this.canvas)return;const n=this.canvas,e=this.shadow,t=n.contextTop,s=n.getZoom()*n.getRetinaScaling();t.shadowColor=e.color,t.shadowBlur=e.blur*s,t.shadowOffsetX=e.offsetX*s,t.shadowOffsetY=e.offsetY*s}_resetShadow(){const e=this.canvas.contextTop;e.shadowColor="",e.shadowBlur=e.shadowOffsetX=e.shadowOffsetY=0}_isOutSideCanvas(e){return e.x<0||e.x>this.canvas.getWidth()||e.y<0||e.y>this.canvas.getHeight()}}const da=["path","left","top"],la=["d"];class ue extends b{constructor(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{},{path:i,left:n,top:s}=t,o=d(t,da);super(),Object.assign(this,ue.ownDefaults),this.setOptions(o),this._setPath(e||[],!0),"number"==typeof n&&this.set(c,n),"number"==typeof s&&this.set(A,s)}_setPath(e,t){this.path=ii(Array.isArray(e)?e:wi(e)),this.setBoundingBox(t)}_findCenterFromElement(){const e=this._calcBoundsFromPath();return new s(e.left+e.width/2,e.top+e.height/2)}_renderPathCommands(e){const t=-this.pathOffset.x,n=-this.pathOffset.y;e.beginPath();for(const s of this.path)switch(s[0]){case"L":e.lineTo(s[1]+t,s[2]+n);break;case"M":e.moveTo(s[1]+t,s[2]+n);break;case"C":e.bezierCurveTo(s[1]+t,s[2]+n,s[3]+t,s[4]+n,s[5]+t,s[6]+n);break;case"Q":e.quadraticCurveTo(s[1]+t,s[2]+n,s[3]+t,s[4]+n);break;case"Z":e.closePath()}}_render(e){this._renderPathCommands(e),this._renderPaintInOrder(e)}toString(){return"#<Path (".concat(this.complexity(),'): { "top": ').concat(this.top,', "left": ').concat(this.left," }>")}toObject(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];return n(n({},super.toObject(e)),{},{path:this.path.map(e=>e.slice())})}toDatalessObject(){let t=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];const e=this.toObject(t);return this.sourcePath&&(delete e.path,e.sourcePath=this.sourcePath),e}_toSVG(){const e=Ln(this.path,a.NUM_FRACTION_DIGITS);return["<path ","COMMON_PARTS",'d="'.concat(e,`" stroke-linecap="round" />
`)]}_getOffsetTransform(){const e=a.NUM_FRACTION_DIGITS;return" translate(".concat(l(-this.pathOffset.x,e),", ").concat(l(-this.pathOffset.y,e),")")}toClipPathSVG(e){const t=this._getOffsetTransform();return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:e,additionalTransform:t})}toSVG(e){const t=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:e,additionalTransform:t})}complexity(){return this.path.length}setDimensions(){this.setBoundingBox()}setBoundingBox(e){const{width:n,height:s,pathOffset:t}=this._calcDimensions();this.set({width:n,height:s,pathOffset:t}),e&&this.setPositionByOrigin(t,i,i)}_calcBoundsFromPath(){const n=[];let s=0,o=0,e=0,t=0;for(const i of this.path)switch(i[0]){case"L":e=i[1],t=i[2],n.push({x:s,y:o},{x:e,y:t});break;case"M":e=i[1],t=i[2],s=e,o=t;break;case"C":n.push(...In(e,t,i[1],i[2],i[3],i[4],i[5],i[6])),e=i[5],t=i[6];break;case"Q":n.push(...In(e,t,i[1],i[2],i[1],i[2],i[3],i[4])),e=i[3],t=i[4];break;case"Z":e=s,t=o}return te(n)}_calcDimensions(){const e=this._calcBoundsFromPath();return n(n({},e),{},{pathOffset:new s(e.left+e.width/2,e.top+e.height/2)})}static fromObject(e){return this._fromObject(e,{extraParam:"path"})}static async fromElement(e,t,s){const o=J(e,this.ATTRIBUTE_NAMES,s),{d:i}=o;return new this(i,n(n(n({},d(o,la)),t),{},{left:0[0],top:0[0]}))}}t(ue,"type","Path"),t(ue,"cacheProperties",[...se,"path","fillRule"]),t(ue,"ATTRIBUTE_NAMES",[...he,"d"]),o.setClass(ue),o.setSVGClass(ue);class on extends ln{constructor(e){super(e),t(this,"decimate",.4),t(this,"drawStraightLine",!1),t(this,"straightLineKey","shiftKey"),this._points=[],this._hasStraightLine=!1}needsFullRender(){return super.needsFullRender()||this._hasStraightLine}static drawSegment(e,t,n){const s=t.midPointFrom(n);return e.quadraticCurveTo(t.x,t.y,s.x,s.y),s}onMouseDown(e,t){let{e:n}=t;this.canvas._isMainEvent(n)&&(this.drawStraightLine=!!this.straightLineKey&&n[this.straightLineKey],this._prepareForDrawing(e),this._addPoint(e),this._render())}onMouseMove(e,t){let{e:n}=t;if(this.canvas._isMainEvent(n)&&(this.drawStraightLine=!!this.straightLineKey&&n[this.straightLineKey],(!0!==this.limitedToCanvasSize||!this._isOutSideCanvas(e))&&this._addPoint(e)&&this._points.length>1))if(this.needsFullRender())this.canvas.clearContext(this.canvas.contextTop),this._render();else{const t=this._points,n=t.length,e=this.canvas.contextTop;this._saveAndTransform(e),this.oldEnd&&(e.beginPath(),e.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=on.drawSegment(e,t[n-2],t[n-1]),e.stroke(),e.restore()}}onMouseUp(e){let{e:t}=e;return!this.canvas._isMainEvent(t)||(this.drawStraightLine=!1,this.oldEnd=0[0],this._finalizeAndAddPath(),!1)}_prepareForDrawing(e){this._reset(),this._addPoint(e),this.canvas.contextTop.moveTo(e.x,e.y)}_addPoint(e){return!(this._points.length>1&&e.eq(this._points[this._points.length-1]))&&(this.drawStraightLine&&this._points.length>1&&(this._hasStraightLine=!0,this._points.pop()),this._points.push(e),!0)}_reset(){this._points=[],this._setBrushStyles(this.canvas.contextTop),this._setShadow(),this._hasStraightLine=!1}_render(){let t=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:this.canvas.contextTop,e=this._points[0],n=this._points[1];if(this._saveAndTransform(t),t.beginPath(),2===this._points.length&&e.x===n.x&&e.y===n.y){const t=this.width/1e3;e.x-=t,n.x+=t}t.moveTo(e.x,e.y);for(let s=1;s<this._points.length;s++)on.drawSegment(t,e,n),e=this._points[s],n=this._points[s+1];t.lineTo(e.x,e.y),t.stroke(),t.restore()}convertPointsToSVGPath(e){const t=this.width/1e3;return Oi(e,t)}createPath(e){const t=new ue(e,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeMiterLimit:this.strokeMiterLimit,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray});return this.shadow&&(this.shadow.affectStroke=!0,t.shadow=new R(this.shadow)),t}decimatePoints(e,t){if(e.length<=2)return e;let o,n=e[0];const a=this.canvas.getZoom(),r=(t/a)**2,i=e.length-1,s=[n];for(let t=1;t<i-1;t++)o=(n.x-e[t].x)**2+(n.y-e[t].y)**2,o>=r&&(n=e[t],s.push(n));return s.push(e[i]),s}_finalizeAndAddPath(){this.canvas.contextTop.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate));const t=this.convertPointsToSVGPath(this._points);if(function(e){return"M 0 0 Q 0 0 0 0 L 0 0"===Ln(e)}(t))return void this.canvas.requestRenderAll();const e=this.createPath(t);this.canvas.clearContext(this.canvas.contextTop),this.canvas.fire("before:path:created",{path:e}),this.canvas.add(e),this.canvas.requestRenderAll(),e.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:e})}}const ca=["left","top","radius"],Wo=["radius","startAngle","endAngle","counterClockwise"];class X extends b{static getDefaults(){return n(n({},super.getDefaults()),X.ownDefaults)}constructor(e){super(),Object.assign(this,X.ownDefaults),this.setOptions(e)}_set(e,t){return super._set(e,t),"radius"===e&&this.setRadius(t),this}_render(e){e.beginPath(),e.arc(0,0,this.radius,m(this.startAngle),m(this.endAngle),this.counterClockwise),this._renderPaintInOrder(e)}getRadiusX(){return this.get("radius")*this.get(O)}getRadiusY(){return this.get("radius")*this.get(z)}setRadius(e){this.radius=e,this.set({width:2*e,height:2*e})}toObject(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];return super.toObject([...Wo,...e])}_toSVG(){const e=(this.endAngle-this.startAngle)%360;if(0===e)return["<circle ","COMMON_PARTS",'cx="0" cy="0" ','r="',"".concat(this.radius),`" />
`];{const{radius:t}=this,n=m(this.startAngle),s=m(this.endAngle),o=I(n)*t,i=V(n)*t,a=I(s)*t,r=V(s)*t,c=e>180?1:0,l=this.counterClockwise?0:1;return['<path d="M '.concat(o," ").concat(i," A ").concat(t," ").concat(t," 0 ").concat(c," ").concat(l," ").concat(a," ").concat(r,'" '),"COMMON_PARTS",` />
`]}}static async fromElement(e,t,s){const i=J(e,this.ATTRIBUTE_NAMES,s),{left:a=0,top:r=0,radius:o=0}=i;return new this(n(n({},d(i,ca)),{},{radius:o,left:a-o,top:r-o}))}static fromObject(e){return super._fromObject(e)}}t(X,"type","Circle"),t(X,"cacheProperties",[...se,...Wo]),t(X,"ownDefaults",{radius:0,startAngle:0,endAngle:360,counterClockwise:!1}),t(X,"ATTRIBUTE_NAMES",["cx","cy","r",...he]),o.setClass(X),o.setSVGClass(X);const ua=["x1","y1","x2","y2"],ha=["x1","y1","x2","y2"],ns=["x1","x2","y1","y2"];class Oe extends b{constructor(){let[s,o,i,a]=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[0,0,0,0],e=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};super(),Object.assign(this,Oe.ownDefaults),this.setOptions(e),this.x1=s,this.x2=i,this.y1=o,this.y2=a,this._setWidthHeight();const{left:t,top:n}=e;"number"==typeof t&&this.set(c,t),"number"==typeof n&&this.set(A,n)}_setWidthHeight(){const{x1:e,y1:t,x2:n,y2:o}=this;this.width=Math.abs(n-e),this.height=Math.abs(o-t);const{left:a,top:r,width:c,height:l}=te([{x:e,y:t},{x:n,y:o}]),d=new s(a+c/2,r+l/2);this.setPositionByOrigin(d,i,i)}_set(e,t){return super._set(e,t),ns.includes(e)&&this._setWidthHeight(),this}_render(e){e.beginPath();const t=this.calcLinePoints();e.moveTo(t.x1,t.y1),e.lineTo(t.x2,t.y2),e.lineWidth=this.strokeWidth;const s=e.strokeStyle;var n;D(this.stroke)?e.strokeStyle=this.stroke.toLive(e):e.strokeStyle=null!==(n=this.stroke)&&0[0]!==n?n:e.fillStyle,this.stroke&&this._renderStroke(e),e.strokeStyle=s}_findCenterFromElement(){return new s((this.x1+this.x2)/2,(this.y1+this.y2)/2)}toObject(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];return n(n({},super.toObject(e)),this.calcLinePoints())}_getNonTransformedDimensions(){const e=super._getNonTransformedDimensions();return"butt"===this.strokeLineCap&&(0===this.width&&(e.y-=this.strokeWidth),0===this.height&&(e.x-=this.strokeWidth)),e}calcLinePoints(){const{x1:o,x2:i,y1:a,y2:r,width:e,height:t}=this,n=o<=i?-1:1,s=a<=r?-1:1;return{x1:n*e/2,x2:n*-e/2,y1:s*t/2,y2:s*-t/2}}_toSVG(){const{x1:e,x2:t,y1:n,y2:s}=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="'.concat(e,'" y1="').concat(n,'" x2="').concat(t,'" y2="').concat(s,`" />
`)]}static async fromElement(e,t,n){const s=J(e,this.ATTRIBUTE_NAMES,n),{x1:o=0,y1:i=0,x2:a=0,y2:r=0}=s;return new this([o,i,a,r],d(s,ua))}static fromObject(e){let{x1:t,y1:s,x2:o,y2:i}=e,a=d(e,ha);return this._fromObject(n(n({},a),{},{points:[t,s,o,i]}),{extraParam:"points"})}}t(Oe,"type","Line"),t(Oe,"cacheProperties",[...se,...ns]),t(Oe,"ATTRIBUTE_NAMES",he.concat(ns)),o.setClass(Oe),o.setSVGClass(Oe);class _e extends b{static getDefaults(){return n(n({},super.getDefaults()),_e.ownDefaults)}constructor(e){super(),Object.assign(this,_e.ownDefaults),this.setOptions(e)}_render(e){const n=this.width/2,t=this.height/2;e.beginPath(),e.moveTo(-n,t),e.lineTo(0,-t),e.lineTo(n,t),e.closePath(),this._renderPaintInOrder(e)}_toSVG(){const t=this.width/2,e=this.height/2;return["<polygon ","COMMON_PARTS",'points="',"".concat(-t," ").concat(e,",0 ").concat(-e,",").concat(t," ").concat(e),'" />']}}t(_e,"type","Triangle"),t(_e,"ownDefaults",{width:100,height:100}),o.setClass(_e),o.setSVGClass(_e);const ta=["rx","ry"];class oe extends b{static getDefaults(){return n(n({},super.getDefaults()),oe.ownDefaults)}constructor(e){super(),Object.assign(this,oe.ownDefaults),this.setOptions(e)}_set(e,t){switch(super._set(e,t),e){case"rx":this.rx=t,this.set("width",2*t);break;case"ry":this.ry=t,this.set("height",2*t)}return this}getRx(){return this.get("rx")*this.get(O)}getRy(){return this.get("ry")*this.get(z)}toObject(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];return super.toObject([...ta,...e])}_toSVG(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" rx="'.concat(this.rx,'" ry="').concat(this.ry,`" />
`)]}_render(e){e.beginPath(),e.save(),e.transform(1,0,0,this.ry/this.rx,0,0),e.arc(0,0,this.rx,0,le,!1),e.restore(),this._renderPaintInOrder(e)}static async fromElement(e,t,n){const s=J(e,this.ATTRIBUTE_NAMES,n);return s.left=(s.left||0)-s.rx,s.top=(s.top||0)-s.ry,new this(s)}}function Ji(e){if(!e)return[];const t=e.replace(/,/g," ").trim().split(/\s+/),n=[];for(let e=0;e<t.length;e+=2)n.push({x:parseFloat(t[e]),y:parseFloat(t[e+1])});return n}t(oe,"type","Ellipse"),t(oe,"cacheProperties",[...se,...ta]),t(oe,"ownDefaults",{rx:0,ry:0}),t(oe,"ATTRIBUTE_NAMES",[...he,"cx","cy","rx","ry"]),o.setClass(oe),o.setSVGClass(oe);const ja=["left","top"],Gi={exactBoundingBox:!1};class U extends b{static getDefaults(){return n(n({},super.getDefaults()),U.ownDefaults)}constructor(){let o=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[],e=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};super(),t(this,"strokeDiff",0[0]),Object.assign(this,U.ownDefaults),this.setOptions(e),this.points=o;const{left:n,top:s}=e;this.initialized=!0,this.setBoundingBox(!0),"number"==typeof n&&this.set(c,n),"number"==typeof s&&this.set(A,s)}isOpen(){return!0}_projectStrokeOnPoints(e){return Bs(this.points,e,this.isOpen())}_calcDimensions(e){e=n({scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,strokeLineCap:this.strokeLineCap,strokeLineJoin:this.strokeLineJoin,strokeMiterLimit:this.strokeMiterLimit,strokeUniform:this.strokeUniform,strokeWidth:this.strokeWidth},e||{});const r=this.exactBoundingBox?this._projectStrokeOnPoints(e).map(e=>e.projectedPoint):this.points;if(0===r.length)return{left:0,top:0,width:0,height:0,pathOffset:new s,strokeOffset:new s,strokeDiff:new s};const t=te(r),l=gt(n(n({},e),{},{scaleX:1,scaleY:1})),o=te(this.points.map(e=>j(e,l,!0))),c=new s(this.scaleX,this.scaleY);let i=t.left+t.width/2,a=t.top+t.height/2;return this.exactBoundingBox&&(i-=a*Math.tan(m(this.skewX)),a-=i*Math.tan(m(this.skewY))),n(n({},t),{},{pathOffset:new s(i,a),strokeOffset:new s(o.left,o.top).subtract(new s(t.left,t.top)).multiply(c),strokeDiff:new s(t.width,t.height).subtract(new s(o.width,o.height)).multiply(c)})}_findCenterFromElement(){const e=te(this.points);return new s(e.left+e.width/2,e.top+e.height/2)}setDimensions(){this.setBoundingBox()}setBoundingBox(e){const{left:o,top:a,width:t,height:n,pathOffset:r,strokeOffset:c,strokeDiff:l}=this._calcDimensions();this.set({width:t,height:n,pathOffset:r,strokeOffset:c,strokeDiff:l}),e&&this.setPositionByOrigin(new s(o+t/2,a+n/2),i,i)}isStrokeAccountedForInDimensions(){return this.exactBoundingBox}_getNonTransformedDimensions(){return this.exactBoundingBox?new s(this.width,this.height):super._getNonTransformedDimensions()}_getTransformedDimensions(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};if(this.exactBoundingBox){let a;if(Object.keys(e).some(e=>this.strokeUniform||this.constructor.layoutProperties.includes(e))){var t,n,o,i;const{width:r,height:c}=this._calcDimensions(e);a=new s(null!==(t=e.width)&&0[0]!==t?t:r,null!==(n=e.height)&&0[0]!==n?n:c)}else a=new s(null!==(o=e.width)&&0[0]!==o?o:this.width,null!==(i=e.height)&&0[0]!==i?i:this.height);return a.multiply(new s(e.scaleX||this.scaleX,e.scaleY||this.scaleY))}return super._getTransformedDimensions(e)}_set(e,t){const n=this.initialized&&this[e]!==t,s=super._set(e,t);return this.exactBoundingBox&&n&&((e===O||e===z)&&this.strokeUniform&&this.constructor.layoutProperties.includes("strokeUniform")||this.constructor.layoutProperties.includes(e))&&this.setDimensions(),s}toObject(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];return n(n({},super.toObject(e)),{},{points:this.points.map(e=>{let{x:t,y:n}=e;return{x:t,y:n}})})}_toSVG(){const e=[],n=this.pathOffset.x,s=this.pathOffset.y,t=a.NUM_FRACTION_DIGITS;for(let o=0,i=this.points.length;o<i;o++)e.push(l(this.points[o].x-n,t),",",l(this.points[o].y-s,t)," ");return["<".concat(this.constructor.type.toLowerCase()," "),"COMMON_PARTS",'points="'.concat(e.join(""),`" />
`)]}_render(e){const t=this.points.length,n=this.pathOffset.x,s=this.pathOffset.y;if(t&&!isNaN(this.points[t-1].y)){e.beginPath(),e.moveTo(this.points[0].x-n,this.points[0].y-s);for(let o=0;o<t;o++){const i=this.points[o];e.lineTo(i.x-n,i.y-s)}!this.isOpen()&&e.closePath(),this._renderPaintInOrder(e)}}complexity(){return this.points.length}static async fromElement(e,t,s){return new this(Ji(e.getAttribute("points")),n(n({},d(J(e,this.ATTRIBUTE_NAMES,s),ja)),t))}static fromObject(e){return this._fromObject(e,{extraParam:"points"})}}t(U,"ownDefaults",Gi),t(U,"type","Polyline"),t(U,"layoutProperties",[Ie,He,"strokeLineCap","strokeLineJoin","strokeMiterLimit","strokeWidth","strokeUniform","points"]),t(U,"cacheProperties",[...se,"points"]),t(U,"ATTRIBUTE_NAMES",[...he]),o.setClass(U),o.setSVGClass(U);class At extends U{isOpen(){return!1}}t(At,"ownDefaults",Gi),t(At,"type","Polygon"),o.setClass(At),o.setSVGClass(At);class Ki extends b{isEmptyStyles(e){if(!this.styles)return!0;if(0[0]!==e&&!this.styles[e])return!0;const t=0[0]===e?this.styles:{line:this.styles[e]};for(const e in t)for(const n in t[e])for(const s in t[e][n])return!1;return!0}styleHas(e,t){if(!this.styles)return!1;if(0[0]!==t&&!this.styles[t])return!1;const n=0[0]===t?this.styles:{0:this.styles[t]};for(const t in n)for(const s in n[t])if(0[0]!==n[t][s][e])return!0;return!1}cleanStyle(e){if(!this.styles)return!1;const t=this.styles;let s,n,i=0,o=!0,a=0;for(const a in t){s=0;for(const c in t[a]){const r=t[a][c]||{};i++,0[0]!==r[e]?(n?r[e]!==n&&(o=!1):n=r[e],r[e]===this[e]&&delete r[e]):o=!1,0!==Object.keys(r).length?s++:delete t[a][c]}0===s&&delete t[a]}for(let e=0;e<this._textLines.length;e++)a+=this._textLines[e].length;o&&i===a&&(this[e]=n,this.removeStyle(e))}removeStyle(e){if(!this.styles)return;const s=this.styles;let t,o,n;for(o in s){for(n in t=s[o],t)delete t[n][e],0===Object.keys(t[n]).length&&delete t[n];0===Object.keys(t).length&&delete s[o]}}_extendStyles(e,t){const{lineIndex:s,charIndex:o}=this.get2DCursorLocation(e);this._getLineStyle(s)||this._setLineStyle(s);const i=zn(n(n({},this._getStyleDeclaration(s,o)),t),e=>0[0]!==e);this._setStyleDeclaration(s,o,i)}getSelectionStyles(e,t,n){const s=[];for(let o=e;o<(t||e);o++)s.push(this.getStyleAtPosition(o,n));return s}getStyleAtPosition(e,t){const{lineIndex:n,charIndex:s}=this.get2DCursorLocation(e);return t?this.getCompleteStyleDeclaration(n,s):this._getStyleDeclaration(n,s)}setSelectionStyles(e,t,n){for(let s=t;s<(n||t);s++)this._extendStyles(s,e);this._forceClearCache=!0}_getStyleDeclaration(e,t){var n;const s=this.styles&&this.styles[e];return s&&null!==(n=s[t])&&0[0]!==n?n:{}}getCompleteStyleDeclaration(e,t){return n(n({},Ce(this,this.constructor._styleProperties)),this._getStyleDeclaration(e,t))}_setStyleDeclaration(e,t,n){this.styles[e][t]=n}_deleteStyleDeclaration(e,t){delete this.styles[e][t]}_getLineStyle(e){return!!this.styles[e]}_setLineStyle(e){this.styles[e]={}}_deleteLineStyle(e){delete this.styles[e]}}t(Ki,"_styleProperties",va);const xa=/  +/g,Ca=/"/g;function gs(e,t,n,s,o){return"		".concat(function(e,t){let{left:n,top:s,width:o,height:i}=t,r=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:a.NUM_FRACTION_DIGITS;const c=Ft(v,e,!1),[d,u,h,m]=[n,s,o,i].map(e=>l(e,r));return"<rect ".concat(c,' x="').concat(d,'" y="').concat(u,'" width="').concat(h,'" height="').concat(m,'"></rect>')}(e,{left:t,top:n,width:s,height:o}),`
`)}const ka=["textAnchor","textDecoration","dx","dy","top","left","fontSize","strokeWidth"];let vs;class y extends Ki{static getDefaults(){return n(n({},super.getDefaults()),y.ownDefaults)}constructor(e,n){super(),t(this,"__charBounds",[]),Object.assign(this,y.ownDefaults),this.setOptions(n),this.styles||(this.styles={}),this.text=e,this.initialized=!0,this.path&&this.setPathInfo(),this.initDimensions(),this.setCoords()}setPathInfo(){const e=this.path;e&&(e.segmentsInfo=Rn(e.path))}_splitText(){const e=this._splitTextIntoLines(this.text);return this.textLines=e.lines,this._textLines=e.graphemeLines,this._unwrappedTextLines=e._unwrappedLines,this._text=e.graphemeText,e}initDimensions(){this._splitText(),this._clearCache(),this.dirty=!0,this.path?(this.width=this.path.width,this.height=this.path.height):(this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight()),this.textAlign.includes(ee)&&this.enlargeSpaces()}enlargeSpaces(){let t,s,i,n,o,e,a;for(let r=0,c=this._textLines.length;r<c;r++)if((this.textAlign===ee||r!==c-1&&!this.isEndOfWrapping(r))&&(n=0,o=this._textLines[r],s=this.getLineWidth(r),s<this.width&&(a=this.textLines[r].match(this._reSpacesAndTabs)))){i=a.length,t=(this.width-s)/i;for(let s=0;s<=o.length;s++)e=this.__charBounds[r][s],this._reSpaceAndTab.test(o[s])?(e.width+=t,e.kernedWidth+=t,e.left+=n,n+=t):e.left+=n}}isEndOfWrapping(e){return e===this._textLines.length-1}missingNewlineOffset(){return 1}get2DCursorLocation(e,t){const s=t?this._unwrappedTextLines:this._textLines;let n;for(n=0;n<s.length;n++){if(e<=s[n].length)return{lineIndex:n,charIndex:e};e-=s[n].length+this.missingNewlineOffset(n,t)}return{lineIndex:n-1,charIndex:s[n-1].length<e?s[n-1].length:e}}toString(){return"#<Text (".concat(this.complexity(),'): { "text": "').concat(this.text,'", "fontFamily": "').concat(this.fontFamily,'" }>')}_getCacheCanvasDimensions(){const e=super._getCacheCanvasDimensions(),t=this.fontSize;return e.width+=t*e.zoomX,e.height+=t*e.zoomY,e}_render(e){const t=this.path;t&&!t.isNotVisible()&&t._render(e),this._setTextStyles(e),this._renderTextLinesBackground(e),this._renderTextDecoration(e,"underline"),this._renderText(e),this._renderTextDecoration(e,"overline"),this._renderTextDecoration(e,"linethrough")}_renderText(e){this.paintFirst===C?(this._renderTextStroke(e),this._renderTextFill(e)):(this._renderTextFill(e),this._renderTextStroke(e))}_setTextStyles(e,t,n){if(e.textBaseline="alphabetic",this.path)switch(this.pathAlign){case i:e.textBaseline="middle";break;case"ascender":e.textBaseline=A;break;case"descender":e.textBaseline=_s}e.font=this._getFontDeclaration(t,n)}calcTextWidth(){let e=this.getLineWidth(0);for(let t=1,s=this._textLines.length;t<s;t++){const n=this.getLineWidth(t);n>e&&(e=n)}return e}_renderTextLine(e,t,n,s,o,i){this._renderChars(e,t,n,s,o,i)}_renderTextLinesBackground(e){if(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor"))return;const s=e.fillStyle,n=this._getLeftOffset();let t=this._getTopOffset();for(let s=0,u=this._textLines.length;s<u;s++){const a=this.getHeightOfLine(s);if(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor",s)){t+=a;continue}const h=this._textLines[s].length,d=this._getLineLeftOffset(s);let o,i,r=0,l=0,c=this.getValueOfPropertyAt(s,0,"textBackgroundColor");for(let m=0;m<h;m++){const u=this.__charBounds[s][m];i=this.getValueOfPropertyAt(s,m,"textBackgroundColor"),this.path?(e.save(),e.translate(u.renderLeft,u.renderTop),e.rotate(u.angle),e.fillStyle=i,i&&e.fillRect(-u.width/2,-a/this.lineHeight*(1-this._fontSizeFraction),u.width,a/this.lineHeight),e.restore()):i!==c?(o=n+d+l,"rtl"===this.direction&&(o=this.width-o-r),e.fillStyle=c,c&&e.fillRect(o,t,r,a/this.lineHeight),l=u.left,r=u.width,c=i):r+=u.kernedWidth}i&&!this.path&&(o=n+d+l,"rtl"===this.direction&&(o=this.width-o-r),e.fillStyle=i,e.fillRect(o,t,r,a/this.lineHeight)),t+=a}e.fillStyle=s,this._removeShadow(e)}_measureChar(e,t,n,s){const o=Be.getFontCache(t),h=this._getFontDeclaration(t),l=n+e,d=n&&h===this._getFontDeclaration(s),u=t.fontSize/this.CACHE_FONT_SIZE;let r,i,a,c;if(n&&0[0]!==o[n]&&(a=o[n]),0[0]!==o[e]&&(c=r=o[e]),d&&0[0]!==o[l]&&(i=o[l],c=i-a),0[0]===r||0[0]===a||0[0]===i){const s=function(){if(!vs){const e=M({width:0,height:0});vs=e.getContext("2d")}return vs}();this._setTextStyles(s,t,!0),0[0]===r&&(c=r=s.measureText(e).width,o[e]=r),0[0]===a&&d&&n&&(a=s.measureText(n).width,o[n]=a),d&&0[0]===i&&(i=s.measureText(l).width,o[l]=i,c=i-a)}return{width:r*u,kernedWidth:c*u}}getHeightOfChar(e,t){return this.getValueOfPropertyAt(e,t,"fontSize")}measureLine(e){const t=this._measureLine(e);return 0!==this.charSpacing&&(t.width-=this._getWidthOfCharSpacing()),t.width<0&&(t.width=0),t}_measureLine(e){let l,t,s=0;const n=this.pathSide===f,a=this.path,d=this._textLines[e],o=d.length,r=new Array(o);this.__charBounds[e]=r;for(let n=0;n<o;n++){const i=d[n];t=this._getGraphemeBox(i,e,n,l),r[n]=t,s+=t.kernedWidth,l=i}if(r[o]={left:t?t.left+t.width:0,width:0,kernedWidth:0,height:this.fontSize,deltaY:0},a&&a.segmentsInfo){let e=0;const l=a.segmentsInfo[a.segmentsInfo.length-1].length;switch(this.textAlign){case c:e=n?l-s:0;break;case i:e=(l-s)/2;break;case f:e=n?0:l-s}e+=this.pathStartOffset*(n?-1:1);for(let s=n?o-1:0;n?s>=0:s<o;n?s--:s++)t=r[s],e>l?e%=l:e<0&&(e+=l),this._setGraphemeOnPath(e,t),e+=t.kernedWidth}return{width:s,numOfSpaces:0}}_setGraphemeOnPath(e,t){const o=e+t.kernedWidth/2,n=this.path,s=vi(n.path,o,n.segmentsInfo);t.renderLeft=s.x-n.pathOffset.x,t.renderTop=s.y-n.pathOffset.y,t.angle=s.angle+(this.pathSide===f?Math.PI:0)}_getGraphemeBox(e,t,n,s,o){const a=this.getCompleteStyleDeclaration(t,n),u=s?this.getCompleteStyleDeclaration(t,n-1):{},i=this._measureChar(e,a,s,u);let r,c=i.kernedWidth,l=i.width;0!==this.charSpacing&&(r=this._getWidthOfCharSpacing(),l+=r,c+=r);const d={width:l,left:0,height:a.fontSize,kernedWidth:c,deltaY:a.deltaY};if(n>0&&!o){const e=this.__charBounds[t][n-1];d.left=e.left+e.width+i.kernedWidth-i.width}return d}getHeightOfLine(e){if(this.__lineHeights[e])return this.__lineHeights[e];let t=this.getHeightOfChar(e,0);for(let n=1,s=this._textLines[e].length;n<s;n++)t=Math.max(this.getHeightOfChar(e,n),t);return this.__lineHeights[e]=t*this.lineHeight*this._fontSizeMult}calcTextHeight(){let e,t=0;for(let n=0,s=this._textLines.length;n<s;n++)e=this.getHeightOfLine(n),t+=n===s-1?e/this.lineHeight:e;return t}_getLeftOffset(){return"ltr"===this.direction?-this.width/2:this.width/2}_getTopOffset(){return-this.height/2}_renderTextCommon(e,t){e.save();let n=0;const s=this._getLeftOffset(),o=this._getTopOffset();for(let i=0,r=this._textLines.length;i<r;i++){const a=this.getHeightOfLine(i),c=a/this.lineHeight,l=this._getLineLeftOffset(i);this._renderTextLine(t,e,this._textLines[i],s+l,o+n+c,i),n+=a}e.restore()}_renderTextFill(e){(this.fill||this.styleHas(v))&&this._renderTextCommon(e,"fillText")}_renderTextStroke(e){(this.stroke&&0!==this.strokeWidth||!this.isEmptyStyles())&&(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(e),e.save(),this._setLineDash(e,this.strokeDashArray),e.beginPath(),this._renderTextCommon(e,"strokeText"),e.closePath(),e.restore())}_renderChars(e,t,n,s,o,i){const _=this.getHeightOfLine(i),v=this.textAlign.includes(ee),h=this.path,j=!v&&0===this.charSpacing&&this.isEmptyStyles(i)&&!h,m="ltr"===this.direction,b="ltr"===this.direction?1:-1,y=t.direction;let u,p,a,l,g,d="",r=0;if(t.save(),y!==this.direction&&(t.canvas.setAttribute("dir",m?"ltr":"rtl"),t.direction=m?"ltr":"rtl",t.textAlign=m?c:f),o-=_*this._fontSizeFraction/this.lineHeight,j)return this._renderChar(e,t,i,0,n.join(""),s,o),void t.restore();for(let c=0,m=n.length-1;c<=m;c++)l=c===m||this.charSpacing||h,d+=n[c],a=this.__charBounds[i][c],0===r?(s+=b*(a.kernedWidth-a.width),r+=a.width):r+=a.kernedWidth,v&&!l&&this._reSpaceAndTab.test(n[c])&&(l=!0),l||(u=u||this.getCompleteStyleDeclaration(i,c),p=this.getCompleteStyleDeclaration(i,c+1),l=$t(u,p,!1)),l&&(h?(t.save(),t.translate(a.renderLeft,a.renderTop),t.rotate(a.angle),this._renderChar(e,t,i,c,d,-r/2,0),t.restore()):(g=s,this._renderChar(e,t,i,c,d,g,o)),d="",u=p,s+=b*r,r=0);t.restore()}_applyPatternGradientTransformText(e){const n=this.width+this.strokeWidth,s=this.height+this.strokeWidth,o=M({width:n,height:s}),t=o.getContext("2d");return o.width=n,o.height=s,t.beginPath(),t.moveTo(0,0),t.lineTo(n,0),t.lineTo(n,s),t.lineTo(0,s),t.closePath(),t.translate(n/2,s/2),t.fillStyle=e.toLive(t),this._applyPatternGradientTransform(t,e),t.fill(),t.createPattern(o,"no-repeat")}handleFiller(e,t,n){let s,o;return D(n)?"percentage"===n.gradientUnits||n.gradientTransform||n.patternTransform?(s=-this.width/2,o=-this.height/2,e.translate(s,o),e[t]=this._applyPatternGradientTransformText(n),{offsetX:s,offsetY:o}):(e[t]=n.toLive(e),this._applyPatternGradientTransform(e,n)):(e[t]=n,{offsetX:0,offsetY:0})}_setStrokeStyles(e,t){let{stroke:n,strokeWidth:s}=t;return e.lineWidth=s,e.lineCap=this.strokeLineCap,e.lineDashOffset=this.strokeDashOffset,e.lineJoin=this.strokeLineJoin,e.miterLimit=this.strokeMiterLimit,this.handleFiller(e,"strokeStyle",n)}_setFillStyles(e,t){let{fill:n}=t;return this.handleFiller(e,"fillStyle",n)}_renderChar(e,t,n,s,o,i,a){const c=this._getStyleDeclaration(n,s),r=this.getCompleteStyleDeclaration(n,s),l="fillText"===e&&r.fill,d="strokeText"===e&&r.stroke&&r.strokeWidth;if(d||l){if(t.save(),t.font=this._getFontDeclaration(r),c.textBackgroundColor&&this._removeShadow(t),c.deltaY&&(a+=c.deltaY),l){const e=this._setFillStyles(t,r);t.fillText(o,i-e.offsetX,a-e.offsetY)}if(d){const e=this._setStrokeStyles(t,r);t.strokeText(o,i-e.offsetX,a-e.offsetY)}t.restore()}}setSuperscript(e,t){this._setScript(e,t,this.superscript)}setSubscript(e,t){this._setScript(e,t,this.subscript)}_setScript(e,t,n){const s=this.get2DCursorLocation(e,!0),o=this.getValueOfPropertyAt(s.lineIndex,s.charIndex,"fontSize"),i=this.getValueOfPropertyAt(s.lineIndex,s.charIndex,"deltaY"),a={fontSize:o*n.size,deltaY:i+o*n.baseline};this.setSelectionStyles(a,e,t)}_getLineLeftOffset(e){const a=this.getLineWidth(e),s=this.width-a,t=this.textAlign,r=this.direction,o=this.isEndOfWrapping(e);let n=0;return t===ee||t===bt&&!o||t===jt&&!o||t===Gt&&!o?0:(t===i&&(n=s/2),t===f&&(n=s),t===bt&&(n=s/2),t===jt&&(n=s),"rtl"===r&&(t===f||t===ee||t===jt?n=0:t===c||t===Gt?n=-s:t!==i&&t!==bt||(n=-s/2)),n)}_clearCache(){this._forceClearCache=!1,this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]}getLineWidth(e){if(0[0]!==this.__lineWidths[e])return this.__lineWidths[e];const{width:t}=this.measureLine(e);return this.__lineWidths[e]=t,t}_getWidthOfCharSpacing(){return 0!==this.charSpacing?this.fontSize*this.charSpacing/1e3:0}getValueOfPropertyAt(e,t,n){var s;return null!==(s=this._getStyleDeclaration(e,t)[n])&&0[0]!==s?s:this[n]}_renderTextDecoration(e,t){if(!this[t]&&!this.styleHas(t))return;let n=this._getTopOffset();const i=this._getLeftOffset(),a=this.path,r=this._getWidthOfCharSpacing(),s="linethrough"===t?.5:"overline"===t?1:0,o=this.offsets[t];for(let c=0,k=this._textLines.length;c<k;c++){const y=this.getHeightOfLine(c);if(!this[t]&&!this.styleHas(t,c)){n+=y;continue}const E=this._textLines[c],C=y/this.lineHeight,w=this._getLineLeftOffset(c);let j=0,l=0,p=this.getValueOfPropertyAt(c,0,t),h=this.getValueOfPropertyAt(c,0,v),f=this.getValueOfPropertyAt(c,0,ke),m=p,u=h,d=f;const O=n+C*(1-this._fontSizeFraction);let g=this.getHeightOfChar(c,0),b=this.getValueOfPropertyAt(c,0,"deltaY");for(let n=0,x=E.length;n<x;n++){const r=this.__charBounds[c][n];m=this.getValueOfPropertyAt(c,n,t),u=this.getValueOfPropertyAt(c,n,v),d=this.getValueOfPropertyAt(c,n,ke);const y=this.getHeightOfChar(c,n),_=this.getValueOfPropertyAt(c,n,"deltaY");if(a&&m&&u){const t=this.fontSize*d/1e3;e.save(),e.fillStyle=h,e.translate(r.renderLeft,r.renderTop),e.rotate(r.angle),e.fillRect(-r.kernedWidth/2,o*y+_-s*t,r.kernedWidth,t),e.restore()}else if((m!==p||u!==h||y!==g||d!==f||_!==b)&&l>0){const n=this.fontSize*f/1e3;let t=i+w+j;"rtl"===this.direction&&(t=this.width-t-l),p&&h&&f&&(e.fillStyle=h,e.fillRect(t,O+o*g+b-s*n,l,n)),j=r.left,l=r.width,p=m,f=d,h=u,g=y,b=_}else l+=r.kernedWidth}let _=i+w+j;"rtl"===this.direction&&(_=this.width-_-l),e.fillStyle=u;const x=this.fontSize*d/1e3;m&&u&&d&&e.fillRect(_,O+o*g+b-s*x,l-r,x),n+=y}this._removeShadow(e)}_getFontDeclaration(){let{fontFamily:e=this.fontFamily,fontStyle:t=this.fontStyle,fontWeight:n=this.fontWeight,fontSize:s=this.fontSize}=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{},o=arguments.length>1?arguments[1]:0[0];const i=e.includes("'")||e.includes('"')||e.includes(",")||y.genericFonts.includes(e.toLowerCase())?e:'"'.concat(e,'"');return[t,n,"".concat(o?this.CACHE_FONT_SIZE:s,"px"),i].join(" ")}render(e){this.visible&&(this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._forceClearCache&&this.initDimensions(),super.render(e)))}graphemeSplit(e){return Vt(e)}_splitTextIntoLines(e){const t=e.split(this._reNewline),n=new Array(t.length),o=[`
`];let s=[];for(let e=0;e<t.length;e++)n[e]=this.graphemeSplit(t[e]),s=s.concat(n[e],o);return s.pop(),{_unwrappedLines:n,lines:t,graphemeText:s,graphemeLines:n}}toObject(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];return n(n({},super.toObject([...Yi,...e])),{},{styles:Xs(this.styles,this.text)},this.path?{path:this.path.toObject()}:{})}set(e,t){const{textLayoutProperties:o}=this.constructor;super.set(e,t);let n=!1,s=!1;if("object"==typeof e)for(const t in e)"path"===t&&this.setPathInfo(),n=n||o.includes(t),s=s||"path"===t;else n=o.includes(e),s="path"===e;return s&&this.setPathInfo(),n&&this.initialized&&(this.initDimensions(),this.setCoords()),this}complexity(){return 1}static async fromElement(e,t,s){const g=J(e,y.ATTRIBUTE_NAMES,s),l=n(n({},t),g),{textAnchor:u=c,textDecoration:a="",dx:x=0,dy:j=0,top:m=0,left:p=0,fontSize:h=ws,strokeWidth:v=1}=l,b=d(l,ka),o=new this((e.textContent||"").replace(/^\s+|\s+$|\n+/g,"").replace(/\s+/g," "),n({left:p+x,top:m+j,underline:a.includes("underline"),overline:a.includes("overline"),linethrough:a.includes("line-through"),strokeWidth:0,fontSize:h},b)),_=o.getScaledHeight()/o.height,w=((o.height+o.strokeWidth)*o.lineHeight-o.height)*_,O=o.getScaledHeight()+w;let r=0;return u===i&&(r=o.getScaledWidth()/2),u===f&&(r=o.getScaledWidth()),o.set({left:o.left-r,top:o.top-(O-o.fontSize*(.07+o._fontSizeFraction))/o.lineHeight,strokeWidth:v}),o}static fromObject(e){return this._fromObject(n(n({},e),{},{styles:Qs(e.styles||{},e.text)}),{extraParam:"text"})}}t(y,"textLayoutProperties",qi),t(y,"cacheProperties",[...se,...Yi]),t(y,"ownDefaults",pa),t(y,"type","Text"),t(y,"genericFonts",["serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]),t(y,"ATTRIBUTE_NAMES",he.concat("x","y","dx","dy","font-family","font-style","font-weight","font-size","letter-spacing","text-decoration","text-anchor")),Ms(y,[class extends Bi{_toSVG(){const e=this._getSVGLeftTopOffsets(),t=this._getSVGTextAndBg(e.textTop,e.textLeft);return this._wrapSVGTextAndBg(t)}toSVG(e){const n=this._createBaseSVGMarkup(this._toSVG(),{reviver:e,noStyle:!0,withShadow:!0}),t=this.path;return t?n+t._createBaseSVGMarkup(t._toSVG(),{reviver:e,withShadow:!0,additionalTransform:$e(this.calcOwnMatrix())}):n}_getSVGLeftTopOffsets(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}}_wrapSVGTextAndBg(e){let{textBgRects:n,textSpans:s}=e;const t=this.getSvgTextDecoration(this);return[n.join(""),'		<text xml:space="preserve" ','font-family="'.concat(this.fontFamily.replace(Ca,"'"),'" '),'font-size="'.concat(this.fontSize,'" '),this.fontStyle?'font-style="'.concat(this.fontStyle,'" '):"",this.fontWeight?'font-weight="'.concat(this.fontWeight,'" '):"",t?'text-decoration="'.concat(t,'" '):"","rtl"===this.direction?'direction="'.concat(this.direction,'" '):"",'style="',this.getSvgStyles(!0),'"',this.addPaintOrder()," >",s.join(""),`</text>
`]}_getSVGTextAndBg(e,t){const i=[],s=[];let n,o=e;this.backgroundColor&&s.push(...gs(this.backgroundColor,-this.width/2,-this.height/2,this.width,this.height));for(let e=0,a=this._textLines.length;e<a;e++)n=this._getLineLeftOffset(e),"rtl"===this.direction&&(n+=this.width),(this.textBackgroundColor||this.styleHas("textBackgroundColor",e))&&this._setSVGTextLineBg(s,e,t+n,o),this._setSVGTextLineText(i,e,t+n,o),o+=this.getHeightOfLine(e);return{textSpans:i,textBgRects:s}}_createTextCharSpan(e,t,n,o,i){const r=a.NUM_FRACTION_DIGITS,d=this.getSvgSpanStyles(t,e!==e.trim()||!!e.match(xa)),f=d?'style="'.concat(d,'"'):"",u=t.deltaY,p=u?' dy="'.concat(l(u,r),'" '):"",{angle:c,renderLeft:h,renderTop:g,width:v}=i;let m="";if(0[0]!==h){const i=v/2;c&&(m=' rotate="'.concat(l(Z(c),r),'"'));const e=Me({angle:Z(c)});e[4]=h,e[5]=g;const t=new s(-i,0).transform(e);n=t.x,o=t.y}return'<tspan x="'.concat(l(n,r),'" y="').concat(l(o,r),'" ').concat(p).concat(m).concat(f,">").concat($s(e),"</tspan>")}_setSVGTextLineText(e,t,n,s){const h=this.getHeightOfLine(t),m=this.textAlign.includes(ee),c=this._textLines[t];let r,l,o,u,i,d="",a=0;s+=h*(1-this._fontSizeFraction)/this.lineHeight;for(let h=0,f=c.length-1;h<=f;h++)i=h===f||this.charSpacing||this.path,d+=c[h],o=this.__charBounds[t][h],0===a?(n+=o.kernedWidth-o.width,a+=o.width):a+=o.kernedWidth,m&&!i&&this._reSpaceAndTab.test(c[h])&&(i=!0),i||(r=r||this.getCompleteStyleDeclaration(t,h),l=this.getCompleteStyleDeclaration(t,h+1),i=$t(r,l,!0)),i&&(u=this._getStyleDeclaration(t,h),e.push(this._createTextCharSpan(d,u,n,s,o)),d="",r=l,"rtl"===this.direction?n-=a:n+=a,a=0)}_setSVGTextLineBg(e,t,n,s){const l=this._textLines[t],c=this.getHeightOfLine(t)/this.lineHeight;let i,a=0,r=0,o=this.getValueOfPropertyAt(t,0,"textBackgroundColor");for(let d=0;d<l.length;d++){const{left:u,width:h,kernedWidth:m}=this.__charBounds[t][d];i=this.getValueOfPropertyAt(t,d,"textBackgroundColor"),i!==o?(o&&e.push(...gs(o,n+r,s,a,c)),r=u,a=h,o=i):a+=m}i&&e.push(...gs(o,n+r,s,a,c))}_getSVGLineTopOffset(e){let t,n=0;for(t=0;t<e;t++)n+=this.getHeightOfLine(t);const s=this.getHeightOfLine(t);return{lineTop:n,offset:(this._fontSizeMult-this._fontSizeFraction)*s/(this.lineHeight*this._fontSizeMult)}}getSvgStyles(e){return"".concat(super.getSvgStyles(e)," text-decoration-thickness: ").concat(l(this.textDecorationThickness*this.getObjectScaling().y/10,a.NUM_FRACTION_DIGITS),"%; white-space: pre;")}getSvgSpanStyles(e,t){const{fontFamily:n,strokeWidth:d,stroke:o,fill:i,fontSize:r,fontStyle:c,fontWeight:s,deltaY:u,textDecorationThickness:g,linethrough:h,overline:m,underline:f}=e,p=this.getSvgTextDecoration({underline:f??this.underline,overline:m??this.overline,linethrough:h??this.linethrough}),b=g||this.textDecorationThickness;return[o?Ft(C,o):"",d?"stroke-width: ".concat(d,"; "):"",n?"font-family: ".concat(n.includes("'")||n.includes('"')?n:"'".concat(n,"'"),"; "):"",r?"font-size: ".concat(r,"px; "):"",c?"font-style: ".concat(c,"; "):"",s?"font-weight: ".concat(s,"; "):"",p?"text-decoration: ".concat(p,"; text-decoration-thickness: ").concat(l(b*this.getObjectScaling().y/10,a.NUM_FRACTION_DIGITS),"%; "):"",i?Ft(v,i):"",u?"baseline-shift: ".concat(-u,"; "):"",t?"white-space: pre; ":""].join("")}getSvgTextDecoration(e){return["overline","underline","line-through"].filter(t=>e[t.replace("-","")]).join(" ")}}]),o.setClass(y),o.setSVGClass(y);class Ma{constructor(e){t(this,"target",0[0]),t(this,"__mouseDownInPlace",!1),t(this,"__dragStartFired",!1),t(this,"__isDraggingOver",!1),t(this,"__dragStartSelection",0[0]),t(this,"__dragImageDisposer",0[0]),t(this,"_dispose",0[0]),this.target=e;const n=[this.target.on("dragenter",this.dragEnterHandler.bind(this)),this.target.on("dragover",this.dragOverHandler.bind(this)),this.target.on("dragleave",this.dragLeaveHandler.bind(this)),this.target.on("dragend",this.dragEndHandler.bind(this)),this.target.on("drop",this.dropHandler.bind(this))];this._dispose=()=>{n.forEach(e=>e()),this._dispose=0[0]}}isPointerOverSelection(e){const t=this.target,n=t.getSelectionStartFromPointer(e);return t.isEditing&&n>=t.selectionStart&&n<=t.selectionEnd&&t.selectionStart<t.selectionEnd}start(e){return this.__mouseDownInPlace=this.isPointerOverSelection(e)}isActive(){return this.__mouseDownInPlace}end(e){const t=this.isActive();return t&&!this.__dragStartFired&&(this.target.setCursorByClick(e),this.target.initDelayedCursor(!0)),this.__mouseDownInPlace=!1,this.__dragStartFired=!1,this.__isDraggingOver=!1,t}getDragStartSelection(){return this.__dragStartSelection}setDragImage(e,t){var r;let{selectionStart:l,selectionEnd:y}=t;const n=this.target,a=n.canvas,j=new s(n.flipX?-1:1,n.flipY?-1:1),i=n._getCursorBoundaries(l),u=new s(i.left+i.leftOffset,i.top+i.topOffset).multiply(j).transform(n.calcTransformMatrix()),f=a.getScenePoint(e).subtract(u),h=n.getCanvasRetinaScaling(),m=n.getBoundingRect(),g=u.subtract(new s(m.left,m.top)),p=a.viewportTransform,c=g.add(f).transform(p,!0),v=n.backgroundColor,b=ys(n.styles);n.backgroundColor="";const d={stroke:"transparent",fill:"transparent",textBackgroundColor:"transparent"};n.setSelectionStyles(d,0,l),n.setSelectionStyles(d,y,n.text.length),n.dirty=!0;const o=n.toCanvasElement({enableRetinaScaling:a.enableRetinaScaling,viewportTransform:!0});n.backgroundColor=v,n.styles=b,n.dirty=!0,hn(o,{position:"fixed",left:"".concat(-o.width,"px"),border:x,width:"".concat(o.width/h,"px"),height:"".concat(o.height/h,"px")}),this.__dragImageDisposer&&this.__dragImageDisposer(),this.__dragImageDisposer=()=>{o.remove()},H(e.target||this.target.hiddenTextarea).body.appendChild(o),null===(r=e.dataTransfer)||0[0]===r||r.setDragImage(o,c.x,c.y)}onDragStart(e){this.__dragStartFired=!0;const t=this.target,s=this.isActive();if(s&&e.dataTransfer){const s=this.__dragStartSelection={selectionStart:t.selectionStart,selectionEnd:t.selectionEnd},o=t._text.slice(s.selectionStart,s.selectionEnd).join(""),i=n({text:t.text,value:o},s);e.dataTransfer.setData("text/plain",o),e.dataTransfer.setData("application/fabric",JSON.stringify({value:o,styles:t.getSelectionStyles(s.selectionStart,s.selectionEnd,!0)})),e.dataTransfer.effectAllowed="copyMove",this.setDragImage(e,i)}return t.abortCursorAnimation(),s}canDrop(e){if(this.target.editable&&!this.target.getActiveControl()&&!e.defaultPrevented){if(this.isActive()&&this.__dragStartSelection){const t=this.target.getSelectionStartFromPointer(e),n=this.__dragStartSelection;return t<n.selectionStart||t>n.selectionEnd}return!0}return!1}targetCanDrop(e){return this.target.canDrop(e)}dragEnterHandler(e){let{e:t}=e;const n=this.targetCanDrop(t);!this.__isDraggingOver&&n&&(this.__isDraggingOver=!0)}dragOverHandler(e){const{e:t}=e,n=this.targetCanDrop(t);!this.__isDraggingOver&&n?this.__isDraggingOver=!0:this.__isDraggingOver&&!n&&(this.__isDraggingOver=!1),this.__isDraggingOver&&(t.preventDefault(),e.canDrop=!0,e.dropTarget=this.target)}dragLeaveHandler(){(this.__isDraggingOver||this.isActive())&&(this.__isDraggingOver=!1)}dropHandler(e){var s;const{e:t}=e,o=t.defaultPrevented;this.__isDraggingOver=!1,t.preventDefault();let n=null===(s=t.dataTransfer)||0[0]===s?0[0]:s.getData("text/plain");if(n&&!o){const s=this.target,i=s.canvas;let o=s.getSelectionStartFromPointer(t);const{styles:r}=t.dataTransfer.types.includes("application/fabric")?JSON.parse(t.dataTransfer.getData("application/fabric")):{},c=n[Math.max(0,n.length-1)],a=0;if(this.__dragStartSelection){const e=this.__dragStartSelection.selectionStart,t=this.__dragStartSelection.selectionEnd;o>e&&o<=t?o=e:o>t&&(o-=t-e),s.removeChars(e,t),delete this.__dragStartSelection}s._reNewline.test(c)&&(s._reNewline.test(s._text[o])||o===s._text.length)&&(n=n.trimEnd()),e.didDrop=!0,e.dropTarget=s,s.insertChars(n,r,o),i.setActiveObject(s),s.enterEditing(t),s.selectionStart=Math.min(o+a,s._text.length),s.selectionEnd=Math.min(s.selectionStart+n.length,s._text.length),s.hiddenTextarea.value=s.text,s._updateTextarea(),s.hiddenTextarea.focus(),s.fire(Xt,{index:o+a,action:"drop"}),i.fire("text:changed",{target:s}),i.contextTopDirty=!0,i.requestRenderAll()}}dragEndHandler(e){let{e:n}=e;if(this.isActive()&&this.__dragStartFired&&this.__dragStartSelection){var t;const e=this.target,o=this.target.canvas,{selectionStart:s,selectionEnd:i}=this.__dragStartSelection,a=(null===(t=n.dataTransfer)||0[0]===t?0[0]:t.dropEffect)||x;a===x?(e.selectionStart=s,e.selectionEnd=i,e._updateTextarea(),e.hiddenTextarea.focus()):(e.clearContextTop(),"move"===a&&(e.removeChars(s,i),e.selectionStart=e.selectionEnd=s,e.hiddenTextarea&&(e.hiddenTextarea.value=e.text),e._updateTextarea(),e.fire(Xt,{index:s,action:"dragend"}),o.fire("text:changed",{target:e}),o.requestRenderAll()),e.exitEditing())}this.__dragImageDisposer&&this.__dragImageDisposer(),delete this.__dragImageDisposer,delete this.__dragStartSelection,this.__isDraggingOver=!1}dispose(){this._dispose&&this._dispose()}}const Pi=/[ \n.,;!?-]/;class Ta extends y{constructor(){super(...arguments),t(this,"_currentCursorOpacity",1)}initBehavior(){this._tick=this._tick.bind(this),this._onTickComplete=this._onTickComplete.bind(this),this.updateSelectionOnMouseMove=this.updateSelectionOnMouseMove.bind(this)}onDeselect(e){return this.isEditing&&this.exitEditing(),this.selected=!1,super.onDeselect(e)}_animateCursor(e){let{toValue:t,duration:n,delay:s,onComplete:o}=e;return Yn({startValue:this._currentCursorOpacity,endValue:t,duration:n,delay:s,onComplete:o,abort:()=>!this.canvas||this.selectionStart!==this.selectionEnd,onChange:e=>{this._currentCursorOpacity=e,this.renderCursorOrSelection()}})}_tick(e){this._currentTickState=this._animateCursor({toValue:0,duration:this.cursorDuration/2,delay:Math.max(e||0,100),onComplete:this._onTickComplete})}_onTickComplete(){var e;null===(e=this._currentTickCompleteState)||0[0]===e||e.abort(),this._currentTickCompleteState=this._animateCursor({toValue:1,duration:this.cursorDuration,onComplete:this._tick})}initDelayedCursor(e){this.abortCursorAnimation(),this._tick(e?0:this.cursorDelay)}abortCursorAnimation(){let e=!1;[this._currentTickState,this._currentTickCompleteState].forEach(t=>{t&&!t.isDone()&&(e=!0,t.abort())}),this._currentCursorOpacity=1,e&&this.clearContextTop()}restartCursorIfNeeded(){[this._currentTickState,this._currentTickCompleteState].some(e=>!e||e.isDone())&&this.initDelayedCursor()}selectAll(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this}cmdAll(){this.selectAll(),this.renderCursorOrSelection()}getSelectedText(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")}findWordBoundaryLeft(e){let n=0,t=e-1;if(this._reSpace.test(this._text[t]))for(;this._reSpace.test(this._text[t]);)n++,t--;for(;/\S/.test(this._text[t])&&t>-1;)n++,t--;return e-n}findWordBoundaryRight(e){let n=0,t=e;if(this._reSpace.test(this._text[t]))for(;this._reSpace.test(this._text[t]);)n++,t++;for(;/\S/.test(this._text[t])&&t<this._text.length;)n++,t++;return e+n}findLineBoundaryLeft(e){let n=0,t=e-1;for(;!/\n/.test(this._text[t])&&t>-1;)n++,t--;return e-n}findLineBoundaryRight(e){let n=0,t=e;for(;!/\n/.test(this._text[t])&&t<this._text.length;)n++,t++;return e+n}searchWordBoundary(e,t){const s=this._text;let n=e>0&&this._reSpace.test(s[e])&&(-1===t||!bs.test(s[e-1]))?e-1:e,o=s[n];for(;n>0&&n<s.length&&!Pi.test(o);)n+=t,o=s[n];return-1===t&&Pi.test(o)&&n++,n}selectWord(e){var t;e=null!==(t=e)&&0[0]!==t?t:this.selectionStart;const n=this.searchWordBoundary(e,-1),s=Math.max(n,this.searchWordBoundary(e,1));this.selectionStart=n,this.selectionEnd=s,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()}selectLine(e){var t;e=null!==(t=e)&&0[0]!==t?t:this.selectionStart;const n=this.findLineBoundaryLeft(e),s=this.findLineBoundaryRight(e);this.selectionStart=n,this.selectionEnd=s,this._fireSelectionChanged(),this._updateTextarea()}enterEditing(e){!this.isEditing&&this.editable&&(this.enterEditingImpl(),this.fire("editing:entered",e?{e}:0[0]),this._fireSelectionChanged(),this.canvas&&(this.canvas.fire("text:editing:entered",{target:this,e}),this.canvas.requestRenderAll()))}enterEditingImpl(){this.canvas&&(this.canvas.calcOffset(),this.canvas.textEditingManager.exitTextEditing()),this.isEditing=!0,this.initHiddenTextarea(),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick()}updateSelectionOnMouseMove(e){if(this.getActiveControl())return;const n=this.hiddenTextarea;H(n).activeElement!==n&&n.focus();const t=this.getSelectionStartFromPointer(e),s=this.selectionStart,o=this.selectionEnd;(t===this.__selectionStartOnMouseDown&&s!==o||s!==t&&o!==t)&&(t>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=t):(this.selectionStart=t,this.selectionEnd=this.__selectionStartOnMouseDown),this.selectionStart===s&&this.selectionEnd===o||(this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()))}_setEditingProps(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0}fromStringToGraphemeSelection(e,t,n){const o=n.slice(0,e),s=this.graphemeSplit(o).length;if(e===t)return{selectionStart:s,selectionEnd:s};const i=n.slice(e,t);return{selectionStart:s,selectionEnd:s+this.graphemeSplit(i).length}}fromGraphemeToStringSelection(e,t,n){const s=n.slice(0,e).join("").length;return e===t?{selectionStart:s,selectionEnd:s}:{selectionStart:s,selectionEnd:s+n.slice(e,t).join("").length}}_updateTextarea(){if(this.cursorOffsetCache={},this.hiddenTextarea){if(!this.inCompositionMode){const e=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=e.selectionStart,this.hiddenTextarea.selectionEnd=e.selectionEnd}this.updateTextareaPosition()}}updateFromTextArea(){if(!this.hiddenTextarea)return;this.cursorOffsetCache={};const e=this.hiddenTextarea;this.text=e.value,this.set("dirty",!0),this.initDimensions(),this.setCoords();const t=this.fromStringToGraphemeSelection(e.selectionStart,e.selectionEnd,e.value);this.selectionEnd=this.selectionStart=t.selectionEnd,this.inCompositionMode||(this.selectionStart=t.selectionStart),this.updateTextareaPosition()}updateTextareaPosition(){if(this.selectionStart===this.selectionEnd){const e=this._calcTextareaPosition();this.hiddenTextarea.style.left=e.left,this.hiddenTextarea.style.top=e.top}}_calcTextareaPosition(){if(!this.canvas)return{left:"1px",top:"1px"};const r=this.inCompositionMode?this.compositionStart:this.selectionStart,n=this._getCursorBoundaries(r),a=this.get2DCursorLocation(r),h=a.lineIndex,f=a.charIndex,t=this.getValueOfPropertyAt(h,f,"fontSize")*this.lineHeight,m=n.leftOffset,l=this.getCanvasRetinaScaling(),o=this.canvas.upperCanvasEl,d=o.width/l,u=o.height/l,i=d-t,c=u-t,e=new s(n.left+m,n.top+n.topOffset+t).transform(this.calcTransformMatrix()).transform(this.canvas.viewportTransform).multiply(new s(o.clientWidth/d,o.clientHeight/u));return e.x<0&&(e.x=0),e.x>i&&(e.x=i),e.y<0&&(e.y=0),e.y>c&&(e.y=c),e.x+=this.canvas._offset.left,e.y+=this.canvas._offset.top,{left:"".concat(e.x,"px"),top:"".concat(e.y,"px"),fontSize:"".concat(t,"px"),charHeight:t}}_saveEditingProps(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}}_restoreEditingProps(){this._savedProps&&(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor||this.canvas.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor||this.canvas.moveCursor),delete this._savedProps)}_exitEditing(){const e=this.hiddenTextarea;this.selected=!1,this.isEditing=!1,e&&(e.blur&&e.blur(),e.parentNode&&e.parentNode.removeChild(e)),this.hiddenTextarea=null,this.abortCursorAnimation(),this.selectionStart!==this.selectionEnd&&this.clearContextTop()}exitEditingImpl(){this._exitEditing(),this.selectionEnd=this.selectionStart,this._restoreEditingProps(),this._forceClearCache&&(this.initDimensions(),this.setCoords())}exitEditing(){const e=this._textBeforeEdit!==this.text;return this.exitEditingImpl(),this.fire("editing:exited"),e&&this.fire(Zt),this.canvas&&(this.canvas.fire("text:editing:exited",{target:this}),e&&this.canvas.fire("object:modified",{target:this})),this}_removeExtraneousStyles(){for(const e in this.styles)this._textLines[e]||delete this.styles[e]}removeStyleFromTo(e,t){const{lineIndex:n,charIndex:i}=this.get2DCursorLocation(e,!0),{lineIndex:s,charIndex:o}=this.get2DCursorLocation(t,!0);if(n!==s){if(this.styles[n])for(let e=i;e<this._unwrappedTextLines[n].length;e++)delete this.styles[n][e];if(this.styles[s])for(let e=o;e<this._unwrappedTextLines[s].length;e++){const t=this.styles[s][e];t&&(this.styles[n]||(this.styles[n]={}),this.styles[n][i+e-o]=t)}for(let e=n+1;e<=s;e++)delete this.styles[e];this.shiftLineStyles(s,n-s)}else if(this.styles[n]){const e=this.styles[n],t=o-i;for(let t=i;t<o;t++)delete e[t];for(const s in this.styles[n]){const i=parseInt(s,10);i>=o&&(e[i-t]=e[s],delete e[s])}}}shiftLineStyles(e,t){const n=Object.assign({},this.styles);for(const o in this.styles){const s=parseInt(o,10);s>e&&(this.styles[s+t]=n[s],n[s-t]||delete this.styles[s])}}insertNewlineStyleObject(e,t,s,o){const i={},a=this._unwrappedTextLines[e].length,r=a===t;let c=!1;s||(s=1),this.shiftLineStyles(e,s);const l=this.styles[e]?this.styles[e][0===t?t:t-1]:0[0];for(const n in this.styles[e]){const s=parseInt(n,10);s>=t&&(c=!0,i[s-t]=this.styles[e][n],r&&0===t||delete this.styles[e][n])}let d=!1;for(c&&!r&&(this.styles[e+s]=i,d=!0),(d||a>t)&&s--;s>0;)o&&o[s-1]?this.styles[e+s]={0:n({},o[s-1])}:l?this.styles[e+s]={0:n({},l)}:delete this.styles[e+s],s--;this._forceClearCache=!0}insertCharStyleObject(e,t,s,o){this.styles||(this.styles={});const i=this.styles[e],a=i?n({},i):{};s||(s=1);for(const n in a){const e=parseInt(n,10);e>=t&&(i[e+s]=a[e],a[e-s]||delete i[e])}if(this._forceClearCache=!0,o){for(;s--;)Object.keys(o[s]).length&&(this.styles[e]||(this.styles[e]={}),this.styles[e][t+s]=n({},o[s]));return}if(!i)return;const r=i[t?t-1:1];for(;r&&s--;)this.styles[e][t+s]=n({},r)}insertNewStyleBlock(e,t,n){const i=this.get2DCursorLocation(t,!0),o=[0];let s,a=0;for(let t=0;t<e.length;t++)`
`===e[t]?(a++,o[a]=0):o[a]++;for(o[0]>0&&(this.insertCharStyleObject(i.lineIndex,i.charIndex,o[0],n),n=n&&n.slice(o[0]+1)),a&&this.insertNewlineStyleObject(i.lineIndex,i.charIndex+o[0],a),s=1;s<a;s++)o[s]>0?this.insertCharStyleObject(i.lineIndex+s,0,o[s],n):n&&this.styles[i.lineIndex+s]&&n[0]&&(this.styles[i.lineIndex+s][0]=n[0]),n=n&&n.slice(o[s]+1);o[s]>0&&this.insertCharStyleObject(i.lineIndex+s,0,o[s],n)}removeChars(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:e+1;this.removeStyleFromTo(e,t),this._text.splice(e,t-e),this.text=this._text.join(""),this.set("dirty",!0),this.initDimensions(),this.setCoords(),this._removeExtraneousStyles()}insertChars(e,t,n){let s=arguments.length>3&&0[0]!==arguments[3]?arguments[3]:n;s>n&&this.removeStyleFromTo(n,s);const o=this.graphemeSplit(e);this.insertNewStyleBlock(o,n,t),this._text=[...this._text.slice(0,n),...o,...this._text.slice(s)],this.text=this._text.join(""),this.set("dirty",!0),this.initDimensions(),this.setCoords(),this._removeExtraneousStyles()}setSelectionStartEndWithShift(e,t,n){n<=e?(t===e?this._selectionDirection=c:this._selectionDirection===f&&(this._selectionDirection=c,this.selectionEnd=e),this.selectionStart=n):n>e&&n<t?this._selectionDirection===f?this.selectionEnd=n:this.selectionStart=n:(t===e?this._selectionDirection=f:this._selectionDirection===c&&(this._selectionDirection=f,this.selectionStart=t),this.selectionEnd=n)}}class za extends Ta{initHiddenTextarea(){const t=this.canvas&&H(this.canvas.getElement())||we(),e=t.createElement("textarea");Object.entries({autocapitalize:"off",autocorrect:"off",autocomplete:"off",spellcheck:"false","data-fabric":"textarea",wrap:"off"}).map(t=>{let[n,s]=t;return e.setAttribute(n,s)});const{top:n,left:s,fontSize:o}=this._calcTextareaPosition();e.style.cssText="position: absolute; top: ".concat(n,"; left: ").concat(s,"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; padding-top: ").concat(o,";"),(this.hiddenTextareaContainer||t.body).appendChild(e),Object.entries({blur:"blur",keydown:"onKeyDown",keyup:"onKeyUp",input:"onInput",copy:"copy",cut:"copy",paste:"paste",compositionstart:"onCompositionStart",compositionupdate:"onCompositionUpdate",compositionend:"onCompositionEnd"}).map(t=>{let[n,s]=t;return e.addEventListener(n,this[s].bind(this))}),this.hiddenTextarea=e}blur(){this.abortCursorAnimation()}onKeyDown(e){if(!this.isEditing)return;const t="rtl"===this.direction?this.keysMapRtl:this.keysMap;if(e.keyCode in t)this[t[e.keyCode]](e);else{if(!(e.keyCode in this.ctrlKeysMapDown)||!e.ctrlKey&&!e.metaKey)return;this[this.ctrlKeysMapDown[e.keyCode]](e)}e.stopImmediatePropagation(),e.preventDefault(),e.keyCode>=33&&e.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}onKeyUp(e){!this.isEditing||this._copyDone||this.inCompositionMode?this._copyDone=!1:e.keyCode in this.ctrlKeysMapUp&&(e.ctrlKey||e.metaKey)&&(this[this.ctrlKeysMapUp[e.keyCode]](e),e.stopImmediatePropagation(),e.preventDefault(),this.canvas&&this.canvas.requestRenderAll())}onInput(e){const b=this.fromPaste,{value:m,selectionStart:y,selectionEnd:j}=this.hiddenTextarea;if(this.fromPaste=!1,e&&e.stopPropagation(),!this.isEditing)return;const h=()=>{this.updateFromTextArea(),this.fire(Xt),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())};if(""===this.hiddenTextarea.value)return this.styles={},void h();const p=this._splitTextIntoLines(m).graphemeText,g=this._text.length,u=p.length,t=this.selectionStart,n=this.selectionEnd,f=t!==n;let o,s,c,l,r=u-g;const d=this.fromStringToGraphemeSelection(y,j,m),v=t>d.selectionStart;f?(s=this._text.slice(t,n),r+=n-t):u<g&&(s=v?this._text.slice(n+r,n):this._text.slice(t,t-r));const i=p.slice(d.selectionEnd-r,d.selectionEnd);if(s&&s.length&&(i.length&&(o=this.getSelectionStyles(t,t+1,!1),o=i.map(()=>o[0])),f?(c=t,l=n):v?(c=n-s.length,l=n):(c=n,l=n+s.length),this.removeStyleFromTo(c,l)),i.length){const{copyPasteData:e}=W();b&&i.join("")===e.copiedText&&!a.disableStyleCopyPaste&&(o=e.copiedTextStyle),this.insertNewStyleBlock(i,t,o)}h()}onCompositionStart(){this.inCompositionMode=!0}onCompositionEnd(){this.inCompositionMode=!1}onCompositionUpdate(e){let{target:t}=e;const{selectionStart:n,selectionEnd:s}=t;this.compositionStart=n,this.compositionEnd=s,this.updateTextareaPosition()}copy(){if(this.selectionStart===this.selectionEnd)return;const{copyPasteData:e}=W();e.copiedText=this.getSelectedText(),a.disableStyleCopyPaste?e.copiedTextStyle=0[0]:e.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0}paste(){this.fromPaste=!0}_getWidthBeforeCursor(e,t){let n,s=this._getLineLeftOffset(e);return t>0&&(n=this.__charBounds[e][t-1],s+=n.left+n.width),s}getDownCursorOffset(e,t){const s=this._getSelectionForOffset(e,t),o=this.get2DCursorLocation(s),n=o.lineIndex;if(n===this._textLines.length-1||e.metaKey||34===e.keyCode)return this._text.length-s;const i=o.charIndex,a=this._getWidthBeforeCursor(n,i),r=this._getIndexOnLine(n+1,a);return this._textLines[n].slice(i).length+r+1+this.missingNewlineOffset(n)}_getSelectionForOffset(e,t){return e.shiftKey&&this.selectionStart!==this.selectionEnd&&t?this.selectionEnd:this.selectionStart}getUpCursorOffset(e,t){const s=this._getSelectionForOffset(e,t),o=this.get2DCursorLocation(s),n=o.lineIndex;if(0===n||e.metaKey||33===e.keyCode)return-s;const i=o.charIndex,a=this._getWidthBeforeCursor(n,i),r=this._getIndexOnLine(n-1,a),c=this._textLines[n].slice(0,i),l=this.missingNewlineOffset(n-1);return-this._textLines[n-1].length+r-c.length+(1-l)}_getIndexOnLine(e,t){const i=this._textLines[e];let s,a,n=this._getLineLeftOffset(e),o=0;for(let r=0,c=i.length;r<c;r++)if(s=this.__charBounds[e][r].width,n+=s,n>t){a=!0;const e=n-s,i=n,c=Math.abs(e-t);o=Math.abs(i-t)<c?r:r-1;break}return a||(o=i.length-1),o}moveCursorDown(e){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",e)}moveCursorUp(e){0===this.selectionStart&&0===this.selectionEnd||this._moveCursorUpOrDown("Up",e)}_moveCursorUpOrDown(e,t){const n=this["get".concat(e,"CursorOffset")](t,this._selectionDirection===f);if(t.shiftKey?this.moveCursorWithShift(n):this.moveCursorWithoutShift(n),0!==n){const e=this.text.length;this.selectionStart=Fe(0,this.selectionStart,e),this.selectionEnd=Fe(0,this.selectionEnd,e),this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea()}}moveCursorWithShift(e){const t=this._selectionDirection===c?this.selectionStart+e:this.selectionEnd+e;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,t),0!==e}moveCursorWithoutShift(e){return e<0?(this.selectionStart+=e,this.selectionEnd=this.selectionStart):(this.selectionEnd+=e,this.selectionStart=this.selectionEnd),0!==e}moveCursorLeft(e){0===this.selectionStart&&0===this.selectionEnd||this._moveCursorLeftOrRight("Left",e)}_move(e,t,n){let s;if(e.altKey)s=this["findWordBoundary".concat(n)](this[t]);else{if(!e.metaKey&&35!==e.keyCode&&36!==e.keyCode)return this[t]+="Left"===n?-1:1,!0;s=this["findLineBoundary".concat(n)](this[t])}return 0[0]!==s&&this[t]!==s&&(this[t]=s,!0)}_moveLeft(e,t){return this._move(e,t,"Left")}_moveRight(e,t){return this._move(e,t,"Right")}moveCursorLeftWithoutShift(e){let t=!0;return this._selectionDirection=c,this.selectionEnd===this.selectionStart&&0!==this.selectionStart&&(t=this._moveLeft(e,"selectionStart")),this.selectionEnd=this.selectionStart,t}moveCursorLeftWithShift(e){return this._selectionDirection===f&&this.selectionStart!==this.selectionEnd?this._moveLeft(e,"selectionEnd"):0!==this.selectionStart?(this._selectionDirection=c,this._moveLeft(e,"selectionStart")):0[0]}moveCursorRight(e){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",e)}_moveCursorLeftOrRight(e,t){const n="moveCursor".concat(e).concat(t.shiftKey?"WithShift":"WithoutShift");this._currentCursorOpacity=1,this[n](t)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())}moveCursorRightWithShift(e){return this._selectionDirection===c&&this.selectionStart!==this.selectionEnd?this._moveRight(e,"selectionStart"):this.selectionEnd!==this._text.length?(this._selectionDirection=f,this._moveRight(e,"selectionEnd")):0[0]}moveCursorRightWithoutShift(e){let t=!0;return this._selectionDirection=f,this.selectionStart===this.selectionEnd?(t=this._moveRight(e,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,t}}const zi=e=>!!e.button;class Na extends za{constructor(){super(...arguments),t(this,"draggableTextDelegate",0[0])}initBehavior(){this.on("mousedown",this._mouseDownHandler),this.on("mouseup",this.mouseUpHandler),this.on("mousedblclick",this.doubleClickHandler),this.on("mousetripleclick",this.tripleClickHandler),this.draggableTextDelegate=new Ma(this),super.initBehavior()}shouldStartDragging(){return this.draggableTextDelegate.isActive()}onDragStart(e){return this.draggableTextDelegate.onDragStart(e)}canDrop(e){return this.draggableTextDelegate.canDrop(e)}doubleClickHandler(e){this.isEditing&&(this.selectWord(this.getSelectionStartFromPointer(e.e)),this.renderCursorOrSelection())}tripleClickHandler(e){this.isEditing&&(this.selectLine(this.getSelectionStartFromPointer(e.e)),this.renderCursorOrSelection())}_mouseDownHandler(e){let{e:t,alreadySelected:n}=e;this.canvas&&this.editable&&!zi(t)&&!this.getActiveControl()&&(this.draggableTextDelegate.start(t)||(this.canvas.textEditingManager.register(this),n&&(this.inCompositionMode=!1,this.setCursorByClick(t)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()),this.selected||(this.selected=n||this.isEditing)))}mouseUpHandler(e){let{e:t,transform:n}=e;const s=this.draggableTextDelegate.end(t);if(this.canvas){this.canvas.textEditingManager.unregister(this);const e=this.canvas._activeObject;if(e&&e!==this)return}!this.editable||this.group&&!this.group.interactive||n&&n.actionPerformed||zi(t)||s||this.selected&&!this.getActiveControl()&&(this.enterEditing(t),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection())}setCursorByClick(e){const t=this.getSelectionStartFromPointer(e),n=this.selectionStart,s=this.selectionEnd;e.shiftKey?this.setSelectionStartEndWithShift(n,s,t):(this.selectionStart=t,this.selectionEnd=t),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())}getSelectionStartFromPointer(e){const n=this.canvas.getScenePoint(e).transform(k(this.calcTransformMatrix())).add(new s(-this._getLeftOffset(),-this._getTopOffset()));let a=0,t=0,o=0;for(let e=0;e<this._textLines.length&&a<=n.y;e++)a+=this.getHeightOfLine(e),o=e,e>0&&(t+=this._textLines[e-1].length+this.missingNewlineOffset(e-1));let i=Math.abs(this._getLineLeftOffset(o));const r=this._textLines[o].length,c=this.__charBounds[o];for(let e=0;e<r;e++){const s=i+c[e].kernedWidth;if(n.x<=s){Math.abs(n.x-s)<=Math.abs(n.x-i)&&t++;break}i=s,t++}return Math.min(this.flipX?r-t:t,this._text.length)}}const pn="moveCursorUp",Lt="moveCursorDown",Pt="moveCursorLeft",Bt="moveCursorRight",Wt="exitEditing",bi=(e,t)=>{const s=t.getRetinaScaling();e.setTransform(s,0,0,s,0,0);const n=t.viewportTransform;e.transform(n[0],n[1],n[2],n[3],n[4],n[5])},Va=n({selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,hiddenTextareaContainer:null,keysMap:{9:Wt,27:Wt,33:pn,34:Lt,35:Bt,36:Pt,37:Pt,38:pn,39:Bt,40:Lt},keysMapRtl:{9:Wt,27:Wt,33:pn,34:Lt,35:Pt,36:Bt,37:Bt,38:pn,39:Pt,40:Lt},ctrlKeysMapDown:{65:"cmdAll"},ctrlKeysMapUp:{67:"copy",88:"cut"}},{_selectionDirection:null,_reSpace:/\s|\r?\n/,inCompositionMode:!1});class ce extends Na{static getDefaults(){return n(n({},super.getDefaults()),ce.ownDefaults)}get type(){const e=super.type;return"itext"===e?"i-text":e}constructor(e,t){super(e,n(n({},ce.ownDefaults),t)),this.initBehavior()}_set(e,t){return this.isEditing&&this._savedProps&&e in this._savedProps?(this._savedProps[e]=t,this):("canvas"===e&&(this.canvas instanceof Fn&&this.canvas.textEditingManager.remove(this),t instanceof Fn&&t.textEditingManager.add(this)),super._set(e,t))}setSelectionStart(e){e=Math.max(e,0),this._updateAndFire("selectionStart",e)}setSelectionEnd(e){e=Math.min(e,this.text.length),this._updateAndFire("selectionEnd",e)}_updateAndFire(e,t){this[e]!==t&&(this._fireSelectionChanged(),this[e]=t),this._updateTextarea()}_fireSelectionChanged(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})}initDimensions(){this.isEditing&&this.initDelayedCursor(),super.initDimensions()}getSelectionStyles(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:this.selectionStart||0,t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:this.selectionEnd,n=arguments.length>2?arguments[2]:0[0];return super.getSelectionStyles(e,t,n)}setSelectionStyles(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:this.selectionStart||0,n=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:this.selectionEnd;return super.setSelectionStyles(e,t,n)}get2DCursorLocation(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:this.selectionStart,t=arguments.length>1?arguments[1]:0[0];return super.get2DCursorLocation(e,t)}render(e){super.render(e),this.cursorOffsetCache={},this.renderCursorOrSelection()}toCanvasElement(e){const t=this.isEditing;this.isEditing=!1;const n=super.toCanvasElement(e);return this.isEditing=t,n}renderCursorOrSelection(){if(!this.isEditing||!this.canvas)return;const e=this.clearContextTop(!0);if(!e)return;const o=this._getCursorBoundaries(),i=this.findAncestorsWithClipPath(),n=i.length>0;let s,t=e;if(n){s=M(e.canvas),t=s.getContext("2d"),bi(t,this.canvas);const n=this.calcTransformMatrix();t.transform(n[0],n[1],n[2],n[3],n[4],n[5])}if(this.selectionStart!==this.selectionEnd||this.inCompositionMode?this.renderSelection(t,o):this.renderCursor(t,o),n)for(const o of i){const n=o.clipPath,a=M(e.canvas),s=a.getContext("2d");if(bi(s,this.canvas),!n.absolutePositioned){const e=o.calcTransformMatrix();s.transform(e[0],e[1],e[2],e[3],e[4],e[5])}n.transform(s),n.drawObject(s,!0,{}),this.drawClipPathOnCache(t,n,a)}n&&(e.setTransform(1,0,0,1,0,0),e.drawImage(s,0,0)),this.canvas.contextTopDirty=!0,e.restore()}findAncestorsWithClipPath(){const t=[];let e=this;for(;e;)e.clipPath&&t.push(e),e=e.parent;return t}_getCursorBoundaries(){let t=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:this.selectionStart,n=arguments.length>1?arguments[1]:0[0];const s=this._getLeftOffset(),o=this._getTopOffset(),e=this._getCursorBoundariesOffsets(t,n);return{left:s,top:o,leftOffset:e.left,topOffset:e.top}}_getCursorBoundariesOffsets(e,t){return t?this.__getCursorBoundariesOffsets(e):this.cursorOffsetCache&&"top"in this.cursorOffsetCache?this.cursorOffsetCache:this.cursorOffsetCache=this.__getCursorBoundariesOffsets(e)}__getCursorBoundariesOffsets(e){let a=0,t=0;const{charIndex:r,lineIndex:n}=this.get2DCursorLocation(e);for(let e=0;e<n;e++)a+=this.getHeightOfLine(e);const o=this._getLineLeftOffset(n),l=this.__charBounds[n][r];l&&(t=l.left),0!==this.charSpacing&&r===this._textLines[n].length&&(t-=this._getWidthOfCharSpacing());const s={top:a,left:o+(t>0?t:0)};return"rtl"===this.direction&&(this.textAlign===f||this.textAlign===ee||this.textAlign===jt?s.left*=-1:this.textAlign===c||this.textAlign===Gt?s.left=o-(t>0?t:0):this.textAlign!==i&&this.textAlign!==bt||(s.left=o-(t>0?t:0))),s}renderCursorAt(e){this._renderCursor(this.canvas.contextTop,this._getCursorBoundaries(e,!0),e)}renderCursor(e,t){this._renderCursor(e,t,this.selectionStart)}getCursorRenderingData(){let o=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:this.selectionStart,e=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:this._getCursorBoundaries(o);const n=this.get2DCursorLocation(o),t=n.lineIndex,s=n.charIndex>0?n.charIndex-1:0,i=this.getValueOfPropertyAt(t,s,"fontSize"),r=this.getObjectScaling().x*this.canvas.getZoom(),a=this.cursorWidth/r,c=this.getValueOfPropertyAt(t,s,"deltaY"),l=e.topOffset+(1-this._fontSizeFraction)*this.getHeightOfLine(t)/this.lineHeight-i*(1-this._fontSizeFraction);return{color:this.cursorColor||this.getValueOfPropertyAt(t,s,"fill"),opacity:this._currentCursorOpacity,left:e.left+e.leftOffset-a/2,top:l+e.top+c,width:a,height:i}}_renderCursor(e,t,n){const{color:s,opacity:o,left:i,top:a,width:r,height:c}=this.getCursorRenderingData(n,t);e.fillStyle=s,e.globalAlpha=o,e.fillRect(i,a,r,c)}renderSelection(e,t){const n={selectionStart:this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,selectionEnd:this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd};this._renderSelection(e,n,t)}renderDragSourceEffect(){const e=this.draggableTextDelegate.getDragStartSelection();this._renderSelection(this.canvas.contextTop,e,this._getCursorBoundaries(e.selectionStart,!0))}renderDropTargetEffect(e){const t=this.getSelectionStartFromPointer(e);this.renderCursorAt(t)}_renderSelection(e,t,n){const d=t.selectionStart,u=t.selectionEnd,h=this.textAlign.includes(ee),r=this.get2DCursorLocation(d),l=this.get2DCursorLocation(u),o=r.lineIndex,s=l.lineIndex,m=r.charIndex<0?0:r.charIndex,a=l.charIndex<0?0:l.charIndex;for(let t=o;t<=s;t++){const u=this._getLineLeftOffset(t)||0;let d=this.getHeightOfLine(t),g=0,p=0,r=0;if(t===o&&(p=this.__charBounds[o][m].left),t>=o&&t<s)r=h&&!this.isEndOfWrapping(t)?this.width:this.getLineWidth(t)||5;else if(t===s)if(0===a)r=this.__charBounds[s][a].left;else{const e=this._getWidthOfCharSpacing();r=this.__charBounds[s][a-1].left+this.__charBounds[s][a-1].width-e}g=d,(this.lineHeight<1||t===s&&this.lineHeight>1)&&(d/=this.lineHeight);let l=n.left+u+p,v=d,b=0;const j=r-p;this.inCompositionMode?(e.fillStyle=this.compositionColor||"black",v=1,b=d):e.fillStyle=this.selectionColor,"rtl"===this.direction&&(this.textAlign===f||this.textAlign===ee||this.textAlign===jt?l=this.width-l-j:this.textAlign===c||this.textAlign===Gt?l=n.left+u-r:this.textAlign!==i&&this.textAlign!==bt||(l=n.left+u-r)),e.fillRect(l,n.top+n.topOffset+b,j,v),n.topOffset+=g}}getCurrentCharFontSize(){const e=this._getCurrentCharIndex();return this.getValueOfPropertyAt(e.l,e.c,"fontSize")}getCurrentCharColor(){const e=this._getCurrentCharIndex();return this.getValueOfPropertyAt(e.l,e.c,v)}_getCurrentCharIndex(){const e=this.get2DCursorLocation(this.selectionStart,!0),t=e.charIndex>0?e.charIndex-1:0;return{l:e.lineIndex,c:t}}dispose(){this.exitEditingImpl(),this.draggableTextDelegate.dispose(),super.dispose()}}t(ce,"ownDefaults",Va),t(ce,"type","IText"),o.setClass(ce),o.setClass(ce,"i-text");class ye extends ce{static getDefaults(){return n(n({},super.getDefaults()),ye.ownDefaults)}constructor(e,t){super(e,n(n({},ye.ownDefaults),t))}static createControls(){return{controls:Ts()}}initDimensions(){this.initialized&&(this.isEditing&&this.initDelayedCursor(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),this.textAlign.includes(ee)&&this.enlargeSpaces(),this.height=this.calcTextHeight())}_generateStyleMap(e){let s=0,n=0,t=0;const o={};for(let i=0;i<e.graphemeLines.length;i++)`
`===e.graphemeText[t]&&i>0?(n=0,t++,s++):!this.splitByGrapheme&&this._reSpaceAndTab.test(e.graphemeText[t])&&i>0&&(n++,t++),o[i]={line:s,offset:n},t+=e.graphemeLines[i].length,n+=e.graphemeLines[i].length;return o}styleHas(e,t){if(this._styleMap&&!this.isWrapping){const e=this._styleMap[t];e&&(t=e.line)}return super.styleHas(e,t)}isEmptyStyles(e){if(!this.styles)return!0;let o,i=0,a=e+1,r=!1;const t=this._styleMap[e],n=this._styleMap[e+1];t&&(e=t.line,i=t.offset),n&&(a=n.line,r=a===e,o=n.offset);const s=0[0]===e?this.styles:{line:this.styles[e]};for(const e in s)for(const t in s[e]){const n=parseInt(t,10);if(n>=i&&(!r||n<o))for(const n in s[e][t])return!1}return!0}_getStyleDeclaration(e,t){if(this._styleMap&&!this.isWrapping){const n=this._styleMap[e];if(!n)return{};e=n.line,t=n.offset+t}return super._getStyleDeclaration(e,t)}_setStyleDeclaration(e,t,n){const s=this._styleMap[e];super._setStyleDeclaration(s.line,s.offset+t,n)}_deleteStyleDeclaration(e,t){const n=this._styleMap[e];super._deleteStyleDeclaration(n.line,n.offset+t)}_getLineStyle(e){const t=this._styleMap[e];return!!this.styles[t.line]}_setLineStyle(e){const t=this._styleMap[e];super._setLineStyle(t.line)}_wrapText(e,t){this.isWrapping=!0;const n=this.getGraphemeDataForRender(e),s=[];for(let e=0;e<n.wordsData.length;e++)s.push(...this._wrapLine(e,t,n));return this.isWrapping=!1,s}getGraphemeDataForRender(e){const t=this.splitByGrapheme,s=t?"":" ";let n=0;return{wordsData:e.map((e,o)=>{let i=0;const a=t?this.graphemeSplit(e):this.wordSplit(e);return 0===a.length?[{word:[],width:0}]:a.map(e=>{const a=t?[e]:this.graphemeSplit(e),r=this._measureWord(a,o,i);return n=Math.max(r,n),i+=a.length+s.length,{word:a,width:r}})}),largestWordWidth:n}}_measureWord(e,t){let n,o=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:0,s=0;for(let i=0,a=e.length;i<a;i++)s+=this._getGraphemeBox(e[i],t,i+o,n,!0).kernedWidth,n=e[i];return s}wordSplit(e){return e.split(this._wordJoiners)}_wrapLine(e,t,n){let{largestWordWidth:u,wordsData:v}=n,h=arguments.length>3&&0[0]!==arguments[3]?arguments[3]:0;const c=this._getWidthOfCharSpacing(),d=this.splitByGrapheme,l=[],m=d?"":" ";let i=0,s=[],r=0,f=0,a=!0;t-=h;const g=Math.max(t,u,this.dynamicMinWidth),p=v[e];let o;for(r=0,o=0;o<p.length;o++){const{word:t,width:n}=p[o];r+=t.length,i+=f+n-c,i>g&&!a?(l.push(s),s=[],i=n,a=!0):i+=c,a||d||s.push(m),s=s.concat(t),f=d?0:this._measureWord([m],e,r),r++,a=!1}return o&&l.push(s),u+h>this.dynamicMinWidth&&(this.dynamicMinWidth=u-c+h),l}isEndOfWrapping(e){return!this._styleMap[e+1]||this._styleMap[e+1].line!==this._styleMap[e].line}missingNewlineOffset(e,t){return this.splitByGrapheme&&!t?this.isEndOfWrapping(e)?1:0:1}_splitTextIntoLines(e){const t=super._splitTextIntoLines(e),n=this._wrapText(t.lines,this.width),s=new Array(n.length);for(let e=0;e<n.length;e++)s[e]=n[e].join("");return t.lines=s,t.graphemeLines=n,t}getMinWidth(){return Math.max(this.minWidth,this.dynamicMinWidth)}_removeExtraneousStyles(){const e=new Map;for(const t in this._styleMap){const n=parseInt(t,10);if(this._textLines[n]){const n=this._styleMap[t].line;e.set("".concat(n),!0)}}for(const t in this.styles)e.has(t)||delete this.styles[t]}toObject(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];return super.toObject(["minWidth","splitByGrapheme",...e])}}t(ye,"type","Textbox"),t(ye,"textLayoutProperties",[...ce.textLayoutProperties,"width"]),t(ye,"ownDefaults",{minWidth:20,dynamicMinWidth:2,lockScalingFlip:!0,noScaleCache:!1,_wordJoiners:/[ \t\r]/,splitByGrapheme:!1}),o.setClass(ye);class ms extends rt{shouldPerformLayout(e){return!!e.target.clipPath&&super.shouldPerformLayout(e)}shouldLayoutClipPath(){return!1}calcLayoutResult(e,t){const{target:o}=e,{clipPath:n,group:a}=o;if(!n||!this.shouldPerformLayout(e))return;const{width:r,height:c}=te(Ho(o,n)),i=new s(r,c);if(n.absolutePositioned)return{center:re(n.getRelativeCenterPoint(),0[0],a?a.calcTransformMatrix():0[0]),size:i};{const a=n.getRelativeCenterPoint().transform(o.calcOwnMatrix(),!0);if(this.shouldPerformLayout(e)){const{center:n=new s,correction:o=new s}=this.calcBoundingBox(t,e)||{};return{center:n.add(a),correction:o.subtract(a),size:i}}return{center:o.getRelativeCenterPoint().add(a),size:i}}}}t(ms,"type","clip-path"),o.setClass(ms);class us extends rt{getInitialSize(e,t){let{target:n}=e,{size:o}=t;return new s(n.width||o.x,n.height||o.y)}}t(us,"type","fixed"),o.setClass(us);class qa extends Ye{subscribeTargets(e){const t=e.target;e.targets.reduce((e,t)=>(t.parent&&e.add(t.parent),e),new Set).forEach(e=>{e.layoutManager.subscribeTargets({target:e,targets:[t]})})}unsubscribeTargets(e){const t=e.target,n=t.getObjects();e.targets.reduce((e,t)=>(t.parent&&e.add(t.parent),e),new Set).forEach(e=>{!n.some(t=>t.parent===e)&&e.layoutManager.unsubscribeTargets({target:e,targets:[t]})})}}class xe extends P{static getDefaults(){return n(n({},super.getDefaults()),xe.ownDefaults)}constructor(){let n=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[],e=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};super(),Object.assign(this,xe.ownDefaults),this.setOptions(e);const{left:s,top:o,layoutManager:t}=e;this.groupInit(n,{left:s,top:o,layoutManager:t??new qa})}_shouldSetNestedCoords(){return!0}__objectSelectionMonitor(){}multiSelectAdd(){for(var n=arguments.length,t=new Array(n),e=0;e<n;e++)t[e]=arguments[e];"selection-order"===this.multiSelectionStacking?this.add(...t):t.forEach(e=>{const t=this._objects.findIndex(t=>t.isInFrontOf(e)),n=-1===t?this.size():t;this.insertAt(n,e)})}canEnterGroup(e){return this.getObjects().some(t=>t.isDescendantOf(e)||e.isDescendantOf(t))?(ie("error","ActiveSelection: circular object trees are not supported, this call has no effect"),!1):super.canEnterGroup(e)}enterGroup(e,t){e.parent&&e.parent===e.group?e.parent._exitGroup(e):e.group&&e.parent!==e.group&&e.group.remove(e),this._enterGroup(e,t)}exitGroup(e,t){this._exitGroup(e,t),e.parent&&e.parent._enterGroup(e,!0)}_onAfterObjectsChange(e,t){super._onAfterObjectsChange(e,t);const n=new Set;t.forEach(e=>{const{parent:t}=e;t&&n.add(t)}),e===_n?n.forEach(e=>{e._onAfterObjectsChange(en,t)}):n.forEach(e=>{e._set("dirty",!0)})}onDeselect(){return this.removeAll(),!1}toString(){return"#<ActiveSelection: (".concat(this.complexity(),")>")}shouldCache(){return!1}isOnACache(){return!1}_renderControls(e,t,s){e.save(),e.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1;const o=n(n({hasControls:!1},s),{},{forActiveSelection:!0});for(let t=0;t<this._objects.length;t++)this._objects[t]._renderControls(e,o);super._renderControls(e,t),e.restore()}}t(xe,"type","ActiveSelection"),t(xe,"ownDefaults",{multiSelectionStacking:"canvas-stacking"}),o.setClass(xe),o.setClass(xe,"activeSelection");class ui{constructor(){t(this,"resources",{})}applyFilters(e,t,n,s,o){const i=o.getContext("2d");if(!i)return;i.drawImage(t,0,0,n,s);const r={sourceWidth:n,sourceHeight:s,imageData:i.getImageData(0,0,n,s),originalEl:t,originalImageData:i.getImageData(0,0,n,s),canvasEl:o,ctx:i,filterBackend:this};e.forEach(e=>{e.applyTo(r)});const{imageData:a}=r;return a.width===n&&a.height===s||(o.width=a.width,o.height=a.height),i.putImageData(a,0,0),r}}class ut{constructor(){let{tileSize:e=a.textureSize}=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};t(this,"aPosition",new Float32Array([0,0,0,1,1,0,1,1])),t(this,"resources",{}),this.tileSize=e,this.setupGLContext(e,e),this.captureGPUInfo()}setupGLContext(e,t){this.dispose(),this.createWebGLCanvas(e,t)}createWebGLCanvas(e,t){const s=M({width:e,height:t}),n=s.getContext("webgl",{alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1});n&&(n.clearColor(0,0,0,0),this.canvas=s,this.gl=n)}applyFilters(e,t,n,s,o,i){const a=this.gl,l=o.getContext("2d");if(!a||!l)return;let c;i&&(c=this.getCachedTexture(i,t));const r={originalWidth:t.width||t.naturalWidth||0,originalHeight:t.height||t.naturalHeight||0,sourceWidth:n,sourceHeight:s,destinationWidth:n,destinationHeight:s,context:a,sourceTexture:this.createTexture(a,n,s,c?0[0]:t),targetTexture:this.createTexture(a,n,s),originalTexture:c||this.createTexture(a,n,s,c?0[0]:t),passes:e.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:o},d=a.createFramebuffer();return a.bindFramebuffer(a.FRAMEBUFFER,d),e.forEach(e=>{e&&e.applyTo(r)}),function(e){const t=e.targetCanvas,o=t.width,i=t.height,n=e.destinationWidth,s=e.destinationHeight;o===n&&i===s||(t.width=n,t.height=s)}(r),this.copyGLTo2D(a,r),a.bindTexture(a.TEXTURE_2D,null),a.deleteTexture(r.sourceTexture),a.deleteTexture(r.targetTexture),a.deleteFramebuffer(d),l.setTransform(1,0,0,1,0,0),r}dispose(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()}clearWebGLCaches(){this.programCache={},this.textureCache={}}createTexture(e,t,n,s,o){const{NEAREST:r,TEXTURE_2D:i,RGBA:a,UNSIGNED_BYTE:c,CLAMP_TO_EDGE:l,TEXTURE_MAG_FILTER:u,TEXTURE_MIN_FILTER:h,TEXTURE_WRAP_S:m,TEXTURE_WRAP_T:f}=e,d=e.createTexture();return e.bindTexture(i,d),e.texParameteri(i,u,o||r),e.texParameteri(i,h,o||r),e.texParameteri(i,m,l),e.texParameteri(i,f,l),s?e.texImage2D(i,0,a,a,c,s):e.texImage2D(i,0,a,t,n,0,a,c,null),d}getCachedTexture(e,t,n){const{textureCache:s}=this;if(s[e])return s[e];{const o=this.createTexture(this.gl,t.width,t.height,t,n);return o&&(s[e]=o),o}}evictCachesForKey(e){this.textureCache[e]&&(this.gl.deleteTexture(this.textureCache[e]),delete this.textureCache[e])}copyGLTo2D(e,t){const o=e.canvas,n=t.targetCanvas,s=n.getContext("2d");if(!s)return;s.translate(0,n.height),s.scale(1,-1);const i=o.height-n.height;s.drawImage(o,0,i,n.width,n.height,0,0,n.width,n.height)}copyGLTo2DPutImageData(e,t){const o=t.targetCanvas.getContext("2d"),n=t.destinationWidth,s=t.destinationHeight,i=n*s*4;if(!o)return;const a=new Uint8Array(this.imageBuffer,0,i),r=new Uint8ClampedArray(this.imageBuffer,0,i);e.readPixels(0,0,n,s,e.RGBA,e.UNSIGNED_BYTE,a);const c=new ImageData(r,n,s);o.putImageData(c,0,0)}captureGPUInfo(){if(this.gpuInfo)return this.gpuInfo;const t=this.gl,e={renderer:"",vendor:""};if(!t)return e;const n=t.getExtension("WEBGL_debug_renderer_info");if(n){const s=t.getParameter(n.UNMASKED_RENDERER_WEBGL),o=t.getParameter(n.UNMASKED_VENDOR_WEBGL);s&&(e.renderer=s.toLowerCase()),o&&(e.vendor=o.toLowerCase())}return this.gpuInfo=e,e}}let an;function si(){const{WebGLProbe:e}=W();return e.queryWebGL(N()),a.enableGLFiltering&&e.isSupported(a.textureSize)?new ut({tileSize:a.textureSize}):new ui}function dn(){return!an&&(!(arguments.length>0&&0[0]!==arguments[0])||arguments[0])&&(an=si()),an}const er=["filters","resizeFilter","src","crossOrigin","type"],ti=["cropX","cropY"];class S extends b{static getDefaults(){return n(n({},super.getDefaults()),S.ownDefaults)}constructor(e,n){super(),t(this,"_lastScaleX",1),t(this,"_lastScaleY",1),t(this,"_filterScalingX",1),t(this,"_filterScalingY",1),this.filters=[],Object.assign(this,S.ownDefaults),this.setOptions(n),this.cacheKey="texture".concat(fe()),this.setElement("string"==typeof e?(this.canvas&&H(this.canvas.getElement())||we()).getElementById(e):e,n)}getElement(){return this._element}setElement(e){var t;let n=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};this.removeTexture(this.cacheKey),this.removeTexture("".concat(this.cacheKey,"_filtered")),this._element=e,this._originalElement=e,this._setWidthHeight(n),null===(t=e.classList)||0[0]===t||t.add(S.CSS_CANVAS),0!==this.filters.length&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters()}removeTexture(e){const t=dn(!1);t instanceof ut&&t.evictCachesForKey(e)}dispose(){super.dispose(),this.removeTexture(this.cacheKey),this.removeTexture("".concat(this.cacheKey,"_filtered")),this._cacheContext=null,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach(e=>{const t=this[e];t&&W().dispose(t),this[e]=0[0]})}getCrossOrigin(){return this._originalElement&&(this._originalElement.crossOrigin||null)}getOriginalSize(){const e=this.getElement();return e?{width:e.naturalWidth||e.width,height:e.naturalHeight||e.height}:{width:0,height:0}}_stroke(e){if(!this.stroke||0===this.strokeWidth)return;const t=this.width/2,n=this.height/2;e.beginPath(),e.moveTo(-t,-n),e.lineTo(t,-n),e.lineTo(t,n),e.lineTo(-t,n),e.lineTo(-t,-n),e.closePath()}toObject(){let t=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];const e=[];return this.filters.forEach(t=>{t&&e.push(t.toObject())}),n(n({},super.toObject([...ti,...t])),{},{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:e},this.resizeFilter?{resizeFilter:this.resizeFilter.toObject()}:{})}hasCrop(){return!!this.cropX||!!this.cropY||this.width<this._element.width||this.height<this._element.height}_toSVG(){const n=[],e=this._element,s=-this.width/2,o=-this.height/2;let t=[],i=[],a="",r="";if(!e)return[];if(this.hasCrop()){const e=fe();t.push('<clipPath id="imageCrop_'+e+`">
`,'	<rect x="'+s+'" y="'+o+'" width="'+this.width+'" height="'+this.height+`" />
`,`</clipPath>
`),a=' clip-path="url(#imageCrop_'+e+')" '}if(this.imageSmoothing||(r=' image-rendering="optimizeSpeed"'),n.push("	<image ","COMMON_PARTS",'xlink:href="'.concat(this.getSvgSrc(!0),'" x="').concat(s-this.cropX,'" y="').concat(o-this.cropY,'" width="').concat(e.width||e.naturalWidth,'" height="').concat(e.height||e.naturalHeight,'"').concat(r).concat(a,`></image>
`)),this.stroke||this.strokeDashArray){const e=this.fill;this.fill=null,i=['	<rect x="'.concat(s,'" y="').concat(o,'" width="').concat(this.width,'" height="').concat(this.height,'" style="').concat(this.getSvgStyles(),`" />
`)],this.fill=e}return t=this.paintFirst!==v?t.concat(i,n):t.concat(n,i),t}getSrc(e){const t=e?this._element:this._originalElement;return t?t.toDataURL?t.toDataURL():this.srcFromAttribute?t.getAttribute("src")||"":t.src:this.src||""}getSvgSrc(e){return this.getSrc(e)}setSrc(e){let{crossOrigin:t,signal:n}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};return wt(e,{crossOrigin:t,signal:n}).then(e=>{0[0]!==t&&this.set({crossOrigin:t}),this.setElement(e)})}toString(){return'#<Image: { src: "'.concat(this.getSrc(),'" }>')}applyResizeFilters(){const e=this.resizeFilter,i=this.minimumScaleTrigger,a=this.getTotalObjectScaling(),n=a.x,s=a.y,t=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!e||n>i&&s>i)return this._element=t,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=n,void(this._lastScaleY=s);const o=M(t),{width:r,height:c}=t;this._element=o,this._lastScaleX=e.scaleX=n,this._lastScaleY=e.scaleY=s,dn().applyFilters([e],t,r,c,this._element),this._filterScalingX=o.width/this._originalElement.width,this._filterScalingY=o.height/this._originalElement.height}applyFilters(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:this.filters||[];if(e=e.filter(e=>e&&!e.isNeutralState()),this.set("dirty",!0),this.removeTexture("".concat(this.cacheKey,"_filtered")),0===e.length)return this._element=this._originalElement,this._filteredEl=0[0],this._filterScalingX=1,void(this._filterScalingY=1);const t=this._originalElement,n=t.naturalWidth||t.width,s=t.naturalHeight||t.height;if(this._element===this._originalElement){const e=M({width:n,height:s});this._element=e,this._filteredEl=e}else this._filteredEl&&(this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,n,s),this._lastScaleX=1,this._lastScaleY=1);dn().applyFilters(e,this._originalElement,n,s,this._element,this.cacheKey),this._originalElement.width===this._element.width&&this._originalElement.height===this._element.height||(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height)}_render(e){e.imageSmoothingEnabled=this.imageSmoothing,!0!==this.isMoving&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(e),this._renderPaintInOrder(e)}drawCacheOnCanvas(e){e.imageSmoothingEnabled=this.imageSmoothing,super.drawCacheOnCanvas(e)}shouldCache(){return this.needsItsOwnCache()}_renderFill(e){const t=this._element;if(!t)return;const n=this._filterScalingX,s=this._filterScalingY,o=this.width,i=this.height,a=Math.max(this.cropX,0),r=Math.max(this.cropY,0),c=t.naturalWidth||t.width,l=t.naturalHeight||t.height,d=a*n,u=r*s,h=Math.min(o*n,c-d),m=Math.min(i*s,l-u),f=-o/2,p=-i/2,g=Math.min(o,c/n-a),v=Math.min(i,l/s-r);t&&e.drawImage(t,d,u,h,m,f,p,g,v)}_needsResize(){const e=this.getTotalObjectScaling();return e.x!==this._lastScaleX||e.y!==this._lastScaleY}_resetWidthHeight(){this.set(this.getOriginalSize())}_setWidthHeight(){let{width:t,height:n}=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};const e=this.getOriginalSize();this.width=t||e.width,this.height=n||e.height}parsePreserveAspectRatioAttribute(){const e=Cs(this.preserveAspectRatio||""),o=this.width,i=this.height,h={width:o,height:i};let t,a=this._element.width,r=this._element.height,s=1,n=1,c=0,l=0,d=0,u=0;return!e||e.alignX===x&&e.alignY===x?(s=o/a,n=i/r):("meet"===e.meetOrSlice&&(s=n=Go(this._element,h),t=(o-a*s)/2,"Min"===e.alignX&&(c=-t),"Max"===e.alignX&&(c=t),t=(i-r*n)/2,"Min"===e.alignY&&(l=-t),"Max"===e.alignY&&(l=t)),"slice"===e.meetOrSlice&&(s=n=Xo(this._element,h),t=a-o/s,"Mid"===e.alignX&&(d=t/2),"Max"===e.alignX&&(d=t),t=r-i/n,"Mid"===e.alignY&&(u=t/2),"Max"===e.alignY&&(u=t),a=o/s,r=i/n)),{width:a,height:r,scaleX:s,scaleY:n,offsetLeft:c,offsetTop:l,cropX:d,cropY:u}}static fromObject(e,t){let{filters:s,resizeFilter:o,src:i,crossOrigin:r,type:c}=e,a=d(e,er);return Promise.all([wt(i,n(n({},t),{},{crossOrigin:r})),s&&Pe(s,t),o&&Pe([o],t),vt(a,t)]).then(e=>{let[t,s=[],[o]=[],r={}]=e;return new this(t,n(n({},a),{},{src:i,filters:s,resizeFilter:o},r))})}static fromURL(e){let{crossOrigin:t=null,signal:n}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{},s=arguments.length>2?arguments[2]:0[0];return wt(e,{crossOrigin:t,signal:n}).then(e=>new this(e,s))}static async fromElement(e){let n=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{},s=arguments.length>2?arguments[2]:0[0];const t=J(e,this.ATTRIBUTE_NAMES,s);return this.fromURL(t["xlink:href"]||t.href,n,t).catch(e=>(ie("log","Unable to parse Image",e),null))}}function Dn(e){if(!fa.test(e.nodeName))return{};const y=e.getAttribute("viewBox");let a,o,n=1,s=1,l=0,p=0;const u=e.getAttribute("width"),d=e.getAttribute("height"),r=e.getAttribute("x")||0,c=e.getAttribute("y")||0,j=!y||!Zi.test(y),_=!u||!d||"100%"===u||"100%"===d;let h="",m=0,f=0;if(j&&(r||c)&&e.parentNode&&"#document"!==e.parentNode.nodeName&&(h=" translate("+E(r||"0")+" "+E(c||"0")+") ",a=(e.getAttribute("transform")||"")+h,e.setAttribute("transform",a),e.removeAttribute("x"),e.removeAttribute("y")),j&&_)return{width:0,height:0};const t={width:0,height:0};if(j)return t.width=E(u),t.height=E(d),t;const g=y.match(Zi);l=-parseFloat(g[1]),p=-parseFloat(g[2]);const v=parseFloat(g[3]),b=parseFloat(g[4]);t.minX=l,t.minY=p,t.viewBoxWidth=v,t.viewBoxHeight=b,_?(t.width=v,t.height=b):(t.width=E(u),t.height=E(d),n=t.width/v,s=t.height/b);const i=Cs(e.getAttribute("preserveAspectRatio")||"");if(i.alignX!==x&&("meet"===i.meetOrSlice&&(s=n=n>s?s:n),"slice"===i.meetOrSlice&&(s=n=n>s?n:s),m=t.width-v*n,f=t.height-b*n,"Mid"===i.alignX&&(m/=2),"Mid"===i.alignY&&(f/=2),"Min"===i.alignX&&(m=0),"Min"===i.alignY&&(f=0)),1===n&&1===s&&0===l&&0===p&&0===r&&0===c)return t;if((r||c)&&"#document"!==e.parentNode.nodeName&&(h=" translate("+E(r||"0")+" "+E(c||"0")+") "),a=h+" matrix("+n+" 0 0 "+s+" "+(l*n+m)+" "+(p*s+f)+") ","svg"===e.nodeName){for(o=e.ownerDocument.createElementNS(Un,"g");e.firstChild;)o.appendChild(e.firstChild);e.appendChild(o)}else o=e,o.removeAttribute("x"),o.removeAttribute("y"),a=o.getAttribute("transform")+a;return o.setAttribute("transform",a),t}t(S,"type","Image"),t(S,"cacheProperties",[...se,...ti]),t(S,"ownDefaults",{strokeWidth:0,srcFromAttribute:!1,minimumScaleTrigger:.5,cropX:0,cropY:0,imageSmoothing:!0}),t(S,"CSS_CANVAS","canvas-img"),t(S,"ATTRIBUTE_NAMES",[...he,"x","y","width","height","preserveAspectRatio","xlink:href","href","crossOrigin","image-rendering"]),o.setClass(S),o.setSVGClass(S);const mn=e=>e.tagName.replace("svg:",""),ir=It(["pattern","defs","symbol","metadata","clipPath","mask","desc"]);function Zo(e,t){let o,i,n,a,s=[];for(n=0,a=t.length;n<a;n++)o=t[n],i=e.getElementsByTagNameNS("http://www.w3.org/2000/svg",o),s=s.concat(Array.from(i));return s}const rr=["gradientTransform","x1","x2","y1","y2","gradientUnits","cx","cy","r","fx","fy"],An="xlink:href";function Qo(e,t){const o=(null===(s=t.getAttribute(An))||0[0]===s?0[0]:s.slice(1))||"",n=e.getElementById(o);if(n&&n.getAttribute(An)&&Qo(e,n),n&&(rr.forEach(e=>{const s=n.getAttribute(e);!t.hasAttribute(e)&&s&&t.setAttribute(e,s)}),!t.children.length)){const e=n.cloneNode(!0);for(var s;e.firstChild;)t.appendChild(e.firstChild)}t.removeAttribute(An)}const dr=["linearGradient","radialGradient","svg:linearGradient","svg:radialGradient"];function Yo(e){const s=e.getElementsByTagName("style"),t={};for(let e=0;e<s.length;e++){const o=(s[e].textContent||"").replace(/\/\*[\s\S]*?\*\//g,"");""!==o.trim()&&o.split("}").filter((e,t,n)=>n.length>1&&e.trim()).forEach(e=>{if((e.match(/{/g)||[]).length>1&&e.trim().startsWith("@"))return;const s=e.split("{"),o={},i=s[1].trim().split(";").filter(function(e){return e.trim()});for(let e=0;e<i.length;e++){const t=i[e].split(":"),n=t[0].trim(),s=t[1].trim();o[n]=s}(e=s[0].trim()).split(",").forEach(e=>{""!==(e=e.replace(/^svg/i,"").trim())&&(t[e]=n(n({},t[e]||{}),o))})})}return t}const qo=e=>o.getSVGClass(mn(e).toLowerCase());class mr{constructor(e,t,n,s,o){this.elements=e,this.options=t,this.reviver=n,this.regexUrl=/^url\(['"]?#([^'"]+)['"]?\)/g,this.doc=s,this.clipPaths=o,this.gradientDefs=function(e){const t=Zo(e,dr),n={};let s=t.length;for(;s--;){const o=t[s];o.getAttribute("xlink:href")&&Qo(e,o);const i=o.getAttribute("id");i&&(n[i]=o)}return n}(s),this.cssRules=Yo(s)}parse(){return Promise.all(this.elements.map(e=>this.createObject(e)))}async createObject(e){const t=qo(e);if(t){const n=await t.fromElement(e,this.options,this.cssRules);return this.resolveGradient(n,e,v),this.resolveGradient(n,e,C),n instanceof S&&n._originalElement?fn(n,n.parsePreserveAspectRatioAttribute()):fn(n),await this.resolveClipPath(n,e),this.reviver&&this.reviver(e,n),n}return null}extractPropertyDefinition(e,t,n){const o=e[t],s=this.regexUrl;if(!s.test(o))return;s.lastIndex=0;const i=s.exec(o)[1];return s.lastIndex=0,n[i]}resolveGradient(e,t,s){const o=this.extractPropertyDefinition(e,s,this.gradientDefs);if(o){const i=t.getAttribute(s+"-opacity"),a=We.fromElement(o,e,n(n({},this.options),{},{opacity:i}));e.set(s,a)}}async resolveClipPath(e,t,n){const o=this.extractPropertyDefinition(e,"clipPath",this.clipPaths);if(o){const m=k(e.calcTransformMatrix()),c=o[0].parentElement;let a=t;for(;!n&&a.parentElement&&a.getAttribute("clip-path")!==e.clipPath;)a=a.parentElement;a.parentElement.appendChild(c);const h=lt("".concat(a.getAttribute("transform")||""," ").concat(c.getAttribute("originalTransform")||""));c.setAttribute("transform","matrix(".concat(h.join(","),")"));const l=await Promise.all(o.map(e=>qo(e).fromElement(e,this.options,this.cssRules).then(e=>(fn(e),e.fillRule=e.clipRule,delete e.clipRule,e)))),r=1===l.length?l[0]:new P(l),d=u(m,r.calcTransformMatrix());r.clipPath&&await this.resolveClipPath(r,a,c.getAttribute("clip-path")?a:0[0]);const{scaleX:f,scaleY:p,angle:g,skewX:v,translateX:b,translateY:j}=Ae(d);r.set({flipX:!1,flipY:!1}),r.set({scaleX:f,scaleY:p,angle:g,skewX:v,skewY:0}),r.setPositionByOrigin(new s(b,j),i,i),e.clipPath=r}else delete e.clipPath}}const Ko=e=>ma.test(mn(e)),On=()=>({objects:[],elements:[],options:{},allElements:[]});async function En(e,t){let{crossOrigin:l,signal:i}=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:{};if(i&&i.aborted)return ie("log",new ks("parseSVGDocument")),On();const r=e.documentElement;!function(e){const t=Zo(e,["use","svg:use"]),n=["x","y","xlink:href","href","transform"];for(const a of t){const r=a.attributes,i={};for(const e of r)e.value&&(i[e.name]=e.value);const c=(i["xlink:href"]||i.href||"").slice(1);if(""===c)return;const l=e.getElementById(c);if(null===l)return;let s=l.cloneNode(!0);const d=s.attributes,o={};for(const e of d)e.value&&(o[e.name]=e.value);const{x:u=0,y:h=0,transform:m=""}=i,f="".concat(m," ").concat(o.transform||""," translate(").concat(u,", ").concat(h,")");if(Dn(s),/^svg$/i.test(s.nodeName)){const e=s.ownerDocument.createElementNS(Un,"g");Object.entries(o).forEach(t=>{let[n,s]=t;return e.setAttributeNS(Un,n,s)}),e.append(...s.childNodes),s=e}for(const t of r){if(!t)continue;const{name:e,value:i}=t;if(!n.includes(e))if("style"===e){const t={};cs(i,t),Object.entries(o).forEach(e=>{let[n,s]=e;t[n]=s}),cs(o.style||"",t);const n=Object.entries(t).map(e=>e.join(":")).join(";");s.setAttribute(e,n)}else!o[e]&&s.setAttribute(e,i)}s.setAttribute("transform",f),s.setAttribute("instantiated_by_use","1"),s.removeAttribute("id"),a.parentNode.replaceChild(s,a)}}(e);const o=Array.from(r.getElementsByTagName("*")),a=n(n({},Dn(r)),{},{crossOrigin:l,signal:i}),s=o.filter(e=>(Dn(e),Ko(e)&&!function(e){let t=e;for(;t&&(t=t.parentElement);)if(t&&t.nodeName&&ir.test(mn(t))&&!t.getAttribute("instantiated_by_use"))return!0;return!1}(e)));if(!s||s&&!s.length)return n(n({},On()),{},{options:a,allElements:o});const c={};o.filter(e=>"clipPath"===mn(e)).forEach(e=>{e.setAttribute("originalTransform",e.getAttribute("transform")||"");const t=e.getAttribute("id");c[t]=Array.from(e.getElementsByTagName("*")).filter(e=>Ko(e))});const d=new mr(s,a,t,e,c);return{objects:await d.parse(),elements:s,options:a,allElements:o}}const Vo=to,Io=e=>function(t,n,o){const{points:i,pathOffset:a}=o;return new s(i[e]).subtract(a).transform(u(o.getViewportTransform(),o.calcTransformMatrix()))},Ro=(e,t,n,o)=>{const{target:a,pointIndex:r}=t,i=a,c=re(new s(n,o),0[0],i.calcOwnMatrix());return i.points[r]=c.add(i.pathOffset),i.setDimensions(),i.set("dirty",!0),!0},Lo=(e,t)=>function(o,i,a,r){const c=i.target,l=new s(c.points[(e>0?e:c.points.length)-1]),u=l.subtract(c.pathOffset).transform(c.calcOwnMatrix()),h=t(o,n(n({},i),{},{pointIndex:e}),a,r),d=l.subtract(c.pathOffset).transform(c.calcOwnMatrix()).subtract(u);return c.left-=d.x,c.top-=d.y,h},No=e=>pe(Vo,Lo(e,Ro)),kn=(e,t,n)=>{const{path:a,pathOffset:o}=e,i=a[t];return new s(i[n]-o.x,i[n+1]-o.y).transform(u(e.getViewportTransform(),e.calcTransformMatrix()))};function Or(e,t,n){const{commandIndex:s,pointIndex:o}=this;return kn(n,s,o)}function xr(e,t,o,i){const{target:c}=t,{commandIndex:a,pointIndex:r}=this,l=((e,t,n,o,i)=>{const{path:a,pathOffset:r}=e,c=a[(o>0?o:a.length)-1],l=new s(c[i],c[i+1]),h=l.subtract(r).transform(e.calcOwnMatrix()),d=re(new s(t,n),0[0],e.calcOwnMatrix());a[o][i]=d.x+r.x,a[o][i+1]=d.y+r.y,e.setDimensions();const u=l.subtract(e.pathOffset).transform(e.calcOwnMatrix()).subtract(h);return e.left-=u.x,e.top-=u.y,e.set("dirty",!0),!0})(c,o,i,a,r);return ls(this.actionName,n(n({},ps(e,t,o,i)),{},{commandIndex:a,pointIndex:r})),l}class Mo extends F{constructor(e){super(e)}render(e,t,s,o,i){const a=n(n({},o),{},{cornerColor:this.controlFill,cornerStrokeColor:this.controlStroke,transparentCorners:!this.controlFill});super.render(e,t,s,a,i)}}class Er extends Mo{constructor(e){super(e)}render(e,t,n,s,o){const{path:r}=o,{commandIndex:i,pointIndex:c,connectToCommandIndex:l,connectToPointIndex:d}=this;e.save(),e.strokeStyle=this.controlStroke,this.connectionDashArray&&e.setLineDash(this.connectionDashArray);const[u]=r[i],a=kn(o,l,d);if("Q"===u){const s=kn(o,i,c+2);e.moveTo(s.x,s.y),e.lineTo(t,n)}else e.moveTo(t,n);e.lineTo(a.x,a.y),e.stroke(),e.restore(),super.render(e,t,n,s,o)}}const jn=(e,t,s,o,i,a)=>new(s?Er:Mo)(n(n({commandIndex:e,pointIndex:t,actionName:"modifyPath",positionHandler:Or,actionHandler:xr,connectToCommandIndex:i,connectToPointIndex:a},o),s?o.controlPointStyle:o.pointStyle));xo=Object.freeze({__proto__:null,changeWidth:ss,createObjectDefaultControls:Zn,createPathControls:function(e){let n=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};const t={};let s="M";return e.path.forEach((e,o)=>{const i=e[0];switch("Z"!==i&&(t["c_".concat(o,"_").concat(i)]=jn(o,e.length-2,!1,n)),i){case"C":t["c_".concat(o,"_C_CP_1")]=jn(o,1,!0,n,o-1,(e=>"C"===e?5:"Q"===e?3:1)(s)),t["c_".concat(o,"_C_CP_2")]=jn(o,3,!0,n,o,5);break;case"Q":t["c_".concat(o,"_Q_CP_1")]=jn(o,1,!0,n,o,3)}s=i}),t},createPolyActionHandler:No,createPolyControls:function(e){let s=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};const t={};for(let o=0;o<("number"==typeof e?e:e.points.length);o++)t["p".concat(o)]=new F(n({actionName:Vo,positionHandler:Io(o),actionHandler:No(o)},s));return t},createPolyPositionHandler:Io,createResizeControls:Bo,createTextboxDefaultControls:Ts,dragHandler:yi,factoryPolyActionHandler:Lo,getLocalPoint:Ut,polyActionHandler:Ro,renderCircleControl:Do,renderSquareControl:Fo,rotationStyleHandler:Ao,rotationWithSnapping:Co,scaleCursorStyleHandler:Ne,scaleOrSkewActionName:_t,scaleSkewCursorStyleHandler:je,scalingEqually:ft,scalingX:Gs,scalingXOrSkewingY:As,scalingY:Us,scalingYOrSkewingX:Ss,skewCursorStyleHandler:Hs,skewHandlerX:Ds,skewHandlerY:zs,wrapWithFireEvent:pe,wrapWithFixedAnchor:ve});const st=e=>0[0]!==e.webgl,yn="precision highp float",Fr=`
    `.concat(yn,`;
    varying vec2 vTexCoord;
    uniform sampler2D uTexture;
    void main() {
      gl_FragColor = texture2D(uTexture, vTexCoord);
    }`),Tr=["type"],zr=["type"],Dr=new RegExp(yn,"g");class p{get type(){return this.constructor.type}constructor(){let e=d(arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{},Tr);Object.assign(this,this.constructor.defaults,e)}getFragmentSource(){return Fr}getVertexSource(){return`
    attribute vec2 aPosition;
    varying vec2 vTexCoord;
    void main() {
      vTexCoord = aPosition;
      gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
    }`}createProgram(e){let o=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:this.getFragmentSource(),r=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:this.getVertexSource();const{WebGLProbe:{GLPrecision:a="highp"}}=W();"highp"!==a&&(o=o.replace(Dr,yn.replace("highp",a)));const n=e.createShader(e.VERTEX_SHADER),s=e.createShader(e.FRAGMENT_SHADER),t=e.createProgram();if(!n||!s||!t)throw new G("Vertex, fragment shader or program creation error");if(e.shaderSource(n,r),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS))throw new G("Vertex shader compile error for ".concat(this.type,": ").concat(e.getShaderInfoLog(n)));if(e.shaderSource(s,o),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS))throw new G("Fragment shader compile error for ".concat(this.type,": ").concat(e.getShaderInfoLog(s)));if(e.attachShader(t,n),e.attachShader(t,s),e.linkProgram(t),!e.getProgramParameter(t,e.LINK_STATUS))throw new G('Shader link error for "'.concat(this.type,'" ').concat(e.getProgramInfoLog(t)));const i=this.getUniformLocations(e,t)||{};return i.uStepW=e.getUniformLocation(t,"uStepW"),i.uStepH=e.getUniformLocation(t,"uStepH"),{program:t,attributeLocations:this.getAttributeLocations(e,t),uniformLocations:i}}getAttributeLocations(e,t){return{aPosition:e.getAttribLocation(t,"aPosition")}}getUniformLocations(e,t){const n=this.constructor.uniformLocations,s={};for(let o=0;o<n.length;o++)s[n[o]]=e.getUniformLocation(t,n[o]);return s}sendAttributeData(e,t,n){const s=t.aPosition,o=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,o),e.enableVertexAttribArray(s),e.vertexAttribPointer(s,2,e.FLOAT,!1,0,0),e.bufferData(e.ARRAY_BUFFER,n,e.STATIC_DRAW)}_setupFrameBuffer(e){const t=e.context;if(e.passes>1){const n=e.destinationWidth,s=e.destinationHeight;e.sourceWidth===n&&e.sourceHeight===s||(t.deleteTexture(e.targetTexture),e.targetTexture=e.filterBackend.createTexture(t,n,s)),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e.targetTexture,0)}else t.bindFramebuffer(t.FRAMEBUFFER,null),t.finish()}_swapTextures(e){e.passes--,e.pass++;const t=e.targetTexture;e.targetTexture=e.sourceTexture,e.sourceTexture=t}isNeutralState(){return!1}applyTo(e){st(e)?(this._setupFrameBuffer(e),this.applyToWebGL(e),this._swapTextures(e)):this.applyTo2d(e)}applyTo2d(){}getCacheKey(){return this.type}retrieveShader(e){const t=this.getCacheKey();return e.programCache[t]||(e.programCache[t]=this.createProgram(e.context)),e.programCache[t]}applyToWebGL(e){const t=e.context,n=this.retrieveShader(e);0===e.pass&&e.originalTexture?t.bindTexture(t.TEXTURE_2D,e.originalTexture):t.bindTexture(t.TEXTURE_2D,e.sourceTexture),t.useProgram(n.program),this.sendAttributeData(t,n.attributeLocations,e.aPosition),t.uniform1f(n.uniformLocations.uStepW,1/e.sourceWidth),t.uniform1f(n.uniformLocations.uStepH,1/e.sourceHeight),this.sendUniformData(t,n.uniformLocations),t.viewport(0,0,e.destinationWidth,e.destinationHeight),t.drawArrays(t.TRIANGLE_STRIP,0,4)}bindAdditionalTexture(e,t,n){e.activeTexture(n),e.bindTexture(e.TEXTURE_2D,t),e.activeTexture(e.TEXTURE0)}unbindAdditionalTexture(e,t){e.activeTexture(t),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE0)}sendUniformData(){}createHelpLayer(e){if(!e.helpLayer){const{sourceWidth:t,sourceHeight:n}=e,s=M({width:t,height:n});e.helpLayer=s}}toObject(){const e=Object.keys(this.constructor.defaults||{});return n({type:this.type},e.reduce((e,t)=>(e[t]=this[t],e),{}))}toJSON(){return this.toObject()}static async fromObject(e){return new this(d(e,zr))}}t(p,"type","BaseFilter"),t(p,"uniformLocations",[]);const Lr={multiply:`gl_FragColor.rgb *= uColor.rgb;
`,screen:`gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);
`,add:`gl_FragColor.rgb += uColor.rgb;
`,difference:`gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);
`,subtract:`gl_FragColor.rgb -= uColor.rgb;
`,lighten:`gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);
`,darken:`gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);
`,exclusion:`gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);
`,overlay:`
    if (uColor.r < 0.5) {
      gl_FragColor.r *= 2.0 * uColor.r;
    } else {
      gl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);
    }
    if (uColor.g < 0.5) {
      gl_FragColor.g *= 2.0 * uColor.g;
    } else {
      gl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);
    }
    if (uColor.b < 0.5) {
      gl_FragColor.b *= 2.0 * uColor.b;
    } else {
      gl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);
    }
    `,tint:`
    gl_FragColor.rgb *= (1.0 - uColor.a);
    gl_FragColor.rgb += uColor.rgb;
    `};class et extends p{getCacheKey(){return"".concat(this.type,"_").concat(this.mode)}getFragmentSource(){return`
      precision highp float;
      uniform sampler2D uTexture;
      uniform vec4 uColor;
      varying vec2 vTexCoord;
      void main() {
        vec4 color = texture2D(uTexture, vTexCoord);
        gl_FragColor = color;
        if (color.a > 0.0) {
          `.concat(Lr[this.mode],`
        }
      }
      `)}applyTo2d(e){let{imageData:{data:o}}=e;const a=new r(this.color).getSource(),i=this.alpha,t=a[0]*i,n=a[1]*i,s=a[2]*i,c=1-i;for(let u=0;u<o.length;u+=4){const e=o[u],i=o[u+1],a=o[u+2];let r,l,d;switch(this.mode){case"multiply":r=e*t/255,l=i*n/255,d=a*s/255;break;case"screen":r=255-(255-e)*(255-t)/255,l=255-(255-i)*(255-n)/255,d=255-(255-a)*(255-s)/255;break;case"add":r=e+t,l=i+n,d=a+s;break;case"difference":r=Math.abs(e-t),l=Math.abs(i-n),d=Math.abs(a-s);break;case"subtract":r=e-t,l=i-n,d=a-s;break;case"darken":r=Math.min(e,t),l=Math.min(i,n),d=Math.min(a,s);break;case"lighten":r=Math.max(e,t),l=Math.max(i,n),d=Math.max(a,s);break;case"overlay":r=t<128?2*e*t/255:255-2*(255-e)*(255-t)/255,l=n<128?2*i*n/255:255-2*(255-i)*(255-n)/255,d=s<128?2*a*s/255:255-2*(255-a)*(255-s)/255;break;case"exclusion":r=t+e-2*t*e/255,l=n+i-2*n*i/255,d=s+a-2*s*a/255;break;case"tint":r=t+e*c,l=n+i*c,d=s+a*c}o[u]=r,o[u+1]=l,o[u+2]=d}}sendUniformData(e,t){const n=new r(this.color).getSource();n[0]=this.alpha*n[0]/255,n[1]=this.alpha*n[1]/255,n[2]=this.alpha*n[2]/255,n[3]=this.alpha,e.uniform4fv(t.uColor,n)}}t(et,"defaults",{color:"#F95C63",mode:"multiply",alpha:1}),t(et,"type","BlendColor"),t(et,"uniformLocations",["uColor"]),o.setClass(et);const Pr={multiply:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform sampler2D uImage;
    uniform vec4 uColor;
    varying vec2 vTexCoord;
    varying vec2 vTexCoord2;
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      vec4 color2 = texture2D(uImage, vTexCoord2);
      color.rgba *= color2.rgba;
      gl_FragColor = color;
    }
    `,mask:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform sampler2D uImage;
    uniform vec4 uColor;
    varying vec2 vTexCoord;
    varying vec2 vTexCoord2;
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      vec4 color2 = texture2D(uImage, vTexCoord2);
      color.a = color2.a;
      gl_FragColor = color;
    }
    `},Hr=["type","image"];class Ge extends p{getCacheKey(){return"".concat(this.type,"_").concat(this.mode)}getFragmentSource(){return Pr[this.mode]}getVertexSource(){return`
    attribute vec2 aPosition;
    varying vec2 vTexCoord;
    varying vec2 vTexCoord2;
    uniform mat3 uTransformMatrix;
    void main() {
      vTexCoord = aPosition;
      vTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;
      gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
    }
    `}applyToWebGL(e){const t=e.context,n=this.createTexture(e.filterBackend,this.image);this.bindAdditionalTexture(t,n,t.TEXTURE1),super.applyToWebGL(e),this.unbindAdditionalTexture(t,t.TEXTURE1)}createTexture(e,t){return e.getCachedTexture(t.cacheKey,t.getElement())}calculateMatrix(){const e=this.image,{width:t,height:n}=e.getElement();return[1/e.scaleX,0,0,0,1/e.scaleY,0,-e.left/t,-e.top/n,1]}applyTo2d(e){let{imageData:{data:t,width:n,height:s},filterBackend:{resources:c}}=e;const o=this.image;c.blendImage||(c.blendImage=N());const i=c.blendImage,a=i.getContext("2d");i.width!==n||i.height!==s?(i.width=n,i.height=s):a.clearRect(0,0,n,s),a.setTransform(o.scaleX,0,0,o.scaleY,o.left,o.top),a.drawImage(o.getElement(),0,0,n,s);const r=a.getImageData(0,0,n,s).data;for(let e=0;e<t.length;e+=4){const s=t[e],o=t[e+1],i=t[e+2],a=t[e+3],c=r[e],l=r[e+1],d=r[e+2],n=r[e+3];switch(this.mode){case"multiply":t[e]=s*c/255,t[e+1]=o*l/255,t[e+2]=i*d/255,t[e+3]=a*n/255;break;case"mask":t[e+3]=n}}}sendUniformData(e,t){const n=this.calculateMatrix();e.uniform1i(t.uImage,1),e.uniformMatrix3fv(t.uTransformMatrix,!1,n)}toObject(){return n(n({},super.toObject()),{},{image:this.image&&this.image.toObject()})}static async fromObject(e,t){let{type:i,image:s}=e,o=d(e,Hr);return S.fromObject(s,t).then(e=>new this(n(n({},o),{},{image:e})))}}t(Ge,"type","BlendImage"),t(Ge,"defaults",{mode:"multiply",alpha:1}),t(Ge,"uniformLocations",["uTransformMatrix","uImage"]),o.setClass(Ge);class yt extends p{getFragmentSource(){return`
    precision highp float;
    uniform sampler2D uTexture;
    uniform vec2 uDelta;
    varying vec2 vTexCoord;
    const float nSamples = 15.0;
    vec3 v3offset = vec3(12.9898, 78.233, 151.7182);
    float random(vec3 scale) {
      /* use the fragment position for a different seed per-pixel */
      return fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);
    }
    void main() {
      vec4 color = vec4(0.0);
      float totalC = 0.0;
      float totalA = 0.0;
      float offset = random(v3offset);
      for (float t = -nSamples; t <= nSamples; t++) {
        float percent = (t + offset - 0.5) / nSamples;
        vec4 sample = texture2D(uTexture, vTexCoord + uDelta * percent);
        float weight = 1.0 - abs(percent);
        float alpha = weight * sample.a;
        color.rgb += sample.rgb * alpha;
        color.a += alpha;
        totalA += weight;
        totalC += alpha;
      }
      gl_FragColor.rgb = color.rgb / totalC;
      gl_FragColor.a = color.a / totalA;
    }
  `}applyTo(e){st(e)?(this.aspectRatio=e.sourceWidth/e.sourceHeight,e.passes++,this._setupFrameBuffer(e),this.horizontal=!0,this.applyToWebGL(e),this._swapTextures(e),this._setupFrameBuffer(e),this.horizontal=!1,this.applyToWebGL(e),this._swapTextures(e)):this.applyTo2d(e)}applyTo2d(e){let{imageData:{data:t,width:i,height:r}}=e;this.aspectRatio=i/r,this.horizontal=!0;let a=this.getBlurValue()*i;const n=new Uint8ClampedArray(t),o=15,s=4*i;for(let e=0;e<t.length;e+=4){let c=0,l=0,d=0,i=0,u=0;const r=e-e%s,h=r+s;for(let m=-14;m<o;m++){const f=m/o,g=4*Math.floor(a*f),p=1-(f<0?-f:f);let n=e+g;n<r?n=r:n>h&&(n=h);const s=t[n+3]*p;c+=t[n]*s,l+=t[n+1]*s,d+=t[n+2]*s,i+=s,u+=p}n[e]=c/i,n[e+1]=l/i,n[e+2]=d/i,n[e+3]=i/u}this.horizontal=!1,a=this.getBlurValue()*r;for(let e=0;e<n.length;e+=4){let c=0,l=0,d=0,i=0,u=0;const r=e%s,h=n.length-s+r;for(let f=-14;f<o;f++){const p=f/o,v=Math.floor(a*p)*s,g=1-(p<0?-p:p);let t=e+v;t<r?t=r:t>h&&(t=h);const m=n[t+3]*g;c+=n[t]*m,l+=n[t+1]*m,d+=n[t+2]*m,i+=m,u+=g}t[e]=c/i,t[e+1]=l/i,t[e+2]=d/i,t[e+3]=i/u}}sendUniformData(e,t){const n=this.chooseRightDelta();e.uniform2fv(t.uDelta,n)}isNeutralState(){return 0===this.blur}getBlurValue(){let t=1;const{horizontal:n,aspectRatio:e}=this;return n?e>1&&(t=1/e):e<1&&(t=e),t*this.blur*.12}chooseRightDelta(){const e=this.getBlurValue();return this.horizontal?[e,0]:[0,e]}}t(yt,"type","Blur"),t(yt,"defaults",{blur:0}),t(yt,"uniformLocations",["uDelta"]),o.setClass(yt);class St extends p{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uBrightness;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    color.rgb += uBrightness;
    gl_FragColor = color;
  }
`}applyTo2d(e){let{imageData:{data:t}}=e;const n=Math.round(255*this.brightness);for(let e=0;e<t.length;e+=4)t[e]+=n,t[e+1]+=n,t[e+2]+=n}isNeutralState(){return 0===this.brightness}sendUniformData(e,t){e.uniform1f(t.uBrightness,this.brightness)}}t(St,"type","Brightness"),t(St,"defaults",{brightness:0}),t(St,"uniformLocations",["uBrightness"]),o.setClass(St);const po={matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],colorsOnly:!0};class Se extends p{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  varying vec2 vTexCoord;
  uniform mat4 uColorMatrix;
  uniform vec4 uConstants;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    color *= uColorMatrix;
    color += uConstants;
    gl_FragColor = color;
  }`}applyTo2d(e){const n=e.imageData.data,t=this.matrix,s=this.colorsOnly;for(let e=0;e<n.length;e+=4){const o=n[e],i=n[e+1],a=n[e+2];if(n[e]=o*t[0]+i*t[1]+a*t[2]+255*t[4],n[e+1]=o*t[5]+i*t[6]+a*t[7]+255*t[9],n[e+2]=o*t[10]+i*t[11]+a*t[12]+255*t[14],!s){const s=n[e+3];n[e]+=s*t[3],n[e+1]+=s*t[8],n[e+2]+=s*t[13],n[e+3]=o*t[15]+i*t[16]+a*t[17]+s*t[18]+255*t[19]}}}sendUniformData(e,t){const n=this.matrix,s=[n[0],n[1],n[2],n[3],n[5],n[6],n[7],n[8],n[10],n[11],n[12],n[13],n[15],n[16],n[17],n[18]],o=[n[4],n[9],n[14],n[19]];e.uniformMatrix4fv(t.uColorMatrix,!1,s),e.uniform4fv(t.uConstants,o)}toObject(){return n(n({},super.toObject()),{},{matrix:[...this.matrix]})}}function ze(e,n){var s;const i=(t(s=class extends Se{toObject(){return{type:this.type,colorsOnly:this.colorsOnly}}},"type",e),t(s,"defaults",{colorsOnly:!1,matrix:n}),s);return o.setClass(i,e),i}t(Se,"type","ColorMatrix"),t(Se,"defaults",po),t(Se,"uniformLocations",["uColorMatrix","uConstants"]),o.setClass(Se);const Kr=ze("Brownie",[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0]),qr=ze("Vintage",[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0]),Yr=ze("Kodachrome",[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0]),Gr=ze("Technicolor",[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0]),Xr=ze("Polaroid",[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0]),Qr=ze("Sepia",[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0]),Zr=ze("BlackWhite",[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]);class es extends p{constructor(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};super(e),this.subFilters=e.subFilters||[]}applyTo(e){st(e)&&(e.passes+=this.subFilters.length-1),this.subFilters.forEach(t=>{t.applyTo(e)})}toObject(){return{type:this.type,subFilters:this.subFilters.map(e=>e.toObject())}}isNeutralState(){return!this.subFilters.some(e=>!e.isNeutralState())}static fromObject(e,t){return Promise.all((e.subFilters||[]).map(e=>o.getClass(e.type).fromObject(e,t))).then(e=>new this({subFilters:e}))}}t(es,"type","Composed"),o.setClass(es);class kt extends p{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uContrast;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    float contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));
    color.rgb = contrastF * (color.rgb - 0.5) + 0.5;
    gl_FragColor = color;
  }`}isNeutralState(){return 0===this.contrast}applyTo2d(e){let{imageData:{data:t}}=e;const s=Math.floor(255*this.contrast),n=259*(s+255)/(255*(259-s));for(let e=0;e<t.length;e+=4)t[e]=n*(t[e]-128)+128,t[e+1]=n*(t[e+1]-128)+128,t[e+2]=n*(t[e+2]-128)+128}sendUniformData(e,t){e.uniform1f(t.uContrast,this.contrast)}}t(kt,"type","Contrast"),t(kt,"defaults",{contrast:0}),t(kt,"uniformLocations",["uContrast"]),o.setClass(kt);const tc={Convolute_3_1:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[9];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 0);
      for (float h = 0.0; h < 3.0; h+=1.0) {
        for (float w = 0.0; w < 3.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));
          color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];
        }
      }
      gl_FragColor = color;
    }
    `,Convolute_3_0:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[9];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 1);
      for (float h = 0.0; h < 3.0; h+=1.0) {
        for (float w = 0.0; w < 3.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));
          color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];
        }
      }
      float alpha = texture2D(uTexture, vTexCoord).a;
      gl_FragColor = color;
      gl_FragColor.a = alpha;
    }
    `,Convolute_5_1:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[25];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 0);
      for (float h = 0.0; h < 5.0; h+=1.0) {
        for (float w = 0.0; w < 5.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
          color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];
        }
      }
      gl_FragColor = color;
    }
    `,Convolute_5_0:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[25];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 1);
      for (float h = 0.0; h < 5.0; h+=1.0) {
        for (float w = 0.0; w < 5.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
          color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];
        }
      }
      float alpha = texture2D(uTexture, vTexCoord).a;
      gl_FragColor = color;
      gl_FragColor.a = alpha;
    }
    `,Convolute_7_1:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[49];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 0);
      for (float h = 0.0; h < 7.0; h+=1.0) {
        for (float w = 0.0; w < 7.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
          color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];
        }
      }
      gl_FragColor = color;
    }
    `,Convolute_7_0:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[49];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 1);
      for (float h = 0.0; h < 7.0; h+=1.0) {
        for (float w = 0.0; w < 7.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
          color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];
        }
      }
      float alpha = texture2D(uTexture, vTexCoord).a;
      gl_FragColor = color;
      gl_FragColor.a = alpha;
    }
    `,Convolute_9_1:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[81];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 0);
      for (float h = 0.0; h < 9.0; h+=1.0) {
        for (float w = 0.0; w < 9.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
          color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];
        }
      }
      gl_FragColor = color;
    }
    `,Convolute_9_0:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[81];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 1);
      for (float h = 0.0; h < 9.0; h+=1.0) {
        for (float w = 0.0; w < 9.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
          color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];
        }
      }
      float alpha = texture2D(uTexture, vTexCoord).a;
      gl_FragColor = color;
      gl_FragColor.a = alpha;
    }
    `};class ot extends p{getCacheKey(){return"".concat(this.type,"_").concat(Math.sqrt(this.matrix.length),"_").concat(this.opaque?1:0)}getFragmentSource(){return tc[this.getCacheKey()]}applyTo2d(e){const p=e.imageData,n=p.data,O=this.matrix,h=Math.round(Math.sqrt(O.length)),w=Math.floor(h/2),a=p.width,b=p.height,_=e.ctx.createImageData(a,b),m=_.data,y=this.opaque?1:0;let g,j,v,f,t,d,u,l,c,r,i,o,s;for(i=0;i<b;i++)for(r=0;r<a;r++){for(t=4*(i*a+r),g=0,j=0,v=0,f=0,s=0;s<h;s++)for(o=0;o<h;o++)u=i+s-w,d=r+o-w,u<0||u>=b||d<0||d>=a||(l=4*(u*a+d),c=O[s*h+o],g+=n[l]*c,j+=n[l+1]*c,v+=n[l+2]*c,y||(f+=n[l+3]*c));m[t]=g,m[t+1]=j,m[t+2]=v,m[t+3]=y?n[t+3]:f}e.imageData=_}sendUniformData(e,t){e.uniform1fv(t.uMatrix,this.matrix)}toObject(){return n(n({},super.toObject()),{},{opaque:this.opaque,matrix:[...this.matrix]})}}t(ot,"type","Convolute"),t(ot,"defaults",{opaque:!1,matrix:[0,0,0,0,1,0,0,0,0]}),t(ot,"uniformLocations",["uMatrix","uOpaque","uHalfSize","uSize"]),o.setClass(ot);const no="Gamma";class at extends p{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform vec3 uGamma;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    vec3 correction = (1.0 / uGamma);
    color.r = pow(color.r, correction.r);
    color.g = pow(color.g, correction.g);
    color.b = pow(color.b, correction.b);
    gl_FragColor = color;
    gl_FragColor.rgb *= color.a;
  }
`}constructor(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};super(e),this.gamma=e.gamma||this.constructor.defaults.gamma.concat()}applyTo2d(e){let{imageData:{data:t}}=e;const s=this.gamma,o=1/s[0],i=1/s[1],a=1/s[2];this.rgbValues||(this.rgbValues={r:new Uint8Array(256),g:new Uint8Array(256),b:new Uint8Array(256)});const n=this.rgbValues;for(let e=0;e<256;e++)n.r[e]=255*(e/255)**o,n.g[e]=255*(e/255)**i,n.b[e]=255*(e/255)**a;for(let e=0;e<t.length;e+=4)t[e]=n.r[t[e]],t[e+1]=n.g[t[e+1]],t[e+2]=n.b[t[e+2]]}sendUniformData(e,t){e.uniform3fv(t.uGamma,this.gamma)}isNeutralState(){const{gamma:e}=this;return 1===e[0]&&1===e[1]&&1===e[2]}toObject(){return{type:no,gamma:this.gamma.concat()}}}t(at,"type",no),t(at,"defaults",{gamma:[1,1,1]}),t(at,"uniformLocations",["uGamma"]),o.setClass(at);const ic={average:`
    precision highp float;
    uniform sampler2D uTexture;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      float average = (color.r + color.b + color.g) / 3.0;
      gl_FragColor = vec4(average, average, average, color.a);
    }
    `,lightness:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform int uMode;
    varying vec2 vTexCoord;
    void main() {
      vec4 col = texture2D(uTexture, vTexCoord);
      float average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;
      gl_FragColor = vec4(average, average, average, col.a);
    }
    `,luminosity:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform int uMode;
    varying vec2 vTexCoord;
    void main() {
      vec4 col = texture2D(uTexture, vTexCoord);
      float average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;
      gl_FragColor = vec4(average, average, average, col.a);
    }
    `};class it extends p{applyTo2d(e){let{imageData:{data:t}}=e;for(let n,e=0;e<t.length;e+=4){const s=t[e],o=t[e+1],i=t[e+2];switch(this.mode){case"average":n=(s+o+i)/3;break;case"lightness":n=(Math.min(s,o,i)+Math.max(s,o,i))/2;break;case"luminosity":n=.21*s+.72*o+.07*i}t[e+2]=t[e+1]=t[e]=n}}getCacheKey(){return"".concat(this.type,"_").concat(this.mode)}getFragmentSource(){return ic[this.mode]}sendUniformData(e,t){e.uniform1i(t.uMode,1)}isNeutralState(){return!1}}t(it,"type","Grayscale"),t(it,"defaults",{mode:"average"}),t(it,"uniformLocations",["uMode"]),o.setClass(it);const rc=n(n({},po),{},{rotation:0});class qt extends Se{calculateMatrix(){const o=this.rotation*Math.PI,s=I(o),i=V(o),e=1/3,n=Math.sqrt(e)*i,t=1-s;this.matrix=[s+t/3,e*t-n,e*t+n,0,0,e*t+n,s+e*t,e*t-n,0,0,e*t-n,e*t+n,s+e*t,0,0,0,0,0,1,0]}isNeutralState(){return 0===this.rotation}applyTo(e){this.calculateMatrix(),super.applyTo(e)}toObject(){return{type:this.type,rotation:this.rotation}}}t(qt,"type","HueRotation"),t(qt,"defaults",rc),o.setClass(qt);class Qe extends p{applyTo2d(e){let{imageData:{data:t}}=e;for(let e=0;e<t.length;e+=4)t[e]=255-t[e],t[e+1]=255-t[e+1],t[e+2]=255-t[e+2],this.alpha&&(t[e+3]=255-t[e+3])}getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform int uInvert;
  uniform int uAlpha;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    if (uInvert == 1) {
      if (uAlpha == 1) {
        gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,1.0 -color.a);
      } else {
        gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);
      }
    } else {
      gl_FragColor = color;
    }
  }
`}isNeutralState(){return!this.invert}sendUniformData(e,t){e.uniform1i(t.uInvert,Number(this.invert)),e.uniform1i(t.uAlpha,Number(this.alpha))}}t(Qe,"type","Invert"),t(Qe,"defaults",{alpha:!1,invert:!0}),t(Qe,"uniformLocations",["uInvert","uAlpha"]),o.setClass(Qe);class pt extends p{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uStepH;
  uniform float uNoise;
  uniform float uSeed;
  varying vec2 vTexCoord;
  float rand(vec2 co, float seed, float vScale) {
    return fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);
  }
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    color.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;
    gl_FragColor = color;
  }
`}applyTo2d(e){let{imageData:{data:t}}=e;const n=this.noise;for(let e=0;e<t.length;e+=4){const s=(.5-Math.random())*n;t[e]+=s,t[e+1]+=s,t[e+2]+=s}}sendUniformData(e,t){e.uniform1f(t.uNoise,this.noise/255),e.uniform1f(t.uSeed,Math.random())}isNeutralState(){return 0===this.noise}}t(pt,"type","Noise"),t(pt,"defaults",{noise:0}),t(pt,"uniformLocations",["uNoise","uSeed"]),o.setClass(pt);class xt extends p{applyTo2d(e){let{imageData:{data:t,width:n,height:s}}=e;for(let e=0;e<s;e+=this.blocksize)for(let o=0;o<n;o+=this.blocksize){const i=4*e*n+4*o,a=t[i],r=t[i+1],c=t[i+2],l=t[i+3];for(let i=e;i<Math.min(e+this.blocksize,s);i++)for(let s=o;s<Math.min(o+this.blocksize,n);s++){const e=4*i*n+4*s;t[e]=a,t[e+1]=r,t[e+2]=c,t[e+3]=l}}}isNeutralState(){return 1===this.blocksize}getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uBlocksize;
  uniform float uStepW;
  uniform float uStepH;
  varying vec2 vTexCoord;
  void main() {
    float blockW = uBlocksize * uStepW;
    float blockH = uBlocksize * uStepH;
    int posX = int(vTexCoord.x / blockW);
    int posY = int(vTexCoord.y / blockH);
    float fposX = float(posX);
    float fposY = float(posY);
    vec2 squareCoords = vec2(fposX * blockW, fposY * blockH);
    vec4 color = texture2D(uTexture, squareCoords);
    gl_FragColor = color;
  }
`}sendUniformData(e,t){e.uniform1f(t.uBlocksize,this.blocksize)}}t(xt,"type","Pixelate"),t(xt,"defaults",{blocksize:4}),t(xt,"uniformLocations",["uBlocksize"]),o.setClass(xt);class Ct extends p{getFragmentSource(){return`
precision highp float;
uniform sampler2D uTexture;
uniform vec4 uLow;
uniform vec4 uHigh;
varying vec2 vTexCoord;
void main() {
  gl_FragColor = texture2D(uTexture, vTexCoord);
  if(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {
    gl_FragColor.a = 0.0;
  }
}
`}applyTo2d(e){let{imageData:{data:s}}=e;const t=255*this.distance,n=new r(this.color).getSource(),o=[n[0]-t,n[1]-t,n[2]-t],i=[n[0]+t,n[1]+t,n[2]+t];for(let e=0;e<s.length;e+=4){const t=s[e],n=s[e+1],a=s[e+2];t>o[0]&&n>o[1]&&a>o[2]&&t<i[0]&&n<i[1]&&a<i[2]&&(s[e+3]=0)}}sendUniformData(e,t){const n=new r(this.color).getSource(),s=this.distance,o=[0+n[0]/255-s,0+n[1]/255-s,0+n[2]/255-s,1],i=[n[0]/255+s,n[1]/255+s,n[2]/255+s,1];e.uniform4fv(t.uLow,o),e.uniform4fv(t.uHigh,i)}}t(Ct,"type","RemoveColor"),t(Ct,"defaults",{color:"#FFFFFF",distance:.02,useAlpha:!1}),t(Ct,"uniformLocations",["uLow","uHigh"]),o.setClass(Ct);class Et extends p{sendUniformData(e,t){e.uniform2fv(t.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),e.uniform1fv(t.uTaps,this.taps)}getFilterWindow(){const e=this.tempScale;return Math.ceil(this.lanczosLobes/e)}getCacheKey(){const e=this.getFilterWindow();return"".concat(this.type,"_").concat(e)}getFragmentSource(){const e=this.getFilterWindow();return this.generateShader(e)}getTaps(){const n=this.lanczosCreate(this.lanczosLobes),s=this.tempScale,e=this.getFilterWindow(),t=new Array(e);for(let o=1;o<=e;o++)t[o-1]=n(o*s);return t}generateShader(e){const t=new Array(e);for(let n=1;n<=e;n++)t[n-1]="".concat(n,".0 * uDelta");return`
      precision highp float;
      uniform sampler2D uTexture;
      uniform vec2 uDelta;
      varying vec2 vTexCoord;
      uniform float uTaps[`.concat(e,`];
      void main() {
        vec4 color = texture2D(uTexture, vTexCoord);
        float sum = 1.0;
        `).concat(t.map((e,t)=>`
              color += texture2D(uTexture, vTexCoord + `.concat(e,") * uTaps[").concat(t,"] + texture2D(uTexture, vTexCoord - ").concat(e,") * uTaps[").concat(t,`];
              sum += 2.0 * uTaps[`).concat(t,`];
            `)).join(`
`),`
        gl_FragColor = color / sum;
      }
    `)}applyToForWebgl(e){e.passes++,this.width=e.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=e.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),e.destinationWidth=this.dW,super.applyTo(e),e.sourceWidth=e.destinationWidth,this.height=e.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),e.destinationHeight=this.dH,super.applyTo(e),e.sourceHeight=e.destinationHeight}applyTo(e){st(e)?this.applyToForWebgl(e):this.applyTo2d(e)}isNeutralState(){return 1===this.scaleX&&1===this.scaleY}lanczosCreate(e){return t=>{if(t>=e||t<=-e)return 0;if(t<11920929e-14&&t>-11920929e-14)return 1;const n=(t*=Math.PI)/e;return Math.sin(t)/t*Math.sin(n)/n}}applyTo2d(e){const i=e.imageData,a=this.scaleX,r=this.scaleY;this.rcpScaleX=1/a,this.rcpScaleY=1/r;const t=i.width,n=i.height,s=Math.round(t*a),o=Math.round(n*r);let c;c="sliceHack"===this.resizeType?this.sliceByTwo(e,t,n,s,o):"hermite"===this.resizeType?this.hermiteFastResize(e,t,n,s,o):"bilinear"===this.resizeType?this.bilinearFiltering(e,t,n,s,o):"lanczos"===this.resizeType?this.lanczosResize(e,t,n,s,o):new ImageData(s,o),e.imageData=c}sliceByTwo(e,t,n,s,o){const v=e.imageData,a=.5;let g=!1,f=!1,c=t*a,i=n*a;const u=e.filterBackend.resources;let h=0,m=0;const p=t;let d=0;u.sliceByTwo||(u.sliceByTwo=N());const r=u.sliceByTwo;(r.width<1.5*t||r.height<n)&&(r.width=1.5*t,r.height=n);const l=r.getContext("2d");for(l.clearRect(0,0,1.5*t,n),l.putImageData(v,0,0),s=Math.floor(s),o=Math.floor(o);!g||!f;)t=c,n=i,s<Math.floor(c*a)?c=Math.floor(c*a):(c=s,g=!0),o<Math.floor(i*a)?i=Math.floor(i*a):(i=o,f=!0),l.drawImage(r,h,m,t,n,p,d,c,i),h=p,m=d,d+=i;return l.getImageData(h,m,s,o)}lanczosResize(e,t,n,s,o){const l=e.imageData.data,d=e.ctx.createImageData(s,o),c=d.data,p=this.lanczosCreate(this.lanczosLobes),u=this.rcpScaleX,h=this.rcpScaleY,v=2/this.rcpScaleX,g=2/this.rcpScaleY,m=Math.ceil(u*this.lanczosLobes/2),f=Math.ceil(h*this.lanczosLobes/2),r={},a={x:0,y:0},i={x:0,y:0};return function e(b){let x,y,_,j,O,E,k,A,S,w,C;for(a.x=(b+.5)*u,i.x=Math.floor(a.x),x=0;x<o;x++){for(a.y=(x+.5)*h,i.y=Math.floor(a.y),O=0,E=0,k=0,A=0,S=0,y=i.x-m;y<=i.x+m;y++)if(!(y<0||y>=t)){w=Math.floor(1e3*Math.abs(y-a.x)),r[w]||(r[w]={});for(let e=i.y-f;e<=i.y+f;e++)e<0||e>=n||(C=Math.floor(1e3*Math.abs(e-a.y)),r[w][C]||(r[w][C]=p(Math.sqrt((w*v)**2+(C*g)**2)/1e3)),_=r[w][C],_>0&&(j=4*(e*t+y),O+=_,E+=_*l[j],k+=_*l[j+1],A+=_*l[j+2],S+=_*l[j+3]))}j=4*(x*s+b),c[j]=E/O,c[j+1]=k/O,c[j+2]=A/O,c[j+3]=S/O}return++b<s?e(b):d}(0)}bilinearFiltering(e,t,n,s,o){let f,_,v,p,m,h,d,a,l,c,i,g,r,O=0;const b=this.rcpScaleX,j=this.rcpScaleY,y=4*(t-1),u=e.imageData.data,w=e.ctx.createImageData(s,o),x=w.data;for(d=0;d<o;d++)for(a=0;a<s;a++)for(m=Math.floor(b*a),h=Math.floor(j*d),l=b*a-m,c=j*d-h,r=4*(h*t+m),i=0;i<4;i++)f=u[r+i],_=u[r+4+i],v=u[r+y+i],p=u[r+y+4+i],g=f*(1-l)*(1-c)+_*l*(1-c)+v*c*(1-l)+p*l*c,x[O++]=g;return w}hermiteFastResize(e,t,n,s,o){const a=this.rcpScaleX,r=this.rcpScaleY,d=Math.ceil(a/2),u=Math.ceil(r/2),i=e.imageData.data,l=e.ctx.createImageData(s,o),c=l.data;for(let e=0;e<o;e++)for(let o=0;o<s;o++){const l=4*(o+e*s);let n=0,h=0,m=0,f=0,p=0,g=0,v=0;const b=(e+.5)*r;for(let s=Math.floor(e*r);s<(e+1)*r;s++){const c=Math.abs(b-(s+.5))/u,l=(o+.5)*a,j=c*c;for(let c=Math.floor(o*a);c<(o+1)*a;c++){let e=Math.abs(l-(c+.5))/d;const r=Math.sqrt(j+e*e);r>1&&r<-1||(n=2*r*r*r-3*r*r+1,n>0&&(e=4*(c+s*t),v+=n*i[e+3],m+=n,i[e+3]<255&&(n=n*i[e+3]/250),f+=n*i[e],p+=n*i[e+1],g+=n*i[e+2],h+=n))}}c[l]=f/h,c[l+1]=p/h,c[l+2]=g/h,c[l+3]=v/m}return l}}t(Et,"type","Resize"),t(Et,"defaults",{resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3}),t(Et,"uniformLocations",["uDelta","uTaps"]),o.setClass(Et);class Mt extends p{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uSaturation;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    float rgMax = max(color.r, color.g);
    float rgbMax = max(rgMax, color.b);
    color.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;
    color.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;
    color.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;
    gl_FragColor = color;
  }
`}applyTo2d(e){let{imageData:{data:t}}=e;const n=-this.saturation;for(let e=0;e<t.length;e+=4){const o=t[e],i=t[e+1],a=t[e+2],s=Math.max(o,i,a);t[e]+=s!==o?(s-o)*n:0,t[e+1]+=s!==i?(s-i)*n:0,t[e+2]+=s!==a?(s-a)*n:0}}sendUniformData(e,t){e.uniform1f(t.uSaturation,-this.saturation)}isNeutralState(){return 0===this.saturation}}t(Mt,"type","Saturation"),t(Mt,"defaults",{saturation:0}),t(Mt,"uniformLocations",["uSaturation"]),o.setClass(Mt);class Tt extends p{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uVibrance;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    float max = max(color.r, max(color.g, color.b));
    float avg = (color.r + color.g + color.b) / 3.0;
    float amt = (abs(max - avg) * 2.0) * uVibrance;
    color.r += max != color.r ? (max - color.r) * amt : 0.00;
    color.g += max != color.g ? (max - color.g) * amt : 0.00;
    color.b += max != color.b ? (max - color.b) * amt : 0.00;
    gl_FragColor = color;
  }
`}applyTo2d(e){let{imageData:{data:t}}=e;const n=-this.vibrance;for(let e=0;e<t.length;e+=4){const o=t[e],i=t[e+1],a=t[e+2],s=Math.max(o,i,a),c=(o+i+a)/3,r=2*Math.abs(s-c)/255*n;t[e]+=s!==o?(s-o)*r:0,t[e+1]+=s!==i?(s-i)*r:0,t[e+2]+=s!==a?(s-a)*r:0}}sendUniformData(e,t){e.uniform1f(t.uVibrance,-this.vibrance)}isNeutralState(){return 0===this.vibrance}}t(Tt,"type","Vibrance"),t(Tt,"defaults",{vibrance:0}),t(Tt,"uniformLocations",["uVibrance"]),o.setClass(Tt),Ps=Object.freeze({__proto__:null,BaseFilter:p,BlackWhite:Zr,BlendColor:et,BlendImage:Ge,Blur:yt,Brightness:St,Brownie:Kr,ColorMatrix:Se,Composed:es,Contrast:kt,Convolute:ot,Gamma:at,Grayscale:it,HueRotation:qt,Invert:Qe,Kodachrome:Yr,Noise:pt,Pixelate:xt,Polaroid:Xr,RemoveColor:Ct,Resize:Et,Saturation:Mt,Sepia:Qr,Technicolor:Gr,Vibrance:Tt,Vintage:qr}),e.ActiveSelection=xe,e.BaseBrush=ln,e.BaseFabricObject=Q,e.Canvas=Fn,e.Canvas2dFilterBackend=ui,e.CanvasDOMManager=Mi,e.Circle=X,e.CircleBrush=class extends ln{constructor(e){super(e),t(this,"width",10),this.points=[]}drawDot(e){const n=this.addPoint(e),t=this.canvas.contextTop;this._saveAndTransform(t),this.dot(t,n),t.restore()}dot(e,t){e.fillStyle=t.fill,e.beginPath(),e.arc(t.x,t.y,t.radius,0,2*Math.PI,!1),e.closePath(),e.fill()}onMouseDown(e){this.points=[],this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.drawDot(e)}_render(){const e=this.canvas.contextTop,t=this.points;this._saveAndTransform(e);for(let n=0;n<t.length;n++)this.dot(e,t[n]);e.restore()}onMouseMove(e){!0===this.limitedToCanvasSize&&this._isOutSideCanvas(e)||(this.needsFullRender()?(this.canvas.clearContext(this.canvas.contextTop),this.addPoint(e),this._render()):this.drawDot(e))}onMouseUp(){const n=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;const t=[];for(let n=0;n<this.points.length;n++){const e=this.points[n],s=new X({radius:e.radius,left:e.x,top:e.y,originX:i,originY:i,fill:e.fill});this.shadow&&(s.shadow=new R(this.shadow)),t.push(s)}const e=new P(t,{canvas:this.canvas});this.canvas.fire("before:path:created",{path:e}),this.canvas.add(e),this.canvas.fire("path:created",{path:e}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=n,this.canvas.requestRenderAll()}addPoint(e){let{x:n,y:s}=e;const t={x:n,y:s,radius:De(Math.max(0,this.width-20),this.width+20)/2,fill:new r(this.color).setAlpha(De(0,100)/100).toRgba()};return this.points.push(t),t}},e.ClipPathLayout=ms,e.Color=r,e.Control=F,e.Ellipse=oe,e.FabricImage=S,e.FabricObject=b,e.FabricText=y,e.FitContentLayout=sn,e.FixedLayout=us,e.Gradient=We,e.Group=P,e.IText=ce,e.Image=S,e.InteractiveFabricObject=ht,e.Intersection=h,e.LayoutManager=Ye,e.LayoutStrategy=rt,e.Line=Oe,e.Object=b,e.Observable=so,e.Path=ue,e.Pattern=ct,e.PatternBrush=class extends on{constructor(e){super(e)}getPatternSrc(){const t=N(),e=t.getContext("2d");return t.width=t.height=25,e&&(e.fillStyle=this.color,e.beginPath(),e.arc(10,10,10,0,2*Math.PI,!1),e.closePath(),e.fill()),t}getPattern(e){return e.createPattern(this.source||this.getPatternSrc(),"repeat")}_setBrushStyles(e){super._setBrushStyles(e);const t=this.getPattern(e);t&&(e.strokeStyle=t)}createPath(e){const t=super.createPath(e),n=t._getLeftTopCoords().scalarAdd(t.strokeWidth/2);return t.stroke=new ct({source:this.source||this.getPatternSrc(),offsetX:-n.x,offsetY:-n.y}),t}},e.PencilBrush=on,e.Point=s,e.Polygon=At,e.Polyline=U,e.Rect=B,e.Shadow=R,e.SprayBrush=class extends ln{constructor(e){super(e),t(this,"width",10),t(this,"density",20),t(this,"dotWidth",1),t(this,"dotWidthVariance",1),t(this,"randomOpacity",!1),t(this,"optimizeOverlapping",!0),this.sprayChunks=[],this.sprayChunk=[]}onMouseDown(e){this.sprayChunks=[],this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.addSprayChunk(e),this.renderChunck(this.sprayChunk)}onMouseMove(e){!0===this.limitedToCanvasSize&&this._isOutSideCanvas(e)||(this.addSprayChunk(e),this.renderChunck(this.sprayChunk))}onMouseUp(){const n=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;const t=[];for(let e=0;e<this.sprayChunks.length;e++){const n=this.sprayChunks[e];for(let s=0;s<n.length;s++){const e=n[s],o=new B({width:e.width,height:e.width,left:e.x+1,top:e.y+1,originX:i,originY:i,fill:this.color});t.push(o)}}const e=new P(this.optimizeOverlapping?function(e){const t={},n=[];for(let o,s=0;s<e.length;s++)o="".concat(e[s].left).concat(e[s].top),t[o]||(t[o]=!0,n.push(e[s]));return n}(t):t,{objectCaching:!0,subTargetCheck:!1,interactive:!1});this.shadow&&e.set("shadow",new R(this.shadow)),this.canvas.fire("before:path:created",{path:e}),this.canvas.add(e),this.canvas.fire("path:created",{path:e}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=n,this.canvas.requestRenderAll()}renderChunck(e){const t=this.canvas.contextTop;t.fillStyle=this.color,this._saveAndTransform(t);for(let s=0;s<e.length;s++){const n=e[s];t.globalAlpha=n.opacity,t.fillRect(n.x,n.y,n.width,n.width)}t.restore()}_render(){const e=this.canvas.contextTop;e.fillStyle=this.color,this._saveAndTransform(e);for(let e=0;e<this.sprayChunks.length;e++)this.renderChunck(this.sprayChunks[e]);e.restore()}addSprayChunk(e){this.sprayChunk=[];const t=this.width/2;for(let n=0;n<this.density;n++)this.sprayChunk.push({x:De(e.x-t,e.x+t),y:De(e.y-t,e.y+t),width:this.dotWidthVariance?De(Math.max(1,this.dotWidth-this.dotWidthVariance),this.dotWidth+this.dotWidthVariance):this.dotWidth,opacity:this.randomOpacity?De(0,100)/100:1});this.sprayChunks.push(this.sprayChunk)}},e.StaticCanvas=nt,e.StaticCanvasDOMManager=wn,e.Text=y,e.Textbox=ye,e.Triangle=_e,e.WebGLFilterBackend=ut,e.cache=Be,e.classRegistry=o,e.config=a,e.controlsUtils=xo,e.createCollectionMixin=ts,e.filters=Ps,e.getCSSRules=Yo,e.getEnv=W,e.getFabricDocument=we,e.getFabricWindow=$,e.getFilterBackend=dn,e.iMatrix=_,e.initFilterBackend=si,e.isPutImageFaster=(e,t)=>{const a=M({width:e,height:t}),s=N().getContext("webgl"),o={imageBuffer:new ArrayBuffer(e*t*4)},i={destinationWidth:e,destinationHeight:t,targetCanvas:a};let n;n=$().performance.now(),ut.prototype.copyGLTo2D.call(o,s,i);const r=$().performance.now()-n;return n=$().performance.now(),ut.prototype.copyGLTo2DPutImageData.call(o,s,i),r>$().performance.now()-n},e.isWebGLPipelineState=st,e.loadSVGFromString=function(e,t,n){return En((new $().DOMParser).parseFromString(e.trim(),"text/xml"),t,n)},e.loadSVGFromURL=function(e,t){let n=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:{};return new Promise((t,s)=>{ki(e.replace(/^\n\s*/,"").trim(),{onComplete:e=>{const n=e.responseXML;n&&t(n),s()},signal:n.signal})}).then(e=>En(e,t,n)).catch(()=>On())},e.parseAttributes=J,e.parseFontDeclaration=ko,e.parsePointsAttribute=Ji,e.parseSVGDocument=En,e.parseStyleAttribute=So,e.parseTransformAttribute=lt,e.runningAnimations=Ot,e.setEnv=e=>{Es=e},e.setFilterBackend=function(e){an=e},e.util=Si,e.version=Ht})}}),Il=Is({"node_modules/openseadragon-fabric/lib/fabric-canvas.js"(e){"use strict";var t,n,s,o=e&&e.__createBinding||(Object.create?function(e,t,n,s){s===0[0]&&(s=n);var o=Object.getOwnPropertyDescriptor(t,n);(!o||("get"in o?!t.__esModule:o.writable||o.configurable))&&(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,s,o)}:function(e,t,n,s){s===0[0]&&(s=n),e[s]=t[n]}),i=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var n,t={};if(e!=null)for(n in e)n!=="default"&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return i(t,e),t};Object.defineProperty(e,"__esModule",{value:!0}),e.FabricOverlay=0[0],t=gc(),n=a(Qs()),s=class{_viewer;_canvas;_fabricCanvas;_id;_containerWidth;_containerHeight;_canvasDiv;viewer(){return this._viewer}canvas(){return this._canvas}fabricCanvas(){return this._fabricCanvas}clearFabric(){this._fabricCanvas.clear()}renderAllFabric(){this._fabricCanvas.renderAll()}resizeCanvas(){this._containerWidth!==this._viewer.container.clientWidth&&(this._containerWidth=this._viewer.container.clientWidth,this._canvasDiv.setAttribute("width",String(this._containerWidth)),this._canvas.setAttribute("width",String(this._containerWidth))),this._containerHeight!==this._viewer.container.clientHeight&&(this._containerHeight=this._viewer.container.clientHeight,this._canvasDiv.setAttribute("height",String(this._containerHeight)),this._canvas.setAttribute("height",String(this._containerHeight)))}resizeFabric(){let a=new n.Point(0,0),e=this._viewer.viewport.getZoom(!0),r=this._viewer.viewport.viewportToImageZoom(e);this._fabricCanvas.setWidth(this._containerWidth),this._fabricCanvas.setHeight(this._containerHeight),this._fabricCanvas.setZoom(e),this._fabricCanvas.setZoom(r);let s=this._viewer.viewport.viewportToWindowCoordinates(a),c=Math.round(s.x),l=Math.round(s.y),o=this._canvasDiv.getBoundingClientRect(),i=n.default.getPageScroll();this._fabricCanvas.absolutePan(new t.Point(o.left-c+i.x,o.top-l+i.y))}clearFabricSelection(){this._fabricCanvas.isDrawingMode?(this._fabricCanvas.isDrawingMode=!1,this._fabricCanvas.clearContext(this._fabricCanvas.getContext())):this._fabricCanvas.discardActiveObject(),this._fabricCanvas.requestRenderAll()}setViewerMouseNavEnabled(e=!0){if(!this._viewer)return;this._viewer.setMouseNavEnabled(e)}updateCanvasRotation(e){if(e<0||e>360)return;this._viewer.world.getItemAt(0).setRotation(e,!0)}constructor(e,{fabricCanvasOptions:n={selection:!1}},s){let o=this;this._viewer=e,this._containerWidth=0,this._containerHeight=0,this._canvasDiv=document.createElement("div"),this._canvasDiv.style.position="absolute",this._canvasDiv.style.left="0px",this._canvasDiv.style.top="0px",this._canvasDiv.style.width="100%",this._canvasDiv.style.height="100%",this._viewer.canvas.appendChild(this._canvasDiv),this._canvas=document.createElement("canvas"),this._id="osd-canvas-"+s,this._canvas.setAttribute("id",this._id),this._canvasDiv.appendChild(this._canvas),this.resizeCanvas(),this._fabricCanvas=new t.Canvas(this._canvas,n),this._fabricCanvas.on("mouse:down",function(e){e.target&&(e.e.preventDefault(),e.e.stopPropagation())}),this._fabricCanvas.on("mouse:up",function(e){e.target&&(e.e.preventDefault(),e.e.stopPropagation())}),this._viewer.addHandler("update-viewport",function(){o.resizeFabric(),o.resizeCanvas(),o.renderAllFabric()}),this._viewer.addHandler("open",function(){o.resizeFabric(),o.resizeCanvas()}),window.addEventListener("resize",function(){o.resizeFabric(),o.resizeCanvas()})}},e.FabricOverlay=s}}),Vl=Is({"node_modules/openseadragon-fabric/lib/openseadragon-fabric.js"(e){"use strict";var t,n,s,o=e&&e.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(e,"__esModule",{value:!0}),e.initOSDFabricJS=e.FabricOverlay=0[0],t=o(Qs()),n=Il(),Object.defineProperty(e,"FabricOverlay",{enumerable:!0,get:function(){return n.FabricOverlay}}),s=gc();function i(){if(!t.default){console.error("[openseadragon-canvas-overlay] requires OpenSeadragon");return}if(!s.Canvas){console.error("[fabric-js] requires FabricJS"),console.error("Please import FabricJS before importing this package");return}let e=0;const o=()=>(e+=1,e);t.default.Viewer.prototype.fabricOverlay=function(e){const t=o(),s=new n.FabricOverlay(this,e,t);return s}}e.initOSDFabricJS=i}}),_=Oc(Qs()),ql=Oc(Vl());function s(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n,s=e[Symbol.toPrimitive];if(0[0]!==s){if(n=s.call(e,t||"default"),"object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Od(e,t){var n,s=Object.keys(e);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(e),t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),s.push.apply(s,n)),s}function n(e){for(var t,n=1;n<arguments.length;n++)t=null!=arguments[n]?arguments[n]:{},n%2?Od(Object(t),!0).forEach(function(n){s(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Od(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))});return e}function w(e,t){if(e==null)return{};var n,s,o,i=function(e,t){if(e==null)return{};var n,s={};for(n in e)if({}.hasOwnProperty.call(e,n)){if(t.indexOf(n)>=0)continue;s[n]=e[n]}return s}(e,t);if(Object.getOwnPropertySymbols){o=Object.getOwnPropertySymbols(e);for(s=0;s<o.length;s++)n=o[s],t.indexOf(n)>=0||{}.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}function we(e,t){return t||(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}hc=class{constructor(){s(this,"browserShadowBlurConstant",1),s(this,"DPI",96),s(this,"devicePixelRatio","undefined"!=typeof window?window.devicePixelRatio:1),s(this,"perfLimitSizeTotal",2097152),s(this,"maxCacheSideLimit",4096),s(this,"minCacheSideLimit",256),s(this,"disableStyleCopyPaste",!1),s(this,"enableGLFiltering",!0),s(this,"textureSize",4096),s(this,"forceGLPutImageData",!1),s(this,"cachesBoundsOfCurve",!1),s(this,"fontPaths",{}),s(this,"NUM_FRACTION_DIGITS",4)}},b=new class extends hc{constructor(e){super(),this.configure(e)}configure(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};Object.assign(this,e)}addFonts(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};this.fontPaths=n(n({},this.fontPaths),e)}removeFonts(){(arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[]).forEach(e=>{delete this.fontPaths[e]})}clearFonts(){this.fontPaths={}}restoreDefaults(e){const t=new hc,n=e?.reduce((e,n)=>(e[n]=t[n],e),{})||t;this.configure(n)}},Ae=function(e){for(var n=arguments.length,s=new Array(n>1?n-1:0),t=1;t<n;t++)s[t-1]=arguments[t];return console[e]("fabric",...s)},de=class extends Error{constructor(e,t){super("fabric: ".concat(e),t)}},uc=class extends de{constructor(e){super("".concat(e," 'options.signal' is in 'aborted' state"))}},Cd=class{},Id=class extends Cd{testPrecision(e,t){const s="precision ".concat(t,` float;
void main(){}`),n=e.createShader(e.FRAGMENT_SHADER);return!!n&&(e.shaderSource(n,s),e.compileShader(n),!!e.getShaderParameter(n,e.COMPILE_STATUS))}queryWebGL(e){const t=e.getContext("webgl");t&&(this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.GLPrecision=["highp","mediump","lowp"].find(e=>this.testPrecision(t,e)),t.getExtension("WEBGL_lose_context").loseContext(),Ae("log","WebGL: max texture size ".concat(this.maxTextureSize)))}isSupported(e){return!!this.maxTextureSize&&this.maxTextureSize>=e}},Bd={},ue=()=>eu||(eu={document,window,isTouchSupported:"ontouchstart"in window||"ontouchstart"in document||window&&window.navigator&&window.navigator.maxTouchPoints>0,WebGLProbe:new Id,dispose(){},copyPasteData:Bd}),Ze=()=>ue().document,It=()=>ue().window,rc=()=>{var e;return Math.max(null!==(e=b.devicePixelRatio)&&0[0]!==e?e:It().devicePixelRatio,1)},Bt=new class{constructor(){s(this,"charWidthsCache",{}),s(this,"boundsOfCurveCache",{})}getFontCache(e){let{fontFamily:t,fontStyle:o,fontWeight:i}=e;t=t.toLowerCase(),this.charWidthsCache[t]||(this.charWidthsCache[t]={});const n=this.charWidthsCache[t],s="".concat(o.toLowerCase(),"_").concat((i+"").toLowerCase());return n[s]||(n[s]={}),n[s]}clearFontCache(e){(e=(e||"").toLowerCase())?this.charWidthsCache[e]&&delete this.charWidthsCache[e]:this.charWidthsCache={}}limitDimsByArea(e){const{perfLimitSizeTotal:t}=b,n=Math.sqrt(t*e);return[Math.floor(n),Math.floor(t/n)]}},Js="6.7.1";function jt(){}Fe=Math.PI/2,je=2*Math.PI,eo=Math.PI/180,D=Object.freeze([1,0,0,1,0,0]),to=16,De=.4477152502,m="center",j="left",P="top",so="bottom",C="right",N="none",ro=/\r?\n/,Yr="moving",zs="scaling",qr="rotating",co="rotate",Wr="skewing",jn="resizing",$r="modifyPoly",r1="modifyPath",Ss="changed",As="scale",F="scaleX",B="scaleY",rt="skewX",Ot="skewY",A="fill",R="stroke",ks="modified",at="json",lo="svg",c=new class{constructor(){this[at]=new Map,this[lo]=new Map}has(e){return this[at].has(e)}getClass(e){const t=this[at].get(e);if(!t)throw new de("No class registered for ".concat(e));return t}setClass(e,t){t?this[at].set(t,e):(this[at].set(e.type,e),this[at].set(e.type.toLowerCase(),e))}getSVGClass(e){return this[lo].get(e)}setSVGClass(e,t){this[lo].set(t??e.type.toLowerCase(),e)}},xs=new class extends Array{remove(e){const t=this.indexOf(e);t>-1&&this.splice(t,1)}cancelAll(){const e=this.splice(0);return e.forEach(e=>e.abort()),e}cancelByCanvas(e){if(!e)return[];const t=this.filter(t=>{var n;return t.target===e||"object"==typeof t.target&&(null===(n=t.target)||0[0]===n?0[0]:n.canvas)===e});return t.forEach(e=>e.abort()),t}cancelByTarget(e){if(!e)return[];const t=this.filter(t=>t.target===e);return t.forEach(e=>e.abort()),t}},x1=class{constructor(){s(this,"__eventListeners",{})}on(e,t){if(this.__eventListeners||(this.__eventListeners={}),"object"==typeof e)return Object.entries(e).forEach(e=>{let[t,n]=e;this.on(t,n)}),()=>this.off(e);if(t){const n=e;return this.__eventListeners[n]||(this.__eventListeners[n]=[]),this.__eventListeners[n].push(t),()=>this.off(n,t)}return()=>!1}once(e,t){if("object"==typeof e){const t=[];return Object.entries(e).forEach(e=>{let[n,s]=e;t.push(this.once(n,s))}),()=>t.forEach(e=>e())}if(t){const n=this.on(e,function(){for(var s=arguments.length,o=new Array(s),e=0;e<s;e++)o[e]=arguments[e];t.call(this,...o),n()});return n}return()=>!1}_removeEventListener(e,t){if(this.__eventListeners[e])if(t){const n=this.__eventListeners[e],s=n.indexOf(t);s>-1&&n.splice(s,1)}else this.__eventListeners[e]=[]}off(e,t){if(this.__eventListeners)if(0[0]===e)for(const e in this.__eventListeners)this._removeEventListener(e);else"object"==typeof e?Object.entries(e).forEach(e=>{let[t,n]=e;this._removeEventListener(t,n)}):this._removeEventListener(e,t)}fire(e,t){var n;if(!this.__eventListeners)return;const s=null===(n=this.__eventListeners[e])||0[0]===n?0[0]:n.concat();if(s)for(let e=0;e<s.length;e++)s[e].call(this,t||{})}},$e=(e,t)=>{const n=e.indexOf(t);return-1!==n&&e.splice(n,1),e},se=e=>{if(0===e)return 1;switch((e<0?-e:e)/Fe){case 1:case 3:return 0;case 2:return-1}return Math.cos(e)},Z=e=>{if(0===e)return 0;const n=e/Fe,t=Math.sign(e);switch(n){case 1:return t;case 2:return 0;case 3:return-t}return Math.sin(e)},o=class _ot{constructor(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:0,t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:0;"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e,this.y=t)}add(e){return new _ot(this.x+e.x,this.y+e.y)}addEquals(e){return this.x+=e.x,this.y+=e.y,this}scalarAdd(e){return new _ot(this.x+e,this.y+e)}scalarAddEquals(e){return this.x+=e,this.y+=e,this}subtract(e){return new _ot(this.x-e.x,this.y-e.y)}subtractEquals(e){return this.x-=e.x,this.y-=e.y,this}scalarSubtract(e){return new _ot(this.x-e,this.y-e)}scalarSubtractEquals(e){return this.x-=e,this.y-=e,this}multiply(e){return new _ot(this.x*e.x,this.y*e.y)}scalarMultiply(e){return new _ot(this.x*e,this.y*e)}scalarMultiplyEquals(e){return this.x*=e,this.y*=e,this}divide(e){return new _ot(this.x/e.x,this.y/e.y)}scalarDivide(e){return new _ot(this.x/e,this.y/e)}scalarDivideEquals(e){return this.x/=e,this.y/=e,this}eq(e){return this.x===e.x&&this.y===e.y}lt(e){return this.x<e.x&&this.y<e.y}lte(e){return this.x<=e.x&&this.y<=e.y}gt(e){return this.x>e.x&&this.y>e.y}gte(e){return this.x>=e.x&&this.y>=e.y}lerp(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:.5;return t=Math.max(Math.min(1,t),0),new _ot(this.x+(e.x-this.x)*t,this.y+(e.y-this.y)*t)}distanceFrom(e){const t=this.x-e.x,n=this.y-e.y;return Math.sqrt(t*t+n*n)}midPointFrom(e){return this.lerp(e)}min(e){return new _ot(Math.min(this.x,e.x),Math.min(this.y,e.y))}max(e){return new _ot(Math.max(this.x,e.x),Math.max(this.y,e.y))}toString(){return"".concat(this.x,",").concat(this.y)}setXY(e,t){return this.x=e,this.y=t,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setFromPoint(e){return this.x=e.x,this.y=e.y,this}swap(e){const t=this.x,n=this.y;this.x=e.x,this.y=e.y,e.x=t,e.y=n}clone(){return new _ot(this.x,this.y)}rotate(e){let n=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:uo;const s=Z(e),o=se(e),t=this.subtract(n);return new _ot(t.x*o-t.y*s,t.x*s+t.y*o).add(n)}transform(e){let t=arguments.length>1&&0[0]!==arguments[1]&&arguments[1];return new _ot(e[0]*this.x+e[2]*this.y+(t?0:e[4]),e[1]*this.x+e[3]*this.y+(t?0:e[5]))}},uo=new o(0,0),Os=e=>!!e&&Array.isArray(e._objects);function $1(e){class t extends e{constructor(){super(...arguments),s(this,"_objects",[])}_onObjectAdded(){}_onObjectRemoved(){}_onStackOrderChanged(){}add(){for(var n=arguments.length,t=new Array(n),e=0;e<n;e++)t[e]=arguments[e];const s=this._objects.push(...t);return t.forEach(e=>this._onObjectAdded(e)),s}insertAt(e){for(var n=arguments.length,s=new Array(n>1?n-1:0),t=1;t<n;t++)s[t-1]=arguments[t];return this._objects.splice(e,0,...s),s.forEach(e=>this._onObjectAdded(e)),this._objects.length}remove(){const t=this._objects,n=[];for(var s=arguments.length,o=new Array(s),e=0;e<s;e++)o[e]=arguments[e];return o.forEach(e=>{const s=t.indexOf(e);-1!==s&&(t.splice(s,1),n.push(e),this._onObjectRemoved(e))}),n}forEachObject(e){this.getObjects().forEach((t,n,s)=>e(t,n,s))}getObjects(){for(var n=arguments.length,t=new Array(n),e=0;e<n;e++)t[e]=arguments[e];return 0===t.length?[...this._objects]:this._objects.filter(e=>e.isType(...t))}item(e){return this._objects[e]}isEmpty(){return 0===this._objects.length}size(){return this._objects.length}contains(e,n){return!!this._objects.includes(e)||!!n&&this._objects.some(n=>n instanceof t&&n.contains(e,!0))}complexity(){return this._objects.reduce((e,t)=>e+=t.complexity?t.complexity():0,0)}sendObjectToBack(e){return!!e&&e!==this._objects[0]&&($e(this._objects,e),this._objects.unshift(e),this._onStackOrderChanged(e),!0)}bringObjectToFront(e){return!!e&&e!==this._objects[this._objects.length-1]&&($e(this._objects,e),this._objects.push(e),this._onStackOrderChanged(e),!0)}sendObjectBackwards(e,t){if(!e)return!1;const n=this._objects.indexOf(e);if(0!==n){const s=this.findNewLowerIndex(e,n,t);return $e(this._objects,e),this._objects.splice(s,0,e),this._onStackOrderChanged(e),!0}return!1}bringObjectForward(e,t){if(!e)return!1;const n=this._objects.indexOf(e);if(n!==this._objects.length-1){const s=this.findNewUpperIndex(e,n,t);return $e(this._objects,e),this._objects.splice(s,0,e),this._onStackOrderChanged(e),!0}return!1}moveObjectTo(e,t){return e!==this._objects[t]&&($e(this._objects,e),this._objects.splice(t,0,e),this._onStackOrderChanged(e),!0)}findNewLowerIndex(e,t,n){let s;if(n){{s=t;for(let n=t-1;n>=0;--n)if(e.isOverlapping(this._objects[n])){s=n;break}}}else s=t-1;return s}findNewUpperIndex(e,t,n){let s;if(n){{s=t;for(let n=t+1;n<this._objects.length;++n)if(e.isOverlapping(this._objects[n])){s=n;break}}}else s=t+1;return s}collectObjects(e){let{left:a,top:r,width:c,height:l}=e,{includeIntersecting:n=!0}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};const i=[],t=new o(a,r),s=t.add(new o(c,l));for(let o=this._objects.length-1;o>=0;o--){const e=this._objects[o];e.selectable&&e.visible&&(n&&e.intersectsWithRect(t,s)||e.isContainedWithinRect(t,s)||n&&e.containsPoint(t)||n&&e.containsPoint(s))&&i.push(e)}return i}}return t}Rr=class extends x1{_setOptions(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};for(const t in e)this.set(t,e[t])}_setObject(e){for(const t in e)this._set(t,e[t])}set(e,t){return"object"==typeof e?this._setObject(e):this._set(e,t),this}_set(e,t){this[e]=t}toggle(e){const t=this.get(e);return"boolean"==typeof t&&this.set(e,!t),this}get(e){return this[e]}};function _s(e){return It().requestAnimationFrame(e)}function W1(e){return It().cancelAnimationFrame(e)}K1=0,Se=()=>K1++,ae=()=>{const e=Ze().createElement("canvas");if(!e||0[0]===e.getContext)throw new de("Failed to create `canvas` element");return e},Dr=()=>Ze().createElement("img"),K=e=>{const t=ae();return t.width=e.width,t.height=e.height,t},mo=(e,t,n)=>e.toDataURL("image/".concat(t),n),po=(e,t,n)=>new Promise((s)=>{e.toBlob(s,"image/".concat(t),n)}),x=e=>e*eo,he=e=>e/eo,Ar=e=>e.every((e,t)=>e===D[t]),M=(e,t,n)=>new o(e).transform(t,n),$=e=>{const t=1/(e[0]*e[3]-e[1]*e[2]),n=[t*e[3],-t*e[1],-t*e[2],t*e[0],0,0],{x:s,y:i}=new o(e[4],e[5]).transform(n,!0);return n[4]=-s,n[5]=-i,n},O=(e,t,n)=>[e[0]*t[0]+e[2]*t[1],e[1]*t[0]+e[3]*t[1],e[0]*t[2]+e[2]*t[3],e[1]*t[2]+e[3]*t[3],n?0:e[0]*t[4]+e[2]*t[5]+e[4],n?0:e[1]*t[4]+e[3]*t[5]+e[5]],bs=(e,t)=>e.reduceRight((e,n)=>n&&e?O(n,e,t):n||e,0[0])||D.concat(),kr=e=>{let[t,n]=e;return Math.atan2(n,t)},vt=e=>{const s=kr(e),t=e[0]**2+e[1]**2,n=Math.sqrt(t),o=(e[0]*e[3]-e[2]*e[1])/n,i=Math.atan2(e[0]*e[2]+e[1]*e[3],t);return{angle:he(s),scaleX:n,scaleY:o,skewX:he(i),skewY:0,translateX:e[4]||0,translateY:e[5]||0}},ht=function(e){return[1,0,0,1,e,arguments.length>1&&0[0]!==arguments[1]?arguments[1]:0]};function lt(){let{angle:i=0}=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{},{x:e=0,y:t=0}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};const o=x(i),n=se(o),s=Z(o);return[n,s,-s,n,e?e-(n*e-s*t):0,t?t-(s*e+n*t):0]}gs=function(e){return[e,0,0,arguments.length>1&&0[0]!==arguments[1]?arguments[1]:e,0,0]},Er=e=>Math.tan(x(e)),jo=e=>[1,0,Er(e),1,0,0],yo=e=>[1,Er(e),0,1,0,0],bn=e=>{let{scaleX:n=1,scaleY:s=1,flipX:a=!1,flipY:r=!1,skewX:o=0,skewY:i=0}=e,t=gs(a?-n:n,r?-s:s);return o&&(t=O(t,jo(o),!0)),i&&(t=O(t,yo(i),!0)),t},wr=e=>{const{translateX:o=0,translateY:i=0,angle:n=0}=e;let t=ht(o,i);n&&(t=O(t,lt({angle:n})));const s=bn(e);return Ar(s)||(t=O(t,s)),t},gn=function(e){let{signal:t,crossOrigin:n=null}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};return new Promise(function(s,o){if(t&&t.aborted)return o(new uc("loadImage"));const i=Dr();let a;t&&(a=function(e){i.src="",o(e)},t.addEventListener("abort",a,{once:!0}));const r=function(){i.onload=i.onerror=null,a&&(t==null||t.removeEventListener("abort",a)),s(i)};e?(i.onload=r,i.onerror=function(){a&&(t==null||t.removeEventListener("abort",a)),o(new de("Error loading ".concat(i.src)))},n&&(i.crossOrigin=n),i.src=e):r()})},Je=function(e){let{signal:t,reviver:n=jt}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};return new Promise((s,o)=>{const i=[];t&&t.addEventListener("abort",o,{once:!0}),Promise.all(e.map(e=>c.getClass(e.type).fromObject(e,{signal:t}).then(t=>(n(e,t),i.push(t),t)))).then(s).catch(e=>{i.forEach(e=>{e.dispose&&e.dispose()}),o(e)}).finally(()=>{t&&t.removeEventListener("abort",o)})})},pn=function(e){let{signal:t}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};return new Promise((n,s)=>{const o=[];t&&t.addEventListener("abort",s,{once:!0});const i=Object.values(e).map(e=>e&&e.type&&c.has(e.type)?Je([e],{signal:t}).then(e=>{let[t]=e;return o.push(t),t}):e),a=Object.keys(e);Promise.all(i).then(e=>e.reduce((e,t,n)=>(e[a[n]]=t,e),{})).then(n).catch(e=>{o.forEach(e=>{e.dispose&&e.dispose()}),s(e)}).finally(()=>{t&&t.removeEventListener("abort",s)})})},qe=function(e){return(arguments.length>1&&0[0]!==arguments[1]?arguments[1]:[]).reduce((t,n)=>(n in e&&(t[n]=e[n]),t),{})},Oo=(e,t)=>Object.keys(e).reduce((n,s)=>(t(e[s],s,e)&&(n[s]=e[s]),n),{}),y=(e,t)=>parseFloat(Number(e).toFixed(t)),ot=e=>"matrix("+e.map(e=>y(e,b.NUM_FRACTION_DIGITS)).join(" ")+")",Y=e=>!!e&&0[0]!==e.toLive,fr=e=>!!e&&"function"==typeof e.toObject,hr=e=>!!e&&0[0]!==e.offsetX&&"source"in e,Ke=e=>!!e&&"multiSelectionStacking"in e;function F4(e){const n=e&&ne(e);let s=0,o=0;if(!e||!n)return{left:s,top:o};let t=e;const i=n.documentElement,a=n.body||{scrollLeft:0,scrollTop:0};for(;t&&(t.parentNode||t.host)&&(t=t.parentNode||t.host,t===n?(s=a.scrollLeft||i.scrollLeft||0,o=a.scrollTop||i.scrollTop||0):(s+=t.scrollLeft||0,o+=t.scrollTop||0),1!==t.nodeType||"fixed"!==t.style.position););return{left:s,top:o}}ne=e=>e.ownerDocument||null,ar=e=>{var t;return(null===(t=e.ownerDocument)||0[0]===t?0[0]:t.defaultView)||null},ir=function(e,t,n){let{width:o,height:i}=n,s=arguments.length>3&&0[0]!==arguments[3]?arguments[3]:1;e.width=o,e.height=i,s>1&&(e.setAttribute("width",(o*s).toString()),e.setAttribute("height",(i*s).toString()),t.scale(s,s))},Eo=(e,t)=>{let{width:n,height:s}=t;n&&(e.style.width="number"==typeof n?"".concat(n,"px"):n),s&&(e.style.height="number"==typeof s?"".concat(s,"px"):s)};function T4(e){return 0[0]!==e.onselectstart&&(e.onselectstart=()=>!1),e.style.userSelect=N,e}tr=class{constructor(e){s(this,"_originalCanvasStyle",0[0]),s(this,"lower",0[0]);const t=this.createLowerCanvas(e);this.lower={el:t,ctx:t.getContext("2d")}}createLowerCanvas(e){const t=(n=e)&&0[0]!==n.getContext?e:e&&Ze().getElementById(e)||ae();var n;if(t.hasAttribute("data-fabric"))throw new de("Trying to initialize a canvas that has already been initialized. Did you forget to dispose the canvas?");return this._originalCanvasStyle=t.style.cssText,t.setAttribute("data-fabric","main"),t.classList.add("lower-canvas"),t}cleanupDOM(e){let{width:n,height:s}=e;const{el:t}=this.lower;t.classList.remove("lower-canvas"),t.removeAttribute("data-fabric"),t.setAttribute("width","".concat(n)),t.setAttribute("height","".concat(s)),t.style.cssText=this._originalCanvasStyle||"",this._originalCanvasStyle=0[0]}setDimensions(e,t){const{el:n,ctx:s}=this.lower;ir(n,s,e,t)}setCSSDimensions(e){Eo(this.lower.el,e)}calcOffset(){return function(e){var s;const i=e&&ne(e),t={left:0,top:0};if(!i)return t;const n=(null===(s=ar(e))||0[0]===s?0[0]:s.getComputedStyle(e,null))||{};t.left+=parseInt(n.borderLeftWidth,10)||0,t.top+=parseInt(n.borderTopWidth,10)||0,t.left+=parseInt(n.paddingLeft,10)||0,t.top+=parseInt(n.paddingTop,10)||0;let o={left:0,top:0};const a=i.documentElement;0[0]!==e.getBoundingClientRect&&(o=e.getBoundingClientRect());const r=F4(e);return{left:o.left+r.left-(a.clientLeft||0)+t.left,top:o.top+r.top-(a.clientTop||0)+t.top}}(this.lower.el)}dispose(){ue().dispose(this.lower.el),delete this.lower}},z4={backgroundVpt:!0,backgroundColor:"",overlayVpt:!0,overlayColor:"",includeDefaultValues:!0,svgViewportTransformation:!0,renderOnAddRemove:!0,skipOffscreen:!0,enableRetinaScaling:!0,imageSmoothingEnabled:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,viewportTransform:[...D]},ko=class _se extends $1(Rr){get lowerCanvasEl(){var e;return null===(e=this.elements.lower)||0[0]===e?0[0]:e.el}get contextContainer(){var e;return null===(e=this.elements.lower)||0[0]===e?0[0]:e.ctx}static getDefaults(){return _se.ownDefaults}constructor(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};super(),Object.assign(this,this.constructor.getDefaults()),this.set(t),this.initElements(e),this._setDimensionsImpl({width:this.width||this.elements.lower.el.width||0,height:this.height||this.elements.lower.el.height||0}),this.skipControlsDrawing=!1,this.viewportTransform=[...this.viewportTransform],this.calcViewportBoundaries()}initElements(e){this.elements=new tr(e)}add(){const e=super.add(...arguments);return arguments.length>0&&this.renderOnAddRemove&&this.requestRenderAll(),e}insertAt(e){for(var n=arguments.length,s=new Array(n>1?n-1:0),t=1;t<n;t++)s[t-1]=arguments[t];const o=super.insertAt(e,...s);return s.length>0&&this.renderOnAddRemove&&this.requestRenderAll(),o}remove(){const e=super.remove(...arguments);return e.length>0&&this.renderOnAddRemove&&this.requestRenderAll(),e}_onObjectAdded(e){e.canvas&&e.canvas!==this&&(Ae("warn",`Canvas is trying to add an object that belongs to a different canvas.
Resulting to default behavior: removing object from previous canvas and adding to new canvas`),e.canvas.remove(e)),e._set("canvas",this),e.setCoords(),this.fire("object:added",{target:e}),e.fire("added",{target:this})}_onObjectRemoved(e){e._set("canvas",0[0]),this.fire("object:removed",{target:e}),e.fire("removed",{target:this})}_onStackOrderChanged(){this.renderOnAddRemove&&this.requestRenderAll()}getRetinaScaling(){return this.enableRetinaScaling?rc():1}calcOffset(){return this._offset=this.elements.calcOffset()}getWidth(){return this.width}getHeight(){return this.height}setWidth(e,t){return this.setDimensions({width:e},t)}setHeight(e,t){return this.setDimensions({height:e},t)}_setDimensionsImpl(e){let{cssOnly:t=!1,backstoreOnly:s=!1}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};if(!t){const t=n({width:this.width,height:this.height},e);this.elements.setDimensions(t,this.getRetinaScaling()),this.hasLostContext=!0,this.width=t.width,this.height=t.height}s||this.elements.setCSSDimensions(e),this.calcOffset()}setDimensions(e,t){this._setDimensionsImpl(e,t),t&&t.cssOnly||this.requestRenderAll()}getZoom(){return this.viewportTransform[0]}setViewportTransform(e){this.viewportTransform=e,this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll()}zoomToPoint(e,t){const s=e,n=[...this.viewportTransform],i=M(e,$(n));n[0]=t,n[3]=t;const o=M(i,n);n[4]+=s.x-o.x,n[5]+=s.y-o.y,this.setViewportTransform(n)}setZoom(e){this.zoomToPoint(new o(0,0),e)}absolutePan(e){const t=[...this.viewportTransform];return t[4]=-e.x,t[5]=-e.y,this.setViewportTransform(t)}relativePan(e){return this.absolutePan(new o(-e.x-this.viewportTransform[4],-e.y-this.viewportTransform[5]))}getElement(){return this.elements.lower.el}clearContext(e){e.clearRect(0,0,this.width,this.height)}getContext(){return this.elements.lower.ctx}clear(){this.remove(...this.getObjects()),this.backgroundImage=0[0],this.overlayImage=0[0],this.backgroundColor="",this.overlayColor="",this.clearContext(this.getContext()),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll()}renderAll(){this.cancelRequestedRender(),this.destroyed||this.renderCanvas(this.getContext(),this._objects)}renderAndReset(){this.nextRenderHandle=0,this.renderAll()}requestRenderAll(){this.nextRenderHandle||this.disposed||this.destroyed||(this.nextRenderHandle=_s(()=>this.renderAndReset()))}calcViewportBoundaries(){const a=this.width,r=this.height,n=$(this.viewportTransform),s=M({x:0,y:0},n),i=M({x:a,y:r},n),e=s.min(i),t=s.max(i);return this.vptCoords={tl:e,tr:new o(t.x,e.y),bl:new o(e.x,t.y),br:t}}cancelRequestedRender(){this.nextRenderHandle&&(W1(this.nextRenderHandle),this.nextRenderHandle=0)}drawControls(){}renderCanvas(e,t){if(this.destroyed)return;const n=this.viewportTransform,s=this.clipPath;this.calcViewportBoundaries(),this.clearContext(e),e.imageSmoothingEnabled=this.imageSmoothingEnabled,e.patternQuality="best",this.fire("before:render",{ctx:e}),this._renderBackground(e),e.save(),e.transform(n[0],n[1],n[2],n[3],n[4],n[5]),this._renderObjects(e,t),e.restore(),this.controlsAboveOverlay||this.skipControlsDrawing||this.drawControls(e),s&&(s._set("canvas",this),s.shouldCache(),s._transformDone=!0,s.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(e,s)),this._renderOverlay(e),this.controlsAboveOverlay&&!this.skipControlsDrawing&&this.drawControls(e),this.fire("after:render",{ctx:e}),this.__cleanupTask&&(this.__cleanupTask(),this.__cleanupTask=0[0])}drawClipPathOnCanvas(e,t){const n=this.viewportTransform;e.save(),e.transform(...n),e.globalCompositeOperation="destination-in",t.transform(e),e.scale(1/t.zoomX,1/t.zoomY),e.drawImage(t._cacheCanvas,-t.cacheTranslationX,-t.cacheTranslationY),e.restore()}_renderObjects(e,t){for(let n=0,s=t.length;n<s;++n)t[n]&&t[n].render(e)}_renderBackgroundOrOverlay(e,t){const n=this["".concat(t,"Color")],s=this["".concat(t,"Image")],i=this.viewportTransform,o=this["".concat(t,"Vpt")];if(!n&&!s)return;const a=Y(n);if(n){if(e.save(),e.beginPath(),e.moveTo(0,0),e.lineTo(this.width,0),e.lineTo(this.width,this.height),e.lineTo(0,this.height),e.closePath(),e.fillStyle=a?n.toLive(e):n,o&&e.transform(...i),a){e.transform(1,0,0,1,n.offsetX||0,n.offsetY||0);const t=n.gradientTransform||n.patternTransform;t&&e.transform(...t)}e.fill(),e.restore()}if(s){e.save();const{skipOffscreen:t}=this;this.skipOffscreen=o,o&&e.transform(...i),s.render(e),this.skipOffscreen=t,e.restore()}}_renderBackground(e){this._renderBackgroundOrOverlay(e,"background")}_renderOverlay(e){this._renderBackgroundOrOverlay(e,"overlay")}getCenter(){return{top:this.height/2,left:this.width/2}}getCenterPoint(){return new o(this.width/2,this.height/2)}centerObjectH(e){return this._centerObject(e,new o(this.getCenterPoint().x,e.getCenterPoint().y))}centerObjectV(e){return this._centerObject(e,new o(e.getCenterPoint().x,this.getCenterPoint().y))}centerObject(e){return this._centerObject(e,this.getCenterPoint())}viewportCenterObject(e){return this._centerObject(e,this.getVpCenter())}viewportCenterObjectH(e){return this._centerObject(e,new o(this.getVpCenter().x,e.getCenterPoint().y))}viewportCenterObjectV(e){return this._centerObject(e,new o(e.getCenterPoint().x,this.getVpCenter().y))}getVpCenter(){return M(this.getCenterPoint(),$(this.viewportTransform))}_centerObject(e,t){e.setXY(t,m,m),e.setCoords(),this.renderOnAddRemove&&this.requestRenderAll()}toDatalessJSON(e){return this.toDatalessObject(e)}toObject(e){return this._toObjectMethod("toObject",e)}toJSON(){return this.toObject()}toDatalessObject(e){return this._toObjectMethod("toDatalessObject",e)}_toObjectMethod(e,t){const s=this.clipPath,o=s&&!s.excludeFromExport?this._toObject(s,e,t):null;return n(n(n({version:Js},qe(this,t)),{},{objects:this._objects.filter(e=>!e.excludeFromExport).map(n=>this._toObject(n,e,t))},this.__serializeBgOverlay(e,t)),o?{clipPath:o}:null)}_toObject(e,t,n){let s;this.includeDefaultValues||(s=e.includeDefaultValues,e.includeDefaultValues=!1);const o=e[t](n);return this.includeDefaultValues||(e.includeDefaultValues=!!s),o}__serializeBgOverlay(e,t){const n={},i=this.backgroundImage,a=this.overlayImage,s=this.backgroundColor,o=this.overlayColor;return Y(s)?s.excludeFromExport||(n.background=s.toObject(t)):s&&(n.background=s),Y(o)?o.excludeFromExport||(n.overlay=o.toObject(t)):o&&(n.overlay=o),i&&!i.excludeFromExport&&(n.backgroundImage=this._toObject(i,e,t)),a&&!a.excludeFromExport&&(n.overlayImage=this._toObject(a,e,t)),n}toSVG(){let n=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:0[0];n.reviver=t;const e=[];return this._setSVGPreamble(e,n),this._setSVGHeader(e,n),this.clipPath&&e.push('<g clip-path="url(#'.concat(this.clipPath.clipPathId,`)" >
`)),this._setSVGBgOverlayColor(e,"background"),this._setSVGBgOverlayImage(e,"backgroundImage",t),this._setSVGObjects(e,t),this.clipPath&&e.push(`</g>
`),this._setSVGBgOverlayColor(e,"overlay"),this._setSVGBgOverlayImage(e,"overlayImage",t),e.push("</svg>"),e.join("")}_setSVGPreamble(e,t){t.suppressPreamble||e.push('<?xml version="1.0" encoding="',t.encoding||"UTF-8",`" standalone="no" ?>
`,'<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ',`"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
`)}_setSVGHeader(e,t){const i=t.width||"".concat(this.width),a=t.height||"".concat(this.height),s=b.NUM_FRACTION_DIGITS,n=t.viewBox;let o;if(n)o='viewBox="'.concat(n.x," ").concat(n.y," ").concat(n.width," ").concat(n.height,'" ');else if(this.svgViewportTransformation){const e=this.viewportTransform;o='viewBox="'.concat(y(-e[4]/e[0],s)," ").concat(y(-e[5]/e[3],s)," ").concat(y(this.width/e[0],s)," ").concat(y(this.height/e[3],s),'" ')}else o='viewBox="0 0 '.concat(this.width," ").concat(this.height,'" ');e.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',i,'" ','height="',a,'" ',o,`xml:space="preserve">
`,"<desc>Created with Fabric.js ",Js,`</desc>
`,`<defs>
`,this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(t),`</defs>
`)}createSVGClipPathMarkup(e){const t=this.clipPath;return t?(t.clipPathId="CLIPPATH_".concat(Se()),'<clipPath id="'.concat(t.clipPathId,`" >
`).concat(t.toClipPathSVG(e.reviver),`</clipPath>
`)):""}createSVGRefElementsMarkup(){return["background","overlay"].map(e=>{const t=this["".concat(e,"Color")];if(Y(t)){const n=this["".concat(e,"Vpt")],s=this.viewportTransform,o={isType:()=>!1,width:this.width/(n?s[0]:1),height:this.height/(n?s[3]:1)};return t.toSVG(o,{additionalTransform:n?ot(s):""})}}).join("")}createSVGFontFacesMarkup(){const n=[],e={},t=b.fontPaths;this._objects.forEach(function e(t){n.push(t),Os(t)&&t._objects.forEach(e)}),n.forEach(n=>{if(!(o=n)||"function"!=typeof o._renderText)return;var o;const{styles:i,fontFamily:s}=n;!e[s]&&t[s]&&(e[s]=!0,i&&Object.values(i).forEach(n=>{Object.values(n).forEach(n=>{let{fontFamily:s=""}=n;!e[s]&&t[s]&&(e[s]=!0)})}))});const s=Object.keys(e).map(e=>`		@font-face {
			font-family: '`.concat(e,`';
			src: url('`).concat(t[e],`');
		}
`)).join("");return s?`	<style type="text/css"><![CDATA[
`.concat(s,`]]></style>
`):""}_setSVGObjects(e,t){this.forEachObject(n=>{n.excludeFromExport||this._setSVGObject(e,n,t)})}_setSVGObject(e,t,n){e.push(t.toSVG(n))}_setSVGBgOverlayImage(e,t,n){const s=this[t];s&&!s.excludeFromExport&&s.toSVG&&e.push(s.toSVG(n))}_setSVGBgOverlayColor(e,t){const n=this["".concat(t,"Color")];if(n)if(Y(n)){const s=n.repeat||"",o=this.width,i=this.height,a=this["".concat(t,"Vpt")]?ot($(this.viewportTransform)):"";e.push('<rect transform="'.concat(a," translate(").concat(o/2,",").concat(i/2,')" x="').concat(n.offsetX-o/2,'" y="').concat(n.offsetY-i/2,'" width="').concat("repeat-y"!==s&&"no-repeat"!==s||!hr(n)?o:n.source.width,'" height="').concat("repeat-x"!==s&&"no-repeat"!==s||!hr(n)?i:n.source.height,'" fill="url(#SVGID_').concat(n.id,`)"></rect>
`))}else e.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',n,'"',`></rect>
`)}loadFromJSON(e,t){let{signal:n}=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:{};if(!e)return Promise.reject(new de("`json` is undefined"));const s="string"==typeof e?JSON.parse(e):e,{objects:o=[],backgroundImage:i,background:a,overlayImage:r,overlay:c,clipPath:l}=s,d=this.renderOnAddRemove;return this.renderOnAddRemove=!1,Promise.all([Je(o,{reviver:t,signal:n}),pn({backgroundImage:i,backgroundColor:a,overlayImage:r,overlayColor:c,clipPath:l},{signal:n})]).then(e=>{let[t,n]=e;return this.clear(),this.add(...t),this.set(s),this.set(n),this.renderOnAddRemove=d,this})}clone(e){const t=this.toObject(e);return this.cloneWithoutData().loadFromJSON(t)}cloneWithoutData(){const e=K(this);return new this.constructor(e)}toDataURL(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};const{format:t="png",quality:n=1,multiplier:s=1,enableRetinaScaling:o=!1}=e,i=s*(o?this.getRetinaScaling():1);return mo(this.toCanvasElement(i,e),t,n)}toBlob(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};const{format:t="png",quality:n=1,multiplier:s=1,enableRetinaScaling:o=!1}=e,i=s*(o?this.getRetinaScaling():1);return po(this.toCanvasElement(i,e),t,n)}toCanvasElement(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:1,{width:g,height:m,left:h,top:r,filter:i}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};const a=(g||this.width)*e,n=(m||this.height)*e,c=this.getZoom(),l=this.width,d=this.height,u=this.skipControlsDrawing,o=c*e,t=this.viewportTransform,f=[o,0,0,o,(t[4]-(h||0))*e,(t[5]-(r||0))*e],p=this.enableRetinaScaling,s=K({width:a,height:n}),v=i?this._objects.filter(e=>i(e)):this._objects;return this.enableRetinaScaling=!1,this.viewportTransform=f,this.width=a,this.height=n,this.skipControlsDrawing=!0,this.calcViewportBoundaries(),this.renderCanvas(s.getContext("2d"),v),this.viewportTransform=t,this.width=l,this.height=d,this.calcViewportBoundaries(),this.enableRetinaScaling=p,this.skipControlsDrawing=u,s}dispose(){return!this.disposed&&this.elements.cleanupDOM({width:this.width,height:this.height}),xs.cancelByCanvas(this),this.disposed=!0,new Promise((e,t)=>{const n=()=>{this.destroy(),e(!0)};n.kill=t,this.__cleanupTask&&this.__cleanupTask.kill("aborted"),this.destroyed?e(!1):this.nextRenderHandle?this.__cleanupTask=n:n()})}destroy(){this.destroyed=!0,this.cancelRequestedRender(),this.forEachObject(e=>e.dispose()),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose(),this.backgroundImage=0[0],this.overlayImage&&this.overlayImage.dispose(),this.overlayImage=0[0],this.elements.dispose()}toString(){return"#<Canvas (".concat(this.complexity(),"): { objects: ").concat(this._objects.length," }>")}},s(ko,"ownDefaults",z4),e0=["touchstart","touchmove","touchend"],Za=e=>{const t=F4(e.target),n=function(e){const t=e.changedTouches;return t&&t[0]?t[0]:e}(e);return new o(n.clientX+t.left,n.clientY+t.top)},Nn=e=>e0.includes(e.type)||"touch"===e.pointerType,Qa=e=>{e.preventDefault(),e.stopPropagation()},fe=e=>{let t=0,n=0,s=0,o=0;for(let i=0,c=e.length;i<c;i++){const{x:a,y:r}=e[i];(a>s||!i)&&(s=a),(a<t||!i)&&(t=a),(r>o||!i)&&(o=r),(r<n||!i)&&(n=r)}return{left:t,top:n,width:s-t,height:o-n}},n0=["translateX","translateY","scaleX","scaleY"],Xa=(e,t)=>Ct(e,O(t,e.calcOwnMatrix())),Ct=(e,t)=>{const n=vt(t),{translateX:s,translateY:i,scaleX:a,scaleY:r}=n,c=w(n,n0),l=new o(s,i);e.flipX=!1,e.flipY=!1,Object.assign(e,c),e.set({scaleX:a,scaleY:r}),e.setPositionByOrigin(l,m,m)},Ga=e=>{e.scaleX=1,e.scaleY=1,e.skewX=0,e.skewY=0,e.flipX=!1,e.flipY=!1,e.rotate(0)},Ao=e=>({scaleX:e.scaleX,scaleY:e.scaleY,skewX:e.skewX,skewY:e.skewY,angle:e.angle,left:e.left,flipX:e.flipX,flipY:e.flipY,top:e.top}),Jn=(e,t,n)=>{const s=e/2,i=t/2,r=[new o(-s,-i),new o(s,-i),new o(-s,i),new o(s,i)].map(e=>e.transform(n)),a=fe(r);return new o(a.width,a.height)},Mt=function(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:D;return O($(arguments.length>1&&0[0]!==arguments[1]?arguments[1]:D),e)},ye=function(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:D,n=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:D;return e.transform(Mt(t,n))},qa=function(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:D,n=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:D;return e.transform(Mt(t,n),!0)},So=(e,t,n)=>{const s=Mt(t,n);return Ct(e,O(s,e.calcOwnMatrix())),s},Fo=(e,t)=>{var s;const{transform:{target:o}}=t;null===(s=o.canvas)||0[0]===s||s.fire("object:".concat(e),n(n({},t),{},{target:o})),o.fire(e,t)},s0={left:-.5,top:-.5,center:0,bottom:.5,right:.5},E=e=>"string"==typeof e?s0[e]:e-.5,Xn="not-allowed";function i0(e){return E(e.originX)===E(m)&&E(e.originY)===E(m)}function X4(e){return.5-E(e)}J=(e,t)=>e[t],To=(e,t,n,s)=>({e,transform:t,pointer:new o(n,s)});function U4(e,t){const n=e.getTotalAngle()+he(Math.atan2(t.y,t.x))+360;return Math.round(n%360/45)}function Do(e,t,n,s,i){var l;let{target:c,corner:u}=e;const d=c.controls[u],h=(null===(l=c.canvas)||0[0]===l?0[0]:l.getZoom())||1,r=c.padding/h,a=function(e,t,n,s){const i=e.getRelativeCenterPoint(),a=0[0]!==n&&0[0]!==s?e.translateToGivenOrigin(i,m,m,n,s):new o(e.left,e.top);return(e.angle?t.rotate(-x(e.angle),i):t).subtract(a)}(c,new o(s,i),t,n);return a.x>=r&&(a.x-=r),a.x<=-r&&(a.x+=r),a.y>=r&&(a.y-=r),a.y<=r&&(a.y+=r),a.x-=d.offsetX,a.y-=d.offsetY,a}Ma=(e,t,n,s)=>{const{target:o,offsetX:l,offsetY:d}=t,r=n-l,c=s-d,i=!J(o,"lockMovementX")&&o.left!==r,a=!J(o,"lockMovementY")&&o.top!==c;return i&&o.set(j,r),a&&o.set(P,c),(i||a)&&Fo(Yr,To(e,t,n,s)),i||a},Sa={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#0FF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000",blanchedalmond:"#FFEBCD",blue:"#00F",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#0FF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#F0F",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#789",lightslategrey:"#789",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#0F0",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#F0F",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#639",red:"#F00",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFF",whitesmoke:"#F5F5F5",yellow:"#FF0",yellowgreen:"#9ACD32"},No=(e,t,n)=>(n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e),Ea=(e,t,n,s)=>{e/=255,t/=255,n/=255;const o=Math.max(e,t,n),a=Math.min(e,t,n);let i,r;const c=(o+a)/2;if(o===a)i=r=0;else{const s=o-a;switch(r=c>.5?s/(2-o-a):s/(o+a),o){case e:i=(t-n)/s+(t<n?6:0);break;case t:i=(n-e)/s+2;break;case n:i=(e-t)/s+4}i/=6}return[Math.round(360*i),Math.round(100*r),Math.round(100*c),s]},xa=function(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:"1";return parseFloat(e)/(e.endsWith("%")?100:1)},qn=e=>Math.min(Math.round(e),255).toString(16).toUpperCase().padStart(2,"0"),Oa=e=>{let[n,s,o,i=1]=e;const t=Math.round(.3*n+.59*s+.11*o);return[t,t,t,i]},U=class _Le{constructor(e){if(s(this,"isUnrecognised",!1),e)if(e instanceof _Le)this.setSource([...e._source]);else if(Array.isArray(e)){const[t,n,s,o=1]=e;this.setSource([t,n,s,o])}else this.setSource(this._tryParsingColor(e));else this.setSource([0,0,0,1])}_tryParsingColor(e){return(e=e.toLowerCase())in Sa&&(e=Sa[e]),"transparent"===e?[255,255,255,0]:_Le.sourceFromHex(e)||_Le.sourceFromRgb(e)||_Le.sourceFromHsl(e)||(this.isUnrecognised=!0)&&[0,0,0,1]}getSource(){return this._source}setSource(e){this._source=e}toRgb(){const[e,t,n]=this.getSource();return"rgb(".concat(e,",").concat(t,",").concat(n,")")}toRgba(){return"rgba(".concat(this.getSource().join(","),")")}toHsl(){const[e,t,n]=Ea(...this.getSource());return"hsl(".concat(e,",").concat(t,"%,").concat(n,"%)")}toHsla(){const[e,t,n,s]=Ea(...this.getSource());return"hsla(".concat(e,",").concat(t,"%,").concat(n,"%,").concat(s,")")}toHex(){return this.toHexa().slice(0,6)}toHexa(){const[e,t,n,s]=this.getSource();return"".concat(qn(e)).concat(qn(t)).concat(qn(n)).concat(qn(Math.round(255*s)))}getAlpha(){return this.getSource()[3]}setAlpha(e){return this._source[3]=e,this}toGrayscale(){return this.setSource(Oa(this.getSource())),this}toBlackWhite(e){const[n,,,s]=Oa(this.getSource()),t=n<(e||127)?0:255;return this.setSource([t,t,t,s]),this}overlayWith(e){e instanceof _Le||(e=new _Le(e));const t=this.getSource(),n=e.getSource(),[s,o,i]=t.map((e,t)=>Math.round(.5*e+.5*n[t]));return this.setSource([s,o,i,t[3]]),this}static fromRgb(e){return _Le.fromRgba(e)}static fromRgba(e){return new _Le(_Le.sourceFromRgb(e))}static sourceFromRgb(e){const t=e.match(/^rgba?\(\s*(\d{0,3}(?:\.\d+)?%?)\s*[\s|,]\s*(\d{0,3}(?:\.\d+)?%?)\s*[\s|,]\s*(\d{0,3}(?:\.\d+)?%?)\s*(?:\s*[,/]\s*(\d{0,3}(?:\.\d+)?%?)\s*)?\)$/i);if(t){const[e,n,s]=t.slice(1,4).map(e=>{const t=parseFloat(e);return e.endsWith("%")?Math.round(2.55*t):t});return[e,n,s,xa(t[4])]}}static fromHsl(e){return _Le.fromHsla(e)}static fromHsla(e){return new _Le(_Le.sourceFromHsl(e))}static sourceFromHsl(e){const n=e.match(/^hsla?\(\s*([+-]?\d{0,3}(?:\.\d+)?(?:deg|turn|rad)?)\s*[\s|,]\s*(\d{0,3}(?:\.\d+)?%?)\s*[\s|,]\s*(\d{0,3}(?:\.\d+)?%?)\s*(?:\s*[,/]\s*(\d*(?:\.\d+)?%?)\s*)?\)$/i);if(!n)return;const o=(_Le.parseAngletoDegrees(n[1])%360+360)%360/360,s=parseFloat(n[2])/100,t=parseFloat(n[3])/100;let i,a,r;if(0===s)i=a=r=t;else{const e=t<=.5?t*(s+1):t+s-t*s,n=2*t-e;i=No(n,e,o+1/3),a=No(n,e,o),r=No(n,e,o-1/3)}return[Math.round(255*i),Math.round(255*a),Math.round(255*r),xa(n[4])]}static fromHex(e){return new _Le(_Le.sourceFromHex(e))}static sourceFromHex(e){if(e.match(/^#?(([0-9a-f]){3,4}|([0-9a-f]{2}){3,4})$/i)){const t=e.slice(e.indexOf("#")+1);let n;n=t.length<=4?t.split("").map(e=>e+e):t.match(/.{2}/g);const[s,o,i,a=255]=n.map(e=>parseInt(e,16));return[s,o,i,a/255]}}static parseAngletoDegrees(e){const t=e.toLowerCase(),n=parseFloat(t);return t.includes("rad")?he(n):t.includes("turn")?360*n:n}},Pe=function(e){let o=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:to;const s=/\D{0,2}$/.exec(e),t=parseFloat(e),n=b.DPI;switch(s?.[0]){case"mm":return t*n/25.4;case"cm":return t*n/2.54;case"in":return t*n;case"pt":return t*n/72;case"pc":return t*n/72*12;case"em":return t*o;default:return t}},wa=e=>{const[n,s]=e.trim().split(" "),[o,i]=(t=n)&&t!==N?[t.slice(1,4),t.slice(5,8)]:t===N?[t,t]:["Mid","Mid"];var t;return{meetOrSlice:s||"meet",alignX:o,alignY:i}},Jt=function(e,t){let n,s,o=!(arguments.length>2&&0[0]!==arguments[2])||arguments[2];if(t)if(t.toLive)n="url(#SVGID_".concat(t.id,")");else{const e=new U(t),o=e.getAlpha();n=e.toRgb(),1!==o&&(s=o.toString())}else n="none";return o?"".concat(e,": ").concat(n,"; ").concat(s?"".concat(e,"-opacity: ").concat(s,"; "):""):"".concat(e,'="').concat(n,'" ').concat(s?"".concat(e,'-opacity="').concat(s,'" '):"")},ya=class{getSvgStyles(e){const t=this.fillRule?this.fillRule:"nonzero",n=this.strokeWidth?this.strokeWidth:"0",s=this.strokeDashArray?this.strokeDashArray.join(" "):N,o=this.strokeDashOffset?this.strokeDashOffset:"0",i=this.strokeLineCap?this.strokeLineCap:"butt",a=this.strokeLineJoin?this.strokeLineJoin:"miter",r=this.strokeMiterLimit?this.strokeMiterLimit:"4",c=0[0]!==this.opacity?this.opacity:"1",l=this.visible?"":" visibility: hidden;",d=e?"":this.getSvgFilter(),u=Jt(A,this.fill);return[Jt(R,this.stroke),"stroke-width: ",n,"; ","stroke-dasharray: ",s,"; ","stroke-linecap: ",i,"; ","stroke-dashoffset: ",o,"; ","stroke-linejoin: ",a,"; ","stroke-miterlimit: ",r,"; ",u,"fill-rule: ",t,"; ","opacity: ",c,";",d,l].join("")}getSvgFilter(){return this.shadow?"filter: url(#SVGID_".concat(this.shadow.id,");"):""}getSvgCommons(){return[this.id?'id="'.concat(this.id,'" '):"",this.clipPath?'clip-path="url(#'.concat(this.clipPath.clipPathId,')" '):""].join("")}getSvgTransform(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:"";const n=e?this.calcTransformMatrix():this.calcOwnMatrix(),s='transform="'.concat(ot(n));return"".concat(s).concat(t,'" ')}_toSVG(){return[""]}toSVG(e){return this._createBaseSVGMarkup(this._toSVG(e),{reviver:e})}toClipPathSVG(e){return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(e),{reviver:e})}_createBaseClipPathSVGMarkup(e){let{reviver:t,additionalTransform:n=""}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};const s=[this.getSvgTransform(!0,n),this.getSvgCommons()].join(""),o=e.indexOf("COMMON_PARTS");return e[o]=s,t?t(e.join("")):e.join("")}_createBaseSVGMarkup(e){let{noStyle:r,reviver:o,withShadow:h,additionalTransform:c}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};const f=r?"":'style="'.concat(this.getSvgStyles(),'" '),a=h?'style="'.concat(this.getSvgFilter(),'" '):"",n=this.clipPath,m=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",s=n&&n.absolutePositioned,i=this.stroke,l=this.fill,d=this.shadow,t=[],p=e.indexOf("COMMON_PARTS");let u;n&&(n.clipPathId="CLIPPATH_".concat(Se()),u='<clipPath id="'.concat(n.clipPathId,`" >
`).concat(n.toClipPathSVG(o),`</clipPath>
`)),s&&t.push("<g ",a,this.getSvgCommons(),` >
`),t.push("<g ",this.getSvgTransform(!1),s?"":a+this.getSvgCommons(),` >
`);const g=[f,m,r?"":this.addPaintOrder()," ",c?'transform="'.concat(c,'" '):""].join("");return e[p]=g,Y(l)&&t.push(l.toSVG(this)),Y(i)&&t.push(i.toSVG(this)),d&&t.push(d.toSVG(this)),n&&t.push(u),t.push(e.join("")),t.push(`</g>
`),s&&t.push(`</g>
`),o?o(t.join("")):t.join("")}addPaintOrder(){return this.paintFirst!==A?' paint-order="'.concat(this.paintFirst,'" '):""}};function Ro(e){return new RegExp("^("+e.join("|")+")\\b","i")}Ue="textDecorationThickness",ba=["fontSize","fontWeight","fontFamily","fontStyle"],va=["underline","overline","linethrough"],pa=[...ba,"lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide","pathAlign"],vi=[...pa,...va,"textBackgroundColor","direction",Ue],$4=[...ba,...va,R,"strokeWidth",A,"deltaY","textBackgroundColor",Ue],V4={_reNewline:ro,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:j,fontStyle:"normal",lineHeight:1.16,textBackgroundColor:"",stroke:null,shadow:null,path:0[0],pathStartOffset:0,pathSide:j,pathAlign:"baseline",charSpacing:0,deltaY:0,direction:"ltr",CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.28167,overline:-.81333},_fontSizeMult:1.13,[Ue]:66.667},ie="justify",$n="justify-left",hn="justify-right",mn="justify-center",te=String.raw(P4||(P4=we(["[-+]?(?:d*.d+|d+.?)(?:[eE][-+]?d+)?"],["[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?"]))),Ko=String.raw(R4||(R4=we(["(?:s*,?s+|s*,s*)"],["(?:\\s*,?\\s+|\\s*,\\s*)"]))),N4=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+te+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+te+"))?\\s+(.*)"),D4={cx:j,x:j,r:"radius",cy:P,y:P,display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing","text-decoration-thickness":Ue},qo="font-size",Go="clip-path",O0=Ro(["path","circle","polygon","polyline","ellipse","rect","line","image","text"]),x0=Ro(["symbol","image","marker","pattern","view","svg"]),Zi=Ro(["symbol","g","a","svg","clipPath","defs"]),E0=new RegExp(String.raw(L4||(L4=we(["^s*(",")","(",")","(",")","(",")s*$"],["^\\s*(",")","(",")","(",")","(",")\\s*$"])),te,Ko,te,Ko,te,Ko,te)),M4=new o(1,0),Gi=new o,si=(e,t)=>e.rotate(t),Bn=(e,t)=>new o(t).subtract(e),In=e=>e.distanceFrom(Gi),Hn=(e,t)=>Math.atan2(xt(e,t),$i(e,t)),qi=e=>Hn(M4,e),Pn=e=>e.eq(Gi)?e:e.scalarDivide(In(e)),oi=function(e){let t=!(arguments.length>1&&0[0]!==arguments[1])||arguments[1];return Pn(new o(-e.y,e.x).scalarMultiply(t?1:-1))},xt=(e,t)=>e.x*t.y-e.y*t.x,$i=(e,t)=>e.x*t.x+e.y*t.y,ai=(e,t,n)=>{if(e.eq(t)||e.eq(n))return!0;const i=xt(t,n),s=xt(t,e),o=xt(n,e);return i>=0?s>=0&&o<=0:!(s<=0&&o>=0)},Ii="(-?\\d+(?:\\.\\d*)?(?:px)?(?:\\s?|$))?",Ri=new RegExp("(?:\\s|^)"+Ii+Ii+"("+te+"?(?:px)?)?(?:\\s?|$)(?:$|\\s)"),Mn=class _Os{constructor(e){const t="string"==typeof e?_Os.parseShadow(e):e;Object.assign(this,_Os.ownDefaults,t),this.id=Se()}static parseShadow(e){const t=e.trim(),[,n=0,s=0,o=0]=(Ri.exec(t)||[]).map(e=>parseFloat(e)||0);return{color:(t.replace(Ri,"")||"rgb(0,0,0)").trim(),offsetX:n,offsetY:s,blur:o}}toString(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")}toSVG(e){const t=si(new o(this.offsetX,this.offsetY),x(-e.angle)),i=new U(this.color);let n=40,s=40;return e.width&&e.height&&(n=100*y((Math.abs(t.x)+this.blur)/e.width,b.NUM_FRACTION_DIGITS)+20,s=100*y((Math.abs(t.y)+this.blur)/e.height,b.NUM_FRACTION_DIGITS)+20),e.flipX&&(t.x*=-1),e.flipY&&(t.y*=-1),'<filter id="SVGID_'.concat(this.id,'" y="-').concat(s,'%" height="').concat(100+2*s,'%" x="-').concat(n,'%" width="').concat(100+2*n,`%" >
	<feGaussianBlur in="SourceAlpha" stdDeviation="`).concat(y(this.blur?this.blur/2:0,b.NUM_FRACTION_DIGITS),`"></feGaussianBlur>
	<feOffset dx="`).concat(y(t.x,b.NUM_FRACTION_DIGITS),'" dy="').concat(y(t.y,b.NUM_FRACTION_DIGITS),`" result="oBlur" ></feOffset>
	<feFlood flood-color="`).concat(i.toRgb(),'" flood-opacity="').concat(i.getAlpha(),`"/>
	<feComposite in2="oBlur" operator="in" />
	<feMerge>
		<feMergeNode></feMergeNode>
		<feMergeNode in="SourceGraphic"></feMergeNode>
	</feMerge>
</filter>
`)}toObject(){const e={color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling,type:this.constructor.type},t=_Os.ownDefaults;return this.includeDefaultValues?e:Oo(e,(e,n)=>e!==t[n])}static async fromObject(e){return new this(e)}},s(Mn,"ownDefaults",{color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1}),s(Mn,"type","shadow"),c.setClass(Mn,"shadow"),Xe=(e,t,n)=>Math.max(e,Math.min(t,n)),S4=[P,j,F,B,"flipX","flipY","originX","originY","angle","opacity","globalCompositeOperation","shadow","visible",rt,Ot],_e=[A,R,"strokeWidth","strokeDashArray","width","height","paintFirst","strokeUniform","strokeLineCap","strokeDashOffset","strokeLineJoin","strokeMiterLimit","backgroundColor","clipPath"],A4={top:0,left:0,width:0,height:0,angle:0,flipX:!1,flipY:!1,scaleX:1,scaleY:1,minScaleLimit:0,skewX:0,skewY:0,originX:j,originY:P,strokeWidth:1,strokeUniform:!1,padding:0,opacity:1,paintFirst:A,fill:"rgb(0,0,0)",fillRule:"nonzero",stroke:null,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,globalCompositeOperation:"source-over",backgroundColor:"",shadow:null,visible:!0,includeDefaultValues:!0,excludeFromExport:!1,objectCaching:!0,clipPath:0[0],inverted:!1,absolutePositioned:!1,centeredRotation:!0,centeredScaling:!1,dirty:!0},di=(e,t,n,s)=>(e<Math.abs(t)?(e=t,s=n/4):s=0===t&&0===e?n/je*Math.asin(1):n/je*Math.asin(t/e),{a:e,c:t,p:n,s}),Si=(e,t,n,s,o)=>e*2**(10*(s-=1))*Math.sin((s*o-t)*je/n),ki=(e,t,n,s)=>-n*Math.cos(e/s*Fe)+n+t,gi=(e,t,n,s)=>(e/=s)<1/2.75?n*(7.5625*e*e)+t:e<2/2.75?n*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?n*(7.5625*(e-=2.25/2.75)*e+.9375)+t:n*(7.5625*(e-=2.625/2.75)*e+.984375)+t,Ci=(e,t,n,s)=>n-gi(s-e,0,n,s)+t,k4=Object.freeze({__proto__:null,defaultEasing:ki,easeInBack:function(e,t,n,s){let o=arguments.length>4&&0[0]!==arguments[4]?arguments[4]:1.70158;return n*(e/=s)*e*((o+1)*e-o)+t},easeInBounce:Ci,easeInCirc:(e,t,n,s)=>-n*(Math.sqrt(1-(e/=s)*e)-1)+t,easeInCubic:(e,t,n,s)=>n*(e/s)**3+t,easeInElastic:(e,t,n,s)=>{const i=n;let o=0;if(0===e)return t;if(1===(e/=s))return t+n;o||(o=.3*s);const{a,s:r,p:c}=di(i,n,o,1.70158);return-Si(a,r,c,e,s)+t},easeInExpo:(e,t,n,s)=>0===e?t:n*2**(10*(e/s-1))+t,easeInOutBack:function(e,t,n,s){let o=arguments.length>4&&0[0]!==arguments[4]?arguments[4]:1.70158;return(e/=s/2)<1?n/2*(e*e*((1+(o*=1.525))*e-o))+t:n/2*((e-=2)*e*((1+(o*=1.525))*e+o)+2)+t},easeInOutBounce:(e,t,n,s)=>e<s/2?.5*Ci(2*e,0,n,s)+t:.5*gi(2*e-s,0,n,s)+.5*n+t,easeInOutCirc:(e,t,n,s)=>(e/=s/2)<1?-n/2*(Math.sqrt(1-e**2)-1)+t:n/2*(Math.sqrt(1-(e-=2)*e)+1)+t,easeInOutCubic:(e,t,n,s)=>(e/=s/2)<1?n/2*e**3+t:n/2*((e-2)**3+2)+t,easeInOutElastic:(e,t,n,s)=>{const c=n;let o=0;if(0===e)return t;if(2===(e/=s/2))return t+n;o||(o=s*(.3*1.5));const{a:i,s:a,p:r,c:l}=di(c,n,o,1.70158);return e<1?-.5*Si(i,a,r,e,s)+t:i*2**(-10*(e-=1))*Math.sin((e*s-a)*je/r)*.5+l+t},easeInOutExpo:(e,t,n,s)=>0===e?t:e===s?t+n:(e/=s/2)<1?n/2*2**(10*(e-1))+t:n/2*-(2**(-10*--e)+2)+t,easeInOutQuad:(e,t,n,s)=>(e/=s/2)<1?n/2*e**2+t:-n/2*(--e*(e-2)-1)+t,easeInOutQuart:(e,t,n,s)=>(e/=s/2)<1?n/2*e**4+t:-n/2*((e-=2)*e**3-2)+t,easeInOutQuint:(e,t,n,s)=>(e/=s/2)<1?n/2*e**5+t:n/2*((e-2)**5+2)+t,easeInOutSine:(e,t,n,s)=>-n/2*(Math.cos(Math.PI*e/s)-1)+t,easeInQuad:(e,t,n,s)=>n*(e/=s)*e+t,easeInQuart:(e,t,n,s)=>n*(e/=s)*e**3+t,easeInQuint:(e,t,n,s)=>n*(e/s)**5+t,easeInSine:(e,t,n,s)=>-n*Math.cos(e/s*Fe)+n+t,easeOutBack:function(e,t,n,s){let o=arguments.length>4&&0[0]!==arguments[4]?arguments[4]:1.70158;return n*((e=e/s-1)*e*((o+1)*e+o)+1)+t},easeOutBounce:gi,easeOutCirc:(e,t,n,s)=>n*Math.sqrt(1-(e=e/s-1)*e)+t,easeOutCubic:(e,t,n,s)=>n*((e/s-1)**3+1)+t,easeOutElastic:(e,t,n,s)=>{const i=n;let o=0;if(0===e)return t;if(1===(e/=s))return t+n;o||(o=.3*s);const{a,s:r,p:c,c:l}=di(i,n,o,1.70158);return a*2**(-10*e)*Math.sin((e*s-r)*je/c)+l+t},easeOutExpo:(e,t,n,s)=>e===s?t+n:n*-(2**(-10*e/s)+1)+t,easeOutQuad:(e,t,n,s)=>-n*(e/=s)*(e-2)+t,easeOutQuart:(e,t,n,s)=>-n*((e=e/s-1)*e**3-1)+t,easeOutQuint:(e,t,n,s)=>n*((e/s-1)**5+1)+t,easeOutSine:(e,t,n,s)=>n*Math.sin(e/s*Fe)+t}),E4=()=>!1,mi=class{constructor(e){let{startValue:t,byValue:n,duration:o=500,delay:i=0,easing:a=ki,onStart:r=jt,onChange:c=jt,onComplete:l=jt,abort:d=E4,target:u}=e;s(this,"_state","pending"),s(this,"durationProgress",0),s(this,"valueProgress",0),this.tick=this.tick.bind(this),this.duration=o,this.delay=i,this.easing=a,this._onStart=r,this._onChange=c,this._onComplete=l,this._abort=d,this.target=u,this.startValue=t,this.byValue=n,this.value=this.startValue,this.endValue=Object.freeze(this.calculate(this.duration).value)}get state(){return this._state}isDone(){return"aborted"===this._state||"completed"===this._state}start(){const e=e=>{"pending"===this._state&&(this.startTime=e||+new Date,this._state="running",this._onStart(),this.tick(this.startTime))};this.register(),this.delay>0?setTimeout(()=>_s(e),this.delay):_s(e)}tick(e){const t=(e||+new Date)-this.startTime,n=Math.min(t,this.duration);this.durationProgress=n/this.duration;const{value:s,valueProgress:o}=this.calculate(n);this.value=Object.freeze(s),this.valueProgress=o,"aborted"!==this._state&&(this._abort(this.value,this.valueProgress,this.durationProgress)?(this._state="aborted",this.unregister()):t>=this.duration?(this.durationProgress=this.valueProgress=1,this._onChange(this.endValue,this.valueProgress,this.durationProgress),this._state="completed",this._onComplete(this.endValue,this.valueProgress,this.durationProgress),this.unregister()):(this._onChange(this.value,this.valueProgress,this.durationProgress),_s(this.tick)))}register(){xs.push(this)}unregister(){xs.remove(this)}abort(){this._state="aborted",this.unregister()}},C4=["startValue","endValue"],x4=class extends mi{constructor(e){let{startValue:t=0,endValue:s=100}=e;super(n(n({},w(e,C4)),{},{startValue:t,byValue:s-t}))}calculate(e){const t=this.easing(e,this.startValue,this.byValue,this.duration);return{value:t,valueProgress:Math.abs((t-this.startValue)/this.byValue)}}},O4=["startValue","endValue"],y4=class extends mi{constructor(e){let{startValue:t=[0],endValue:s=[100]}=e;super(n(n({},w(e,O4)),{},{startValue:t,byValue:s.map((e,n)=>e-t[n])}))}calculate(e){const t=this.startValue.map((t,n)=>this.easing(e,t,this.byValue[n],this.duration,n));return{value:t,valueProgress:Math.abs((t[0]-this.startValue[0])/this.byValue[0])}}},Hc=["startValue","endValue","easing","onChange","onComplete","abort"],b4=(e,t,n,s)=>t+n*(1-Math.cos(e/s*Fe)),ii=e=>e&&((t,n,s)=>e(new U(t).toRgba(),n,s)),g4=class extends mi{constructor(e){let{startValue:s,endValue:o,easing:i=b4,onChange:a,onComplete:r,abort:c}=e,l=w(e,Hc);const t=new U(s).getSource(),d=new U(o).getSource();super(n(n({},l),{},{startValue:t,byValue:d.map((e,n)=>e-t[n]),easing:i,onChange:ii(a),onComplete:ii(r),abort:ii(c)}))}calculate(e){const[n,s,o,i]=this.startValue.map((t,n)=>this.easing(e,t,this.byValue[n],this.duration,n)),t=[...[n,s,o].map(Math.round),Xe(0,i,1)];return{value:t,valueProgress:t.map((e,t)=>0!==this.byValue[t]?Math.abs((e-this.startValue[t])/this.byValue[t]):0).find(e=>0!==e)||0}}};function oa(e){const t=(e=>Array.isArray(e.startValue)||Array.isArray(e.endValue))(e)?new y4(e):new x4(e);return t.start(),t}function m4(e){const t=new g4(e);return t.start(),t}Kt=class _Ks{constructor(e){this.status=e,this.points=[]}includes(e){return this.points.some(t=>t.eq(e))}append(){for(var t=arguments.length,n=new Array(t),e=0;e<t;e++)n[e]=arguments[e];return this.points=this.points.concat(n.filter(e=>!this.includes(e))),this}static isPointContained(e,t,n){let s=arguments.length>3&&0[0]!==arguments[3]&&arguments[3];if(t.eq(n))return e.eq(t);if(t.x===n.x)return e.x===t.x&&(s||e.y>=Math.min(t.y,n.y)&&e.y<=Math.max(t.y,n.y));if(t.y===n.y)return e.y===t.y&&(s||e.x>=Math.min(t.x,n.x)&&e.x<=Math.max(t.x,n.x));{const i=Bn(t,n),o=Bn(t,e).divide(i);return s?Math.abs(o.x)===Math.abs(o.y):o.x===o.y&&o.x>=0&&o.x<=1}}static isPointInPolygon(e,t){const s=new o(e).setX(Math.min(e.x-1,...t.map(e=>e.x)));let n=0;for(let o=0;o<t.length;o++){const i=this.intersectSegmentSegment(t[o],t[(o+1)%t.length],e,s);if(i.includes(e))return!0;n+=Number("Intersection"===i.status)}return n%2==1}static intersectLineLine(e,t,n,s){let c=!(arguments.length>4&&0[0]!==arguments[4])||arguments[4],l=!(arguments.length>5&&0[0]!==arguments[5])||arguments[5];const i=t.x-e.x,a=t.y-e.y,d=s.x-n.x,u=s.y-n.y,h=e.x-n.x,m=e.y-n.y,f=d*m-u*h,p=i*m-a*h,r=u*i-d*a;if(0!==r){const t=f/r,n=p/r;return(c||0<=t&&t<=1)&&(l||0<=n&&n<=1)?new _Ks("Intersection").append(new o(e.x+t*i,e.y+t*a)):new _Ks}if(0===f||0===p){const o=c||l||_Ks.isPointContained(e,n,s)||_Ks.isPointContained(t,n,s)||_Ks.isPointContained(n,e,t)||_Ks.isPointContained(s,e,t);return new _Ks(o?"Coincident":0[0])}return new _Ks("Parallel")}static intersectSegmentLine(e,t,n,s){return _Ks.intersectLineLine(e,t,n,s,!1,!0)}static intersectSegmentSegment(e,t,n,s){return _Ks.intersectLineLine(e,t,n,s,!1,!1)}static intersectLinePolygon(e,t,n){let i=!(arguments.length>3&&0[0]!==arguments[3])||arguments[3];const s=new _Ks,o=n.length;for(let c,l,a,r=0;r<o;r++){if(c=n[r],l=n[(r+1)%o],a=_Ks.intersectLineLine(e,t,c,l,i,!1),"Coincident"===a.status)return a;s.append(...a.points)}return s.points.length>0&&(s.status="Intersection"),s}static intersectSegmentPolygon(e,t,n){return _Ks.intersectLinePolygon(e,t,n,!1)}static intersectPolygonPolygon(e,t){const n=new _Ks,o=e.length,s=[];for(let i=0;i<o;i++){const r=e[i],c=e[(i+1)%o],a=_Ks.intersectSegmentPolygon(r,c,t);"Coincident"===a.status?(s.push(a),n.append(r,c)):n.append(...a.points)}return s.length>0&&s.length===e.length?new _Ks("Coincident"):(n.points.length>0&&(n.status="Intersection"),n)}static intersectPolygonRectangle(e,t,n){const s=t.min(n),i=t.max(n),a=new o(i.x,s.y),r=new o(s.x,i.y);return _Ks.intersectPolygonPolygon(e,[s,a,i,r])}},u4=class extends Rr{getX(){return this.getXY().x}setX(e){this.setXY(this.getXY().setX(e))}getY(){return this.getXY().y}setY(e){this.setXY(this.getXY().setY(e))}getRelativeX(){return this.left}setRelativeX(e){this.left=e}getRelativeY(){return this.top}setRelativeY(e){this.top=e}getXY(){const e=this.getRelativeXY();return this.group?M(e,this.group.calcTransformMatrix()):e}setXY(e,t,n){this.group&&(e=M(e,$(this.group.calcTransformMatrix()))),this.setRelativeXY(e,t,n)}getRelativeXY(){return new o(this.left,this.top)}setRelativeXY(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:this.originX,n=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:this.originY;this.setPositionByOrigin(e,t,n)}isStrokeAccountedForInDimensions(){return!1}getCoords(){const{tl:t,tr:n,br:s,bl:o}=this.aCoords||(this.aCoords=this.calcACoords()),e=[t,n,s,o];if(this.group){const t=this.group.calcTransformMatrix();return e.map(e=>M(e,t))}return e}intersectsWithRect(e,t){return"Intersection"===Kt.intersectPolygonRectangle(this.getCoords(),e,t).status}intersectsWithObject(e){const t=Kt.intersectPolygonPolygon(this.getCoords(),e.getCoords());return"Intersection"===t.status||"Coincident"===t.status||e.isContainedWithinObject(this)||this.isContainedWithinObject(e)}isContainedWithinObject(e){return this.getCoords().every(t=>e.containsPoint(t))}isContainedWithinRect(e,t){const{left:n,top:s,width:o,height:i}=this.getBoundingRect();return n>=e.x&&n+o<=t.x&&s>=e.y&&s+i<=t.y}isOverlapping(e){return this.intersectsWithObject(e)||this.isContainedWithinObject(e)||e.isContainedWithinObject(this)}containsPoint(e){return Kt.isPointInPolygon(e,this.getCoords())}isOnScreen(){if(!this.canvas)return!1;const{tl:e,br:t}=this.canvas.vptCoords;return!!this.getCoords().some(n=>n.x<=t.x&&n.x>=e.x&&n.y<=t.y&&n.y>=e.y)||!!this.intersectsWithRect(e,t)||this.containsPoint(e.midPointFrom(t))}isPartiallyOnScreen(){if(!this.canvas)return!1;const{tl:e,br:t}=this.canvas.vptCoords;return!!this.intersectsWithRect(e,t)||this.getCoords().every(n=>(n.x>=t.x||n.x<=e.x)&&(n.y>=t.y||n.y<=e.y))&&this.containsPoint(e.midPointFrom(t))}getBoundingRect(){return fe(this.getCoords())}getScaledWidth(){return this._getTransformedDimensions().x}getScaledHeight(){return this._getTransformedDimensions().y}scale(e){this._set(F,e),this._set(B,e),this.setCoords()}scaleToWidth(e){const t=this.getBoundingRect().width/this.getScaledWidth();return this.scale(e/this.width/t)}scaleToHeight(e){const t=this.getBoundingRect().height/this.getScaledHeight();return this.scale(e/this.height/t)}getCanvasRetinaScaling(){var e;return(null===(e=this.canvas)||0[0]===e?0[0]:e.getRetinaScaling())||1}getTotalAngle(){return this.group?he(kr(this.calcTransformMatrix())):this.angle}getViewportTransform(){var e;return(null===(e=this.canvas)||0[0]===e?0[0]:e.viewportTransform)||D.concat()}calcACoords(){const o=lt({angle:this.angle}),{x:i,y:a}=this.getRelativeCenterPoint(),r=ht(i,a),e=O(r,o),s=this._getTransformedDimensions(),t=s.x/2,n=s.y/2;return{tl:M({x:-t,y:-n},e),tr:M({x:t,y:-n},e),bl:M({x:-t,y:n},e),br:M({x:t,y:n},e)}}setCoords(){this.aCoords=this.calcACoords()}transformMatrixKey(){let t=arguments.length>0&&0[0]!==arguments[0]&&arguments[0],e=[];return!t&&this.group&&(e=this.group.transformMatrixKey(t)),e.push(this.top,this.left,this.width,this.height,this.scaleX,this.scaleY,this.angle,this.strokeWidth,this.skewX,this.skewY,+this.flipX,+this.flipY,E(this.originX),E(this.originY)),e}calcTransformMatrix(){let n=arguments.length>0&&0[0]!==arguments[0]&&arguments[0],e=this.calcOwnMatrix();if(n||!this.group)return e;const s=this.transformMatrixKey(n),t=this.matrixCache;return t&&t.key.every((e,t)=>e===s[t])?t.value:(this.group&&(e=O(this.group.calcTransformMatrix(!1),e)),this.matrixCache={key:s,value:e},e)}calcOwnMatrix(){const t=this.transformMatrixKey(!0),e=this.ownMatrixCache;if(e&&e.key===t)return e.value;const n=this.getRelativeCenterPoint(),o={angle:this.angle,translateX:n.x,translateY:n.y,scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY},s=wr(o);return this.ownMatrixCache={key:t,value:s},s}_getNonTransformedDimensions(){return new o(this.width,this.height).scalarAdd(this.strokeWidth)}_calculateCurrentDimensions(e){return this._getTransformedDimensions(e).transform(this.getViewportTransform(),!0).scalarAdd(2*this.padding)}_getTransformedDimensions(){let l=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};const e=n({scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,width:this.width,height:this.height,strokeWidth:this.strokeWidth},l),s=e.strokeWidth;let t=s,i=0;this.strokeUniform&&(t=0,i=s);const a=e.width+t,r=e.height+t;let c;return c=0===e.skewX&&0===e.skewY?new o(a*e.scaleX,r*e.scaleY):Jn(a,r,bn(e)),c.scalarAdd(i)}translateToGivenOrigin(e,t,n,s,i){let a=e.x,r=e.y;const c=E(s)-E(t),l=E(i)-E(n);if(c||l){const e=this._getTransformedDimensions();a+=c*e.x,r+=l*e.y}return new o(a,r)}translateToCenterPoint(e,t,n){if(t===m&&n===m)return e;const s=this.translateToGivenOrigin(e,t,n,m,m);return this.angle?s.rotate(x(this.angle),e):s}translateToOriginPoint(e,t,n){const s=this.translateToGivenOrigin(e,m,m,t,n);return this.angle?s.rotate(x(this.angle),e):s}getCenterPoint(){const e=this.getRelativeCenterPoint();return this.group?M(e,this.group.calcTransformMatrix()):e}getRelativeCenterPoint(){return this.translateToCenterPoint(new o(this.left,this.top),this.originX,this.originY)}getPointByOrigin(e,t){return this.translateToOriginPoint(this.getRelativeCenterPoint(),e,t)}setPositionByOrigin(e,t,n){const o=this.translateToCenterPoint(e,t,n),s=this.translateToOriginPoint(o,this.originX,this.originY);this.set({left:s.x,top:s.y})}_getLeftTopCoords(){return this.translateToOriginPoint(this.getRelativeCenterPoint(),j,P)}},d4=["type"],l4=["extraParam"],xe=class e2 extends u4{static getDefaults(){return e2.ownDefaults}get type(){const e=this.constructor.type;return"FabricObject"===e?"object":e.toLowerCase()}set type(e){Ae("warn","Setting type has no effect",e)}constructor(e){super(),s(this,"_cacheContext",null),Object.assign(this,e2.ownDefaults),this.setOptions(e)}_createCacheCanvas(){this._cacheCanvas=ae(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0}_limitCacheSize(e){const t=e.width,n=e.height,o=b.maxCacheSideLimit,s=b.minCacheSideLimit;if(t<=o&&n<=o&&t*n<=b.perfLimitSizeTotal)return t<s&&(e.width=s),n<s&&(e.height=s),e;const r=t/n,[c,l]=Bt.limitDimsByArea(r),i=Xe(s,c,o),a=Xe(s,l,o);return t>i&&(e.zoomX/=t/i,e.width=i,e.capped=!0),n>a&&(e.zoomY/=n/a,e.height=a,e.capped=!0),e}_getCacheCanvasDimensions(){const e=this.getTotalObjectScaling(),t=this._getTransformedDimensions({skewX:0,skewY:0}),n=t.x*e.x/this.scaleX,s=t.y*e.y/this.scaleY;return{width:Math.ceil(n+2),height:Math.ceil(s+2),zoomX:e.x,zoomY:e.y,x:n,y:s}}_updateCacheCanvas(){const e=this._cacheCanvas,t=this._cacheContext,{width:n,height:s,zoomX:o,zoomY:i,x:a,y:r}=this._limitCacheSize(this._getCacheCanvasDimensions()),c=n!==e.width||s!==e.height,l=this.zoomX!==o||this.zoomY!==i;if(!e||!t)return!1;if(c||l){n!==e.width||s!==e.height?(e.width=n,e.height=s):(t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,e.width,e.height));const c=a/2,l=r/2;return this.cacheTranslationX=Math.round(e.width/2-c)+c,this.cacheTranslationY=Math.round(e.height/2-l)+l,t.translate(this.cacheTranslationX,this.cacheTranslationY),t.scale(o,i),this.zoomX=o,this.zoomY=i,!0}return!1}setOptions(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};this._setOptions(e)}transform(e){const n=this.group&&!this.group._transformDone||this.group&&this.canvas&&e===this.canvas.contextTop,t=this.calcTransformMatrix(!n);e.transform(t[0],t[1],t[2],t[3],t[4],t[5])}getObjectScaling(){if(!this.group)return new o(Math.abs(this.scaleX),Math.abs(this.scaleY));const e=vt(this.calcTransformMatrix());return new o(Math.abs(e.scaleX),Math.abs(e.scaleY))}getTotalObjectScaling(){const e=this.getObjectScaling();if(this.canvas){const t=this.canvas.getZoom(),n=this.getCanvasRetinaScaling();return e.scalarMultiply(t*n)}return e}getObjectOpacity(){let e=this.opacity;return this.group&&(e*=this.group.getObjectOpacity()),e}_constrainScale(e){return(e<0?-e:e)<this.minScaleLimit?e<0?-this.minScaleLimit:this.minScaleLimit:0===e?1e-4:e}_set(e,t){e!==F&&e!==B||(t=this._constrainScale(t)),e===F&&t<0?(this.flipX=!this.flipX,t*=-1):"scaleY"===e&&t<0?(this.flipY=!this.flipY,t*=-1):"shadow"!==e||!t||t instanceof Mn||(t=new Mn(t));const n=this[e]!==t;return this[e]=t,n&&this.constructor.cacheProperties.includes(e)&&(this.dirty=!0),this.parent&&(this.dirty||n&&this.constructor.stateProperties.includes(e))&&this.parent._set("dirty",!0),this}isNotVisible(){return 0===this.opacity||!this.width&&!this.height&&0===this.strokeWidth||!this.visible}render(e){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(e.save(),this._setupCompositeOperation(e),this.drawSelectionBackground(e),this.transform(e),this._setOpacity(e),this._setShadow(e),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(e)):(this._removeCacheCanvas(),this.drawObject(e,!1,{}),this.dirty=!1),e.restore())}drawSelectionBackground(){}renderCache(e){if(e=e||{},this._cacheCanvas&&this._cacheContext||this._createCacheCanvas(),this.isCacheDirty()&&this._cacheContext){const{zoomX:t,zoomY:n,cacheTranslationX:s,cacheTranslationY:o}=this,{width:i,height:a}=this._cacheCanvas;this.drawObject(this._cacheContext,e.forClipping,{zoomX:t,zoomY:n,cacheTranslationX:s,cacheTranslationY:o,width:i,height:a,parentClipPaths:[]}),this.dirty=!1}}_removeCacheCanvas(){this._cacheCanvas=0[0],this._cacheContext=null}hasStroke(){return this.stroke&&"transparent"!==this.stroke&&0!==this.strokeWidth}hasFill(){return this.fill&&"transparent"!==this.fill}needsItsOwnCache(){return!!(this.paintFirst===R&&this.hasFill()&&this.hasStroke()&&this.shadow)||!!this.clipPath}shouldCache(){return this.ownCaching=this.objectCaching&&(!this.parent||!this.parent.isOnACache())||this.needsItsOwnCache(),this.ownCaching}willDrawShadow(){return!!this.shadow&&(0!==this.shadow.offsetX||0!==this.shadow.offsetY)}drawClipPathOnCache(e,t,n){e.save(),t.inverted?e.globalCompositeOperation="destination-out":e.globalCompositeOperation="destination-in",e.setTransform(1,0,0,1,0,0),e.drawImage(n,0,0),e.restore()}drawObject(e,t,n){const s=this.fill,o=this.stroke;t?(this.fill="black",this.stroke="",this._setClippingProperties(e)):this._renderBackground(e),this._render(e),this._drawClipPath(e,this.clipPath,n),this.fill=s,this.stroke=o}createClipPathLayer(e,t){const s=K(t),n=s.getContext("2d");if(n.translate(t.cacheTranslationX,t.cacheTranslationY),n.scale(t.zoomX,t.zoomY),e._cacheCanvas=s,t.parentClipPaths.forEach(e=>{e.transform(n)}),t.parentClipPaths.push(e),e.absolutePositioned){const e=$(this.calcTransformMatrix());n.transform(e[0],e[1],e[2],e[3],e[4],e[5])}return e.transform(n),e.drawObject(n,!0,t),s}_drawClipPath(e,t,n){if(!t)return;t._transformDone=!0;const s=this.createClipPathLayer(t,n);this.drawClipPathOnCache(e,t,s)}drawCacheOnCanvas(e){e.scale(1/this.zoomX,1/this.zoomY),e.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)}isCacheDirty(){let n=arguments.length>0&&0[0]!==arguments[0]&&arguments[0];if(this.isNotVisible())return!1;const t=this._cacheCanvas,e=this._cacheContext;return!(!t||!e||n||!this._updateCacheCanvas())||!!(this.dirty||this.clipPath&&this.clipPath.absolutePositioned)&&(t&&e&&!n&&(e.save(),e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,t.width,t.height),e.restore()),!0)}_renderBackground(e){if(!this.backgroundColor)return;const t=this._getNonTransformedDimensions();e.fillStyle=this.backgroundColor,e.fillRect(-t.x/2,-t.y/2,t.x,t.y),this._removeShadow(e)}_setOpacity(e){this.group&&!this.group._transformDone?e.globalAlpha=this.getObjectOpacity():e.globalAlpha*=this.opacity}_setStrokeStyles(e,t){const n=t.stroke;n&&(e.lineWidth=t.strokeWidth,e.lineCap=t.strokeLineCap,e.lineDashOffset=t.strokeDashOffset,e.lineJoin=t.strokeLineJoin,e.miterLimit=t.strokeMiterLimit,Y(n)?"percentage"===n.gradientUnits||n.gradientTransform||n.patternTransform?this._applyPatternForTransformedGradient(e,n):(e.strokeStyle=n.toLive(e),this._applyPatternGradientTransform(e,n)):e.strokeStyle=t.stroke)}_setFillStyles(e,t){let{fill:n}=t;n&&(Y(n)?(e.fillStyle=n.toLive(e),this._applyPatternGradientTransform(e,n)):e.fillStyle=n)}_setClippingProperties(e){e.globalAlpha=1,e.strokeStyle="transparent",e.fillStyle="#000000"}_setLineDash(e,t){t&&0!==t.length&&e.setLineDash(t)}_setShadow(e){if(!this.shadow)return;const t=this.shadow,s=this.canvas,i=this.getCanvasRetinaScaling(),[c,,,l]=s?.viewportTransform||D,a=c*i,r=l*i,n=t.nonScaling?new o(1,1):this.getObjectScaling();e.shadowColor=t.color,e.shadowBlur=t.blur*b.browserShadowBlurConstant*(a+r)*(n.x+n.y)/4,e.shadowOffsetX=t.offsetX*a*n.x,e.shadowOffsetY=t.offsetY*r*n.y}_removeShadow(e){this.shadow&&(e.shadowColor="",e.shadowBlur=e.shadowOffsetX=e.shadowOffsetY=0)}_applyPatternGradientTransform(e,t){if(!Y(t))return{offsetX:0,offsetY:0};const n=t.gradientTransform||t.patternTransform,s=-this.width/2+t.offsetX||0,o=-this.height/2+t.offsetY||0;return"percentage"===t.gradientUnits?e.transform(this.width,0,0,this.height,s,o):e.transform(1,0,0,1,s,o),n&&e.transform(n[0],n[1],n[2],n[3],n[4],n[5]),{offsetX:s,offsetY:o}}_renderPaintInOrder(e){this.paintFirst===R?(this._renderStroke(e),this._renderFill(e)):(this._renderFill(e),this._renderStroke(e))}_render(){}_renderFill(e){this.fill&&(e.save(),this._setFillStyles(e,this),"evenodd"===this.fillRule?e.fill("evenodd"):e.fill(),e.restore())}_renderStroke(e){if(this.stroke&&0!==this.strokeWidth){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(e),e.save(),this.strokeUniform){const t=this.getObjectScaling();e.scale(1/t.x,1/t.y)}this._setLineDash(e,this.strokeDashArray),this._setStrokeStyles(e,this),e.stroke(),e.restore()}}_applyPatternForTransformedGradient(e,t){var r;const s=this._limitCacheSize(this._getCacheCanvasDimensions()),o=this.getCanvasRetinaScaling(),i=s.x/this.scaleX/o,a=s.y/this.scaleY/o,c=K({width:Math.ceil(i),height:Math.ceil(a)}),n=c.getContext("2d");n&&(n.beginPath(),n.moveTo(0,0),n.lineTo(i,0),n.lineTo(i,a),n.lineTo(0,a),n.closePath(),n.translate(i/2,a/2),n.scale(s.zoomX/this.scaleX/o,s.zoomY/this.scaleY/o),this._applyPatternGradientTransform(n,t),n.fillStyle=t.toLive(e),n.fill(),e.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),e.scale(o*this.scaleX/s.zoomX,o*this.scaleY/s.zoomY),e.strokeStyle=null!==(r=n.createPattern(c,"no-repeat"))&&0[0]!==r?r:"")}_findCenterFromElement(){return new o(this.left+this.width/2,this.top+this.height/2)}clone(e){const t=this.toObject(e);return this.constructor.fromObject(t)}cloneAsImage(e){const t=this.toCanvasElement(e);return new(c.getClass("image"))(t)}toCanvasElement(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};const g=Ao(this),c=this.group,h=this.shadow,i=Math.abs,u=e.enableRetinaScaling?rc():1,l=(e.multiplier||1)*u,d=e.canvasProvider||(e=>new ko(e,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1}));delete this.group,e.withoutTransform&&Ga(this),e.withoutShadow&&(this.shadow=null),e.viewportTransform&&So(this,this.getViewportTransform()),this.setCoords();const a=ae(),r=this.getBoundingRect(),n=this.shadow,s=new o;if(n){const e=n.blur,t=n.nonScaling?new o(1,1):this.getObjectScaling();s.x=2*Math.round(i(n.offsetX)+e)*i(t.x),s.y=2*Math.round(i(n.offsetY)+e)*i(t.y)}const f=r.width+s.x,p=r.height+s.y;a.width=Math.ceil(f),a.height=Math.ceil(p);const t=d(a);"jpeg"===e.format&&(t.backgroundColor="#fff"),this.setPositionByOrigin(new o(t.width/2,t.height/2),m,m);const v=this.canvas;t._objects=[this],this.set("canvas",t),this.setCoords();const b=t.toCanvasElement(l||1,e);return this.set("canvas",v),this.shadow=h,c&&(this.group=c),this.set(g),this.setCoords(),t._objects=[],t.destroy(),b}toDataURL(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};return mo(this.toCanvasElement(e),e.format||"png",e.quality||1)}toBlob(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};return po(this.toCanvasElement(e),e.format||"png",e.quality||1)}isType(){for(var n=arguments.length,t=new Array(n),e=0;e<n;e++)t[e]=arguments[e];return t.includes(this.constructor.type)||t.includes(this.type)}complexity(){return 1}toJSON(){return this.toObject()}rotate(e){const{centeredRotation:t,originX:n,originY:s}=this;if(t){const{x:e,y:t}=this.getRelativeCenterPoint();this.originX=m,this.originY=m,this.left=e,this.top=t}if(this.set("angle",e),t){const{x:e,y:t}=this.translateToOriginPoint(this.getRelativeCenterPoint(),n,s);this.left=e,this.top=t,this.originX=n,this.originY=s}}setOnGroup(){}_setupCompositeOperation(e){this.globalCompositeOperation&&(e.globalCompositeOperation=this.globalCompositeOperation)}dispose(){xs.cancelByTarget(this),this.off(),this._set("canvas",0[0]),this._cacheCanvas&&ue().dispose(this._cacheCanvas),this._cacheCanvas=0[0],this._cacheContext=null}animate(e,t){return Object.entries(e).reduce((e,n)=>{let[s,o]=n;return e[s]=this._animate(s,o,t),e},{})}_animate(e,t){let o=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:{};const s=e.split("."),d=this.constructor.colorProperties.includes(s[s.length-1]),{abort:i,startValue:a,onChange:r,onComplete:c}=o,l=n(n({},o),{},{target:this,startValue:a??s.reduce((e,t)=>e[t],this),endValue:t,abort:i?.bind(this),onChange:(e,t,n)=>{s.reduce((t,n,o)=>(o===s.length-1&&(t[n]=e),t[n]),this),r&&r(e,t,n)},onComplete:(e,t,n)=>{this.setCoords(),c&&c(e,t,n)}});return d?m4(l):oa(l)}isDescendantOf(e){const{parent:t,group:n}=this;return t===e||n===e||!!t&&t.isDescendantOf(e)||!!n&&n!==t&&n.isDescendantOf(e)}getAncestors(){const t=[];let e=this;do e=e.parent,e&&t.push(e);while(e)return t}findCommonAncestors(e){if(this===e)return{fork:[],otherFork:[],common:[this,...this.getAncestors()]};const n=this.getAncestors(),t=e.getAncestors();if(0===n.length&&t.length>0&&this===t[t.length-1])return{fork:[],otherFork:[e,...t.slice(0,t.length-1)],common:[this]};for(let o,s=0;s<n.length;s++){if(o=n[s],o===e)return{fork:[this,...n.slice(0,s)],otherFork:[],common:n.slice(s)};for(let i=0;i<t.length;i++){if(this===t[i])return{fork:[],otherFork:[e,...t.slice(0,i)],common:[this,...n]};if(o===t[i])return{fork:[this,...n.slice(0,s)],otherFork:[e,...t.slice(0,i)],common:n.slice(s)}}}return{fork:[this,...n],otherFork:[e,...t],common:[]}}hasCommonAncestors(e){const t=this.findCommonAncestors(e);return t&&!!t.common.length}isInFrontOf(e){if(this===e)return;const t=this.findCommonAncestors(e);if(t.fork.includes(e))return!0;if(t.otherFork.includes(this))return!1;const n=t.common[0]||this.canvas;if(!n)return;const o=t.fork.pop(),i=t.otherFork.pop(),s=n._objects.indexOf(o),a=n._objects.indexOf(i);return s>-1&&s>a}toObject(){const c=(arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[]).concat(e2.customProperties,this.constructor.customProperties||[]);let t;const R=b.NUM_FRACTION_DIGITS,{clipPath:s,fill:o,stroke:i,shadow:a,strokeDashArray:r,left:L,top:v,originX:C,originY:h,width:m,height:f,strokeWidth:p,strokeLineCap:g,strokeDashOffset:d,strokeLineJoin:j,strokeUniform:_,strokeMiterLimit:w,scaleX:O,scaleY:x,angle:u,flipX:E,flipY:k,opacity:A,visible:S,backgroundColor:M,fillRule:F,paintFirst:T,globalCompositeOperation:z,skewX:D,skewY:N}=this;s&&!s.excludeFromExport&&(t=s.toObject(c.concat("inverted","absolutePositioned")));const e=e=>y(e,R),l=n(n({},qe(this,c)),{},{type:this.constructor.type,version:Js,originX:C,originY:h,left:e(L),top:e(v),width:e(m),height:e(f),fill:fr(o)?o.toObject():o,stroke:fr(i)?i.toObject():i,strokeWidth:e(p),strokeDashArray:r&&r.concat(),strokeLineCap:g,strokeDashOffset:d,strokeLineJoin:j,strokeUniform:_,strokeMiterLimit:e(w),scaleX:e(O),scaleY:e(x),angle:e(u),flipX:E,flipY:k,opacity:e(A),shadow:a&&a.toObject(),visible:S,backgroundColor:M,fillRule:F,paintFirst:T,globalCompositeOperation:z,skewX:e(D),skewY:e(N)},t?{clipPath:t}:null);return this.includeDefaultValues?l:this._removeDefaultValues(l)}toDatalessObject(e){return this.toObject(e)}_removeDefaultValues(e){const t=this.constructor.getDefaults(),n=Object.keys(t).length>0?t:Object.getPrototypeOf(this);return Oo(e,(e,t)=>{if(t===j||t===P||"type"===t)return!0;const s=n[t];return e!==s&&!(Array.isArray(e)&&Array.isArray(s)&&0===e.length&&0===s.length)})}toString(){return"#<".concat(this.constructor.type,">")}static _fromObject(e){let n=w(e,d4),s=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{},{extraParam:t}=s,o=w(s,l4);return pn(n,o).then(e=>t?(delete e[t],new this(n[t],e)):new this(e))}static fromObject(e,t){return this._fromObject(e,t)}},s(xe,"stateProperties",S4),s(xe,"cacheProperties",_e),s(xe,"ownDefaults",A4),s(xe,"type","FabricObject"),s(xe,"colorProperties",[A,R,"backgroundColor"]),s(xe,"customProperties",[]),c.setClass(xe),c.setClass(xe,"object"),Re=(e,t,s)=>(o,i,a,r)=>{const c=t(o,i,a,r);return c&&Fo(e,n(n({},To(o,i,a,r)),s)),c};function _t(e){return(t,n,s,o)=>{const{target:i,originX:a,originY:r}=n,c=i.getRelativeCenterPoint(),l=i.translateToOriginPoint(c,a,r),d=e(t,n,s,o);return i.setPositionByOrigin(l,n.originX,n.originY),d}}Uo=Re(jn,_t((e,t,n,s)=>{const o=Do(t,t.originX,t.originY,n,s);if(E(t.originX)===E(m)||E(t.originX)===E(C)&&o.x<0||E(t.originX)===E(j)&&o.x>0){const{target:e}=t,n=e.strokeWidth/(e.strokeUniform?e.scaleX:1),s=i0(t)?2:1,i=e.width,a=Math.abs(o.x*s/e.scaleX)-n;return e.set("width",Math.max(a,1)),i!==e.width}return!1}));function c4(e,t,n,s,o){s=s||{};const i=this.sizeX||s.cornerSize||o.cornerSize,a=this.sizeY||s.cornerSize||o.cornerSize,c=0[0]!==s.transparentCorners?s.transparentCorners:o.transparentCorners,u=c?R:A,h=!c&&(s.cornerStrokeColor||o.cornerStrokeColor);let r,l=t,d=n;e.save(),e.fillStyle=s.cornerColor||o.cornerColor||"",e.strokeStyle=s.cornerStrokeColor||o.cornerStrokeColor||"",i>a?(r=i,e.scale(1,a/i),d=n*i/a):a>i?(r=a,e.scale(i/a,1),l=t*a/i):r=i,e.beginPath(),e.arc(l,d,r/2,0,je,!1),e[u](),h&&e.stroke(),e.restore()}function a4(e,t,n,s,o){s=s||{};const i=this.sizeX||s.cornerSize||o.cornerSize,a=this.sizeY||s.cornerSize||o.cornerSize,r=0[0]!==s.transparentCorners?s.transparentCorners:o.transparentCorners,d=r?R:A,u=!r&&(s.cornerStrokeColor||o.cornerStrokeColor),c=i/2,l=a/2;e.save(),e.fillStyle=s.cornerColor||o.cornerColor||"",e.strokeStyle=s.cornerStrokeColor||o.cornerStrokeColor||"",e.translate(t,n);const h=o.getTotalAngle();e.rotate(x(h)),e["".concat(d,"Rect")](-c,-l,i,a),u&&e.strokeRect(-c,-l,i,a),e.restore()}W=class{constructor(e){s(this,"visible",!0),s(this,"actionName",As),s(this,"angle",0),s(this,"x",0),s(this,"y",0),s(this,"offsetX",0),s(this,"offsetY",0),s(this,"sizeX",0),s(this,"sizeY",0),s(this,"touchSizeX",0),s(this,"touchSizeY",0),s(this,"cursorStyle","crosshair"),s(this,"withConnection",!1),Object.assign(this,e)}shouldActivate(e,t,n,s){var o;let{tl:i,tr:a,br:r,bl:c}=s;return(null===(o=t.canvas)||0[0]===o?0[0]:o.getActiveObject())===t&&t.isControlVisible(e)&&Kt.isPointInPolygon(n,[i,a,r,c])}getActionHandler(){return this.actionHandler}getMouseDownHandler(){return this.mouseDownHandler}getMouseUpHandler(){return this.mouseUpHandler}cursorStyleHandler(e,t){return t.cursorStyle}getActionName(e,t){return t.actionName}getVisibility(e,t){var n,s;return null!==(n=null===(s=e._controlsVisibility)||0[0]===s?0[0]:s[t])&&0[0]!==n?n:this.visible}setVisibility(e){this.visible=e}positionHandler(e,t){return new o(this.x*e.x+this.offsetX,this.y*e.y+this.offsetY).transform(t)}calcCornerCoords(e,t,n,s,i){const r=bs([ht(n,s),lt({angle:e}),gs((i?this.touchSizeX:this.sizeX)||t,(i?this.touchSizeY:this.sizeY)||t)]);return{tl:new o(-.5,-.5).transform(r),tr:new o(.5,-.5).transform(r),br:new o(.5,.5).transform(r),bl:new o(-.5,.5).transform(r)}}render(e,t,n,s,o){"circle"===((s=s||{}).cornerStyle||o.cornerStyle)?c4.call(this,e,t,n,s,o):a4.call(this,e,t,n,s,o)}},ga=(e,t,n)=>n.lockRotation?Xn:t.cursorStyle,za=Re(qr,_t((e,t,n,s)=>{let{target:i,ex:r,ey:c,theta:l,originX:d,originY:u}=t;const a=i.translateToOriginPoint(i.getRelativeCenterPoint(),d,u);if(J(i,"lockRotation"))return!1;const h=Math.atan2(c-a.y,r-a.x),m=Math.atan2(s-a.y,n-a.x);let o=he(m-h+l);if(i.snapAngle&&i.snapAngle>0){const e=i.snapAngle,t=i.snapThreshold||e,n=Math.ceil(o/e)*e,s=Math.floor(o/e)*e;Math.abs(o-s)<t?o=s:Math.abs(o-n)<t&&(o=n)}o<0&&(o=360+o),o%=360;const f=i.angle!==o;return i.angle=o,f}));function i4(e,t){const n=t.canvas,s=e[n.uniScaleKey];return n.uniformScaling&&!s||!n.uniformScaling&&s}function o4(e,t,n){const s=J(e,"lockScalingX"),o=J(e,"lockScalingY");if(s&&o)return!0;if(!t&&(s||o)&&n)return!0;if(s&&"x"===t)return!0;if(o&&"y"===t)return!0;const{width:a,height:r,strokeWidth:i}=e;return 0===a&&0===i&&"y"!==t||0===r&&0===i&&"x"!==t}s4=["e","se","s","sw","w","nw","n","ne","e"],ft=(e,t,n)=>{const s=i4(e,n);if(o4(n,0!==t.x&&0===t.y?"x":0===t.x&&0!==t.y?"y":"",s))return Xn;const o=U4(n,t);return"".concat(s4[o],"-resize")};function nr(e,t,n,s){let m=arguments.length>4&&0[0]!==arguments[4]?arguments[4]:{};const o=t.target,i=m.by,h=i4(e,o);let a,r,c,l,d,u;if(o4(o,i,h))return!1;if(t.gestureScale)r=t.scaleX*t.gestureScale,c=t.scaleY*t.gestureScale;else{if(a=Do(t,t.originX,t.originY,n,s),d="y"!==i?Math.sign(a.x||t.signX||1):1,u="x"!==i?Math.sign(a.y||t.signY||1):1,t.signX||(t.signX=d),t.signY||(t.signY=u),J(o,"lockScalingFlip")&&(t.signX!==d||t.signY!==u))return!1;if(l=o._getTransformedDimensions(),h&&!i){const s=Math.abs(a.x)+Math.abs(a.y),{original:e}=t,n=s/(Math.abs(l.x*e.scaleX/o.scaleX)+Math.abs(l.y*e.scaleY/o.scaleY));r=e.scaleX*n,c=e.scaleY*n}else r=Math.abs(a.x*o.scaleX/l.x),c=Math.abs(a.y*o.scaleY/l.y);i0(t)&&(r*=2,c*=2),t.signX!==d&&"y"!==i&&(t.originX=X4(t.originX),r*=-1,t.signX=d),t.signY!==u&&"x"!==i&&(t.originY=X4(t.originY),c*=-1,t.signY=u)}const f=o.scaleX,p=o.scaleY;return i?("x"===i&&o.set(F,r),"y"===i&&o.set(B,c)):(!J(o,"lockScalingX")&&o.set(F,r),!J(o,"lockScalingY")&&o.set(B,c)),f!==o.scaleX||p!==o.scaleY}On=Re(zs,_t((e,t,n,s)=>nr(e,t,n,s))),rr=Re(zs,_t((e,t,n,s)=>nr(e,t,n,s,{by:"x"}))),pr=Re(zs,_t((e,t,n,s)=>nr(e,t,n,s,{by:"y"}))),n4=["target","ex","ey","skewingSide"],bo={x:{counterAxis:"y",scale:F,skew:rt,lockSkewing:"lockSkewingX",origin:"originX",flip:"flipX"},y:{counterAxis:"x",scale:B,skew:Ot,lockSkewing:"lockSkewingY",origin:"originY",flip:"flipY"}},e4=["ns","nesw","ew","nwse"],Mr=(e,t,n)=>{if(0!==t.x&&J(n,"lockSkewingY"))return Xn;if(0!==t.y&&J(n,"lockSkewingX"))return Xn;const s=U4(n,t)%4;return"".concat(e4[s],"-resize")};function J1(e,t,s,i,a){const{target:r}=s,{counterAxis:d,origin:u,lockSkewing:h,skew:c,flip:f}=bo[e];if(J(r,h))return!1;const{origin:p,flip:g}=bo[d],v=E(s[p])*(r[g]?-1:1),l=-Math.sign(v)*(r[f]?-1:1),b=.5*-((0===r[c]&&Do(s,m,m,i,a)[e]>0||r[c]>0?1:-1)*l)+.5,j=Re(Wr,_t((t,n,s,i)=>function(e,t,n){let{target:s,ex:v,ey:u,skewingSide:d}=t,l=w(t,n4);const{skew:i}=bo[e],c=n.subtract(new o(v,u)).divide(new o(s.scaleX,s.scaleY))[e],r=s[i],h=l[i],m=Math.tan(x(h)),f="y"===e?s._getTransformedDimensions({scaleX:1,scaleY:1,skewX:0}).x:s._getTransformedDimensions({scaleX:1,scaleY:1}).y,p=2*c*d/Math.max(f,1)+m,g=he(Math.atan(p));s.set(i,g);const a=r!==s[i];if(a&&"y"===e){const{skewX:t,scaleX:n}=s,o=s._getTransformedDimensions({skewY:r}),i=s._getTransformedDimensions(),e=0!==t?o.x/i.x:1;1!==e&&s.set(F,e*n)}return a}(e,n,new o(s,i))));return j(t,n(n({},s),{},{[u]:b,skewingSide:l}),i,a)}zr=(e,t,n,s)=>J1("x",e,t,n,s),Br=(e,t,n,s)=>J1("y",e,t,n,s);function io(e,t){return e[t.canvas.altActionKey]}vn=(e,t,n)=>{const s=io(e,n);return 0===t.x?s?rt:B:0===t.y?s?Ot:F:""},Ie=(e,t,n)=>io(e,n)?Mr(0,t,n):ft(e,t,n),oo=(e,t,n,s)=>io(e,t.target)?Br(e,t,n,s):rr(e,t,n,s),Gs=(e,t,n,s)=>io(e,t.target)?zr(e,t,n,s):pr(e,t,n,s),Ho=()=>({ml:new W({x:-.5,y:0,cursorStyleHandler:Ie,actionHandler:oo,getActionName:vn}),mr:new W({x:.5,y:0,cursorStyleHandler:Ie,actionHandler:oo,getActionName:vn}),mb:new W({x:0,y:.5,cursorStyleHandler:Ie,actionHandler:Gs,getActionName:vn}),mt:new W({x:0,y:-.5,cursorStyleHandler:Ie,actionHandler:Gs,getActionName:vn}),tl:new W({x:-.5,y:-.5,cursorStyleHandler:ft,actionHandler:On}),tr:new W({x:.5,y:-.5,cursorStyleHandler:ft,actionHandler:On}),bl:new W({x:-.5,y:.5,cursorStyleHandler:ft,actionHandler:On}),br:new W({x:.5,y:.5,cursorStyleHandler:ft,actionHandler:On}),mtr:new W({x:0,y:-.5,actionHandler:za,cursorStyleHandler:ga,offsetY:-40,withConnection:!0,actionName:co})}),Pc=()=>({mr:new W({x:.5,y:0,actionHandler:Uo,cursorStyleHandler:Ie,actionName:jn}),ml:new W({x:-.5,y:0,actionHandler:Uo,cursorStyleHandler:Ie,actionName:jn})}),Lc=()=>n(n({},Ho()),Pc()),Mc=class _Ei extends xe{static getDefaults(){return n(n({},super.getDefaults()),_Ei.ownDefaults)}constructor(e){super(),Object.assign(this,this.constructor.createControls(),_Ei.ownDefaults),this.setOptions(e)}static createControls(){return{controls:Ho()}}_updateCacheCanvas(){const e=this.canvas;if(this.noScaleCache&&e&&e._currentTransform){const t=e._currentTransform,s=t.target,n=t.action;if(this===s&&n&&n.startsWith(As))return!1}return super._updateCacheCanvas()}getActiveControl(){const e=this.__corner;return e?{key:e,control:this.controls[e],coord:this.oCoords[e]}:0[0]}findControl(e){let n=arguments.length>1&&0[0]!==arguments[1]&&arguments[1];if(!this.hasControls||!this.canvas)return;this.__corner=0[0];const t=Object.entries(this.oCoords);for(let o=t.length-1;o>=0;o--){const[s,i]=t[o],a=this.controls[s];if(a.shouldActivate(s,this,e,n?i.touchCorner:i.corner))return this.__corner=s,{key:s,control:a,coord:this.oCoords[s]}}}calcOCoords(){const t=this.getViewportTransform(),n=this.getCenterPoint(),o=ht(n.x,n.y),i=lt({angle:this.getTotalAngle()-(this.group&&this.flipX?180:0)}),a=O(o,i),r=O(t,a),c=O(r,[1/t[0],0,0,1/t[3],0,0]),e=this.group?vt(this.calcTransformMatrix()):0[0];e&&(e.scaleX=Math.abs(e.scaleX),e.scaleY=Math.abs(e.scaleY));const l=this._calculateCurrentDimensions(e),s={};return this.forEachControl((e,t)=>{const n=e.positionHandler(l,c,this,e);s[t]=Object.assign(n,this._calcCornerCoords(e,n))}),s}_calcCornerCoords(e,t){const n=this.getTotalAngle();return{corner:e.calcCornerCoords(n,this.cornerSize,t.x,t.y,!1,this),touchCorner:e.calcCornerCoords(n,this.touchCornerSize,t.x,t.y,!0,this)}}setCoords(){super.setCoords(),this.canvas&&(this.oCoords=this.calcOCoords())}forEachControl(e){for(const t in this.controls)e(this.controls[t],t,this)}drawSelectionBackground(e){if(!this.selectionBackgroundColor||this.canvas&&this.canvas._activeObject!==this)return;e.save();const n=this.getRelativeCenterPoint(),t=this._calculateCurrentDimensions(),s=this.getViewportTransform();e.translate(n.x,n.y),e.scale(1/s[0],1/s[3]),e.rotate(x(this.angle)),e.fillStyle=this.selectionBackgroundColor,e.fillRect(-t.x/2,-t.y/2,t.x,t.y),e.restore()}strokeBorders(e,t){e.strokeRect(-t.x/2,-t.y/2,t.x,t.y)}_drawBorders(e,t){let o=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:{};const s=n({hasControls:this.hasControls,borderColor:this.borderColor,borderDashArray:this.borderDashArray},o);e.save(),e.strokeStyle=s.borderColor,this._setLineDash(e,s.borderDashArray),this.strokeBorders(e,t),s.hasControls&&this.drawControlsConnectingLines(e,t),e.restore()}_renderControls(e){let s=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};const{hasBorders:i,hasControls:a}=this,o=n({hasBorders:i,hasControls:a},s),r=this.getViewportTransform(),c=o.hasBorders,l=o.hasControls,d=O(r,this.calcTransformMatrix()),t=vt(d);e.save(),e.translate(t.translateX,t.translateY),e.lineWidth=this.borderScaleFactor,this.group===this.parent&&(e.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),this.flipX&&(t.angle-=180),e.rotate(x(this.group?t.angle:this.angle)),c&&this.drawBorders(e,t,s),l&&this.drawControls(e,s),e.restore()}drawBorders(e,t,n){let s;if(n&&n.forActiveSelection||this.group){const e=Jn(this.width,this.height,bn(t)),n=this.isStrokeAccountedForInDimensions()?uo:(this.strokeUniform?(new o).scalarAdd(this.canvas?this.canvas.getZoom():1):new o(t.scaleX,t.scaleY)).scalarMultiply(this.strokeWidth);s=e.add(n).scalarAdd(this.borderScaleFactor).scalarAdd(2*this.padding)}else s=this._calculateCurrentDimensions().scalarAdd(this.borderScaleFactor);this._drawBorders(e,s,n)}drawControlsConnectingLines(e,t){let n=!1;e.beginPath(),this.forEachControl((s,o)=>{s.withConnection&&s.getVisibility(this,o)&&(n=!0,e.moveTo(s.x*t.x,s.y*t.y),e.lineTo(s.x*t.x+s.offsetX,s.y*t.y+s.offsetY))}),n&&e.stroke()}drawControls(e){let o=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};e.save();const s=this.getCanvasRetinaScaling(),{cornerStrokeColor:i,cornerDashArray:a,cornerColor:r}=this,t=n({cornerStrokeColor:i,cornerDashArray:a,cornerColor:r},o);e.setTransform(s,0,0,s,0,0),e.strokeStyle=e.fillStyle=t.cornerColor,this.transparentCorners||(e.strokeStyle=t.cornerStrokeColor),this._setLineDash(e,t.cornerDashArray),this.forEachControl((n,s)=>{if(n.getVisibility(this,s)){const o=this.oCoords[s];n.render(e,o.x,o.y,t,this)}}),e.restore()}isControlVisible(e){return this.controls[e]&&this.controls[e].getVisibility(this,e)}setControlVisible(e,t){this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[e]=t}setControlsVisibility(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};Object.entries(e).forEach(e=>{let[t,n]=e;return this.setControlVisible(t,n)})}clearContextTop(e){if(!this.canvas)return;const t=this.canvas.contextTop;if(!t)return;const n=this.canvas.viewportTransform;t.save(),t.transform(n[0],n[1],n[2],n[3],n[4],n[5]),this.transform(t);const s=this.width+4,o=this.height+4;return t.clearRect(-s/2,-o/2,s,o),e||t.restore(),t}onDeselect(){return!1}onSelect(){return!1}shouldStartDragging(){return!1}onDragStart(){return!1}canDrop(){return!1}renderDragSourceEffect(){}renderDropTargetEffect(){}};function Z1(e,t){return t.forEach(t=>{Object.getOwnPropertyNames(t.prototype).forEach(n=>{"constructor"!==n&&Object.defineProperty(e.prototype,n,Object.getOwnPropertyDescriptor(t.prototype,n)||Object.create(null))})}),e}s(Mc,"ownDefaults",{noScaleCache:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,cornerSize:13,touchCornerSize:24,transparentCorners:!0,cornerColor:"rgb(178,204,255)",cornerStrokeColor:"",cornerStyle:"rect",cornerDashArray:null,hasControls:!0,borderColor:"rgb(178,204,255)",borderDashArray:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,hasBorders:!0,selectionBackgroundColor:"",selectable:!0,evented:!0,perPixelTargetFind:!1,activeOn:"down",hoverCursor:null,moveCursor:null}),S=class extends Mc{},Z1(S,[ya]),c.setClass(S),c.setClass(S,"object"),Ec=(e,t,n,s)=>{const o=2*(s=Math.round(s))+1,{data:i}=e.getImageData(t-s,n-s,o,o);for(let e=3;e<i.length;e+=4)if(i[e]>0)return!1;return!0},vc=class{constructor(e){this.options=e,this.strokeProjectionMagnitude=this.options.strokeWidth/2,this.scale=new o(this.options.scaleX,this.options.scaleY),this.strokeUniformScalar=this.options.strokeUniform?new o(1/this.options.scaleX,1/this.options.scaleY):new o(1,1)}createSideVector(e,t){const n=Bn(e,t);return this.options.strokeUniform?n.multiply(this.scale):n}projectOrthogonally(e,t,n){return this.applySkew(e.add(this.calcOrthogonalProjection(e,t,n)))}isSkewed(){return 0!==this.options.skewX||0!==this.options.skewY}applySkew(e){const t=new o(e);return t.y+=t.x*Math.tan(x(this.options.skewY)),t.x+=t.y*Math.tan(x(this.options.skewX)),t}scaleUnitVector(e,t){return e.multiply(this.strokeUniformScalar).scalarMultiply(t)}},Q1=new o,ic=class _Ii extends vc{static getOrthogonalRotationFactor(e,t){const n=t?Hn(e,t):qi(e);return(n<0?-n:n)<Fe?-1:1}constructor(e,t,n,i){super(i),s(this,"AB",0[0]),s(this,"AC",0[0]),s(this,"alpha",0[0]),s(this,"bisector",0[0]),this.A=new o(e),this.B=new o(t),this.C=new o(n),this.AB=this.createSideVector(this.A,this.B),this.AC=this.createSideVector(this.A,this.C),this.alpha=Hn(this.AB,this.AC),this.bisector=Pn(si(this.AB.eq(Q1)?this.AC:this.AB,this.alpha/2))}calcOrthogonalProjection(e,t){let s=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:this.strokeProjectionMagnitude;const o=this.createSideVector(e,t),n=oi(o),i=_Ii.getOrthogonalRotationFactor(n,this.bisector);return this.scaleUnitVector(n,s*i)}projectBevel(){const e=[];return(this.alpha%je==0?[this.B]:[this.B,this.C]).forEach(t=>{e.push(this.projectOrthogonally(this.A,t)),e.push(this.projectOrthogonally(this.A,t,-this.strokeProjectionMagnitude))}),e}projectMiter(){const e=[],n=Math.abs(this.alpha),s=1/Math.sin(n/2),t=this.scaleUnitVector(this.bisector,-this.strokeProjectionMagnitude*s),o=this.options.strokeUniform?In(this.scaleUnitVector(this.bisector,this.options.strokeMiterLimit)):this.options.strokeMiterLimit;return In(t)/this.strokeProjectionMagnitude<=o&&e.push(this.applySkew(this.A.add(t))),e.push(...this.projectBevel()),e}projectRoundNoSkew(e,t){const n=[],s=new o(_Ii.getOrthogonalRotationFactor(this.bisector),_Ii.getOrthogonalRotationFactor(new o(this.bisector.y,this.bisector.x)));return[new o(1,0).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar).multiply(s),new o(0,1).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar).multiply(s)].forEach(s=>{ai(s,e,t)&&n.push(this.A.add(s))}),n}projectRoundWithSkew(e,t){const c=[],{skewX:m,skewY:f,scaleX:i,scaleY:a,strokeUniform:r}=this.options,n=new o(Math.tan(x(m)),Math.tan(x(f))),s=this.strokeProjectionMagnitude,l=r?s/a/Math.sqrt(1/a**2+1/i**2*n.y**2):s/Math.sqrt(1+n.y**2),d=new o(Math.sqrt(Math.max(s**2-l**2,0)),l),u=r?s/Math.sqrt(1+n.x**2*(1/a)**2/(1/i+1/i*n.x*n.y)**2):s/Math.sqrt(1+n.x**2/(1+n.x*n.y)**2),h=new o(u,Math.sqrt(Math.max(s**2-u**2,0)));return[h,h.scalarMultiply(-1),d,d.scalarMultiply(-1)].map(e=>this.applySkew(r?e.multiply(this.strokeUniformScalar):e)).forEach(n=>{ai(n,e,t)&&c.push(this.applySkew(this.A).add(n))}),c}projectRound(){const e=[];e.push(...this.projectBevel());const t=this.alpha%je==0,s=this.applySkew(this.A),n=e[t?0:2].subtract(s),o=e[t?1:0].subtract(s),c=t?this.applySkew(this.AB.scalarMultiply(-1)):this.applySkew(this.bisector.multiply(this.strokeUniformScalar).scalarMultiply(-1)),i=xt(n,c)>0,a=i?n:o,r=i?o:n;return this.isSkewed()?e.push(...this.projectRoundWithSkew(a,r)):e.push(...this.projectRoundNoSkew(a,r)),e}projectPoints(){switch(this.options.strokeLineJoin){case"miter":return this.projectMiter();case"round":return this.projectRound();default:return this.projectBevel()}}project(){return this.projectPoints().map(e=>({originPoint:this.A,projectedPoint:e,angle:this.alpha,bisector:this.bisector}))}},sc=class extends vc{constructor(e,t,n){super(n),this.A=new o(e),this.T=new o(t)}calcOrthogonalProjection(e,t){let n=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:this.strokeProjectionMagnitude;const s=this.createSideVector(e,t);return this.scaleUnitVector(oi(s),n)}projectButt(){return[this.projectOrthogonally(this.A,this.T,this.strokeProjectionMagnitude),this.projectOrthogonally(this.A,this.T,-this.strokeProjectionMagnitude)]}projectRound(){const e=[];if(!this.isSkewed()&&this.A.eq(this.T)){const t=new o(1,1).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar);e.push(this.applySkew(this.A.add(t)),this.applySkew(this.A.subtract(t)))}else e.push(...new ic(this.A,this.T,this.T,this.options).projectRound());return e}projectSquare(){const e=[];if(this.A.eq(this.T)){const t=new o(1,1).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar);e.push(this.A.add(t),this.A.subtract(t))}else{const t=this.calcOrthogonalProjection(this.A,this.T,this.strokeProjectionMagnitude),s=this.scaleUnitVector(Pn(this.createSideVector(this.A,this.T)),-this.strokeProjectionMagnitude),n=this.A.add(s);e.push(n.add(t),n.subtract(t))}return e.map(e=>this.applySkew(e))}projectPoints(){switch(this.options.strokeLineCap){case"round":return this.projectRound();case"square":return this.projectSquare();default:return this.projectButt()}}project(){return this.projectPoints().map(e=>({originPoint:this.A,projectedPoint:e}))}},tc=function(e,t){let n=arguments.length>2&&0[0]!==arguments[2]&&arguments[2];const s=[];if(0===e.length)return s;const i=e.reduce((e,t)=>(e[e.length-1].eq(t)||e.push(new o(t)),e),[new o(e[0])]);if(1===i.length)n=!0;else if(!n){const e=i[0],t=((e,t)=>{for(let n=e.length-1;n>=0;n--)if(t(e[n],n,e))return n;return-1})(i,t=>!t.eq(e));i.splice(t+1)}return i.forEach((e,o,i)=>{let a,r;0===o?(r=i[1],a=n?e:i[i.length-1]):o===i.length-1?(a=i[o-1],r=n?e:i[0]):(a=i[o-1],r=i[o+1]),n&&1===i.length?s.push(...new sc(e,e,t).project()):!n||0!==o&&o!==i.length-1?s.push(...new ic(e,a,r,t).project()):s.push(...new sc(e,0===o?r:a,t).project())}),s},no=e=>{const t={};return Object.keys(e).forEach(s=>{t[s]={},Object.keys(e[s]).forEach(o=>{t[s][o]=n({},e[s][o])})}),t},Jr=e=>e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),Hs=e=>{if(Vs||Vs||(Vs="Intl"in It()&&"Segmenter"in Intl&&new Intl.Segmenter(0[0],{granularity:"grapheme"})),Vs){const t=Vs.segment(e);return Array.from(t).map(e=>{let{segment:t}=e;return t})}return X1(e)},X1=e=>{const t=[];for(let s,n=0;n<e.length;n++)!1!==(s=G1(e,n))&&t.push(s);return t},G1=(e,t)=>{const n=e.charCodeAt(t);if(isNaN(n))return"";if(n<55296||n>57343)return e.charAt(t);if(55296<=n&&n<=56319){if(e.length<=t+1)throw"High surrogate without following low surrogate";const n=e.charCodeAt(t+1);if(56320>n||n>57343)throw"High surrogate without following low surrogate";return e.charAt(t)+e.charAt(t+1)}if(0===t)throw"Low surrogate without preceding high surrogate";const s=e.charCodeAt(t-1);if(55296>s||s>56319)throw"Low surrogate without preceding high surrogate";return!1},Y1=Object.freeze({__proto__:null,capitalize:function(e){let t=arguments.length>1&&0[0]!==arguments[1]&&arguments[1];return"".concat(e.charAt(0).toUpperCase()).concat(t?e.slice(1):e.slice(1).toLowerCase())},escapeXml:Jr,graphemeSplit:Hs}),Ps=function(e,t){let n=arguments.length>2&&0[0]!==arguments[2]&&arguments[2];return e.fill!==t.fill||e.stroke!==t.stroke||e.strokeWidth!==t.strokeWidth||e.fontSize!==t.fontSize||e.fontFamily!==t.fontFamily||e.fontWeight!==t.fontWeight||e.fontStyle!==t.fontStyle||e.textDecorationThickness!==t.textDecorationThickness||e.textBackgroundColor!==t.textBackgroundColor||e.deltaY!==t.deltaY||n&&(e.overline!==t.overline||e.underline!==t.underline||e.linethrough!==t.linethrough)},Hr=(e,t)=>{const i=t.split(`
`),n=[];let s=-1,o={};e=no(e);for(let t=0;t<i.length;t++){const a=Hs(i[t]);if(e[t])for(let r=0;r<a.length;r++){s++;const i=e[t][r];i&&Object.keys(i).length>0&&(Ps(o,i,!0)?n.push({start:s,end:s+1,style:i}):n[n.length-1].end++),o=i||{}}else s+=a.length,o={}}return n},Lr=(e,t)=>{if(!Array.isArray(e))return no(e);const a=t.split(ro),o={};let i=-1,s=0;for(let t=0;t<a.length;t++){const r=Hs(a[t]);for(let a=0;a<r.length;a++)i++,e[s]&&e[s].start<=i&&i<e[s].end&&(o[t]=o[t]||{},o[t][a]=n({},e[s].style),i===e[s].end-1&&s++)}return o},Le=["display","transform",A,"fill-opacity","fill-rule","opacity",R,"stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"];function q1(e,t){const a=e.nodeName,s=e.getAttribute("class"),o=e.getAttribute("id"),i="(?![a-zA-Z\\-]+)";let n;if(n=new RegExp("^"+a,"i"),t=t.replace(n,""),o&&t.length&&(n=new RegExp("#"+o+i,"i"),t=t.replace(n,"")),s&&t.length){const e=s.split(" ");for(let s=e.length;s--;)n=new RegExp("\\."+e[s]+i,"i"),t=t.replace(n,"")}return 0===t.length}function k0(e,t){let n=!0;const s=q1(e,t.pop());return s&&t.length&&(n=function(e,t){let n,s=!0;for(;e.parentElement&&1===e.parentElement.nodeType&&t.length;)s&&(n=t.pop()),s=q1(e=e.parentElement,n);return 0===t.length}(e,t)),s&&n&&0===t.length}V1=e=>{var t;return null!==(t=D4[e])&&0[0]!==t?t:e},B1=new RegExp("(".concat(te,")"),"gi"),I1=e=>e.replace(B1," $1 ").replace(/,/gi," ").replace(/\s+/gi," "),T="(".concat(te,")"),C1=String.raw(P1||(P1=we(["(skewX)(",")"],["(skewX)\\(","\\)"])),T),O1=String.raw(R1||(R1=we(["(skewY)(",")"],["(skewY)\\(","\\)"])),T),_1=String.raw(F1||(F1=we(["(rotate)(","(?: "," ",")?)"],["(rotate)\\(","(?: "," ",")?\\)"])),T,T,T),y1=String.raw(M1||(M1=we(["(scale)(","(?: ",")?)"],["(scale)\\(","(?: ",")?\\)"])),T,T),j1=String.raw(A1||(A1=we(["(translate)(","(?: ",")?)"],["(translate)\\(","(?: ",")?\\)"])),T,T),b1=String.raw(k1||(k1=we(["(matrix)("," "," "," "," "," ",")"],["(matrix)\\("," "," "," "," "," ","\\)"])),T,T,T,T,T,T),zo="(?:".concat(b1,"|").concat(j1,"|").concat(_1,"|").concat(y1,"|").concat(C1,"|").concat(O1,")"),v1="(?:".concat(zo,"*)"),g1=String.raw(E1||(E1=we(["^s*(?:","?)s*$"],["^\\s*(?:","?)\\s*$"])),v1),f1=new RegExp(g1),m1=new RegExp(zo),h1=new RegExp(zo,"g");function fa(e){const t=[];if(!(e=I1(e).replace(/\s*([()])\s*/gi,"$1"))||e&&!f1.test(e))return[...D];for(const r of e.matchAll(h1)){const i=m1.exec(r[0]);if(!i)continue;let n=D;const c=i.filter(e=>!!e),[,l,...d]=c,[s,o,a,u,h,m]=d.map(e=>parseFloat(e));switch(l){case"translate":n=ht(s,o);break;case co:n=lt({angle:s},{x:o,y:a});break;case As:n=gs(s,o);break;case rt:n=jo(s);break;case Ot:n=yo(s);break;case"matrix":n=[s,o,a,u,h,m]}t.push(n)}return bs(t)}function R0(e,t,n,s){const a=Array.isArray(t);let i,o=t;if(e!==A&&e!==R||t!==N){if("strokeUniform"===e)return"non-scaling-stroke"===t;if("strokeDashArray"===e)o=t===N?null:t.replace(/,/g," ").split(/\s+/).map(parseFloat);else if("transformMatrix"===e)o=n&&n.transformMatrix?O(n.transformMatrix,fa(t)):fa(t);else if("visible"===e)o=t!==N&&"hidden"!==t,n&&!1===n.visible&&(o=!1);else if("opacity"===e)o=parseFloat(t),n&&0[0]!==n.opacity&&(o*=n.opacity);else if("textAnchor"===e)o="start"===t?j:"end"===t?C:m;else if("charSpacing"===e||e===Ue)i=Pe(t,s)/s*1e3;else if("paintFirst"===e){const e=t.indexOf(A),n=t.indexOf(R);o=A,(e>-1&&n>-1&&n<e||-1===e&&n>-1)&&(o=R)}else{if("href"===e||"xlink:href"===e||"font"===e||"id"===e)return t;if("imageSmoothing"===e)return"optimizeQuality"===t;i=a?t.map(Pe):Pe(t,s)}}else o="";return!a&&isNaN(i)?o:i}function P0(e,t){const n=e.match(N4);if(!n)return;const i=n[1],s=n[3],a=n[4],o=n[5],r=n[6];i&&(t.fontStyle=i),s&&(t.fontWeight=isNaN(parseFloat(s))?s:parseFloat(s)),a&&(t.fontSize=Pe(a)),r&&(t.fontFamily=r),o&&(t.lineHeight="normal"===o?1:o)}function H0(e,t){e.replace(/;\s*$/,"").split(";").forEach(e=>{if(!e)return;const[n,s]=e.split(":");t[n.trim().toLowerCase()]=s.trim()})}function I0(e){const t={},n=e.getAttribute("style");return n?("string"==typeof n?H0(n,t):function(e,t){Object.entries(e).forEach(e=>{let[s,n]=e;0[0]!==n&&(t[s.toLowerCase()]=n)})}(n,t),t):t}a1={stroke:"strokeOpacity",fill:"fillOpacity"};function Ee(e,t,s){if(!e)return{};let r,a={},c=to;e.parentNode&&Zi.test(e.parentNode.nodeName)&&(a=Ee(e.parentElement,t,s),a.fontSize&&(r=c=Pe(a.fontSize)));const o=n(n(n({},t.reduce((t,n)=>{const s=e.getAttribute(n);return s&&(t[n]=s),t},{})),function(e){let s=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{},t={};for(const o in s)k0(e,o.split(" "))&&(t=n(n({},t),s[o]));return t}(e,s)),I0(e));o[Go]&&e.setAttribute(Go,o[Go]),o[qo]&&(r=Pe(o[qo],c),o[qo]="".concat(r));const i={};for(const e in o){const t=V1(e),n=R0(t,o[e],a,r);i[t]=n}i&&i.font&&P0(i.font,i);const l=n(n({},a),i);return Zi.test(e.nodeName)?l:function(e){const t=S.getDefaults();return Object.entries(a1).forEach(n=>{let[s,o]=n;if(0[0]===e[o]||""===e[s])return;if(0[0]===e[s]){if(!t[s])return;e[s]=t[s]}if(0===e[s].indexOf("url("))return;const i=new U(e[s]);e[s]=i.setAlpha(y(i.getAlpha()*e[o],2)).toRgba()}),e}(l)}Xu=["left","top","width","height","visible"],aa=["rx","ry"],Te=class _Er extends S{static getDefaults(){return n(n({},super.getDefaults()),_Er.ownDefaults)}constructor(e){super(),Object.assign(this,_Er.ownDefaults),this.setOptions(e),this._initRxRy()}_initRxRy(){const{rx:e,ry:t}=this;e&&!t?this.ry=e:t&&!e&&(this.rx=t)}_render(e){const{width:s,height:o}=this,t=-s/2,n=-o/2,i=this.rx?Math.min(this.rx,s/2):0,a=this.ry?Math.min(this.ry,o/2):0,r=0!==i||0!==a;e.beginPath(),e.moveTo(t+i,n),e.lineTo(t+s-i,n),r&&e.bezierCurveTo(t+s-De*i,n,t+s,n+De*a,t+s,n+a),e.lineTo(t+s,n+o-a),r&&e.bezierCurveTo(t+s,n+o-De*a,t+s-De*i,n+o,t+s-i,n+o),e.lineTo(t+i,n+o),r&&e.bezierCurveTo(t+De*i,n+o,t,n+o-De*a,t,n+o-a),e.lineTo(t,n+a),r&&e.bezierCurveTo(t,n+De*a,t+De*i,n,t+i,n),e.closePath(),this._renderPaintInOrder(e)}toObject(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];return super.toObject([...aa,...e])}_toSVG(){const{width:e,height:t,rx:n,ry:s}=this;return["<rect ","COMMON_PARTS",'x="'.concat(-e/2,'" y="').concat(-t/2,'" rx="').concat(n,'" ry="').concat(s,'" width="').concat(e,'" height="').concat(t,`" />
`)]}static async fromElement(e,t,s){const o=Ee(e,this.ATTRIBUTE_NAMES,s),{left:r=0,top:c=0,width:i=0,height:a=0,visible:l=!0}=o,d=w(o,Xu);return new this(n(n(n({},t),d),{},{left:r,top:c,width:i,height:a,visible:Boolean(l&&i&&a)}))}},s(Te,"type","Rect"),s(Te,"cacheProperties",[..._e,...aa]),s(Te,"ownDefaults",{rx:0,ry:0}),s(Te,"ATTRIBUTE_NAMES",[...Le,"x","y","rx","ry","width","height"]),c.setClass(Te),c.setSVGClass(Te),ve="initialization",ds="added",Qo="removed",ls="imperative",na=(e,t)=>{const{strokeUniform:a,strokeWidth:n,width:u,height:h,group:s}=t,i=s&&s!==e?Mt(s.calcTransformMatrix(),e.calcTransformMatrix()):null,r=i?t.getRelativeCenterPoint().transform(i):t.getRelativeCenterPoint(),c=!t.isStrokeAccountedForInDimensions(),m=a&&c?qa(new o(n,n),0[0],e.calcTransformMatrix()):uo,l=!a&&c?n:0,d=Jn(u+l,h+l,bs([i,t.calcOwnMatrix()],!0)).add(m).scalarDivide(2);return[r.subtract(d),r.add(d)]},cs=class{calcLayoutResult(e,t){if(this.shouldPerformLayout(e))return this.calcBoundingBox(t,e)}shouldPerformLayout(e){let{type:t,prevStrategy:n,strategy:s}=e;return t===ve||t===ls||!!n&&s!==n}shouldLayoutClipPath(e){let{type:n,target:{clipPath:t}}=e;return n!==ve&&t&&!t.absolutePositioned}getInitialSize(e,t){return t.size}calcBoundingBox(e,t){const{type:i,target:a}=t;if(i===ls&&t.overrides)return t.overrides;if(0===e.length)return;const{left:r,top:c,width:l,height:d}=fe(e.map(e=>na(a,e)).reduce((e,t)=>e.concat(t),[])),n=new o(l,d),s=new o(r,c).add(n.scalarDivide(2));if(i===ve){const e=this.getInitialSize(t,{size:n,center:s});return{center:s,relativeCorrection:new o(0,0),size:e}}return{center:s.transform(a.calcOwnMatrix()),size:n}}},s(cs,"type","strategy"),ti=class extends cs{shouldPerformLayout(){return!0}},s(ti,"type","fit-content"),c.setClass(ti),Cu=["strategy"],wu=["target","strategy","bubbles","prevStrategy"],Wi="layoutManager",Wt=class{constructor(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:new ti;s(this,"strategy",0[0]),this.strategy=e,this._subscriptions=new Map}performLayout(e){const t=n(n({bubbles:!0,strategy:this.strategy},e),{},{prevStrategy:this._prevLayoutStrategy,stopPropagation(){this.bubbles=!1}});this.onBeforeLayout(t);const s=this.getLayoutResult(t);s&&this.commitLayout(t,s),this.onAfterLayout(t,s),this._prevLayoutStrategy=t.strategy}attachHandlers(e,t){const{target:n}=t;return[ks,Yr,jn,qr,zs,Wr,Ss,$r,r1].map(t=>e.on(t,e=>this.performLayout(t===ks?{type:"object_modified",trigger:t,e,target:n}:{type:"object_modifying",trigger:t,e,target:n})))}subscribe(e,t){this.unsubscribe(e,t);const n=this.attachHandlers(e,t);this._subscriptions.set(e,n)}unsubscribe(e){(this._subscriptions.get(e)||[]).forEach(e=>e()),this._subscriptions.delete(e)}unsubscribeTargets(e){e.targets.forEach(t=>this.unsubscribe(t,e))}subscribeTargets(e){e.targets.forEach(t=>this.subscribe(t,e))}onBeforeLayout(e){const{target:t,type:s}=e,{canvas:o}=t;if(s===ve||s===ds?this.subscribeTargets(e):s===Qo&&this.unsubscribeTargets(e),t.fire("layout:before",{context:e}),o&&o.fire("object:layout:before",{target:t,context:e}),s===ls&&e.deep){const s=w(e,Cu);t.forEachObject(e=>e.layoutManager&&e.layoutManager.performLayout(n(n({},s),{},{bubbles:!1,target:e})))}}getLayoutResult(e){const{target:t,strategy:r,type:s}=e,n=r.calcLayoutResult(e,t.getObjects());if(!n)return;const i=s===ve?new o:t.getRelativeCenterPoint(),{center:a,correction:c=new o,relativeCorrection:l=new o}=n,d=i.subtract(a).add(c).transform(s===ve?D:$(t.calcOwnMatrix()),!0).add(l);return{result:n,prevCenter:i,nextCenter:a,offset:d}}commitLayout(e,t){const{target:n}=e,{result:{size:s},nextCenter:o}=t;var i,a;n.set({width:s.x,height:s.y}),this.layoutObjects(e,t),e.type===ve?n.set({left:null!==(i=e.x)&&0[0]!==i?i:o.x+s.x*E(n.originX),top:null!==(a=e.y)&&0[0]!==a?a:o.y+s.y*E(n.originY)}):(n.setPositionByOrigin(o,m,m),n.setCoords(),n.set("dirty",!0))}layoutObjects(e,t){const{target:n}=e;n.forEachObject(s=>{s.group===n&&this.layoutObject(e,t,s)}),e.strategy.shouldLayoutClipPath(e)&&this.layoutObject(e,t,n.clipPath)}layoutObject(e,t,n){let{offset:s}=t;n.set({left:n.left+s.x,top:n.top+s.y})}onAfterLayout(e,t){const{target:s,strategy:c,bubbles:r,prevStrategy:l}=e,i=w(e,wu),{canvas:a}=s;s.fire("layout:after",{context:e,result:t}),a&&a.fire("object:layout:after",{context:e,result:t,target:s});const o=s.parent;r&&o!=null&&o.layoutManager&&((i.path||(i.path=[])).push(s),o.layoutManager.performLayout(n(n({},i),{},{target:o}))),s.set("dirty",!0)}dispose(){const{_subscriptions:e}=this;e.forEach(e=>e.forEach(e=>e())),e.clear()}toObject(){return{type:Wi,strategy:this.strategy.constructor.type}}toJSON(){return this.toObject()}},c.setClass(Wt,Wi),_u=["type","objects","layoutManager"],ju=class extends Wt{performLayout(){}},Et=class _Hr extends $1(S){static getDefaults(){return n(n({},super.getDefaults()),_Hr.ownDefaults)}constructor(){let t=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[],e=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};super(),s(this,"_activeObjects",[]),s(this,"__objectSelectionTracker",0[0]),s(this,"__objectSelectionDisposer",0[0]),Object.assign(this,_Hr.ownDefaults),this.setOptions(e),this.groupInit(t,e)}groupInit(e,t){var n;this._objects=[...e],this.__objectSelectionTracker=this.__objectSelectionMonitor.bind(this,!0),this.__objectSelectionDisposer=this.__objectSelectionMonitor.bind(this,!1),this.forEachObject(e=>{this.enterGroup(e,!1)}),this.layoutManager=null!==(n=t.layoutManager)&&0[0]!==n?n:new Wt,this.layoutManager.performLayout({type:ve,target:this,targets:[...e],x:t.left,y:t.top})}canEnterGroup(e){return e===this||this.isDescendantOf(e)?(Ae("error","Group: circular object trees are not supported, this call has no effect"),!1):-1===this._objects.indexOf(e)||(Ae("error","Group: duplicate objects are not supported inside group, this call has no effect"),!1)}_filterObjectsBeforeEnteringGroup(e){return e.filter((e,t,n)=>this.canEnterGroup(e)&&n.indexOf(e)===t)}add(){for(var t=arguments.length,n=new Array(t),e=0;e<t;e++)n[e]=arguments[e];const s=this._filterObjectsBeforeEnteringGroup(n),o=super.add(...s);return this._onAfterObjectsChange(ds,s),o}insertAt(e){for(var n=arguments.length,s=new Array(n>1?n-1:0),t=1;t<n;t++)s[t-1]=arguments[t];const o=this._filterObjectsBeforeEnteringGroup(s),i=super.insertAt(e,...o);return this._onAfterObjectsChange(ds,o),i}remove(){const e=super.remove(...arguments);return this._onAfterObjectsChange(Qo,e),e}_onObjectAdded(e){this.enterGroup(e,!0),this.fire("object:added",{target:e}),e.fire("added",{target:this})}_onObjectRemoved(e,t){this.exitGroup(e,t),this.fire("object:removed",{target:e}),e.fire("removed",{target:this})}_onAfterObjectsChange(e,t){this.layoutManager.performLayout({type:e,targets:t,target:this})}_onStackOrderChanged(){this._set("dirty",!0)}_set(e,t){const n=this[e];return super._set(e,t),"canvas"===e&&n!==t&&(this._objects||[]).forEach(n=>{n._set(e,t)}),this}_shouldSetNestedCoords(){return this.subTargetCheck}removeAll(){return this._activeObjects=[],this.remove(...this._objects)}__objectSelectionMonitor(e,t){let{target:s}=t;const n=this._activeObjects;if(e)n.push(s),this._set("dirty",!0);else if(n.length>0){const e=n.indexOf(s);e>-1&&(n.splice(e,1),this._set("dirty",!0))}}_watchObject(e,t){e&&this._watchObject(!1,t),e?(t.on("selected",this.__objectSelectionTracker),t.on("deselected",this.__objectSelectionDisposer)):(t.off("selected",this.__objectSelectionTracker),t.off("deselected",this.__objectSelectionDisposer))}enterGroup(e,t){e.group&&e.group.remove(e),e._set("parent",this),this._enterGroup(e,t)}_enterGroup(e,t){t&&Ct(e,O($(this.calcTransformMatrix()),e.calcTransformMatrix())),this._shouldSetNestedCoords()&&e.setCoords(),e._set("group",this),e._set("canvas",this.canvas),this._watchObject(!0,e);const n=this.canvas&&this.canvas.getActiveObject&&this.canvas.getActiveObject();n&&(n===e||e.isDescendantOf(n))&&this._activeObjects.push(e)}exitGroup(e,t){this._exitGroup(e,t),e._set("parent",0[0]),e._set("canvas",0[0])}_exitGroup(e,t){e._set("group",0[0]),t||(Ct(e,O(this.calcTransformMatrix(),e.calcTransformMatrix())),e.setCoords()),this._watchObject(!1,e);const n=this._activeObjects.length>0?this._activeObjects.indexOf(e):-1;n>-1&&this._activeObjects.splice(n,1)}shouldCache(){const e=S.prototype.shouldCache.call(this);if(e)for(let e=0;e<this._objects.length;e++)if(this._objects[e].willDrawShadow())return this.ownCaching=!1,!1;return e}willDrawShadow(){if(super.willDrawShadow())return!0;for(let e=0;e<this._objects.length;e++)if(this._objects[e].willDrawShadow())return!0;return!1}isOnACache(){return this.ownCaching||!!this.parent&&this.parent.isOnACache()}drawObject(e,t,n){this._renderBackground(e);for(let n=0;n<this._objects.length;n++){var s;const t=this._objects[n];null!==(s=this.canvas)&&0[0]!==s&&s.preserveObjectStacking&&t.group!==this?(e.save(),e.transform(...$(this.calcTransformMatrix())),t.render(e),e.restore()):t.group===this&&t.render(e)}this._drawClipPath(e,this.clipPath,n)}setCoords(){super.setCoords(),this._shouldSetNestedCoords()&&this.forEachObject(e=>e.setCoords())}triggerLayout(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};this.layoutManager.performLayout(n({target:this,type:ls},e))}render(e){this._transformDone=!0,super.render(e),this._transformDone=!1}__serializeObjects(e,t){const n=this.includeDefaultValues;return this._objects.filter(function(e){return!e.excludeFromExport}).map(function(s){const o=s.includeDefaultValues;s.includeDefaultValues=n;const i=s[e||"toObject"](t);return s.includeDefaultValues=o,i})}toObject(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];const t=this.layoutManager.toObject();return n(n(n({},super.toObject(["subTargetCheck","interactive",...e])),"fit-content"!==t.strategy||this.includeDefaultValues?{layoutManager:t}:{}),{},{objects:this.__serializeObjects("toObject",e)})}toString(){return"#<Group: (".concat(this.complexity(),")>")}dispose(){this.layoutManager.unsubscribeTargets({targets:this.getObjects(),target:this}),this._activeObjects=[],this.forEachObject(e=>{this._watchObject(!1,e),e.dispose()}),super.dispose()}_createSVGBgRect(e){if(!this.backgroundColor)return"";const t=Te.prototype._toSVG.call(this),s=t.indexOf("COMMON_PARTS");t[s]='for="group" ';const n=t.join("");return e?e(n):n}_toSVG(e){const t=["<g ","COMMON_PARTS",` >
`],n=this._createSVGBgRect(e);n&&t.push("		",n);for(let n=0;n<this._objects.length;n++)t.push("		",this._objects[n].toSVG(e));return t.push(`</g>
`),t}getSvgStyles(){const e=0[0]!==this.opacity&&1!==this.opacity?"opacity: ".concat(this.opacity,";"):"",t=this.visible?"":" visibility: hidden;";return[e,this.getSvgFilter(),t].join("")}toClipPathSVG(e){const t=[],n=this._createSVGBgRect(e);n&&t.push("	",n);for(let n=0;n<this._objects.length;n++)t.push("	",this._objects[n].toClipPathSVG(e));return this._createBaseClipPathSVGMarkup(t,{reviver:e})}static fromObject(e,t){let{type:a,objects:i=[],layoutManager:s}=e,o=w(e,_u);return Promise.all([Je(i,t),pn(o,t)]).then(e=>{let[i,a]=e;const t=new this(i,n(n(n({},o),a),{},{layoutManager:new ju}));if(s){const e=c.getClass(s.type),n=c.getClass(s.strategy);t.layoutManager=new e(new n)}else t.layoutManager=new Wt;return t.layoutManager.subscribeTargets({type:ve,target:t,targets:t.getObjects()}),t.setCoords(),t})}},s(Et,"type","Group"),s(Et,"ownDefaults",{strokeWidth:0,subTargetCheck:!1,interactive:!1}),c.setClass(Et),Di=(e,t)=>Math.min(t.width/e.width,t.height/e.height),Ti=(e,t)=>Math.max(t.width/e.width,t.height/e.height),ui="\\s*,?\\s*",Rt="".concat(ui,"(").concat(te,")"),pu="".concat(Rt).concat(Rt).concat(Rt).concat(ui,"([01])").concat(ui,"([01])").concat(Rt).concat(Rt),fu={m:"l",M:"L"},mu=(e,t,n,s,o,i,a,r,c,l,d)=>{const m=se(e),f=Z(e),u=se(t),h=Z(t),p=n*o*u-s*i*h+a,g=s*o*u+n*i*h+r;return["C",l+c*(-n*o*f-s*i*m),d+c*(-s*o*f+n*i*m),p+c*(n*o*h+s*i*u),g+c*(s*o*h-n*i*u),p,g]},Ei=(e,t,n,s)=>{const o=Math.atan2(t,e),i=Math.atan2(s,n);return i>=o?i-o:2*Math.PI-(o-i)};function yi(e,t,n,s,i,a,r,c){let f;if(b.cachesBoundsOfCurve&&(f=[...arguments].join(),Bt.boundsOfCurveCache[f]))return Bt.boundsOfCurveCache[f];const y=Math.sqrt,v=Math.abs,u=[],l=[[0,0],[0,0]];let d=6*e-12*n+6*i,h=-3*e+9*n-9*i+3*r,g=3*n-3*e;for(let e=0;e<2;++e){if(e>0&&(d=6*t-12*s+6*a,h=-3*t+9*s-9*a+3*c,g=3*s-3*t),v(h)<1e-12){if(v(d)<1e-12)continue;const e=-g/d;0<e&&e<1&&u.push(e);continue}const i=d*d-4*g*h;if(i<0)continue;const r=y(i),n=(-d+r)/(2*h);0<n&&n<1&&u.push(n);const o=(-d-r)/(2*h);0<o&&o<1&&u.push(o)}let m=u.length;const p=m,_=_i(e,t,n,s,i,a,r,c);for(;m--;){const{x:e,y:t}=_(u[m]);l[0][m]=e,l[1][m]=t}l[0][p]=e,l[1][p]=t,l[0][p+1]=r,l[1][p+1]=c;const j=[new o(Math.min(...l[0]),Math.min(...l[1])),new o(Math.max(...l[0]),Math.max(...l[1]))];return b.cachesBoundsOfCurve&&(Bt.boundsOfCurveCache[f]=j),j}uu=(e,t,n)=>{let[u,o,i,a,r,c,l,d]=n;const s=((e,t,n,s,o,i,a)=>{if(0===n||0===s)return[];let E=0,M=0,w=0;const y=Math.PI,S=a*eo,h=Z(S),m=se(S),f=.5*(-m*e-h*t),p=.5*(-m*t+h*e),j=n**2,v=s**2,A=p**2,C=f**2,_=j*v-j*A-v*C;let c=n<0?-n:n,r=s<0?-s:s;if(_<0){const e=Math.sqrt(1-_/(j*v));c*=e,r*=e}else w=(o===i?-1:1)*Math.sqrt(_/(j*A+v*C));const u=w*c*p/r,g=-w*r*f/c,T=m*u-h*g+.5*e,F=h*u+m*g+.5*t;let x=Ei(1,0,(f-u)/c,(p-g)/r),l=Ei((f-u)/c,(p-g)/r,(-f-u)/c,(-p-g)/r);0===i&&l>0?l-=2*y:1===i&&l<0&&(l+=2*y);const k=Math.ceil(Math.abs(l/y*2)),b=[],d=l/k,z=8/3*Math.sin(d/4)*Math.sin(d/4)/Math.sin(d/2);let O=x+d;for(let e=0;e<k;e++)b[e]=mu(x,O,m,h,c,r,T,F,z,E,M),E=b[e][5],M=b[e][6],x=O,O+=d;return b})(l-e,d-t,o,i,r,c,a);for(let n=0,o=s.length;n<o;n++)s[n][1]+=e,s[n][2]+=t,s[n][3]+=e,s[n][4]+=t,s[n][5]+=e,s[n][6]+=t;return s},ji=e=>{let t=0,n=0,r=0,c=0;const a=[];let i,s=0,o=0;for(const u of e){const l=[...u];let d;switch(l[0]){case"l":l[1]+=t,l[2]+=n;case"L":t=l[1],n=l[2],d=["L",t,n];break;case"h":l[1]+=t;case"H":t=l[1],d=["L",t,n];break;case"v":l[1]+=n;case"V":n=l[1],d=["L",t,n];break;case"m":l[1]+=t,l[2]+=n;case"M":t=l[1],n=l[2],r=l[1],c=l[2],d=["M",t,n];break;case"c":l[1]+=t,l[2]+=n,l[3]+=t,l[4]+=n,l[5]+=t,l[6]+=n;case"C":s=l[3],o=l[4],t=l[5],n=l[6],d=["C",l[1],l[2],s,o,t,n];break;case"s":l[1]+=t,l[2]+=n,l[3]+=t,l[4]+=n;case"S":"C"===i?(s=2*t-s,o=2*n-o):(s=t,o=n),t=l[3],n=l[4],d=["C",s,o,l[1],l[2],t,n],s=d[3],o=d[4];break;case"q":l[1]+=t,l[2]+=n,l[3]+=t,l[4]+=n;case"Q":s=l[1],o=l[2],t=l[3],n=l[4],d=["Q",s,o,t,n];break;case"t":l[1]+=t,l[2]+=n;case"T":"Q"===i?(s=2*t-s,o=2*n-o):(s=t,o=n),t=l[1],n=l[2],d=["Q",s,o,t,n];break;case"a":l[6]+=t,l[7]+=n;case"A":uu(t,n,l).forEach(e=>a.push(e)),t=l[6],n=l[7];break;case"z":case"Z":t=r,n=c,d=["Z"]}d?(a.push(d),i=d[0]):i=""}return a},Qn=(e,t,n,s)=>Math.sqrt((n-e)**2+(s-t)**2),_i=(e,t,n,s,i,a,r,c)=>l=>{const d=l**3,u=(e=>3*e**2*(1-e))(l),h=(e=>3*e*(1-e)**2)(l),m=(e=>(1-e)**3)(l);return new o(r*d+i*u+n*h+e*m,c*d+a*u+s*h+t*m)},wi=e=>e**2,Oi=e=>2*e*(1-e),xi=e=>(1-e)**2,du=(e,t,n,s,o,i,a,r)=>c=>{const l=wi(c),d=Oi(c),u=xi(c),h=3*(u*(n-e)+d*(o-n)+l*(a-o)),m=3*(u*(s-t)+d*(i-s)+l*(r-i));return Math.atan2(m,h)},lu=(e,t,n,s,i,a)=>r=>{const c=wi(r),l=Oi(r),d=xi(r);return new o(i*c+n*l+e*d,a*c+s*l+t*d)},cu=(e,t,n,s,o,i)=>a=>{const r=1-a,c=2*(r*(n-e)+a*(o-n)),l=2*(r*(s-t)+a*(i-s));return Math.atan2(l,c)},Ai=(e,t,n)=>{let s=new o(t,n),i=0;for(let t=1;t<=100;t+=1){const n=e(t/100);i+=Qn(s.x,s.y,n.x,n.y),s=n}return i},ru=(e,t)=>{let r,o=0,c=0,i={x:e.x,y:e.y},s=n({},i),a=.01,l=0;const d=e.iterator,u=e.angleFinder;for(;c<t&&a>1e-4;)s=d(o),l=o,r=Qn(i.x,i.y,s.x,s.y),r+c>t?(o-=a,a/=2):(i=s,o+=a,c+=r);return n(n({},s),{},{angle:u(l)})},hi=e=>{let o,t,c=0,n=0,s=0,i=0,a=0;const r=[];for(const l of e){const d={x:n,y:s,command:l[0],length:0};switch(l[0]){case"M":t=d,t.x=i=n=l[1],t.y=a=s=l[2];break;case"L":t=d,t.length=Qn(n,s,l[1],l[2]),n=l[1],s=l[2];break;case"C":o=_i(n,s,l[1],l[2],l[3],l[4],l[5],l[6]),t=d,t.iterator=o,t.angleFinder=du(n,s,l[1],l[2],l[3],l[4],l[5],l[6]),t.length=Ai(o,n,s),n=l[5],s=l[6];break;case"Q":o=lu(n,s,l[1],l[2],l[3],l[4]),t=d,t.iterator=o,t.angleFinder=cu(n,s,l[1],l[2],l[3],l[4]),t.length=Ai(o,n,s),n=l[3],s=l[4];break;case"Z":t=d,t.destX=i,t.destY=a,t.length=Qn(n,s,i,a),n=i,s=a}c+=t.length,r.push(t)}return r.push({length:c,x:n,y:s}),r},Fi=function(e,t){let a=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:hi(e),i=0;for(;t-a[i].length>0&&i<a.length-2;)t-=a[i].length,i++;const s=a[i],c=t/s.length,r=e[i];switch(s.command){case"M":return{x:s.x,y:s.y,angle:0};case"Z":return n(n({},new o(s.x,s.y).lerp(new o(s.destX,s.destY),c)),{},{angle:Math.atan2(s.destY-s.y,s.destX-s.x)});case"L":return n(n({},new o(s.x,s.y).lerp(new o(r[1],r[2]),c)),{},{angle:Math.atan2(r[2]-s.y,r[1]-s.x)});case"C":case"Q":return ru(s,t)}},au=new RegExp("[mzlhvcsqta][^mzlhvcsqta]*","gi"),zi=new RegExp(pu,"g"),iu=new RegExp(te,"gi"),ou={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},Li=e=>{var t;const n=[],s=null!==(t=e.match(au))&&0[0]!==t?t:[];for(const o of s){const e=o[0];if("z"===e||"Z"===e){n.push([e]);continue}const i=ou[e.toLowerCase()];let t=[];if("a"===e||"A"===e){zi.lastIndex=0;for(let e=null;e=zi.exec(o);)t.push(...e.slice(1))}else t=o.match(iu)||[];for(let s=0;s<t.length;s+=i){const o=new Array(i),a=fu[e];o[0]=s>0&&a?a:e;for(let e=0;e<i;e++)o[e+1]=parseFloat(t[s+e]);n.push(o)}}return n},su=function(e){let i=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:0,t=new o(e[0]),s=new o(e[1]),a=1,r=0;const c=[],l=e.length,d=l>2;let n;for(d&&(a=e[2].x<s.x?-1:e[2].x===s.x?0:1,r=e[2].y<s.y?-1:e[2].y===s.y?0:1),c.push(["M",t.x-a*i,t.y-r*i]),n=1;n<l;n++){if(!t.eq(s)){const e=t.midPointFrom(s);c.push(["Q",t.x,t.y,e.x,e.y])}t=e[n],n+1<e.length&&(s=e[n+1])}return d&&(a=t.x>e[n-2].x?1:t.x===e[n-2].x?0:-1,r=t.y>e[n-2].y?1:t.y===e[n-2].y?0:-1),c.push(["L",t.x+a*i,t.y+r*i]),c},Pi=(e,t)=>e.map(e=>e.map((e,n)=>0===n||0[0]===t?e:y(e,t)).join(" ")).join(" ");function ri(e,t){const n=e.style;n&&t&&("string"==typeof t?n.cssText+=";"+t:Object.entries(t).forEach(e=>{let[t,s]=e;return n.setProperty(t,s)}))}tu=(e,t)=>Math.floor(Math.random()*(t-e+1))+e;function B0(e){let s=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};const a=s.onComplete||jt,t=new It().XMLHttpRequest,n=s.signal,o=function(){t.abort()},i=function(){n&&n.removeEventListener("abort",o),t.onerror=t.ontimeout=jt};if(n&&n.aborted)throw new uc("request");return n&&n.addEventListener("abort",o,{once:!0}),t.onreadystatechange=function(){4===t.readyState&&(i(),a(t),t.onreadystatechange=jt)},t.onerror=t.ontimeout=i,t.open("get",e,!0),t.send(),t}Jd=(e,t)=>{let n=e._findCenterFromElement();e.transformMatrix&&((e=>{if(e.transformMatrix){const{scaleX:t,scaleY:n,angle:s,skewX:o}=vt(e.transformMatrix);e.flipX=!1,e.flipY=!1,e.set(F,t),e.set(B,n),e.angle=s,e.skewX=o,e.skewY=0}})(e),n=n.transform(e.transformMatrix)),delete e.transformMatrix,t&&(e.scaleX*=t.scaleX,e.scaleY*=t.scaleY,e.cropX=t.cropX,e.cropY=t.cropY,n.x+=t.offsetLeft,n.y+=t.offsetTop,e.width=t.width,e.height=t.height),e.setPositionByOrigin(n,m,m)},V0=Object.freeze({__proto__:null,addTransformToObject:Xa,animate:oa,animateColor:m4,applyTransformToObject:Ct,calcAngleBetweenVectors:Hn,calcDimensionsMatrix:bn,calcPlaneChangeMatrix:Mt,calcVectorRotation:qi,cancelAnimFrame:W1,capValue:Xe,composeMatrix:wr,copyCanvasElement:e=>{var t;const n=K(e);return null===(t=n.getContext("2d"))||0[0]===t||t.drawImage(e,0,0),n},cos:se,createCanvasElement:ae,createImage:Dr,createRotateMatrix:lt,createScaleMatrix:gs,createSkewXMatrix:jo,createSkewYMatrix:yo,createTranslateMatrix:ht,createVector:Bn,crossProduct:xt,degreesToRadians:x,dotProduct:$i,ease:k4,enlivenObjectEnlivables:pn,enlivenObjects:Je,findScaleToCover:Ti,findScaleToFit:Di,getBoundsOfCurve:yi,getOrthonormalVector:oi,getPathSegmentsInfo:hi,getPointOnPath:Fi,getPointer:Za,getRandomInt:tu,getRegularPolygonPath:(e,t)=>{const s=2*Math.PI/e;let i=-Fe;e%2==0&&(i+=s/2);const n=new Array(e+1);for(let a=0;a<e;a++){const r=a*s+i,{x:c,y:l}=new o(se(r),Z(r)).scalarMultiply(t);n[a]=[0===a?"M":"L",c,l]}return n[e]=["Z"],n},getSmoothPathFromPoints:su,getSvgAttributes:e=>{const t=["instantiated_by_use","style","id","class"];switch(e){case"linearGradient":return t.concat(["x1","y1","x2","y2","gradientUnits","gradientTransform"]);case"radialGradient":return t.concat(["gradientUnits","gradientTransform","cx","cy","r","fx","fy","fr"]);case"stop":return t.concat(["offset","stop-color","stop-opacity"])}return t},getUnitVector:Pn,groupSVGElements:(e,t)=>e&&1===e.length?e[0]:new Et(e,t),hasStyleChanged:Ps,invertTransform:$,isBetweenVectors:ai,isIdentityMatrix:Ar,isTouchEvent:Nn,isTransparent:Ec,joinPath:Pi,loadImage:gn,magnitude:In,makeBoundingBoxFromPoints:fe,makePathSimpler:ji,matrixToSVG:ot,mergeClipPaths:(e,t)=>{var o;let s=e,n=t;s.inverted&&!n.inverted&&(s=t,n=e),So(n,null===(o=n.group)||0[0]===o?0[0]:o.calcTransformMatrix(),s.calcTransformMatrix());const i=s.inverted&&n.inverted;return i&&(s.inverted=n.inverted=!1),new Et([s],{clipPath:n,inverted:i})},multiplyTransformMatrices:O,multiplyTransformMatrixArray:bs,parsePath:Li,parsePreserveAspectRatioAttribute:wa,parseUnit:Pe,pick:qe,projectStrokeOnPoints:tc,qrDecompose:vt,radiansToDegrees:he,removeFromArray:$e,removeTransformFromObject:(e,t)=>{const n=$(t),s=O(n,e.calcOwnMatrix());Ct(e,s)},removeTransformMatrixForSvgParsing:Jd,request:B0,requestAnimFrame:_s,resetObjectTransform:Ga,rotatePoint:(e,t,n)=>e.rotate(n,t),rotateVector:si,saveObjectTransform:Ao,sendObjectToPlane:So,sendPointToPlane:ye,sendVectorToPlane:qa,setStyle:ri,sin:Z,sizeAfterTransform:Jn,string:Y1,stylesFromArray:Lr,stylesToArray:Hr,toBlob:po,toDataURL:mo,toFixed:y,transformPath:(e,t,n)=>(n&&(t=O(t,[1,0,0,1,-n.x,-n.y])),e.map(e=>{const n=[...e];for(let s=1;s<e.length-1;s+=2){const{x:o,y:i}=M({x:e[s],y:e[s+1]},t);n[s]=o,n[s+1]=i}return n})),transformPoint:M}),Qd=class extends tr{constructor(e){let{allowTouchScrolling:i=!1,containerClass:a=""}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};super(e),s(this,"upper",0[0]),s(this,"container",0[0]);const{el:t}=this.lower,n=this.createUpperCanvas();this.upper={el:n,ctx:n.getContext("2d")},this.applyCanvasStyle(t,{allowTouchScrolling:i}),this.applyCanvasStyle(n,{allowTouchScrolling:i,styles:{position:"absolute",left:"0",top:"0"}});const o=this.createContainerElement();o.classList.add(a),t.parentNode&&t.parentNode.replaceChild(o,t),o.append(t,n),this.container=o}createUpperCanvas(){const{el:t}=this.lower,e=ae();return e.className=t.className,e.classList.remove("lower-canvas"),e.classList.add("upper-canvas"),e.setAttribute("data-fabric","top"),e.style.cssText=t.style.cssText,e.setAttribute("draggable","true"),e}createContainerElement(){const e=Ze().createElement("div");return e.setAttribute("data-fabric","wrapper"),ri(e,{position:"relative"}),T4(e),e}applyCanvasStyle(e,t){const{styles:s,allowTouchScrolling:o}=t;ri(e,n(n({},s),{},{"touch-action":o?"manipulation":N})),T4(e)}setDimensions(e,t){super.setDimensions(e,t);const{el:n,ctx:s}=this.upper;ir(n,s,e,t)}setCSSDimensions(e){super.setCSSDimensions(e),Eo(this.upper.el,e),Eo(this.container,e)}cleanupDOM(e){const t=this.container,{el:n}=this.lower,{el:s}=this.upper;super.cleanupDOM(e),t.removeChild(s),t.removeChild(n),t.parentNode&&t.parentNode.replaceChild(n,t)}dispose(){super.dispose(),ue().dispose(this.upper.el),delete this.upper,delete this.container}},Ui=class _Mn extends ko{constructor(){super(...arguments),s(this,"targets",[]),s(this,"_hoveredTargets",[]),s(this,"_objectsToRender",0[0]),s(this,"_currentTransform",null),s(this,"_groupSelector",null),s(this,"contextTopDirty",!1)}static getDefaults(){return n(n({},super.getDefaults()),_Mn.ownDefaults)}get upperCanvasEl(){var e;return null===(e=this.elements.upper)||0[0]===e?0[0]:e.el}get contextTop(){var e;return null===(e=this.elements.upper)||0[0]===e?0[0]:e.ctx}get wrapperEl(){return this.elements.container}initElements(e){this.elements=new Qd(e,{allowTouchScrolling:this.allowTouchScrolling,containerClass:this.containerClass}),this._createCacheCanvas()}_onObjectAdded(e){this._objectsToRender=0[0],super._onObjectAdded(e)}_onObjectRemoved(e){this._objectsToRender=0[0],e===this._activeObject&&(this.fire("before:selection:cleared",{deselected:[e]}),this._discardActiveObject(),this.fire("selection:cleared",{deselected:[e]}),e.fire("deselected",{target:e})),e===this._hoveredTarget&&(this._hoveredTarget=0[0],this._hoveredTargets=[]),super._onObjectRemoved(e)}_onStackOrderChanged(){this._objectsToRender=0[0],super._onStackOrderChanged()}_chooseObjectsToRender(){const e=this._activeObject;return!this.preserveObjectStacking&&e?this._objects.filter(t=>!t.group&&t!==e).concat(e):this._objects}renderAll(){this.cancelRequestedRender(),this.destroyed||(!this.contextTopDirty||this._groupSelector||this.isDrawingMode||(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&(this.renderTopLayer(this.contextTop),this.hasLostContext=!1),!this._objectsToRender&&(this._objectsToRender=this._chooseObjectsToRender()),this.renderCanvas(this.getContext(),this._objectsToRender))}renderTopLayer(e){e.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(e),this.contextTopDirty=!0),e.restore()}renderTop(){const e=this.contextTop;this.clearContext(e),this.renderTopLayer(e),this.fire("after:render",{ctx:e})}setTargetFindTolerance(e){e=Math.round(e),this.targetFindTolerance=e;const t=this.getRetinaScaling(),n=Math.ceil((2*e+1)*t);this.pixelFindCanvasEl.width=this.pixelFindCanvasEl.height=n,this.pixelFindContext.scale(t,t)}isTargetTransparent(e,t,n){const o=this.targetFindTolerance,s=this.pixelFindContext;this.clearContext(s),s.save(),s.translate(-t+o,-n+o),s.transform(...this.viewportTransform);const a=e.selectionBackgroundColor;e.selectionBackgroundColor="",e.render(s),e.selectionBackgroundColor=a,s.restore();const i=Math.round(o*this.getRetinaScaling());return Ec(s,i,i,i)}_isSelectionKeyPressed(e){const t=this.selectionKey;return!!t&&(Array.isArray(t)?!!t.find(t=>!!t&&!0===e[t]):e[t])}_shouldClearSelection(e,t){const s=this.getActiveObjects(),n=this._activeObject;return!!(!t||t&&n&&s.length>1&&-1===s.indexOf(t)&&n!==t&&!this._isSelectionKeyPressed(e)||t&&!t.evented||t&&!t.selectable&&n&&n!==t)}_shouldCenterTransform(e,t,n){if(!e)return;let s;return t===As||t===F||t===B||t===jn?s=this.centeredScaling||e.centeredScaling:t===co&&(s=this.centeredRotation||e.centeredRotation),s?!n:n}_getOriginFromCorner(e,t){const n={x:e.originX,y:e.originY};return t?(["ml","tl","bl"].includes(t)?n.x=C:["mr","tr","br"].includes(t)&&(n.x=j),["tl","mt","tr"].includes(t)?n.y=so:["bl","mb","br"].includes(t)&&(n.y=P),n):n}_setupCurrentTransform(e,t,s){var r;const o=t.group?ye(this.getScenePoint(e),0[0],t.group.calcTransformMatrix()):this.getScenePoint(e),{key:c="",control:i}=t.getActiveControl()||{},h=s&&i?null===(r=i.getActionHandler(e,t,i))||0[0]===r?0[0]:r.bind(i):Ma,l=((e,t,n,s)=>{if(!t||!e)return"drag";const o=s.controls[t];return o.getActionName(n,o,s)})(s,c,e,t),d=e[this.centeredKey],a=this._shouldCenterTransform(t,l,d)?{x:m,y:m}:this._getOriginFromCorner(t,c),u={target:t,action:l,actionHandler:h,actionPerformed:!1,corner:c,scaleX:t.scaleX,scaleY:t.scaleY,skewX:t.skewX,skewY:t.skewY,offsetX:o.x-t.left,offsetY:o.y-t.top,originX:a.x,originY:a.y,ex:o.x,ey:o.y,lastX:o.x,lastY:o.y,theta:x(t.angle),width:t.width,height:t.height,shiftKey:e.shiftKey,altKey:d,original:n(n({},Ao(t)),{},{originX:a.x,originY:a.y})};this._currentTransform=u,this.fire("before:transform",{e,transform:u})}setCursor(e){this.upperCanvasEl.style.cursor=e}_drawSelection(e){const{x:l,y:d,deltaX:u,deltaY:h}=this._groupSelector,s=new o(l,d).transform(this.viewportTransform),i=new o(l+u,d+h).transform(this.viewportTransform),a=this.selectionLineWidth/2;let t=Math.min(s.x,i.x),n=Math.min(s.y,i.y),r=Math.max(s.x,i.x),c=Math.max(s.y,i.y);this.selectionColor&&(e.fillStyle=this.selectionColor,e.fillRect(t,n,r-t,c-n)),this.selectionLineWidth&&this.selectionBorderColor&&(e.lineWidth=this.selectionLineWidth,e.strokeStyle=this.selectionBorderColor,t+=a,n+=a,r-=a,c-=a,S.prototype._setLineDash.call(this,e,this.selectionDashArray),e.strokeRect(t,n,r-t,c-n))}findTarget(e){if(this.skipTargetFind)return;const n=this.getViewportPoint(e),t=this._activeObject,s=this.getActiveObjects();if(this.targets=[],t&&s.length>=1){if(t.findControl(n,Nn(e)))return t;if(s.length>1&&this.searchPossibleTargets([t],n))return t;if(t===this.searchPossibleTargets([t],n)){if(this.preserveObjectStacking){const o=this.targets;this.targets=[];const s=this.searchPossibleTargets(this._objects,n);return e[this.altSelectionKey]&&s&&s!==t?(this.targets=o,t):s}return t}}return this.searchPossibleTargets(this._objects,n)}_pointIsInObjectSelectionArea(e,t){let n=e.getCoords();const i=this.getZoom(),s=e.padding/i;if(s){const[e,t,r,c]=n,l=Math.atan2(t.y-e.y,t.x-e.x),d=se(l)*s,u=Z(l)*s,i=d+u,a=d-u;n=[new o(e.x-a,e.y-i),new o(t.x+i,t.y-a),new o(r.x+a,r.y+i),new o(c.x-i,c.y+a)]}return Kt.isPointInPolygon(t,n)}_checkTarget(e,t){if(e&&e.visible&&e.evented&&this._pointIsInObjectSelectionArea(e,ye(t,0[0],this.viewportTransform))){if(!this.perPixelTargetFind&&!e.perPixelTargetFind||e.isEditing)return!0;if(!this.isTargetTransparent(e,t.x,t.y))return!0}return!1}_searchPossibleTargets(e,t){let n=e.length;for(;n--;){const s=e[n];if(this._checkTarget(s,t)){if(Os(s)&&s.subTargetCheck){const e=this._searchPossibleTargets(s._objects,t);e&&this.targets.push(e)}return s}}}searchPossibleTargets(e,t){const n=this._searchPossibleTargets(e,t);if(n&&Os(n)&&n.interactive&&this.targets[0]){const e=this.targets;for(let t=e.length-1;t>0;t--){const n=e[t];if(!Os(n)||!n.interactive)return n}return e[0]}return n}getViewportPoint(e){return this._pointer?this._pointer:this.getPointer(e,!0)}getScenePoint(e){return this._absolutePointer?this._absolutePointer:this.getPointer(e)}getPointer(e){let c=arguments.length>1&&0[0]!==arguments[1]&&arguments[1];const a=this.upperCanvasEl,t=a.getBoundingClientRect();let n=Za(e),s=t.width||0,i=t.height||0;s&&i||(P in t&&so in t&&(i=Math.abs(t.top-t.bottom)),C in t&&j in t&&(s=Math.abs(t.right-t.left))),this.calcOffset(),n.x=n.x-this._offset.left,n.y=n.y-this._offset.top,c||(n=ye(n,0[0],this.viewportTransform));const r=this.getRetinaScaling();1!==r&&(n.x/=r,n.y/=r);const l=0===s||0===i?new o(1,1):new o(a.width/s,a.height/i);return n.multiply(l)}_setDimensionsImpl(e,t){this._resetTransformEventData(),super._setDimensionsImpl(e,t),this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(this.contextTop)}_createCacheCanvas(){this.pixelFindCanvasEl=ae(),this.pixelFindContext=this.pixelFindCanvasEl.getContext("2d",{willReadFrequently:!0}),this.setTargetFindTolerance(this.targetFindTolerance)}getTopContext(){return this.elements.upper.ctx}getSelectionContext(){return this.elements.upper.ctx}getSelectionElement(){return this.elements.upper.el}getActiveObject(){return this._activeObject}getActiveObjects(){const e=this._activeObject;return Ke(e)?e.getObjects():e?[e]:[]}_fireSelectionEvents(e,t){let o=!1,n=!1;const s=this.getActiveObjects(),i=[],a=[];e.forEach(e=>{s.includes(e)||(o=!0,e.fire("deselected",{e:t,target:e}),a.push(e))}),s.forEach(n=>{e.includes(n)||(o=!0,n.fire("selected",{e:t,target:n}),i.push(n))}),e.length>0&&s.length>0?(n=!0,o&&this.fire("selection:updated",{e:t,selected:i,deselected:a})):s.length>0?(n=!0,this.fire("selection:created",{e:t,selected:i})):e.length>0&&(n=!0,this.fire("selection:cleared",{e:t,deselected:a})),n&&(this._objectsToRender=0[0])}setActiveObject(e,t){const n=this.getActiveObjects(),s=this._setActiveObject(e,t);return this._fireSelectionEvents(n,t),s}_setActiveObject(e,t){const n=this._activeObject;return n!==e&&!(!this._discardActiveObject(t,e)&&this._activeObject)&&!e.onSelect({e:t})&&(this._activeObject=e,Ke(e)&&n!==e&&e.set("canvas",this),e.setCoords(),!0)}_discardActiveObject(e,t){const n=this._activeObject;return!!n&&!n.onDeselect({e,object:t})&&(this._currentTransform&&this._currentTransform.target===n&&this.endCurrentTransform(e),Ke(n)&&n===this._hoveredTarget&&(this._hoveredTarget=0[0]),this._activeObject=0[0],!0)}discardActiveObject(e){const t=this.getActiveObjects(),n=this.getActiveObject();t.length&&this.fire("before:selection:cleared",{e,deselected:[n]});const s=this._discardActiveObject(e);return this._fireSelectionEvents(t,e),s}endCurrentTransform(e){const t=this._currentTransform;this._finalizeCurrentTransform(e),t&&t.target&&(t.target.isMoving=!1),this._currentTransform=null}_finalizeCurrentTransform(e){const n=this._currentTransform,t=n.target,s={e,target:t,transform:n,action:n.action};t._scaling&&(t._scaling=!1),t.setCoords(),n.actionPerformed&&(this.fire("object:modified",s),t.fire(ks,s))}setViewportTransform(e){super.setViewportTransform(e);const t=this._activeObject;t&&t.setCoords()}destroy(){const e=this._activeObject;Ke(e)&&(e.removeAll(),e.dispose()),delete this._activeObject,super.destroy(),this.pixelFindContext=null,this.pixelFindCanvasEl=0[0]}clear(){this.discardActiveObject(),this._activeObject=0[0],this.clearContext(this.contextTop),super.clear()}drawControls(e){const t=this._activeObject;t&&t._renderControls(e)}_toObject(e,t,n){const s=this._realizeGroupTransformOnObject(e),o=super._toObject(e,t,n);return e.set(s),o}_realizeGroupTransformOnObject(e){const{group:t}=e;if(t&&Ke(t)&&this._activeObject===t){const n=qe(e,["angle","flipX","flipY",j,F,B,rt,Ot,P]);return Xa(e,t.calcOwnMatrix()),n}return{}}_setSVGObject(e,t,n){const s=this._realizeGroupTransformOnObject(t);super._setSVGObject(e,t,n),t.set(s)}},s(Ui,"ownDefaults",{uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",selection:!0,selectionKey:"shiftKey",selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",notAllowedCursor:"not-allowed",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,enablePointerEvents:!1,containerClass:"canvas-container",preserveObjectStacking:!1}),Xd=class{constructor(e){s(this,"targets",[]),s(this,"__disposer",0[0]);const t=()=>{const{hiddenTextarea:t}=e.getActiveObject()||{};t&&t.focus()},n=e.upperCanvasEl;n.addEventListener("click",t),this.__disposer=()=>n.removeEventListener("click",t)}exitTextEditing(){this.target=0[0],this.targets.forEach(e=>{e.isEditing&&e.exitEditing()})}add(e){this.targets.push(e)}remove(e){this.unregister(e),$e(this.targets,e)}register(e){this.target=e}unregister(e){e===this.target&&(this.target=0[0])}onMouseMove(e){var t;(null===(t=this.target)||0[0]===t?0[0]:t.isEditing)&&this.target.updateSelectionOnMouseMove(e)}clear(){this.targets=[],this.target=0[0]}dispose(){this.clear(),this.__disposer(),delete this.__disposer}},Gd=["target","oldTarget","fireCanvas","e"],I={passive:!1},mt=(e,t)=>{const n=e.getViewportPoint(t),s=e.getScenePoint(t);return{viewportPoint:n,scenePoint:s,pointer:n,absolutePointer:s}},ze=function(e){for(var n=arguments.length,s=new Array(n>1?n-1:0),t=1;t<n;t++)s[t-1]=arguments[t];return e.addEventListener(...s)},G=function(e){for(var n=arguments.length,s=new Array(n>1?n-1:0),t=1;t<n;t++)s[t-1]=arguments[t];return e.removeEventListener(...s)},Yd={mouse:{in:"over",out:"out",targetIn:"mouseover",targetOut:"mouseout",canvasIn:"mouse:over",canvasOut:"mouse:out"},drag:{in:"enter",out:"leave",targetIn:"dragenter",targetOut:"dragleave",canvasIn:"drag:enter",canvasOut:"drag:leave"}},Ji=class extends Ui{constructor(e){super(e,arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{}),s(this,"_isClick",0[0]),s(this,"textEditingManager",new Xd(this)),["_onMouseDown","_onTouchStart","_onMouseMove","_onMouseUp","_onTouchEnd","_onResize","_onMouseWheel","_onMouseOut","_onMouseEnter","_onContextMenu","_onClick","_onDragStart","_onDragEnd","_onDragProgress","_onDragOver","_onDragEnter","_onDragLeave","_onDrop"].forEach(e=>{this[e]=this[e].bind(this)}),this.addOrRemove(ze,"add")}_getEventPrefix(){return this.enablePointerEvents?"pointer":"mouse"}addOrRemove(e){const n=this.upperCanvasEl,s=this._getEventPrefix();e(ar(n),"resize",this._onResize),e(n,s+"down",this._onMouseDown),e(n,"".concat(s,"move"),this._onMouseMove,I),e(n,"".concat(s,"out"),this._onMouseOut),e(n,"".concat(s,"enter"),this._onMouseEnter),e(n,"wheel",this._onMouseWheel),e(n,"contextmenu",this._onContextMenu),e(n,"click",this._onClick),e(n,"dblclick",this._onClick),e(n,"dragstart",this._onDragStart),e(n,"dragend",this._onDragEnd),e(n,"dragover",this._onDragOver),e(n,"dragenter",this._onDragEnter),e(n,"dragleave",this._onDragLeave),e(n,"drop",this._onDrop),this.enablePointerEvents||e(n,"touchstart",this._onTouchStart,I)}removeListeners(){this.addOrRemove(G,"remove");const t=this._getEventPrefix(),e=ne(this.upperCanvasEl);G(e,"".concat(t,"up"),this._onMouseUp),G(e,"touchend",this._onTouchEnd,I),G(e,"".concat(t,"move"),this._onMouseMove,I),G(e,"touchmove",this._onMouseMove,I),clearTimeout(this._willAddMouseDown)}_onMouseWheel(e){this.__onMouseWheel(e)}_onMouseOut(e){const s=this._hoveredTarget,t=n({e},mt(this,e));this.fire("mouse:out",n(n({},t),{},{target:s})),this._hoveredTarget=0[0],s&&s.fire("mouseout",n({},t)),this._hoveredTargets.forEach(e=>{this.fire("mouse:out",n(n({},t),{},{target:e})),e&&e.fire("mouseout",n({},t))}),this._hoveredTargets=[]}_onMouseEnter(e){this._currentTransform||this.findTarget(e)||(this.fire("mouse:over",n({e},mt(this,e))),this._hoveredTarget=0[0],this._hoveredTargets=[])}_onDragStart(e){this._isClick=!1;const t=this.getActiveObject();if(t&&t.onDragStart(e)){this._dragSource=t;const n={e,target:t};return this.fire("dragstart",n),t.fire("dragstart",n),void ze(this.upperCanvasEl,"drag",this._onDragProgress)}Qa(e)}_renderDragEffects(e,t,n){let o=!1;const i=this._dropTarget;i&&i!==t&&i!==n&&(i.clearContextTop(),o=!0),t==null||t.clearContextTop(),n!==t&&(n==null||n.clearContextTop());const s=this.contextTop;s.save(),s.transform(...this.viewportTransform),t&&(s.save(),t.transform(s),t.renderDragSourceEffect(e),s.restore(),o=!0),n&&(s.save(),n.transform(s),n.renderDropTargetEffect(e),s.restore(),o=!0),s.restore(),o&&(this.contextTopDirty=!0)}_onDragEnd(e){const t=!!e.dataTransfer&&e.dataTransfer.dropEffect!==N,s=t?this._activeObject:0[0],n={e,target:this._dragSource,subTargets:this.targets,dragSource:this._dragSource,didDrop:t,dropTarget:s};G(this.upperCanvasEl,"drag",this._onDragProgress),this.fire("dragend",n),this._dragSource&&this._dragSource.fire("dragend",n),delete this._dragSource,this._onMouseUp(e)}_onDragProgress(e){const t={e,target:this._dragSource,dragSource:this._dragSource,dropTarget:this._draggedoverTarget};this.fire("drag",t),this._dragSource&&this._dragSource.fire("drag",t)}findDragTargets(e){return this.targets=[],{target:this._searchPossibleTargets(this._objects,this.getViewportPoint(e)),targets:[...this.targets]}}_onDragOver(e){const o="dragover",{target:t,targets:i}=this.findDragTargets(e),a=this._dragSource,n={e,target:t,subTargets:i,dragSource:a,canDrop:!1,dropTarget:0[0]};let s;this.fire(o,n),this._fireEnterLeaveEvents(t,n),t&&(t.canDrop(e)&&(s=t),t.fire(o,n));for(let t=0;t<i.length;t++){const a=i[t];a.canDrop(e)&&(s=a),a.fire(o,n)}this._renderDragEffects(e,a,s),this._dropTarget=s}_onDragEnter(e){const{target:t,targets:s}=this.findDragTargets(e),n={e,target:t,subTargets:s,dragSource:this._dragSource};this.fire("dragenter",n),this._fireEnterLeaveEvents(t,n)}_onDragLeave(e){const t={e,target:this._draggedoverTarget,subTargets:this.targets,dragSource:this._dragSource};this.fire("dragleave",t),this._fireEnterLeaveEvents(0[0],t),this._renderDragEffects(e,this._dragSource),this._dropTarget=0[0],this.targets=[],this._hoveredTargets=[]}_onDrop(e){const{target:s,targets:o}=this.findDragTargets(e),t=this._basicEventHandler("drop:before",n({e,target:s,subTargets:o,dragSource:this._dragSource},mt(this,e)));t.didDrop=!1,t.dropTarget=0[0],this._basicEventHandler("drop",t),this.fire("drop:after",t)}_onContextMenu(e){const t=this.findTarget(e),n=this.targets||[],s=this._basicEventHandler("contextmenu:before",{e,target:t,subTargets:n});return this.stopContextMenu&&Qa(e),this._basicEventHandler("contextmenu",s),!1}_onClick(e){const t=e.detail;t>3||t<2||(this._cacheTransformEventData(e),2==t&&"dblclick"===e.type&&this._handleEvent(e,"dblclick"),3==t&&this._handleEvent(e,"tripleclick"),this._resetTransformEventData())}getPointerId(e){const t=e.changedTouches;return t?t[0]&&t[0].identifier:this.enablePointerEvents?e.pointerId:-1}_isMainEvent(e){return!0===e.isPrimary||!1!==e.isPrimary&&("touchend"===e.type&&0===e.touches.length||!e.changedTouches||e.changedTouches[0].identifier===this.mainTouchId)}_onTouchStart(e){let t=!this.allowTouchScrolling;const n=this._activeObject;0[0]===this.mainTouchId&&(this.mainTouchId=this.getPointerId(e)),this.__onMouseDown(e),(this.isDrawingMode||n&&this._target===n)&&(t=!0),t&&e.preventDefault(),this._resetTransformEventData();const s=this.upperCanvasEl,i=this._getEventPrefix(),o=ne(s);ze(o,"touchend",this._onTouchEnd,I),t&&ze(o,"touchmove",this._onMouseMove,I),G(s,"".concat(i,"down"),this._onMouseDown)}_onMouseDown(e){this.__onMouseDown(e),this._resetTransformEventData();const n=this.upperCanvasEl,t=this._getEventPrefix();G(n,"".concat(t,"move"),this._onMouseMove,I);const s=ne(n);ze(s,"".concat(t,"up"),this._onMouseUp),ze(s,"".concat(t,"move"),this._onMouseMove,I)}_onTouchEnd(e){if(e.touches.length>0)return;this.__onMouseUp(e),this._resetTransformEventData(),delete this.mainTouchId;const n=this._getEventPrefix(),t=ne(this.upperCanvasEl);G(t,"touchend",this._onTouchEnd,I),G(t,"touchmove",this._onMouseMove,I),this._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout(()=>{ze(this.upperCanvasEl,"".concat(n,"down"),this._onMouseDown),this._willAddMouseDown=0},400)}_onMouseUp(e){this.__onMouseUp(e),this._resetTransformEventData();const n=this.upperCanvasEl,t=this._getEventPrefix();if(this._isMainEvent(e)){const e=ne(this.upperCanvasEl);G(e,"".concat(t,"up"),this._onMouseUp),G(e,"".concat(t,"move"),this._onMouseMove,I),ze(n,"".concat(t,"move"),this._onMouseMove,I)}}_onMouseMove(e){const t=this.getActiveObject();!this.allowTouchScrolling&&(!t||!t.shouldStartDragging(e))&&e.preventDefault&&e.preventDefault(),this.__onMouseMove(e)}_onResize(){this.calcOffset(),this._resetTransformEventData()}_shouldRender(e){const t=this.getActiveObject();return!!t!=!!e||t&&e&&t!==e}__onMouseUp(e){var i;this._cacheTransformEventData(e),this._handleEvent(e,"up:before");const n=this._currentTransform,r=this._isClick,t=this._target,{button:a}=e;if(a)return(this.fireMiddleClick&&1===a||this.fireRightClick&&2===a)&&this._handleEvent(e,"up"),void this._resetTransformEventData();if(this.isDrawingMode&&this._isCurrentlyDrawing)return void this._onMouseUpInDrawingMode(e);if(!this._isMainEvent(e))return;let s,c,o=!1;if(n&&(this._finalizeCurrentTransform(e),o=n.actionPerformed),!r){const n=t===this._activeObject;this.handleSelection(e),o||(o=this._shouldRender(t)||!n&&t===this._activeObject)}if(t){const a=t.findControl(this.getViewportPoint(e),Nn(e)),{key:r,control:i}=a||{};if(c=r,t.selectable&&t!==this._activeObject&&"up"===t.activeOn)this.setActiveObject(t,e),o=!0;else if(i){const o=i.getMouseUpHandler(e,t,i);o&&(s=this.getScenePoint(e),o.call(i,e,n,s.x,s.y))}t.isMoving=!1}if(n&&(n.target!==t||n.corner!==c)){const t=n.target&&n.target.controls[n.corner],o=t&&t.getMouseUpHandler(e,n.target,t);s=s||this.getScenePoint(e),o&&o.call(t,e,n,s.x,s.y)}this._setCursorFromEvent(e,t),this._handleEvent(e,"up"),this._groupSelector=null,this._currentTransform=null,t&&(t.__corner=0[0]),o?this.requestRenderAll():r||null!==(i=this._activeObject)&&0[0]!==i&&i.isEditing||this.renderTop()}_basicEventHandler(e,t){const{target:n,subTargets:s=[]}=t;this.fire(e,t),n&&n.fire(e,t);for(let o=0;o<s.length;o++)s[o]!==n&&s[o].fire(e,t);return t}_handleEvent(e,t,s){const o=this._target,i=this.targets||[],a=n(n(n({e,target:o,subTargets:i},mt(this,e)),{},{transform:this._currentTransform},"up:before"===t||"up"===t?{isClick:this._isClick,currentTarget:this.findTarget(e),currentSubTargets:this.targets}:{}),"down:before"===t||"down"===t?s:{});this.fire("mouse:".concat(t),a),o&&o.fire("mouse".concat(t),a);for(let e=0;e<i.length;e++)i[e]!==o&&i[e].fire("mouse".concat(t),a)}_onMouseDownInDrawingMode(e){this._isCurrentlyDrawing=!0,this.getActiveObject()&&(this.discardActiveObject(e),this.requestRenderAll());const t=this.getScenePoint(e);this.freeDrawingBrush&&this.freeDrawingBrush.onMouseDown(t,{e,pointer:t}),this._handleEvent(e,"down",{alreadySelected:!1})}_onMouseMoveInDrawingMode(e){if(this._isCurrentlyDrawing){const t=this.getScenePoint(e);this.freeDrawingBrush&&this.freeDrawingBrush.onMouseMove(t,{e,pointer:t})}this.setCursor(this.freeDrawingCursor),this._handleEvent(e,"move")}_onMouseUpInDrawingMode(e){const t=this.getScenePoint(e);this.freeDrawingBrush?this._isCurrentlyDrawing=!!this.freeDrawingBrush.onMouseUp({e,pointer:t}):this._isCurrentlyDrawing=!1,this._handleEvent(e,"up")}__onMouseDown(e){this._isClick=!0,this._cacheTransformEventData(e),this._handleEvent(e,"down:before");let t=this._target,n=!!t&&t===this._activeObject;const{button:s}=e;if(s)return(this.fireMiddleClick&&1===s||this.fireRightClick&&2===s)&&this._handleEvent(e,"down",{alreadySelected:n}),void this._resetTransformEventData();if(this.isDrawingMode)return void this._onMouseDownInDrawingMode(e);if(!this._isMainEvent(e))return;if(this._currentTransform)return;let o=this._shouldRender(t),i=!1;if(this.handleMultiSelection(e,t)?(t=this._activeObject,i=!0,o=!0):this._shouldClearSelection(e,t)&&this.discardActiveObject(e),this.selection&&(!t||!t.selectable&&!t.isEditing&&t!==this._activeObject)){const t=this.getScenePoint(e);this._groupSelector={x:t.x,y:t.y,deltaY:0,deltaX:0}}if(n=!!t&&t===this._activeObject,t){t.selectable&&"down"===t.activeOn&&this.setActiveObject(t,e);const s=t.findControl(this.getViewportPoint(e),Nn(e));if(t===this._activeObject&&(s||!i)){this._setupCurrentTransform(e,t,n);const o=s?s.control:0[0],i=this.getScenePoint(e),a=o&&o.getMouseDownHandler(e,t,o);a&&a.call(o,e,this._currentTransform,i.x,i.y)}}o&&(this._objectsToRender=0[0]),this._handleEvent(e,"down",{alreadySelected:n}),o&&this.requestRenderAll()}_resetTransformEventData(){this._target=this._pointer=this._absolutePointer=0[0]}_cacheTransformEventData(e){this._resetTransformEventData(),this._pointer=this.getViewportPoint(e),this._absolutePointer=ye(this._pointer,0[0],this.viewportTransform),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(e)}__onMouseMove(e){if(this._isClick=!1,this._cacheTransformEventData(e),this._handleEvent(e,"move:before"),this.isDrawingMode)return void this._onMouseMoveInDrawingMode(e);if(!this._isMainEvent(e))return;const t=this._groupSelector;if(t){const n=this.getScenePoint(e);t.deltaX=n.x-t.x,t.deltaY=n.y-t.y,this.renderTop()}else if(this._currentTransform)this._transformObject(e);else{const t=this.findTarget(e);this._setCursorFromEvent(e,t),this._fireOverOutEvents(e,t)}this.textEditingManager.onMouseMove(e),this._handleEvent(e,"move"),this._resetTransformEventData()}_fireOverOutEvents(e,t){const o=this._hoveredTarget,n=this._hoveredTargets,s=this.targets,i=Math.max(n.length,s.length);this.fireSyntheticInOutEvents("mouse",{e,target:t,oldTarget:o,fireCanvas:!0});for(let t=0;t<i;t++)this.fireSyntheticInOutEvents("mouse",{e,target:s[t],oldTarget:n[t]});this._hoveredTarget=t,this._hoveredTargets=this.targets.concat()}_fireEnterLeaveEvents(e,t){const i=this._draggedoverTarget,s=this._hoveredTargets,o=this.targets,a=Math.max(s.length,o.length);this.fireSyntheticInOutEvents("drag",n(n({},t),{},{target:e,oldTarget:i,fireCanvas:!0}));for(let e=0;e<a;e++)this.fireSyntheticInOutEvents("drag",n(n({},t),{},{target:o[e],oldTarget:s[e]}));this._draggedoverTarget=e}fireSyntheticInOutEvents(e,t){let{target:s,oldTarget:o,fireCanvas:a,e:i}=t,r=w(t,Gd);const{targetIn:l,targetOut:d,canvasIn:u,canvasOut:h}=Yd[e],c=o!==s;if(o&&c){const e=n(n({},r),{},{e:i,target:o,nextTarget:s},mt(this,i));a&&this.fire(h,e),o.fire(d,e)}if(s&&c){const e=n(n({},r),{},{e:i,target:s,previousTarget:o},mt(this,i));a&&this.fire(u,e),s.fire(l,e)}}__onMouseWheel(e){this._cacheTransformEventData(e),this._handleEvent(e,"wheel"),this._resetTransformEventData()}_transformObject(e){const n=this.getScenePoint(e),t=this._currentTransform,s=t.target,o=s.group?ye(n,0[0],s.group.calcTransformMatrix()):n;t.shiftKey=e.shiftKey,t.altKey=!!this.centeredKey&&e[this.centeredKey],this._performTransformAction(e,t,o),t.actionPerformed&&this.requestRenderAll()}_performTransformAction(e,t,n){const{action:i,actionHandler:o,target:a}=t,s=!!o&&o(e,t,n.x,n.y);s&&a.setCoords(),"drag"===i&&s&&(t.target.isMoving=!0,this.setCursor(t.target.moveCursor||this.moveCursor)),t.actionPerformed=t.actionPerformed||s}_setCursorFromEvent(e,t){if(!t)return void this.setCursor(this.defaultCursor);let n=t.hoverCursor||this.hoverCursor;const s=Ke(this._activeObject)?this._activeObject:null,o=(!s||t.group!==s)&&t.findControl(this.getViewportPoint(e));if(o){const n=o.control;this.setCursor(n.cursorStyleHandler(e,n,t))}else t.subTargetCheck&&this.targets.concat().reverse().map(e=>{n=e.hoverCursor||n}),this.setCursor(n)}handleMultiSelection(e,t){const n=this._activeObject,s=Ke(n);if(n&&this._isSelectionKeyPressed(e)&&this.selection&&t&&t.selectable&&(n!==t||s)&&(s||!t.isDescendantOf(n)&&!n.isDescendantOf(t))&&!t.onSelect({e})&&!n.getActiveControl()){if(s){const s=n.getObjects();if(t===n){const n=this.getViewportPoint(e);if(!(t=this.searchPossibleTargets(s,n)||this.searchPossibleTargets(this._objects,n))||!t.selectable)return!1}t.group===n?(n.remove(t),this._hoveredTarget=t,this._hoveredTargets=[...this.targets],1===n.size()&&this._setActiveObject(n.item(0),e)):(n.multiSelectAdd(t),this._hoveredTarget=n,this._hoveredTargets=[...this.targets]),this._fireSelectionEvents(s,e)}else{n.isEditing&&n.exitEditing();const s=new(c.getClass("ActiveSelection"))([],{canvas:this});s.multiSelectAdd(n,t),this._hoveredTarget=s,this._setActiveObject(s,e),this._fireSelectionEvents([n],e)}return!0}return!1}handleSelection(e){if(!this.selection||!this._groupSelector)return!1;const{x:l,y:d,deltaX:u,deltaY:h}=this._groupSelector,n=new o(l,d),i=n.add(new o(u,h)),a=n.min(i),r=n.max(i).subtract(a),t=this.collectObjects({left:a.x,top:a.y,width:r.x,height:r.y},{includeIntersecting:!this.selectionFullyContained}),s=n.eq(i)?t[0]?[t[0]]:[]:t.length>1?t.filter(t=>!t.onSelect({e})).reverse():t;if(1===s.length)this.setActiveObject(s[0],e);else if(s.length>1){const t=c.getClass("ActiveSelection");this.setActiveObject(new t(s,{canvas:this}),e)}return this._groupSelector=null,!0}clear(){this.textEditingManager.clear(),super.clear()}destroy(){this.removeListeners(),this.textEditingManager.dispose(),super.destroy()}},ea={x1:0,y1:0,x2:0,y2:0},qd=n(n({},ea),{},{r1:0,r2:0}),ct=(e,t)=>isNaN(e)&&"number"==typeof t?t:e,Kd=/^(\d+\.\d+)%|(\d+)%$/;function Ud(e){return e&&Kd.test(e)}function Wd(e,t){const n="number"==typeof e?e:"string"==typeof e?parseFloat(e)/(Ud(e)?100:1):NaN;return Xe(0,ct(n,t),1)}$d=/\s*;\s*/,Vd=/\s*:\s*/;function $0(e,t){let n,s;const o=e.getAttribute("style");if(o){const e=o.split($d);""===e[e.length-1]&&e.pop();for(let t=e.length;t--;){const[o,i]=e[t].split(Vd).map(e=>e.trim());"stop-color"===o?n=i:"stop-opacity"===o&&(s=i)}}const i=new U(n||e.getAttribute("stop-color")||"rgb(0,0,0)");return{offset:Wd(e.getAttribute("offset"),0),color:i.toRgb(),opacity:ct(parseFloat(s||e.getAttribute("stop-opacity")||""),1)*i.getAlpha()*t}}function W0(e,t){const n=[],s=e.getElementsByTagName("stop"),o=Wd(t,1);for(let e=s.length;e--;)n.push($0(s[e],o));return n}function Hd(e){return"linearGradient"===e.nodeName||"LINEARGRADIENT"===e.nodeName?"linear":"radial"}function Pd(e){return"userSpaceOnUse"===e.getAttribute("gradientUnits")?"pixels":"percentage"}function le(e,t){return e.getAttribute(t)}function U0(e,t){return function(e,t){let n,{width:s,height:o,gradientUnits:i}=t;return Object.keys(e).reduce((t,a)=>{const r=e[a];return"Infinity"===r?n=1:"-Infinity"===r?n=0:(n="string"==typeof r?parseFloat(r):r,"string"==typeof r&&Ud(r)&&(n*=.01,"pixels"===i&&("x1"!==a&&"x2"!==a&&"r2"!==a||(n*=s),"y1"!==a&&"y2"!==a||(n*=o)))),t[a]=n,t},{})}("linear"===Hd(e)?function(e){return{x1:le(e,"x1")||0,y1:le(e,"y1")||0,x2:le(e,"x2")||"100%",y2:le(e,"y2")||0}}(e):function(e){return{x1:le(e,"fx")||le(e,"cx")||"50%",y1:le(e,"fy")||le(e,"cy")||"50%",r1:0,x2:le(e,"cx")||"50%",y2:le(e,"cy")||"50%",r2:le(e,"r")||"50%"}}(e),n(n({},t),{},{gradientUnits:Pd(e)}))}Un=class{constructor(e){const{type:t="linear",gradientUnits:o="pixels",coords:i={},colorStops:a=[],offsetX:r=0,offsetY:c=0,gradientTransform:l,id:s}=e||{};Object.assign(this,{type:t,gradientUnits:o,coords:n(n({},"radial"===t?qd:ea),i),colorStops:a,offsetX:r,offsetY:c,gradientTransform:l,id:s?"".concat(s,"_").concat(Se()):Se()})}addColorStop(e){for(const t in e){const n=new U(e[t]);this.colorStops.push({offset:parseFloat(t),color:n.toRgb(),opacity:n.getAlpha()})}return this}toObject(e){return n(n({},qe(this,e)),{},{type:this.type,coords:n({},this.coords),colorStops:this.colorStops.map(e=>n({},e)),offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform?[...this.gradientTransform]:0[0]})}toSVG(e){let{additionalTransform:r}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};const t=[],a=this.gradientTransform?this.gradientTransform.concat():D.concat(),c="pixels"===this.gradientUnits?"userSpaceOnUse":"objectBoundingBox",s=this.colorStops.map(e=>n({},e)).sort((e,t)=>e.offset-t.offset);let o=-this.offsetX,i=-this.offsetY;var l;"objectBoundingBox"===c?(o/=e.width,i/=e.height):(o+=e.width/2,i+=e.height/2),(l=e)&&"function"==typeof l._renderPathCommands&&"percentage"!==this.gradientUnits&&(o-=e.pathOffset.x,i-=e.pathOffset.y),a[4]-=o,a[5]-=i;const d=['id="SVGID_'.concat(this.id,'"'),'gradientUnits="'.concat(c,'"'),'gradientTransform="'.concat(r?r+" ":"").concat(ot(a),'"'),""].join(" ");if("linear"===this.type){const{x1:e,y1:n,x2:s,y2:o}=this.coords;t.push("<linearGradient ",d,' x1="',e,'" y1="',n,'" x2="',s,'" y2="',o,`">
`)}else if("radial"===this.type){const{x1:i,y1:a,x2:r,y2:c,r1:n,r2:o}=this.coords,e=n>o;t.push("<radialGradient ",d,' cx="',e?i:r,'" cy="',e?a:c,'" r="',e?n:o,'" fx="',e?r:i,'" fy="',e?c:a,`">
`),e&&(s.reverse(),s.forEach(e=>{e.offset=1-e.offset}));const l=Math.min(n,o);if(l>0){const e=l/Math.max(n,o);s.forEach(t=>{t.offset+=e*(1-t.offset)})}}return s.forEach(e=>{let{color:s,offset:o,opacity:n}=e;t.push("<stop ",'offset="',100*o+"%",'" style="stop-color:',s,0[0]!==n?";stop-opacity: "+n:";",`"/>
`)}),t.push("linear"===this.type?"</linearGradient>":"</radialGradient>",`
`),t.join("")}toLive(e){const{x1:t,y1:n,x2:s,y2:o,r1:a,r2:r}=this.coords,i="linear"===this.type?e.createLinearGradient(t,n,s,o):e.createRadialGradient(t,n,a,s,o,r);return this.colorStops.forEach(e=>{let{color:t,opacity:n,offset:s}=e;i.addColorStop(s,0[0]!==n?new U(t).setAlpha(n).toRgba():t)}),i}static async fromObject(e){const{colorStops:t,gradientTransform:s}=e;return new this(n(n({},e),{},{colorStops:t?t.map(e=>n({},e)):0[0],gradientTransform:s?[...s]:0[0]}))}static fromElement(e,t,s){const o=Pd(e),i=t._findCenterFromElement();return new this(n({id:e.getAttribute("id")||0[0],type:Hd(e),coords:U0(e,{width:s.viewBoxWidth||s.width,height:s.viewBoxHeight||s.height}),colorStops:W0(e,s.opacity),gradientUnits:o,gradientTransform:fa(e.getAttribute("gradientTransform")||"")},"pixels"===o?{offsetX:t.width/2-i.x,offsetY:t.height/2-i.y}:{offsetX:0,offsetY:0}))}},s(Un,"type","Gradient"),c.setClass(Un,"gradient"),c.setClass(Un,"linear"),c.setClass(Un,"radial"),Ld=["type","source","patternTransform"],Po=class{get type(){return"pattern"}set type(e){Ae("warn","Setting type has no effect",e)}constructor(e){s(this,"repeat","repeat"),s(this,"offsetX",0),s(this,"offsetY",0),s(this,"crossOrigin",""),this.id=Se(),Object.assign(this,e)}isImageSource(){return!!this.source&&"string"==typeof this.source.src}isCanvasSource(){return!!this.source&&!!this.source.toDataURL}sourceToString(){return this.isImageSource()?this.source.src:this.isCanvasSource()?this.source.toDataURL():""}toLive(e){return this.source&&(!this.isImageSource()||this.source.complete&&0!==this.source.naturalWidth&&0!==this.source.naturalHeight)?e.createPattern(this.source,this.repeat):null}toObject(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];const{repeat:t,crossOrigin:s}=this;return n(n({},qe(this,e)),{},{type:"pattern",source:this.sourceToString(),repeat:t,crossOrigin:s,offsetX:y(this.offsetX,b.NUM_FRACTION_DIGITS),offsetY:y(this.offsetY,b.NUM_FRACTION_DIGITS),patternTransform:this.patternTransform?[...this.patternTransform]:null})}toSVG(e){let{width:s,height:o}=e;const{source:t,repeat:n,id:r}=this,i=ct(this.offsetX/s,0),a=ct(this.offsetY/o,0),c="repeat-y"===n||"no-repeat"===n?1+Math.abs(i||0):ct(t.width/s,0),l="repeat-x"===n||"no-repeat"===n?1+Math.abs(a||0):ct(t.height/o,0);return['<pattern id="SVGID_'.concat(r,'" x="').concat(i,'" y="').concat(a,'" width="').concat(c,'" height="').concat(l,'">'),'<image x="0" y="0" width="'.concat(t.width,'" height="').concat(t.height,'" xlink:href="').concat(this.sourceToString(),'"></image>'),"</pattern>",""].join(`
`)}static async fromObject(e,t){let{type:r,source:i,patternTransform:s}=e,o=w(e,Ld);const a=await gn(i,n(n({},t),{},{crossOrigin:o.crossOrigin}));return new this(n(n({},o),{},{patternTransform:s&&s.slice(0),source:a}))}},s(Po,"type","Pattern"),c.setClass(Po),c.setClass(Po,"pattern"),Nd=["path","left","top"],Dd=["d"],tn=class _ro extends S{constructor(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{},{path:i,left:n,top:s}=t,o=w(t,Nd);super(),Object.assign(this,_ro.ownDefaults),this.setOptions(o),this._setPath(e||[],!0),"number"==typeof n&&this.set(j,n),"number"==typeof s&&this.set(P,s)}_setPath(e,t){this.path=ji(Array.isArray(e)?e:Li(e)),this.setBoundingBox(t)}_findCenterFromElement(){const e=this._calcBoundsFromPath();return new o(e.left+e.width/2,e.top+e.height/2)}_renderPathCommands(e){const t=-this.pathOffset.x,n=-this.pathOffset.y;e.beginPath();for(const s of this.path)switch(s[0]){case"L":e.lineTo(s[1]+t,s[2]+n);break;case"M":e.moveTo(s[1]+t,s[2]+n);break;case"C":e.bezierCurveTo(s[1]+t,s[2]+n,s[3]+t,s[4]+n,s[5]+t,s[6]+n);break;case"Q":e.quadraticCurveTo(s[1]+t,s[2]+n,s[3]+t,s[4]+n);break;case"Z":e.closePath()}}_render(e){this._renderPathCommands(e),this._renderPaintInOrder(e)}toString(){return"#<Path (".concat(this.complexity(),'): { "top": ').concat(this.top,', "left": ').concat(this.left," }>")}toObject(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];return n(n({},super.toObject(e)),{},{path:this.path.map(e=>e.slice())})}toDatalessObject(){let t=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];const e=this.toObject(t);return this.sourcePath&&(delete e.path,e.sourcePath=this.sourcePath),e}_toSVG(){const e=Pi(this.path,b.NUM_FRACTION_DIGITS);return["<path ","COMMON_PARTS",'d="'.concat(e,`" stroke-linecap="round" />
`)]}_getOffsetTransform(){const e=b.NUM_FRACTION_DIGITS;return" translate(".concat(y(-this.pathOffset.x,e),", ").concat(y(-this.pathOffset.y,e),")")}toClipPathSVG(e){const t=this._getOffsetTransform();return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:e,additionalTransform:t})}toSVG(e){const t=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:e,additionalTransform:t})}complexity(){return this.path.length}setDimensions(){this.setBoundingBox()}setBoundingBox(e){const{width:n,height:s,pathOffset:t}=this._calcDimensions();this.set({width:n,height:s,pathOffset:t}),e&&this.setPositionByOrigin(t,m,m)}_calcBoundsFromPath(){const n=[];let s=0,o=0,e=0,t=0;for(const i of this.path)switch(i[0]){case"L":e=i[1],t=i[2],n.push({x:s,y:o},{x:e,y:t});break;case"M":e=i[1],t=i[2],s=e,o=t;break;case"C":n.push(...yi(e,t,i[1],i[2],i[3],i[4],i[5],i[6])),e=i[5],t=i[6];break;case"Q":n.push(...yi(e,t,i[1],i[2],i[1],i[2],i[3],i[4])),e=i[3],t=i[4];break;case"Z":e=s,t=o}return fe(n)}_calcDimensions(){const e=this._calcBoundsFromPath();return n(n({},e),{},{pathOffset:new o(e.left+e.width/2,e.top+e.height/2)})}static fromObject(e){return this._fromObject(e,{extraParam:"path"})}static async fromElement(e,t,s){const o=Ee(e,this.ATTRIBUTE_NAMES,s),{d:i}=o;return new this(i,n(n(n({},w(o,Dd)),t),{},{left:0[0],top:0[0]}))}},s(tn,"type","Path"),s(tn,"cacheProperties",[..._e,"path","fillRule"]),s(tn,"ATTRIBUTE_NAMES",[...Le,"d"]),c.setClass(tn),c.setSVGClass(tn),zd=["left","top","radius"],_a=["radius","startAngle","endAngle","counterClockwise"],dt=class _ho extends S{static getDefaults(){return n(n({},super.getDefaults()),_ho.ownDefaults)}constructor(e){super(),Object.assign(this,_ho.ownDefaults),this.setOptions(e)}_set(e,t){return super._set(e,t),"radius"===e&&this.setRadius(t),this}_render(e){e.beginPath(),e.arc(0,0,this.radius,x(this.startAngle),x(this.endAngle),this.counterClockwise),this._renderPaintInOrder(e)}getRadiusX(){return this.get("radius")*this.get(F)}getRadiusY(){return this.get("radius")*this.get(B)}setRadius(e){this.radius=e,this.set({width:2*e,height:2*e})}toObject(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];return super.toObject([..._a,...e])}_toSVG(){const e=(this.endAngle-this.startAngle)%360;if(0===e)return["<circle ","COMMON_PARTS",'cx="0" cy="0" ','r="',"".concat(this.radius),`" />
`];{const{radius:t}=this,n=x(this.startAngle),s=x(this.endAngle),o=se(n)*t,i=Z(n)*t,a=se(s)*t,r=Z(s)*t,c=e>180?1:0,l=this.counterClockwise?0:1;return['<path d="M '.concat(o," ").concat(i," A ").concat(t," ").concat(t," 0 ").concat(c," ").concat(l," ").concat(a," ").concat(r,'" '),"COMMON_PARTS",` />
`]}}static async fromElement(e,t,s){const i=Ee(e,this.ATTRIBUTE_NAMES,s),{left:a=0,top:r=0,radius:o=0}=i;return new this(n(n({},w(i,zd)),{},{radius:o,left:a-o,top:r-o}))}static fromObject(e){return super._fromObject(e)}},s(dt,"type","Circle"),s(dt,"cacheProperties",[..._e,..._a]),s(dt,"ownDefaults",{radius:0,startAngle:0,endAngle:360,counterClockwise:!1}),s(dt,"ATTRIBUTE_NAMES",["cx","cy","r",...Le]),c.setClass(dt),c.setSVGClass(dt),Td=["x1","y1","x2","y2"],Fd=["x1","y1","x2","y2"],Lo=["x1","x2","y1","y2"],gt=class _mo extends S{constructor(){let[s,o,i,a]=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[0,0,0,0],e=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};super(),Object.assign(this,_mo.ownDefaults),this.setOptions(e),this.x1=s,this.x2=i,this.y1=o,this.y2=a,this._setWidthHeight();const{left:t,top:n}=e;"number"==typeof t&&this.set(j,t),"number"==typeof n&&this.set(P,n)}_setWidthHeight(){const{x1:e,y1:t,x2:n,y2:s}=this;this.width=Math.abs(n-e),this.height=Math.abs(s-t);const{left:i,top:a,width:r,height:c}=fe([{x:e,y:t},{x:n,y:s}]),l=new o(i+r/2,a+c/2);this.setPositionByOrigin(l,m,m)}_set(e,t){return super._set(e,t),Lo.includes(e)&&this._setWidthHeight(),this}_render(e){e.beginPath();const t=this.calcLinePoints();e.moveTo(t.x1,t.y1),e.lineTo(t.x2,t.y2),e.lineWidth=this.strokeWidth;const s=e.strokeStyle;var n;Y(this.stroke)?e.strokeStyle=this.stroke.toLive(e):e.strokeStyle=null!==(n=this.stroke)&&0[0]!==n?n:e.fillStyle,this.stroke&&this._renderStroke(e),e.strokeStyle=s}_findCenterFromElement(){return new o((this.x1+this.x2)/2,(this.y1+this.y2)/2)}toObject(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];return n(n({},super.toObject(e)),this.calcLinePoints())}_getNonTransformedDimensions(){const e=super._getNonTransformedDimensions();return"butt"===this.strokeLineCap&&(0===this.width&&(e.y-=this.strokeWidth),0===this.height&&(e.x-=this.strokeWidth)),e}calcLinePoints(){const{x1:o,x2:i,y1:a,y2:r,width:e,height:t}=this,n=o<=i?-1:1,s=a<=r?-1:1;return{x1:n*e/2,x2:n*-e/2,y1:s*t/2,y2:s*-t/2}}_toSVG(){const{x1:e,x2:t,y1:n,y2:s}=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="'.concat(e,'" y1="').concat(n,'" x2="').concat(t,'" y2="').concat(s,`" />
`)]}static async fromElement(e,t,n){const s=Ee(e,this.ATTRIBUTE_NAMES,n),{x1:o=0,y1:i=0,x2:a=0,y2:r=0}=s;return new this([o,i,a,r],w(s,Td))}static fromObject(e){let{x1:t,y1:s,x2:o,y2:i}=e,a=w(e,Fd);return this._fromObject(n(n({},a),{},{points:[t,s,o,i]}),{extraParam:"points"})}},s(gt,"type","Line"),s(gt,"cacheProperties",[..._e,...Lo]),s(gt,"ATTRIBUTE_NAMES",Le.concat(Lo)),c.setClass(gt),c.setSVGClass(gt),Yn=class _vo extends S{static getDefaults(){return n(n({},super.getDefaults()),_vo.ownDefaults)}constructor(e){super(),Object.assign(this,_vo.ownDefaults),this.setOptions(e)}_render(e){const n=this.width/2,t=this.height/2;e.beginPath(),e.moveTo(-n,t),e.lineTo(0,-t),e.lineTo(n,t),e.closePath(),this._renderPaintInOrder(e)}_toSVG(){const t=this.width/2,e=this.height/2;return["<polygon ","COMMON_PARTS",'points="',"".concat(-t," ").concat(e,",0 ").concat(-e,",").concat(t," ").concat(e),'" />']}},s(Yn,"type","Triangle"),s(Yn,"ownDefaults",{width:100,height:100}),c.setClass(Yn),c.setSVGClass(Yn),Aa=["rx","ry"],bt=class __o extends S{static getDefaults(){return n(n({},super.getDefaults()),__o.ownDefaults)}constructor(e){super(),Object.assign(this,__o.ownDefaults),this.setOptions(e)}_set(e,t){switch(super._set(e,t),e){case"rx":this.rx=t,this.set("width",2*t);break;case"ry":this.ry=t,this.set("height",2*t)}return this}getRx(){return this.get("rx")*this.get(F)}getRy(){return this.get("ry")*this.get(B)}toObject(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];return super.toObject([...Aa,...e])}_toSVG(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" rx="'.concat(this.rx,'" ry="').concat(this.ry,`" />
`)]}_render(e){e.beginPath(),e.save(),e.transform(1,0,0,this.ry/this.rx,0,0),e.arc(0,0,this.rx,0,je,!1),e.restore(),this._renderPaintInOrder(e)}static async fromElement(e,t,n){const s=Ee(e,this.ATTRIBUTE_NAMES,n);return s.left=(s.left||0)-s.rx,s.top=(s.top||0)-s.ry,new this(s)}};function K0(e){if(!e)return[];const t=e.replace(/,/g," ").trim().split(/\s+/),n=[];for(let e=0;e<t.length;e+=2)n.push({x:parseFloat(t[e]),y:parseFloat(t[e+1])});return n}s(bt,"type","Ellipse"),s(bt,"cacheProperties",[..._e,...Aa]),s(bt,"ownDefaults",{rx:0,ry:0}),s(bt,"ATTRIBUTE_NAMES",[...Le,"cx","cy","rx","ry"]),c.setClass(bt),c.setSVGClass(bt),Ad=["left","top"],Ta={exactBoundingBox:!1},Ce=class _So extends S{static getDefaults(){return n(n({},super.getDefaults()),_So.ownDefaults)}constructor(){let o=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[],e=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};super(),s(this,"strokeDiff",0[0]),Object.assign(this,_So.ownDefaults),this.setOptions(e),this.points=o;const{left:t,top:n}=e;this.initialized=!0,this.setBoundingBox(!0),"number"==typeof t&&this.set(j,t),"number"==typeof n&&this.set(P,n)}isOpen(){return!0}_projectStrokeOnPoints(e){return tc(this.points,e,this.isOpen())}_calcDimensions(e){e=n({scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,strokeLineCap:this.strokeLineCap,strokeLineJoin:this.strokeLineJoin,strokeMiterLimit:this.strokeMiterLimit,strokeUniform:this.strokeUniform,strokeWidth:this.strokeWidth},e||{});const r=this.exactBoundingBox?this._projectStrokeOnPoints(e).map(e=>e.projectedPoint):this.points;if(0===r.length)return{left:0,top:0,width:0,height:0,pathOffset:new o,strokeOffset:new o,strokeDiff:new o};const t=fe(r),l=bn(n(n({},e),{},{scaleX:1,scaleY:1})),s=fe(this.points.map(e=>M(e,l,!0))),c=new o(this.scaleX,this.scaleY);let i=t.left+t.width/2,a=t.top+t.height/2;return this.exactBoundingBox&&(i-=a*Math.tan(x(this.skewX)),a-=i*Math.tan(x(this.skewY))),n(n({},t),{},{pathOffset:new o(i,a),strokeOffset:new o(s.left,s.top).subtract(new o(t.left,t.top)).multiply(c),strokeDiff:new o(t.width,t.height).subtract(new o(s.width,s.height)).multiply(c)})}_findCenterFromElement(){const e=fe(this.points);return new o(e.left+e.width/2,e.top+e.height/2)}setDimensions(){this.setBoundingBox()}setBoundingBox(e){const{left:s,top:i,width:t,height:n,pathOffset:a,strokeOffset:r,strokeDiff:c}=this._calcDimensions();this.set({width:t,height:n,pathOffset:a,strokeOffset:r,strokeDiff:c}),e&&this.setPositionByOrigin(new o(s+t/2,i+n/2),m,m)}isStrokeAccountedForInDimensions(){return this.exactBoundingBox}_getNonTransformedDimensions(){return this.exactBoundingBox?new o(this.width,this.height):super._getNonTransformedDimensions()}_getTransformedDimensions(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};if(this.exactBoundingBox){let a;if(Object.keys(e).some(e=>this.strokeUniform||this.constructor.layoutProperties.includes(e))){var t,n,s,i;const{width:r,height:c}=this._calcDimensions(e);a=new o(null!==(t=e.width)&&0[0]!==t?t:r,null!==(n=e.height)&&0[0]!==n?n:c)}else a=new o(null!==(s=e.width)&&0[0]!==s?s:this.width,null!==(i=e.height)&&0[0]!==i?i:this.height);return a.multiply(new o(e.scaleX||this.scaleX,e.scaleY||this.scaleY))}return super._getTransformedDimensions(e)}_set(e,t){const n=this.initialized&&this[e]!==t,s=super._set(e,t);return this.exactBoundingBox&&n&&((e===F||e===B)&&this.strokeUniform&&this.constructor.layoutProperties.includes("strokeUniform")||this.constructor.layoutProperties.includes(e))&&this.setDimensions(),s}toObject(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];return n(n({},super.toObject(e)),{},{points:this.points.map(e=>{let{x:t,y:n}=e;return{x:t,y:n}})})}_toSVG(){const e=[],n=this.pathOffset.x,s=this.pathOffset.y,t=b.NUM_FRACTION_DIGITS;for(let o=0,i=this.points.length;o<i;o++)e.push(y(this.points[o].x-n,t),",",y(this.points[o].y-s,t)," ");return["<".concat(this.constructor.type.toLowerCase()," "),"COMMON_PARTS",'points="'.concat(e.join(""),`" />
`)]}_render(e){const t=this.points.length,n=this.pathOffset.x,s=this.pathOffset.y;if(t&&!isNaN(this.points[t-1].y)){e.beginPath(),e.moveTo(this.points[0].x-n,this.points[0].y-s);for(let o=0;o<t;o++){const i=this.points[o];e.lineTo(i.x-n,i.y-s)}!this.isOpen()&&e.closePath(),this._renderPaintInOrder(e)}}complexity(){return this.points.length}static async fromElement(e,t,s){return new this(K0(e.getAttribute("points")),n(n({},w(Ee(e,this.ATTRIBUTE_NAMES,s),Ad)),t))}static fromObject(e){return this._fromObject(e,{extraParam:"points"})}},s(Ce,"ownDefaults",Ta),s(Ce,"type","Polyline"),s(Ce,"layoutProperties",[rt,Ot,"strokeLineCap","strokeLineJoin","strokeMiterLimit","strokeWidth","strokeUniform","points"]),s(Ce,"cacheProperties",[..._e,"points"]),s(Ce,"ATTRIBUTE_NAMES",[...Le]),c.setClass(Ce),c.setSVGClass(Ce),Gn=class extends Ce{isOpen(){return!1}},s(Gn,"ownDefaults",Ta),s(Gn,"type","Polygon"),c.setClass(Gn),c.setSVGClass(Gn),Na=class extends S{isEmptyStyles(e){if(!this.styles)return!0;if(0[0]!==e&&!this.styles[e])return!0;const t=0[0]===e?this.styles:{line:this.styles[e]};for(const e in t)for(const n in t[e])for(const s in t[e][n])return!1;return!0}styleHas(e,t){if(!this.styles)return!1;if(0[0]!==t&&!this.styles[t])return!1;const n=0[0]===t?this.styles:{0:this.styles[t]};for(const t in n)for(const s in n[t])if(0[0]!==n[t][s][e])return!0;return!1}cleanStyle(e){if(!this.styles)return!1;const t=this.styles;let s,n,i=0,o=!0,a=0;for(const a in t){s=0;for(const c in t[a]){const r=t[a][c]||{};i++,0[0]!==r[e]?(n?r[e]!==n&&(o=!1):n=r[e],r[e]===this[e]&&delete r[e]):o=!1,0!==Object.keys(r).length?s++:delete t[a][c]}0===s&&delete t[a]}for(let e=0;e<this._textLines.length;e++)a+=this._textLines[e].length;o&&i===a&&(this[e]=n,this.removeStyle(e))}removeStyle(e){if(!this.styles)return;const s=this.styles;let t,o,n;for(o in s){for(n in t=s[o],t)delete t[n][e],0===Object.keys(t[n]).length&&delete t[n];0===Object.keys(t).length&&delete s[o]}}_extendStyles(e,t){const{lineIndex:s,charIndex:o}=this.get2DCursorLocation(e);this._getLineStyle(s)||this._setLineStyle(s);const i=Oo(n(n({},this._getStyleDeclaration(s,o)),t),e=>0[0]!==e);this._setStyleDeclaration(s,o,i)}getSelectionStyles(e,t,n){const s=[];for(let o=e;o<(t||e);o++)s.push(this.getStyleAtPosition(o,n));return s}getStyleAtPosition(e,t){const{lineIndex:n,charIndex:s}=this.get2DCursorLocation(e);return t?this.getCompleteStyleDeclaration(n,s):this._getStyleDeclaration(n,s)}setSelectionStyles(e,t,n){for(let s=t;s<(n||t);s++)this._extendStyles(s,e);this._forceClearCache=!0}_getStyleDeclaration(e,t){var n;const s=this.styles&&this.styles[e];return s&&null!==(n=s[t])&&0[0]!==n?n:{}}getCompleteStyleDeclaration(e,t){return n(n({},qe(this,this.constructor._styleProperties)),this._getStyleDeclaration(e,t))}_setStyleDeclaration(e,t,n){this.styles[e][t]=n}_deleteStyleDeclaration(e,t){delete this.styles[e][t]}_getLineStyle(e){return!!this.styles[e]}_setLineStyle(e){this.styles[e]={}}_deleteLineStyle(e){delete this.styles[e]}},s(Na,"_styleProperties",$4),yd=/  +/g,md=/"/g;function Pa(e,t,n,s,o){return"		".concat(function(e,t){let{left:n,top:s,width:o,height:i}=t,a=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:b.NUM_FRACTION_DIGITS;const r=Jt(A,e,!1),[c,l,d,u]=[n,s,o,i].map(e=>y(e,a));return"<rect ".concat(r,' x="').concat(c,'" y="').concat(l,'" width="').concat(d,'" height="').concat(u,'"></rect>')}(e,{left:t,top:n,width:s,height:o}),`
`)}sd=["textAnchor","textDecoration","dx","dy","top","left","fontSize","strokeWidth"],re=class _Eo extends Na{static getDefaults(){return n(n({},super.getDefaults()),_Eo.ownDefaults)}constructor(e,t){super(),s(this,"__charBounds",[]),Object.assign(this,_Eo.ownDefaults),this.setOptions(t),this.styles||(this.styles={}),this.text=e,this.initialized=!0,this.path&&this.setPathInfo(),this.initDimensions(),this.setCoords()}setPathInfo(){const e=this.path;e&&(e.segmentsInfo=hi(e.path))}_splitText(){const e=this._splitTextIntoLines(this.text);return this.textLines=e.lines,this._textLines=e.graphemeLines,this._unwrappedTextLines=e._unwrappedLines,this._text=e.graphemeText,e}initDimensions(){this._splitText(),this._clearCache(),this.dirty=!0,this.path?(this.width=this.path.width,this.height=this.path.height):(this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight()),this.textAlign.includes(ie)&&this.enlargeSpaces()}enlargeSpaces(){let t,s,i,n,o,e,a;for(let r=0,c=this._textLines.length;r<c;r++)if((this.textAlign===ie||r!==c-1&&!this.isEndOfWrapping(r))&&(n=0,o=this._textLines[r],s=this.getLineWidth(r),s<this.width&&(a=this.textLines[r].match(this._reSpacesAndTabs)))){i=a.length,t=(this.width-s)/i;for(let s=0;s<=o.length;s++)e=this.__charBounds[r][s],this._reSpaceAndTab.test(o[s])?(e.width+=t,e.kernedWidth+=t,e.left+=n,n+=t):e.left+=n}}isEndOfWrapping(e){return e===this._textLines.length-1}missingNewlineOffset(){return 1}get2DCursorLocation(e,t){const s=t?this._unwrappedTextLines:this._textLines;let n;for(n=0;n<s.length;n++){if(e<=s[n].length)return{lineIndex:n,charIndex:e};e-=s[n].length+this.missingNewlineOffset(n,t)}return{lineIndex:n-1,charIndex:s[n-1].length<e?s[n-1].length:e}}toString(){return"#<Text (".concat(this.complexity(),'): { "text": "').concat(this.text,'", "fontFamily": "').concat(this.fontFamily,'" }>')}_getCacheCanvasDimensions(){const e=super._getCacheCanvasDimensions(),t=this.fontSize;return e.width+=t*e.zoomX,e.height+=t*e.zoomY,e}_render(e){const t=this.path;t&&!t.isNotVisible()&&t._render(e),this._setTextStyles(e),this._renderTextLinesBackground(e),this._renderTextDecoration(e,"underline"),this._renderText(e),this._renderTextDecoration(e,"overline"),this._renderTextDecoration(e,"linethrough")}_renderText(e){this.paintFirst===R?(this._renderTextStroke(e),this._renderTextFill(e)):(this._renderTextFill(e),this._renderTextStroke(e))}_setTextStyles(e,t,n){if(e.textBaseline="alphabetic",this.path)switch(this.pathAlign){case m:e.textBaseline="middle";break;case"ascender":e.textBaseline=P;break;case"descender":e.textBaseline=so}e.font=this._getFontDeclaration(t,n)}calcTextWidth(){let e=this.getLineWidth(0);for(let t=1,s=this._textLines.length;t<s;t++){const n=this.getLineWidth(t);n>e&&(e=n)}return e}_renderTextLine(e,t,n,s,o,i){this._renderChars(e,t,n,s,o,i)}_renderTextLinesBackground(e){if(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor"))return;const s=e.fillStyle,n=this._getLeftOffset();let t=this._getTopOffset();for(let s=0,u=this._textLines.length;s<u;s++){const a=this.getHeightOfLine(s);if(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor",s)){t+=a;continue}const h=this._textLines[s].length,d=this._getLineLeftOffset(s);let o,i,r=0,l=0,c=this.getValueOfPropertyAt(s,0,"textBackgroundColor");for(let m=0;m<h;m++){const u=this.__charBounds[s][m];i=this.getValueOfPropertyAt(s,m,"textBackgroundColor"),this.path?(e.save(),e.translate(u.renderLeft,u.renderTop),e.rotate(u.angle),e.fillStyle=i,i&&e.fillRect(-u.width/2,-a/this.lineHeight*(1-this._fontSizeFraction),u.width,a/this.lineHeight),e.restore()):i!==c?(o=n+d+l,"rtl"===this.direction&&(o=this.width-o-r),e.fillStyle=c,c&&e.fillRect(o,t,r,a/this.lineHeight),l=u.left,r=u.width,c=i):r+=u.kernedWidth}i&&!this.path&&(o=n+d+l,"rtl"===this.direction&&(o=this.width-o-r),e.fillStyle=i,e.fillRect(o,t,r,a/this.lineHeight)),t+=a}e.fillStyle=s,this._removeShadow(e)}_measureChar(e,t,n,s){const o=Bt.getFontCache(t),h=this._getFontDeclaration(t),l=n+e,d=n&&h===this._getFontDeclaration(s),u=t.fontSize/this.CACHE_FONT_SIZE;let r,i,a,c;if(n&&0[0]!==o[n]&&(a=o[n]),0[0]!==o[e]&&(c=r=o[e]),d&&0[0]!==o[l]&&(i=o[l],c=i-a),0[0]===r||0[0]===a||0[0]===i){const s=function(){if(!Ia){const e=K({width:0,height:0});Ia=e.getContext("2d")}return Ia}();this._setTextStyles(s,t,!0),0[0]===r&&(c=r=s.measureText(e).width,o[e]=r),0[0]===a&&d&&n&&(a=s.measureText(n).width,o[n]=a),d&&0[0]===i&&(i=s.measureText(l).width,o[l]=i,c=i-a)}return{width:r*u,kernedWidth:c*u}}getHeightOfChar(e,t){return this.getValueOfPropertyAt(e,t,"fontSize")}measureLine(e){const t=this._measureLine(e);return 0!==this.charSpacing&&(t.width-=this._getWidthOfCharSpacing()),t.width<0&&(t.width=0),t}_measureLine(e){let r,t,s=0;const n=this.pathSide===C,i=this.path,c=this._textLines[e],o=c.length,a=new Array(o);this.__charBounds[e]=a;for(let n=0;n<o;n++){const i=c[n];t=this._getGraphemeBox(i,e,n,r),a[n]=t,s+=t.kernedWidth,r=i}if(a[o]={left:t?t.left+t.width:0,width:0,kernedWidth:0,height:this.fontSize,deltaY:0},i&&i.segmentsInfo){let e=0;const r=i.segmentsInfo[i.segmentsInfo.length-1].length;switch(this.textAlign){case j:e=n?r-s:0;break;case m:e=(r-s)/2;break;case C:e=n?0:r-s}e+=this.pathStartOffset*(n?-1:1);for(let s=n?o-1:0;n?s>=0:s<o;n?s--:s++)t=a[s],e>r?e%=r:e<0&&(e+=r),this._setGraphemeOnPath(e,t),e+=t.kernedWidth}return{width:s,numOfSpaces:0}}_setGraphemeOnPath(e,t){const o=e+t.kernedWidth/2,n=this.path,s=Fi(n.path,o,n.segmentsInfo);t.renderLeft=s.x-n.pathOffset.x,t.renderTop=s.y-n.pathOffset.y,t.angle=s.angle+(this.pathSide===C?Math.PI:0)}_getGraphemeBox(e,t,n,s,o){const a=this.getCompleteStyleDeclaration(t,n),u=s?this.getCompleteStyleDeclaration(t,n-1):{},i=this._measureChar(e,a,s,u);let r,c=i.kernedWidth,l=i.width;0!==this.charSpacing&&(r=this._getWidthOfCharSpacing(),l+=r,c+=r);const d={width:l,left:0,height:a.fontSize,kernedWidth:c,deltaY:a.deltaY};if(n>0&&!o){const e=this.__charBounds[t][n-1];d.left=e.left+e.width+i.kernedWidth-i.width}return d}getHeightOfLine(e){if(this.__lineHeights[e])return this.__lineHeights[e];let t=this.getHeightOfChar(e,0);for(let n=1,s=this._textLines[e].length;n<s;n++)t=Math.max(this.getHeightOfChar(e,n),t);return this.__lineHeights[e]=t*this.lineHeight*this._fontSizeMult}calcTextHeight(){let e,t=0;for(let n=0,s=this._textLines.length;n<s;n++)e=this.getHeightOfLine(n),t+=n===s-1?e/this.lineHeight:e;return t}_getLeftOffset(){return"ltr"===this.direction?-this.width/2:this.width/2}_getTopOffset(){return-this.height/2}_renderTextCommon(e,t){e.save();let n=0;const s=this._getLeftOffset(),o=this._getTopOffset();for(let i=0,r=this._textLines.length;i<r;i++){const a=this.getHeightOfLine(i),c=a/this.lineHeight,l=this._getLineLeftOffset(i);this._renderTextLine(t,e,this._textLines[i],s+l,o+n+c,i),n+=a}e.restore()}_renderTextFill(e){(this.fill||this.styleHas(A))&&this._renderTextCommon(e,"fillText")}_renderTextStroke(e){(this.stroke&&0!==this.strokeWidth||!this.isEmptyStyles())&&(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(e),e.save(),this._setLineDash(e,this.strokeDashArray),e.beginPath(),this._renderTextCommon(e,"strokeText"),e.closePath(),e.restore())}_renderChars(e,t,n,s,o,i){const y=this.getHeightOfLine(i),p=this.textAlign.includes(ie),u=this.path,v=!p&&0===this.charSpacing&&this.isEmptyStyles(i)&&!u,h="ltr"===this.direction,g="ltr"===this.direction?1:-1,b=t.direction;let d,m,a,c,f,l="",r=0;if(t.save(),b!==this.direction&&(t.canvas.setAttribute("dir",h?"ltr":"rtl"),t.direction=h?"ltr":"rtl",t.textAlign=h?j:C),o-=y*this._fontSizeFraction/this.lineHeight,v)return this._renderChar(e,t,i,0,n.join(""),s,o),void t.restore();for(let h=0,v=n.length-1;h<=v;h++)c=h===v||this.charSpacing||u,l+=n[h],a=this.__charBounds[i][h],0===r?(s+=g*(a.kernedWidth-a.width),r+=a.width):r+=a.kernedWidth,p&&!c&&this._reSpaceAndTab.test(n[h])&&(c=!0),c||(d=d||this.getCompleteStyleDeclaration(i,h),m=this.getCompleteStyleDeclaration(i,h+1),c=Ps(d,m,!1)),c&&(u?(t.save(),t.translate(a.renderLeft,a.renderTop),t.rotate(a.angle),this._renderChar(e,t,i,h,l,-r/2,0),t.restore()):(f=s,this._renderChar(e,t,i,h,l,f,o)),l="",d=m,s+=g*r,r=0);t.restore()}_applyPatternGradientTransformText(e){const n=this.width+this.strokeWidth,s=this.height+this.strokeWidth,o=K({width:n,height:s}),t=o.getContext("2d");return o.width=n,o.height=s,t.beginPath(),t.moveTo(0,0),t.lineTo(n,0),t.lineTo(n,s),t.lineTo(0,s),t.closePath(),t.translate(n/2,s/2),t.fillStyle=e.toLive(t),this._applyPatternGradientTransform(t,e),t.fill(),t.createPattern(o,"no-repeat")}handleFiller(e,t,n){let s,o;return Y(n)?"percentage"===n.gradientUnits||n.gradientTransform||n.patternTransform?(s=-this.width/2,o=-this.height/2,e.translate(s,o),e[t]=this._applyPatternGradientTransformText(n),{offsetX:s,offsetY:o}):(e[t]=n.toLive(e),this._applyPatternGradientTransform(e,n)):(e[t]=n,{offsetX:0,offsetY:0})}_setStrokeStyles(e,t){let{stroke:n,strokeWidth:s}=t;return e.lineWidth=s,e.lineCap=this.strokeLineCap,e.lineDashOffset=this.strokeDashOffset,e.lineJoin=this.strokeLineJoin,e.miterLimit=this.strokeMiterLimit,this.handleFiller(e,"strokeStyle",n)}_setFillStyles(e,t){let{fill:n}=t;return this.handleFiller(e,"fillStyle",n)}_renderChar(e,t,n,s,o,i,a){const c=this._getStyleDeclaration(n,s),r=this.getCompleteStyleDeclaration(n,s),l="fillText"===e&&r.fill,d="strokeText"===e&&r.stroke&&r.strokeWidth;if(d||l){if(t.save(),t.font=this._getFontDeclaration(r),c.textBackgroundColor&&this._removeShadow(t),c.deltaY&&(a+=c.deltaY),l){const e=this._setFillStyles(t,r);t.fillText(o,i-e.offsetX,a-e.offsetY)}if(d){const e=this._setStrokeStyles(t,r);t.strokeText(o,i-e.offsetX,a-e.offsetY)}t.restore()}}setSuperscript(e,t){this._setScript(e,t,this.superscript)}setSubscript(e,t){this._setScript(e,t,this.subscript)}_setScript(e,t,n){const s=this.get2DCursorLocation(e,!0),o=this.getValueOfPropertyAt(s.lineIndex,s.charIndex,"fontSize"),i=this.getValueOfPropertyAt(s.lineIndex,s.charIndex,"deltaY"),a={fontSize:o*n.size,deltaY:i+o*n.baseline};this.setSelectionStyles(a,e,t)}_getLineLeftOffset(e){const i=this.getLineWidth(e),s=this.width-i,t=this.textAlign,a=this.direction,o=this.isEndOfWrapping(e);let n=0;return t===ie||t===mn&&!o||t===hn&&!o||t===$n&&!o?0:(t===m&&(n=s/2),t===C&&(n=s),t===mn&&(n=s/2),t===hn&&(n=s),"rtl"===a&&(t===C||t===ie||t===hn?n=0:t===j||t===$n?n=-s:t!==m&&t!==mn||(n=-s/2)),n)}_clearCache(){this._forceClearCache=!1,this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]}getLineWidth(e){if(0[0]!==this.__lineWidths[e])return this.__lineWidths[e];const{width:t}=this.measureLine(e);return this.__lineWidths[e]=t,t}_getWidthOfCharSpacing(){return 0!==this.charSpacing?this.fontSize*this.charSpacing/1e3:0}getValueOfPropertyAt(e,t,n){var s;return null!==(s=this._getStyleDeclaration(e,t)[n])&&0[0]!==s?s:this[n]}_renderTextDecoration(e,t){if(!this[t]&&!this.styleHas(t))return;let n=this._getTopOffset();const i=this._getLeftOffset(),a=this.path,r=this._getWidthOfCharSpacing(),s="linethrough"===t?.5:"overline"===t?1:0,o=this.offsets[t];for(let c=0,E=this._textLines.length;c<E;c++){const j=this.getHeightOfLine(c);if(!this[t]&&!this.styleHas(t,c)){n+=j;continue}const C=this._textLines[c],x=j/this.lineHeight,_=this._getLineLeftOffset(c);let b=0,l=0,p=this.getValueOfPropertyAt(c,0,t),h=this.getValueOfPropertyAt(c,0,A),f=this.getValueOfPropertyAt(c,0,Ue),m=p,u=h,d=f;const w=n+x*(1-this._fontSizeFraction);let g=this.getHeightOfChar(c,0),v=this.getValueOfPropertyAt(c,0,"deltaY");for(let n=0,O=C.length;n<O;n++){const r=this.__charBounds[c][n];m=this.getValueOfPropertyAt(c,n,t),u=this.getValueOfPropertyAt(c,n,A),d=this.getValueOfPropertyAt(c,n,Ue);const j=this.getHeightOfChar(c,n),y=this.getValueOfPropertyAt(c,n,"deltaY");if(a&&m&&u){const t=this.fontSize*d/1e3;e.save(),e.fillStyle=h,e.translate(r.renderLeft,r.renderTop),e.rotate(r.angle),e.fillRect(-r.kernedWidth/2,o*j+y-s*t,r.kernedWidth,t),e.restore()}else if((m!==p||u!==h||j!==g||d!==f||y!==v)&&l>0){const n=this.fontSize*f/1e3;let t=i+_+b;"rtl"===this.direction&&(t=this.width-t-l),p&&h&&f&&(e.fillStyle=h,e.fillRect(t,w+o*g+v-s*n,l,n)),b=r.left,l=r.width,p=m,f=d,h=u,g=j,v=y}else l+=r.kernedWidth}let y=i+_+b;"rtl"===this.direction&&(y=this.width-y-l),e.fillStyle=u;const O=this.fontSize*d/1e3;m&&u&&d&&e.fillRect(y,w+o*g+v-s*O,l-r,O),n+=j}this._removeShadow(e)}_getFontDeclaration(){let{fontFamily:e=this.fontFamily,fontStyle:t=this.fontStyle,fontWeight:n=this.fontWeight,fontSize:s=this.fontSize}=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{},o=arguments.length>1?arguments[1]:0[0];const i=e.includes("'")||e.includes('"')||e.includes(",")||_Eo.genericFonts.includes(e.toLowerCase())?e:'"'.concat(e,'"');return[t,n,"".concat(o?this.CACHE_FONT_SIZE:s,"px"),i].join(" ")}render(e){this.visible&&(this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._forceClearCache&&this.initDimensions(),super.render(e)))}graphemeSplit(e){return Hs(e)}_splitTextIntoLines(e){const t=e.split(this._reNewline),n=new Array(t.length),o=[`
`];let s=[];for(let e=0;e<t.length;e++)n[e]=this.graphemeSplit(t[e]),s=s.concat(n[e],o);return s.pop(),{_unwrappedLines:n,lines:t,graphemeText:s,graphemeLines:n}}toObject(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];return n(n({},super.toObject([...vi,...e])),{},{styles:Hr(this.styles,this.text)},this.path?{path:this.path.toObject()}:{})}set(e,t){const{textLayoutProperties:o}=this.constructor;super.set(e,t);let n=!1,s=!1;if("object"==typeof e)for(const t in e)"path"===t&&this.setPathInfo(),n=n||o.includes(t),s=s||"path"===t;else n=o.includes(e),s="path"===e;return s&&this.setPathInfo(),n&&this.initialized&&(this.initDimensions(),this.setCoords()),this}complexity(){return 1}static async fromElement(e,t,s){const h=Ee(e,_Eo.ATTRIBUTE_NAMES,s),r=n(n({},t),h),{textAnchor:c=j,textDecoration:i="",dx:_=0,dy:g=0,top:d=0,left:u=0,fontSize:l=to,strokeWidth:f=1}=r,p=w(r,sd),o=new this((e.textContent||"").replace(/^\s+|\s+$|\n+/g,"").replace(/\s+/g," "),n({left:u+_,top:d+g,underline:i.includes("underline"),overline:i.includes("overline"),linethrough:i.includes("line-through"),strokeWidth:0,fontSize:l},p)),v=o.getScaledHeight()/o.height,b=((o.height+o.strokeWidth)*o.lineHeight-o.height)*v,y=o.getScaledHeight()+b;let a=0;return c===m&&(a=o.getScaledWidth()/2),c===C&&(a=o.getScaledWidth()),o.set({left:o.left-a,top:o.top-(y-o.fontSize*(.07+o._fontSizeFraction))/o.lineHeight,strokeWidth:f}),o}static fromObject(e){return this._fromObject(n(n({},e),{},{styles:Lr(e.styles||{},e.text)}),{extraParam:"text"})}},s(re,"textLayoutProperties",pa),s(re,"cacheProperties",[..._e,...vi]),s(re,"ownDefaults",V4),s(re,"type","Text"),s(re,"genericFonts",["serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]),s(re,"ATTRIBUTE_NAMES",Le.concat("x","y","dx","dy","font-family","font-style","font-weight","font-size","letter-spacing","text-decoration","text-anchor")),Z1(re,[class extends ya{_toSVG(){const e=this._getSVGLeftTopOffsets(),t=this._getSVGTextAndBg(e.textTop,e.textLeft);return this._wrapSVGTextAndBg(t)}toSVG(e){const n=this._createBaseSVGMarkup(this._toSVG(),{reviver:e,noStyle:!0,withShadow:!0}),t=this.path;return t?n+t._createBaseSVGMarkup(t._toSVG(),{reviver:e,withShadow:!0,additionalTransform:ot(this.calcOwnMatrix())}):n}_getSVGLeftTopOffsets(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}}_wrapSVGTextAndBg(e){let{textBgRects:n,textSpans:s}=e;const t=this.getSvgTextDecoration(this);return[n.join(""),'		<text xml:space="preserve" ','font-family="'.concat(this.fontFamily.replace(md,"'"),'" '),'font-size="'.concat(this.fontSize,'" '),this.fontStyle?'font-style="'.concat(this.fontStyle,'" '):"",this.fontWeight?'font-weight="'.concat(this.fontWeight,'" '):"",t?'text-decoration="'.concat(t,'" '):"","rtl"===this.direction?'direction="'.concat(this.direction,'" '):"",'style="',this.getSvgStyles(!0),'"',this.addPaintOrder()," >",s.join(""),`</text>
`]}_getSVGTextAndBg(e,t){const i=[],s=[];let n,o=e;this.backgroundColor&&s.push(...Pa(this.backgroundColor,-this.width/2,-this.height/2,this.width,this.height));for(let e=0,a=this._textLines.length;e<a;e++)n=this._getLineLeftOffset(e),"rtl"===this.direction&&(n+=this.width),(this.textBackgroundColor||this.styleHas("textBackgroundColor",e))&&this._setSVGTextLineBg(s,e,t+n,o),this._setSVGTextLineText(i,e,t+n,o),o+=this.getHeightOfLine(e);return{textSpans:i,textBgRects:s}}_createTextCharSpan(e,t,n,s,i){const a=b.NUM_FRACTION_DIGITS,c=this.getSvgSpanStyles(t,e!==e.trim()||!!e.match(yd)),h=c?'style="'.concat(c,'"'):"",l=t.deltaY,m=l?' dy="'.concat(y(l,a),'" '):"",{angle:r,renderLeft:d,renderTop:f,width:p}=i;let u="";if(0[0]!==d){const i=p/2;r&&(u=' rotate="'.concat(y(he(r),a),'"'));const e=lt({angle:he(r)});e[4]=d,e[5]=f;const t=new o(-i,0).transform(e);n=t.x,s=t.y}return'<tspan x="'.concat(y(n,a),'" y="').concat(y(s,a),'" ').concat(m).concat(u).concat(h,">").concat(Jr(e),"</tspan>")}_setSVGTextLineText(e,t,n,s){const h=this.getHeightOfLine(t),m=this.textAlign.includes(ie),c=this._textLines[t];let r,l,o,u,i,d="",a=0;s+=h*(1-this._fontSizeFraction)/this.lineHeight;for(let h=0,f=c.length-1;h<=f;h++)i=h===f||this.charSpacing||this.path,d+=c[h],o=this.__charBounds[t][h],0===a?(n+=o.kernedWidth-o.width,a+=o.width):a+=o.kernedWidth,m&&!i&&this._reSpaceAndTab.test(c[h])&&(i=!0),i||(r=r||this.getCompleteStyleDeclaration(t,h),l=this.getCompleteStyleDeclaration(t,h+1),i=Ps(r,l,!0)),i&&(u=this._getStyleDeclaration(t,h),e.push(this._createTextCharSpan(d,u,n,s,o)),d="",r=l,"rtl"===this.direction?n-=a:n+=a,a=0)}_setSVGTextLineBg(e,t,n,s){const l=this._textLines[t],c=this.getHeightOfLine(t)/this.lineHeight;let i,a=0,r=0,o=this.getValueOfPropertyAt(t,0,"textBackgroundColor");for(let d=0;d<l.length;d++){const{left:u,width:h,kernedWidth:m}=this.__charBounds[t][d];i=this.getValueOfPropertyAt(t,d,"textBackgroundColor"),i!==o?(o&&e.push(...Pa(o,n+r,s,a,c)),r=u,a=h,o=i):a+=m}i&&e.push(...Pa(o,n+r,s,a,c))}_getSVGLineTopOffset(e){let t,n=0;for(t=0;t<e;t++)n+=this.getHeightOfLine(t);const s=this.getHeightOfLine(t);return{lineTop:n,offset:(this._fontSizeMult-this._fontSizeFraction)*s/(this.lineHeight*this._fontSizeMult)}}getSvgStyles(e){return"".concat(super.getSvgStyles(e)," text-decoration-thickness: ").concat(y(this.textDecorationThickness*this.getObjectScaling().y/10,b.NUM_FRACTION_DIGITS),"%; white-space: pre;")}getSvgSpanStyles(e,t){const{fontFamily:n,strokeWidth:c,stroke:o,fill:i,fontSize:a,fontStyle:r,fontWeight:s,deltaY:l,textDecorationThickness:f,linethrough:d,overline:u,underline:h}=e,m=this.getSvgTextDecoration({underline:h??this.underline,overline:u??this.overline,linethrough:d??this.linethrough}),p=f||this.textDecorationThickness;return[o?Jt(R,o):"",c?"stroke-width: ".concat(c,"; "):"",n?"font-family: ".concat(n.includes("'")||n.includes('"')?n:"'".concat(n,"'"),"; "):"",a?"font-size: ".concat(a,"px; "):"",r?"font-style: ".concat(r,"; "):"",s?"font-weight: ".concat(s,"; "):"",m?"text-decoration: ".concat(m,"; text-decoration-thickness: ").concat(y(p*this.getObjectScaling().y/10,b.NUM_FRACTION_DIGITS),"%; "):"",i?Jt(A,i):"",l?"baseline-shift: ".concat(-l,"; "):"",t?"white-space: pre; ":""].join("")}getSvgTextDecoration(e){return["overline","underline","line-through"].filter(t=>e[t.replace("-","")]).join(" ")}}]),c.setClass(re),c.setSVGClass(re),nd=class{constructor(e){s(this,"target",0[0]),s(this,"__mouseDownInPlace",!1),s(this,"__dragStartFired",!1),s(this,"__isDraggingOver",!1),s(this,"__dragStartSelection",0[0]),s(this,"__dragImageDisposer",0[0]),s(this,"_dispose",0[0]),this.target=e;const t=[this.target.on("dragenter",this.dragEnterHandler.bind(this)),this.target.on("dragover",this.dragOverHandler.bind(this)),this.target.on("dragleave",this.dragLeaveHandler.bind(this)),this.target.on("dragend",this.dragEndHandler.bind(this)),this.target.on("drop",this.dropHandler.bind(this))];this._dispose=()=>{t.forEach(e=>e()),this._dispose=0[0]}}isPointerOverSelection(e){const t=this.target,n=t.getSelectionStartFromPointer(e);return t.isEditing&&n>=t.selectionStart&&n<=t.selectionEnd&&t.selectionStart<t.selectionEnd}start(e){return this.__mouseDownInPlace=this.isPointerOverSelection(e)}isActive(){return this.__mouseDownInPlace}end(e){const t=this.isActive();return t&&!this.__dragStartFired&&(this.target.setCursorByClick(e),this.target.initDelayedCursor(!0)),this.__mouseDownInPlace=!1,this.__dragStartFired=!1,this.__isDraggingOver=!1,t}getDragStartSelection(){return this.__dragStartSelection}setDragImage(e,t){var r;let{selectionStart:l,selectionEnd:y}=t;const n=this.target,a=n.canvas,j=new o(n.flipX?-1:1,n.flipY?-1:1),i=n._getCursorBoundaries(l),u=new o(i.left+i.leftOffset,i.top+i.topOffset).multiply(j).transform(n.calcTransformMatrix()),f=a.getScenePoint(e).subtract(u),h=n.getCanvasRetinaScaling(),m=n.getBoundingRect(),g=u.subtract(new o(m.left,m.top)),p=a.viewportTransform,c=g.add(f).transform(p,!0),v=n.backgroundColor,b=no(n.styles);n.backgroundColor="";const d={stroke:"transparent",fill:"transparent",textBackgroundColor:"transparent"};n.setSelectionStyles(d,0,l),n.setSelectionStyles(d,y,n.text.length),n.dirty=!0;const s=n.toCanvasElement({enableRetinaScaling:a.enableRetinaScaling,viewportTransform:!0});n.backgroundColor=v,n.styles=b,n.dirty=!0,ri(s,{position:"fixed",left:"".concat(-s.width,"px"),border:N,width:"".concat(s.width/h,"px"),height:"".concat(s.height/h,"px")}),this.__dragImageDisposer&&this.__dragImageDisposer(),this.__dragImageDisposer=()=>{s.remove()},ne(e.target||this.target.hiddenTextarea).body.appendChild(s),null===(r=e.dataTransfer)||0[0]===r||r.setDragImage(s,c.x,c.y)}onDragStart(e){this.__dragStartFired=!0;const t=this.target,s=this.isActive();if(s&&e.dataTransfer){const s=this.__dragStartSelection={selectionStart:t.selectionStart,selectionEnd:t.selectionEnd},o=t._text.slice(s.selectionStart,s.selectionEnd).join(""),i=n({text:t.text,value:o},s);e.dataTransfer.setData("text/plain",o),e.dataTransfer.setData("application/fabric",JSON.stringify({value:o,styles:t.getSelectionStyles(s.selectionStart,s.selectionEnd,!0)})),e.dataTransfer.effectAllowed="copyMove",this.setDragImage(e,i)}return t.abortCursorAnimation(),s}canDrop(e){if(this.target.editable&&!this.target.getActiveControl()&&!e.defaultPrevented){if(this.isActive()&&this.__dragStartSelection){const t=this.target.getSelectionStartFromPointer(e),n=this.__dragStartSelection;return t<n.selectionStart||t>n.selectionEnd}return!0}return!1}targetCanDrop(e){return this.target.canDrop(e)}dragEnterHandler(e){let{e:t}=e;const n=this.targetCanDrop(t);!this.__isDraggingOver&&n&&(this.__isDraggingOver=!0)}dragOverHandler(e){const{e:t}=e,n=this.targetCanDrop(t);!this.__isDraggingOver&&n?this.__isDraggingOver=!0:this.__isDraggingOver&&!n&&(this.__isDraggingOver=!1),this.__isDraggingOver&&(t.preventDefault(),e.canDrop=!0,e.dropTarget=this.target)}dragLeaveHandler(){(this.__isDraggingOver||this.isActive())&&(this.__isDraggingOver=!1)}dropHandler(e){var s;const{e:t}=e,o=t.defaultPrevented;this.__isDraggingOver=!1,t.preventDefault();let n=null===(s=t.dataTransfer)||0[0]===s?0[0]:s.getData("text/plain");if(n&&!o){const s=this.target,i=s.canvas;let o=s.getSelectionStartFromPointer(t);const{styles:r}=t.dataTransfer.types.includes("application/fabric")?JSON.parse(t.dataTransfer.getData("application/fabric")):{},c=n[Math.max(0,n.length-1)],a=0;if(this.__dragStartSelection){const e=this.__dragStartSelection.selectionStart,t=this.__dragStartSelection.selectionEnd;o>e&&o<=t?o=e:o>t&&(o-=t-e),s.removeChars(e,t),delete this.__dragStartSelection}s._reNewline.test(c)&&(s._reNewline.test(s._text[o])||o===s._text.length)&&(n=n.trimEnd()),e.didDrop=!0,e.dropTarget=s,s.insertChars(n,r,o),i.setActiveObject(s),s.enterEditing(t),s.selectionStart=Math.min(o+a,s._text.length),s.selectionEnd=Math.min(s.selectionStart+n.length,s._text.length),s.hiddenTextarea.value=s.text,s._updateTextarea(),s.hiddenTextarea.focus(),s.fire(Ss,{index:o+a,action:"drop"}),i.fire("text:changed",{target:s}),i.contextTopDirty=!0,i.requestRenderAll()}}dragEndHandler(e){let{e:n}=e;if(this.isActive()&&this.__dragStartFired&&this.__dragStartSelection){var t;const e=this.target,o=this.target.canvas,{selectionStart:s,selectionEnd:i}=this.__dragStartSelection,a=(null===(t=n.dataTransfer)||0[0]===t?0[0]:t.dropEffect)||N;a===N?(e.selectionStart=s,e.selectionEnd=i,e._updateTextarea(),e.hiddenTextarea.focus()):(e.clearContextTop(),"move"===a&&(e.removeChars(s,i),e.selectionStart=e.selectionEnd=s,e.hiddenTextarea&&(e.hiddenTextarea.value=e.text),e._updateTextarea(),e.fire(Ss,{index:s,action:"dragend"}),o.fire("text:changed",{target:e}),o.requestRenderAll()),e.exitEditing())}this.__dragImageDisposer&&this.__dragImageDisposer(),delete this.__dragImageDisposer,delete this.__dragStartSelection,this.__isDraggingOver=!1}dispose(){this._dispose&&this._dispose()}},$a=/[ \n.,;!?-]/,td=class extends re{constructor(){super(...arguments),s(this,"_currentCursorOpacity",1)}initBehavior(){this._tick=this._tick.bind(this),this._onTickComplete=this._onTickComplete.bind(this),this.updateSelectionOnMouseMove=this.updateSelectionOnMouseMove.bind(this)}onDeselect(e){return this.isEditing&&this.exitEditing(),this.selected=!1,super.onDeselect(e)}_animateCursor(e){let{toValue:t,duration:n,delay:s,onComplete:o}=e;return oa({startValue:this._currentCursorOpacity,endValue:t,duration:n,delay:s,onComplete:o,abort:()=>!this.canvas||this.selectionStart!==this.selectionEnd,onChange:e=>{this._currentCursorOpacity=e,this.renderCursorOrSelection()}})}_tick(e){this._currentTickState=this._animateCursor({toValue:0,duration:this.cursorDuration/2,delay:Math.max(e||0,100),onComplete:this._onTickComplete})}_onTickComplete(){var e;null===(e=this._currentTickCompleteState)||0[0]===e||e.abort(),this._currentTickCompleteState=this._animateCursor({toValue:1,duration:this.cursorDuration,onComplete:this._tick})}initDelayedCursor(e){this.abortCursorAnimation(),this._tick(e?0:this.cursorDelay)}abortCursorAnimation(){let e=!1;[this._currentTickState,this._currentTickCompleteState].forEach(t=>{t&&!t.isDone()&&(e=!0,t.abort())}),this._currentCursorOpacity=1,e&&this.clearContextTop()}restartCursorIfNeeded(){[this._currentTickState,this._currentTickCompleteState].some(e=>!e||e.isDone())&&this.initDelayedCursor()}selectAll(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this}cmdAll(){this.selectAll(),this.renderCursorOrSelection()}getSelectedText(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")}findWordBoundaryLeft(e){let n=0,t=e-1;if(this._reSpace.test(this._text[t]))for(;this._reSpace.test(this._text[t]);)n++,t--;for(;/\S/.test(this._text[t])&&t>-1;)n++,t--;return e-n}findWordBoundaryRight(e){let n=0,t=e;if(this._reSpace.test(this._text[t]))for(;this._reSpace.test(this._text[t]);)n++,t++;for(;/\S/.test(this._text[t])&&t<this._text.length;)n++,t++;return e+n}findLineBoundaryLeft(e){let n=0,t=e-1;for(;!/\n/.test(this._text[t])&&t>-1;)n++,t--;return e-n}findLineBoundaryRight(e){let n=0,t=e;for(;!/\n/.test(this._text[t])&&t<this._text.length;)n++,t++;return e+n}searchWordBoundary(e,t){const s=this._text;let n=e>0&&this._reSpace.test(s[e])&&(-1===t||!ro.test(s[e-1]))?e-1:e,o=s[n];for(;n>0&&n<s.length&&!$a.test(o);)n+=t,o=s[n];return-1===t&&$a.test(o)&&n++,n}selectWord(e){var t;e=null!==(t=e)&&0[0]!==t?t:this.selectionStart;const n=this.searchWordBoundary(e,-1),s=Math.max(n,this.searchWordBoundary(e,1));this.selectionStart=n,this.selectionEnd=s,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()}selectLine(e){var t;e=null!==(t=e)&&0[0]!==t?t:this.selectionStart;const n=this.findLineBoundaryLeft(e),s=this.findLineBoundaryRight(e);this.selectionStart=n,this.selectionEnd=s,this._fireSelectionChanged(),this._updateTextarea()}enterEditing(e){!this.isEditing&&this.editable&&(this.enterEditingImpl(),this.fire("editing:entered",e?{e}:0[0]),this._fireSelectionChanged(),this.canvas&&(this.canvas.fire("text:editing:entered",{target:this,e}),this.canvas.requestRenderAll()))}enterEditingImpl(){this.canvas&&(this.canvas.calcOffset(),this.canvas.textEditingManager.exitTextEditing()),this.isEditing=!0,this.initHiddenTextarea(),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick()}updateSelectionOnMouseMove(e){if(this.getActiveControl())return;const n=this.hiddenTextarea;ne(n).activeElement!==n&&n.focus();const t=this.getSelectionStartFromPointer(e),s=this.selectionStart,o=this.selectionEnd;(t===this.__selectionStartOnMouseDown&&s!==o||s!==t&&o!==t)&&(t>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=t):(this.selectionStart=t,this.selectionEnd=this.__selectionStartOnMouseDown),this.selectionStart===s&&this.selectionEnd===o||(this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()))}_setEditingProps(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0}fromStringToGraphemeSelection(e,t,n){const o=n.slice(0,e),s=this.graphemeSplit(o).length;if(e===t)return{selectionStart:s,selectionEnd:s};const i=n.slice(e,t);return{selectionStart:s,selectionEnd:s+this.graphemeSplit(i).length}}fromGraphemeToStringSelection(e,t,n){const s=n.slice(0,e).join("").length;return e===t?{selectionStart:s,selectionEnd:s}:{selectionStart:s,selectionEnd:s+n.slice(e,t).join("").length}}_updateTextarea(){if(this.cursorOffsetCache={},this.hiddenTextarea){if(!this.inCompositionMode){const e=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=e.selectionStart,this.hiddenTextarea.selectionEnd=e.selectionEnd}this.updateTextareaPosition()}}updateFromTextArea(){if(!this.hiddenTextarea)return;this.cursorOffsetCache={};const e=this.hiddenTextarea;this.text=e.value,this.set("dirty",!0),this.initDimensions(),this.setCoords();const t=this.fromStringToGraphemeSelection(e.selectionStart,e.selectionEnd,e.value);this.selectionEnd=this.selectionStart=t.selectionEnd,this.inCompositionMode||(this.selectionStart=t.selectionStart),this.updateTextareaPosition()}updateTextareaPosition(){if(this.selectionStart===this.selectionEnd){const e=this._calcTextareaPosition();this.hiddenTextarea.style.left=e.left,this.hiddenTextarea.style.top=e.top}}_calcTextareaPosition(){if(!this.canvas)return{left:"1px",top:"1px"};const r=this.inCompositionMode?this.compositionStart:this.selectionStart,n=this._getCursorBoundaries(r),a=this.get2DCursorLocation(r),h=a.lineIndex,f=a.charIndex,t=this.getValueOfPropertyAt(h,f,"fontSize")*this.lineHeight,m=n.leftOffset,l=this.getCanvasRetinaScaling(),s=this.canvas.upperCanvasEl,d=s.width/l,u=s.height/l,i=d-t,c=u-t,e=new o(n.left+m,n.top+n.topOffset+t).transform(this.calcTransformMatrix()).transform(this.canvas.viewportTransform).multiply(new o(s.clientWidth/d,s.clientHeight/u));return e.x<0&&(e.x=0),e.x>i&&(e.x=i),e.y<0&&(e.y=0),e.y>c&&(e.y=c),e.x+=this.canvas._offset.left,e.y+=this.canvas._offset.top,{left:"".concat(e.x,"px"),top:"".concat(e.y,"px"),fontSize:"".concat(t,"px"),charHeight:t}}_saveEditingProps(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}}_restoreEditingProps(){this._savedProps&&(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor||this.canvas.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor||this.canvas.moveCursor),delete this._savedProps)}_exitEditing(){const e=this.hiddenTextarea;this.selected=!1,this.isEditing=!1,e&&(e.blur&&e.blur(),e.parentNode&&e.parentNode.removeChild(e)),this.hiddenTextarea=null,this.abortCursorAnimation(),this.selectionStart!==this.selectionEnd&&this.clearContextTop()}exitEditingImpl(){this._exitEditing(),this.selectionEnd=this.selectionStart,this._restoreEditingProps(),this._forceClearCache&&(this.initDimensions(),this.setCoords())}exitEditing(){const e=this._textBeforeEdit!==this.text;return this.exitEditingImpl(),this.fire("editing:exited"),e&&this.fire(ks),this.canvas&&(this.canvas.fire("text:editing:exited",{target:this}),e&&this.canvas.fire("object:modified",{target:this})),this}_removeExtraneousStyles(){for(const e in this.styles)this._textLines[e]||delete this.styles[e]}removeStyleFromTo(e,t){const{lineIndex:n,charIndex:i}=this.get2DCursorLocation(e,!0),{lineIndex:s,charIndex:o}=this.get2DCursorLocation(t,!0);if(n!==s){if(this.styles[n])for(let e=i;e<this._unwrappedTextLines[n].length;e++)delete this.styles[n][e];if(this.styles[s])for(let e=o;e<this._unwrappedTextLines[s].length;e++){const t=this.styles[s][e];t&&(this.styles[n]||(this.styles[n]={}),this.styles[n][i+e-o]=t)}for(let e=n+1;e<=s;e++)delete this.styles[e];this.shiftLineStyles(s,n-s)}else if(this.styles[n]){const e=this.styles[n],t=o-i;for(let t=i;t<o;t++)delete e[t];for(const s in this.styles[n]){const i=parseInt(s,10);i>=o&&(e[i-t]=e[s],delete e[s])}}}shiftLineStyles(e,t){const n=Object.assign({},this.styles);for(const o in this.styles){const s=parseInt(o,10);s>e&&(this.styles[s+t]=n[s],n[s-t]||delete this.styles[s])}}insertNewlineStyleObject(e,t,s,o){const i={},a=this._unwrappedTextLines[e].length,r=a===t;let c=!1;s||(s=1),this.shiftLineStyles(e,s);const l=this.styles[e]?this.styles[e][0===t?t:t-1]:0[0];for(const n in this.styles[e]){const s=parseInt(n,10);s>=t&&(c=!0,i[s-t]=this.styles[e][n],r&&0===t||delete this.styles[e][n])}let d=!1;for(c&&!r&&(this.styles[e+s]=i,d=!0),(d||a>t)&&s--;s>0;)o&&o[s-1]?this.styles[e+s]={0:n({},o[s-1])}:l?this.styles[e+s]={0:n({},l)}:delete this.styles[e+s],s--;this._forceClearCache=!0}insertCharStyleObject(e,t,s,o){this.styles||(this.styles={});const i=this.styles[e],a=i?n({},i):{};s||(s=1);for(const n in a){const e=parseInt(n,10);e>=t&&(i[e+s]=a[e],a[e-s]||delete i[e])}if(this._forceClearCache=!0,o){for(;s--;)Object.keys(o[s]).length&&(this.styles[e]||(this.styles[e]={}),this.styles[e][t+s]=n({},o[s]));return}if(!i)return;const r=i[t?t-1:1];for(;r&&s--;)this.styles[e][t+s]=n({},r)}insertNewStyleBlock(e,t,n){const i=this.get2DCursorLocation(t,!0),o=[0];let s,a=0;for(let t=0;t<e.length;t++)`
`===e[t]?(a++,o[a]=0):o[a]++;for(o[0]>0&&(this.insertCharStyleObject(i.lineIndex,i.charIndex,o[0],n),n=n&&n.slice(o[0]+1)),a&&this.insertNewlineStyleObject(i.lineIndex,i.charIndex+o[0],a),s=1;s<a;s++)o[s]>0?this.insertCharStyleObject(i.lineIndex+s,0,o[s],n):n&&this.styles[i.lineIndex+s]&&n[0]&&(this.styles[i.lineIndex+s][0]=n[0]),n=n&&n.slice(o[s]+1);o[s]>0&&this.insertCharStyleObject(i.lineIndex+s,0,o[s],n)}removeChars(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:e+1;this.removeStyleFromTo(e,t),this._text.splice(e,t-e),this.text=this._text.join(""),this.set("dirty",!0),this.initDimensions(),this.setCoords(),this._removeExtraneousStyles()}insertChars(e,t,n){let s=arguments.length>3&&0[0]!==arguments[3]?arguments[3]:n;s>n&&this.removeStyleFromTo(n,s);const o=this.graphemeSplit(e);this.insertNewStyleBlock(o,n,t),this._text=[...this._text.slice(0,n),...o,...this._text.slice(s)],this.text=this._text.join(""),this.set("dirty",!0),this.initDimensions(),this.setCoords(),this._removeExtraneousStyles()}setSelectionStartEndWithShift(e,t,n){n<=e?(t===e?this._selectionDirection=j:this._selectionDirection===C&&(this._selectionDirection=j,this.selectionEnd=e),this.selectionStart=n):n>e&&n<t?this._selectionDirection===C?this.selectionEnd=n:this.selectionStart=n:(t===e?this._selectionDirection=C:this._selectionDirection===j&&(this._selectionDirection=C,this.selectionStart=t),this.selectionEnd=n)}},ed=class extends td{initHiddenTextarea(){const t=this.canvas&&ne(this.canvas.getElement())||Ze(),e=t.createElement("textarea");Object.entries({autocapitalize:"off",autocorrect:"off",autocomplete:"off",spellcheck:"false","data-fabric":"textarea",wrap:"off"}).map(t=>{let[n,s]=t;return e.setAttribute(n,s)});const{top:n,left:s,fontSize:o}=this._calcTextareaPosition();e.style.cssText="position: absolute; top: ".concat(n,"; left: ").concat(s,"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; padding-top: ").concat(o,";"),(this.hiddenTextareaContainer||t.body).appendChild(e),Object.entries({blur:"blur",keydown:"onKeyDown",keyup:"onKeyUp",input:"onInput",copy:"copy",cut:"copy",paste:"paste",compositionstart:"onCompositionStart",compositionupdate:"onCompositionUpdate",compositionend:"onCompositionEnd"}).map(t=>{let[n,s]=t;return e.addEventListener(n,this[s].bind(this))}),this.hiddenTextarea=e}blur(){this.abortCursorAnimation()}onKeyDown(e){if(!this.isEditing)return;const t="rtl"===this.direction?this.keysMapRtl:this.keysMap;if(e.keyCode in t)this[t[e.keyCode]](e);else{if(!(e.keyCode in this.ctrlKeysMapDown)||!e.ctrlKey&&!e.metaKey)return;this[this.ctrlKeysMapDown[e.keyCode]](e)}e.stopImmediatePropagation(),e.preventDefault(),e.keyCode>=33&&e.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}onKeyUp(e){!this.isEditing||this._copyDone||this.inCompositionMode?this._copyDone=!1:e.keyCode in this.ctrlKeysMapUp&&(e.ctrlKey||e.metaKey)&&(this[this.ctrlKeysMapUp[e.keyCode]](e),e.stopImmediatePropagation(),e.preventDefault(),this.canvas&&this.canvas.requestRenderAll())}onInput(e){const v=this.fromPaste,{value:h,selectionStart:y,selectionEnd:j}=this.hiddenTextarea;if(this.fromPaste=!1,e&&e.stopPropagation(),!this.isEditing)return;const u=()=>{this.updateFromTextArea(),this.fire(Ss),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())};if(""===this.hiddenTextarea.value)return this.styles={},void u();const f=this._splitTextIntoLines(h).graphemeText,p=this._text.length,d=f.length,t=this.selectionStart,n=this.selectionEnd,m=t!==n;let o,s,r,c,a=d-p;const l=this.fromStringToGraphemeSelection(y,j,h),g=t>l.selectionStart;m?(s=this._text.slice(t,n),a+=n-t):d<p&&(s=g?this._text.slice(n+a,n):this._text.slice(t,t-a));const i=f.slice(l.selectionEnd-a,l.selectionEnd);if(s&&s.length&&(i.length&&(o=this.getSelectionStyles(t,t+1,!1),o=i.map(()=>o[0])),m?(r=t,c=n):g?(r=n-s.length,c=n):(r=n,c=n+s.length),this.removeStyleFromTo(r,c)),i.length){const{copyPasteData:e}=ue();v&&i.join("")===e.copiedText&&!b.disableStyleCopyPaste&&(o=e.copiedTextStyle),this.insertNewStyleBlock(i,t,o)}u()}onCompositionStart(){this.inCompositionMode=!0}onCompositionEnd(){this.inCompositionMode=!1}onCompositionUpdate(e){let{target:t}=e;const{selectionStart:n,selectionEnd:s}=t;this.compositionStart=n,this.compositionEnd=s,this.updateTextareaPosition()}copy(){if(this.selectionStart===this.selectionEnd)return;const{copyPasteData:e}=ue();e.copiedText=this.getSelectedText(),b.disableStyleCopyPaste?e.copiedTextStyle=0[0]:e.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0}paste(){this.fromPaste=!0}_getWidthBeforeCursor(e,t){let n,s=this._getLineLeftOffset(e);return t>0&&(n=this.__charBounds[e][t-1],s+=n.left+n.width),s}getDownCursorOffset(e,t){const s=this._getSelectionForOffset(e,t),o=this.get2DCursorLocation(s),n=o.lineIndex;if(n===this._textLines.length-1||e.metaKey||34===e.keyCode)return this._text.length-s;const i=o.charIndex,a=this._getWidthBeforeCursor(n,i),r=this._getIndexOnLine(n+1,a);return this._textLines[n].slice(i).length+r+1+this.missingNewlineOffset(n)}_getSelectionForOffset(e,t){return e.shiftKey&&this.selectionStart!==this.selectionEnd&&t?this.selectionEnd:this.selectionStart}getUpCursorOffset(e,t){const s=this._getSelectionForOffset(e,t),o=this.get2DCursorLocation(s),n=o.lineIndex;if(0===n||e.metaKey||33===e.keyCode)return-s;const i=o.charIndex,a=this._getWidthBeforeCursor(n,i),r=this._getIndexOnLine(n-1,a),c=this._textLines[n].slice(0,i),l=this.missingNewlineOffset(n-1);return-this._textLines[n-1].length+r-c.length+(1-l)}_getIndexOnLine(e,t){const i=this._textLines[e];let s,a,n=this._getLineLeftOffset(e),o=0;for(let r=0,c=i.length;r<c;r++)if(s=this.__charBounds[e][r].width,n+=s,n>t){a=!0;const e=n-s,i=n,c=Math.abs(e-t);o=Math.abs(i-t)<c?r:r-1;break}return a||(o=i.length-1),o}moveCursorDown(e){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",e)}moveCursorUp(e){0===this.selectionStart&&0===this.selectionEnd||this._moveCursorUpOrDown("Up",e)}_moveCursorUpOrDown(e,t){const n=this["get".concat(e,"CursorOffset")](t,this._selectionDirection===C);if(t.shiftKey?this.moveCursorWithShift(n):this.moveCursorWithoutShift(n),0!==n){const e=this.text.length;this.selectionStart=Xe(0,this.selectionStart,e),this.selectionEnd=Xe(0,this.selectionEnd,e),this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea()}}moveCursorWithShift(e){const t=this._selectionDirection===j?this.selectionStart+e:this.selectionEnd+e;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,t),0!==e}moveCursorWithoutShift(e){return e<0?(this.selectionStart+=e,this.selectionEnd=this.selectionStart):(this.selectionEnd+=e,this.selectionStart=this.selectionEnd),0!==e}moveCursorLeft(e){0===this.selectionStart&&0===this.selectionEnd||this._moveCursorLeftOrRight("Left",e)}_move(e,t,n){let s;if(e.altKey)s=this["findWordBoundary".concat(n)](this[t]);else{if(!e.metaKey&&35!==e.keyCode&&36!==e.keyCode)return this[t]+="Left"===n?-1:1,!0;s=this["findLineBoundary".concat(n)](this[t])}return 0[0]!==s&&this[t]!==s&&(this[t]=s,!0)}_moveLeft(e,t){return this._move(e,t,"Left")}_moveRight(e,t){return this._move(e,t,"Right")}moveCursorLeftWithoutShift(e){let t=!0;return this._selectionDirection=j,this.selectionEnd===this.selectionStart&&0!==this.selectionStart&&(t=this._moveLeft(e,"selectionStart")),this.selectionEnd=this.selectionStart,t}moveCursorLeftWithShift(e){return this._selectionDirection===C&&this.selectionStart!==this.selectionEnd?this._moveLeft(e,"selectionEnd"):0!==this.selectionStart?(this._selectionDirection=j,this._moveLeft(e,"selectionStart")):0[0]}moveCursorRight(e){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",e)}_moveCursorLeftOrRight(e,t){const n="moveCursor".concat(e).concat(t.shiftKey?"WithShift":"WithoutShift");this._currentCursorOpacity=1,this[n](t)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())}moveCursorRightWithShift(e){return this._selectionDirection===j&&this.selectionStart!==this.selectionEnd?this._moveRight(e,"selectionStart"):this.selectionEnd!==this._text.length?(this._selectionDirection=C,this._moveRight(e,"selectionEnd")):0[0]}moveCursorRightWithoutShift(e){let t=!0;return this._selectionDirection=C,this.selectionStart===this.selectionEnd?(t=this._moveRight(e,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,t}},Ka=e=>!!e.button,Jl=class extends ed{constructor(){super(...arguments),s(this,"draggableTextDelegate",0[0])}initBehavior(){this.on("mousedown",this._mouseDownHandler),this.on("mouseup",this.mouseUpHandler),this.on("mousedblclick",this.doubleClickHandler),this.on("mousetripleclick",this.tripleClickHandler),this.draggableTextDelegate=new nd(this),super.initBehavior()}shouldStartDragging(){return this.draggableTextDelegate.isActive()}onDragStart(e){return this.draggableTextDelegate.onDragStart(e)}canDrop(e){return this.draggableTextDelegate.canDrop(e)}doubleClickHandler(e){this.isEditing&&(this.selectWord(this.getSelectionStartFromPointer(e.e)),this.renderCursorOrSelection())}tripleClickHandler(e){this.isEditing&&(this.selectLine(this.getSelectionStartFromPointer(e.e)),this.renderCursorOrSelection())}_mouseDownHandler(e){let{e:t,alreadySelected:n}=e;this.canvas&&this.editable&&!Ka(t)&&!this.getActiveControl()&&(this.draggableTextDelegate.start(t)||(this.canvas.textEditingManager.register(this),n&&(this.inCompositionMode=!1,this.setCursorByClick(t)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()),this.selected||(this.selected=n||this.isEditing)))}mouseUpHandler(e){let{e:t,transform:n}=e;const s=this.draggableTextDelegate.end(t);if(this.canvas){this.canvas.textEditingManager.unregister(this);const e=this.canvas._activeObject;if(e&&e!==this)return}!this.editable||this.group&&!this.group.interactive||n&&n.actionPerformed||Ka(t)||s||this.selected&&!this.getActiveControl()&&(this.enterEditing(t),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection())}setCursorByClick(e){const t=this.getSelectionStartFromPointer(e),n=this.selectionStart,s=this.selectionEnd;e.shiftKey?this.setSelectionStartEndWithShift(n,s,t):(this.selectionStart=t,this.selectionEnd=t),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())}getSelectionStartFromPointer(e){const n=this.canvas.getScenePoint(e).transform($(this.calcTransformMatrix())).add(new o(-this._getLeftOffset(),-this._getTopOffset()));let a=0,t=0,s=0;for(let e=0;e<this._textLines.length&&a<=n.y;e++)a+=this.getHeightOfLine(e),s=e,e>0&&(t+=this._textLines[e-1].length+this.missingNewlineOffset(e-1));let i=Math.abs(this._getLineLeftOffset(s));const r=this._textLines[s].length,c=this.__charBounds[s];for(let e=0;e<r;e++){const s=i+c[e].kernedWidth;if(n.x<=s){Math.abs(n.x-s)<=Math.abs(n.x-i)&&t++;break}i=s,t++}return Math.min(this.flipX?r-t:t,this._text.length)}},es="moveCursorUp",ts="moveCursorDown",ns="moveCursorLeft",ss="moveCursorRight",os="exitEditing",Ja=(e,t)=>{const s=t.getRetinaScaling();e.setTransform(s,0,0,s,0,0);const n=t.viewportTransform;e.transform(n[0],n[1],n[2],n[3],n[4],n[5])},Zl=n({selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,hiddenTextareaContainer:null,keysMap:{9:os,27:os,33:es,34:ts,35:ss,36:ns,37:ns,38:es,39:ss,40:ts},keysMapRtl:{9:os,27:os,33:es,34:ts,35:ns,36:ss,37:ss,38:es,39:ns,40:ts},ctrlKeysMapDown:{65:"cmdAll"},ctrlKeysMapUp:{67:"copy",88:"cut"}},{_selectionDirection:null,_reSpace:/\s|\r?\n/,inCompositionMode:!1}),pt=class _Ho extends Jl{static getDefaults(){return n(n({},super.getDefaults()),_Ho.ownDefaults)}get type(){const e=super.type;return"itext"===e?"i-text":e}constructor(e,t){super(e,n(n({},_Ho.ownDefaults),t)),this.initBehavior()}_set(e,t){return this.isEditing&&this._savedProps&&e in this._savedProps?(this._savedProps[e]=t,this):("canvas"===e&&(this.canvas instanceof Ji&&this.canvas.textEditingManager.remove(this),t instanceof Ji&&t.textEditingManager.add(this)),super._set(e,t))}setSelectionStart(e){e=Math.max(e,0),this._updateAndFire("selectionStart",e)}setSelectionEnd(e){e=Math.min(e,this.text.length),this._updateAndFire("selectionEnd",e)}_updateAndFire(e,t){this[e]!==t&&(this._fireSelectionChanged(),this[e]=t),this._updateTextarea()}_fireSelectionChanged(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})}initDimensions(){this.isEditing&&this.initDelayedCursor(),super.initDimensions()}getSelectionStyles(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:this.selectionStart||0,t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:this.selectionEnd,n=arguments.length>2?arguments[2]:0[0];return super.getSelectionStyles(e,t,n)}setSelectionStyles(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:this.selectionStart||0,n=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:this.selectionEnd;return super.setSelectionStyles(e,t,n)}get2DCursorLocation(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:this.selectionStart,t=arguments.length>1?arguments[1]:0[0];return super.get2DCursorLocation(e,t)}render(e){super.render(e),this.cursorOffsetCache={},this.renderCursorOrSelection()}toCanvasElement(e){const t=this.isEditing;this.isEditing=!1;const n=super.toCanvasElement(e);return this.isEditing=t,n}renderCursorOrSelection(){if(!this.isEditing||!this.canvas)return;const e=this.clearContextTop(!0);if(!e)return;const o=this._getCursorBoundaries(),i=this.findAncestorsWithClipPath(),n=i.length>0;let s,t=e;if(n){s=K(e.canvas),t=s.getContext("2d"),Ja(t,this.canvas);const n=this.calcTransformMatrix();t.transform(n[0],n[1],n[2],n[3],n[4],n[5])}if(this.selectionStart!==this.selectionEnd||this.inCompositionMode?this.renderSelection(t,o):this.renderCursor(t,o),n)for(const o of i){const n=o.clipPath,a=K(e.canvas),s=a.getContext("2d");if(Ja(s,this.canvas),!n.absolutePositioned){const e=o.calcTransformMatrix();s.transform(e[0],e[1],e[2],e[3],e[4],e[5])}n.transform(s),n.drawObject(s,!0,{}),this.drawClipPathOnCache(t,n,a)}n&&(e.setTransform(1,0,0,1,0,0),e.drawImage(s,0,0)),this.canvas.contextTopDirty=!0,e.restore()}findAncestorsWithClipPath(){const t=[];let e=this;for(;e;)e.clipPath&&t.push(e),e=e.parent;return t}_getCursorBoundaries(){let t=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:this.selectionStart,n=arguments.length>1?arguments[1]:0[0];const s=this._getLeftOffset(),o=this._getTopOffset(),e=this._getCursorBoundariesOffsets(t,n);return{left:s,top:o,leftOffset:e.left,topOffset:e.top}}_getCursorBoundariesOffsets(e,t){return t?this.__getCursorBoundariesOffsets(e):this.cursorOffsetCache&&"top"in this.cursorOffsetCache?this.cursorOffsetCache:this.cursorOffsetCache=this.__getCursorBoundariesOffsets(e)}__getCursorBoundariesOffsets(e){let i=0,t=0;const{charIndex:a,lineIndex:n}=this.get2DCursorLocation(e);for(let e=0;e<n;e++)i+=this.getHeightOfLine(e);const o=this._getLineLeftOffset(n),r=this.__charBounds[n][a];r&&(t=r.left),0!==this.charSpacing&&a===this._textLines[n].length&&(t-=this._getWidthOfCharSpacing());const s={top:i,left:o+(t>0?t:0)};return"rtl"===this.direction&&(this.textAlign===C||this.textAlign===ie||this.textAlign===hn?s.left*=-1:this.textAlign===j||this.textAlign===$n?s.left=o-(t>0?t:0):this.textAlign!==m&&this.textAlign!==mn||(s.left=o-(t>0?t:0))),s}renderCursorAt(e){this._renderCursor(this.canvas.contextTop,this._getCursorBoundaries(e,!0),e)}renderCursor(e,t){this._renderCursor(e,t,this.selectionStart)}getCursorRenderingData(){let o=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:this.selectionStart,e=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:this._getCursorBoundaries(o);const n=this.get2DCursorLocation(o),t=n.lineIndex,s=n.charIndex>0?n.charIndex-1:0,i=this.getValueOfPropertyAt(t,s,"fontSize"),r=this.getObjectScaling().x*this.canvas.getZoom(),a=this.cursorWidth/r,c=this.getValueOfPropertyAt(t,s,"deltaY"),l=e.topOffset+(1-this._fontSizeFraction)*this.getHeightOfLine(t)/this.lineHeight-i*(1-this._fontSizeFraction);return{color:this.cursorColor||this.getValueOfPropertyAt(t,s,"fill"),opacity:this._currentCursorOpacity,left:e.left+e.leftOffset-a/2,top:l+e.top+c,width:a,height:i}}_renderCursor(e,t,n){const{color:s,opacity:o,left:i,top:a,width:r,height:c}=this.getCursorRenderingData(n,t);e.fillStyle=s,e.globalAlpha=o,e.fillRect(i,a,r,c)}renderSelection(e,t){const n={selectionStart:this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,selectionEnd:this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd};this._renderSelection(e,n,t)}renderDragSourceEffect(){const e=this.draggableTextDelegate.getDragStartSelection();this._renderSelection(this.canvas.contextTop,e,this._getCursorBoundaries(e.selectionStart,!0))}renderDropTargetEffect(e){const t=this.getSelectionStartFromPointer(e);this.renderCursorAt(t)}_renderSelection(e,t,n){const c=t.selectionStart,l=t.selectionEnd,d=this.textAlign.includes(ie),a=this.get2DCursorLocation(c),r=this.get2DCursorLocation(l),o=a.lineIndex,s=r.lineIndex,u=a.charIndex<0?0:a.charIndex,i=r.charIndex<0?0:r.charIndex;for(let t=o;t<=s;t++){const l=this._getLineLeftOffset(t)||0;let c=this.getHeightOfLine(t),f=0,h=0,a=0;if(t===o&&(h=this.__charBounds[o][u].left),t>=o&&t<s)a=d&&!this.isEndOfWrapping(t)?this.width:this.getLineWidth(t)||5;else if(t===s)if(0===i)a=this.__charBounds[s][i].left;else{const e=this._getWidthOfCharSpacing();a=this.__charBounds[s][i-1].left+this.__charBounds[s][i-1].width-e}f=c,(this.lineHeight<1||t===s&&this.lineHeight>1)&&(c/=this.lineHeight);let r=n.left+l+h,p=c,g=0;const v=a-h;this.inCompositionMode?(e.fillStyle=this.compositionColor||"black",p=1,g=c):e.fillStyle=this.selectionColor,"rtl"===this.direction&&(this.textAlign===C||this.textAlign===ie||this.textAlign===hn?r=this.width-r-v:this.textAlign===j||this.textAlign===$n?r=n.left+l-a:this.textAlign!==m&&this.textAlign!==mn||(r=n.left+l-a)),e.fillRect(r,n.top+n.topOffset+g,v,p),n.topOffset+=f}}getCurrentCharFontSize(){const e=this._getCurrentCharIndex();return this.getValueOfPropertyAt(e.l,e.c,"fontSize")}getCurrentCharColor(){const e=this._getCurrentCharIndex();return this.getValueOfPropertyAt(e.l,e.c,A)}_getCurrentCharIndex(){const e=this.get2DCursorLocation(this.selectionStart,!0),t=e.charIndex>0?e.charIndex-1:0;return{l:e.lineIndex,c:t}}dispose(){this.exitEditingImpl(),this.draggableTextDelegate.dispose(),super.dispose()}},s(pt,"ownDefaults",Zl),s(pt,"type","IText"),c.setClass(pt),c.setClass(pt,"i-text"),hs=class _No extends pt{static getDefaults(){return n(n({},super.getDefaults()),_No.ownDefaults)}constructor(e,t){super(e,n(n({},_No.ownDefaults),t))}static createControls(){return{controls:Lc()}}initDimensions(){this.initialized&&(this.isEditing&&this.initDelayedCursor(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),this.textAlign.includes(ie)&&this.enlargeSpaces(),this.height=this.calcTextHeight())}_generateStyleMap(e){let s=0,n=0,t=0;const o={};for(let i=0;i<e.graphemeLines.length;i++)`
`===e.graphemeText[t]&&i>0?(n=0,t++,s++):!this.splitByGrapheme&&this._reSpaceAndTab.test(e.graphemeText[t])&&i>0&&(n++,t++),o[i]={line:s,offset:n},t+=e.graphemeLines[i].length,n+=e.graphemeLines[i].length;return o}styleHas(e,t){if(this._styleMap&&!this.isWrapping){const e=this._styleMap[t];e&&(t=e.line)}return super.styleHas(e,t)}isEmptyStyles(e){if(!this.styles)return!0;let o,i=0,a=e+1,r=!1;const t=this._styleMap[e],n=this._styleMap[e+1];t&&(e=t.line,i=t.offset),n&&(a=n.line,r=a===e,o=n.offset);const s=0[0]===e?this.styles:{line:this.styles[e]};for(const e in s)for(const t in s[e]){const n=parseInt(t,10);if(n>=i&&(!r||n<o))for(const n in s[e][t])return!1}return!0}_getStyleDeclaration(e,t){if(this._styleMap&&!this.isWrapping){const n=this._styleMap[e];if(!n)return{};e=n.line,t=n.offset+t}return super._getStyleDeclaration(e,t)}_setStyleDeclaration(e,t,n){const s=this._styleMap[e];super._setStyleDeclaration(s.line,s.offset+t,n)}_deleteStyleDeclaration(e,t){const n=this._styleMap[e];super._deleteStyleDeclaration(n.line,n.offset+t)}_getLineStyle(e){const t=this._styleMap[e];return!!this.styles[t.line]}_setLineStyle(e){const t=this._styleMap[e];super._setLineStyle(t.line)}_wrapText(e,t){this.isWrapping=!0;const n=this.getGraphemeDataForRender(e),s=[];for(let e=0;e<n.wordsData.length;e++)s.push(...this._wrapLine(e,t,n));return this.isWrapping=!1,s}getGraphemeDataForRender(e){const t=this.splitByGrapheme,s=t?"":" ";let n=0;return{wordsData:e.map((e,o)=>{let i=0;const a=t?this.graphemeSplit(e):this.wordSplit(e);return 0===a.length?[{word:[],width:0}]:a.map(e=>{const a=t?[e]:this.graphemeSplit(e),r=this._measureWord(a,o,i);return n=Math.max(r,n),i+=a.length+s.length,{word:a,width:r}})}),largestWordWidth:n}}_measureWord(e,t){let n,o=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:0,s=0;for(let i=0,a=e.length;i<a;i++)s+=this._getGraphemeBox(e[i],t,i+o,n,!0).kernedWidth,n=e[i];return s}wordSplit(e){return e.split(this._wordJoiners)}_wrapLine(e,t,n){let{largestWordWidth:u,wordsData:v}=n,h=arguments.length>3&&0[0]!==arguments[3]?arguments[3]:0;const c=this._getWidthOfCharSpacing(),d=this.splitByGrapheme,l=[],m=d?"":" ";let i=0,s=[],r=0,f=0,a=!0;t-=h;const g=Math.max(t,u,this.dynamicMinWidth),p=v[e];let o;for(r=0,o=0;o<p.length;o++){const{word:t,width:n}=p[o];r+=t.length,i+=f+n-c,i>g&&!a?(l.push(s),s=[],i=n,a=!0):i+=c,a||d||s.push(m),s=s.concat(t),f=d?0:this._measureWord([m],e,r),r++,a=!1}return o&&l.push(s),u+h>this.dynamicMinWidth&&(this.dynamicMinWidth=u-c+h),l}isEndOfWrapping(e){return!this._styleMap[e+1]||this._styleMap[e+1].line!==this._styleMap[e].line}missingNewlineOffset(e,t){return this.splitByGrapheme&&!t?this.isEndOfWrapping(e)?1:0:1}_splitTextIntoLines(e){const t=super._splitTextIntoLines(e),n=this._wrapText(t.lines,this.width),s=new Array(n.length);for(let e=0;e<n.length;e++)s[e]=n[e].join("");return t.lines=s,t.graphemeLines=n,t}getMinWidth(){return Math.max(this.minWidth,this.dynamicMinWidth)}_removeExtraneousStyles(){const e=new Map;for(const t in this._styleMap){const n=parseInt(t,10);if(this._textLines[n]){const n=this._styleMap[t].line;e.set("".concat(n),!0)}}for(const t in this.styles)e.has(t)||delete this.styles[t]}toObject(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];return super.toObject(["minWidth","splitByGrapheme",...e])}},s(hs,"type","Textbox"),s(hs,"textLayoutProperties",[...pt.textLayoutProperties,"width"]),s(hs,"ownDefaults",{minWidth:20,dynamicMinWidth:2,lockScalingFlip:!0,noScaleCache:!1,_wordJoiners:/[ \t\r]/,splitByGrapheme:!1}),c.setClass(hs),sr=class extends cs{shouldPerformLayout(e){return!!e.target.clipPath&&super.shouldPerformLayout(e)}shouldLayoutClipPath(){return!1}calcLayoutResult(e,t){const{target:s}=e,{clipPath:n,group:a}=s;if(!n||!this.shouldPerformLayout(e))return;const{width:r,height:c}=fe(na(s,n)),i=new o(r,c);if(n.absolutePositioned)return{center:ye(n.getRelativeCenterPoint(),0[0],a?a.calcTransformMatrix():0[0]),size:i};{const a=n.getRelativeCenterPoint().transform(s.calcOwnMatrix(),!0);if(this.shouldPerformLayout(e)){const{center:n=new o,correction:s=new o}=this.calcBoundingBox(t,e)||{};return{center:n.add(a),correction:s.subtract(a),size:i}}return{center:s.getRelativeCenterPoint().add(a),size:i}}}},s(sr,"type","clip-path"),c.setClass(sr),or=class extends cs{getInitialSize(e,t){let{target:n}=e,{size:s}=t;return new o(n.width||s.x,n.height||s.y)}},s(or,"type","fixed"),c.setClass(or),Ql=class extends Wt{subscribeTargets(e){const t=e.target;e.targets.reduce((e,t)=>(t.parent&&e.add(t.parent),e),new Set).forEach(e=>{e.layoutManager.subscribeTargets({target:e,targets:[t]})})}unsubscribeTargets(e){const t=e.target,n=t.getObjects();e.targets.reduce((e,t)=>(t.parent&&e.add(t.parent),e),new Set).forEach(e=>{!n.some(t=>t.parent===e)&&e.layoutManager.unsubscribeTargets({target:e,targets:[t]})})}},ms=class _Jo extends Et{static getDefaults(){return n(n({},super.getDefaults()),_Jo.ownDefaults)}constructor(){let n=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[],e=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};super(),Object.assign(this,_Jo.ownDefaults),this.setOptions(e);const{left:s,top:o,layoutManager:t}=e;this.groupInit(n,{left:s,top:o,layoutManager:t??new Ql})}_shouldSetNestedCoords(){return!0}__objectSelectionMonitor(){}multiSelectAdd(){for(var n=arguments.length,t=new Array(n),e=0;e<n;e++)t[e]=arguments[e];"selection-order"===this.multiSelectionStacking?this.add(...t):t.forEach(e=>{const t=this._objects.findIndex(t=>t.isInFrontOf(e)),n=-1===t?this.size():t;this.insertAt(n,e)})}canEnterGroup(e){return this.getObjects().some(t=>t.isDescendantOf(e)||e.isDescendantOf(t))?(Ae("error","ActiveSelection: circular object trees are not supported, this call has no effect"),!1):super.canEnterGroup(e)}enterGroup(e,t){e.parent&&e.parent===e.group?e.parent._exitGroup(e):e.group&&e.parent!==e.group&&e.group.remove(e),this._enterGroup(e,t)}exitGroup(e,t){this._exitGroup(e,t),e.parent&&e.parent._enterGroup(e,!0)}_onAfterObjectsChange(e,t){super._onAfterObjectsChange(e,t);const n=new Set;t.forEach(e=>{const{parent:t}=e;t&&n.add(t)}),e===Qo?n.forEach(e=>{e._onAfterObjectsChange(ds,t)}):n.forEach(e=>{e._set("dirty",!0)})}onDeselect(){return this.removeAll(),!1}toString(){return"#<ActiveSelection: (".concat(this.complexity(),")>")}shouldCache(){return!1}isOnACache(){return!1}_renderControls(e,t,s){e.save(),e.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1;const o=n(n({hasControls:!1},s),{},{forActiveSelection:!0});for(let t=0;t<this._objects.length;t++)this._objects[t]._renderControls(e,o);super._renderControls(e,t),e.restore()}},s(ms,"type","ActiveSelection"),s(ms,"ownDefaults",{multiSelectionStacking:"canvas-stacking"}),c.setClass(ms),c.setClass(ms,"activeSelection"),Xl=class{constructor(){s(this,"resources",{})}applyFilters(e,t,n,s,o){const i=o.getContext("2d");if(!i)return;i.drawImage(t,0,0,n,s);const r={sourceWidth:n,sourceHeight:s,imageData:i.getImageData(0,0,n,s),originalEl:t,originalImageData:i.getImageData(0,0,n,s),canvasEl:o,ctx:i,filterBackend:this};e.forEach(e=>{e.applyTo(r)});const{imageData:a}=r;return a.width===n&&a.height===s||(o.width=a.width,o.height=a.height),i.putImageData(a,0,0),r}},cr=class{constructor(){let{tileSize:e=b.textureSize}=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};s(this,"aPosition",new Float32Array([0,0,0,1,1,0,1,1])),s(this,"resources",{}),this.tileSize=e,this.setupGLContext(e,e),this.captureGPUInfo()}setupGLContext(e,t){this.dispose(),this.createWebGLCanvas(e,t)}createWebGLCanvas(e,t){const s=K({width:e,height:t}),n=s.getContext("webgl",{alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1});n&&(n.clearColor(0,0,0,0),this.canvas=s,this.gl=n)}applyFilters(e,t,n,s,o,i){const a=this.gl,l=o.getContext("2d");if(!a||!l)return;let c;i&&(c=this.getCachedTexture(i,t));const r={originalWidth:t.width||t.naturalWidth||0,originalHeight:t.height||t.naturalHeight||0,sourceWidth:n,sourceHeight:s,destinationWidth:n,destinationHeight:s,context:a,sourceTexture:this.createTexture(a,n,s,c?0[0]:t),targetTexture:this.createTexture(a,n,s),originalTexture:c||this.createTexture(a,n,s,c?0[0]:t),passes:e.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:o},d=a.createFramebuffer();return a.bindFramebuffer(a.FRAMEBUFFER,d),e.forEach(e=>{e&&e.applyTo(r)}),function(e){const t=e.targetCanvas,o=t.width,i=t.height,n=e.destinationWidth,s=e.destinationHeight;o===n&&i===s||(t.width=n,t.height=s)}(r),this.copyGLTo2D(a,r),a.bindTexture(a.TEXTURE_2D,null),a.deleteTexture(r.sourceTexture),a.deleteTexture(r.targetTexture),a.deleteFramebuffer(d),l.setTransform(1,0,0,1,0,0),r}dispose(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()}clearWebGLCaches(){this.programCache={},this.textureCache={}}createTexture(e,t,n,s,o){const{NEAREST:r,TEXTURE_2D:i,RGBA:a,UNSIGNED_BYTE:c,CLAMP_TO_EDGE:l,TEXTURE_MAG_FILTER:u,TEXTURE_MIN_FILTER:h,TEXTURE_WRAP_S:m,TEXTURE_WRAP_T:f}=e,d=e.createTexture();return e.bindTexture(i,d),e.texParameteri(i,u,o||r),e.texParameteri(i,h,o||r),e.texParameteri(i,m,l),e.texParameteri(i,f,l),s?e.texImage2D(i,0,a,a,c,s):e.texImage2D(i,0,a,t,n,0,a,c,null),d}getCachedTexture(e,t,n){const{textureCache:s}=this;if(s[e])return s[e];{const o=this.createTexture(this.gl,t.width,t.height,t,n);return o&&(s[e]=o),o}}evictCachesForKey(e){this.textureCache[e]&&(this.gl.deleteTexture(this.textureCache[e]),delete this.textureCache[e])}copyGLTo2D(e,t){const o=e.canvas,n=t.targetCanvas,s=n.getContext("2d");if(!s)return;s.translate(0,n.height),s.scale(1,-1);const i=o.height-n.height;s.drawImage(o,0,i,n.width,n.height,0,0,n.width,n.height)}copyGLTo2DPutImageData(e,t){const o=t.targetCanvas.getContext("2d"),n=t.destinationWidth,s=t.destinationHeight,i=n*s*4;if(!o)return;const a=new Uint8Array(this.imageBuffer,0,i),r=new Uint8ClampedArray(this.imageBuffer,0,i);e.readPixels(0,0,n,s,e.RGBA,e.UNSIGNED_BYTE,a);const c=new ImageData(r,n,s);o.putImageData(c,0,0)}captureGPUInfo(){if(this.gpuInfo)return this.gpuInfo;const t=this.gl,e={renderer:"",vendor:""};if(!t)return e;const n=t.getExtension("WEBGL_debug_renderer_info");if(n){const s=t.getParameter(n.UNMASKED_RENDERER_WEBGL),o=t.getParameter(n.UNMASKED_VENDOR_WEBGL);s&&(e.renderer=s.toLowerCase()),o&&(e.vendor=o.toLowerCase())}return this.gpuInfo=e,e}};function Z0(){const{WebGLProbe:e}=ue();return e.queryWebGL(ae()),b.enableGLFiltering&&e.isSupported(b.textureSize)?new cr({tileSize:b.textureSize}):new Xl}function ur(){return!lr&&(!(arguments.length>0&&0[0]!==arguments[0])||arguments[0])&&(lr=Z0()),lr}Yl=["filters","resizeFilter","src","crossOrigin","type"],mr=["cropX","cropY"],Ne=class _na extends S{static getDefaults(){return n(n({},super.getDefaults()),_na.ownDefaults)}constructor(e,t){super(),s(this,"_lastScaleX",1),s(this,"_lastScaleY",1),s(this,"_filterScalingX",1),s(this,"_filterScalingY",1),this.filters=[],Object.assign(this,_na.ownDefaults),this.setOptions(t),this.cacheKey="texture".concat(Se()),this.setElement("string"==typeof e?(this.canvas&&ne(this.canvas.getElement())||Ze()).getElementById(e):e,t)}getElement(){return this._element}setElement(e){var t;let n=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};this.removeTexture(this.cacheKey),this.removeTexture("".concat(this.cacheKey,"_filtered")),this._element=e,this._originalElement=e,this._setWidthHeight(n),null===(t=e.classList)||0[0]===t||t.add(_na.CSS_CANVAS),0!==this.filters.length&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters()}removeTexture(e){const t=ur(!1);t instanceof cr&&t.evictCachesForKey(e)}dispose(){super.dispose(),this.removeTexture(this.cacheKey),this.removeTexture("".concat(this.cacheKey,"_filtered")),this._cacheContext=null,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach(e=>{const t=this[e];t&&ue().dispose(t),this[e]=0[0]})}getCrossOrigin(){return this._originalElement&&(this._originalElement.crossOrigin||null)}getOriginalSize(){const e=this.getElement();return e?{width:e.naturalWidth||e.width,height:e.naturalHeight||e.height}:{width:0,height:0}}_stroke(e){if(!this.stroke||0===this.strokeWidth)return;const t=this.width/2,n=this.height/2;e.beginPath(),e.moveTo(-t,-n),e.lineTo(t,-n),e.lineTo(t,n),e.lineTo(-t,n),e.lineTo(-t,-n),e.closePath()}toObject(){let t=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:[];const e=[];return this.filters.forEach(t=>{t&&e.push(t.toObject())}),n(n({},super.toObject([...mr,...t])),{},{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:e},this.resizeFilter?{resizeFilter:this.resizeFilter.toObject()}:{})}hasCrop(){return!!this.cropX||!!this.cropY||this.width<this._element.width||this.height<this._element.height}_toSVG(){const n=[],e=this._element,s=-this.width/2,o=-this.height/2;let t=[],i=[],a="",r="";if(!e)return[];if(this.hasCrop()){const e=Se();t.push('<clipPath id="imageCrop_'+e+`">
`,'	<rect x="'+s+'" y="'+o+'" width="'+this.width+'" height="'+this.height+`" />
`,`</clipPath>
`),a=' clip-path="url(#imageCrop_'+e+')" '}if(this.imageSmoothing||(r=' image-rendering="optimizeSpeed"'),n.push("	<image ","COMMON_PARTS",'xlink:href="'.concat(this.getSvgSrc(!0),'" x="').concat(s-this.cropX,'" y="').concat(o-this.cropY,'" width="').concat(e.width||e.naturalWidth,'" height="').concat(e.height||e.naturalHeight,'"').concat(r).concat(a,`></image>
`)),this.stroke||this.strokeDashArray){const e=this.fill;this.fill=null,i=['	<rect x="'.concat(s,'" y="').concat(o,'" width="').concat(this.width,'" height="').concat(this.height,'" style="').concat(this.getSvgStyles(),`" />
`)],this.fill=e}return t=this.paintFirst!==A?t.concat(i,n):t.concat(n,i),t}getSrc(e){const t=e?this._element:this._originalElement;return t?t.toDataURL?t.toDataURL():this.srcFromAttribute?t.getAttribute("src")||"":t.src:this.src||""}getSvgSrc(e){return this.getSrc(e)}setSrc(e){let{crossOrigin:t,signal:n}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};return gn(e,{crossOrigin:t,signal:n}).then(e=>{0[0]!==t&&this.set({crossOrigin:t}),this.setElement(e)})}toString(){return'#<Image: { src: "'.concat(this.getSrc(),'" }>')}applyResizeFilters(){const e=this.resizeFilter,i=this.minimumScaleTrigger,a=this.getTotalObjectScaling(),n=a.x,s=a.y,t=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!e||n>i&&s>i)return this._element=t,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=n,void(this._lastScaleY=s);const o=K(t),{width:r,height:c}=t;this._element=o,this._lastScaleX=e.scaleX=n,this._lastScaleY=e.scaleY=s,ur().applyFilters([e],t,r,c,this._element),this._filterScalingX=o.width/this._originalElement.width,this._filterScalingY=o.height/this._originalElement.height}applyFilters(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:this.filters||[];if(e=e.filter(e=>e&&!e.isNeutralState()),this.set("dirty",!0),this.removeTexture("".concat(this.cacheKey,"_filtered")),0===e.length)return this._element=this._originalElement,this._filteredEl=0[0],this._filterScalingX=1,void(this._filterScalingY=1);const t=this._originalElement,n=t.naturalWidth||t.width,s=t.naturalHeight||t.height;if(this._element===this._originalElement){const e=K({width:n,height:s});this._element=e,this._filteredEl=e}else this._filteredEl&&(this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,n,s),this._lastScaleX=1,this._lastScaleY=1);ur().applyFilters(e,this._originalElement,n,s,this._element,this.cacheKey),this._originalElement.width===this._element.width&&this._originalElement.height===this._element.height||(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height)}_render(e){e.imageSmoothingEnabled=this.imageSmoothing,!0!==this.isMoving&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(e),this._renderPaintInOrder(e)}drawCacheOnCanvas(e){e.imageSmoothingEnabled=this.imageSmoothing,super.drawCacheOnCanvas(e)}shouldCache(){return this.needsItsOwnCache()}_renderFill(e){const t=this._element;if(!t)return;const n=this._filterScalingX,s=this._filterScalingY,o=this.width,i=this.height,a=Math.max(this.cropX,0),r=Math.max(this.cropY,0),c=t.naturalWidth||t.width,l=t.naturalHeight||t.height,d=a*n,u=r*s,h=Math.min(o*n,c-d),m=Math.min(i*s,l-u),f=-o/2,p=-i/2,g=Math.min(o,c/n-a),v=Math.min(i,l/s-r);t&&e.drawImage(t,d,u,h,m,f,p,g,v)}_needsResize(){const e=this.getTotalObjectScaling();return e.x!==this._lastScaleX||e.y!==this._lastScaleY}_resetWidthHeight(){this.set(this.getOriginalSize())}_setWidthHeight(){let{width:t,height:n}=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};const e=this.getOriginalSize();this.width=t||e.width,this.height=n||e.height}parsePreserveAspectRatioAttribute(){const e=wa(this.preserveAspectRatio||""),o=this.width,i=this.height,h={width:o,height:i};let t,a=this._element.width,r=this._element.height,s=1,n=1,c=0,l=0,d=0,u=0;return!e||e.alignX===N&&e.alignY===N?(s=o/a,n=i/r):("meet"===e.meetOrSlice&&(s=n=Di(this._element,h),t=(o-a*s)/2,"Min"===e.alignX&&(c=-t),"Max"===e.alignX&&(c=t),t=(i-r*n)/2,"Min"===e.alignY&&(l=-t),"Max"===e.alignY&&(l=t)),"slice"===e.meetOrSlice&&(s=n=Ti(this._element,h),t=a-o/s,"Mid"===e.alignX&&(d=t/2),"Max"===e.alignX&&(d=t),t=r-i/n,"Mid"===e.alignY&&(u=t/2),"Max"===e.alignY&&(u=t),a=o/s,r=i/n)),{width:a,height:r,scaleX:s,scaleY:n,offsetLeft:c,offsetTop:l,cropX:d,cropY:u}}static fromObject(e,t){let{filters:s,resizeFilter:o,src:i,crossOrigin:r,type:c}=e,a=w(e,Yl);return Promise.all([gn(i,n(n({},t),{},{crossOrigin:r})),s&&Je(s,t),o&&Je([o],t),pn(a,t)]).then(e=>{let[t,s=[],[o]=[],r={}]=e;return new this(t,n(n({},a),{},{src:i,filters:s,resizeFilter:o},r))})}static fromURL(e){let{crossOrigin:t=null,signal:n}=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{},s=arguments.length>2?arguments[2]:0[0];return gn(e,{crossOrigin:t,signal:n}).then(e=>new this(e,s))}static async fromElement(e){let n=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{},s=arguments.length>2?arguments[2]:0[0];const t=Ee(e,this.ATTRIBUTE_NAMES,s);return this.fromURL(t["xlink:href"]||t.href,n,t).catch(e=>(Ae("log","Unable to parse Image",e),null))}},s(Ne,"type","Image"),s(Ne,"cacheProperties",[..._e,...mr]),s(Ne,"ownDefaults",{strokeWidth:0,srcFromAttribute:!1,minimumScaleTrigger:.5,cropX:0,cropY:0,imageSmoothing:!0}),s(Ne,"CSS_CANVAS","canvas-img"),s(Ne,"ATTRIBUTE_NAMES",[...Le,"x","y","width","height","preserveAspectRatio","xlink:href","href","crossOrigin","image-rendering"]),c.setClass(Ne),c.setSVGClass(Ne),J0=Ro(["pattern","defs","symbol","metadata","clipPath","mask","desc"]),gr=$r,vr=e=>function(t,n,s){const{points:i,pathOffset:a}=s;return new o(i[e]).subtract(a).transform(O(s.getViewportTransform(),s.calcTransformMatrix()))},br=(e,t,n,s)=>{const{target:a,pointIndex:r}=t,i=a,c=ye(new o(n,s),0[0],i.calcOwnMatrix());return i.points[r]=c.add(i.pathOffset),i.setDimensions(),i.set("dirty",!0),!0},jr=(e,t)=>function(s,i,a,r){const c=i.target,l=new o(c.points[(e>0?e:c.points.length)-1]),u=l.subtract(c.pathOffset).transform(c.calcOwnMatrix()),h=t(s,n(n({},i),{},{pointIndex:e}),a,r),d=l.subtract(c.pathOffset).transform(c.calcOwnMatrix()).subtract(u);return c.left-=d.x,c.top-=d.y,h},yr=e=>Re(gr,jr(e,br)),wo=(e,t,n)=>{const{path:a,pathOffset:s}=e,i=a[t];return new o(i[n]-s.x,i[n+1]-s.y).transform(O(e.getViewportTransform(),e.calcTransformMatrix()))};function t2(e,t,n){const{commandIndex:s,pointIndex:o}=this;return wo(n,s,o)}function n2(e,t,s,i){const{target:c}=t,{commandIndex:a,pointIndex:r}=this,l=((e,t,n,s,i)=>{const{path:a,pathOffset:r}=e,c=a[(s>0?s:a.length)-1],l=new o(c[i],c[i+1]),h=l.subtract(r).transform(e.calcOwnMatrix()),d=ye(new o(t,n),0[0],e.calcOwnMatrix());a[s][i]=d.x+r.x,a[s][i+1]=d.y+r.y,e.setDimensions();const u=l.subtract(e.pathOffset).transform(e.calcOwnMatrix()).subtract(h);return e.left-=u.x,e.top-=u.y,e.set("dirty",!0),!0})(c,s,i,a,r);return Fo(this.actionName,n(n({},To(e,t,s,i)),{},{commandIndex:a,pointIndex:r})),l}xr=class extends W{constructor(e){super(e)}render(e,t,s,o,i){const a=n(n({},o),{},{cornerColor:this.controlFill,cornerStrokeColor:this.controlStroke,transparentCorners:!this.controlFill});super.render(e,t,s,a,i)}},Wl=class extends xr{constructor(e){super(e)}render(e,t,n,s,o){const{path:r}=o,{commandIndex:i,pointIndex:c,connectToCommandIndex:l,connectToPointIndex:d}=this;e.save(),e.strokeStyle=this.controlStroke,this.connectionDashArray&&e.setLineDash(this.connectionDashArray);const[u]=r[i],a=wo(o,l,d);if("Q"===u){const s=wo(o,i,c+2);e.moveTo(s.x,s.y),e.lineTo(t,n)}else e.moveTo(t,n);e.lineTo(a.x,a.y),e.stroke(),e.restore(),super.render(e,t,n,s,o)}},ps=(e,t,s,o,i,a)=>new(s?Wl:xr)(n(n({commandIndex:e,pointIndex:t,actionName:"modifyPath",positionHandler:t2,actionHandler:n2,connectToCommandIndex:i,connectToPointIndex:a},o),s?o.controlPointStyle:o.pointStyle)),s2=Object.freeze({__proto__:null,changeWidth:Uo,createObjectDefaultControls:Ho,createPathControls:function(e){let n=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};const t={};let s="M";return e.path.forEach((e,o)=>{const i=e[0];switch("Z"!==i&&(t["c_".concat(o,"_").concat(i)]=ps(o,e.length-2,!1,n)),i){case"C":t["c_".concat(o,"_C_CP_1")]=ps(o,1,!0,n,o-1,(e=>"C"===e?5:"Q"===e?3:1)(s)),t["c_".concat(o,"_C_CP_2")]=ps(o,3,!0,n,o,5);break;case"Q":t["c_".concat(o,"_Q_CP_1")]=ps(o,1,!0,n,o,3)}s=i}),t},createPolyActionHandler:yr,createPolyControls:function(e){let s=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:{};const t={};for(let o=0;o<("number"==typeof e?e:e.points.length);o++)t["p".concat(o)]=new W(n({actionName:gr,positionHandler:vr(o),actionHandler:yr(o)},s));return t},createPolyPositionHandler:vr,createResizeControls:Pc,createTextboxDefaultControls:Lc,dragHandler:Ma,factoryPolyActionHandler:jr,getLocalPoint:Do,polyActionHandler:br,renderCircleControl:c4,renderSquareControl:a4,rotationStyleHandler:ga,rotationWithSnapping:za,scaleCursorStyleHandler:ft,scaleOrSkewActionName:vn,scaleSkewCursorStyleHandler:Ie,scalingEqually:On,scalingX:rr,scalingXOrSkewingY:oo,scalingY:pr,scalingYOrSkewingX:Gs,skewCursorStyleHandler:Mr,skewHandlerX:zr,skewHandlerY:Br,wrapWithFireEvent:Re,wrapWithFixedAnchor:_t}),ys=e=>0[0]!==e.webgl,vo="precision highp float",Bl=`
    `.concat(vo,`;
    varying vec2 vTexCoord;
    uniform sampler2D uTexture;
    void main() {
      gl_FragColor = texture2D(uTexture, vTexCoord);
    }`),Rl=["type"],Ll=["type"],Dl=new RegExp(vo,"g"),k=class{get type(){return this.constructor.type}constructor(){let e=w(arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{},Rl);Object.assign(this,this.constructor.defaults,e)}getFragmentSource(){return Bl}getVertexSource(){return`
    attribute vec2 aPosition;
    varying vec2 vTexCoord;
    void main() {
      vTexCoord = aPosition;
      gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
    }`}createProgram(e){let o=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:this.getFragmentSource(),r=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:this.getVertexSource();const{WebGLProbe:{GLPrecision:a="highp"}}=ue();"highp"!==a&&(o=o.replace(Dl,vo.replace("highp",a)));const n=e.createShader(e.VERTEX_SHADER),s=e.createShader(e.FRAGMENT_SHADER),t=e.createProgram();if(!n||!s||!t)throw new de("Vertex, fragment shader or program creation error");if(e.shaderSource(n,r),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS))throw new de("Vertex shader compile error for ".concat(this.type,": ").concat(e.getShaderInfoLog(n)));if(e.shaderSource(s,o),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS))throw new de("Fragment shader compile error for ".concat(this.type,": ").concat(e.getShaderInfoLog(s)));if(e.attachShader(t,n),e.attachShader(t,s),e.linkProgram(t),!e.getProgramParameter(t,e.LINK_STATUS))throw new de('Shader link error for "'.concat(this.type,'" ').concat(e.getProgramInfoLog(t)));const i=this.getUniformLocations(e,t)||{};return i.uStepW=e.getUniformLocation(t,"uStepW"),i.uStepH=e.getUniformLocation(t,"uStepH"),{program:t,attributeLocations:this.getAttributeLocations(e,t),uniformLocations:i}}getAttributeLocations(e,t){return{aPosition:e.getAttribLocation(t,"aPosition")}}getUniformLocations(e,t){const n=this.constructor.uniformLocations,s={};for(let o=0;o<n.length;o++)s[n[o]]=e.getUniformLocation(t,n[o]);return s}sendAttributeData(e,t,n){const s=t.aPosition,o=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,o),e.enableVertexAttribArray(s),e.vertexAttribPointer(s,2,e.FLOAT,!1,0,0),e.bufferData(e.ARRAY_BUFFER,n,e.STATIC_DRAW)}_setupFrameBuffer(e){const t=e.context;if(e.passes>1){const n=e.destinationWidth,s=e.destinationHeight;e.sourceWidth===n&&e.sourceHeight===s||(t.deleteTexture(e.targetTexture),e.targetTexture=e.filterBackend.createTexture(t,n,s)),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e.targetTexture,0)}else t.bindFramebuffer(t.FRAMEBUFFER,null),t.finish()}_swapTextures(e){e.passes--,e.pass++;const t=e.targetTexture;e.targetTexture=e.sourceTexture,e.sourceTexture=t}isNeutralState(){return!1}applyTo(e){ys(e)?(this._setupFrameBuffer(e),this.applyToWebGL(e),this._swapTextures(e)):this.applyTo2d(e)}applyTo2d(){}getCacheKey(){return this.type}retrieveShader(e){const t=this.getCacheKey();return e.programCache[t]||(e.programCache[t]=this.createProgram(e.context)),e.programCache[t]}applyToWebGL(e){const t=e.context,n=this.retrieveShader(e);0===e.pass&&e.originalTexture?t.bindTexture(t.TEXTURE_2D,e.originalTexture):t.bindTexture(t.TEXTURE_2D,e.sourceTexture),t.useProgram(n.program),this.sendAttributeData(t,n.attributeLocations,e.aPosition),t.uniform1f(n.uniformLocations.uStepW,1/e.sourceWidth),t.uniform1f(n.uniformLocations.uStepH,1/e.sourceHeight),this.sendUniformData(t,n.uniformLocations),t.viewport(0,0,e.destinationWidth,e.destinationHeight),t.drawArrays(t.TRIANGLE_STRIP,0,4)}bindAdditionalTexture(e,t,n){e.activeTexture(n),e.bindTexture(e.TEXTURE_2D,t),e.activeTexture(e.TEXTURE0)}unbindAdditionalTexture(e,t){e.activeTexture(t),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE0)}sendUniformData(){}createHelpLayer(e){if(!e.helpLayer){const{sourceWidth:t,sourceHeight:n}=e,s=K({width:t,height:n});e.helpLayer=s}}toObject(){const e=Object.keys(this.constructor.defaults||{});return n({type:this.type},e.reduce((e,t)=>(e[t]=this[t],e),{}))}toJSON(){return this.toObject()}static async fromObject(e){return new this(w(e,Ll))}},s(k,"type","BaseFilter"),s(k,"uniformLocations",[]),Tl={multiply:`gl_FragColor.rgb *= uColor.rgb;
`,screen:`gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);
`,add:`gl_FragColor.rgb += uColor.rgb;
`,difference:`gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);
`,subtract:`gl_FragColor.rgb -= uColor.rgb;
`,lighten:`gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);
`,darken:`gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);
`,exclusion:`gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);
`,overlay:`
    if (uColor.r < 0.5) {
      gl_FragColor.r *= 2.0 * uColor.r;
    } else {
      gl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);
    }
    if (uColor.g < 0.5) {
      gl_FragColor.g *= 2.0 * uColor.g;
    } else {
      gl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);
    }
    if (uColor.b < 0.5) {
      gl_FragColor.b *= 2.0 * uColor.b;
    } else {
      gl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);
    }
    `,tint:`
    gl_FragColor.rgb *= (1.0 - uColor.a);
    gl_FragColor.rgb += uColor.rgb;
    `},zn=class extends k{getCacheKey(){return"".concat(this.type,"_").concat(this.mode)}getFragmentSource(){return`
      precision highp float;
      uniform sampler2D uTexture;
      uniform vec4 uColor;
      varying vec2 vTexCoord;
      void main() {
        vec4 color = texture2D(uTexture, vTexCoord);
        gl_FragColor = color;
        if (color.a > 0.0) {
          `.concat(Tl[this.mode],`
        }
      }
      `)}applyTo2d(e){let{imageData:{data:o}}=e;const a=new U(this.color).getSource(),i=this.alpha,t=a[0]*i,n=a[1]*i,s=a[2]*i,r=1-i;for(let u=0;u<o.length;u+=4){const e=o[u],i=o[u+1],a=o[u+2];let c,l,d;switch(this.mode){case"multiply":c=e*t/255,l=i*n/255,d=a*s/255;break;case"screen":c=255-(255-e)*(255-t)/255,l=255-(255-i)*(255-n)/255,d=255-(255-a)*(255-s)/255;break;case"add":c=e+t,l=i+n,d=a+s;break;case"difference":c=Math.abs(e-t),l=Math.abs(i-n),d=Math.abs(a-s);break;case"subtract":c=e-t,l=i-n,d=a-s;break;case"darken":c=Math.min(e,t),l=Math.min(i,n),d=Math.min(a,s);break;case"lighten":c=Math.max(e,t),l=Math.max(i,n),d=Math.max(a,s);break;case"overlay":c=t<128?2*e*t/255:255-2*(255-e)*(255-t)/255,l=n<128?2*i*n/255:255-2*(255-i)*(255-n)/255,d=s<128?2*a*s/255:255-2*(255-a)*(255-s)/255;break;case"exclusion":c=t+e-2*t*e/255,l=n+i-2*n*i/255,d=s+a-2*s*a/255;break;case"tint":c=t+e*r,l=n+i*r,d=s+a*r}o[u]=c,o[u+1]=l,o[u+2]=d}}sendUniformData(e,t){const n=new U(this.color).getSource();n[0]=this.alpha*n[0]/255,n[1]=this.alpha*n[1]/255,n[2]=this.alpha*n[2]/255,n[3]=this.alpha,e.uniform4fv(t.uColor,n)}},s(zn,"defaults",{color:"#F95C63",mode:"multiply",alpha:1}),s(zn,"type","BlendColor"),s(zn,"uniformLocations",["uColor"]),c.setClass(zn),Fl={multiply:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform sampler2D uImage;
    uniform vec4 uColor;
    varying vec2 vTexCoord;
    varying vec2 vTexCoord2;
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      vec4 color2 = texture2D(uImage, vTexCoord2);
      color.rgba *= color2.rgba;
      gl_FragColor = color;
    }
    `,mask:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform sampler2D uImage;
    uniform vec4 uColor;
    varying vec2 vTexCoord;
    varying vec2 vTexCoord2;
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      vec4 color2 = texture2D(uImage, vTexCoord2);
      color.a = color2.a;
      gl_FragColor = color;
    }
    `},Ml=["type","image"],Sn=class extends k{getCacheKey(){return"".concat(this.type,"_").concat(this.mode)}getFragmentSource(){return Fl[this.mode]}getVertexSource(){return`
    attribute vec2 aPosition;
    varying vec2 vTexCoord;
    varying vec2 vTexCoord2;
    uniform mat3 uTransformMatrix;
    void main() {
      vTexCoord = aPosition;
      vTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;
      gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
    }
    `}applyToWebGL(e){const t=e.context,n=this.createTexture(e.filterBackend,this.image);this.bindAdditionalTexture(t,n,t.TEXTURE1),super.applyToWebGL(e),this.unbindAdditionalTexture(t,t.TEXTURE1)}createTexture(e,t){return e.getCachedTexture(t.cacheKey,t.getElement())}calculateMatrix(){const e=this.image,{width:t,height:n}=e.getElement();return[1/e.scaleX,0,0,0,1/e.scaleY,0,-e.left/t,-e.top/n,1]}applyTo2d(e){let{imageData:{data:t,width:n,height:s},filterBackend:{resources:c}}=e;const o=this.image;c.blendImage||(c.blendImage=ae());const i=c.blendImage,a=i.getContext("2d");i.width!==n||i.height!==s?(i.width=n,i.height=s):a.clearRect(0,0,n,s),a.setTransform(o.scaleX,0,0,o.scaleY,o.left,o.top),a.drawImage(o.getElement(),0,0,n,s);const r=a.getImageData(0,0,n,s).data;for(let e=0;e<t.length;e+=4){const s=t[e],o=t[e+1],i=t[e+2],a=t[e+3],c=r[e],l=r[e+1],d=r[e+2],n=r[e+3];switch(this.mode){case"multiply":t[e]=s*c/255,t[e+1]=o*l/255,t[e+2]=i*d/255,t[e+3]=a*n/255;break;case"mask":t[e+3]=n}}}sendUniformData(e,t){const n=this.calculateMatrix();e.uniform1i(t.uImage,1),e.uniformMatrix3fv(t.uTransformMatrix,!1,n)}toObject(){return n(n({},super.toObject()),{},{image:this.image&&this.image.toObject()})}static async fromObject(e,t){let{type:i,image:s}=e,o=w(e,Ml);return Ne.fromObject(s,t).then(e=>new this(n(n({},o),{},{image:e})))}},s(Sn,"type","BlendImage"),s(Sn,"defaults",{mode:"multiply",alpha:1}),s(Sn,"uniformLocations",["uTransformMatrix","uImage"]),c.setClass(Sn),An=class extends k{getFragmentSource(){return`
    precision highp float;
    uniform sampler2D uTexture;
    uniform vec2 uDelta;
    varying vec2 vTexCoord;
    const float nSamples = 15.0;
    vec3 v3offset = vec3(12.9898, 78.233, 151.7182);
    float random(vec3 scale) {
      /* use the fragment position for a different seed per-pixel */
      return fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);
    }
    void main() {
      vec4 color = vec4(0.0);
      float totalC = 0.0;
      float totalA = 0.0;
      float offset = random(v3offset);
      for (float t = -nSamples; t <= nSamples; t++) {
        float percent = (t + offset - 0.5) / nSamples;
        vec4 sample = texture2D(uTexture, vTexCoord + uDelta * percent);
        float weight = 1.0 - abs(percent);
        float alpha = weight * sample.a;
        color.rgb += sample.rgb * alpha;
        color.a += alpha;
        totalA += weight;
        totalC += alpha;
      }
      gl_FragColor.rgb = color.rgb / totalC;
      gl_FragColor.a = color.a / totalA;
    }
  `}applyTo(e){ys(e)?(this.aspectRatio=e.sourceWidth/e.sourceHeight,e.passes++,this._setupFrameBuffer(e),this.horizontal=!0,this.applyToWebGL(e),this._swapTextures(e),this._setupFrameBuffer(e),this.horizontal=!1,this.applyToWebGL(e),this._swapTextures(e)):this.applyTo2d(e)}applyTo2d(e){let{imageData:{data:t,width:i,height:r}}=e;this.aspectRatio=i/r,this.horizontal=!0;let a=this.getBlurValue()*i;const n=new Uint8ClampedArray(t),o=15,s=4*i;for(let e=0;e<t.length;e+=4){let c=0,l=0,d=0,i=0,u=0;const r=e-e%s,h=r+s;for(let m=-14;m<o;m++){const f=m/o,g=4*Math.floor(a*f),p=1-(f<0?-f:f);let n=e+g;n<r?n=r:n>h&&(n=h);const s=t[n+3]*p;c+=t[n]*s,l+=t[n+1]*s,d+=t[n+2]*s,i+=s,u+=p}n[e]=c/i,n[e+1]=l/i,n[e+2]=d/i,n[e+3]=i/u}this.horizontal=!1,a=this.getBlurValue()*r;for(let e=0;e<n.length;e+=4){let c=0,l=0,d=0,i=0,u=0;const r=e%s,h=n.length-s+r;for(let f=-14;f<o;f++){const p=f/o,v=Math.floor(a*p)*s,g=1-(p<0?-p:p);let t=e+v;t<r?t=r:t>h&&(t=h);const m=n[t+3]*g;c+=n[t]*m,l+=n[t+1]*m,d+=n[t+2]*m,i+=m,u+=g}t[e]=c/i,t[e+1]=l/i,t[e+2]=d/i,t[e+3]=i/u}}sendUniformData(e,t){const n=this.chooseRightDelta();e.uniform2fv(t.uDelta,n)}isNeutralState(){return 0===this.blur}getBlurValue(){let t=1;const{horizontal:n,aspectRatio:e}=this;return n?e>1&&(t=1/e):e<1&&(t=e),t*this.blur*.12}chooseRightDelta(){const e=this.getBlurValue();return this.horizontal?[e,0]:[0,e]}},s(An,"type","Blur"),s(An,"defaults",{blur:0}),s(An,"uniformLocations",["uDelta"]),c.setClass(An),kn=class extends k{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uBrightness;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    color.rgb += uBrightness;
    gl_FragColor = color;
  }
`}applyTo2d(e){let{imageData:{data:t}}=e;const n=Math.round(255*this.brightness);for(let e=0;e<t.length;e+=4)t[e]+=n,t[e+1]+=n,t[e+2]+=n}isNeutralState(){return 0===this.brightness}sendUniformData(e,t){e.uniform1f(t.uBrightness,this.brightness)}},s(kn,"type","Brightness"),s(kn,"defaults",{brightness:0}),s(kn,"uniformLocations",["uBrightness"]),c.setClass(kn),Vr={matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],colorsOnly:!0},Ye=class extends k{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  varying vec2 vTexCoord;
  uniform mat4 uColorMatrix;
  uniform vec4 uConstants;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    color *= uColorMatrix;
    color += uConstants;
    gl_FragColor = color;
  }`}applyTo2d(e){const n=e.imageData.data,t=this.matrix,s=this.colorsOnly;for(let e=0;e<n.length;e+=4){const o=n[e],i=n[e+1],a=n[e+2];if(n[e]=o*t[0]+i*t[1]+a*t[2]+255*t[4],n[e+1]=o*t[5]+i*t[6]+a*t[7]+255*t[9],n[e+2]=o*t[10]+i*t[11]+a*t[12]+255*t[14],!s){const s=n[e+3];n[e]+=s*t[3],n[e+1]+=s*t[8],n[e+2]+=s*t[13],n[e+3]=o*t[15]+i*t[16]+a*t[17]+s*t[18]+255*t[19]}}}sendUniformData(e,t){const n=this.matrix,s=[n[0],n[1],n[2],n[3],n[5],n[6],n[7],n[8],n[10],n[11],n[12],n[13],n[15],n[16],n[17],n[18]],o=[n[4],n[9],n[14],n[19]];e.uniformMatrix4fv(t.uColorMatrix,!1,s),e.uniform4fv(t.uConstants,o)}toObject(){return n(n({},super.toObject()),{},{matrix:[...this.matrix]})}};function et(e,t){var n;const o=(s(n=class extends Ye{toObject(){return{type:this.type,colorsOnly:this.colorsOnly}}},"type",e),s(n,"defaults",{colorsOnly:!1,matrix:t}),n);return c.setClass(o,e),o}s(Ye,"type","ColorMatrix"),s(Ye,"defaults",Vr),s(Ye,"uniformLocations",["uColorMatrix","uConstants"]),c.setClass(Ye),Sl=et("Brownie",[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0]),fl=et("Vintage",[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0]),ml=et("Kodachrome",[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0]),hl=et("Technicolor",[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0]),ul=et("Polaroid",[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0]),ll=et("Sepia",[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0]),cl=et("BlackWhite",[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]),ao=class extends k{constructor(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};super(e),this.subFilters=e.subFilters||[]}applyTo(e){ys(e)&&(e.passes+=this.subFilters.length-1),this.subFilters.forEach(t=>{t.applyTo(e)})}toObject(){return{type:this.type,subFilters:this.subFilters.map(e=>e.toObject())}}isNeutralState(){return!this.subFilters.some(e=>!e.isNeutralState())}static fromObject(e,t){return Promise.all((e.subFilters||[]).map(e=>c.getClass(e.type).fromObject(e,t))).then(e=>new this({subFilters:e}))}},s(ao,"type","Composed"),c.setClass(ao),rn=class extends k{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uContrast;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    float contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));
    color.rgb = contrastF * (color.rgb - 0.5) + 0.5;
    gl_FragColor = color;
  }`}isNeutralState(){return 0===this.contrast}applyTo2d(e){let{imageData:{data:t}}=e;const s=Math.floor(255*this.contrast),n=259*(s+255)/(255*(259-s));for(let e=0;e<t.length;e+=4)t[e]=n*(t[e]-128)+128,t[e+1]=n*(t[e+1]-128)+128,t[e+2]=n*(t[e+2]-128)+128}sendUniformData(e,t){e.uniform1f(t.uContrast,this.contrast)}},s(rn,"type","Contrast"),s(rn,"defaults",{contrast:0}),s(rn,"uniformLocations",["uContrast"]),c.setClass(rn),rl={Convolute_3_1:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[9];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 0);
      for (float h = 0.0; h < 3.0; h+=1.0) {
        for (float w = 0.0; w < 3.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));
          color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];
        }
      }
      gl_FragColor = color;
    }
    `,Convolute_3_0:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[9];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 1);
      for (float h = 0.0; h < 3.0; h+=1.0) {
        for (float w = 0.0; w < 3.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));
          color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];
        }
      }
      float alpha = texture2D(uTexture, vTexCoord).a;
      gl_FragColor = color;
      gl_FragColor.a = alpha;
    }
    `,Convolute_5_1:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[25];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 0);
      for (float h = 0.0; h < 5.0; h+=1.0) {
        for (float w = 0.0; w < 5.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
          color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];
        }
      }
      gl_FragColor = color;
    }
    `,Convolute_5_0:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[25];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 1);
      for (float h = 0.0; h < 5.0; h+=1.0) {
        for (float w = 0.0; w < 5.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
          color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];
        }
      }
      float alpha = texture2D(uTexture, vTexCoord).a;
      gl_FragColor = color;
      gl_FragColor.a = alpha;
    }
    `,Convolute_7_1:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[49];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 0);
      for (float h = 0.0; h < 7.0; h+=1.0) {
        for (float w = 0.0; w < 7.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
          color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];
        }
      }
      gl_FragColor = color;
    }
    `,Convolute_7_0:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[49];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 1);
      for (float h = 0.0; h < 7.0; h+=1.0) {
        for (float w = 0.0; w < 7.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
          color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];
        }
      }
      float alpha = texture2D(uTexture, vTexCoord).a;
      gl_FragColor = color;
      gl_FragColor.a = alpha;
    }
    `,Convolute_9_1:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[81];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 0);
      for (float h = 0.0; h < 9.0; h+=1.0) {
        for (float w = 0.0; w < 9.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
          color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];
        }
      }
      gl_FragColor = color;
    }
    `,Convolute_9_0:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[81];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 1);
      for (float h = 0.0; h < 9.0; h+=1.0) {
        for (float w = 0.0; w < 9.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
          color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];
        }
      }
      float alpha = texture2D(uTexture, vTexCoord).a;
      gl_FragColor = color;
      gl_FragColor.a = alpha;
    }
    `},nn=class extends k{getCacheKey(){return"".concat(this.type,"_").concat(Math.sqrt(this.matrix.length),"_").concat(this.opaque?1:0)}getFragmentSource(){return rl[this.getCacheKey()]}applyTo2d(e){const p=e.imageData,n=p.data,O=this.matrix,h=Math.round(Math.sqrt(O.length)),w=Math.floor(h/2),a=p.width,b=p.height,_=e.ctx.createImageData(a,b),m=_.data,y=this.opaque?1:0;let g,j,v,f,t,d,u,l,c,r,i,o,s;for(i=0;i<b;i++)for(r=0;r<a;r++){for(t=4*(i*a+r),g=0,j=0,v=0,f=0,s=0;s<h;s++)for(o=0;o<h;o++)u=i+s-w,d=r+o-w,u<0||u>=b||d<0||d>=a||(l=4*(u*a+d),c=O[s*h+o],g+=n[l]*c,j+=n[l+1]*c,v+=n[l+2]*c,y||(f+=n[l+3]*c));m[t]=g,m[t+1]=j,m[t+2]=v,m[t+3]=y?n[t+3]:f}e.imageData=_}sendUniformData(e,t){e.uniform1fv(t.uMatrix,this.matrix)}toObject(){return n(n({},super.toObject()),{},{opaque:this.opaque,matrix:[...this.matrix]})}},s(nn,"type","Convolute"),s(nn,"defaults",{opaque:!1,matrix:[0,0,0,0,1,0,0,0,0]}),s(nn,"uniformLocations",["uMatrix","uOpaque","uHalfSize","uSize"]),c.setClass(nn),nc="Gamma",Zt=class extends k{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform vec3 uGamma;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    vec3 correction = (1.0 / uGamma);
    color.r = pow(color.r, correction.r);
    color.g = pow(color.g, correction.g);
    color.b = pow(color.b, correction.b);
    gl_FragColor = color;
    gl_FragColor.rgb *= color.a;
  }
`}constructor(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:{};super(e),this.gamma=e.gamma||this.constructor.defaults.gamma.concat()}applyTo2d(e){let{imageData:{data:t}}=e;const s=this.gamma,o=1/s[0],i=1/s[1],a=1/s[2];this.rgbValues||(this.rgbValues={r:new Uint8Array(256),g:new Uint8Array(256),b:new Uint8Array(256)});const n=this.rgbValues;for(let e=0;e<256;e++)n.r[e]=255*(e/255)**o,n.g[e]=255*(e/255)**i,n.b[e]=255*(e/255)**a;for(let e=0;e<t.length;e+=4)t[e]=n.r[t[e]],t[e+1]=n.g[t[e+1]],t[e+2]=n.b[t[e+2]]}sendUniformData(e,t){e.uniform3fv(t.uGamma,this.gamma)}isNeutralState(){const{gamma:e}=this;return 1===e[0]&&1===e[1]&&1===e[2]}toObject(){return{type:nc,gamma:this.gamma.concat()}}},s(Zt,"type",nc),s(Zt,"defaults",{gamma:[1,1,1]}),s(Zt,"uniformLocations",["uGamma"]),c.setClass(Zt),nl={average:`
    precision highp float;
    uniform sampler2D uTexture;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      float average = (color.r + color.b + color.g) / 3.0;
      gl_FragColor = vec4(average, average, average, color.a);
    }
    `,lightness:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform int uMode;
    varying vec2 vTexCoord;
    void main() {
      vec4 col = texture2D(uTexture, vTexCoord);
      float average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;
      gl_FragColor = vec4(average, average, average, col.a);
    }
    `,luminosity:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform int uMode;
    varying vec2 vTexCoord;
    void main() {
      vec4 col = texture2D(uTexture, vTexCoord);
      float average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;
      gl_FragColor = vec4(average, average, average, col.a);
    }
    `},Vt=class extends k{applyTo2d(e){let{imageData:{data:t}}=e;for(let n,e=0;e<t.length;e+=4){const s=t[e],o=t[e+1],i=t[e+2];switch(this.mode){case"average":n=(s+o+i)/3;break;case"lightness":n=(Math.min(s,o,i)+Math.max(s,o,i))/2;break;case"luminosity":n=.21*s+.72*o+.07*i}t[e+2]=t[e+1]=t[e]=n}}getCacheKey(){return"".concat(this.type,"_").concat(this.mode)}getFragmentSource(){return nl[this.mode]}sendUniformData(e,t){e.uniform1i(t.uMode,1)}isNeutralState(){return!1}},s(Vt,"type","Grayscale"),s(Vt,"defaults",{mode:"average"}),s(Vt,"uniformLocations",["uMode"]),c.setClass(Vt),Jc=n(n({},Vr),{},{rotation:0}),Ns=class extends Ye{calculateMatrix(){const o=this.rotation*Math.PI,s=se(o),i=Z(o),e=1/3,n=Math.sqrt(e)*i,t=1-s;this.matrix=[s+t/3,e*t-n,e*t+n,0,0,e*t+n,s+e*t,e*t-n,0,0,e*t-n,e*t+n,s+e*t,0,0,0,0,0,1,0]}isNeutralState(){return 0===this.rotation}applyTo(e){this.calculateMatrix(),super.applyTo(e)}toObject(){return{type:this.type,rotation:this.rotation}}},s(Ns,"type","HueRotation"),s(Ns,"defaults",Jc),c.setClass(Ns),Ft=class extends k{applyTo2d(e){let{imageData:{data:t}}=e;for(let e=0;e<t.length;e+=4)t[e]=255-t[e],t[e+1]=255-t[e+1],t[e+2]=255-t[e+2],this.alpha&&(t[e+3]=255-t[e+3])}getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform int uInvert;
  uniform int uAlpha;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    if (uInvert == 1) {
      if (uAlpha == 1) {
        gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,1.0 -color.a);
      } else {
        gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);
      }
    } else {
      gl_FragColor = color;
    }
  }
`}isNeutralState(){return!this.invert}sendUniformData(e,t){e.uniform1i(t.uInvert,Number(this.invert)),e.uniform1i(t.uAlpha,Number(this.alpha))}},s(Ft,"type","Invert"),s(Ft,"defaults",{alpha:!1,invert:!0}),s(Ft,"uniformLocations",["uInvert","uAlpha"]),c.setClass(Ft),zt=class extends k{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uStepH;
  uniform float uNoise;
  uniform float uSeed;
  varying vec2 vTexCoord;
  float rand(vec2 co, float seed, float vScale) {
    return fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);
  }
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    color.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;
    gl_FragColor = color;
  }
`}applyTo2d(e){let{imageData:{data:t}}=e;const n=this.noise;for(let e=0;e<t.length;e+=4){const s=(.5-Math.random())*n;t[e]+=s,t[e+1]+=s,t[e+2]+=s}}sendUniformData(e,t){e.uniform1f(t.uNoise,this.noise/255),e.uniform1f(t.uSeed,Math.random())}isNeutralState(){return 0===this.noise}},s(zt,"type","Noise"),s(zt,"defaults",{noise:0}),s(zt,"uniformLocations",["uNoise","uSeed"]),c.setClass(zt),Dt=class extends k{applyTo2d(e){let{imageData:{data:t,width:n,height:s}}=e;for(let e=0;e<s;e+=this.blocksize)for(let o=0;o<n;o+=this.blocksize){const i=4*e*n+4*o,a=t[i],r=t[i+1],c=t[i+2],l=t[i+3];for(let i=e;i<Math.min(e+this.blocksize,s);i++)for(let s=o;s<Math.min(o+this.blocksize,n);s++){const e=4*i*n+4*s;t[e]=a,t[e+1]=r,t[e+2]=c,t[e+3]=l}}}isNeutralState(){return 1===this.blocksize}getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uBlocksize;
  uniform float uStepW;
  uniform float uStepH;
  varying vec2 vTexCoord;
  void main() {
    float blockW = uBlocksize * uStepW;
    float blockH = uBlocksize * uStepH;
    int posX = int(vTexCoord.x / blockW);
    int posY = int(vTexCoord.y / blockH);
    float fposX = float(posX);
    float fposY = float(posY);
    vec2 squareCoords = vec2(fposX * blockW, fposY * blockH);
    vec4 color = texture2D(uTexture, squareCoords);
    gl_FragColor = color;
  }
`}sendUniformData(e,t){e.uniform1f(t.uBlocksize,this.blocksize)}},s(Dt,"type","Pixelate"),s(Dt,"defaults",{blocksize:4}),s(Dt,"uniformLocations",["uBlocksize"]),c.setClass(Dt),Nt=class extends k{getFragmentSource(){return`
precision highp float;
uniform sampler2D uTexture;
uniform vec4 uLow;
uniform vec4 uHigh;
varying vec2 vTexCoord;
void main() {
  gl_FragColor = texture2D(uTexture, vTexCoord);
  if(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {
    gl_FragColor.a = 0.0;
  }
}
`}applyTo2d(e){let{imageData:{data:s}}=e;const t=255*this.distance,n=new U(this.color).getSource(),o=[n[0]-t,n[1]-t,n[2]-t],i=[n[0]+t,n[1]+t,n[2]+t];for(let e=0;e<s.length;e+=4){const t=s[e],n=s[e+1],a=s[e+2];t>o[0]&&n>o[1]&&a>o[2]&&t<i[0]&&n<i[1]&&a<i[2]&&(s[e+3]=0)}}sendUniformData(e,t){const n=new U(this.color).getSource(),s=this.distance,o=[0+n[0]/255-s,0+n[1]/255-s,0+n[2]/255-s,1],i=[n[0]/255+s,n[1]/255+s,n[2]/255+s,1];e.uniform4fv(t.uLow,o),e.uniform4fv(t.uHigh,i)}},s(Nt,"type","RemoveColor"),s(Nt,"defaults",{color:"#FFFFFF",distance:.02,useAlpha:!1}),s(Nt,"uniformLocations",["uLow","uHigh"]),c.setClass(Nt),Ht=class extends k{sendUniformData(e,t){e.uniform2fv(t.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),e.uniform1fv(t.uTaps,this.taps)}getFilterWindow(){const e=this.tempScale;return Math.ceil(this.lanczosLobes/e)}getCacheKey(){const e=this.getFilterWindow();return"".concat(this.type,"_").concat(e)}getFragmentSource(){const e=this.getFilterWindow();return this.generateShader(e)}getTaps(){const n=this.lanczosCreate(this.lanczosLobes),s=this.tempScale,e=this.getFilterWindow(),t=new Array(e);for(let o=1;o<=e;o++)t[o-1]=n(o*s);return t}generateShader(e){const t=new Array(e);for(let n=1;n<=e;n++)t[n-1]="".concat(n,".0 * uDelta");return`
      precision highp float;
      uniform sampler2D uTexture;
      uniform vec2 uDelta;
      varying vec2 vTexCoord;
      uniform float uTaps[`.concat(e,`];
      void main() {
        vec4 color = texture2D(uTexture, vTexCoord);
        float sum = 1.0;
        `).concat(t.map((e,t)=>`
              color += texture2D(uTexture, vTexCoord + `.concat(e,") * uTaps[").concat(t,"] + texture2D(uTexture, vTexCoord - ").concat(e,") * uTaps[").concat(t,`];
              sum += 2.0 * uTaps[`).concat(t,`];
            `)).join(`
`),`
        gl_FragColor = color / sum;
      }
    `)}applyToForWebgl(e){e.passes++,this.width=e.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=e.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),e.destinationWidth=this.dW,super.applyTo(e),e.sourceWidth=e.destinationWidth,this.height=e.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),e.destinationHeight=this.dH,super.applyTo(e),e.sourceHeight=e.destinationHeight}applyTo(e){ys(e)?this.applyToForWebgl(e):this.applyTo2d(e)}isNeutralState(){return 1===this.scaleX&&1===this.scaleY}lanczosCreate(e){return t=>{if(t>=e||t<=-e)return 0;if(t<11920929e-14&&t>-11920929e-14)return 1;const n=(t*=Math.PI)/e;return Math.sin(t)/t*Math.sin(n)/n}}applyTo2d(e){const i=e.imageData,a=this.scaleX,r=this.scaleY;this.rcpScaleX=1/a,this.rcpScaleY=1/r;const t=i.width,n=i.height,s=Math.round(t*a),o=Math.round(n*r);let c;c="sliceHack"===this.resizeType?this.sliceByTwo(e,t,n,s,o):"hermite"===this.resizeType?this.hermiteFastResize(e,t,n,s,o):"bilinear"===this.resizeType?this.bilinearFiltering(e,t,n,s,o):"lanczos"===this.resizeType?this.lanczosResize(e,t,n,s,o):new ImageData(s,o),e.imageData=c}sliceByTwo(e,t,n,s,o){const v=e.imageData,a=.5;let g=!1,f=!1,c=t*a,i=n*a;const u=e.filterBackend.resources;let h=0,m=0;const p=t;let d=0;u.sliceByTwo||(u.sliceByTwo=ae());const r=u.sliceByTwo;(r.width<1.5*t||r.height<n)&&(r.width=1.5*t,r.height=n);const l=r.getContext("2d");for(l.clearRect(0,0,1.5*t,n),l.putImageData(v,0,0),s=Math.floor(s),o=Math.floor(o);!g||!f;)t=c,n=i,s<Math.floor(c*a)?c=Math.floor(c*a):(c=s,g=!0),o<Math.floor(i*a)?i=Math.floor(i*a):(i=o,f=!0),l.drawImage(r,h,m,t,n,p,d,c,i),h=p,m=d,d+=i;return l.getImageData(h,m,s,o)}lanczosResize(e,t,n,s,o){const l=e.imageData.data,d=e.ctx.createImageData(s,o),c=d.data,p=this.lanczosCreate(this.lanczosLobes),u=this.rcpScaleX,h=this.rcpScaleY,v=2/this.rcpScaleX,g=2/this.rcpScaleY,m=Math.ceil(u*this.lanczosLobes/2),f=Math.ceil(h*this.lanczosLobes/2),r={},a={x:0,y:0},i={x:0,y:0};return function e(b){let x,y,_,j,O,E,k,A,S,w,C;for(a.x=(b+.5)*u,i.x=Math.floor(a.x),x=0;x<o;x++){for(a.y=(x+.5)*h,i.y=Math.floor(a.y),O=0,E=0,k=0,A=0,S=0,y=i.x-m;y<=i.x+m;y++)if(!(y<0||y>=t)){w=Math.floor(1e3*Math.abs(y-a.x)),r[w]||(r[w]={});for(let e=i.y-f;e<=i.y+f;e++)e<0||e>=n||(C=Math.floor(1e3*Math.abs(e-a.y)),r[w][C]||(r[w][C]=p(Math.sqrt((w*v)**2+(C*g)**2)/1e3)),_=r[w][C],_>0&&(j=4*(e*t+y),O+=_,E+=_*l[j],k+=_*l[j+1],A+=_*l[j+2],S+=_*l[j+3]))}j=4*(x*s+b),c[j]=E/O,c[j+1]=k/O,c[j+2]=A/O,c[j+3]=S/O}return++b<s?e(b):d}(0)}bilinearFiltering(e,t,n,s,o){let f,_,v,p,m,h,d,a,l,c,i,g,r,O=0;const b=this.rcpScaleX,j=this.rcpScaleY,y=4*(t-1),u=e.imageData.data,w=e.ctx.createImageData(s,o),x=w.data;for(d=0;d<o;d++)for(a=0;a<s;a++)for(m=Math.floor(b*a),h=Math.floor(j*d),l=b*a-m,c=j*d-h,r=4*(h*t+m),i=0;i<4;i++)f=u[r+i],_=u[r+4+i],v=u[r+y+i],p=u[r+y+4+i],g=f*(1-l)*(1-c)+_*l*(1-c)+v*c*(1-l)+p*l*c,x[O++]=g;return w}hermiteFastResize(e,t,n,s,o){const a=this.rcpScaleX,r=this.rcpScaleY,d=Math.ceil(a/2),u=Math.ceil(r/2),i=e.imageData.data,l=e.ctx.createImageData(s,o),c=l.data;for(let e=0;e<o;e++)for(let o=0;o<s;o++){const l=4*(o+e*s);let n=0,h=0,m=0,f=0,p=0,g=0,v=0;const b=(e+.5)*r;for(let s=Math.floor(e*r);s<(e+1)*r;s++){const c=Math.abs(b-(s+.5))/u,l=(o+.5)*a,j=c*c;for(let c=Math.floor(o*a);c<(o+1)*a;c++){let e=Math.abs(l-(c+.5))/d;const r=Math.sqrt(j+e*e);r>1&&r<-1||(n=2*r*r*r-3*r*r+1,n>0&&(e=4*(c+s*t),v+=n*i[e+3],m+=n,i[e+3]<255&&(n=n*i[e+3]/250),f+=n*i[e],p+=n*i[e+1],g+=n*i[e+2],h+=n))}}c[l]=f/h,c[l+1]=p/h,c[l+2]=g/h,c[l+3]=v/m}return l}},s(Ht,"type","Resize"),s(Ht,"defaults",{resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3}),s(Ht,"uniformLocations",["uDelta","uTaps"]),c.setClass(Ht),Yt=class extends k{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uSaturation;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    float rgMax = max(color.r, color.g);
    float rgbMax = max(rgMax, color.b);
    color.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;
    color.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;
    color.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;
    gl_FragColor = color;
  }
`}applyTo2d(e){let{imageData:{data:t}}=e;const n=-this.saturation;for(let e=0;e<t.length;e+=4){const o=t[e],i=t[e+1],a=t[e+2],s=Math.max(o,i,a);t[e]+=s!==o?(s-o)*n:0,t[e+1]+=s!==i?(s-i)*n:0,t[e+2]+=s!==a?(s-a)*n:0}}sendUniformData(e,t){e.uniform1f(t.uSaturation,-this.saturation)}isNeutralState(){return 0===this.saturation}},s(Yt,"type","Saturation"),s(Yt,"defaults",{saturation:0}),s(Yt,"uniformLocations",["uSaturation"]),c.setClass(Yt),Xt=class extends k{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uVibrance;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    float max = max(color.r, max(color.g, color.b));
    float avg = (color.r + color.g + color.b) / 3.0;
    float amt = (abs(max - avg) * 2.0) * uVibrance;
    color.r += max != color.r ? (max - color.r) * amt : 0.00;
    color.g += max != color.g ? (max - color.g) * amt : 0.00;
    color.b += max != color.b ? (max - color.b) * amt : 0.00;
    gl_FragColor = color;
  }
`}applyTo2d(e){let{imageData:{data:t}}=e;const n=-this.vibrance;for(let e=0;e<t.length;e+=4){const o=t[e],i=t[e+1],a=t[e+2],s=Math.max(o,i,a),c=(o+i+a)/3,r=2*Math.abs(s-c)/255*n;t[e]+=s!==o?(s-o)*r:0,t[e+1]+=s!==i?(s-i)*r:0,t[e+2]+=s!==a?(s-a)*r:0}}sendUniformData(e,t){e.uniform1f(t.uVibrance,-this.vibrance)}isNeutralState(){return 0===this.vibrance}},s(Xt,"type","Vibrance"),s(Xt,"defaults",{vibrance:0}),s(Xt,"uniformLocations",["uVibrance"]),c.setClass(Xt),j2=Object.freeze({__proto__:null,BaseFilter:k,BlackWhite:cl,BlendColor:zn,BlendImage:Sn,Blur:An,Brightness:kn,Brownie:Sl,ColorMatrix:Ye,Composed:ao,Contrast:rn,Convolute:nn,Gamma:Zt,Grayscale:Vt,HueRotation:Ns,Invert:Ft,Kodachrome:ml,Noise:zt,Pixelate:Dt,Polaroid:ul,RemoveColor:Nt,Resize:Ht,Saturation:Yt,Sepia:ll,Technicolor:hl,Vibrance:Xt,Vintage:fl}),h=e=>typeof e=="string",cn=()=>{let t,n;const e=new Promise((e,s)=>{t=e,n=s});return e.resolve=t,e.reject=n,e},bc=e=>e==null?"":""+e,Qc=(e,t,n)=>{e.forEach(e=>{t[e]&&(n[e]=t[e])})},Xc=/###/g,_c=e=>e&&e.indexOf("###")>-1?e.replace(Xc,"."):e,wc=e=>!e||h(e),dn=(e,t,n)=>{const o=h(t)?t.split("."):t;let s=0;for(;s<o.length-1;){if(wc(e))return{};const t=_c(o[s]);!e[t]&&n&&(e[t]=new n),Object.prototype.hasOwnProperty.call(e,t)?e=e[t]:e={},++s}return wc(e)?{}:{obj:e,k:_c(o[s])}},xc=(e,t,n)=>{const{obj:a,k:r}=dn(e,t,Object);if(a!==0[0]||t.length===1){a[r]=n;return}let i=t[t.length-1],s=t.slice(0,t.length-1),o=dn(e,s,Object);for(;o.obj===0[0]&&s.length;)i=`${s[s.length-1]}.${i}`,s=s.slice(0,s.length-1),o=dn(e,s,Object),o?.obj&&typeof o.obj[`${o.k}.${i}`]!="undefined"&&(o.obj=0[0]);o.obj[`${o.k}.${i}`]=n},Gc=(e,t,n)=>{const{obj:o,k:i}=dn(e,t,Object);o[i]=o[i]||[],o[i].push(n)},Rs=(e,t)=>{const{obj:n,k:s}=dn(e,t);return n?Object.prototype.hasOwnProperty.call(n,s)?n[s]:0[0]:0[0]},Yc=(e,t,n)=>{const s=Rs(e,n);return s!==0[0]?s:Rs(t,n)},Ac=(e,t,n)=>{for(const s in t)s!=="__proto__"&&s!=="constructor"&&(s in e?h(e[s])||e[s]instanceof String||h(t[s])||t[s]instanceof String?n&&(e[s]=t[s]):Ac(e[s],t[s],n):e[s]=t[s]);return e},kt=e=>e.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&"),qc={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},Kc=e=>h(e)?e.replace(/[&<>"'/]/g,e=>qc[e]):e,Uc=class{constructor(e){this.capacity=e,this.regExpMap=new Map,this.regExpQueue=[]}getRegExp(e){const t=this.regExpMap.get(e);if(t!==0[0])return t;const n=new RegExp(e);return this.regExpQueue.length===this.capacity&&this.regExpMap.delete(this.regExpQueue.shift()),this.regExpMap.set(e,n),this.regExpQueue.push(e),n}},Wc=[" ",",","?","!",";"],$c=new Uc(20),Vc=(e,t,n)=>{t=t||"",n=n||"";const o=Wc.filter(e=>t.indexOf(e)<0&&n.indexOf(e)<0);if(o.length===0)return!0;const i=$c.getRegExp(`(${o.map(e=>e==="?"?"\\?":e).join("|")})`);let s=!i.test(e);if(!s){const t=e.indexOf(n);t>0&&!i.test(e.substring(0,t))&&(s=!0)}return s},Ks=(e,t,n=".")=>{if(!e)return 0[0];if(e[t])return Object.prototype.hasOwnProperty.call(e,t)?e[t]:0[0];const o=t.split(n);let s=e;for(let e=0;e<o.length;){if(!s||typeof s!="object")return 0[0];let t,i="";for(let a=e;a<o.length;++a)if(a!==e&&(i+=n),i+=o[a],t=s[i],t!==0[0]){if(["string","number","boolean"].indexOf(typeof t)>-1&&a<o.length-1)continue;e+=a-e+1;break}s=t}return s},En=e=>e?.replace("_","-"),Bc={type:"logger",log(e){this.output("log",e)},warn(e){this.output("warn",e)},error(e){this.output("error",e)},output(e,t){console?.[e]?.apply?.(console,t)}},n1=class _Logger{constructor(e,t={}){this.init(e,t)}init(e,t={}){this.prefix=t.prefix||"i18next:",this.logger=e||Bc,this.options=t,this.debug=t.debug}log(...e){return this.forward(e,"log","",!0)}warn(...e){return this.forward(e,"warn","",!0)}error(...e){return this.forward(e,"error","")}deprecate(...e){return this.forward(e,"warn","WARNING DEPRECATED: ",!0)}forward(e,t,n,s){return s&&!this.debug?null:(h(e[0])&&(e[0]=`${n}${this.prefix} ${e[0]}`),this.logger[t](e))}create(e){return new _Logger(this.logger,{...{prefix:`${this.prefix}:${e}:`},...this.options})}clone(e){return e=e||this.options,e.prefix=e.prefix||this.prefix,new _Logger(this.logger,e)}},me=new n1,Bs=class{constructor(){this.observers={}}on(e,t){return e.split(" ").forEach(e=>{this.observers[e]||(this.observers[e]=new Map);const n=this.observers[e].get(t)||0;this.observers[e].set(t,n+1)}),this}off(e,t){if(!this.observers[e])return;if(!t){delete this.observers[e];return}this.observers[e].delete(t)}emit(e,...t){if(this.observers[e]){const n=Array.from(this.observers[e].entries());n.forEach(([e,n])=>{for(let s=0;s<n;s++)e(...t)})}if(this.observers["*"]){const n=Array.from(this.observers["*"].entries());n.forEach(([n,s])=>{for(let o=0;o<s;o++)n.apply(n,[e,...t])})}}},Nc=class extends Bs{constructor(e,t={ns:["translation"],defaultNS:"translation"}){super(),this.data=e||{},this.options=t,this.options.keySeparator===0[0]&&(this.options.keySeparator="."),this.options.ignoreJSONStructure===0[0]&&(this.options.ignoreJSONStructure=!0)}addNamespaces(e){this.options.ns.indexOf(e)<0&&this.options.ns.push(e)}removeNamespaces(e){const t=this.options.ns.indexOf(e);t>-1&&this.options.ns.splice(t,1)}getResource(e,t,n,s={}){const i=s.keySeparator!==0[0]?s.keySeparator:this.options.keySeparator,r=s.ignoreJSONStructure!==0[0]?s.ignoreJSONStructure:this.options.ignoreJSONStructure;let o;e.indexOf(".")>-1?o=e.split("."):(o=[e,t],n&&(Array.isArray(n)?o.push(...n):h(n)&&i?o.push(...n.split(i)):o.push(n)));const a=Rs(this.data,o);return!a&&!t&&!n&&e.indexOf(".")>-1&&(e=o[0],t=o[1],n=o.slice(2).join(".")),a||!r||!h(n)?a:Ks(this.data?.[e]?.[t],n,i)}addResource(e,t,n,s,o={silent:!1}){const a=o.keySeparator!==0[0]?o.keySeparator:this.options.keySeparator;let i=[e,t];n&&(i=i.concat(a?n.split(a):n)),e.indexOf(".")>-1&&(i=e.split("."),s=t,t=i[1]),this.addNamespaces(t),xc(this.data,i,s),o.silent||this.emit("added",e,t,n,s)}addResources(e,t,n,s={silent:!1}){for(const s in n)(h(n[s])||Array.isArray(n[s]))&&this.addResource(e,t,s,n[s],{silent:!0});s.silent||this.emit("added",e,t,n)}addResourceBundle(e,t,n,s,o,i={silent:!1,skipCopy:!1}){let a=[e,t];e.indexOf(".")>-1&&(a=e.split("."),s=n,n=t,t=a[1]),this.addNamespaces(t);let r=Rs(this.data,a)||{};i.skipCopy||(n=JSON.parse(JSON.stringify(n))),s?Ac(r,n,o):r={...r,...n},xc(this.data,a,r),i.silent||this.emit("added",e,t,n)}removeResourceBundle(e,t){this.hasResourceBundle(e,t)&&delete this.data[e][t],this.removeNamespaces(t),this.emit("removed",e,t)}hasResourceBundle(e,t){return this.getResource(e,t)!==0[0]}getResourceBundle(e,t){return t||(t=this.options.defaultNS),this.getResource(e,t)}getDataByLanguage(e){return this.data[e]}hasLanguageSomeTranslations(e){const t=this.getDataByLanguage(e),n=t&&Object.keys(t)||[];return!!n.find(e=>t[e]&&Object.keys(t[e]).length>0)}toJSON(){return this.data}},Dc={processors:{},addPostProcessor(e){this.processors[e.name]=e},handle(e,t,n,s,o){return e.forEach(e=>{t=this.processors[e]?.process(t,n,s,o)??t}),t}},zc=Symbol("i18next/PATH_KEY");function y2(){const n=[],e=Object.create(null);let t;return e.get=(s,o)=>(t?.revoke?.(),o===zc?n:(n.push(o),t=Proxy.revocable(s,e),t.proxy)),Proxy.revocable(Object.create(null),e).proxy}function Tc(e,t){const{[zc]:n}=e(y2());return n.join(t?.keySeparator??".")}Fc={},qs=e=>!h(e)&&typeof e!="boolean"&&typeof e!="number",kc=class _Translator extends Bs{constructor(e,t={}){super(),Qc(["resourceStore","languageUtils","pluralResolver","interpolator","backendConnector","i18nFormat","utils"],e,this),this.options=t,this.options.keySeparator===0[0]&&(this.options.keySeparator="."),this.logger=me.create("translator")}changeLanguage(e){e&&(this.language=e)}exists(e,t={interpolation:{}}){const n={...t};if(e==null)return!1;const s=this.resolve(e,n);if(s?.res===0[0])return!1;const o=qs(s.res);return n.returnObjects!==!1||!o}extractFromKey(e,t){let n=t.nsSeparator!==0[0]?t.nsSeparator:this.options.nsSeparator;n===0[0]&&(n=":");const o=t.keySeparator!==0[0]?t.keySeparator:this.options.keySeparator;let s=t.ns||this.options.defaultNS||[];const i=n&&e.indexOf(n)>-1,a=!this.options.userDefinedKeySeparator&&!t.keySeparator&&!this.options.userDefinedNsSeparator&&!t.nsSeparator&&!Vc(e,n,o);if(i&&!a){const i=e.match(this.interpolator.nestingRegexp);if(i&&i.length>0)return{key:e,namespaces:h(s)?[s]:s};const t=e.split(n);(n!==o||n===o&&this.options.ns.indexOf(t[0])>-1)&&(s=t.shift()),e=t.join(o)}return{key:e,namespaces:h(s)?[s]:s}}translate(e,t,n){let s=typeof t=="object"?{...t}:t;if(typeof s!="object"&&this.options.overloadTranslationOptionHandler&&(s=this.options.overloadTranslationOptionHandler(arguments)),typeof s=="object"&&(s={...s}),s||(s={}),e==null)return"";typeof e=="function"&&(e=Tc(e,{...this.options,...s})),Array.isArray(e)||(e=[String(e)]);const p=s.returnDetails!==0[0]?s.returnDetails:this.options.returnDetails,v=s.keySeparator!==0[0]?s.keySeparator:this.options.keySeparator,{key:i,namespaces:m}=this.extractFromKey(e[e.length-1],s),c=m[m.length-1];let u=s.nsSeparator!==0[0]?s.nsSeparator:this.options.nsSeparator;u===0[0]&&(u=":");const d=s.lng||this.language,E=s.appendNamespaceToCIMode||this.options.appendNamespaceToCIMode;if(d?.toLowerCase()==="cimode")return E?p?{res:`${c}${u}${i}`,usedKey:i,exactUsedKey:i,usedLng:d,usedNS:c,usedParams:this.getUsedParamsDetails(s)}:`${c}${u}${i}`:p?{res:i,usedKey:i,exactUsedKey:i,usedLng:d,usedNS:c,usedParams:this.getUsedParamsDetails(s)}:i;const r=this.resolve(e,s);let o=r?.res;const _=r?.usedKey||i,w=r?.exactUsedKey||i,C=["[object Number]","[object Function]","[object RegExp]"],b=s.joinArrays!==0[0]?s.joinArrays:this.options.joinArrays,j=!this.i18nFormat||this.i18nFormat.handleAsObject,g=s.count!==0[0]&&!h(s.count),f=_Translator.hasDefaultValue(s),x=g?this.pluralResolver.getSuffix(d,s.count,s):"",O=s.ordinal&&g?this.pluralResolver.getSuffix(d,s.count,{ordinal:!1}):"",y=g&&!s.ordinal&&s.count===0,l=y&&s[`defaultValue${this.options.pluralSeparator}zero`]||s[`defaultValue${x}`]||s[`defaultValue${O}`]||s.defaultValue;let a=o;j&&!o&&f&&(a=l);const k=qs(a),A=Object.prototype.toString.apply(a);if(j&&a&&k&&C.indexOf(A)<0&&!(h(b)&&Array.isArray(a))){{if(!s.returnObjects&&!this.options.returnObjects){this.options.returnedObjectHandler||this.logger.warn("accessing an object - but returnObjects options is not enabled!");const e=this.options.returnedObjectHandler?this.options.returnedObjectHandler(_,a,{...s,ns:m}):`key '${i} (${this.language})' returned an object instead of string.`;return p?(r.res=e,r.usedParams=this.getUsedParamsDetails(s),r):e}if(v){const t=Array.isArray(a),e=t?[]:{},n=t?w:_;for(const t in a)if(Object.prototype.hasOwnProperty.call(a,t)){const i=`${n}${v}${t}`;f&&!o?e[t]=this.translate(i,{...s,defaultValue:qs(l)?l[t]:0[0],...{joinArrays:!1,ns:m}}):e[t]=this.translate(i,{...s,...{joinArrays:!1,ns:m}}),e[t]===i&&(e[t]=a[t])}o=e}}}else if(j&&h(b)&&Array.isArray(o))o=o.join(b),o&&(o=this.extendTranslation(o,e,s,n));else{let h=!1,t=!1;!this.isValidLookup(o)&&f&&(h=!0,o=l),this.isValidLookup(o)||(t=!0,o=i);const m=s.missingKeyNoValueFallbackToKey||this.options.missingKeyNoValueFallbackToKey,p=m&&t?0[0]:o,a=f&&l!==o&&this.options.updateMissing;if(t||h||a){if(this.logger.log(a?"updateKey":"missingKey",d,c,i,a?l:o),v){const e=this.resolve(i,{...s,keySeparator:!1});e&&e.res&&this.logger.warn("Seems the loaded translations were in flat JSON format instead of nested. Either set keySeparator: false on init or make sure your translations are published in nested format.")}let e=[];const t=this.languageUtils.getFallbackCodes(this.options.fallbackLng,s.lng||this.language);if(this.options.saveMissingTo==="fallback"&&t&&t[0])for(let n=0;n<t.length;n++)e.push(t[n]);else this.options.saveMissingTo==="all"?e=this.languageUtils.toResolveHierarchy(s.lng||this.language):e.push(s.lng||this.language);const n=(e,t,n)=>{const i=f&&n!==o?n:p;this.options.missingKeyHandler?this.options.missingKeyHandler(e,c,t,i,a,s):this.backendConnector?.saveMissing&&this.backendConnector.saveMissing(e,c,t,i,a,s),this.emit("missingKey",e,c,t,o)};this.options.saveMissing&&(this.options.saveMissingPlurals&&g?e.forEach(e=>{const t=this.pluralResolver.getSuffixes(e,s);y&&s[`defaultValue${this.options.pluralSeparator}zero`]&&t.indexOf(`${this.options.pluralSeparator}zero`)<0&&t.push(`${this.options.pluralSeparator}zero`),t.forEach(t=>{n([e],i+t,s[`defaultValue${t}`]||l)})}):n(e,i,l))}o=this.extendTranslation(o,e,s,r,n),t&&o===i&&this.options.appendNamespaceToMissingKey&&(o=`${c}${u}${i}`),(t||h)&&this.options.parseMissingKeyHandler&&(o=this.options.parseMissingKeyHandler(this.options.appendNamespaceToMissingKey?`${c}${u}${i}`:i,h?o:0[0],s))}return p?(r.res=o,r.usedParams=this.getUsedParamsDetails(s),r):o}extendTranslation(e,t,n,s,o){if(this.i18nFormat?.parse)e=this.i18nFormat.parse(e,{...this.options.interpolation.defaultVariables,...n},n.lng||this.language||s.usedLng,s.usedNS,s.usedKey,{resolved:s});else if(!n.skipInterpolation){n.interpolation&&this.interpolator.init({...n,...{interpolation:{...this.options.interpolation,...n.interpolation}}});const a=h(e)&&(n?.interpolation?.skipOnVariables!==0[0]?n.interpolation.skipOnVariables:this.options.interpolation.skipOnVariables);let r;if(a){const t=e.match(this.interpolator.nestingRegexp);r=t&&t.length}let i=n.replace&&!h(n.replace)?n.replace:n;if(this.options.interpolation.defaultVariables&&(i={...this.options.interpolation.defaultVariables,...i}),e=this.interpolator.interpolate(e,i,n.lng||this.language||s.usedLng,n),a){const t=e.match(this.interpolator.nestingRegexp),s=t&&t.length;r<s&&(n.nest=!1)}!n.lng&&s&&s.res&&(n.lng=this.language||s.usedLng),n.nest!==!1&&(e=this.interpolator.nest(e,(...e)=>o?.[0]===e[0]&&!n.context?(this.logger.warn(`It seems you are nesting recursively key: ${e[0]} in key: ${t[0]}`),null):this.translate(...e,t),n)),n.interpolation&&this.interpolator.reset()}const i=n.postProcess||this.options.postProcess,a=h(i)?[i]:i;return e!=null&&a?.length&&n.applyPostProcessor!==!1&&(e=Dc.handle(a,e,t,this.options&&this.options.postProcessPassResolved?{i18nResolved:{...s,usedParams:this.getUsedParamsDetails(n)},...n}:n,this)),e}resolve(e,t={}){let n,o,i,a,s;return h(e)&&(e=[e]),e.forEach(e=>{if(this.isValidLookup(n))return;const u=this.extractFromKey(e,t),r=u.key;o=r;let d=u.namespaces;this.options.fallbackNS&&(d=d.concat(this.options.fallbackNS));const c=t.count!==0[0]&&!h(t.count),m=c&&!t.ordinal&&t.count===0,f=t.context!==0[0]&&(h(t.context)||typeof t.context=="number")&&t.context!=="",l=t.lngs?t.lngs:this.languageUtils.toResolveHierarchy(t.lng||this.language,t.fallbackLng);d.forEach(e=>{if(this.isValidLookup(n))return;s=e,!Fc[`${l[0]}-${e}`]&&this.utils?.hasLoadedNamespace&&!this.utils?.hasLoadedNamespace(s)&&(Fc[`${l[0]}-${e}`]=!0,this.logger.warn(`key "${o}" for languages "${l.join(", ")}" won't get resolved as namespace "${s}" was not yet loaded`,"This means something IS WRONG in your setup. You access the t function before i18next.init / i18next.loadNamespace / i18next.changeLanguage was done. Wait for the callback or Promise to resolve before accessing it!!!")),l.forEach(s=>{if(this.isValidLookup(n))return;a=s;const o=[r];if(this.i18nFormat?.addLookupKeys)this.i18nFormat.addLookupKeys(o,r,s,e,t);else{let e;c&&(e=this.pluralResolver.getSuffix(s,t.count,t));const i=`${this.options.pluralSeparator}zero`,n=`${this.options.pluralSeparator}ordinal${this.options.pluralSeparator}`;if(c&&(t.ordinal&&e.indexOf(n)===0&&o.push(r+e.replace(n,this.options.pluralSeparator)),o.push(r+e),m&&o.push(r+i)),f){const s=`${r}${this.options.contextSeparator||"_"}${t.context}`;o.push(s),c&&(t.ordinal&&e.indexOf(n)===0&&o.push(s+e.replace(n,this.options.pluralSeparator)),o.push(s+e),m&&o.push(s+i))}}let l;for(;l=o.pop();)this.isValidLookup(n)||(i=l,n=this.getResource(s,e,l,t))})})}),{res:n,usedKey:o,exactUsedKey:i,usedLng:a,usedNS:s}}isValidLookup(e){return e!==0[0]&&!(!this.options.returnNull&&e===null)&&!(!this.options.returnEmptyString&&e==="")}getResource(e,t,n,s={}){return this.i18nFormat?.getResource?this.i18nFormat.getResource(e,t,n,s):this.resourceStore.getResource(e,t,n,s)}getUsedParamsDetails(e={}){const s=["defaultValue","ordinal","context","replace","lng","lngs","fallbackLng","ns","keySeparator","nsSeparator","returnObjects","returnDetails","joinArrays","postProcess","interpolation"],n=e.replace&&!h(e.replace);let t=n?e.replace:e;if(n&&typeof e.count!="undefined"&&(t.count=e.count),this.options.interpolation.defaultVariables&&(t={...this.options.interpolation.defaultVariables,...t}),!n){t={...t};for(const e of s)delete t[e]}return t}static hasDefaultValue(e){const t="defaultValue";for(const n in e)if(Object.prototype.hasOwnProperty.call(e,n)&&t===n.substring(0,t.length)&&0[0]!==e[n])return!0;return!1}},Cc=class{constructor(e){this.options=e,this.supportedLngs=this.options.supportedLngs||!1,this.logger=me.create("languageUtils")}getScriptPartFromCode(e){if(e=En(e),!e||e.indexOf("-")<0)return null;const t=e.split("-");return t.length===2?null:(t.pop(),t[t.length-1].toLowerCase()==="x"?null:this.formatLanguageCode(t.join("-")))}getLanguagePartFromCode(e){if(e=En(e),!e||e.indexOf("-")<0)return e;const t=e.split("-");return this.formatLanguageCode(t[0])}formatLanguageCode(e){if(h(e)&&e.indexOf("-")>-1){let t;try{t=Intl.getCanonicalLocales(e)[0]}catch{}return t&&this.options.lowerCaseLng&&(t=t.toLowerCase()),t?t:this.options.lowerCaseLng?e.toLowerCase():e}return this.options.cleanCode||this.options.lowerCaseLng?e.toLowerCase():e}isSupportedCode(e){return(this.options.load==="languageOnly"||this.options.nonExplicitSupportedLngs)&&(e=this.getLanguagePartFromCode(e)),!this.supportedLngs||!this.supportedLngs.length||this.supportedLngs.indexOf(e)>-1}getBestMatchFromCodes(e){if(!e)return null;let t;return e.forEach(e=>{if(t)return;const n=this.formatLanguageCode(e);(!this.options.supportedLngs||this.isSupportedCode(n))&&(t=n)}),!t&&this.options.supportedLngs&&e.forEach(e=>{if(t)return;const s=this.getScriptPartFromCode(e);if(this.isSupportedCode(s))return t=s;const n=this.getLanguagePartFromCode(e);if(this.isSupportedCode(n))return t=n;t=this.options.supportedLngs.find(e=>{if(e===n)return e;if(e.indexOf("-")<0&&n.indexOf("-")<0)return;if(e.indexOf("-")>0&&n.indexOf("-")<0&&e.substring(0,e.indexOf("-"))===n)return e;if(e.indexOf(n)===0&&n.length>1)return e})}),t||(t=this.getFallbackCodes(this.options.fallbackLng)[0]),t}getFallbackCodes(e,t){if(!e)return[];if(typeof e=="function"&&(e=e(t)),h(e)&&(e=[e]),Array.isArray(e))return e;if(!t)return e.default||[];let n=e[t];return n||(n=e[this.getScriptPartFromCode(t)]),n||(n=e[this.formatLanguageCode(t)]),n||(n=e[this.getLanguagePartFromCode(t)]),n||(n=e.default),n||[]}toResolveHierarchy(e,t){const o=this.getFallbackCodes((t===!1?[]:t)||this.options.fallbackLng||[],e),s=[],n=e=>{if(!e)return;this.isSupportedCode(e)?s.push(e):this.logger.warn(`rejecting language code not found in supportedLngs: ${e}`)};return h(e)&&(e.indexOf("-")>-1||e.indexOf("_")>-1)?(this.options.load!=="languageOnly"&&n(this.formatLanguageCode(e)),this.options.load!=="languageOnly"&&this.options.load!=="currentOnly"&&n(this.getScriptPartFromCode(e)),this.options.load!=="currentOnly"&&n(this.getLanguagePartFromCode(e))):h(e)&&n(this.formatLanguageCode(e)),o.forEach(e=>{s.indexOf(e)<0&&n(this.formatLanguageCode(e))}),s}},yc={zero:0,one:1,two:2,few:3,many:4,other:5},jc={select:e=>e===1?"one":"other",resolvedOptions:()=>({pluralCategories:["one","other"]})},Zc=class{constructor(e,t={}){this.languageUtils=e,this.options=t,this.logger=me.create("pluralResolver"),this.pluralRulesCache={}}addRule(e,t){this.rules[e]=t}clearCache(){this.pluralRulesCache={}}getRule(e,t={}){const o=En(e==="dev"?"en":e),i=t.ordinal?"ordinal":"cardinal",s=JSON.stringify({cleanedCode:o,type:i});if(s in this.pluralRulesCache)return this.pluralRulesCache[s];let n;try{n=new Intl.PluralRules(o,{type:i})}catch{if(!Intl)return this.logger.error("No Intl support, please use an Intl polyfill!"),jc;if(!e.match(/-|_/))return jc;const s=this.languageUtils.getLanguagePartFromCode(e);n=this.getRule(s,t)}return this.pluralRulesCache[s]=n,n}needsPlural(e,t={}){let n=this.getRule(e,t);return n||(n=this.getRule("dev",t)),n?.resolvedOptions().pluralCategories.length>1}getPluralFormsOfKey(e,t,n={}){return this.getSuffixes(e,n).map(e=>`${t}${e}`)}getSuffixes(e,t={}){let n=this.getRule(e,t);return n||(n=this.getRule("dev",t)),n?n.resolvedOptions().pluralCategories.sort((e,t)=>yc[e]-yc[t]).map(e=>`${this.options.prepend}${t.ordinal?`ordinal${this.options.prepend}`:""}${e}`):[]}getSuffix(e,t,n={}){const s=this.getRule(e,n);return s?`${this.options.prepend}${n.ordinal?`ordinal${this.options.prepend}`:""}${s.select(t)}`:(this.logger.warn(`no plural rule found for: ${e}`),this.getSuffix("dev",t,n))}},pc=(e,t,n,s=".",o=!0)=>{let i=Yc(e,t,n);return!i&&o&&h(n)&&(i=Ks(e,n,s),i===0[0]&&(i=Ks(t,n,s))),i},Zs=e=>e.replace(/\$/g,"$$$$"),el=class{constructor(e={}){this.logger=me.create("interpolator"),this.options=e,this.format=e?.interpolation?.format||(e=>e),this.init(e)}init(e={}){e.interpolation||(e.interpolation={escapeValue:!0});const{escape:r,escapeValue:l,useRawValueToEscape:s,prefix:o,prefixEscaped:v,suffix:a,suffixEscaped:m,formatSeparator:u,unescapeSuffix:c,unescapePrefix:d,nestingPrefix:n,nestingPrefixEscaped:h,nestingSuffix:t,nestingSuffixEscaped:f,nestingOptionsSeparator:p,maxReplaces:g,alwaysFormat:i}=e.interpolation;this.escape=r!==0[0]?r:Kc,this.escapeValue=l===0[0]||l,this.useRawValueToEscape=s!==0[0]&&s,this.prefix=o?kt(o):v||"{{",this.suffix=a?kt(a):m||"}}",this.formatSeparator=u||",",this.unescapePrefix=c?"":d||"-",this.unescapeSuffix=this.unescapePrefix?"":c||"",this.nestingPrefix=n?kt(n):h||kt("$t("),this.nestingSuffix=t?kt(t):f||kt(")"),this.nestingOptionsSeparator=p||",",this.maxReplaces=g||1e3,this.alwaysFormat=i!==0[0]&&i,this.resetRegExp()}reset(){this.options&&this.init(this.options)}resetRegExp(){const e=(e,t)=>e?.source===t?(e.lastIndex=0,e):new RegExp(t,"g");this.regexp=e(this.regexp,`${this.prefix}(.+?)${this.suffix}`),this.regexpUnescape=e(this.regexpUnescape,`${this.prefix}${this.unescapePrefix}(.+?)${this.unescapeSuffix}${this.suffix}`),this.nestingRegexp=e(this.nestingRegexp,`${this.nestingPrefix}((?:[^()"']+|"[^"]*"|'[^']*'|\\((?:[^()]|"[^"]*"|'[^']*')*\\))*?)${this.nestingSuffix}`)}interpolate(e,t,n,s){let i,o,a;const r=this.options&&this.options.interpolation&&this.options.interpolation.defaultVariables||{},d=e=>{if(e.indexOf(this.formatSeparator)<0){const o=pc(t,r,e,this.options.keySeparator,this.options.ignoreJSONStructure);return this.alwaysFormat?this.format(o,0[0],n,{...s,...t,interpolationkey:e}):o}const o=e.split(this.formatSeparator),i=o.shift().trim(),a=o.join(this.formatSeparator).trim();return this.format(pc(t,r,i,this.options.keySeparator,this.options.ignoreJSONStructure),a,n,{...s,...t,interpolationkey:i})};this.resetRegExp();const c=s?.missingInterpolationHandler||this.options.missingInterpolationHandler,l=s?.interpolation?.skipOnVariables!==0[0]?s.interpolation.skipOnVariables:this.options.interpolation.skipOnVariables,u=[{regex:this.regexpUnescape,safeValue:e=>Zs(e)},{regex:this.regexp,safeValue:e=>Zs(this.escapeValue?this.escape(e):e)}];return u.forEach(t=>{for(a=0;i=t.regex.exec(e);){const n=i[1].trim();if(o=d(n),o===0[0])if(typeof c=="function"){const t=c(e,i,s);o=h(t)?t:""}else if(s&&Object.prototype.hasOwnProperty.call(s,n))o="";else if(l){o=i[0];continue}else this.logger.warn(`missed to pass in variable ${n} for interpolating ${e}`),o="";else!h(o)&&!this.useRawValueToEscape&&(o=bc(o));const r=t.safeValue(o);if(e=e.replace(i[0],r),l?(t.regex.lastIndex+=o.length,t.regex.lastIndex-=i[0].length):t.regex.lastIndex=0,a++,a>=this.maxReplaces)break}}),e}nest(e,t,n={}){let o,i,s;const a=(e,t)=>{const o=this.nestingOptionsSeparator;if(e.indexOf(o)<0)return e;const i=e.split(new RegExp(`${o}[ ]*{`));let n=`{${i[1]}`;e=i[0],n=this.interpolate(n,s);const r=n.match(/'/g),a=n.match(/"/g);((r?.length??0)%2===0&&!a||a.length%2!==0)&&(n=n.replace(/'/g,'"'));try{s=JSON.parse(n),t&&(s={...t,...s})}catch(t){return this.logger.warn(`failed parsing options string in nesting for key ${e}`,t),`${e}${o}${n}`}return s.defaultValue&&s.defaultValue.indexOf(this.prefix)>-1&&delete s.defaultValue,e};for(;o=this.nestingRegexp.exec(e);){let r=[];s={...n},s=s.replace&&!h(s.replace)?s.replace:s,s.applyPostProcessor=!1,delete s.defaultValue;const c=/{.*}/.test(o[1])?o[1].lastIndexOf("}")+1:o[1].indexOf(this.formatSeparator);if(c!==-1&&(r=o[1].slice(c).split(this.formatSeparator).map(e=>e.trim()).filter(Boolean),o[1]=o[1].slice(0,c)),i=t(a.call(this,o[1].trim(),s),s),i&&o[0]===e&&!h(i))return i;h(i)||(i=bc(i)),i||(this.logger.warn(`missed to resolve ${o[1]} for nesting ${e}`),i=""),r.length&&(i=r.reduce((e,t)=>this.format(e,t,n.lng,{...n,interpolationkey:o[1].trim()}),i.trim())),e=e.replace(o[0],i),this.regexp.lastIndex=0}return e}},tl=e=>{let n=e.toLowerCase().trim();const t={};if(e.indexOf("(")>-1){const o=e.split("(");n=o[0].toLowerCase().trim();const s=o[1].substring(0,o[1].length-1);if(n==="currency"&&s.indexOf(":")<0)t.currency||(t.currency=s.trim());else if(n==="relativetime"&&s.indexOf(":")<0)t.range||(t.range=s.trim());else{const e=s.split(";");e.forEach(e=>{if(e){const[o,...i]=e.split(":"),n=i.join(":").trim().replace(/^'+|'+$/g,""),s=o.trim();t[s]||(t[s]=n),n==="false"&&(t[s]=!1),n==="true"&&(t[s]=!0),isNaN(n)||(t[s]=parseInt(n,10))}})}}return{formatName:n,formatOptions:t}},oc=e=>{const t={};return(n,s,o)=>{let a=o;o&&o.interpolationkey&&o.formatParams&&o.formatParams[o.interpolationkey]&&o[o.interpolationkey]&&(a={...a,[o.interpolationkey]:0[0]});const r=s+JSON.stringify(a);let i=t[r];return i||(i=e(En(s),o),t[r]=i),i(n)}},sl=e=>(t,n,s)=>e(En(n),s)(t),ol=class{constructor(e={}){this.logger=me.create("formatter"),this.options=e,this.init(e)}init(e,t={interpolation:{}}){this.formatSeparator=t.interpolation.formatSeparator||",";const n=t.cacheInBuiltFormats?oc:sl;this.formats={number:n((e,t)=>{const n=new Intl.NumberFormat(e,{...t});return e=>n.format(e)}),currency:n((e,t)=>{const n=new Intl.NumberFormat(e,{...t,style:"currency"});return e=>n.format(e)}),datetime:n((e,t)=>{const n=new Intl.DateTimeFormat(e,{...t});return e=>n.format(e)}),relativetime:n((e,t)=>{const n=new Intl.RelativeTimeFormat(e,{...t});return e=>n.format(e,t.range||"day")}),list:n((e,t)=>{const n=new Intl.ListFormat(e,{...t});return e=>n.format(e)})}}add(e,t){this.formats[e.toLowerCase().trim()]=t}addCached(e,t){this.formats[e.toLowerCase().trim()]=oc(t)}format(e,t,n,s={}){const o=t.split(this.formatSeparator);if(o.length>1&&o[0].indexOf("(")>1&&o[0].indexOf(")")<0&&o.find(e=>e.indexOf(")")>-1)){const e=o.findIndex(e=>e.indexOf(")")>-1);o[0]=[o[0],...o.splice(1,e)].join(this.formatSeparator)}const i=o.reduce((e,t)=>{const{formatName:o,formatOptions:i}=tl(t);if(this.formats[o]){let t=e;try{const a=s?.formatParams?.[s.interpolationkey]||{},r=a.locale||a.lng||s.locale||s.lng||n;t=this.formats[o](e,r,{...i,...s,...a})}catch(e){this.logger.warn(e)}return t}return this.logger.warn(`there was no format function for ${o}`),e},e);return i}},il=(e,t)=>{e.pending[t]!==0[0]&&(delete e.pending[t],e.pendingCount--)},al=class extends Bs{constructor(e,t,n,s={}){super(),this.backend=e,this.store=t,this.services=n,this.languageUtils=n.languageUtils,this.options=s,this.logger=me.create("backendConnector"),this.waitingReads=[],this.maxParallelReads=s.maxParallelReads||10,this.readingCalls=0,this.maxRetries=s.maxRetries>=0?s.maxRetries:5,this.retryTimeout=s.retryTimeout>=1?s.retryTimeout:350,this.state={},this.queue=[],this.backend?.init?.(n,s.backend,s)}queueLoad(e,t,n,s){const i={},o={},r={},a={};return e.forEach(e=>{let s=!0;t.forEach(t=>{const r=`${e}|${t}`;!n.reload&&this.store.hasResourceBundle(e,t)?this.state[r]=2:this.state[r]<0||(this.state[r]===1?o[r]===0[0]&&(o[r]=!0):(this.state[r]=1,s=!1,o[r]===0[0]&&(o[r]=!0),i[r]===0[0]&&(i[r]=!0),a[t]===0[0]&&(a[t]=!0)))}),s||(r[e]=!0)}),(Object.keys(i).length||Object.keys(o).length)&&this.queue.push({pending:o,pendingCount:Object.keys(o).length,loaded:{},errors:[],callback:s}),{toLoad:Object.keys(i),pending:Object.keys(o),toLoadLanguages:Object.keys(r),toLoadNamespaces:Object.keys(a)}}loaded(e,t,n){const a=e.split("|"),o=a[0],i=a[1];t&&this.emit("failedLoading",o,i,t),!t&&n&&this.store.addResourceBundle(o,i,n,0[0],0[0],{skipCopy:!0}),this.state[e]=t?-1:2,t&&n&&(this.state[e]=0);const s={};this.queue.forEach(n=>{Gc(n.loaded,[o],i),il(n,e),t&&n.errors.push(t),n.pendingCount===0&&!n.done&&(Object.keys(n.loaded).forEach(e=>{s[e]||(s[e]={});const t=n.loaded[e];t.length&&t.forEach(t=>{s[e][t]===0[0]&&(s[e][t]=!0)})}),n.done=!0,n.errors.length?n.callback(n.errors):n.callback())}),this.emit("loaded",s),this.queue=this.queue.filter(e=>!e.done)}read(e,t,n,s=0,o=this.retryTimeout,i){if(!e.length)return i(null,{});if(this.readingCalls>=this.maxParallelReads){this.waitingReads.push({lng:e,ns:t,fcName:n,tried:s,wait:o,callback:i});return}this.readingCalls++;const a=(a,r)=>{if(this.readingCalls--,this.waitingReads.length>0){const e=this.waitingReads.shift();this.read(e.lng,e.ns,e.fcName,e.tried,e.wait,e.callback)}if(a&&r&&s<this.maxRetries){setTimeout(()=>{this.read.call(this,e,t,n,s+1,o*2,i)},o);return}i(a,r)},r=this.backend[n].bind(this.backend);if(r.length===2){try{const n=r(e,t);n&&typeof n.then=="function"?n.then(e=>a(null,e)).catch(a):a(null,n)}catch(e){a(e)}return}return r(e,t,a)}prepareLoading(e,t,n={},s){if(!this.backend)return this.logger.warn("No backend was added via i18next.use. Will not load resources."),s&&s();h(e)&&(e=this.languageUtils.toResolveHierarchy(e)),h(t)&&(t=[t]);const o=this.queueLoad(e,t,n,s);if(!o.toLoad.length)return o.pending.length||s(),null;o.toLoad.forEach(e=>{this.loadOne(e)})}load(e,t,n){this.prepareLoading(e,t,{},n)}reload(e,t,n){this.prepareLoading(e,t,{reload:!0},n)}loadOne(e,t=""){const o=e.split("|"),n=o[0],s=o[1];this.read(n,s,"read",0[0],0[0],(o,i)=>{o&&this.logger.warn(`${t}loading namespace ${s} for language ${n} failed`,o),!o&&i&&this.logger.log(`${t}loaded namespace ${s} for language ${n}`,i),this.loaded(e,o,i)})}saveMissing(e,t,n,s,o,i={},a=()=>{}){if(this.services?.utils?.hasLoadedNamespace&&!this.services?.utils?.hasLoadedNamespace(t)){this.logger.warn(`did not save key "${n}" as the namespace "${t}" was not yet loaded`,"This means something IS WRONG in your setup. You access the t function before i18next.init / i18next.loadNamespace / i18next.changeLanguage was done. Wait for the callback or Promise to resolve before accessing it!!!");return}if(n==null||n==="")return;if(this.backend?.create){const c={...i,isUpdate:o},r=this.backend.create.bind(this.backend);if(r.length<6)try{let o;r.length===5?o=r(e,t,n,s,c):o=r(e,t,n,s),o&&typeof o.then=="function"?o.then(e=>a(null,e)).catch(a):a(null,o)}catch(e){a(e)}else r(e,t,n,s,a,c)}if(!e||!e[0])return;this.store.addResource(e[0],t,n,s)}},ec=()=>({debug:!1,initAsync:!0,ns:["translation"],defaultNS:["translation"],fallbackLng:["dev"],fallbackNS:!1,supportedLngs:!1,nonExplicitSupportedLngs:!1,load:"all",preload:!1,simplifyPluralSuffix:!0,keySeparator:".",nsSeparator:":",pluralSeparator:"_",contextSeparator:"_",partialBundledLanguages:!1,saveMissing:!1,updateMissing:!1,saveMissingTo:"fallback",saveMissingPlurals:!0,missingKeyHandler:!1,missingInterpolationHandler:!1,postProcess:!1,postProcessPassResolved:!1,returnNull:!1,returnEmptyString:!0,returnObjects:!1,joinArrays:!1,returnedObjectHandler:!1,parseMissingKeyHandler:!1,appendNamespaceToMissingKey:!1,appendNamespaceToCIMode:!1,overloadTranslationOptionHandler:e=>{let t={};if(typeof e[1]=="object"&&(t=e[1]),h(e[1])&&(t.defaultValue=e[1]),h(e[2])&&(t.tDescription=e[2]),typeof e[2]=="object"||typeof e[3]=="object"){const n=e[3]||e[2];Object.keys(n).forEach(e=>{t[e]=n[e]})}return t},interpolation:{escapeValue:!0,format:e=>e,prefix:"{{",suffix:"}}",formatSeparator:",",unescapePrefix:"-",nestingPrefix:"$t(",nestingSuffix:")",nestingOptionsSeparator:",",maxReplaces:1e3,skipOnVariables:!0},cacheInBuiltFormats:!0}),Qr=e=>(h(e.ns)&&(e.ns=[e.ns]),h(e.fallbackLng)&&(e.fallbackLng=[e.fallbackLng]),h(e.fallbackNS)&&(e.fallbackNS=[e.fallbackNS]),e.supportedLngs?.indexOf?.("cimode")<0&&(e.supportedLngs=e.supportedLngs.concat(["cimode"])),typeof e.initImmediate=="boolean"&&(e.initAsync=e.initImmediate),e),Ds=()=>{},dl=e=>{const t=Object.getOwnPropertyNames(Object.getPrototypeOf(e));t.forEach(t=>{typeof e[t]=="function"&&(e[t]=e[t].bind(e))})},Gr=class _I18n extends Bs{constructor(e={},t){if(super(),this.options=Qr(e),this.services={},this.logger=me,this.modules={external:[]},dl(this),t&&!this.isInitialized&&!e.isClone){if(!this.options.initAsync)return this.init(e,t),this;setTimeout(()=>{this.init(e,t)},0)}}init(e={},t){this.isInitializing=!0,typeof e=="function"&&(t=e,e={}),e.defaultNS==null&&e.ns&&(h(e.ns)?e.defaultNS=e.ns:e.ns.indexOf("translation")<0&&(e.defaultNS=e.ns[0]));const s=ec();this.options={...s,...this.options,...Qr(e)},this.options.interpolation={...s.interpolation,...this.options.interpolation},e.keySeparator!==0[0]&&(this.options.userDefinedKeySeparator=e.keySeparator),e.nsSeparator!==0[0]&&(this.options.userDefinedNsSeparator=e.nsSeparator);const n=e=>e?typeof e=="function"?new e:e:null;if(!this.options.isClone){this.modules.logger?me.init(n(this.modules.logger),this.options):me.init(null,this.options);let t;this.modules.formatter?t=this.modules.formatter:t=ol;const o=new Cc(this.options);this.store=new Nc(this.options.resources,this.options);const e=this.services;e.logger=me,e.resourceStore=this.store,e.languageUtils=o,e.pluralResolver=new Zc(o,{prepend:this.options.pluralSeparator,simplifyPluralSuffix:this.options.simplifyPluralSuffix});const i=this.options.interpolation.format&&this.options.interpolation.format!==s.interpolation.format;i&&this.logger.deprecate(`init: you are still using the legacy format function, please use the new approach: https://www.i18next.com/translation-function/formatting`),t&&(!this.options.interpolation.format||this.options.interpolation.format===s.interpolation.format)&&(e.formatter=n(t),e.formatter.init&&e.formatter.init(e,this.options),this.options.interpolation.format=e.formatter.format.bind(e.formatter)),e.interpolator=new el(this.options),e.utils={hasLoadedNamespace:this.hasLoadedNamespace.bind(this)},e.backendConnector=new al(n(this.modules.backend),e.resourceStore,e,this.options),e.backendConnector.on("*",(e,...t)=>{this.emit(e,...t)}),this.modules.languageDetector&&(e.languageDetector=n(this.modules.languageDetector),e.languageDetector.init&&e.languageDetector.init(e,this.options.detection,this.options)),this.modules.i18nFormat&&(e.i18nFormat=n(this.modules.i18nFormat),e.i18nFormat.init&&e.i18nFormat.init(this)),this.translator=new kc(this.services,this.options),this.translator.on("*",(e,...t)=>{this.emit(e,...t)}),this.modules.external.forEach(e=>{e.init&&e.init(this)})}if(this.format=this.options.interpolation.format,t||(t=Ds),this.options.fallbackLng&&!this.services.languageDetector&&!this.options.lng){const e=this.services.languageUtils.getFallbackCodes(this.options.fallbackLng);e.length>0&&e[0]!=="dev"&&(this.options.lng=e[0])}!this.services.languageDetector&&!this.options.lng&&this.logger.warn("init: no languageDetector is used and no lng is defined");const a=["getResource","hasResourceBundle","getResourceBundle","getDataByLanguage"];a.forEach(e=>{this[e]=(...t)=>this.store[e](...t)});const r=["addResource","addResources","addResourceBundle","removeResourceBundle"];r.forEach(e=>{this[e]=(...t)=>(this.store[e](...t),this)});const o=cn(),i=()=>{const e=(e,n)=>{this.isInitializing=!1,this.isInitialized&&!this.initializedStoreOnce&&this.logger.warn("init: i18next is already initialized. You should call init just once!"),this.isInitialized=!0,this.options.isClone||this.logger.log("initialized",this.options),this.emit("initialized",this.options),o.resolve(n),t(e,n)};if(this.languages&&!this.isInitialized)return e(null,this.t.bind(this));this.changeLanguage(this.options.lng,e)};return this.options.resources||!this.options.initAsync?i():setTimeout(i,0),o}loadResources(e,t=Ds){let n=t;const s=h(e)?e:this.language;if(typeof e=="function"&&(n=e),!this.options.resources||this.options.partialBundledLanguages){if(s?.toLowerCase()==="cimode"&&(!this.options.preload||this.options.preload.length===0))return n();const e=[],t=t=>{if(!t)return;if(t==="cimode")return;const n=this.services.languageUtils.toResolveHierarchy(t);n.forEach(t=>{if(t==="cimode")return;e.indexOf(t)<0&&e.push(t)})};if(s)t(s);else{const e=this.services.languageUtils.getFallbackCodes(this.options.fallbackLng);e.forEach(e=>t(e))}this.options.preload?.forEach?.(e=>t(e)),this.services.backendConnector.load(e,this.options.ns,e=>{!e&&!this.resolvedLanguage&&this.language&&this.setResolvedLanguage(this.language),n(e)})}else n(null)}reloadResources(e,t,n){const s=cn();return typeof e=="function"&&(n=e,e=0[0]),typeof t=="function"&&(n=t,t=0[0]),e||(e=this.languages),t||(t=this.options.ns),n||(n=Ds),this.services.backendConnector.reload(e,t,e=>{s.resolve(),n(e)}),s}use(e){if(!e)throw new Error("You are passing an undefined module! Please check the object you are passing to i18next.use()");if(!e.type)throw new Error("You are passing a wrong module! Please check the object you are passing to i18next.use()");return e.type==="backend"&&(this.modules.backend=e),(e.type==="logger"||e.log&&e.warn&&e.error)&&(this.modules.logger=e),e.type==="languageDetector"&&(this.modules.languageDetector=e),e.type==="i18nFormat"&&(this.modules.i18nFormat=e),e.type==="postProcessor"&&Dc.addPostProcessor(e),e.type==="formatter"&&(this.modules.formatter=e),e.type==="3rdParty"&&this.modules.external.push(e),this}setResolvedLanguage(e){if(!e||!this.languages)return;if(["cimode","dev"].indexOf(e)>-1)return;for(let e=0;e<this.languages.length;e++){const t=this.languages[e];if(["cimode","dev"].indexOf(t)>-1)continue;if(this.store.hasLanguageSomeTranslations(t)){this.resolvedLanguage=t;break}}!this.resolvedLanguage&&this.languages.indexOf(e)<0&&this.store.hasLanguageSomeTranslations(e)&&(this.resolvedLanguage=e,this.languages.unshift(e))}changeLanguage(e,t){this.isLanguageChangingTo=e;const s=cn();this.emit("languageChanging",e);const o=e=>{this.language=e,this.languages=this.services.languageUtils.toResolveHierarchy(e),this.resolvedLanguage=0[0],this.setResolvedLanguage(e)},i=(n,i)=>{i?this.isLanguageChangingTo===e&&(o(i),this.translator.changeLanguage(i),this.isLanguageChangingTo=0[0],this.emit("languageChanged",i),this.logger.log("languageChanged",i)):this.isLanguageChangingTo=0[0],s.resolve((...e)=>this.t(...e)),t&&t(n,(...e)=>this.t(...e))},n=t=>{!e&&!t&&this.services.languageDetector&&(t=[]);const s=h(t)?t:t&&t[0],n=this.store.hasLanguageSomeTranslations(s)?s:this.services.languageUtils.getBestMatchFromCodes(h(t)?[t]:t);n&&(this.language||o(n),this.translator.language||this.translator.changeLanguage(n),this.services.languageDetector?.cacheUserLanguage?.(n)),this.loadResources(n,e=>{i(e,n)})};return!e&&this.services.languageDetector&&!this.services.languageDetector.async?n(this.services.languageDetector.detect()):!e&&this.services.languageDetector&&this.services.languageDetector.async?this.services.languageDetector.detect.length===0?this.services.languageDetector.detect().then(n):this.services.languageDetector.detect(n):n(e),s}getFixedT(e,t,n){const s=(e,t,...o)=>{let i;typeof t!="object"?i=this.options.overloadTranslationOptionHandler([e,t].concat(o)):i={...t},i.lng=i.lng||s.lng,i.lngs=i.lngs||s.lngs,i.ns=i.ns||s.ns,i.keyPrefix!==""&&(i.keyPrefix=i.keyPrefix||n||s.keyPrefix);const r=this.options.keySeparator||".";let a;return i.keyPrefix&&Array.isArray(e)?a=e.map(e=>(typeof e=="function"&&(e=Tc(e,{...this.options,...t})),`${i.keyPrefix}${r}${e}`)):(typeof e=="function"&&(e=Tc(e,{...this.options,...t})),a=i.keyPrefix?`${i.keyPrefix}${r}${e}`:e),this.t(a,i)};return h(e)?s.lng=e:s.lngs=e,s.ns=t,s.keyPrefix=n,s}t(...e){return this.translator?.translate(...e)}exists(...e){return this.translator?.exists(...e)}setDefaultNamespace(e){this.options.defaultNS=e}hasLoadedNamespace(e,t={}){if(!this.isInitialized)return this.logger.warn("hasLoadedNamespace: i18next was not initialized",this.languages),!1;if(!this.languages||!this.languages.length)return this.logger.warn("hasLoadedNamespace: i18n.languages were undefined or empty",this.languages),!1;const n=t.lng||this.resolvedLanguage||this.languages[0],o=!!this.options&&this.options.fallbackLng,i=this.languages[this.languages.length-1];if(n.toLowerCase()==="cimode")return!0;const s=(e,t)=>{const n=this.services.backendConnector.state[`${e}|${t}`];return n===-1||n===0||n===2};if(t.precheck){const e=t.precheck(this,s);if(e!==0[0])return e}return!!this.hasResourceBundle(n,e)||!!(!this.services.backendConnector.backend||this.options.resources&&!this.options.partialBundledLanguages)||!!(s(n,e)&&(!o||s(i,e)))}loadNamespaces(e,t){const n=cn();return this.options.ns?(h(e)&&(e=[e]),e.forEach(e=>{this.options.ns.indexOf(e)<0&&this.options.ns.push(e)}),this.loadResources(e=>{n.resolve(),t&&t(e)}),n):(t&&t(),Promise.resolve())}loadLanguages(e,t){const n=cn();h(e)&&(e=[e]);const s=this.options.preload||[],o=e.filter(e=>s.indexOf(e)<0&&this.services.languageUtils.isSupportedCode(e));return o.length?(this.options.preload=s.concat(o),this.loadResources(e=>{n.resolve(),t&&t(e)}),n):(t&&t(),Promise.resolve())}dir(e){if(e||(e=this.resolvedLanguage||(this.languages?.length>0?this.languages[0]:this.language)),!e)return"rtl";try{const t=new Intl.Locale(e);if(t&&t.getTextInfo){const e=t.getTextInfo();if(e&&e.direction)return e.direction}}catch{}const t=["ar","shu","sqr","ssh","xaa","yhd","yud","aao","abh","abv","acm","acq","acw","acx","acy","adf","ads","aeb","aec","afb","ajp","apc","apd","arb","arq","ars","ary","arz","auz","avl","ayh","ayl","ayn","ayp","bbz","pga","he","iw","ps","pbt","pbu","pst","prp","prd","ug","ur","ydd","yds","yih","ji","yi","hbo","men","xmn","fa","jpr","peo","pes","prs","dv","sam","ckb"],n=this.services?.languageUtils||new Cc(ec());return e.toLowerCase().indexOf("-latn")>1?"ltr":t.indexOf(n.getLanguagePartFromCode(e))>-1||e.toLowerCase().indexOf("-arab")>1?"rtl":"ltr"}static createInstance(e={},t){return new _I18n(e,t)}cloneInstance(e={},t=Ds){const o=e.forkResourceStore;o&&delete e.forkResourceStore;const s={...this.options,...e,...{isClone:!0}},n=new _I18n(s);(e.debug!==0[0]||e.prefix!==0[0])&&(n.logger=n.logger.clone(e));const i=["store","services","language"];if(i.forEach(e=>{n[e]=this[e]}),n.services={...this.services},n.services.utils={hasLoadedNamespace:n.hasLoadedNamespace.bind(n)},o){const e=Object.keys(this.store.data).reduce((e,t)=>(e[t]={...this.store.data[t]},e[t]=Object.keys(e[t]).reduce((n,s)=>(n[s]={...e[t][s]},n),e[t]),e),{});n.store=new Nc(e,s),n.services.resourceStore=n.store}return n.translator=new kc(n.services,s),n.translator.on("*",(e,...t)=>{n.emit(e,...t)}),n.init(s,t),n.translator.options=s,n.translator.backendConnector.services.utils={hasLoadedNamespace:n.hasLoadedNamespace.bind(n)},n}toJSON(){return{options:this.options,store:this.store,language:this.language,languages:this.languages,resolvedLanguage:this.resolvedLanguage}}},g=Gr.createInstance(),g.createInstance=Gr.createInstance,b2=g.createInstance,v2=g.dir,g2=g.init,p2=g.loadResources,f2=g.reloadResources,m2=g.use,h2=g.changeLanguage,u2=g.getFixedT,d2=g.t,l2=g.exists,c2=g.setDefaultNamespace,r2=g.hasLoadedNamespace,a2=g.loadNamespaces,i2=g.loadLanguages,t={},xl(t,{BRAND:()=>hu,DIRTY:()=>nt,EMPTY_PATH:()=>$l,INVALID:()=>d,NEVER:()=>i1,OK:()=>z,ParseStatus:()=>L,Schema:()=>p,ZodAny:()=>st,ZodArray:()=>Ge,ZodBigInt:()=>qt,ZodBoolean:()=>Gt,ZodBranded:()=>pi,ZodCatch:()=>Lt,ZodDate:()=>en,ZodDefault:()=>Pt,ZodDiscriminatedUnion:()=>sa,ZodEffects:()=>Q,ZodEnum:()=>Fn,ZodError:()=>oe,ZodFirstPartyTypeKind:()=>u,ZodFunction:()=>Vi,ZodIntersection:()=>Cn,ZodIssueCode:()=>i,ZodLazy:()=>Dn,ZodLiteral:()=>Tn,ZodMap:()=>Ln,ZodNaN:()=>Zn,ZodNativeEnum:()=>un,ZodNever:()=>Oe,ZodNull:()=>an,ZodNullable:()=>Me,ZodNumber:()=>$t,ZodObject:()=>X,ZodOptional:()=>pe,ZodParsedType:()=>r,ZodPipeline:()=>fi,ZodPromise:()=>it,ZodReadonly:()=>Tt,ZodRecord:()=>Ki,ZodSchema:()=>p,ZodSet:()=>Rn,ZodString:()=>yt,ZodSymbol:()=>Kn,ZodTransformer:()=>Q,ZodTuple:()=>ke,ZodType:()=>p,ZodUndefined:()=>on,ZodUnion:()=>wn,ZodUnknown:()=>He,ZodVoid:()=>Vn,addIssueToContext:()=>a,any:()=>Mu,array:()=>Du,bigint:()=>xu,boolean:()=>Xi,coerce:()=>o1,custom:()=>vu,date:()=>Eu,datetimeRegex:()=>xd,defaultErrorMap:()=>Qe,discriminatedUnion:()=>Pu,effect:()=>la,enum:()=>qu,function:()=>Wu,getErrorMap:()=>go,getParsedType:()=>be,instanceof:()=>yu,intersection:()=>Hu,isAborted:()=>xo,isAsync:()=>Ut,isDirty:()=>Co,isValid:()=>We,late:()=>bu,lazy:()=>Uu,literal:()=>Ku,makeIssue:()=>vs,map:()=>Vu,nan:()=>Ou,nativeEnum:()=>Yu,never:()=>Tu,null:()=>Su,nullable:()=>Zu,number:()=>Yi,object:()=>Nu,objectUtil:()=>Ur,oboolean:()=>s1,onumber:()=>Ic,optional:()=>Qu,ostring:()=>t1,pipeline:()=>e1,preprocess:()=>Ju,promise:()=>Gu,quotelessJson:()=>zl,record:()=>Bu,set:()=>$u,setErrorMap:()=>o2,strictObject:()=>Lu,string:()=>Bi,symbol:()=>ku,transformer:()=>la,tuple:()=>Iu,undefined:()=>Au,union:()=>Ru,unknown:()=>Fu,util:()=>v,void:()=>zu}),function(e){e.assertEqual=e=>{};function t(){}e.assertIs=t;function n(){throw new Error}e.assertNever=n,e.arrayToEnum=e=>{const t={};for(const n of e)t[n]=n;return t},e.getValidEnumValues=t=>{const s=e.objectKeys(t).filter(e=>typeof t[t[e]]!="number"),n={};for(const e of s)n[e]=t[e];return e.objectValues(n)},e.objectValues=t=>e.objectKeys(t).map(function(e){return t[e]}),e.objectKeys=typeof Object.keys=="function"?e=>Object.keys(e):e=>{const t=[];for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t},e.find=(e,t)=>{for(const n of e)if(t(n))return n},e.isInteger=typeof Number.isInteger=="function"?e=>Number.isInteger(e):e=>typeof e=="number"&&Number.isFinite(e)&&Math.floor(e)===e;function s(e,t=" | "){return e.map(e=>typeof e=="string"?`'${e}'`:e).join(t)}e.joinValues=s,e.jsonStringifyReplacer=(e,t)=>typeof t=="bigint"?t.toString():t}(v||(v={})),function(e){e.mergeShapes=(e,t)=>({...e,...t})}(Ur||(Ur={})),r=v.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),be=e=>{const t=typeof e;switch(t){case"undefined":return r.undefined;case"string":return r.string;case"number":return Number.isNaN(e)?r.nan:r.number;case"boolean":return r.boolean;case"function":return r.function;case"bigint":return r.bigint;case"symbol":return r.symbol;case"object":return Array.isArray(e)?r.array:e===null?r.null:e.then&&typeof e.then=="function"&&e.catch&&typeof e.catch=="function"?r.promise:typeof Map!="undefined"&&e instanceof Map?r.map:typeof Set!="undefined"&&e instanceof Set?r.set:typeof Date!="undefined"&&e instanceof Date?r.date:r.object;default:return r.unknown}},i=v.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),zl=e=>{const t=JSON.stringify(e,null,2);return t.replace(/"([^"]+)":/g,"$1:")},oe=class _ZodError extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const s=e||function(e){return e.message},n={_errors:[]},t=e=>{for(const o of e.issues)if(o.code==="invalid_union")o.unionErrors.map(t);else if(o.code==="invalid_return_type")t(o.returnTypeError);else if(o.code==="invalid_arguments")t(o.argumentsError);else if(o.path.length===0)n._errors.push(s(o));else{let e=n,t=0;for(;t<o.path.length;){const n=o.path[t],i=t===o.path.length-1;i?(e[n]=e[n]||{_errors:[]},e[n]._errors.push(s(o))):e[n]=e[n]||{_errors:[]},e=e[n],t++}}};return t(this),n}static assert(e){if(!(e instanceof _ZodError))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,v.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=e=>e.message){const t={},n=[];for(const s of this.issues)if(s.path.length>0){const n=s.path[0];t[n]=t[n]||[],t[n].push(e(s))}else n.push(e(s));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}},oe.create=e=>{const t=new oe(e);return t},Nl=(e,t)=>{let n;switch(e.code){case i.invalid_type:e.received===r.undefined?n="Required":n=`Expected ${e.expected}, received ${e.received}`;break;case i.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(e.expected,v.jsonStringifyReplacer)}`;break;case i.unrecognized_keys:n=`Unrecognized key(s) in object: ${v.joinValues(e.keys,", ")}`;break;case i.invalid_union:n=`Invalid input`;break;case i.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${v.joinValues(e.options)}`;break;case i.invalid_enum_value:n=`Invalid enum value. Expected ${v.joinValues(e.options)}, received '${e.received}'`;break;case i.invalid_arguments:n=`Invalid function arguments`;break;case i.invalid_return_type:n=`Invalid function return type`;break;case i.invalid_date:n=`Invalid date`;break;case i.invalid_string:typeof e.validation=="object"?"includes"in e.validation?(n=`Invalid input: must include "${e.validation.includes}"`,typeof e.validation.position=="number"&&(n=`${n} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?n=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?n=`Invalid input: must end with "${e.validation.endsWith}"`:v.assertNever(e.validation):e.validation!=="regex"?n=`Invalid ${e.validation}`:n="Invalid";break;case i.too_small:e.type==="array"?n=`Array must contain ${e.exact?"exactly":e.inclusive?`at least`:`more than`} ${e.minimum} element(s)`:e.type==="string"?n=`String must contain ${e.exact?"exactly":e.inclusive?`at least`:`over`} ${e.minimum} character(s)`:e.type==="number"?n=`Number must be ${e.exact?`exactly equal to `:e.inclusive?`greater than or equal to `:`greater than `}${e.minimum}`:e.type==="bigint"?n=`Number must be ${e.exact?`exactly equal to `:e.inclusive?`greater than or equal to `:`greater than `}${e.minimum}`:e.type==="date"?n=`Date must be ${e.exact?`exactly equal to `:e.inclusive?`greater than or equal to `:`greater than `}${new Date(Number(e.minimum))}`:n="Invalid input";break;case i.too_big:e.type==="array"?n=`Array must contain ${e.exact?`exactly`:e.inclusive?`at most`:`less than`} ${e.maximum} element(s)`:e.type==="string"?n=`String must contain ${e.exact?`exactly`:e.inclusive?`at most`:`under`} ${e.maximum} character(s)`:e.type==="number"?n=`Number must be ${e.exact?`exactly`:e.inclusive?`less than or equal to`:`less than`} ${e.maximum}`:e.type==="bigint"?n=`BigInt must be ${e.exact?`exactly`:e.inclusive?`less than or equal to`:`less than`} ${e.maximum}`:e.type==="date"?n=`Date must be ${e.exact?`exactly`:e.inclusive?`smaller than or equal to`:`smaller than`} ${new Date(Number(e.maximum))}`:n="Invalid input";break;case i.custom:n=`Invalid input`;break;case i.invalid_intersection_types:n=`Intersection results could not be merged`;break;case i.not_multiple_of:n=`Number must be a multiple of ${e.multipleOf}`;break;case i.not_finite:n="Number must be finite";break;default:n=t.defaultError,v.assertNever(e)}return{message:n}},Qe=Nl,Fr=Qe;function o2(e){Fr=e}function go(){return Fr}vs=e=>{const{data:o,path:i,errorMaps:a,issueData:t}=e,n=[...i,...t.path||[]],r={...t,path:n};if(t.message!==0[0])return{...t,path:n,message:t.message};let s="";const c=a.filter(e=>!!e).slice().reverse();for(const e of c)s=e(r,{data:o,defaultError:s}).message;return{...t,path:n,message:s}},$l=[];function a(e,t){const n=go(),s=vs({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,n,n===Qe?0[0]:Qe].filter(e=>!!e)});e.common.issues.push(s)}L=class _ParseStatus{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const s of t){if(s.status==="aborted")return d;s.status==="dirty"&&e.dirty(),n.push(s.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const e of t){const s=await e.key,o=await e.value;n.push({key:s,value:o})}return _ParseStatus.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const i of t){const{key:s,value:o}=i;if(s.status==="aborted")return d;if(o.status==="aborted")return d;s.status==="dirty"&&e.dirty(),o.status==="dirty"&&e.dirty(),s.value!=="__proto__"&&(typeof o.value!="undefined"||i.alwaysSet)&&(n[s.value]=o.value)}return{status:e.value,value:n}}},d=Object.freeze({status:"aborted"}),nt=e=>({status:"dirty",value:e}),z=e=>({status:"valid",value:e}),xo=e=>e.status==="aborted",Co=e=>e.status==="dirty",We=e=>e.status==="valid",Ut=e=>typeof Promise!="undefined"&&e instanceof Promise,function(e){e.errToObj=e=>typeof e=="string"?{message:e}:e||{},e.toString=e=>typeof e=="string"?e:e?.message}(l||(l={})),ce=class{constructor(e,t,n,s){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=s}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}},Wa=(e,t)=>{if(We(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new oe(e.common.issues);return this._error=t,this._error}}};function f(e){if(!e)return{};const{errorMap:t,invalid_type_error:n,required_error:s,description:o}=e;if(t&&(n||s))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);if(t)return{errorMap:t,description:o};const i=(t,o)=>{const{message:i}=e;return t.code==="invalid_enum_value"?{message:i??o.defaultError}:typeof o.data=="undefined"?{message:i??s??o.defaultError}:t.code!=="invalid_type"?{message:o.defaultError}:{message:i??n??o.defaultError}};return{errorMap:i,description:o}}p=class{get description(){return this._def.description}_getType(e){return be(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:be(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new L,ctx:{common:e.parent.common,data:e.data,parsedType:be(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(Ut(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){const n={common:{issues:[],async:t?.async??!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:be(e)},s=this._parseSync({data:e,path:n.path,parent:n});return Wa(n,s)}"~validate"(e){const t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:be(e)};if(!this["~standard"].async)try{const n=this._parseSync({data:e,path:[],parent:t});return We(n)?{value:n.value}:{issues:t.common.issues}}catch(e){e?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(e=>We(e)?{value:e.value}:{issues:t.common.issues})}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:be(e)},s=this._parse({data:e,path:n.path,parent:n}),o=await(Ut(s)?s:Promise.resolve(s));return Wa(n,o)}refine(e,t){const n=e=>typeof t=="string"||typeof t=="undefined"?{message:t}:typeof t=="function"?t(e):t;return this._refinement((t,s)=>{const o=e(t),a=()=>s.addIssue({code:i.custom,...n(t)});return typeof Promise!="undefined"&&o instanceof Promise?o.then(e=>!!e||(a(),!1)):!!o||(a(),!1)})}refinement(e,t){return this._refinement((n,s)=>!!e(n)||(s.addIssue(typeof t=="function"?t(n,s):t),!1))}_refinement(e){return new Q({schema:this,typeName:u.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:e=>this["~validate"](e)}}optional(){return pe.create(this,this._def)}nullable(){return Me.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Ge.create(this)}promise(){return it.create(this,this._def)}or(e){return wn.create([this,e],this._def)}and(e){return Cn.create(this,e,this._def)}transform(e){return new Q({...f(this._def),schema:this,typeName:u.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new Pt({...f(this._def),innerType:this,defaultValue:t,typeName:u.ZodDefault})}brand(){return new pi({typeName:u.ZodBranded,type:this,...f(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new Lt({...f(this._def),innerType:this,catchValue:t,typeName:u.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return fi.create(this,e)}readonly(){return Tt.create(this)}isOptional(){return this.safeParse(0[0]).success}isNullable(){return this.safeParse(null).success}},od=/^c[^\s-]{8,}$/i,id=/^[0-9a-z]+$/,ad=/^[0-9A-HJKMNP-TV-Z]{26}$/i,rd=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,cd=/^[a-z0-9_-]{21}$/i,ld=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,dd=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,ud=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9-]*\.)+[A-Z]{2,}$/i,hd=`^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$`,fd=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,pd=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,gd=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,vd=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,bd=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,jd=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,La=`((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))`,_d=new RegExp(`^${La}$`);function wd(e){let t=`[0-5]\\d`;e.precision?t=`${t}\\.\\d{${e.precision}}`:e.precision==null&&(t=`${t}(\\.\\d+)?`);const n=e.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${t})${n}`}function Q0(e){return new RegExp(`^${wd(e)}$`)}function xd(e){let t=`${La}T${wd(e)}`;const n=[];return n.push(e.local?`Z?`:`Z`),e.offset&&n.push(`([+-]\\d{2}:?\\d{2})`),t=`${t}(${n.join("|")})`,new RegExp(`^${t}$`)}function X0(e,t){return!(t!=="v4"&&!!t||!fd.test(e))||!(t!=="v6"&&!!t||!gd.test(e))}function G0(e,t){if(!ld.test(e))return!1;try{const[s]=e.split(".");if(!s)return!1;const o=s.replace(/-/g,"+").replace(/_/g,"/").padEnd(s.length+(4-s.length%4)%4,"="),n=JSON.parse(atob(o));return typeof n=="object"&&n!==null&&!("typ"in n&&n?.typ!=="JWT")&&!!n.alg&&(!t||n.alg===t)}catch{return!1}}function Y0(e,t){return!(t!=="v4"&&!!t||!pd.test(e))||!(t!=="v6"&&!!t||!vd.test(e))}yt=class _ZodString extends p{_parse(e){this._def.coerce&&(e.data=String(e.data));const s=this._getType(e);if(s!==r.string){const t=this._getOrReturnCtx(e);return a(t,{code:i.invalid_type,expected:r.string,received:t.parsedType}),d}const n=new L;let t=0[0];for(const s of this._def.checks)if(s.kind==="min")e.data.length<s.value&&(t=this._getOrReturnCtx(e,t),a(t,{code:i.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),n.dirty());else if(s.kind==="max")e.data.length>s.value&&(t=this._getOrReturnCtx(e,t),a(t,{code:i.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),n.dirty());else if(s.kind==="length"){const o=e.data.length>s.value,r=e.data.length<s.value;(o||r)&&(t=this._getOrReturnCtx(e,t),o?a(t,{code:i.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):r&&a(t,{code:i.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),n.dirty())}else if(s.kind==="email")ud.test(e.data)||(t=this._getOrReturnCtx(e,t),a(t,{validation:"email",code:i.invalid_string,message:s.message}),n.dirty());else if(s.kind==="emoji")Ra||(Ra=new RegExp(hd,"u")),Ra.test(e.data)||(t=this._getOrReturnCtx(e,t),a(t,{validation:"emoji",code:i.invalid_string,message:s.message}),n.dirty());else if(s.kind==="uuid")rd.test(e.data)||(t=this._getOrReturnCtx(e,t),a(t,{validation:"uuid",code:i.invalid_string,message:s.message}),n.dirty());else if(s.kind==="nanoid")cd.test(e.data)||(t=this._getOrReturnCtx(e,t),a(t,{validation:"nanoid",code:i.invalid_string,message:s.message}),n.dirty());else if(s.kind==="cuid")od.test(e.data)||(t=this._getOrReturnCtx(e,t),a(t,{validation:"cuid",code:i.invalid_string,message:s.message}),n.dirty());else if(s.kind==="cuid2")id.test(e.data)||(t=this._getOrReturnCtx(e,t),a(t,{validation:"cuid2",code:i.invalid_string,message:s.message}),n.dirty());else if(s.kind==="ulid")ad.test(e.data)||(t=this._getOrReturnCtx(e,t),a(t,{validation:"ulid",code:i.invalid_string,message:s.message}),n.dirty());else if(s.kind==="url")try{new URL(e.data)}catch{t=this._getOrReturnCtx(e,t),a(t,{validation:"url",code:i.invalid_string,message:s.message}),n.dirty()}else if(s.kind==="regex"){s.regex.lastIndex=0;const o=s.regex.test(e.data);o||(t=this._getOrReturnCtx(e,t),a(t,{validation:"regex",code:i.invalid_string,message:s.message}),n.dirty())}else if(s.kind==="trim")e.data=e.data.trim();else if(s.kind==="includes")e.data.includes(s.value,s.position)||(t=this._getOrReturnCtx(e,t),a(t,{code:i.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),n.dirty());else if(s.kind==="toLowerCase")e.data=e.data.toLowerCase();else if(s.kind==="toUpperCase")e.data=e.data.toUpperCase();else if(s.kind==="startsWith")e.data.startsWith(s.value)||(t=this._getOrReturnCtx(e,t),a(t,{code:i.invalid_string,validation:{startsWith:s.value},message:s.message}),n.dirty());else if(s.kind==="endsWith")e.data.endsWith(s.value)||(t=this._getOrReturnCtx(e,t),a(t,{code:i.invalid_string,validation:{endsWith:s.value},message:s.message}),n.dirty());else if(s.kind==="datetime"){const o=xd(s);o.test(e.data)||(t=this._getOrReturnCtx(e,t),a(t,{code:i.invalid_string,validation:"datetime",message:s.message}),n.dirty())}else if(s.kind==="date"){const o=_d;o.test(e.data)||(t=this._getOrReturnCtx(e,t),a(t,{code:i.invalid_string,validation:"date",message:s.message}),n.dirty())}else if(s.kind==="time"){const o=Q0(s);o.test(e.data)||(t=this._getOrReturnCtx(e,t),a(t,{code:i.invalid_string,validation:"time",message:s.message}),n.dirty())}else s.kind==="duration"?dd.test(e.data)||(t=this._getOrReturnCtx(e,t),a(t,{validation:"duration",code:i.invalid_string,message:s.message}),n.dirty()):s.kind==="ip"?X0(e.data,s.version)||(t=this._getOrReturnCtx(e,t),a(t,{validation:"ip",code:i.invalid_string,message:s.message}),n.dirty()):s.kind==="jwt"?G0(e.data,s.alg)||(t=this._getOrReturnCtx(e,t),a(t,{validation:"jwt",code:i.invalid_string,message:s.message}),n.dirty()):s.kind==="cidr"?Y0(e.data,s.version)||(t=this._getOrReturnCtx(e,t),a(t,{validation:"cidr",code:i.invalid_string,message:s.message}),n.dirty()):s.kind==="base64"?bd.test(e.data)||(t=this._getOrReturnCtx(e,t),a(t,{validation:"base64",code:i.invalid_string,message:s.message}),n.dirty()):s.kind==="base64url"?jd.test(e.data)||(t=this._getOrReturnCtx(e,t),a(t,{validation:"base64url",code:i.invalid_string,message:s.message}),n.dirty()):v.assertNever(s);return{status:n.value,value:e.data}}_regex(e,t,n){return this.refinement(t=>e.test(t),{validation:t,code:i.invalid_string,...l.errToObj(n)})}_addCheck(e){return new _ZodString({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...l.errToObj(e)})}url(e){return this._addCheck({kind:"url",...l.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...l.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...l.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...l.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...l.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...l.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...l.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...l.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...l.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...l.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...l.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...l.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof e?.precision=="undefined"?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...l.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof e?.precision=="undefined"?null:e?.precision,...l.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...l.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...l.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...l.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...l.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...l.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...l.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...l.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...l.errToObj(t)})}nonempty(e){return this.min(1,l.errToObj(e))}trim(){return new _ZodString({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new _ZodString({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new _ZodString({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}},yt.create=e=>new yt({checks:[],typeName:u.ZodString,coerce:e?.coerce??!1,...f(e)});function q0(e,t){const s=(e.toString().split(".")[1]||"").length,o=(t.toString().split(".")[1]||"").length,n=s>o?s:o,i=Number.parseInt(e.toFixed(n).replace(".","")),a=Number.parseInt(t.toFixed(n).replace(".",""));return i%a/10**n}$t=class _ZodNumber extends p{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){this._def.coerce&&(e.data=Number(e.data));const s=this._getType(e);if(s!==r.number){const t=this._getOrReturnCtx(e);return a(t,{code:i.invalid_type,expected:r.number,received:t.parsedType}),d}let t=0[0];const n=new L;for(const s of this._def.checks)if(s.kind==="int")v.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),a(t,{code:i.invalid_type,expected:"integer",received:"float",message:s.message}),n.dirty());else if(s.kind==="min"){const o=s.inclusive?e.data<s.value:e.data<=s.value;o&&(t=this._getOrReturnCtx(e,t),a(t,{code:i.too_small,minimum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),n.dirty())}else if(s.kind==="max"){const o=s.inclusive?e.data>s.value:e.data>=s.value;o&&(t=this._getOrReturnCtx(e,t),a(t,{code:i.too_big,maximum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),n.dirty())}else s.kind==="multipleOf"?q0(e.data,s.value)!==0&&(t=this._getOrReturnCtx(e,t),a(t,{code:i.not_multiple_of,multipleOf:s.value,message:s.message}),n.dirty()):s.kind==="finite"?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),a(t,{code:i.not_finite,message:s.message}),n.dirty()):v.assertNever(s);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,l.toString(t))}gt(e,t){return this.setLimit("min",e,!1,l.toString(t))}lte(e,t){return this.setLimit("max",e,!0,l.toString(t))}lt(e,t){return this.setLimit("max",e,!1,l.toString(t))}setLimit(e,t,n,s){return new _ZodNumber({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:l.toString(s)}]})}_addCheck(e){return new _ZodNumber({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:l.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:l.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:l.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:l.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:l.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:l.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:l.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:l.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:l.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&v.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if(n.kind==="finite"||n.kind==="int"||n.kind==="multipleOf")return!0;n.kind==="min"?(t===null||n.value>t)&&(t=n.value):n.kind==="max"&&(e===null||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}},$t.create=e=>new $t({checks:[],typeName:u.ZodNumber,coerce:e?.coerce||!1,...f(e)}),qt=class _ZodBigInt extends p{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}const s=this._getType(e);if(s!==r.bigint)return this._getInvalidInput(e);let t=0[0];const n=new L;for(const s of this._def.checks)if(s.kind==="min"){const o=s.inclusive?e.data<s.value:e.data<=s.value;o&&(t=this._getOrReturnCtx(e,t),a(t,{code:i.too_small,type:"bigint",minimum:s.value,inclusive:s.inclusive,message:s.message}),n.dirty())}else if(s.kind==="max"){const o=s.inclusive?e.data>s.value:e.data>=s.value;o&&(t=this._getOrReturnCtx(e,t),a(t,{code:i.too_big,type:"bigint",maximum:s.value,inclusive:s.inclusive,message:s.message}),n.dirty())}else s.kind==="multipleOf"?e.data%s.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),a(t,{code:i.not_multiple_of,multipleOf:s.value,message:s.message}),n.dirty()):v.assertNever(s);return{status:n.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return a(t,{code:i.invalid_type,expected:r.bigint,received:t.parsedType}),d}gte(e,t){return this.setLimit("min",e,!0,l.toString(t))}gt(e,t){return this.setLimit("min",e,!1,l.toString(t))}lte(e,t){return this.setLimit("max",e,!0,l.toString(t))}lt(e,t){return this.setLimit("max",e,!1,l.toString(t))}setLimit(e,t,n,s){return new _ZodBigInt({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:l.toString(s)}]})}_addCheck(e){return new _ZodBigInt({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:l.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:l.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:l.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:l.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:l.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}},qt.create=e=>new qt({checks:[],typeName:u.ZodBigInt,coerce:e?.coerce??!1,...f(e)}),Gt=class extends p{_parse(e){this._def.coerce&&(e.data=Boolean(e.data));const t=this._getType(e);if(t!==r.boolean){const t=this._getOrReturnCtx(e);return a(t,{code:i.invalid_type,expected:r.boolean,received:t.parsedType}),d}return z(e.data)}},Gt.create=e=>new Gt({typeName:u.ZodBoolean,coerce:e?.coerce||!1,...f(e)}),en=class _ZodDate extends p{_parse(e){this._def.coerce&&(e.data=new Date(e.data));const s=this._getType(e);if(s!==r.date){const t=this._getOrReturnCtx(e);return a(t,{code:i.invalid_type,expected:r.date,received:t.parsedType}),d}if(Number.isNaN(e.data.getTime())){const t=this._getOrReturnCtx(e);return a(t,{code:i.invalid_date}),d}const n=new L;let t=0[0];for(const s of this._def.checks)s.kind==="min"?e.data.getTime()<s.value&&(t=this._getOrReturnCtx(e,t),a(t,{code:i.too_small,message:s.message,inclusive:!0,exact:!1,minimum:s.value,type:"date"}),n.dirty()):s.kind==="max"?e.data.getTime()>s.value&&(t=this._getOrReturnCtx(e,t),a(t,{code:i.too_big,message:s.message,inclusive:!0,exact:!1,maximum:s.value,type:"date"}),n.dirty()):v.assertNever(s);return{status:n.value,value:new Date(e.data.getTime())}}_addCheck(e){return new _ZodDate({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:l.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:l.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}},en.create=e=>new en({checks:[],coerce:e?.coerce||!1,typeName:u.ZodDate,...f(e)}),Kn=class extends p{_parse(e){const t=this._getType(e);if(t!==r.symbol){const t=this._getOrReturnCtx(e);return a(t,{code:i.invalid_type,expected:r.symbol,received:t.parsedType}),d}return z(e.data)}},Kn.create=e=>new Kn({typeName:u.ZodSymbol,...f(e)}),on=class extends p{_parse(e){const t=this._getType(e);if(t!==r.undefined){const t=this._getOrReturnCtx(e);return a(t,{code:i.invalid_type,expected:r.undefined,received:t.parsedType}),d}return z(e.data)}},on.create=e=>new on({typeName:u.ZodUndefined,...f(e)}),an=class extends p{_parse(e){const t=this._getType(e);if(t!==r.null){const t=this._getOrReturnCtx(e);return a(t,{code:i.invalid_type,expected:r.null,received:t.parsedType}),d}return z(e.data)}},an.create=e=>new an({typeName:u.ZodNull,...f(e)}),st=class extends p{constructor(){super(...arguments),this._any=!0}_parse(e){return z(e.data)}},st.create=e=>new st({typeName:u.ZodAny,...f(e)}),He=class extends p{constructor(){super(...arguments),this._unknown=!0}_parse(e){return z(e.data)}},He.create=e=>new He({typeName:u.ZodUnknown,...f(e)}),Oe=class extends p{_parse(e){const t=this._getOrReturnCtx(e);return a(t,{code:i.invalid_type,expected:r.never,received:t.parsedType}),d}},Oe.create=e=>new Oe({typeName:u.ZodNever,...f(e)}),Vn=class extends p{_parse(e){const t=this._getType(e);if(t!==r.undefined){const t=this._getOrReturnCtx(e);return a(t,{code:i.invalid_type,expected:r.void,received:t.parsedType}),d}return z(e.data)}},Vn.create=e=>new Vn({typeName:u.ZodVoid,...f(e)}),Ge=class _ZodArray extends p{_parse(e){const{ctx:t,status:s}=this._processInputParams(e),n=this._def;if(t.parsedType!==r.array)return a(t,{code:i.invalid_type,expected:r.array,received:t.parsedType}),d;if(n.exactLength!==null){const e=t.data.length>n.exactLength.value,o=t.data.length<n.exactLength.value;(e||o)&&(a(t,{code:e?i.too_big:i.too_small,minimum:o?n.exactLength.value:0[0],maximum:e?n.exactLength.value:0[0],type:"array",inclusive:!0,exact:!0,message:n.exactLength.message}),s.dirty())}if(n.minLength!==null&&t.data.length<n.minLength.value&&(a(t,{code:i.too_small,minimum:n.minLength.value,type:"array",inclusive:!0,exact:!1,message:n.minLength.message}),s.dirty()),n.maxLength!==null&&t.data.length>n.maxLength.value&&(a(t,{code:i.too_big,maximum:n.maxLength.value,type:"array",inclusive:!0,exact:!1,message:n.maxLength.message}),s.dirty()),t.common.async)return Promise.all([...t.data].map((e,s)=>n.type._parseAsync(new ce(t,e,t.path,s)))).then(e=>L.mergeArray(s,e));const o=[...t.data].map((e,s)=>n.type._parseSync(new ce(t,e,t.path,s)));return L.mergeArray(s,o)}get element(){return this._def.type}min(e,t){return new _ZodArray({...this._def,minLength:{value:e,message:l.toString(t)}})}max(e,t){return new _ZodArray({...this._def,maxLength:{value:e,message:l.toString(t)}})}length(e,t){return new _ZodArray({...this._def,exactLength:{value:e,message:l.toString(t)}})}nonempty(e){return this.min(1,e)}},Ge.create=(e,t)=>new Ge({type:e,minLength:null,maxLength:null,exactLength:null,typeName:u.ZodArray,...f(t)});function yn(e){if(e instanceof X){const t={};for(const n in e.shape){const s=e.shape[n];t[n]=pe.create(yn(s))}return new X({...e._def,shape:()=>t})}return e instanceof Ge?new Ge({...e._def,type:yn(e.element)}):e instanceof pe?pe.create(yn(e.unwrap())):e instanceof Me?Me.create(yn(e.unwrap())):e instanceof ke?ke.create(e.items.map(e=>yn(e))):e}X=class _ZodObject extends p{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=v.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){const l=this._getType(e);if(l!==r.object){const t=this._getOrReturnCtx(e);return a(t,{code:i.invalid_type,expected:r.object,received:t.parsedType}),d}const{status:o,ctx:t}=this._processInputParams(e),{shape:u,keys:c}=this._getCached(),n=[];if(!(this._def.catchall instanceof Oe&&this._def.unknownKeys==="strip"))for(const e in t.data)c.includes(e)||n.push(e);const s=[];for(const e of c){const n=u[e],o=t.data[e];s.push({key:{status:"valid",value:e},value:n._parse(new ce(t,o,t.path,e)),alwaysSet:e in t.data})}if(this._def.catchall instanceof Oe){const e=this._def.unknownKeys;if(e==="passthrough")for(const e of n)s.push({key:{status:"valid",value:e},value:{status:"valid",value:t.data[e]}});else if(e==="strict")n.length>0&&(a(t,{code:i.unrecognized_keys,keys:n}),o.dirty());else if(e==="strip");else throw new Error(`Internal ZodObject error: invalid unknownKeys value.`)}else{const e=this._def.catchall;for(const o of n){const i=t.data[o];s.push({key:{status:"valid",value:o},value:e._parse(new ce(t,i,t.path,o)),alwaysSet:o in t.data})}}return t.common.async?Promise.resolve().then(async()=>{const e=[];for(const t of s){const n=await t.key,o=await t.value;e.push({key:n,value:o,alwaysSet:t.alwaysSet})}return e}).then(e=>L.mergeObjectSync(o,e)):L.mergeObjectSync(o,s)}get shape(){return this._def.shape()}strict(e){return l.errToObj,new _ZodObject({...this._def,unknownKeys:"strict",...e!==0[0]?{errorMap:(t,n)=>{const s=this._def.errorMap?.(t,n).message??n.defaultError;return t.code==="unrecognized_keys"?{message:l.errToObj(e).message??s}:{message:s}}}:{}})}strip(){return new _ZodObject({...this._def,unknownKeys:"strip"})}passthrough(){return new _ZodObject({...this._def,unknownKeys:"passthrough"})}extend(e){return new _ZodObject({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){const t=new _ZodObject({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:u.ZodObject});return t}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new _ZodObject({...this._def,catchall:e})}pick(e){const t={};for(const n of v.objectKeys(e))e[n]&&this.shape[n]&&(t[n]=this.shape[n]);return new _ZodObject({...this._def,shape:()=>t})}omit(e){const t={};for(const n of v.objectKeys(this.shape))e[n]||(t[n]=this.shape[n]);return new _ZodObject({...this._def,shape:()=>t})}deepPartial(){return yn(this)}partial(e){const t={};for(const n of v.objectKeys(this.shape)){const s=this.shape[n];e&&!e[n]?t[n]=s:t[n]=s.optional()}return new _ZodObject({...this._def,shape:()=>t})}required(e){const t={};for(const n of v.objectKeys(this.shape))if(e&&!e[n])t[n]=this.shape[n];else{const s=this.shape[n];let e=s;for(;e instanceof pe;)e=e._def.innerType;t[n]=e}return new _ZodObject({...this._def,shape:()=>t})}keyof(){return nu(v.objectKeys(this.shape))}},X.create=(e,t)=>new X({shape:()=>e,unknownKeys:"strip",catchall:Oe.create(),typeName:u.ZodObject,...f(t)}),X.strictCreate=(e,t)=>new X({shape:()=>e,unknownKeys:"strict",catchall:Oe.create(),typeName:u.ZodObject,...f(t)}),X.lazycreate=(e,t)=>new X({shape:e,unknownKeys:"strip",catchall:Oe.create(),typeName:u.ZodObject,...f(t)}),wn=class extends p{_parse(e){const{ctx:t}=this._processInputParams(e),s=this._def.options;function r(e){for(const t of e)if(t.result.status==="valid")return t.result;for(const n of e)if(n.result.status==="dirty")return t.common.issues.push(...n.ctx.common.issues),n.result;const n=e.map(e=>new oe(e.ctx.common.issues));return a(t,{code:i.invalid_union,unionErrors:n}),d}if(t.common.async)return Promise.all(s.map(async e=>{const n={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:n}),ctx:n}})).then(r);let n=0[0];const o=[];for(const a of s){const e={...t,common:{...t.common,issues:[]},parent:null},i=a._parseSync({data:t.data,path:t.path,parent:e});if(i.status==="valid")return i;i.status==="dirty"&&!n&&(n={result:i,ctx:e}),e.common.issues.length&&o.push(e.common.issues)}if(n)return t.common.issues.push(...n.ctx.common.issues),n.result;const c=o.map(e=>new oe(e));return a(t,{code:i.invalid_union,unionErrors:c}),d}get options(){return this._def.options}},wn.create=(e,t)=>new wn({options:e,typeName:u.ZodUnion,...f(t)}),ge=e=>e instanceof Dn?ge(e.schema):e instanceof Q?ge(e.innerType()):e instanceof Tn?[e.value]:e instanceof Fn?e.options:e instanceof un?v.objectValues(e.enum):e instanceof Pt?ge(e._def.innerType):e instanceof on?[0[0]]:e instanceof an?[null]:e instanceof pe?[0[0],...ge(e.unwrap())]:e instanceof Me?[null,...ge(e.unwrap())]:e instanceof pi?ge(e.unwrap()):e instanceof Tt?ge(e.unwrap()):e instanceof Lt?ge(e._def.innerType):[],sa=class _ZodDiscriminatedUnion extends p{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==r.object)return a(t,{code:i.invalid_type,expected:r.object,received:t.parsedType}),d;const s=this.discriminator,o=t.data[s],n=this.optionsMap.get(o);return n?t.common.async?n._parseAsync({data:t.data,path:t.path,parent:t}):n._parseSync({data:t.data,path:t.path,parent:t}):(a(t,{code:i.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[s]}),d)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,n){const s=new Map;for(const n of t){const o=ge(n.shape[e]);if(!o.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const t of o){if(s.has(t))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(t)}`);s.set(t,n)}}return new _ZodDiscriminatedUnion({typeName:u.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:s,...f(n)})}};function ta(e,t){const n=be(e),s=be(t);if(e===t)return{valid:!0,data:e};if(n===r.object&&s===r.object){const s=v.objectKeys(t),o=v.objectKeys(e).filter(e=>s.indexOf(e)!==-1),n={...e,...t};for(const s of o){const i=ta(e[s],t[s]);if(!i.valid)return{valid:!1};n[s]=i.data}return{valid:!0,data:n}}if(n===r.array&&s===r.array){if(e.length!==t.length)return{valid:!1};const n=[];for(let s=0;s<e.length;s++){const i=e[s],a=t[s],o=ta(i,a);if(!o.valid)return{valid:!1};n.push(o.data)}return{valid:!0,data:n}}return n===r.date&&s===r.date&&+e===+t?{valid:!0,data:e}:{valid:!1}}Cn=class extends p{_parse(e){const{status:n,ctx:t}=this._processInputParams(e),s=(e,s)=>{if(xo(e)||xo(s))return d;const o=ta(e.value,s.value);return o.valid?((Co(e)||Co(s))&&n.dirty(),{status:n.value,value:o.data}):(a(t,{code:i.invalid_intersection_types}),d)};return t.common.async?Promise.all([this._def.left._parseAsync({data:t.data,path:t.path,parent:t}),this._def.right._parseAsync({data:t.data,path:t.path,parent:t})]).then(([e,t])=>s(e,t)):s(this._def.left._parseSync({data:t.data,path:t.path,parent:t}),this._def.right._parseSync({data:t.data,path:t.path,parent:t}))}},Cn.create=(e,t,n)=>new Cn({left:e,right:t,typeName:u.ZodIntersection,...f(n)}),ke=class _ZodTuple extends p{_parse(e){const{status:n,ctx:t}=this._processInputParams(e);if(t.parsedType!==r.array)return a(t,{code:i.invalid_type,expected:r.array,received:t.parsedType}),d;if(t.data.length<this._def.items.length)return a(t,{code:i.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),d;const o=this._def.rest;!o&&t.data.length>this._def.items.length&&(a(t,{code:i.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),n.dirty());const s=[...t.data].map((e,n)=>{const s=this._def.items[n]||this._def.rest;return s?s._parse(new ce(t,e,t.path,n)):null}).filter(e=>!!e);return t.common.async?Promise.all(s).then(e=>L.mergeArray(n,e)):L.mergeArray(n,s)}get items(){return this._def.items}rest(e){return new _ZodTuple({...this._def,rest:e})}},ke.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new ke({items:e,typeName:u.ZodTuple,rest:null,...f(t)})},Ki=class _ZodRecord extends p{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:s,ctx:t}=this._processInputParams(e);if(t.parsedType!==r.object)return a(t,{code:i.invalid_type,expected:r.object,received:t.parsedType}),d;const n=[],o=this._def.keyType,c=this._def.valueType;for(const e in t.data)n.push({key:o._parse(new ce(t,e,t.path,e)),value:c._parse(new ce(t,t.data[e],t.path,e)),alwaysSet:e in t.data});return t.common.async?L.mergeObjectAsync(s,n):L.mergeObjectSync(s,n)}get element(){return this._def.valueType}static create(e,t,n){return t instanceof p?new _ZodRecord({keyType:e,valueType:t,typeName:u.ZodRecord,...f(n)}):new _ZodRecord({keyType:yt.create(),valueType:e,typeName:u.ZodRecord,...f(t)})}},Ln=class extends p{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:n,ctx:t}=this._processInputParams(e);if(t.parsedType!==r.map)return a(t,{code:i.invalid_type,expected:r.map,received:t.parsedType}),d;const c=this._def.keyType,l=this._def.valueType,s=[...t.data.entries()].map(([e,n],s)=>({key:c._parse(new ce(t,e,t.path,[s,"key"])),value:l._parse(new ce(t,n,t.path,[s,"value"]))}));if(t.common.async){const e=new Map;return Promise.resolve().then(async()=>{for(const i of s){const t=await i.key,o=await i.value;if(t.status==="aborted"||o.status==="aborted")return d;(t.status==="dirty"||o.status==="dirty")&&n.dirty(),e.set(t.value,o.value)}return{status:n.value,value:e}})}const o=new Map;for(const i of s){const e=i.key,t=i.value;if(e.status==="aborted"||t.status==="aborted")return d;(e.status==="dirty"||t.status==="dirty")&&n.dirty(),o.set(e.value,t.value)}return{status:n.value,value:o}}},Ln.create=(e,t,n)=>new Ln({valueType:t,keyType:e,typeName:u.ZodMap,...f(n)}),Rn=class _ZodSet extends p{_parse(e){const{status:s,ctx:t}=this._processInputParams(e);if(t.parsedType!==r.set)return a(t,{code:i.invalid_type,expected:r.set,received:t.parsedType}),d;const n=this._def;n.minSize!==null&&t.data.size<n.minSize.value&&(a(t,{code:i.too_small,minimum:n.minSize.value,type:"set",inclusive:!0,exact:!1,message:n.minSize.message}),s.dirty()),n.maxSize!==null&&t.data.size>n.maxSize.value&&(a(t,{code:i.too_big,maximum:n.maxSize.value,type:"set",inclusive:!0,exact:!1,message:n.maxSize.message}),s.dirty());const l=this._def.valueType;function o(e){const t=new Set;for(const n of e){if(n.status==="aborted")return d;n.status==="dirty"&&s.dirty(),t.add(n.value)}return{status:s.value,value:t}}const c=[...t.data.values()].map((e,n)=>l._parse(new ce(t,e,t.path,n)));return t.common.async?Promise.all(c).then(e=>o(e)):o(c)}min(e,t){return new _ZodSet({...this._def,minSize:{value:e,message:l.toString(t)}})}max(e,t){return new _ZodSet({...this._def,maxSize:{value:e,message:l.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}},Rn.create=(e,t)=>new Rn({valueType:e,minSize:null,maxSize:null,typeName:u.ZodSet,...f(t)}),Vi=class _ZodFunction extends p{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==r.function)return a(t,{code:i.invalid_type,expected:r.function,received:t.parsedType}),d;function s(e,n){return vs({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,go(),Qe].filter(e=>!!e),issueData:{code:i.invalid_arguments,argumentsError:n}})}function o(e,n){return vs({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,go(),Qe].filter(e=>!!e),issueData:{code:i.invalid_return_type,returnTypeError:n}})}const n={errorMap:t.common.contextualErrorMap},c=t.data;if(this._def.returns instanceof it){const e=this;return z(async function(...i){const t=new oe([]),r=await e._def.args.parseAsync(i,n).catch(e=>{throw t.addIssue(s(i,e)),t}),a=await Reflect.apply(c,this,r),l=await e._def.returns._def.type.parseAsync(a,n).catch(e=>{throw t.addIssue(o(a,e)),t});return l})}const l=this;return z(function(...i){const e=l._def.args.safeParse(i,n);if(!e.success)throw new oe([s(i,e.error)]);const a=Reflect.apply(c,this,e.data),t=l._def.returns.safeParse(a,n);if(!t.success)throw new oe([o(a,t.error)]);return t.data})}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new _ZodFunction({...this._def,args:ke.create(e).rest(He.create())})}returns(e){return new _ZodFunction({...this._def,returns:e})}implement(e){const t=this.parse(e);return t}strictImplement(e){const t=this.parse(e);return t}static create(e,t,n){return new _ZodFunction({args:e||ke.create([]).rest(He.create()),returns:t||He.create(),typeName:u.ZodFunction,...f(n)})}},Dn=class extends p{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.getter();return n._parse({data:t.data,path:t.path,parent:t})}},Dn.create=(e,t)=>new Dn({getter:e,typeName:u.ZodLazy,...f(t)}),Tn=class extends p{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return a(t,{received:t.data,code:i.invalid_literal,expected:this._def.value}),d}return{status:"valid",value:e.data}}get value(){return this._def.value}},Tn.create=(e,t)=>new Tn({value:e,typeName:u.ZodLiteral,...f(t)});function nu(e,t){return new Fn({values:e,typeName:u.ZodEnum,...f(t)})}Fn=class _ZodEnum extends p{_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),n=this._def.values;return a(t,{expected:v.joinValues(n),received:t.parsedType,code:i.invalid_type}),d}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const t=this._getOrReturnCtx(e),n=this._def.values;return a(t,{received:t.data,code:i.invalid_enum_value,options:n}),d}return z(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return _ZodEnum.create(e,{...this._def,...t})}exclude(e,t=this._def){return _ZodEnum.create(this.options.filter(t=>!e.includes(t)),{...this._def,...t})}},Fn.create=nu,un=class extends p{_parse(e){const n=v.getValidEnumValues(this._def.values),t=this._getOrReturnCtx(e);if(t.parsedType!==r.string&&t.parsedType!==r.number){const e=v.objectValues(n);return a(t,{expected:v.joinValues(e),received:t.parsedType,code:i.invalid_type}),d}if(this._cache||(this._cache=new Set(v.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const e=v.objectValues(n);return a(t,{received:t.data,code:i.invalid_enum_value,options:e}),d}return z(e.data)}get enum(){return this._def.values}},un.create=(e,t)=>new un({values:e,typeName:u.ZodNativeEnum,...f(t)}),it=class extends p{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==r.promise&&t.common.async===!1)return a(t,{code:i.invalid_type,expected:r.promise,received:t.parsedType}),d;const n=t.parsedType===r.promise?t.data:Promise.resolve(t.data);return z(n.then(e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap})))}},it.create=(e,t)=>new it({type:e,typeName:u.ZodPromise,...f(t)}),Q=class extends p{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===u.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:n,ctx:t}=this._processInputParams(e),s=this._def.effect||null,o={addIssue:e=>{a(t,e),e.fatal?n.abort():n.dirty()},get path(){return t.path}};if(o.addIssue=o.addIssue.bind(o),s.type==="preprocess"){const i=s.transform(t.data,o);if(t.common.async)return Promise.resolve(i).then(async e=>{if(n.value==="aborted")return d;const s=await this._def.schema._parseAsync({data:e,path:t.path,parent:t});return s.status==="aborted"?d:s.status==="dirty"?nt(s.value):n.value==="dirty"?nt(s.value):s});if(n.value==="aborted")return d;const e=this._def.schema._parseSync({data:i,path:t.path,parent:t});return e.status==="aborted"?d:e.status==="dirty"?nt(e.value):n.value==="dirty"?nt(e.value):e}if(s.type==="refinement"){const e=e=>{const n=s.refinement(e,o);if(t.common.async)return Promise.resolve(n);if(n instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(t.common.async===!1){const s=this._def.schema._parseSync({data:t.data,path:t.path,parent:t});return s.status==="aborted"?d:(s.status==="dirty"&&n.dirty(),e(s.value),{status:n.value,value:s.value})}return this._def.schema._parseAsync({data:t.data,path:t.path,parent:t}).then(t=>t.status==="aborted"?d:(t.status==="dirty"&&n.dirty(),e(t.value).then(()=>({status:n.value,value:t.value}))))}if(s.type==="transform"){if(t.common.async===!1){const e=this._def.schema._parseSync({data:t.data,path:t.path,parent:t});if(!We(e))return d;const i=s.transform(e.value,o);if(i instanceof Promise)throw new Error(`Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.`);return{status:n.value,value:i}}return this._def.schema._parseAsync({data:t.data,path:t.path,parent:t}).then(e=>We(e)?Promise.resolve(s.transform(e.value,o)).then(e=>({status:n.value,value:e})):d)}v.assertNever(s)}},Q.create=(e,t,n)=>new Q({schema:e,typeName:u.ZodEffects,effect:t,...f(n)}),Q.createWithPreprocess=(e,t,n)=>new Q({schema:t,effect:{type:"preprocess",transform:e},typeName:u.ZodEffects,...f(n)}),pe=class extends p{_parse(e){const t=this._getType(e);return t===r.undefined?z(0[0]):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}},pe.create=(e,t)=>new pe({innerType:e,typeName:u.ZodOptional,...f(t)}),Me=class extends p{_parse(e){const t=this._getType(e);return t===r.null?z(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}},Me.create=(e,t)=>new Me({innerType:e,typeName:u.ZodNullable,...f(t)}),Pt=class extends p{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===r.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}},Pt.create=(e,t)=>new Pt({innerType:e,typeName:u.ZodDefault,defaultValue:typeof t.default=="function"?t.default:()=>t.default,...f(t)}),Lt=class extends p{_parse(e){const{ctx:s}=this._processInputParams(e),t={...s,common:{...s.common,issues:[]}},n=this._def.innerType._parse({data:t.data,path:t.path,parent:{...t}});return Ut(n)?n.then(e=>({status:"valid",value:e.status==="valid"?e.value:this._def.catchValue({get error(){return new oe(t.common.issues)},input:t.data})})):{status:"valid",value:n.status==="valid"?n.value:this._def.catchValue({get error(){return new oe(t.common.issues)},input:t.data})}}removeCatch(){return this._def.innerType}},Lt.create=(e,t)=>new Lt({innerType:e,typeName:u.ZodCatch,catchValue:typeof t.catch=="function"?t.catch:()=>t.catch,...f(t)}),Zn=class extends p{_parse(e){const t=this._getType(e);if(t!==r.nan){const t=this._getOrReturnCtx(e);return a(t,{code:i.invalid_type,expected:r.nan,received:t.parsedType}),d}return{status:"valid",value:e.data}}},Zn.create=e=>new Zn({typeName:u.ZodNaN,...f(e)}),hu=Symbol("zod_brand"),pi=class extends p{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}},fi=class _ZodPipeline extends p{_parse(e){const{status:s,ctx:t}=this._processInputParams(e);if(t.common.async){const e=async()=>{const e=await this._def.in._parseAsync({data:t.data,path:t.path,parent:t});return e.status==="aborted"?d:e.status==="dirty"?(s.dirty(),nt(e.value)):this._def.out._parseAsync({data:e.value,path:t.path,parent:t})};return e()}const n=this._def.in._parseSync({data:t.data,path:t.path,parent:t});return n.status==="aborted"?d:n.status==="dirty"?(s.dirty(),{status:"dirty",value:n.value}):this._def.out._parseSync({data:n.value,path:t.path,parent:t})}static create(e,t){return new _ZodPipeline({in:e,out:t,typeName:u.ZodPipeline})}},Tt=class extends p{_parse(e){const t=this._def.innerType._parse(e),n=e=>(We(e)&&(e.value=Object.freeze(e.value)),e);return Ut(t)?t.then(e=>n(e)):n(t)}unwrap(){return this._def.innerType}},Tt.create=(e,t)=>new Tt({innerType:e,typeName:u.ZodReadonly,...f(t)});function gu(e,t){const n=typeof e=="function"?e(t):typeof e=="string"?{message:e}:e,s=typeof n=="string"?{message:n}:n;return s}function vu(e,t={},n){return e?st.create().superRefine((s,o)=>{const i=e(s);if(i instanceof Promise)return i.then(e=>{if(!e){const e=gu(t,s),i=e.fatal??n??!0;o.addIssue({code:"custom",...e,fatal:i})}});if(!i){const e=gu(t,s),i=e.fatal??n??!0;o.addIssue({code:"custom",...e,fatal:i})}}):st.create()}bu={object:X.lazycreate},function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(u||(u={})),yu=(e,t={message:`Input not instance of ${e.name}`})=>vu(t=>t instanceof e,t),Bi=yt.create,Yi=$t.create,Ou=Zn.create,xu=qt.create,Xi=Gt.create,Eu=en.create,ku=Kn.create,Au=on.create,Su=an.create,Mu=st.create,Fu=He.create,Tu=Oe.create,zu=Vn.create,Du=Ge.create,Nu=X.create,Lu=X.strictCreate,Ru=wn.create,Pu=sa.create,Hu=Cn.create,Iu=ke.create,Bu=Ki.create,Vu=Ln.create,$u=Rn.create,Wu=Vi.create,Uu=Dn.create,Ku=Tn.create,qu=Fn.create,Yu=un.create,Gu=it.create,la=Q.create,Qu=pe.create,Zu=Me.create,Ju=Q.createWithPreprocess,e1=fi.create,t1=()=>Bi().optional(),Ic=()=>Yi().optional(),s1=()=>Xi().optional(),o1={string:e=>yt.create({...e,coerce:!0}),number:e=>$t.create({...e,coerce:!0}),boolean:e=>Gt.create({...e,coerce:!0}),bigint:e=>qt.create({...e,coerce:!0}),date:e=>en.create({...e,coerce:!0})},i1=d,js=/^https?:\/\/library.stanford.edu\/iiif\/image-api\/1.1\/compliance.html#level(?<level>[012])$/,ua=t.string().regex(js),c1=ua,xn="http://library.stanford.edu/iiif/image-api/1.1/context.json",ha="http://iiif.io/api/image/1/context.json",ma=t.literal(xn),ws=t.object({"@context":ma,"@id":t.string().url(),profile:ua.optional(),width:t.number().int(),height:t.number().int(),scale_factors:t.number().array().optional(),tile_width:t.number().optional(),tile_height:t.number().optional()}),ja=t.object({width:t.number().int(),height:t.number().int()}),Ca=t.object({width:t.number().int(),height:t.number().int().optional(),scaleFactors:t.array(t.number().int())}),p1=["ImageService1","ImageService2","ImageService3"],ka=t.enum(p1),Fa=t.coerce.date(),St=t.union([Fa,t.any()]).transform(e=>{const{success:t,data:n}=Fa.safeParse(e);if(t)return n}),ut=t.object({}).passthrough(),Cs=/^https?:\/\/iiif.io\/api\/image\/2.*level(?<level>[012])(.json)?$/,Ua=t.string().regex(Cs),w1=t.object({formats:t.string().array().optional(),maxArea:t.number().int().optional(),maxHeight:t.number().int().optional(),maxWidth:t.number().int().optional(),qualities:t.string().array().optional(),supports:t.string().array().optional()}),Ya=t.union([Ua,w1]);function L0(e){return e!==0[0]}Es=t.union([Ua,t.array(t.union([Ya,t.unknown()]).transform(e=>{const{success:t,data:n}=Ya.safeParse(e);if(t)return n}))]).transform(e=>{if(e&&Array.isArray(e)){const t=e[0];if(typeof t!="string")throw new Error("First profile must be a string");return[t,...e.slice(1).filter(L0)]}return e}),Ms="http://iiif.io/api/image/2/context.json",dr=t.union([t.literal(Ms),t.literal("https://iiif.io/api/image/2/context.json"),t.string().url()]),Fs=t.object({"@id":t.string().url(),"@type":t.union([t.literal("iiif:Image"),t.literal("ImageService2")]).optional(),"@context":dr,protocol:t.literal("http://iiif.io/api/image"),width:t.number().int(),height:t.number().int(),profile:Es,sizes:ja.array().optional(),tiles:Ca.array().optional()}),S1=["level0","level1","level2"],_r=t.enum(S1),Ts=t.object({id:t.string().url(),type:t.literal("ImageService3"),protocol:t.literal("http://iiif.io/api/image"),profile:_r,width:t.number().int(),height:t.number().int(),maxWidth:t.number().int().optional(),maxHeight:t.number().int().optional(),maxArea:t.number().int().optional(),sizes:ja.array().optional(),tiles:Ca.array().optional(),extraFeatures:t.string().array().optional()}),T1=t.object({"@id":t.string().url(),"@type":ka.optional(),profile:t.union([c1,Es,_r]),width:t.number().int().optional(),height:t.number().int().optional(),"@context":t.union([ma,t.literal("http://iiif.io/api/image/1/context.json"),dr]).optional()}),z1=["level0","level1","level2"],D1=t.union([t.object({id:t.string().url(),type:t.literal("ImageService2"),profile:Es}),t.object({"@id":t.string().url(),"@type":t.literal("ImageService2"),profile:Es})]),N1=t.object({id:t.string().url(),type:ka,profile:t.enum(z1)}),L1=t.union([D1,N1]),Or=t.union([T1,L1]),Cr=t.record(t.string(),t.string().array()),N0=t.object({label:Cr.optional(),value:Cr.optional()});function ln(e){if(e)return Array.isArray(e)?e:[e]}function q(e){if(typeof e=="string")return{none:[e]};if(Array.isArray(e)){let t={};return e.forEach(e=>{if(typeof e=="string")t.none||(t.none=[]),t.none.push(e);else if(typeof e=="object")t={...t,...q(e)};else throw new Error("Unable to parse string")}),t}if(e&&typeof e=="object"){e;const n=e["@language"]||"none",t=e["@value"]||"";return{[n]:Array.isArray(t)?t:[t]}}}function Be(e){if(!e)return;const t={};for(const n in e)t[n]=e[n];return t}function D0(e){if(e){const t=q(e.label),n=q(e.value);if(t&&n)return{label:t,value:n}}}function A0(e){if(e){const t=Be(e.label),n=Be(e.value);if(t&&n)return{label:t,value:n}}}function U1(e){return e!==0[0]}function Tr(e){if(Array.isArray(e))return e.length===0?0[0]:e.map(D0).filter(U1);if(e)throw new Error("Unable to parse metadata")}function fo(e){if(Array.isArray(e))return e.length===0?0[0]:e.map(A0).filter(U1);if(e)throw new Error("Unable to parse metadata")}function Kr(e){if(e){if(typeof e=="string")return{label:{none:["Attribution"]},value:{none:[e]}};const t=q(e);if(t)return{label:{none:["Attribution"]},value:t}}}function Xr(e){return e?.map(e=>typeof e=="string"?{id:e}:{id:e["@id"],type:e["@type"],format:e.format,width:e.width,height:e.height})}function Zr(e){return e?.map(e=>({id:e["@id"],type:e["@type"],label:q(e.label),format:e.format}))}function ac(e){if(e)return typeof e=="string"?[{id:e}]:Array.isArray(e)?e.map(e=>({id:e["@id"],label:q(e.label),format:e.format})):[{id:e["@id"],label:q(e.label),format:e.format}]}Ys=t.union([t.string(),t.number(),t.boolean()]).transform(e=>String(e)),fn=t.union([Ys.array(),Ys]),Sr=t.object({"@id":t.string().url(),format:t.string().optional(),label:fn.optional()}),_o=t.union([Sr.array(),Sr,Ys]),bi=t.union([t.string(),t.object({"@id":t.string().url(),"@type":t.string().optional(),format:t.string().optional(),height:t.number().optional(),width:t.number().optional()})]),Mo=t.union([bi.array(),bi]).transform(ln),Va=t.object({"@id":t.string().url(),"@type":t.string().optional(),label:fn.optional(),format:t.string().optional()}),Vo=t.union([Va.array(),Va]).transform(ln),r4=t.union([t.object({"@value":fn,"@language":t.string().optional()}),t.object({value:fn,language:t.string().optional()})]).transform(e=>"value"in e?{"@value":e.value,"@language":e.language}:e),da=r4,ee=t.union([da.array(),da,fn]),Yo=t.union([t.string(),ee]),ia=t.object({label:ee.optional(),value:ee.optional()}),h4=t.union([ia,t.any()]).transform(e=>{const{success:t,data:n}=ia.safeParse(e);if(t)return n}),Xo=h4.array(),f4=t.object({width:t.number().int().optional(),height:t.number().int().optional(),service:Or}),p4=t.object({resource:f4}),ei=t.object({"@id":t.string().url(),"@type":t.literal("sc:Canvas"),width:t.number().int(),height:t.number().int(),images:p4.array().length(1),label:ee.optional(),description:ee.optional(),related:_o.optional(),attribution:Yo.optional(),thumbnail:Mo.optional(),rendering:Vo.optional(),metadata:Xo.optional(),navDate:St.optional(),navPlace:ut.optional()}),v4=t.object({canvases:ei.array().nonempty()}),is=t.object({"@id":t.string().url(),"@type":t.literal("sc:Manifest"),sequences:v4.array().length(1),label:ee.optional(),description:ee.optional(),metadata:Xo.optional(),related:_o.optional(),attribution:Yo.optional(),rendering:Vo.optional(),thumbnail:Mo.optional(),navDate:St.optional(),navPlace:ut.optional()}),Hi=t.lazy(()=>t.object({"@id":t.string().url(),"@type":t.literal("sc:Manifest"),label:ee.optional()})),Ve=t.lazy(()=>t.object({"@id":t.string().url(),"@type":t.literal("sc:Collection"),manifests:Hi.array().optional(),collections:Ve.array().optional(),members:t.union([Hi,Ve,_4]).array().optional(),label:ee.optional(),description:ee.optional(),metadata:Xo.optional(),related:_o.optional(),attribution:Yo.optional(),thumbnail:Mo.optional(),rendering:Vo.optional(),navDate:St.optional(),navPlace:ut.optional()})),_4=t.object({"@id":t.string().url(),"@type":t.literal("sc:Collection"),label:ee.optional()}),w4=t.union([t.string(),t.number(),t.boolean()]).transform(e=>String(e)),V=t.record(t.string(),w4.array()),ci=V,Mi=t.object({id:t.string().url(),type:t.string().optional(),label:V,format:t.string().optional(),language:t.union([t.string(),t.array(t.string())]).optional()}),er=t.object({id:t.string().url(),type:t.string().optional(),label:V,format:t.string().optional()}),Ws=t.union([er.array(),er]).transform(ln),li=t.union([Mi.array(),Mi]).transform(ln),Ni=t.object({id:t.string().url(),type:t.string().optional(),format:t.string().optional(),width:t.number().int().optional(),height:t.number().int().optional()}),ni=t.union([Ni.array(),Ni]).transform(ln),Qi=t.object({id:t.string().url(),type:t.string().optional(),format:t.string().optional(),profile:t.string().optional()}),Jo=t.union([Qi.array(),Qi]).transform(ln),Zo=t.object({id:t.string().url(),type:t.literal("AnnotationPage"),items:t.object({}).passthrough().array().optional()}).array(),ra=t.object({label:V,value:V}),ca=t.union([ra,t.any()]).transform(e=>{const{success:t,data:n}=ra.safeParse(e);if(t)return n}),Wo=ca.array(),$o=ca,Bo=t.object({type:t.literal("Image"),width:t.number().int().optional(),height:t.number().int().optional(),service:Or.array()}),H4=t.object({type:t.literal("Choice"),items:Bo.array()}),I4=t.object({type:t.literal("Annotation"),body:t.union([Bo,Bo.array().length(1),H4])}),B4=t.object({type:t.literal("AnnotationPage"),items:I4.array().length(1)}),Io=t.object({id:t.string().url(),type:t.literal("Canvas"),width:t.number().int(),height:t.number().int(),items:B4.array().length(1),label:V.optional(),description:V.optional(),metadata:Wo.optional(),navDate:St.optional(),navPlace:ut.optional(),homepage:li.optional(),thumbnail:ni.optional(),rendering:Ws.optional(),seeAlso:Jo.optional(),summary:ci.optional(),requiredStatement:$o.optional(),annotations:Zo.optional()}),Wn=t.object({id:t.string().url(),type:t.literal("Manifest"),items:Io.array().nonempty(),label:V.optional(),description:V.optional(),metadata:Wo.optional(),navDate:St.optional(),navPlace:ut.optional(),homepage:li.optional(),thumbnail:ni.optional(),rendering:Ws.optional(),seeAlso:Jo.optional(),summary:ci.optional(),requiredStatement:$o.optional(),annotations:Zo.optional()}),W4=t.lazy(()=>t.object({id:t.string().url(),type:t.literal("Manifest"),label:V.optional()})),wt=t.lazy(()=>t.object({id:t.string().url(),type:t.literal("Collection"),items:t.union([W4,wt,K4]).array(),label:V.optional(),description:V.optional(),metadata:Wo.optional(),navDate:St.optional(),navPlace:ut.optional(),homepage:li.optional(),thumbnail:ni.optional(),rendering:Ws.optional(),seeAlso:Jo.optional(),summary:ci.optional(),requiredStatement:$o.optional(),annotations:Zo.optional()})),K4=t.object({id:t.string().url(),type:t.literal("Collection"),label:V.optional()}),q4=t.union([ws,Fs,Ts]),_0=t.union([ei,Io]),G4=t.union([is,Wn]),Da=t.union([Ve,wt]),Q4=ws,Z4=t.union([Ve,is,ei,Fs]),J4=t.union([wt,Wn,Io,Ts]),j0=t.union([Q4,Z4,J4]);function t0({width:e,height:t},n,s,o){const i=s*n.originalWidth,a=o*n.originalHeight,l=s*n.originalWidth+n.width*n.scaleFactor>e?e-s*n.originalWidth:n.width*n.scaleFactor,d=o*n.originalHeight+n.height*n.scaleFactor>t?t-o*n.originalHeight:n.height*n.scaleFactor;let r=n.width,c=n.height;return i+n.width*n.scaleFactor>e&&(r=Math.floor((e-i+n.scaleFactor-1)/n.scaleFactor)),a+n.height*n.scaleFactor>t&&(c=Math.floor((t-a+n.scaleFactor-1)/n.scaleFactor)),{region:{x:i,y:a,width:l,height:d},size:{width:r,height:c}}}function b0({width:e,height:t},n=768){const s=Math.max(e,t)/n,o=Math.ceil(Math.log(s)/Math.log(2));return{scaleFactors:Array.from({length:o},(e,t)=>2**t),width:n}}function g0({width:e,height:t},n,s){const o=n.height||n.width,i=n.width*s,a=o*s;return{scaleFactor:s,width:n.width,height:o,originalWidth:i,originalHeight:a,columns:Math.ceil(e/i),rows:Math.ceil(t/a)}}function m0(e,t){return t.map(t=>t.scaleFactors.map(n=>g0(e,t,n))).flat()}function u0(e){return!!e.some(e=>e.width&&e.scaleFactors&&e.scaleFactors.length)}function d0(e,t,n){if(!t||!u0(t))if(n)t=[b0(e)];else throw new Error("Image does not support tiles or custom regions and sizes.");return m0(e,t)}function l0(e,t,n="cover"){if(n==="cover"||n==="contain"){const s=t.width/e.width,o=t.height/e.height,i=n==="cover"?Math.max(s,o):Math.min(s,o),a=e.width*i,r=e.height*i;return{width:a,height:r}}throw new Error('Mode must be either "cover" or "contain"')}c0=.8,r0=1.5;function a0(e,t,n="cover",{sizes:s,tileZoomLevels:o,supportsAnyRegionAndSize:i,maxWidth:a,maxHeight:r,maxArea:c}){let{width:l,height:d}=l0(e,t,n);if(a&&l>a&&(d=d/l*a,l=a),r&&d>r&&(l=l/d*r,d=r),c&&l*d>c){const e=d/l,t=Math.floor(Math.sqrt(c/e)),n=t*e;l=Math.floor(n)/e,d=l*e}const u=e.width/e.height;if(l=Math.floor(l),d=Math.round(l/u),s){let e;for(const t of s){const n=t.width/l;if(n>=c0&&n<=r0){e=t;break}}if(e)return{size:e}}if(i)return{size:{width:Math.round(l),height:Math.round(d)}};if(o){const s=e.width/l,i=o.map(({scaleFactor:e},t)=>({index:t,scaleFactor:e,diff:Math.abs(e-s)})).sort((e,t)=>e.diff-t.diff),t=o[i[0].index],a=Math.ceil(e.width/(t.scaleFactor*o[0].width)),r=Math.ceil(e.height/(t.scaleFactor*o[0].height)),n=[];for(let s=0;s<r;s++){const o=[];for(let n=0;n<a;n++){const i=t0(e,t,n,s);o.push(i)}n.push(o)}return n}throw new Error("Unable to create thumbnail")}Ha=["regionByPx","sizeByWh"];function h0(e){const t=e.match(js);if(t&&t.groups){const e=parseInt(t.groups.level);return e}}function o0(e){const t=e.match(Cs);if(t&&t.groups){const e=parseInt(t.groups.level);return e}}function f0(e){return{maxWidth:e?.maxWidth,maxHeight:e?.maxHeight,maxArea:e?.maxArea,supportsAnyRegionAndSize:Ha.every(t=>e?.supports&&e?.supports?.includes(t))}}function p0(e){if("type"in e&&e.type==="ImageService3")return 3;if("type"in e&&e.type==="ImageService2"||"@type"in e&&e["@type"]==="ImageService2"||"@context"in e&&e["@context"]===Ms)return 2;if("@context"in e&&(e["@context"]===xn||e["@context"]===ha))return 1;if("profile"in e){let t;return Array.isArray(e.profile)?t=e.profile[0]:t=e.profile,t.match(js)?1:t.match(Cs)?2:3}else throw new Error("Unsupported IIIF Image Service")}function Ba(e){if("type"in e||"@type"in e){const t=e.profile;let n=!1;return t==="level0"||typeof t=="string"&&t.endsWith("level0.json")?"extraFeatures"in e&&(n=Ha.every(t=>e.extraFeatures&&e.extraFeatures.includes(t))):n=!0,{maxWidth:"maxWidth"in e?e.maxWidth:0[0],maxHeight:"maxHeight"in e?e.maxHeight:0[0],maxArea:"maxArea"in e?e.maxArea:0[0],supportsAnyRegionAndSize:n}}if(Array.isArray(e.profile)){let t=!1,n=Number.NEGATIVE_INFINITY,s=Number.NEGATIVE_INFINITY,o=Number.NEGATIVE_INFINITY;return e.profile.forEach(e=>{if(typeof e=="string"){const n=o0(e);n&&(t=t||n>=1)}else{const{maxWidth:i,maxHeight:a,maxArea:r,supportsAnyRegionAndSize:c}=f0(e);i!==0[0]&&(s=Math.max(i,s)),a!==0[0]&&(n=Math.max(a,n)),r!==0[0]&&(o=Math.max(r,o)),t=t||c}}),{maxWidth:s>=0?s:0[0],maxHeight:n>=0?n:0[0],maxArea:o>=0?o:0[0],supportsAnyRegionAndSize:t}}if("profile"in e&&e.profile){const t=h0(e.profile),n=o0(e.profile);return t?{supportsAnyRegionAndSize:t>=1}:n?{supportsAnyRegionAndSize:n>=1}:{supportsAnyRegionAndSize:!1}}else throw new Error("Invalid Image")}var Us,pl,Rc,jl,_l,Is,xl,kl,Oc,Qs,gc,Il,Vl,_,ql,hc,b,Ae,de,uc,Cd,Id,Bd,eu,ue,Ze,It,rc,Bt,Js,Fe,je,eo,D,to,De,m,j,P,so,C,N,ro,Yr,zs,qr,co,Wr,jn,$r,r1,Ss,As,F,B,rt,Ot,A,R,ks,at,lo,c,xs,x1,$e,se,o,Z,uo,Os,Rr,K1,Se,ae,Dr,K,mo,po,x,he,Ar,O,M,$,bs,kr,vt,ht,gs,Er,jo,yo,bn,wr,gn,Je,pn,qe,Oo,y,ot,Y,fr,hr,Ke,ne,ar,ir,Eo,tr,z4,ko,e0,Za,Nn,Qa,fe,n0,Xa,Ct,Ga,Ao,Jn,Mt,ye,qa,So,Fo,s0,E,Xn,J,To,Ma,Sa,No,Ea,xa,qn,Oa,U,Pe,wa,Jt,ya,Ue,ba,va,pa,vi,$4,V4,ie,$n,hn,mn,P4,R4,L4,te,Ko,N4,D4,qo,Go,O0,x0,Zi,E0,M4,Gi,si,Bn,In,Hn,qi,Pn,oi,xt,$i,ai,Ii,Ri,Mn,Xe,S4,_e,A4,di,Si,ki,gi,Ci,k4,E4,mi,C4,x4,O4,y4,Hc,b4,ii,g4,Kt,u4,d4,l4,xe,Re,Uo,W,ga,za,s4,ft,On,rr,pr,n4,bo,e4,Mr,zr,Br,vn,Ie,oo,Gs,Ho,Pc,Lc,Mc,S,Ec,vc,Q1,ic,sc,tc,no,Jr,Vs,Hs,X1,G1,Y1,Ps,Hr,Lr,Le,V1,B1,I1,P1,R1,F1,M1,A1,k1,E1,T,C1,O1,_1,y1,j1,b1,zo,v1,g1,f1,m1,h1,a1,Xu,aa,Te,ve,ds,Qo,ls,na,cs,ti,Cu,wu,Wi,Wt,_u,ju,Et,Di,Ti,ui,Rt,pu,fu,mu,Ei,uu,ji,Qn,_i,wi,Oi,xi,du,lu,cu,Ai,ru,hi,Fi,au,zi,iu,ou,Li,su,Pi,tu,Jd,V0,Qd,Ui,Xd,Gd,I,mt,ze,G,Yd,Ji,ea,qd,ct,Kd,$d,Vd,Un,Ld,Po,Nd,Dd,tn,zd,_a,dt,Td,Fd,Lo,gt,Yn,Aa,bt,Ad,Ta,Ce,Gn,Na,yd,md,sd,Ia,re,nd,$a,td,ed,Ka,Jl,es,ts,ns,ss,os,Ja,Zl,pt,hs,sr,or,Ql,ms,Xl,cr,lr,Yl,mr,Ne,J0,gr,vr,br,jr,yr,wo,xr,Wl,ps,s2,ys,vo,Bl,Rl,Ll,Dl,k,Tl,zn,Fl,Ml,Sn,An,kn,Vr,Ye,Sl,fl,ml,hl,ul,ll,cl,ao,rn,rl,nn,nc,Zt,nl,Vt,Jc,Ns,Ft,zt,Dt,Nt,Ht,Yt,Xt,j2,h,cn,bc,Qc,Xc,_c,wc,dn,xc,Gc,Rs,Yc,Ac,kt,qc,Kc,Uc,Wc,$c,Vc,Ks,En,Bc,n1,me,Bs,Nc,Dc,zc,Fc,qs,kc,Cc,yc,jc,Zc,pc,Zs,el,tl,oc,sl,ol,il,al,ec,Qr,Ds,dl,Gr,g,b2,v2,g2,p2,f2,m2,h2,u2,d2,l2,c2,r2,a2,i2,t,v,Ur,r,be,i,zl,oe,Nl,Qe,Fr,vs,$l,d,L,nt,z,xo,Co,We,Ut,l,ce,Wa,p,od,id,ad,rd,cd,ld,dd,ud,hd,Ra,fd,pd,gd,vd,bd,jd,La,_d,yt,$t,qt,Gt,en,Kn,on,an,st,He,Oe,Vn,Ge,X,wn,ge,sa,Cn,ke,Ki,Ln,Rn,Vi,Dn,Tn,Fn,un,it,Q,pe,Me,Pt,Lt,Zn,hu,pi,fi,Tt,bu,u,yu,Bi,Yi,Ou,xu,Xi,Eu,ku,Au,Su,Mu,Fu,Tu,zu,Du,Nu,Lu,Ru,Pu,Hu,Iu,Bu,Vu,$u,Wu,Uu,Ku,qu,Yu,Gu,la,Qu,Zu,Ju,e1,t1,Ic,s1,o1,i1,js,ua,c1,xn,ha,ma,ws,ja,Ca,p1,ka,Fa,St,ut,Cs,Ua,w1,Ya,Es,Ms,dr,Fs,S1,_r,Ts,T1,z1,D1,N1,L1,Or,Cr,N0,Ys,fn,Sr,_o,bi,Mo,Va,Vo,r4,da,ee,Yo,ia,h4,Xo,f4,p4,ei,v4,is,Hi,Ve,_4,w4,V,ci,Mi,er,Ws,li,Ni,ni,Qi,Jo,Zo,ra,ca,Wo,$o,Bo,H4,I4,B4,Io,Wn,W4,wt,K4,q4,_0,G4,Da,Q4,Z4,J4,j0,c0,r0,Ha,j4,Pr,H1,Ir,u1,d1,l1,tt,cc,Zd,At,lc,Rd,Md,Sd,kd,Ed,dc,mc,Gl,fc,Kl,Ul,e,sn,Hl,Pl,Al,Ls,El,Cl,Xs,_n,yl,Sc,bl,vl,gl,H,v0="image",$s=class{embedded=!0;uri;type=v0;maxWidth;maxHeight;maxArea;supportsAnyRegionAndSize;width;height;majorVersion;constructor(...t){const e=t[0],n=t[1];if(t.length===2){const n=t[0];let e,s;if(Array.isArray(n.service)?n.service.forEach(t=>{try{const n=p0(t);(!s||n>s)&&(s=n,e=t)}catch{}}):e=n.service,!e)throw new Error("Unsupported IIIF Image Service");if("@id"in e)this.uri=e["@id"];else if("id"in e)this.uri=e.id;else throw new Error("Unsupported IIIF Image Service");if("type"in e&&e.type==="ImageService3")this.majorVersion=3;else if("type"in e&&e.type==="ImageService2"||"@type"in e&&e["@type"]==="ImageService2"||"@context"in e&&e["@context"]===Ms)this.majorVersion=2;else if("@context"in e&&(e["@context"]===xn||e["@context"]===ha))this.majorVersion=1;else if("profile"in e){let t;if(Array.isArray(e.profile)&&e.profile.length>0)t=e.profile[0];else if(typeof e.profile=="string")t=e.profile;else throw new Error("Unsupported IIIF Image Service");t.match(js)?this.majorVersion=1:t.match(Cs)?this.majorVersion=2:this.majorVersion=3}else throw new Error("Unsupported IIIF Image Service");if("profile"in e){const t=Ba(e);this.supportsAnyRegionAndSize=t.supportsAnyRegionAndSize,this.maxWidth=t.maxWidth,this.maxHeight=t.maxHeight,this.maxArea=t.maxArea}else this.supportsAnyRegionAndSize=!1}else{if("@id"in e)this.uri=e["@id"];else if("id"in e)this.uri=e.id;else throw new Error("Unsupported IIIF Image");if("type"in e&&e.type==="ImageService3")this.majorVersion=3;else if("@type"in e&&e["@type"]==="iiif:Image"||"@context"in e&&e["@context"]===Ms)this.majorVersion=2;else if("@context"in e&&e["@context"]===xn)this.majorVersion=1;else throw new Error("Unsupported IIIF Image");if("profile"in e){const t=Ba(e);this.supportsAnyRegionAndSize=t.supportsAnyRegionAndSize,this.maxWidth=t.maxWidth,this.maxHeight=t.maxHeight,this.maxArea=t.maxArea}else this.supportsAnyRegionAndSize=!1}if(e.width!==0[0])this.width=e.width;else if(n)this.width=n.width;else throw new Error("Width not present on either Canvas or Image Resource");if(e.height!==0[0])this.height=e.height;else if(n)this.height=n.height;else throw new Error("Height not present on either Canvas or Image Resource")}getImageUrl(e){const{region:n,size:o}=e;let s,t,i,a,r;n?(r=`${n.x},${n.y},${n.width},${n.height}`,i=n.height,a=n.width):(r="full",i=this.height,a=this.width);let c;if(o){s=Math.round(o.width),t=Math.round(o.height);const r=String(s);let e=String(t);const n=a/i,l=t*n,d=l/n;this.majorVersion<=2&&t===Math.round(d)&&(e=""),c=`${r},${e}`}else s=this.width,t=this.height,c=this.majorVersion===2?"full":"max";const l=s*t;if(this.maxWidth!==0[0]&&s>this.maxWidth)throw new Error(`Width of requested image is too large: ${s} > ${this.maxWidth}`);if(this.maxHeight!==0[0]&&t>this.maxHeight)throw new Error(`Height of requested image is too large: ${t} > ${this.maxHeight}`);if(this.maxArea!==0[0]&&l>this.maxArea)throw new Error(`Area of requested image is too large: ${l} > ${this.maxArea}`);const d=this.majorVersion===1?"native":"default";return`${this.uri}/${r}/${c}/0/${d}.jpg`}getImageRequest(e,t="cover"){return a0({width:this.width,height:this.height},e,t,{supportsAnyRegionAndSize:this.supportsAnyRegionAndSize,maxWidth:this.maxWidth,maxHeight:this.maxHeight,maxArea:this.maxArea})}},rs=class _Image extends $s{tileZoomLevels;sizes;embedded=!1;constructor(e){super(e);const n=Ba(e);let t;"tiles"in e&&(t=e.tiles),this.tileZoomLevels=d0({width:this.width,height:this.height},t,n.supportsAnyRegionAndSize),"sizes"in e&&(this.sizes=e.sizes)}static parse(e,t=null){let n;return t===1?n=ws.parse(e):t===2?n=Fs.parse(e):t===3?n=Ts.parse(e):n=q4.parse(e),new _Image(n)}getTileImageRequest(e,t,n){return t0({width:this.width,height:this.height},e,t,n)}getImageRequest(e,t="cover"){return a0({width:this.width,height:this.height},e,t,{supportsAnyRegionAndSize:this.supportsAnyRegionAndSize,sizes:this.sizes,tileZoomLevels:this.tileZoomLevels,maxWidth:this.maxWidth,maxHeight:this.maxHeight,maxArea:this.maxArea})}},y0="canvas",Y4=class{uri;type=y0;height;width;image;label;description;metadata;navDate;navPlace;homepage;thumbnail;rendering;seeAlso;summary;requiredStatement;annotations;constructor(e){if(this.width=e.width,this.height=e.height,"@id"in e)this.uri=e["@id"],this.description=q(e.description),this.label=q(e.label),this.metadata=Tr(e.metadata),this.navDate=e.navDate,this.navPlace=e.navPlace,this.requiredStatement=Kr(e.attribution),this.thumbnail=Xr(e.thumbnail),this.rendering=Zr(e.rendering),this.homepage=ac(e.related),this.image=new $s(e.images[0].resource,e);else if("id"in e){this.uri=e.id,this.label=Be(e.label),this.description=Be(e.description),this.metadata=fo(e.metadata),this.navDate=e.navDate,this.navPlace=e.navPlace,this.homepage=e.homepage,this.thumbnail=e.thumbnail,this.rendering=e.rendering,this.seeAlso=e.seeAlso,this.summary=e.summary,this.requiredStatement=e.requiredStatement,this.annotations=e.annotations;const t=e.items[0].items[0].body;let n;if(Array.isArray(t))n=t[0];else if(t.type==="Image")n=t;else if(t.type==="Choice")n=t.items[0];else throw new Error("Invalid IIIF Canvas");this.image=new $s(n,e)}else throw new Error("Invalid IIIF Canvas")}},w0="manifest",us=class{embedded=!0;uri;type=w0;label;majorVersion;constructor(e){if("@type"in e)this.uri=e["@id"],this.majorVersion=2,this.label=q(e.label);else if("type"in e)this.uri=e.id,this.majorVersion=3,this.label=Be(e.label);else throw new Error("Unsupported Manifest")}},Qt=class _Manifest extends us{canvases=[];description;metadata;navDate;navPlace;homepage;thumbnail;rendering;seeAlso;summary;requiredStatement;annotations;embedded=!1;constructor(e){if(super(e),"@type"in e){this.description=q(e.description),this.metadata=Tr(e.metadata);const t=e.sequences[0];this.canvases=t.canvases.map(e=>new Y4(e)),this.navDate=e.navDate,this.navPlace=e.navPlace,this.requiredStatement=Kr(e.attribution),this.thumbnail=Xr(e.thumbnail),this.rendering=Zr(e.rendering),this.homepage=ac(e.related)}else if("type"in e)this.description=Be(e.description),this.metadata=fo(e.metadata),this.metadata=fo(e.metadata),this.navDate=e.navDate,this.navPlace=e.navPlace,this.homepage=e.homepage,this.thumbnail=e.thumbnail,this.rendering=e.rendering,this.seeAlso=e.seeAlso,this.summary=e.summary,this.requiredStatement=e.requiredStatement,this.annotations=e.annotations,this.canvases=e.items.map(e=>new Y4(e));else throw new Error("Unsupported Manifest")}static parse(e,t=null){let n;return t===2?n=is.parse(e):t===3?n=Wn.parse(e):n=G4.parse(e),new _Manifest(n)}get images(){return this.canvases.map(e=>e.image)}async#fetchImage(e,t){if(e instanceof $s){const n=`${e.uri}/info.json`,s=await t(n).then(e=>e.json()),o=rs.parse(s);return o}return e}async fetchAll(e=globalThis.fetch){const t=[];for await(const n of this.fetchNext(e))t.push(n);return t}async*fetchNext(e=globalThis.fetch,t=0){for(const n of this.canvases){const s=await this.#fetchImage(n.image,e);n.image=s,yield{item:s,depth:t,parent:{uri:this.uri,type:this.type}}}}async fetchImageByUri(e,t=globalThis.fetch){for(const n of this.canvases)if(n.image.uri===e){const e=await this.#fetchImage(n.image,t);return n.image=e,e}}},C0="collection",fs={maxDepth:Number.POSITIVE_INFINITY,fetchCollections:!0,fetchManifests:!0,fetchImages:!1,fetchFn:globalThis.fetch},Nr=class{uri;type=C0;majorVersion;label;embedded=!0;constructor(e){if("@type"in e)this.uri=e["@id"],this.majorVersion=2,this.label=q(e.label);else if("type"in e)this.uri=e.id,this.majorVersion=3,this.label=Be(e.label);else throw new Error("Unsupported Collection")}static parse(e,t=null){let n;return t===2?n=Ve.parse(e):t===3?n=wt.parse(e):n=Da.parse(e),new ho(n)}},ho=class _Collection extends Nr{items=[];embedded=!1;description;metadata;navDate;navPlace;homepage;thumbnail;rendering;seeAlso;summary;requiredStatement;annotations;constructor(e){if(super(e),"@type"in e){this.description=q(e.description),this.label=q(e.label),this.metadata=Tr(e.metadata),this.navDate=e.navDate,this.navPlace=e.navPlace,this.requiredStatement=Kr(e.attribution),this.thumbnail=Xr(e.thumbnail),this.rendering=Zr(e.rendering),this.homepage=ac(e.related);const t="manifests"in e&&e.manifests?e.manifests:[],n="collections"in e&&e.collections?e.collections:[],s="members"in e&&e.members?e.members:[],o=[...t,...n,...s];this.items=o.map(e=>e["@type"]==="sc:Collection"?new _Collection(e):new us(e))}else if("type"in e)this.description=Be(e.description),this.metadata=fo(e.metadata),this.navDate=e.navDate,this.navPlace=e.navPlace,this.homepage=e.homepage,this.thumbnail=e.thumbnail,this.rendering=e.rendering,this.seeAlso=e.seeAlso,this.summary=e.summary,this.requiredStatement=e.requiredStatement,this.annotations=e.annotations,"items"in e&&(this.items=e.items.map(e=>e.type==="Collection"?"items"in e?new _Collection(e):(e,new Nr(e)):new us(e)));else throw new Error("Unsupported Collection")}static parse(e,t=null){let n;return t===2?n=Ve.parse(e):t===3?n=wt.parse(e):n=Da.parse(e),new _Collection(n)}get canvases(){const e=[];return this.items.reduce((e,t)=>t instanceof Qt?[...e,...t.canvases]:t instanceof us?e:t instanceof _Collection?[...e,...t.canvases]:e,e)}get images(){return this.canvases.map(e=>e.image)}async fetchAll(e){const t=[];for await(const n of this.fetchNext(e))t.push(n);return t}async*fetchNext(e,t=0){if(e={...fs,...e},Number.isNaN(e.maxDepth))return;e.maxDepth===0[0]&&(e.maxDepth=fs.maxDepth),e.fetchImages===0[0]&&(e.fetchImages=fs.fetchImages),e.fetchManifests===0[0]&&(e.fetchManifests=fs.fetchManifests);let n=fs.fetchFn;if(e.fetchFn&&(n=e.fetchFn),t>=e.maxDepth)return;for(const o in this.items){let s=this.items[o];if(s instanceof Qt)e.fetchImages&&(yield*s.fetchNext(n,t+1));else if(s instanceof us&&e.fetchManifests){const a=s.uri,r=await n(a).then(e=>e.json()),i=Qt.parse(r);this.items[o]=i,yield{item:i,depth:t+1,parent:{uri:this.uri,type:this.type}},t+1<e.maxDepth&&e.fetchImages&&(yield*i.fetchNext(n,t+2))}else if(s instanceof Nr&&e.fetchCollections){const a=s.uri,r=await n(a).then(e=>e.json()),i=_Collection.parse(r);this.items[o]=i,yield{item:i,depth:t+1,parent:{uri:this.uri,type:this.type}},s=i,t+1<e.maxDepth&&(yield*i.fetchNext(e,t+2))}}}},S0=class{static parse(e,t=null){if(e&&typeof e=="object"){if(t===1||"@context"in e&&e["@context"]===xn){const t=ws.parse(e);return new rs(t)}if(t===2||"@id"in e){{if("protocol"in e&&e.protocol==="http://iiif.io/api/image"){const t=Fs.parse(e);return new rs(t)}if("@type"in e&&e["@type"]==="sc:Manifest"){const t=is.parse(e);return new Qt(t)}if("@type"in e&&e["@type"]==="sc:Collection"){const t=Ve.parse(e);return new ho(t)}}}else if(t===3||"id"in e){if("protocol"in e&&e.protocol==="http://iiif.io/api/image"){const t=Ts.parse(e);return new rs(t)}if("type"in e&&e.type==="Manifest"){const t=Wn.parse(e);return new Qt(t)}if("type"in e&&e.type==="Collection"){const t=wt.parse(e);return new ho(t)}}}throw new Error("Invalid IIIF data or unsupported IIIF type")}},{slice:M0,forEach:F0}=[];function T0(e){return F0.call(M0.call(arguments,1),t=>{if(t)for(const n in t)e[n]===0[0]&&(e[n]=t[n])}),e}function z0(e){if(typeof e!="string")return!1;const t=[/<\s*script.*?>/i,/<\s*\/\s*script\s*>/i,/<\s*img.*?on\w+\s*=/i,/<\s*\w+\s*on\w+\s*=.*?>/i,/javascript\s*:/i,/vbscript\s*:/i,/expression\s*\(/i,/eval\s*\(/i,/alert\s*\(/i,/document\.cookie/i,/document\.write\s*\(/i,/window\.location/i,/innerHTML/i];return t.some(t=>t.test(e))}Pr=/^[\u0009\u0020-\u007e\u0080-\u00ff]+$/,H1=function(e,t){let o=arguments.length>2&&arguments[2]!==0[0]?arguments[2]:{path:"/"};const n=o,i=encodeURIComponent(t);let s=`${e}=${i}`;if(n.maxAge>0){const e=n.maxAge-0;if(Number.isNaN(e))throw new Error("maxAge should be a Number");s+=`; Max-Age=${Math.floor(e)}`}if(n.domain){if(!Pr.test(n.domain))throw new TypeError("option domain is invalid");s+=`; Domain=${n.domain}`}if(n.path){if(!Pr.test(n.path))throw new TypeError("option path is invalid");s+=`; Path=${n.path}`}if(n.expires){if(typeof n.expires.toUTCString!="function")throw new TypeError("option expires is invalid");s+=`; Expires=${n.expires.toUTCString()}`}if(n.httpOnly&&(s+="; HttpOnly"),n.secure&&(s+="; Secure"),n.sameSite){const e=typeof n.sameSite=="string"?n.sameSite.toLowerCase():n.sameSite;switch(e){case!0:s+="; SameSite=Strict";break;case"lax":s+="; SameSite=Lax";break;case"strict":s+="; SameSite=Strict";break;case"none":s+="; SameSite=None";break;default:throw new TypeError("option sameSite is invalid")}}return n.partitioned&&(s+="; Partitioned"),s},Ir={create(e,t,n,s){let o=arguments.length>4&&arguments[4]!==0[0]?arguments[4]:{path:"/",sameSite:"strict"};n&&(o.expires=new Date,o.expires.setTime(o.expires.getTime()+n*60*1e3)),s&&(o.domain=s),document.cookie=H1(e,t,o)},read(e){const t=`${e}=`,n=document.cookie.split(";");for(let s=0;s<n.length;s++){let e=n[s];for(;e.charAt(0)===" ";)e=e.substring(1,e.length);if(e.indexOf(t)===0)return e.substring(t.length,e.length)}return null},remove(e,t){this.create(e,"",-1,t)}},u1={name:"cookie",lookup(e){let{lookupCookie:t}=e;return t&&typeof document!="undefined"?Ir.read(t)||0[0]:0[0]},cacheUserLanguage(e,t){let{lookupCookie:n,cookieMinutes:s,cookieDomain:o,cookieOptions:i}=t;n&&typeof document!="undefined"&&Ir.create(n,e,s,o,i)}},d1={name:"querystring",lookup(e){let{lookupQuerystring:n}=e,t;if(typeof window!="undefined"){let{search:s}=window.location;!window.location.search&&window.location.hash?.indexOf("?")>-1&&(s=window.location.hash.substring(window.location.hash.indexOf("?")));const o=s.substring(1),e=o.split("&");for(let s=0;s<e.length;s++){const o=e[s].indexOf("=");if(o>0){const i=e[s].substring(0,o);i===n&&(t=e[s].substring(o+1))}}}return t}},l1={name:"hash",lookup(e){let{lookupHash:s,lookupFromHashIndex:n}=e,t;if(typeof window!="undefined"){const{hash:e}=window.location;if(e&&e.length>2){const o=e.substring(1);if(s){const e=o.split("&");for(let n=0;n<e.length;n++){const o=e[n].indexOf("=");if(o>0){const i=e[n].substring(0,o);i===s&&(t=e[n].substring(o+1))}}}if(t)return t;if(!t&&n>-1){const t=e.match(/\/([a-zA-Z-]*)/g);if(!Array.isArray(t))return 0[0];const s=typeof n=="number"?n:0;return t[s]?.replace("/","")}}}return t}},tt=null,cc=()=>{if(tt!==null)return tt;try{if(tt=typeof window!="undefined"&&window.localStorage!==null,!tt)return!1;const e="i18next.translate.boo";window.localStorage.setItem(e,"foo"),window.localStorage.removeItem(e)}catch{tt=!1}return tt},Zd={name:"localStorage",lookup(e){let{lookupLocalStorage:t}=e;return t&&cc()?window.localStorage.getItem(t)||0[0]:0[0]},cacheUserLanguage(e,t){let{lookupLocalStorage:n}=t;n&&cc()&&window.localStorage.setItem(n,e)}},At=null,lc=()=>{if(At!==null)return At;try{if(At=typeof window!="undefined"&&window.sessionStorage!==null,!At)return!1;const e="i18next.translate.boo";window.sessionStorage.setItem(e,"foo"),window.sessionStorage.removeItem(e)}catch{At=!1}return At},Rd={name:"sessionStorage",lookup(e){let{lookupSessionStorage:t}=e;return t&&lc()?window.sessionStorage.getItem(t)||0[0]:0[0]},cacheUserLanguage(e,t){let{lookupSessionStorage:n}=t;n&&lc()&&window.sessionStorage.setItem(n,e)}},Md={name:"navigator",lookup(){const t=[];if(typeof navigator!="undefined"){const{languages:e,userLanguage:n,language:s}=navigator;if(e)for(let n=0;n<e.length;n++)t.push(e[n]);n&&t.push(n),s&&t.push(s)}return t.length>0?t:0[0]}},Sd={name:"htmlTag",lookup(e){let{htmlTag:s}=e,n;const t=s||(typeof document!="undefined"?document.documentElement:null);return t&&typeof t.getAttribute=="function"&&(n=t.getAttribute("lang")),n}},kd={name:"path",lookup(e){let{lookupFromPathIndex:t}=e;if(typeof window=="undefined")return 0[0];const n=window.location.pathname.match(/\/([a-zA-Z-]*)/g);if(!Array.isArray(n))return 0[0];const s=typeof t=="number"?t:0;return n[s]?.replace("/","")}},Ed={name:"subdomain",lookup(e){let{lookupFromSubdomainIndex:t}=e;const s=typeof t=="number"?t+1:1,n=typeof window!="undefined"&&window.location?.hostname?.match(/^(\w{2,5})\.(([a-z0-9-]{1,63}\.[a-z]{2,6})|localhost)/i);return n?n[s]:0[0]}},dc=!1;try{document.cookie,dc=!0}catch{}mc=["querystring","cookie","localStorage","sessionStorage","navigator","htmlTag"],dc||mc.splice(1,1),Gl=()=>({order:mc,lookupQuerystring:"lng",lookupCookie:"i18next",lookupLocalStorage:"i18nextLng",lookupSessionStorage:"i18nextLng",caches:["localStorage"],excludeCacheFor:["cimode"],convertDetectedLanguage:e=>e}),fc=class{constructor(e){let t=arguments.length>1&&arguments[1]!==0[0]?arguments[1]:{};this.type="languageDetector",this.detectors={},this.init(e,t)}init(){let e=arguments.length>0&&arguments[0]!==0[0]?arguments[0]:{languageUtils:{}},t=arguments.length>1&&arguments[1]!==0[0]?arguments[1]:{},n=arguments.length>2&&arguments[2]!==0[0]?arguments[2]:{};this.services=e,this.options=T0(t,this.options||{},Gl()),typeof this.options.convertDetectedLanguage=="string"&&this.options.convertDetectedLanguage.indexOf("15897")>-1&&(this.options.convertDetectedLanguage=e=>e.replace("-","_")),this.options.lookupFromUrlIndex&&(this.options.lookupFromPathIndex=this.options.lookupFromUrlIndex),this.i18nOptions=n,this.addDetector(u1),this.addDetector(d1),this.addDetector(Zd),this.addDetector(Rd),this.addDetector(Md),this.addDetector(Sd),this.addDetector(kd),this.addDetector(Ed),this.addDetector(l1)}addDetector(e){return this.detectors[e.name]=e,this}detect(){let t=arguments.length>0&&arguments[0]!==0[0]?arguments[0]:this.options.order,e=[];return t.forEach(t=>{if(this.detectors[t]){let n=this.detectors[t].lookup(this.options);n&&typeof n=="string"&&(n=[n]),n&&(e=e.concat(n))}}),e=e.filter(e=>e!=null&&!z0(e)).map(e=>this.options.convertDetectedLanguage(e)),this.services&&this.services.languageUtils&&this.services.languageUtils.getBestMatchFromCodes?e:e.length>0?e[0]:null}cacheUserLanguage(e){let t=arguments.length>1&&arguments[1]!==0[0]?arguments[1]:this.options.caches;if(!t)return;if(this.options.excludeCacheFor&&this.options.excludeCacheFor.indexOf(e)>-1)return;t.forEach(t=>{this.detectors[t]&&this.detectors[t].cacheUserLanguage(e,this.options)})}},fc.type="languageDetector",Kl=class extends HTMLElement{constructor(){super(),this.degree=0,this.step=1,this.displayDegrees=!0,this.radius=75,this._disabled=!1,this.handleElement=null,this.styleElement=null,this.isDragging=!1,this.startX=0,this.startY=0,this.handleMouseDown=e=>{if(this._disabled||!this.handleElement)return;this.isDragging=!0,this.startX=e.clientX,this.startY=e.clientY,e.preventDefault(),this.handleElement&&(this.handleElement.style.cursor="grabbing"),document.body.style.cursor="grabbing",document.addEventListener("mousemove",this.handleMouseMove),document.addEventListener("mouseup",this.handleMouseUp)},this.handleMouseMove=e=>{if(!this.isDragging||this._disabled)return;const s=this.shadow.querySelector(".circle");if(!s)return;const t=s.getBoundingClientRect(),o=t.left+t.width/2,i=t.top+t.height/2,a=e.clientX-o,r=e.clientY-i;let n=Math.atan2(a,-r)*(180/Math.PI);n<0&&(n+=360),this.degree=Math.round(n/this.step)*this.step,this.updateHandlePosition()},this.handleMouseUp=()=>{this.isDragging&&this.handleElement&&(this.isDragging=!1,this.handleElement.style.cursor="grab",document.body.style.cursor="default",document.removeEventListener("mousemove",this.handleMouseMove),document.removeEventListener("mouseup",this.handleMouseUp))},this.shadow=this.attachShadow({mode:"open"}),this.render()}static get observedAttributes(){return["step","display-degrees","radius","value","disabled"]}attributeChangedCallback(e,t,n){if(e==="step"&&n!==null)this.step=parseInt(n,10)||1;else if(e==="display-degrees")this.displayDegrees=n!=="false";else if(e==="radius"&&n!==null)this.radius=parseInt(n,10)||75,this.updateRadius();else if(e==="value"&&n!==null)this.degree=parseInt(n,10)||0,this.updateHandlePosition();else if(e==="disabled"){const e=n!==null;this._disabled!==e&&(this._disabled=e,this.updateDisabledState())}this.updateDisplay()}render(){this.shadow.innerHTML=`
      <style id="dynamic-styles">
        :host {
          --control-handle-color: #007bff;
          --handle-color: ${this._disabled?"var(--control-disabled-color)":"var(--control-handle-color)"};
          --rotating-input-container-margin: 20px auto;
          --disabled-opacity: .6;
          --control-circle-color: #ccc;
          --control-circle-border: 2px solid var(--control-circle-color);
        }

        :host(.disabled) {
          opacity: var(--disabled-opacity);
          pointer-events: none;
        }

        .rotating-input-container {
          position: relative;
          width: ${2*this.radius}px;
          height: ${2*this.radius}px;
          margin: var(--rotating-input-container-margin);
          user-select: none;
        }

        .circle {
          width: ${2*this.radius}px;
          height: ${2*this.radius}px;
          border-radius: 50%;
          border: var(--control-circle-border);
          position: relative;
          opacity: ${this._disabled?"0.6":"var(--disabled-opacity)"};
          cursor: ${this._disabled?"not-allowed":"default"};
        }

        .handle {
          position: absolute;
          width: 20px;
          height: 20px;
          background-color: var(--handle-color);
          border-radius: 50%;
          top: 0;
          left: 50%;
          transform: translate(-50%, -50%);
          cursor: ${this._disabled?"not-allowed":"grab"};
        }

        .degree-display {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          font-size: 16px;
          color: ${this._disabled?"#999":""};
        }
      </style>
      <div class="rotating-input-container">
        <div class="circle">
          <div class="handle"></div>
        </div>
        <div class="degree-display">0\xB0</div>
      </div>
    `,this.handleElement=this.shadow.querySelector(".handle"),this.styleElement=this.shadow.querySelector("#dynamic-styles"),this.updateDisplay(),this.updateHandlePosition(),this.setupEventListeners(),this.updateDisabledState()}updateRadius(){const e=this.shadow.querySelector(".rotating-input-container"),t=this.shadow.querySelector(".circle");e&&t&&(e.style.width=`${2*this.radius}px`,e.style.height=`${2*this.radius}px`,t.style.width=`${2*this.radius}px`,t.style.height=`${2*this.radius}px`,this.updateHandlePosition())}setupEventListeners(){this.handleElement&&(this.handleElement.addEventListener("mousedown",this.handleMouseDown),this.handleElement.addEventListener("dragstart",e=>e.preventDefault()))}removeEventListeners(){this.handleElement&&this.handleElement.removeEventListener("mousedown",this.handleMouseDown),document.removeEventListener("mousemove",this.handleMouseMove),document.removeEventListener("mouseup",this.handleMouseUp)}updateHandlePosition(){if(!this.handleElement)return;const e=this.radius*Math.sin(this.degree*(Math.PI/180)),t=-this.radius*Math.cos(this.degree*(Math.PI/180));this.handleElement.style.left=`${this.radius+e}px`,this.handleElement.style.top=`${this.radius+t}px`,this.updateDisplay(),this.dispatchEvent(new CustomEvent("degreeChange",{detail:{degree:this.degree}}))}updateDisplay(){const e=this.shadow.querySelector(".degree-display");e&&(this.displayDegrees?(e.textContent=`${Math.round(this.degree)}\xB0`,e.style.display="block",e.style.color=this._disabled?"#999":""):e.style.display="none")}updateDisabledState(){const e=this.shadow.querySelector(".circle"),t=this.shadow.querySelector(".handle");e&&(e.style.opacity=this._disabled?"0.6":"1",e.style.cursor=this._disabled?"not-allowed":"default"),t&&(t.style.cursor=this._disabled?"not-allowed":"grab"),this.styleElement&&(this.styleElement.textContent=`
        :host {
          --control-handle-color: #007bff;
          --handle-color: ${this._disabled?"var(--control-disabled-color)":"var(--control-handle-color)"};
          --rotating-input-container-margin: 20px auto;
          --disabled-opacity: .6;
          --control-circle-color: #ccc;
          --control-circle-border: 2px solid var(--control-circle-color);
        }

        .rotating-input-container {
          position: relative;
          width: ${2*this.radius}px;
          height: ${2*this.radius}px;
          margin: 20px auto;
          user-select: none;
        }

        .circle {
          width: ${2*this.radius}px;
          height: ${2*this.radius}px;
          border-radius: 50%;
          border: var(--control-circle-border);
          position: relative;
          opacity: ${this._disabled?"var(--disabled-opacity)":"1"};
          cursor: ${this._disabled?"not-allowed":"default"};
        }

        .handle {
          position: absolute;
          width: 20px;
          height: 20px;
          background-color: var(--handle-color);
          border-radius: 50%;
          top: 0;
          left: 50%;
          transform: translate(-50%, -50%);
          cursor: ${this._disabled?"not-allowed":"grab"};
        }

        .degree-display {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          font-size: 16px;
          color: ${this._disabled?"#999":""};
        }
      `),!this._disabled&&this.handleElement?this.handleElement.addEventListener("mousedown",this.handleMouseDown):this._disabled&&(this.removeEventListeners(),this.isDragging=!1,document.body.style.cursor="default",this.handleElement&&(this.handleElement.style.cursor="not-allowed"))}get value(){return this.degree}set value(e){this.degree=e,this.updateHandlePosition()}get disabled(){return this._disabled}set disabled(e){this._disabled=e,e?this.setAttribute("disabled",""):this.removeAttribute("disabled"),this.updateDisabledState()}},Ul=class extends HTMLElement{static get observedAttributes(){return["min","max","step","value-min","value-max","disabled"]}constructor(){super(),this.sliderMin=null,this.sliderMax=null,this.rangeFill=null,this.trackContainer=null,this._min=0,this._max=100,this._step=1,this._valueMin=25,this._valueMax=75,this._disabled=!1,this.handleMinInput=e=>{if(this._disabled)return;const t=e.target;this.valueMin=parseFloat(t.value),this.dispatchInputEvent()},this.handleMaxInput=e=>{if(this._disabled)return;const t=e.target;this.valueMax=parseFloat(t.value),this.dispatchInputEvent()},this.shadow=this.attachShadow({mode:"open"}),this.setupDOM(),this.applyStyling()}connectedCallback(){this.initializeSliders(),this.addEventListeners(),this.updateVisuals()}disconnectedCallback(){this.removeEventListeners()}attributeChangedCallback(e,t,n){if(t===n)return;let s=!1;switch(e){case"min":case"max":case"step":e==="min"&&(this.min=parseFloat(n??"0")),e==="max"&&(this.max=parseFloat(n??"100")),e==="step"&&(this.step=parseFloat(n??"1")),s=!0;break;case"value-min":this.valueMin=parseFloat(n??String(this._min));break;case"value-max":this.valueMax=parseFloat(n??String(this._max));break;case"disabled":this.disabled=n!==null&&n!=="false";break}s&&this.isConnected&&(this.initializeSliders(),this.updateVisuals())}get min(){return this._min}set min(e){const t=isNaN(e)?0:e;this._min!==t&&(this._min=t)}get max(){return this._max}set max(e){const t=isNaN(e)?100:e;this._max!==t&&(this._max=t)}get step(){return this._step}set step(e){const t=isNaN(e)||e<=0?1:e;this._step!==t&&(this._step=t)}get valueMin(){return this._valueMin}set valueMin(e){if(isNaN(e))return;let t=Math.min(Math.max(e,this._min),this._max);t=Math.min(t,this._valueMax),this._valueMin!==t?(this._valueMin=t,this.isConnected&&(this.sliderMin&&(this.sliderMin.value=String(t)),this.updateAttribute("value-min",String(t)),this.updateVisuals(),this.dispatchChangeEvent(),this.dispatchInputEvent())):this.isConnected&&this.sliderMin&&parseFloat(this.sliderMin.value)!==t&&(this.sliderMin.value=String(t))}get valueMax(){return this._valueMax}set valueMax(e){if(isNaN(e))return;let t=Math.min(Math.max(e,this._min),this._max);t=Math.max(t,this._valueMin),this._valueMax!==t?(this._valueMax=t,this.isConnected&&(this.sliderMax&&(this.sliderMax.value=String(t)),this.updateAttribute("value-max",String(t)),this.updateVisuals(),this.dispatchChangeEvent(),this.dispatchInputEvent())):this.isConnected&&this.sliderMax&&parseFloat(this.sliderMax.value)!==t&&(this.sliderMax.value=String(t))}get disabled(){return this._disabled}set disabled(e){const t=!!e;this._disabled!==t&&(this._disabled=t,this.applyStyling(),this.updateDisabledState(),this.updateAttribute("disabled",String(t)))}setupDOM(){this.shadow.innerHTML=`
      <div class="wrapper">
        <div class="track-container">
          <div id="range-fill"></div>
          <input type="range" id="slider-min" aria-label="Minimum Value"/>
          <input type="range" id="slider-max" aria-label="Maximum Value"/>
        </div>
      </div>
    `,this.sliderMin=this.shadow.getElementById("slider-min"),this.sliderMax=this.shadow.getElementById("slider-max"),this.rangeFill=this.shadow.getElementById("range-fill"),this.trackContainer=this.shadow.querySelector(".track-container"),(!this.sliderMin||!this.sliderMax||!this.rangeFill||!this.trackContainer)&&console.error("DualRangeSlider: Failed to find essential elements in Shadow DOM!")}applyStyling(){const e=document.createElement("style");e.textContent=`
        :host {
          display: inline-block;
          width: 300px;
          height: auto;
          padding: 5px 0;
          --track-height: 6px;
          --thumb-size: 16px;
          --fill-color: ${this._disabled?"var(--control-disabled-color)":"var(--control-fill-color)"};
          --control-track-color: #ddd;
          --thumb-color: ${this._disabled?"var(--control-disabled-color)":"var(--control-thumb-color)"};
          --thumb-hover-color: ${this._disabled?"var(--control-disabled-color)":"var(--control-thumb-hover-color)"};
          --thumb-active-color: ${this._disabled?"var(--control-disabled-color)":"var(--control-thumb-active-color)"};
          --disabled-opacity: .6;
        }

        :host(.disabled) {
          opacity: var(--disabled-opacity);
          pointer-events: none;
        }

        .wrapper {
          position: relative;
        }
        .track-container {
          position: relative;
          width: ${this.isVertical()?"var(--thumb-size)":"100%"};
          height: ${this.isVertical()?"100%":"var(--thumb-size)"};
          display: flex;
          align-items: center;
          ${this.isVertical()?"flex-direction: column;":""};
        }
        .track-container::before {
          content: '';
          position: absolute;
          left: ${this.isVertical()?"50%":"0"};
          right: ${this.isVertical()?"auto":"0"};
          top: ${this.isVertical()?"0":"50%"};
          bottom: ${this.isVertical()?"auto":"0"};
          transform: ${this.isVertical()?"translateX(-50%)":"translateY(-50%)"};
          width: ${this.isVertical()?"var(--track-height)":"100%"};
          height: ${this.isVertical()?"100%":"var(--track-height)"};
          background-color: var(--control-track-color);
          border-radius: calc(var(--track-height) / 2);
          z-index: 1;
          pointer-events: none;
        }
        #range-fill {
          position: absolute;
          width: ${this.isVertical()?"var(--track-height)":"100%"};
          height: ${this.isVertical()?"100%":"var(--track-height)"};
          background-color: var(--fill-color);
          border-radius: calc(var(--track-height) / 2);
          left: ${this.isVertical()?"50%":"0"};
          right: ${this.isVertical()?"auto":"0"};
          top: ${this.isVertical()?"0":"50%"};
          bottom: ${this.isVertical()?"auto":"0"};
          transform: ${this.isVertical()?"translateX(-50%)":"translateY(-50%)"};
          z-index: 2;
          pointer-events: none;
        }
        input[type="range"] {
          position: absolute;
          top: 0;
          left: 0;
          width: ${this.isVertical()?"var(--thumb-size)":"100%"};
          height: ${this.isVertical()?"100%":"var(--thumb-size)"};
          -webkit-appearance: none;
          appearance: none;
          background: transparent;
          margin: 0;
          padding: 0;
          cursor: ${this._disabled?"default":"pointer"};
          z-index: 3;
          pointer-events: none;
          ${this.isVertical()?"writing-mode: vertical-rl;":""};
          ${this.isVertical()&&this.getDirection()==="rtl"?"transform: rotate(180deg);":""};
        }
        input[type="range"]::-webkit-slider-thumb { pointer-events: ${this._disabled?"none":"auto"}; }
        input[type="range"]::-moz-range-thumb { pointer-events: ${this._disabled?"none":"auto"}; }
        input[type="range"]::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: var(--thumb-size);
          height: var(--thumb-size);
          background-color: var(--thumb-color);
          border-radius: 50%;
          border: none;
          cursor: ${this._disabled?"default":"pointer"};
          margin-top: ${this.isVertical()?"0":"calc((var(--thumb-size) - var(--track-height)) / -2 )"};
          margin-left: ${this.isVertical()?"calc((var(--thumb-size) - var(--track-height)) / -2 )":"0"};
          position: relative;
          z-index: 4;
        }
        input[type="range"]:hover::-webkit-slider-thumb { background-color: var(--thumb-hover-color); }
        input[type="range"]:active::-webkit-slider-thumb { background-color: var(--thumb-active-color); }
        input[type="range"]::-moz-range-thumb {
          width: var(--thumb-size);
          height: var(--thumb-size);
          background-color: var(--thumb-color);
          border-radius: 50%;
          border: none;
          cursor: ${this._disabled?"default":"pointer"};
          position: relative;
          z-index: 4;
        }
        input[type="range"]:hover::-moz-range-thumb { background-color: var(--thumb-hover-color); }
        input[type="range"]:active::-moz-range-thumb { background-color: var(--thumb-active-color); }
        input[type="range"]::-moz-range-track { background: transparent; border: none; }
      `,e.textContent+=this.isVertical()?"":"",this.shadow.appendChild(e)}initializeSliders(){if(!this.sliderMin||!this.sliderMax){console.error("Cannot initialize sliders, elements not found.");return}this._min=isNaN(this._min)?0:this._min,this._max=isNaN(this._max)?100:this._max,this._step=isNaN(this._step)||this._step<=0?1:this._step,this._min>this._max&&(console.warn(`Initial min (${this._min}) > max (${this._max}). Swapping them.`),[this._min,this._max]=[this._max,this._min]),this.sliderMin.min=String(this._min),this.sliderMin.max=String(this._max),this.sliderMin.step=String(this._step),this.sliderMax.min=String(this._min),this.sliderMax.max=String(this._max),this.sliderMax.step=String(this._step);const n=this.getAttribute("value-min"),s=this.getAttribute("value-max");let e=n!==null?parseFloat(n):this._valueMin,t=s!==null?parseFloat(s):this._valueMax;e=isNaN(e)?this._min:e,t=isNaN(t)?this._max:t,this._valueMin=e,this._valueMax=t,this.valueMin=e,this.valueMax=t,this.sliderMin.value=String(this._valueMin),this.sliderMax.value=String(this._valueMax),this.updateAttribute("value-min",String(this._valueMin)),this.updateAttribute("value-max",String(this._valueMax)),this.updateDisabledState()}addEventListeners(){if(!this.sliderMin||!this.sliderMax)return;this.sliderMin.addEventListener("input",this.handleMinInput),this.sliderMax.addEventListener("input",this.handleMaxInput)}removeEventListeners(){if(!this.sliderMin||!this.sliderMax)return;this.sliderMin.removeEventListener("input",this.handleMinInput),this.sliderMax.removeEventListener("input",this.handleMaxInput)}updateVisuals(){if(this.rangeFill&&this.trackContainer){const t=this._max-this._min;if(t<=0){this.isVertical()?(this.rangeFill.style.top="0%",this.rangeFill.style.height="0%",this.rangeFill.style.width="var(--track-height)",this.rangeFill.style.left="50%",this.rangeFill.style.transform="translateX(-50%)"):(this.rangeFill.style.left="0%",this.rangeFill.style.width="0%",this.rangeFill.style.height="var(--track-height)",this.rangeFill.style.top="50%",this.rangeFill.style.transform="translateY(-50%)");return}const e=(this._valueMin-this._min)/t*100,n=(this._valueMax-this._min)/t*100;this.isVertical()?(this.rangeFill.style.top=`${Math.max(0,e)}%`,this.rangeFill.style.height=`${Math.min(100,Math.max(0,n-e))}%`,this.rangeFill.style.width="var(--track-height)",this.rangeFill.style.left="50%",this.rangeFill.style.transform="translateX(-50%)"):(this.rangeFill.style.left=`${Math.max(0,e)}%`,this.rangeFill.style.width=`${Math.min(100,Math.max(0,n-e))}%`,this.rangeFill.style.height="var(--track-height)",this.rangeFill.style.top="50%",this.rangeFill.style.transform="translateY(-50%)"),this.sliderMin&&this.sliderMax&&(this.sliderMin.style.zIndex="3",this.sliderMax.style.zIndex="4")}}dispatchChangeEvent(){const e=new CustomEvent("change",{detail:{min:this._valueMin,max:this._valueMax},bubbles:!0,composed:!0});this.dispatchEvent(e)}dispatchInputEvent(){const e=new CustomEvent("input",{detail:{min:this._valueMin,max:this._valueMax},bubbles:!0,composed:!0});this.dispatchEvent(e)}updateAttribute(e,t){this.getAttribute(e)!==t&&this.setAttribute(e,t)}isVertical(){const e=window.getComputedStyle(this);return e.writingMode==="vertical-rl"||e.writingMode==="vertical-lr"}getDirection(){const e=window.getComputedStyle(this);return e.direction}updateDisabledState(){this.sliderMin&&(this.sliderMin.disabled=this._disabled),this.sliderMax&&(this.sliderMax.disabled=this._disabled)}},function(e){e[e.Top=0]="Top",e[e.Bottom=1]="Bottom",e[e.Left=2]="Left",e[e.Right=3]="Right"}(e||(e={})),sn=class{static toString(t){return e[t]}static fromString(t){const s=Object.keys(e);let n;return s.forEach(s=>{typeof e[s]=="string"&&t.toLowerCase()==e[s].toLowerCase()&&(n=s)}),n}},Hl=class _Cuts{constructor(e,t,n){this.shapes={},this.offsets={},this.rotations={},this._show=!1,this.positions={},this.overlay=t,n!==0[0]&&(this.url=n),this.initCutShapes(e)}initCutShapes(e){e.forEach(e=>{const t=this.createLine();t.visible=!1;const n=this.createCover();n.visible=!1,this.shapes[e]=[t,n],this.positions[e]=0[0]})}set url(e){this._url=e}get url(){return this._url!==0[0]?this._url.toString():""}get cutPostions(){return Object.keys(this.shapes)}get calculatedWidth(){let t=this.width;return e.Left in this.positions&&this.positions[e.Left]!==0[0]&&(t=t-this.positions[e.Left]),e.Right in this.positions&&this.positions[e.Right]!==0[0]&&(t=t-(this.width-this.positions[e.Right])),t}get calculatedHeight(){let t=this.height;return e.Top in this.positions&&this.positions[e.Top]!==0[0]&&(t=t-this.positions[e.Top]),e.Bottom in this.positions&&this.positions[e.Bottom]!==0[0]&&(t=t-(this.width-this.positions[e.Bottom])),t}getPosition(t){let n;if(this.positions[t]!==0[0])n=this.positions[t];else if(this.positions[t]===0[0]&&t==e.Right)n=this.width;else if(this.positions[t]===0[0]&&t==e.Left)n=0;else if(this.positions[t]===0[0]&&t==e.Bottom)n=this.height;else if(this.positions[t]===0[0]&&t==e.Top)n=0;else throw new Error("Unknown CutPosition, this should never happen!");return n}square(){const t=[];if(this.lastAxis===0[0])this.height>this.width?t.push({position:e.Bottom,value:this.width}):this.height<this.width&&t.push({position:e.Right,value:this.height});else{const s=this.calculatedWidth,o=this.calculatedHeight;if(o==s)return!1;let n;this.lastAxis==e.Left||this.lastAxis==e.Right?(n=s,this.height<n&&(n=this.height),this.lastAxis==e.Left&&this.width-this.getPosition(e.Left)<n&&(n=this.width-this.getPosition(e.Left)),this.lastAxis==e.Right&&this.getPosition(e.Right)<n&&(n=this.getPosition(e.Right))):this.lastAxis==e.Top||this.lastAxis==e.Bottom?(n=o,this.width<n&&(n=this.width),this.lastAxis==e.Top&&this.width-this.getPosition(e.Top)<n&&(n=this.width-this.getPosition(e.Top)),this.lastAxis==e.Bottom&&this.getPosition(e.Bottom)<n&&(n=this.getPosition(e.Bottom))):this.height>this.width?n=this.width:n=this.height,this.lastAxis==e.Left||this.lastAxis==e.Right?(this.lastAxis==e.Left?t.push({position:e.Right,value:this.getPosition(e.Left)+n}):this.lastAxis==e.Right&&t.push({position:e.Left,value:this.getPosition(e.Right)-n}),this.getPosition(e.Top)+n<=this.height?t.push({position:e.Bottom,value:this.getPosition(e.Top)+n}):(t.push({position:e.Bottom,value:this.height}),t.push({position:e.Top,value:this.height-n}))):(this.lastAxis==e.Top||this.lastAxis==e.Bottom)&&(this.lastAxis==e.Top?t.push({position:e.Bottom,value:this.getPosition(e.Top)+n}):this.lastAxis==e.Bottom&&t.push({position:e.Top,value:this.getPosition(e.Bottom)-n}),this.getPosition(e.Left)+n<=this.width?t.push({position:e.Right,value:this.getPosition(e.Left)+n}):(t.push({position:e.Right,value:this.width}),t.push({position:e.Left,value:this.width-n})))}return!!t.length&&(t.forEach(e=>{this.update(e.position,e.value)}),!0)}createLine(e=5){const t=new gt([0,0,0,0],{strokeWidth:e,stroke:"red",hasControls:!1,visible:!1});return this.overlay.fabricCanvas().add(t),t}createCover(e=.4,t="white"){const n=new Te({left:0,top:0,width:0,height:0,strokeWidth:0,hasControls:!1,opacity:e,fill:t,visible:!1});return this.overlay.fabricCanvas().add(n),n}allPositions(){const n=Object.values(e).filter(e=>typeof e=="number").map(e=>e),t={};return n.forEach(n=>{!(n in this.positions)||this.positions[n]===0[0]?n==e.Top?t[n]=0:n==e.Bottom?this.height!==0[0]?t[n]=this.height:t[n]=0:n==e.Right?this.width!==0[0]?t[n]=this.width:t[n]=0:n==e.Left&&(t[n]=0):t[n]=this.positions[n]}),t}getLine(e){return e in this.positions&&this.shapes[e]!==0[0]?this.shapes[e][0]:0[0]}getCover(e){return e in this.positions&&this.shapes[e]!==0[0]?this.shapes[e][1]:0[0]}setLineWidth(e,t){e in this.positions&&this.shapes[e]!==0[0]&&(this.shapes[e][0].set({strokeWidth:t}),this.shapes[e][0].setCoords(),this.shapes[e][0].canvas?.renderAll())}setVisibility(e){if(e===0[0]&&(e=!this._show),this.shapes!==0[0]){const t=Object.keys(this.shapes);t.forEach(t=>{this.shapes[t]!==0[0]&&(this.shapes[t][0].visible=e,this.shapes[t][1].visible=e,this.shapes[t][1].canvas?.renderAll())})}this._show=e}setSize(t,n){this.width=t,this.height=n;const s=Object.keys(this.positions);s.forEach(s=>{if(this.shapes[s]===0[0])return;const o=this.shapes[s][0],i=this.shapes[s][1];if(s==e.Top)o.set({x1:0,y1:0,x2:t,y2:0}),i.set({left:0,top:0,width:t,height:0});else if(s==e.Bottom)o.set({x1:0,y1:n,x2:t,y2:n}),i.set({left:0,top:n,width:t,height:n});else if(s==e.Right)o.set({x1:t,y1:0,x2:t,y2:n}),i.set({left:t,top:0,width:t,height:n});else if(s==e.Left)o.set({x1:0,y1:0,x2:0,y2:n}),i.set({left:0,top:0,width:0,height:n});else throw new Error("Not a valid position");o.setCoords(),i.setCoords(),o.canvas?.renderAll()})}set offsetX(t){t<0?(this.offsets[e.Left]=t,e.Right in this.offsets&&delete this.offsets[e.Right],this.lastAxis=e.Left):t>0&&(this.offsets[e.Right]=t,e.Left in this.offsets&&delete this.offsets[e.Left],this.lastAxis=e.Right),t!=0&&this.notify()}set offsetY(t){t<0?(this.offsets[e.Top]=t,e.Bottom in this.offsets&&delete this.offsets[e.Bottom],this.lastAxis=e.Top):t>0&&(this.offsets[e.Bottom]=t,e.Top in this.offsets&&delete this.offsets[e.Top],this.lastAxis=e.Bottom),t!=0&&this.notify()}set rotateX(t){this.rotations[e.Right]!=t&&(this.rotations[e.Right]=t,this.notify())}set rotateY(t){this.rotations[e.Bottom]!=t&&(this.rotations[e.Bottom]=t,this.notify())}update(t,n){if(this.shapes[t]===0[0])return;if(this.positions[t]==n)return;t==e.Bottom&&e.Top in this.positions&&this.positions[e.Top]!==0[0]&&this.positions[e.Top]>n?this.positions[e.Top]=n:t==e.Top&&e.Bottom in this.positions&&this.positions[e.Bottom]!==0[0]&&this.positions[e.Bottom]>n?this.positions[e.Bottom]=n:t==e.Right&&e.Left in this.positions&&this.positions[e.Left]!==0[0]&&this.positions[e.Left]>n?this.positions[e.Left]=n:t==e.Left&&e.Right in this.positions&&this.positions[e.Right]!==0[0]&&this.positions[e.Right]<n&&(this.positions[e.Right]=n),this.positions[t]=n;const o=this.shapes[t][0],s=this.shapes[t][1];if(t==e.Bottom||t==e.Top)o.set({x1:0,y1:n,x2:this.width,y2:n}),t==e.Bottom?s.set({left:0,top:n,width:this.width,height:this.height-n}):s.set({left:0,top:0,width:this.width,height:n});else if(t==e.Right||t==e.Left)o.set({x1:n,y1:0,x2:n,y2:this.height}),t==e.Right?s.set({left:n,top:0,width:this.width-n,height:this.height}):s.set({left:0,top:0,width:n,height:this.height});else throw new Error("THis should never happen!");this.lastAxis=t,o.setCoords(),s.setCoords(),o.canvas?.renderAll(),this.notify()}set callback(e){this.changeCallback=[],this.changeCallback.push(e)}addCallback(e){this.changeCallback!==0[0]&&(this.changeCallback=[]),this.changeCallback.push(e)}notify(){this.changeCallback!==0[0]&&this.changeCallback.forEach(e=>{const t=[{}];t[0]=this.allPositions(),this.offsets!==0[0]&&(t[1]=this.offsets),this.rotations!==0[0]&&(t[2]=this.rotations),e(t)})}static expandPositions(t,n=!1){const s={};let o;return n?o=Object.keys(e):o=Object.keys(t),o.forEach(e=>{e in t&&t[e]!==0[0]?s[sn.toString(e)]=t[e]:s[sn.toString(e)]=0}),s}toJSON(){const e={url:this.url,width:this.width,height:this.height},t=_Cuts.expandPositions(this.positions);this.positions!==0[0]&&Object.keys(t).length&&(e.cuts=t);const n=_Cuts.expandPositions(this.offsets);this.offsets!==0[0]&&Object.keys(n).length&&(e.offsets=n);const s=_Cuts.expandPositions(this.rotations);return this.rotations!==0[0]&&Object.keys(s).length&&(e.rotations=s),e}toJSONLD(){const r=`xywh=0,0,${this.width},${this.height}`,o={id:"",motivation:"editing",type:"Annotation",body:{type:"Dataset",id:"",value:{}},target:{source:this.url,type:"SpecificResource",selector:{type:"FragmentSelector",value:r}}},n={},e=_Cuts.expandPositions(this.positions,!0);this.positions!==0[0]&&Object.keys(e).length&&(n.cuts=e);const s=_Cuts.expandPositions(this.offsets,!0);this.offsets!==0[0]&&Object.keys(s).length&&(n.offsets=s);const t=_Cuts.expandPositions(this.rotations,!0);this.rotations!==0[0]&&Object.keys(t).length&&(n.rotations=t),o.body.value=n;let i="";"Bottom"in t&&t.Bottom!==0&&(i+=` rotate(${t.Bottom}, ${Math.ceil(this.width/2)}, ${this.height})`),"Right"in t&&t.Right!==0&&(i+=` rotate(${t.Right}, ${this.width}, ${Math.ceil(this.height/2)})`);let a=`
    <pattern id="pattern" width="${this.width}" height="${this.height}" x="${s.Right}" y="${s.Bottom}">
      <clipPath id="cuts">
        <rect x="${e.Left}" y="${e.Top}" width="${e.Right-e.Left}" height="${e.Bottom-e.Top}" transform="${i}" />
      </clipPath>
    </pattern>`;return a=a.replace(/\n|\r/g,""),o.body.value=a,o}loadJSON(e){this.url=new URL(e.url),this.width=e.width,this.height=e.height,this.initCutShapes(this.cutPostions),this.setSize(this.width,this.height),"cuts"in e&&e.cuts!==0[0]&&Object.keys(e.cuts).forEach(t=>{const n=sn.fromString(t);n!==0[0]&&e.cuts!==0[0]&&e.cuts[t]!==0[0]&&(this.positions[n]=e.cuts[t])}),"offsets"in e&&e.offsets!==0[0]&&Object.keys(e.offsets).forEach(t=>{const n=sn.fromString(t);n!==0[0]&&e.offsets!==0[0]&&e.offsets[t]!==0[0]&&(this.offsets[n]=e.offsets[t])}),"rotations"in e&&e.rotations!==0[0]&&Object.keys(e.rotations).forEach(t=>{const n=sn.fromString(t);n!==0[0]&&e.rotations!==0[0]&&e.rotations[t]!==0[0]&&(this.rotations[n]=e.rotations[t])}),this.setVisibility(!0),this.notify()}loadJSONLD(e){const n=e.target.selector.value.split("=")[1].split(","),t={url:e.target.source,width:Number(n[2]),height:Number(n[3])};if(typeof e.body.value!="string"&&"cuts"in e.body.value&&(t.cuts=e.body.value.cuts),typeof e.body.value!="string"&&"offsets"in e.body.value&&(t.offsets=e.body.value.offsets),typeof e.body.value!="string"&&"rotations"in e.body.value&&(t.rotations=e.body.value.rotations),typeof e.body.value=="string"){const l=new DOMParser,c=l.parseFromString(e.body.value,"image/svg+xml"),o=c.querySelector("pattern"),a={};o.hasAttribute("x")&&o.getAttribute("x")!=="0"&&(a.Right=Number(o.getAttribute("x"))),o.hasAttribute("y")&&o.getAttribute("y")!=="0"&&(a.Bottom=Number(o.getAttribute("y"))),Object.keys(a).length&&(t.offsets=a);const s=c.querySelector("rect"),i={Left:0,Top:0,Right:Number(n[2]),Bottom:Number(n[3])};s.hasAttribute("x")&&s.getAttribute("x")!=="0"&&(i.Left=Number(s.getAttribute("x"))),s.hasAttribute("y")&&s.getAttribute("y")!=="0"&&(i.Top=Number(s.getAttribute("y"))),s.hasAttribute("width")&&s.getAttribute("width")!=="0"&&(i.Right=Number(s.getAttribute("x"))+Number(s.getAttribute("width"))),s.hasAttribute("height")&&s.getAttribute("height")!=="0"&&(i.Bottom=Number(s.getAttribute("y"))+Number(s.getAttribute("height"))),Object.keys(i).length&&(t.cuts=i);const r={};if(s.hasAttribute("transform")&&s.getAttribute("transform")!==""){const t=s.getAttribute("transform"),o=/rotate\((.*?)\)/g;let e;for(;e=o.exec(t);){if(e.length<2)continue;const t=e[1].split(",").map(e=>e.trim());t[0]!=="0"&&(t[1]==n[2]?r.Right=Number(t[0]):t[2]==n[3]&&(r.Bottom=Number(t[0])))}}Object.keys(r).length&&(t.rotations=r)}this.loadJSON(t)}},Pl=class extends HTMLElement{constructor(){super(),this.options=[{value:"custom",label:g.t("imageResolutionSelect:custom")},{value:"1920x1080",label:"1080p (Full HD) (1920x1080)"},{value:"1280x720",label:"720p (HD) (1280x720)"},{value:"800x600",label:"SVGA (800x600)"},{value:"640x480",label:"VGA (640x480)"},{value:"1080x1080",label:"Instagram Post (1080x1080)"},{value:"1080x1920",label:"Instagram Story (1080x1920)"},{value:"1200x630",label:"Facebook Post (1200x630)"},{value:"1280x720",label:"YouTube Thumbnail (1280x720)"}],this._disabled=!1,this._value=null,this._selectedIndex=-1,this._customWidth=0,this._customHeight=0,this.customInputs=null,this.confirmButton=null,this.shadow=this.attachShadow({mode:"open"}),this.displayElement=document.createElement("div"),this.displayElement.classList.add("display"),this.optionsContainer=document.createElement("div"),this.optionsContainer.classList.add("options-container"),this.setupDOM(),this.applyStyles(),this.setupEventListeners(),this.mergeOptions()}mergeOptions(){const s=Array.from(this.children).filter(e=>e.tagName.toLowerCase()==="option").map(e=>({value:e.getAttribute("value")||"",label:e.textContent||""})),o=[...this.options,...s],e=[],t=new Set;for(const n of o)t.has(n.value)||(e.push(n),t.add(n.value));const n=e.shift();e.sort((e,t)=>{const[n,s]=(e.value.match(/\d+x\d+/)?e.value:"0x0").split("x").map(Number),[o,i]=(t.value.match(/\d+x\d+/)?t.value:"0x0").split("x").map(Number);return o*i-n*s}),e.forEach(e=>{e.value.match(/\d+x\d+/)&&(e.label.includes(e.value)||(e.label+=` (${e.value})`))}),n?this.options=[n,...e]:this.options=e}connectedCallback(){this.populateOptions(),this.showCustomInputs(),this.confirmButton&&this.enableConfirmButton()}static get observedAttributes(){return["disabled","value","custom-width","custom-height","confirm-button"]}attributeChangedCallback(e,t,n){if(t===n)return;e==="disabled"?this.disabled=n!==null:e==="value"?this.value=n:e==="custom-width"?(this._customWidth=n?parseInt(n)||0:0,this.updateCustomInputs()):e==="custom-height"&&(this._customHeight=n?parseInt(n)||0:0,this.updateCustomInputs())}get customWidth(){return this._customWidth}set customWidth(e){this._customWidth=e,this.updateCustomInputs()}get customHeight(){return this._customHeight}set customHeight(e){this._customHeight=e,this.updateCustomInputs()}get disabled(){return this._disabled}set disabled(e){this._disabled=e,this.updateDisabledState()}get value(){return this._value}set value(e){this._value!==e&&(this._value=e,this.updateDisplay())}get optionsData(){return this.options}set optionsData(e){this.options=[{value:"custom",label:"Custom"},...e],this.populateOptions()}setupDOM(){const e=document.createElement("div");e.classList.add("wrapper"),e.appendChild(this.displayElement),e.appendChild(this.optionsContainer),this.shadow.appendChild(e)}applyStyles(){const e=document.createElement("style");e.textContent=`
      :host {
        display: inline-block;
        --btn-bg-color: #66afff;
        --btn-font-size: 1em;
        --font-family: sans-serif;
        --disabled-opacity: .6;
        --btn-disabled-bg-color: #cccccc;
        --btn-disabled-text-color: #666666;
        --btn-disabled-cursor: not-allowed;
        --btn-hover-bg-color: #007bff;
        --btn-hover-tansition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        --btn-border-radius: 0.4rem;
        --btn-border: none;
        --btn-padding: 8px 16px;
        --disabled-opacity: .6;
      }

      :host(.disabled) {
        opacity: var(--disabled-opacity);
        pointer-events: none;
      }

      .wrapper {
        position: relative;
        display: inline-block;
        min-width: 14em;
        font-size: var(--btn-font-size);
        font-family: var(--font-family);
      }

      .display {
        border: var(--btn-border);
        padding: var(--btn-padding);
        background-color: var(--btn-bg-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        width: 100%;
        border-radius: var(--btn-border-radius);
        color: var(--btn-text-color);
      }

      .display.disabled {
        background-color: var(--btn-disabled-bg-color);
        color: var(--btn-disabled-text-color);
        opacity: var(--disabled-opacity);
        pointer-events: none;
        cursor: var(--btn-disabled-cursor);
      }

      .options-container {
        position: absolute;
        top: 100%;
        left: 0;
        display: none;
        border: 1px solid #ccc;
        background-color: white;
        z-index: 10;
        border-radius: var(--btn-border-radius);
      }

      .options-container.open {
        display: block;
      }

      .option {
        padding: 8px;
        display: flex;
        align-items: center;
        cursor: pointer;
        white-space: nowrap;
      }

      .option.selected {
        background-color: #f0f0f0;
      }

      .custom-inputs {
        display: flex;
        align-items: center;
      }

      .custom-inputs input {
        width: 60px;
        margin: 0 4px;
      }

      .custom-inputs button {
        margin-left: 4px;
        transition: var(--btn-hover-tansition);
        border-radius: var(--btn-border-radius);
        background-color: var(--btn-bg-color);
        font-size: var(--btn-font-size);
        color: var(--btn-text-color);
        var(--btn-border);
        padding: var(--btn-padding);
        font-family: var(--font-family)
      }

      .custom-inputs button:hover:not(:disabled) {
        background-color: var(--btn-hover-bg-color);
      }

      .custom-inputs button:disabled {
        background-color: var(--btn-disabled-bg-color);
        color: var(--btn-disabled-text-color);
        cursor: var(--btn-disabled-cursor);
      }
    `,this.shadow.appendChild(e)}setupEventListeners(){this.displayElement.addEventListener("click",e=>{e.stopPropagation(),this.disabled||(this.optionsContainer.classList.toggle("open"),this.optionsContainer.classList.contains("open")&&(this._selectedIndex=-1))}),document.addEventListener("click",e=>{!this.shadow.contains(e.target)&&this.optionsContainer.classList.contains("open")&&this.optionsContainer.classList.remove("open")}),this.displayElement.addEventListener("keydown",e=>{if(this.disabled)return;e.key==="ArrowDown"?(e.preventDefault(),this.navigateOptions(1)):e.key==="ArrowUp"?(e.preventDefault(),this.navigateOptions(-1)):e.key==="Enter"&&this._selectedIndex!==-1?(e.preventDefault(),this.selectOption(this._selectedIndex)):e.key==="Escape"&&this.optionsContainer.classList.remove("open")}),this.displayElement.setAttribute("tabindex","0")}navigateOptions(e){this.optionsContainer.classList.contains("open")||this.optionsContainer.classList.add("open"),this._selectedIndex+=e,this._selectedIndex<0?this._selectedIndex=this.options.length-1:this._selectedIndex>=this.options.length&&(this._selectedIndex=0),this.updateOptionSelection()}selectOption(e){if(e>=0&&e<this.options.length){this.value=this.options[e].value,this.optionsContainer.classList.remove("open");let t=this.options[e].value;if(this.options[e].value!=="custom"){const[n,s]=this.options[e].value.split("x").map(Number);!isNaN(n)&&!isNaN(s)&&(this._customWidth=n,this._customHeight=s,this.updateCustomInputs(),t=[n,s])}else t=[this._customWidth,this._customHeight];this.dispatchEvent(new CustomEvent("change",{detail:t}))}}updateOptionSelection(){Array.from(this.optionsContainer.children).forEach((e,t)=>{t===this._selectedIndex?(e.classList.add("selected"),e.scrollIntoView({block:"nearest"})):e.classList.remove("selected")})}populateOptions(){this.optionsContainer.innerHTML="",this.options.forEach((e,t)=>{const n=document.createElement("div");n.classList.add("option"),n.dataset.value=e.value,n.textContent=e.label,n.addEventListener("click",()=>{this.selectOption(t)}),this.optionsContainer.appendChild(n)}),this.updateDisplay(),this.updateDisabledState()}updateDisplay(){const e=this.options.find(e=>e.value===this.value);e?this.displayElement.textContent=e.label:this.displayElement.textContent=this.options[0].label}updateDisabledState(){this.disabled?(this.displayElement.classList.add("disabled"),this.displayElement.setAttribute("tabindex","-1")):(this.displayElement.classList.remove("disabled"),this.displayElement.setAttribute("tabindex","0"))}showCustomInputs(){if(!this.customInputs){this.customInputs=document.createElement("div"),this.customInputs.classList.add("custom-inputs");const e=document.createElement("input");e.type="number",e.value=this._customWidth.toString(),e.addEventListener("change",e=>{this._customWidth=parseInt(e.target.value)||0,this.updateCustomValue(),this.enableConfirmButton()}),e.addEventListener("click",e=>{e.stopPropagation()});const t=document.createElement("input");t.type="number",t.value=this._customHeight.toString(),t.addEventListener("change",e=>{this._customHeight=parseInt(e.target.value)||0,this.updateCustomValue(),this.enableConfirmButton()}),t.addEventListener("click",e=>{e.stopPropagation()});const s=document.createTextNode("x");this.customInputs.appendChild(e),this.customInputs.appendChild(s),this.customInputs.appendChild(t),this.hasAttribute("confirm-button")&&(this.confirmButton=document.createElement("button"),this.confirmButton.textContent=g.t("imageResolutionSelect:confirmButton"),this.confirmButton.addEventListener("click",e=>{e.stopPropagation(),this.confirmCustomSelection()}),this.confirmButton.disabled=!0,this.confirmButton.style.display="none",this.customInputs.appendChild(this.confirmButton));const n=Array.from(this.optionsContainer.children).find(e=>e.dataset.value==="custom");if(n){const e=this.getCustomOption().label;n.innerHTML="",n.appendChild(document.createTextNode(`${e} (`)),n.appendChild(this.customInputs),n.appendChild(document.createTextNode(")"))}}this.customInputs.style.display="flex"}updateCustomInputs(){if(this.customInputs){const e=this.customInputs.querySelector("input[type='number']:first-of-type"),t=this.customInputs.querySelector("input[type='number']:last-of-type");e&&(e.value=this._customWidth.toString()),t&&(t.value=this._customHeight.toString())}}updateCustomValue(){this.value=`${this._customWidth}x${this._customHeight}`}confirmCustomSelection(){this.selectOption(0)}enableConfirmButton(){this.confirmButton&&(this.confirmButton.disabled=!1,this.confirmButton.style.display="inline-block")}getCustomOption(){return this.options.filter(e=>e.value==="custom")[0]}},Al=class extends HTMLElement{constructor(){super(),this._disabled=!0,this._fileName="canvas-image",this._format="png",this._internallySettingFormat=!1,this._height=null,this._width=null,this.shadow=this.attachShadow({mode:"open"}),this._button=document.createElement("button"),this._button.className="download-button",this._button.part="button",this._button.textContent=g.t("canvasDownloadButton:download"),this._button.addEventListener("click",this._initiateDownload.bind(this)),this.shadow.appendChild(this._button),this._applyStyles(),this._updateButtonState()}connectedCallback(){this._reflectAttribute("disabled",this.hasAttribute("disabled")),this._reflectAttribute("button-text",this.getAttribute("button-text")||g.t("canvasDownloadButton:download")),this._reflectAttribute("file-name",this.getAttribute("file-name")||"canvas-image"),this._reflectAttribute("format",this.getAttribute("format")||"png"),this._reflectAttribute("height",this.getAttribute("height")),this._reflectAttribute("width",this.getAttribute("width")),this._updateButtonState()}static get observedAttributes(){return["disabled","button-text","file-name","format","height","width"]}attributeChangedCallback(e,t,n){if(this._internallySettingFormat&&e==="format")return;switch(e){case"disabled":this.disabled=n!==null;break;case"button-text":this.buttonText=n||g.t("canvasDownloadButton:download");break;case"file-name":this.fileName=n||"canvas-image";break;case"format":this.format=n||"png";break;case"height":this.height=n?parseInt(n,10):null;break;case"width":this.width=n?parseInt(n,10):null;break}}_reflectAttribute(e,t){switch(e){case"disabled":this._disabled=!!t;break;case"button-text":this.buttonText=String(t);break;case"file-name":this.fileName=String(t);break;case"format":this.format=String(t);break;case"height":this.height=t!==null?parseInt(String(t),10):null;break;case"width":this.width=t!==null?parseInt(String(t),10):null;break}}get canvas(){return this._canvas}set canvas(e){this._canvas=e,this._updateButtonState()}get disabled(){return this._disabled}set disabled(e){const t=Boolean(e);this._disabled!==t&&(this._disabled=t,t?this.setAttribute("disabled",""):this.removeAttribute("disabled"),this._updateButtonState())}get buttonText(){return this._button?.textContent??""}set buttonText(e){const t=String(e||g.t("canvasDownloadButton:download"));this._button&&this._button.textContent!==t&&(this._button.textContent=t)}get fileName(){return this._fileName}set fileName(e){const t=String(e||"canvas-image");this._fileName!==t&&(this._fileName=t)}get format(){return this._format}set format(e){this._internallySettingFormat=!0;let t=String(e||"png").toLowerCase();t!=="png"&&t!=="jpeg"&&(console.warn(`Invalid format "${t}". Defaulting to PNG.`),t="png"),this._format!==t&&(this._format=t,this.setAttribute("format",this._format)),this._internallySettingFormat=!1}get height(){return this._height}set height(e){const t=e===null?null:Number(e);this._height!==t&&(this._height=t,t!==null&&!isNaN(t)?this.setAttribute("height",String(t)):(this.removeAttribute("height"),this._height=null),this._updateButtonState())}get width(){return this._width}set width(e){const t=e===null?null:Number(e);this._width!==t&&(this._width=t,t!==null&&!isNaN(t)?this.setAttribute("width",String(t)):(this.removeAttribute("width"),this._width=null),this._updateButtonState())}set renderCallback(e){this._renderCallback=e,this._updateButtonState()}_canDownload(){return!this._disabled&&(!!this._canvas||!!(this._renderCallback&&typeof this._width=="number"&&typeof this._height=="number"))}_updateButtonState(){this._button&&(this._button.disabled=!this._canDownload())}async _initiateDownload(){if(!this._canDownload())return;this.dispatchEvent(new CustomEvent("download-start",{bubbles:!0,composed:!0}));let e=0[0];if(this._renderCallback&&typeof this._width=="number"&&typeof this._height=="number")try{const t=this._renderCallback(this._width,this._height);if(e=await t,!e)throw new Error("Render callback did not return a valid HTMLCanvasElement.");if(!(e instanceof HTMLCanvasElement))throw new Error("Render callback must return an HTMLCanvasElement.")}catch(e){console.error("Error executing render callback:",e),this.dispatchEvent(new CustomEvent("download-error",{detail:{message:"Render callback failed.",error:e},bubbles:!0,composed:!0})),this.dispatchEvent(new CustomEvent("download-end",{bubbles:!0,composed:!0}));return}else this._canvas&&(e=this._canvas);if(!e){console.error("Error downloading: No canvas available (neither set directly nor generated by callback)."),this.dispatchEvent(new CustomEvent("download-error",{detail:{message:"No canvas available for download."},bubbles:!0,composed:!0})),this.dispatchEvent(new CustomEvent("download-end",{bubbles:!0,composed:!0}));return}this._download(e,this._format,this._fileName)}async _download(e,t,n){try{const o=await this._getBlob(e,t);if(!o)throw new Error("Failed to generate Blob from canvas.");const i=URL.createObjectURL(o),s=document.createElement("a");s.href=i,s.download=`${n}.${t}`,s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),this.dispatchEvent(new CustomEvent("download-success",{detail:{fileName:s.download,format:t,blobSize:o.size},bubbles:!0,composed:!0}))}catch(e){console.error("Error during download process:",e),this.dispatchEvent(new CustomEvent("download-error",{detail:{message:g.t("canvasDownloadButton:downloadFailed"),error:e},bubbles:!0,composed:!0}))}finally{this.dispatchEvent(new CustomEvent("download-end",{bubbles:!0,composed:!0}))}}_getBlob(e,t){return new Promise((n,s)=>{const o=t==="jpeg"?"image/jpeg":"image/png",i=t==="jpeg"?.92:0[0];try{e.toBlob(e=>{n(e)},o,i)}catch(e){s(e)}})}_applyStyles(){const e=document.createElement("style");e.textContent=`
      :host {
        display: inline-block; 
        vertical-align: middle;
        /* Variables for easier theming */
        --btn-bg-color: #66afff;
        --btn-text-color: white;
        --btn-hover-bg-color: #007bff;
        --btn-hover-tansition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        --btn-disabled-bg-color: #cccccc;
        --btn-disabled-text-color: #666666;
        --btn-padding: 8px 16px;
        --btn-border-radius: 0.4rem;
        --btn-border: none;
        --btn-font-size: 1em;
        --btn-line-height: 1.2;
        --btn-cursor: pointer;
        --btn-disabled-cursor: not-allowed;
        --btn-margin: 0 2em;
        --disabled-opacity: .6;
        --font-family: sans-serif;
      }

      :host(.disabled) {
        opacity: var(--disabled-opacity);
        pointer-events: none;
      }

      .download-button {
        font-family: var(--font-family);
        padding: var(--btn-padding);
        border: var(--btn-border);
        border-radius: var(--btn-border-radius);
        cursor: var(--btn-cursor);
        font-size: var(--btn-font-size);
        transition: var(--btn-hover-tansition);
        color: var(--btn-text-color);
        background-color: var(--btn-bg-color);
        white-space: nowrap;
        line-height: var(--btn-line-height);
        margin: var(--btn-margin);
      }

      .download-button:hover:not(:disabled) {
        background-color: var(--btn-hover-bg-color);
      }

      .download-button:disabled {
        background-color: var(--btn-disabled-bg-color);
        color: var(--btn-disabled-text-color);
        cursor: var(--btn-disabled-cursor);
        opacity: var(--disabled-opacity)
      }
      `,this.shadow.appendChild(e)}},Ls=class _GridSizeSelector extends HTMLElement{constructor(e,t){super(),this.width=10,this.height=10,this.maxrows=_GridSizeSelector.initialMaxRows,this.maxcols=_GridSizeSelector.initialMaxCols,this.disabled=!1,this._width=this.width,this._height=this.height,this._isDragging=!1,this._dragStartWidth=0,this._dragStartHeight=0,this._isOpen=!1,this._gridSize=200,this._maxGridSize=400,this._disableSizeUpdate=!1,this.widthInput=null,this.heightInput=null,this.gridContainer=null,this.triggerButton=null,this.updateButton=null,e!==0[0]&&(this.maxcols=e),t!==0[0]&&(this.maxrows=t),this.attachShadow({mode:"open"}),this.render()}connectedCallback(){this.initializeElements(),this.addEventListeners(),this.updateInputs()}disconnectedCallback(){this.removeEventListeners()}initializeElements(){if(!this.shadowRoot)return;this.widthInput=this.shadowRoot.querySelector("#widthInput"),this.heightInput=this.shadowRoot.querySelector("#heightInput"),this.gridContainer=this.shadowRoot.querySelector(".grid-container"),this.triggerButton=this.shadowRoot.querySelector(".trigger-button"),this.updateButton=this.shadowRoot.querySelector(".update-button")}addEventListeners(){const e=this.shadowRoot?.querySelector(".grid-area");e&&!this.disabled&&(e.addEventListener("mousedown",this.handleMouseDown.bind(this)),e.addEventListener("mousemove",this.handleMouseMove.bind(this)),e.addEventListener("mouseup",this.handleMouseUp.bind(this)),e.addEventListener("mouseleave",this.handleMouseUp.bind(this))),this.widthInput&&!this.disabled&&this.widthInput.addEventListener("change",this.handleInputChange.bind(this)),this.heightInput&&!this.disabled&&this.heightInput.addEventListener("change",this.handleInputChange.bind(this)),this.updateButton&&!this._disableSizeUpdate&&!this.disabled&&this.updateButton.addEventListener("click",()=>this.handleUpdateSize()),this.triggerButton&&!this.disabled&&this.triggerButton.addEventListener("click",()=>this.handleToggleGrid())}removeEventListeners(){const e=this.shadowRoot?.querySelector(".grid-area");e&&(e.removeEventListener("mousedown",this.handleMouseDown.bind(this)),e.removeEventListener("mousemove",this.handleMouseMove.bind(this)),e.removeEventListener("mouseup",this.handleMouseUp.bind(this)),e.removeEventListener("mouseleave",this.handleMouseUp.bind(this))),this.widthInput&&this.widthInput.removeEventListener("change",this.handleInputChange.bind(this)),this.heightInput&&this.heightInput.removeEventListener("change",this.handleInputChange.bind(this)),this.updateButton&&this.updateButton.removeEventListener("click",()=>this.handleUpdateSize()),this.triggerButton&&this.triggerButton.removeEventListener("click",()=>this.handleToggleGrid())}static get styles(){return`
      :host {
        --btn-bg-color: #66afff;
        --btn-disabled-bg-color: #cccccc;
        --btn-disabled-text-color: #666666;
        --btn-text-color: white;
        --btn-hover-bg-color: #007bff;
        --btn-hover-tansition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        --btn-padding: 8px 16px;
        --btn-border-radius: 0.4rem;
        --btn-border: none;
        --btn-disabled-cursor: not-allowed;
        --btn-font-size: 1em;
        --btn-line-height: 1.2;
        --font-family: sans-serif;
        --gap: .8em;
        --disabled-opacity: .6;
        --input-border: 1px solid #ccc;
        --grid-width: 15em;
        --grid-height: 15em;
        --cell-background-color: #ddd;
        --cell-selected-background-color: #66afff;
        --cell-selected-border: 1px solid color-mix(in srgb, var(--cell-selected-background-color) 90%, black);
        --grid-box-shadow: 0 4px 8px rgba(0,0,0,0.2);

        display: block;
        font-family: var(--font-family);
        opacity: 1;
        transition: opacity 0.3s ease;

      }

      :host(.disabled) {
        opacity: var(--disabled-opacity);
        pointer-events: none;
      }

      .container {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: var(--gap);
        font-family: var(--font-family);
        justify-content: flex-end;
      }

      :host(.disabled) .container {
        color: var(--btn-disabled-text-color);
        cursor: var(--btn-disabled-cursor);
      }

      .input-area {
        display: flex;
        gap: var(--gap);
        align-self: center;
      }

      .container label {
        vertical-align: middle;
        text-shadow: 0px 0px 15px white, 0px 0px 15px white, 0px 0px 15px white, 0px 0px 15px white, 0px 0px 15px white, 0px 0px 15px white, 0px 0px 15px white;
        align-self: center;
      }

      input[type="number"] {
        width: 80px;
        padding: 8px;
        border: var(--input-border);
        border-radius: var(--btn-border-radius);
        text-align: center;
        font-size: var(--btn-font-size);
      }

      button {
        padding: var(--btn-padding);
        background-color: var(--btn-bg-color);
        color: var(--btn-text-color);
        border: var(--btn-border);
        border-radius: var(--btn-border-radius);
        cursor: pointer;
        transition: var(--btn-hover-tansition);
        font-size: var(--btn-font-size);
        font-family: var(--font-family);
        line-height: var(--btn-line-height);
      }

      button:hover:not(:disabled) {
        background-color: var(--btn-hover-bg-color);
      }

      :host(.disabled) button,    
      button:disabled {
        background-color: var(--btn-disabled-bg-color);
        color: var(--btn-disabled-text-color);
        cursor: var(--btn-disabled-cursor);
      }

      .grid-container {
        position: relative;
        display: inline-block;
      }

      .trigger-button {
        background-color: var(--btn-bg-color);
        var(--btn-border);
        cursor: pointer;
      }

      .trigger-button:hover {
        background-color: #367c39;
      }

      @media (min-width: 720px) {
        .trigger-button {
          order: 1;
        }
        .width-label {
          order: 2;
        }
        .width-input {
          order: 3;
        }
        .height-label {
          order: 4;
        }
        .height-input {
          order: 5;
        }
        .update-button {
          order: 6;
        }
      }

      .grid-area {
        display: none;
        /*
        grid-template-columns: repeat(${_GridSizeSelector.initialMaxCols}, auto);
        grid-template-rows: repeat(${_GridSizeSelector.initialMaxRows}, auto);
        */
        width: var(--grid-width, 200px);
        height: var(--grid-height, 200px);
        border: 1px solid #aaa;
        cursor: pointer;
        background-color: #f0f0f0;
        user-select: none;
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 10;
        box-shadow: var(--grid-box-shadow);
        background-color: #ffffff;
        gap: 2px;
        padding: 2px;
        box-sizing: border-box;
      }

      .grid-cell {
        background-color: var(--cell-background-color);
        border: 1px solid transparent;
        box-sizing: border-box;
      }

      .selected-cell {
        background-color: var(--cell-selected-background-color);
        border: var(--cell-selected-border);
      }
    `}render(){this.shadowRoot.innerHTML=`
        <style>${_GridSizeSelector.styles}</style>
        <div class="container">
          <label class="width-label" for="widthInput">${g.t("generic:columns")}:</label>
          <input
            class="width-input"
            id="widthInput"
            type="number"
            min="1"
            max="${this.maxcols}"
            value="${this._width}"
            ${this.disabled?"disabled":""}
          />
          <label class="height-label" for="heightInput">${g.t("generic:rows")}:</label>
          <input
            class="height-input"
            id="heightInput"
            type="number"
            min="1"
            max="${this.maxrows}"
            value="${this._height}"
            ${this.disabled?"disabled":""}
          />
          <button class="update-button" ${this._disableSizeUpdate||this.disabled?"disabled":""}>${g.t("gridSizeSelector:updateSize")}</button>
          <button class="trigger-button" ${this.disabled?"disabled":""}>${g.t("gridSizeSelector:selectSize")}</button>
        </div>
        <div class="grid-container">
          <div class="grid-area">
            ${this._renderGrid()}
          </div>
        </div>
      </div>
      `,this.initializeElements(),this.addEventListeners(),this.classList.toggle("disabled",this.disabled)}_renderGrid(){let e="";for(let t=0;t<this.maxrows;t++)for(let n=0;n<this.maxcols;n++){const s=t<this._height&&n<this._width;e+=`
          <div
            class="grid-cell ${s?"selected-cell":""}"
            data-row="${t}"
            data-col="${n}"
          ></div>
        `}return e}handleMouseDown(e){if(this.disabled)return;const n=this.shadowRoot?.querySelector(".grid-area");if(!n)return;const t=e.target.closest(".grid-cell");if(!t)return;this._isDragging=!0,this._dragStartWidth=parseInt(t.getAttribute("data-col")||"0")+1,this._dragStartHeight=parseInt(t.getAttribute("data-row")||"0")+1,this._width=this._dragStartWidth,this._height=this._dragStartHeight,this.updateInputs(),this.updateGrid()}handleMouseMove(e){if(this.disabled)return;if(!this._isDragging)return;const n=this.shadowRoot?.querySelector(".grid-area");if(!n)return;const t=e.target.closest(".grid-cell");if(!t)return;const s=parseInt(t.getAttribute("data-col")||"0")+1,o=parseInt(t.getAttribute("data-row")||"0")+1;this._width=Math.max(s,this._dragStartWidth),this._height=Math.max(o,this._dragStartHeight),this.updateInputs(),this.updateGrid()}handleMouseUp(){if(this.disabled)return;this._isDragging=!1,this._dragStartWidth=0,this._dragStartHeight=0}handleInputChange(e){if(this.disabled)return;const t=e.target;t.id==="widthInput"?this._width=parseInt(t.value):t.id==="heightInput"&&(this._height=parseInt(t.value)),this.updateGrid()}handleUpdateSize(){if(this.disabled)return;this.width=this._width,this.height=this._height,this._isOpen=!1,this.updateGrid(),this._fireChange()}_fireChange(){this.dispatchEvent(new CustomEvent("size-changed",{detail:{width:this.width,height:this.height}}))}handleToggleGrid(){if(this.disabled)return;this._isOpen=!this._isOpen,this.updateGrid()}attributeChangedCallback(e,t,n){e==="width"?(this.width=parseInt(n),this._width=this.width):e==="height"?(this.height=parseInt(n),this._height=this.height):e==="maxrows"?(this.maxrows=parseInt(n),this._disableSizeUpdate=!0):e==="maxcols"?(this.maxcols=parseInt(n),this._disableSizeUpdate=!0):e==="disabled"&&(this.disabled=n==="true",this.updateInputs(),this.updateUpdateButtonState(),this.classList.toggle("disabled",this.disabled)),this.updateGrid()}updateGrid(){const e=this.shadowRoot?.querySelector(".grid-area");if(!e)return;e.style.display=this._isOpen?"grid":"none",e.style.gridTemplateColumns=`repeat(${this.maxcols}, auto)`,e.style.gridTemplateRows=`repeat(${this.maxrows}, auto)`,e.innerHTML=this._renderGrid()}updateInputs(){this.widthInput&&(this.widthInput.value=String(this._width),this.widthInput.max=String(this.maxcols),this.widthInput.disabled=this.disabled),this.heightInput&&(this.heightInput.value=String(this._height),this.heightInput.max=String(this.maxrows),this.heightInput.disabled=this.disabled)}updateUpdateButtonState(){this.updateButton&&(this.updateButton.disabled=this._disableSizeUpdate||this.disabled)}},Ls.observedAttributes=["width","height","maxrows","maxcols","disabled"],Ls.initialMaxRows=10,Ls.initialMaxCols=10,El=class _OffsetRect extends _.default.Rect{constructor(e=0,t=0,n=0,s=0,o=0,i,a){super(e,t,n,s,o),i!==0[0]&&(this._horizontal=i),a!==0[0]&&(this._vertical=a)}set horizontal(e){this._horizontal=e}get horizontal(){return this._horizontal}set vertical(e){this._vertical=e}get vertical(){return this._vertical}calculateX(t){if(t===0[0]&&this.reference!==0[0]&&(t=this.reference),t!==0[0]){const t=this.reference.imageToViewportRectangle(this).width;return this.horizontal!==0[0]&&this.horizontal==e.Left?-1*t:t}return 0}calculateY(t){if(t===0[0]&&this.reference!==0[0]&&(t=this.reference),t!==0[0]){const t=this.reference.imageToViewportRectangle(this).height;return this.vertical!==0[0]&&this.vertical==e.Top?-1*t:t}return 0}static fromRect(e){return new _OffsetRect(e.x,e.y,e.width,e.height,e.degrees)}},Cl=class _RotateableRect extends _.default.Rect{constructor(e=0,t=0,n=0,s=0,o=0){super(e,t,n,s,o),this._degreesNoRotate=0,this._xNoRotate=e,this._yNoRotate=t,this._widthNoRotate=n,this._heightNoRotate=s,this._degreesNoRotate=o}rotate(e,t){return super.rotate(e,t),this._degreesNoRotate==0?this._degreesNoRotate=e:(e=e%360,e<0&&(e+=360),this._degreesNoRotate=e),this}setXNoRotate(e){this._xNoRotate=e,this._updateRotation()}setYNoRotate(e){this._yNoRotate=e,this._updateRotation()}setWidthNoRotate(e){this._widthNoRotate=e,this._updateRotation()}setHeightNoRotate(e){this._widthNoRotate=e,this._updateRotation()}setDegreesNoRotate(e){this._degreesNoRotate=e,this._updateRotation()}set rotationPoint(e){this._rotationPoint=e}get rotationPoint(){return this._rotationPoint===0[0]?this.getCenter():this._rotationPoint}_updateRotation(){_RotateableRect._isRotated(this._degreesNoRotate)?(this.x=this._yNoRotate,this.y=this._xNoRotate,this.width=this._heightNoRotate,this.height=this._widthNoRotate):(this.x=this._xNoRotate,this.y=this._yNoRotate,this.width=this._widthNoRotate,this.height=this._heightNoRotate)}clone(){const e=new _RotateableRect(this.x,this.y,this.width,this.height,this.degrees);return e._xNoRotate=this._xNoRotate,e._yNoRotate=this._yNoRotate,e._widthNoRotate=this._widthNoRotate,e._heightNoRotate=this._heightNoRotate,e._degreesNoRotate=this._degreesNoRotate,e._rotationPoint=this._rotationPoint,e}static _isRotated(e,t=45){const n=Math.abs(e-90)<=t||Math.abs(e-270)<=t;return!n}static fromRect(e){return new _RotateableRect(e.x,e.y,e.width,e.height,e.degrees)}},Xs=class _HideRect extends _.default.Rect{constructor(e,t,n,s,o){let i;e instanceof _.default.TiledImage?(i=e.getContentSize().x,t=e.getContentSize().y,n=0,s=0,o=e.getRotation()):i=e,super(i,t,n,s,o)}clone(){return new _HideRect(this.x,this.y,this.width,this.height,this.degrees)}static isHidden(e){const t=e.getClip();if(t===null)return!1;const n=e.getContentSize().x,s=e.getContentSize().y,o=e.getRotation();return!(t.x!=n||t.y!=s||t.width!=0||t.height!=0||t.degrees!=o)}};function Ol(e,t){function n(e){return e!=null&&typeof e=="object"}if(e===0[0]||t===0[0])return!1;if(!n(e)||!n(t))return e===t;const s=Object.keys(e),o=Object.keys(t);if(s.length!==o.length)return!1;for(const o of s){if(!Object.prototype.hasOwnProperty.call(t,o))return!1;const i=e[o],a=t[o],r=n(i)&&n(a);if(r&&!Ol(i,a))return!1;if(!r&&i!==a)return!1}return!0}async function wl(e){let t;e.toString().endsWith("/info.json")?t=e.toString():e.toString().endsWith("/")?t=e.toString()+"info.json":t=e.toString()+"/info.json";const n=await fetch(t);if(!n.ok)throw new Error(`Response status: ${n.status}`);return await n.json()}_n=class _Renderer{constructor(e,t=4,n=4,s=!0,o=!0,i=!0,a,r,c){this._loaded=!1,this._margins=!0,this._marginWidth=1,this.defaultExportDimensions=[1920,1080],this._notificationQueue=[],this._debug=!1,this.fitPreview=!0,this.renderTimeout=3e3,e!==0[0]?this.element=e:this.element=document.querySelector(_Renderer.defaultSelector),this.setSize(t,n),this._gridSelector=s,this._download=o,this._controls=i,_Renderer.setupHTML(this.element,i,r,c),this.viewerElement=this.element.querySelector(_Renderer.rendererViewerSelector),this.viewer=this.setupViewer(this.viewerElement),a!==0[0]&&(this.source=a),this.element!==null&&this.addControls(this.viewerElement,this.defaultExportDimensions[0],this.defaultExportDimensions[1])}clear(){this._source=0[0],this.clipRect=0[0],this._offsets=0[0],this.viewer!==0[0]&&(this._clearTiles(),this.viewer.close(),this._loaded=!1)}_clearTiles(){if(this.viewer!==0[0]){this.viewer.world.removeAll();for(let e=0;e<this.viewer.world.getItemCount();e++)this.viewer.world.removeItem(this.viewer.world.getItemAt(e))}}static _loadTiles(e,t,n){return new Promise((s,o)=>{let a=0;const i=[];if(Array.isArray(t))throw new Error("Handling of TiledImage array not implemented!");for(let e=0;e<n;e++)i.push(t);const r=e=>{o(`Failed to load TiledImage: ${e.message}`)},c=()=>{a++,l()},l=()=>{a===i.length&&(e.removeHandler("tile-load-failed",r),e.removeHandler("tile-loaded",c),s(!0))};e.addHandler("tile-loaded",c),e.addHandler("tile-load-failed",r),e.open(i)})}set source(e){if(this.viewer===0[0])throw new Error("Result viewer element is null!");this._source=e,this._loaded=!1,this.clipRect===0[0]&&(this.clipRect=new _.default.Rect(0,0,e.width,e.height));const t=this._columns,n=this._rows;this._clearTiles(),_Renderer._loadTiles(this.viewer,this._source,t*n).then(e=>{if(typeof e=="boolean"&&e)this.viewer?.world.arrange({rows:this._rows,columns:this._columns,tileMargin:0,immediately:!0}),this._notificationQueue.length?this._notificationQueue.forEach(e=>{this.notify(e)}):(this.preview(),this.layout(!0)),this.viewer?.raiseEvent("source-loaded"),this._loaded=!0,this.preview(),this.enableControls();else throw typeof e=="boolean"?new Error(`Failed to load TiledImage for unknown reasons`):new Error(e)})}get width(){return this._source!==0[0]?this._source.width:0[0]}get height(){return this._source!==0[0]?this._source.height:0[0]}get loaded(){return this._loaded}set debug(e){this._debug=e,this._debug&&(this._debugOverlays=new Map)}set margins(e){this._margins=e,this.setSize(this.columns,this.rows)}set offsets(e){_Renderer.validateSidedVariations(e,"rotation")&&(this._offsets=e)}set rotations(e){_Renderer.validateSidedVariations(e,"rotation")&&(this._rotations=e)}get rows(){return this._margins?this._rows-this._marginWidth*2:this._rows}get columns(){return this._margins?this._columns-this._marginWidth*2:this._columns}setSize(e,t,n){this._margins&&(e>t?this._marginWidth=Math.floor(e/2):this._marginWidth=Math.floor(t/2),e=e+this._marginWidth*2,t=t+this._marginWidth*2),this.viewer!==0[0]&&n!==0[0]&&(this.viewer.addOnceHandler("source-loaded",n),this.viewer.raiseEvent("grid-size-changed")),(this._columns!=e||this._rows!=t)&&(this._columns=e,this._rows=t,this._source!==0[0]&&(this.source=this._source))}enableControls(){this.gridSizeSelect!==0[0]&&this.gridSizeSelect!==null&&this.gridSizeSelect.removeAttribute("disabled"),this.resolutionSelect!==0[0]&&this.resolutionSelect!==null&&this.resolutionSelect.removeAttribute("disabled"),this.downloadButton!==0[0]&&this.downloadButton!==null&&this.downloadButton.removeAttribute("disabled"),this.viewerElement.querySelector(".zoomin")?.classList.remove("disabled"),this.viewerElement.querySelector(".zoomout")?.classList.remove("disabled"),this.viewerElement.querySelector(".fullscreen")?.classList.remove("disabled"),this.viewerElement.querySelector(".fullwidth")?.classList.remove("disabled")}static validateSidedVariations(t,n){return t!==0[0]&&(e.Left in t&&t[e.Left]!==0[0]&&e.Right&&t[e.Right]!==0[0]&&t[e.Left]!=0&&t[e.Right]!=0&&console.error(`Different ${n} for left (${t[e.Left]}) and right (${t[e.Right]}) sides`),!(e.Top in t&&t[e.Top]!==0[0]&&e.Bottom&&t[e.Bottom]!==0[0]&&t[e.Top]!=0&&t[e.Bottom]!=0)||(console.error(`Different ${n} for top (${t[e.Top]}) and bottom (${t[e.Bottom]}) sides`),!1))}static setupHTML(e,t=!0,n,s){let o=`
        <i class="controls button zoomin disabled"></i>
        <i class="controls button zoomout disabled"></i>
        <i class="controls button fullscreen disabled"></i>
        <i class="controls button fullwidth disabled"></i>`;t||(o="");let i="";n!==0[0]&&s!==0[0]&&(i=`width: ${n}px; height: ${s}px`),e.innerHTML=`
      <div class="output-viewer" style="${i}">
        ${o}
      </div>
    `}setupViewer(e){if(e!==0[0]&&(e=this.viewerElement),e!=null){let t={element:e,collectionMode:!0,preserveViewport:!0,gestureSettingsMouse:{clickToZoom:!1},showHomeControl:!1,autoHideControls:!1,collectionTileMargin:0,collectionRows:this._rows,collectionColumns:this._columns,crossOriginPolicy:"Anonymous",drawer:"canvas",debug:this._debug};this._controls?t={...t,zoomInButton:this.element.querySelector(".zoomin"),zoomOutButton:this.element.querySelector(".zoomout"),fullPageButton:this.element.querySelector(".fullscreen")}:t={...t,showNavigationControl:!1,showZoomControl:!1,showHomeControl:!1,showFullPageControl:!1,showSequenceControl:!1};const n=this.element.querySelector(".fullwidth");return n!=null&&n.addEventListener("click",()=>{this._loaded&&this.viewer!==0[0]&&_Renderer.fitToWidth(this.viewer,!1,0[0],!0)}),(0,_.default)(t)}throw new Error("Result viewer element is null!")}preview(e=0,t=0,n,s,o=!0,i,a){if(this.viewer===0[0])throw new Error("Result viewer not initialized");if(n===0[0]&&s===0[0]&&(n=this.width,s=this.height),e===0[0]||t===0[0]||n==null||s===0[0]||this.viewer.world.getItemCount()===0[0])throw new Error("Can't clip image, some dimensions aren't defined");const r=this.viewer.world.getItemCount();for(let o=0;o<r;o++){const i=this.viewer.world.getItemAt(o);if(i!==0[0]){if(this.clipRect===0[0])throw new Error("Clip rect is empty!");this.clipRect.x=e,this.clipRect.y=t,this.clipRect.width=n-e,this.clipRect.height=s-t,i.setClip(Cl.fromRect(this.clipRect))}else throw new Error("Couldn't generate clip mask, no images found!")}i!==0[0]&&(this.offsets=i),a!==0[0]&&(this.rotations=a),this.layout(o),this.downloadButton!==0[0]&&this.downloadButton!==null&&(this.downloadButton.disabled=!1),this.fitPreview&&_Renderer.fitToWidth(this.viewer,!0,0[0],!1,!0)}static createOffsetRect(t,n){let s=0,o=0,i,a;if(e.Left in t&&t[e.Left]!=0[0]&&(s=t[e.Left],i=e.Left),e.Right in t&&t[e.Right]!=0[0]&&(s=t[e.Right],i=e.Right),e.Top in t&&t[e.Top]!=0[0]&&(o=t[e.Top],a=e.Top),e.Bottom in t&&t[e.Bottom]!=0[0]&&(o=t[e.Bottom],a=e.Bottom),s!=0||o!=0){const e=new El(0,0,s,o,0[0],i,a);return e.reference=n,e}}layout(t=!0){const l=()=>{this.viewer?.raiseEvent("layout-finish",{eventSource:this.viewer})},r=this._columns,i=this._rows,c=this._margins,n=this._marginWidth;let s=r,o=i;c&&(s=r-this._marginWidth*2,o=i-this._marginWidth*2),t||this.viewer?.addHandler("animation-finish",l.bind(this)),this.viewer?.raiseEvent("start-layout",{eventSource:this.viewer});let d=-1;if(this.clipRect===0[0]||this.viewer===0[0])throw new Error("Clip rect or viewer is not defined");this.viewer.world.arrange({rows:i,columns:r,tileMargin:0,immediately:!0});const a=this.viewer.world.getItemAt(0);a.setPosition(new _.default.Point(0,0),t);const u=a.imageToViewportRectangle(this.clipRect);if(a===0[0])throw new Error("Couldn't get first tiled image!");for(let l=0;l<i;l++)for(let m=0;m<r;m++){d++;let p=l,g=m,v=0,b=0,w=0,O=0;const h=this.viewer.world.getItemAt(d),j=new Xs(h);if(h===0[0]||a===0[0]||this.clipRect===0[0])throw new Error("Required variables are not defined");let f;if(this._offsets!=0[0]&&(f=_Renderer.createOffsetRect(this._offsets,h)),w=u.width,O=u.height,c&&((m<n||m>=r-n||l<n||l>=i-n)&&h.setClip(j.clone()),g=m-n,p=l-n),h.getClip()===null)throw new Error("TiledImage has no clipings!");if(v=(m-n)*w,b=(l-n)*O,this._rotations!==0[0]&&Object.keys(this._rotations).length){let o=!1,i=!1;l%2==0&&(!c||c&&n%2==0)?o=!0:l%2==1&&c&&n%2==1&&(o=!0),m%2==0&&(!c||c&&n%2==0)?i=!0:m%2==1&&c&&n%2==1&&(i=!0);const r=this.clipRect.getCenter();let s=NaN;if(e.Right in this._rotations&&this._rotations[e.Right]!==0[0]&&o&&!i&&(s=this._rotations[e.Right]),e.Bottom in this._rotations&&this._rotations[e.Bottom]!==0[0]&&i&&!o&&(s=this._rotations[e.Bottom]),e.Right in this._rotations&&this._rotations[e.Right]!==0[0]&&e.Bottom in this._rotations&&this._rotations[e.Bottom]!==0[0]&&o&&!i&&i&&!o&&(s=this._rotations[e.Right]+this._rotations[e.Bottom]),s==360&&(s=NaN),!isNaN(s)&&!Xs.isHidden(h)){const n=h.getClip(),e=h.getClip();if(n===null||e===null)throw new Error("tiled image has no clip for rotation");if(e.rotate(s,r),s==0||s==180)h.setWidth(a.getBounds().width,!0);else{h.setHeight(a.getBounds().height,!0);const r=h._worldWidthCurrent/h.source.dimensions.x,f=this.clipRect.x+this.clipRect.width/2,p=this.clipRect.y+this.clipRect.height/2,g=h.source.dimensions.x/2,j=h.source.dimensions.y/2,c=this.clipRect.x,d=h.source.dimensions.x-(this.clipRect.x+this.clipRect.width),i=this.clipRect.y,t=h.source.dimensions.y-(this.clipRect.y+this.clipRect.height);this.clipRect.height-this.clipRect.y>this.clipRect.width-this.clipRect.x&&(e.y=e.y/2+(this.clipRect.height-this.clipRect.y)/2-e.width/2),e.height=this.clipRect.width,s==90?(h.source.dimensions.x-(this.clipRect.x+this.clipRect.width),this.clipRect.x):s==270&&(h.source.dimensions.x-(this.clipRect.x+this.clipRect.width),this.clipRect.x),console.log(`Margins left ${c} right ${d} top ${i} bottom ${t} : ${i*.5+t*.5} `);const u=p-j-c*.5+d*.5+t;let o=f-g-i*.5+t*.5;if(this.clipRect.height-this.clipRect.y<this.clipRect.width-this.clipRect.x){const t=this.clipRect.width-this.clipRect.x-(this.clipRect.height-this.clipRect.y);e.width=this.clipRect.height-this.clipRect.y,o=o-t/2,console.log(`Less height (${this.clipRect.height-this.clipRect.y}) then width (${this.clipRect.width-this.clipRect.x}), using ${this.clipRect.height-this.clipRect.y}`)}console.log(`offset Y ${o} X ${u}`),v=v-r*u,b=b-r*o,console.log("Rotations",`${m},${l}`,`source width ${h.source.dimensions.x} clip width ${this.clipRect.width}`),new _.default.Point(n.width/2-e.width/2,n.height/2-e.height/2)}h.setRotationPoint(new _.default.Rect(0,0,h.getContentSize().x,h.getContentSize().y).getCenter()),h.setRotation(s,t),h.setClip(e)}}if(f!==0[0]){if(f.height>0){const e=f.calculateY(a)*g;b=b+e}else if(f.height<0){const e=f.calculateY(a)*g;b=b-e}if(g==0&&f.width<0){const e=h.getClip().clone(),t=f.width*p*-1;e.width=e.width-t,e.x=e.x+t,h.setClip(e)}if(g==s-1&&f.width>0){const e=h.getClip().clone(),t=f.width*p;e.width=e.width-t,h.setClip(e)}if(f.width>0){const e=f.calculateX(a)*p;v=v+e}else if(f.width<0){const e=f.calculateX(a)*p;v=v-e}if(p==0&&f.height<0){const e=h.getClip().clone(),t=f.height*g*-1;e.height=e.height-t,e.y=e.y+t,h.setClip(e)}if(p==o-1&&f.height>0){const e=h.getClip().clone(),t=f.height*g;e.height=e.height-t,h.setClip(e)}const t=f.width*p,d=f.height*g,u=e=>Xs.isHidden(e)?this.clipRect.clone():e.getClip(),e=(e,t)=>e<n?n-e:e>=t+n?e-(n+t)+1:NaN;if(c&&(m<n||m>=r-n||l<n||l>=i-n)){if(m<n&&f.width>0){const n=u(h);e(m,s)*this.clipRect.width>t&&(e(m,s)-1)*this.clipRect.width<t?(n.x=n.width+(e(m,s)-1)*n.width-t,n.width=n.width-(e(m,s)-1)*n.width+t):e(m,s)*this.clipRect.width>t?(n.width=j.width,n.x=j.x):(n.width=this.clipRect.width,n.x=this.clipRect.x),h.setClip(n)}if(m>=r-n&&f.width<0){const n=u(h);e(m,s)*this.clipRect.width>t*-1&&(e(m,s)-1)*this.clipRect.width<t*-1?n.width=(t+(e(m,s)-1)*n.width)*-1:e(m,s)*this.clipRect.width>t*-1?n.width=j.width:n.width=this.clipRect.width,h.setClip(n)}if(l<n&&f.height>0){const t=u(h);e(l,o)*this.clipRect.height>d&&(e(l,o)-1)*this.clipRect.height<d?(t.y=t.height+(e(l,o)-1)*t.height-d,t.height=t.height-(e(l,o)-1)*t.height+d):e(l,o)*this.clipRect.height>d?(t.height=j.height,t.y=j.y):(t.height=this.clipRect.height,t.y=this.clipRect.y),h.setClip(t)}if(l>=i-n&&f.height<0){const t=u(h);e(l,o)*this.clipRect.height>d*-1&&(e(l,o)-1)*this.clipRect.height<d*-1?t.height=(d+(e(l,o)-1)*t.height)*-1:e(l,o)*this.clipRect.height>d*-1?t.height=j.height:t.height=this.clipRect.height,h.setClip(t)}if((l<n||l>=i-n)&&f.width!=0&&f.height==0){const t=u(h);t.y=t.height+(e(l,o)-1)*t.height-d,h.setClip(t)}else if((m<n||m>=i-n)&&f.height!=0&&f.width==0){const n=u(h);n.x=n.width+(e(m,s)-1)*n.width-t,h.setClip(n)}if(f.width!=0&&f.height!=0&&(m<n||m>=i-n)&&(l<n||l>=i-n)){const n=u(h);n.y=n.height+(e(l,o)-1)*n.height-d,n.x=n.width+(e(m,s)-1)*n.width-t,n.width=(t+(e(m,s)-1)*n.width)*-1,n.height=n.height-(e(l,o)-1)*n.height+d,h.setClip(n)}}const y=Math.ceil((n+s)*f.width*Math.sign(f.width)/this.clipRect.width);if(y>n&&(m==r-y-1||m==y)){if(m==y&&t*-1>this.clipRect.width){const e=u(h);e.width=e.width-(this.clipRect.width+t)*-1,e.x=e.x+(this.clipRect.width+t)*-1,h.setClip(e)}if(m==r-y-1&&t>this.clipRect.width){const e=u(h);e.width=this.clipRect.width-(t-this.clipRect.width),h.setClip(e)}}const _=Math.ceil((n+o)*f.height*Math.sign(f.height)/this.clipRect.height);if(_>n&&(l==i-_-1||l==_))if(l==_&&d*-1>this.clipRect.height){const e=u(h);e.height=e.height-(this.clipRect.height+t)*-1,e.y=e.y+(this.clipRect.height+d)*-1,h.setClip(e)}else if(l==i-_-1&&d>this.clipRect.height){const e=u(h);e.height=this.clipRect.height-(d-this.clipRect.height),h.setClip(e)}}h.setPosition(new _.default.Point(v,b),t);let y=`${m}, ${l} (${g}, ${p})`;h===a&&(y="Reference "+y),this.debugOverlay(y,h,!0)}this.viewer.world.setAutoRefigureSizes(!0),t&&l.bind(this)()}debugOverlay(e,t,n=!1){if(!this._debug||this._debugOverlays===0[0])return;if(this._debugOverlays.has(t)){const s=this._debugOverlays.get(t);s[0].element.innerHTML=e,this.viewer?.getOverlayById(s[0].element).update(t.getBounds(!0),0[0]),s[1]!==0[0]&&n&&t.getClip()!==null&&this.viewer?.getOverlayById(s[1].element).update(t.imageToViewportRectangle(t.getClip()),0[0])}else{const s=document.createElement("div");s.id="debug-overlay"+Math.random().toString(16).slice(2),s.className="debug-overlay",s.innerHTML=e,s.dataset.content=e,s.style.fontSize="2em",s.style.color="red",s.style.alignItems="center",s.style.justifyContent="canter",s.style.display="flex",s.style.textAlign="center",s.style.border="2px solid red";const o={element:s,location:t.getBounds(!0)};this.viewer?.addOverlay(o.element,o.location);let i;if(n&&t.getClip()!==null){const n=document.createElement("div");n.id="debug-overlay"+Math.random().toString(16).slice(2),n.className="debug-overlay",n.classList.add("clip"),n.dataset.content=e,n.style.border="1px dashed green",i={element:n,location:t.imageToViewportRectangle(t.getClip())},this.viewer?.addOverlay(i.element,i.location),this._debugOverlays.set(t,[o,i])}else this._debugOverlays.set(t,[o])}}static fitToWidth(e,t=!0,n,s=!1,o=!1){if(e!==0[0]&&e.world.getItemCount()>0){{let n=1/0,a=-(1/0),i=1/0,r=-(1/0);for(let o=0;o<e.world.getItemCount();o++){const t=e.world.getItemAt(o),s=t.getBounds();if(t.getClip()!==null){if(t.getContentSize().x==t.getClip().x&&t.getContentSize().y==t.getClip().y)continue;n=Math.min(n,t.imageToViewportRectangle(t.getClip()).x),a=Math.max(a,t.imageToViewportRectangle(t.getClip()).x+t.imageToViewportRectangle(t.getClip()).width),r=Math.max(r,t.imageToViewportRectangle(t.getClip()).y+t.imageToViewportRectangle(t.getClip()).height),i=Math.min(i,t.imageToViewportRectangle(t.getClip()).y)}else n=Math.min(n,s.x),a=Math.max(a,s.x+s.width),r=Math.max(r,s.y+s.height),i=Math.min(i,s.y)}const c=a-n,l=r-i;if(c>0||l>0){let a,r,d;if(o){if(l===0){console.warn("Cannot fit to height when combined height is zero.");return}const s=e.viewport.getContainerSize().y;a=s/e.viewport.getContainerSize().x/l,r=n+c/2,d=i+l/2,e.viewport.zoomTo(a,0[0],t),e.viewport.panTo(new _.default.Point(r,d),t)}else{c===0&&console.warn("Cannot fit to width when combined width is zero."),a=1/c,r=n+c/2,e.viewport.zoomTo(a,0[0],t),e.viewport.panTo(new _.default.Point(r,e.viewport.getCenter().y),t);const o=e.viewport.getBounds();o.y<0&&e.viewport.panBy(new _.default.Point(0,-o.y),t),o.y>0&&s&&e.viewport.panBy(new _.default.Point(0,-o.y+i),t)}e.raiseEvent("full-width",e)}}}else throw new Error("Not a valid viewer or no items in the world.")}appendNotification(e){const t=this._notificationQueue[this._notificationQueue.length-1];(t===0[0]||!Ol(t,e))&&this._notificationQueue.push(e)}notify(t,n=!0){!this._loaded||this.viewer===0[0]?this.appendNotification(t):this.preview(t[0][e.Left],t[0][e.Top],t[0][e.Right],t[0][e.Bottom],n,t[1],t[2])}async renderImage(t=1920,n=1080){const o=document.createElement("div");let a;o.id=_Renderer._rendererContainer,o.style.width=`${t}px`,o.style.height=`${n}px`,this._debug!==0[0]&&this._debug?(a=document.querySelector(`#${_Renderer._debugId}`),a===null&&(a=document.querySelector("body")),a.insertAdjacentElement("beforeend",o)):(o.style.position="absolute",o.style.left="-9999px",o.style.top="-9999px",o.style.overflow="hidden",document.querySelector("body").insertAdjacentElement("beforeend",o));const r=new _Renderer(o,this.columns,this.rows,!1,!1,!1,0[0],t,n);r.fitPreview=!1;const s=r.viewer;if(!s)throw new Error("Child Renderer has no viewer!");if(!this._source)throw new Error("Parent viewer has no source!");const i={},l=this._offsets,d=this._rotations;this.clipRect!==0[0]?(i[e.Top]=this.clipRect.y,i[e.Left]=this.clipRect.x,i[e.Right]=this.clipRect.x+this.clipRect.width,i[e.Bottom]=this.clipRect.y+this.clipRect.height):(i[e.Top]=0,i[e.Left]=0,i[e.Right]=this._source.width,i[e.Bottom]=this._source.height),r.source=this._source;const c=s.world.getItemCount();return new Promise((e,t)=>{let m=!1,u=0,f=!1;const h=()=>{if(m&&u>=c&&f)try{e(s),clearTimeout(v),n&&s.removeHandler("tile-drawn",n),o&&s.removeHandler("layout-finish",o),a&&s.removeHandler("full-width",a)}catch(e){t(e),clearTimeout(v),n&&s.removeHandler("tile-drawn",n),o&&s.removeHandler("layout-finish",o),a&&s.removeHandler("full-width",a)}},n=()=>{u++,h()},o=()=>{m=!0,s.addOnceHandler("full-width",a),_Renderer.fitToWidth(s,!0,0[0],!0),h()},a=()=>{f=!0,h()};s.addHandler("tile-drawn",n);const b=()=>{};s.addHandler("update-viewport",b);const p=()=>{u>=c&&(s.removeHandler("tile-drawn",p),s.addOnceHandler("layout-finish",o),r.notify([i,l,d],!0))};s.addHandler("tile-drawn",p);const v=setTimeout(()=>{const e=g.t("renderer:renderTimeout");t(new Error(`${e} ${this.renderTimeout}ms`)),n&&s.removeHandler("tile-drawn",n),o&&s.removeHandler("layout-finish",o),a&&s.removeHandler("full-width",a)},this.renderTimeout)})}addControls(e,t=1920,n=1080,s="image/png"){let o;const i=async(e=1920,t=1080)=>{try{const n=await this.renderImage(e,t);return await new Promise(e=>setTimeout(e,500)),o=n,n.drawer.canvas}catch(e){if(this.statusContainer!==null){const t=g.t("renderer:error")+": "+e.message;this.statusContainer.innerHTML=t}throw new Error(e)}};if(this._download){customElements.define("offscreencanvas-download",Al),this.downloadButton=document.createElement("offscreencanvas-download");const a=s.split("/")[1];this.downloadButton.format=a,this.downloadButton.renderCallback=i.bind(this),this.downloadButton.addEventListener("download-end",()=>{if(o!=null&&o.container!==0[0]){const t=o.container;if(o.destroy(),t.remove(),this._debug!==0[0]&&this._debug){const e=document.querySelector(`#${_Renderer._debugId}`);e!==null?e.remove():document.querySelector("body > div:last-of-type")?.remove()}const e=document.querySelector(`#${_Renderer._rendererContainer}`);e!==null&&e.remove(),o=null}}),this.downloadButton.fileName=`wallpaper`,this.downloadButton.width=t,this.downloadButton.height=n,this.downloadButton.setAttribute("disabled","true"),this.downloadButton.classList.add("download-button"),customElements.define("image-resolution-select",Pl),this.resolutionSelect=document.createElement("image-resolution-select"),this.resolutionSelect.setAttribute("confirm-button","true"),this.resolutionSelect.customHeight=n,this.resolutionSelect.customWidth=t,this.resolutionSelect.setAttribute("disabled","true"),this.resolutionSelect.addEventListener("change",e=>{e.detail!==0[0]&&(this.downloadButton.width=e.detail[0],this.downloadButton.height=e.detail[1],this.downloadButton.disabled=!1)}),this.resolutionSelect.classList.add("resolution-select"),e.appendChild(this.resolutionSelect),e.appendChild(this.downloadButton)}if(this._gridSelector){customElements.define("grid-size-selector",Ls),this.gridSizeSelect=document.createElement("grid-size-selector"),this.gridSizeSelect.setAttribute("disabled","true"),this.gridSizeSelect.setAttribute("width",String(this.columns)),this.gridSizeSelect.setAttribute("height",String(this.rows)),this.gridSizeSelect.classList.add("grid-select");const t=e=>{const t=e.detail.width,n=e.detail.height,s=()=>{this.viewer!==0[0]&&_Renderer.fitToWidth(this.viewer,!0)};this.viewer?.addOnceHandler("source-loaded",s.bind(this)),this.setSize(t,n)};this.gridSizeSelect.addEventListener("size-changed",t.bind(this)),e.appendChild(this.gridSizeSelect)}}},_n.defaultSelector=".texture-container",_n.rendererViewerSelector=".output-viewer",_n._debugId="debug",_n._rendererContainer="hidden-renderer-container",yl=class extends HTMLElement{constructor(){super(),this.options=[],this._disabled=!1,this._value=null,this._selectedIndex=-1,this.shadow=this.attachShadow({mode:"open"}),this.displayElement=document.createElement("div"),this.displayElement.classList.add("display"),this.optionsContainer=document.createElement("div"),this.optionsContainer.classList.add("options-container"),this.setupDOM(),this.applyStyles(),this.setupEventListeners()}connectedCallback(){this.populateOptions()}static get observedAttributes(){return["disabled","value"]}attributeChangedCallback(e,t,n){if(t===n)return;e==="disabled"?this.disabled=n!==null:e==="value"&&(this.value=n)}get disabled(){return this._disabled}set disabled(e){this._disabled=e,this.updateDisabledState()}get value(){return this._value}set value(e){this._value!==e&&(this._value=e,this.updateDisplay())}setupDOM(){const e=document.createElement("div");e.classList.add("wrapper"),e.appendChild(this.displayElement),e.appendChild(this.optionsContainer),this.shadow.appendChild(e)}applyStyles(){const e=document.createElement("style");e.textContent=`
      :host {
          display: inline-block;
          --disabled-opacity: .6;
      }

      :host(.disabled) {
        opacity: var(--disabled-opacity);
        pointer-events: none;
      }

      .wrapper {
        position: relative;
        display: inline-block;
        width: 100%;
      }
      
      .display {
        border: 1px solid #ccc;
        padding: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        border-radius: .4rem;
      }

      .display.disabled {
        cursor: default;
        background-color: #eee;
        color: #999;
      }

      .display img {
        margin-right: 8px;
        width: 20px;
        height: 20px;
      }

      .options-container {
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        display: none;
        border: 1px solid #ccc;
        background-color: white;
        z-index: 10;
        overflow-y: scroll;
        min-height: 30vh;
        max-height: 80vh;
      }

      .options-container.open {
        display: block;
      }

      .option {
        padding: .2rem;
        display: flex;
        align-items: center;
        cursor: pointer;
      }

      .option img {
        margin-right: 8px;
        width: 20px;
        height: 20px;
      }

      .option.selected {
        background-color: #f0f0f0;
      }

    `,this.shadow.appendChild(e)}setupEventListeners(){this.displayElement.addEventListener("click",e=>{e.stopPropagation(),this.disabled||(this.optionsContainer.classList.toggle("open"),this.optionsContainer.classList.contains("open")&&(this._selectedIndex=-1))}),document.addEventListener("click",e=>{!this.shadow.contains(e.target)&&this.optionsContainer.classList.contains("open")&&this.optionsContainer.classList.remove("open")}),this.displayElement.addEventListener("keydown",e=>{if(this.disabled)return;e.key==="ArrowDown"?(e.preventDefault(),this.navigateOptions(1)):e.key==="ArrowUp"?(e.preventDefault(),this.navigateOptions(-1)):e.key==="Enter"&&this._selectedIndex!==-1?(e.preventDefault(),this.selectOption(this._selectedIndex)):e.key==="Escape"&&this.optionsContainer.classList.remove("open")}),this.displayElement.setAttribute("tabindex","0")}navigateOptions(e){this.optionsContainer.classList.contains("open")||this.optionsContainer.classList.add("open"),this._selectedIndex+=e,this._selectedIndex<0?this._selectedIndex=this.options.length-1:this._selectedIndex>=this.options.length&&(this._selectedIndex=0),this.updateOptionSelection()}selectOption(e){e>=0&&e<this.options.length&&(this.value=this.options[e].value,this.optionsContainer.classList.remove("open"),this.dispatchEvent(new CustomEvent("change",{detail:this.options[e].value})))}updateOptionSelection(){Array.from(this.optionsContainer.children).forEach((e,t)=>{t===this._selectedIndex?(e.classList.add("selected"),e.scrollIntoView({block:"nearest"})):e.classList.remove("selected")})}populateOptions(){this.optionsContainer.innerHTML="",this.options=Array.from(this.children).map(e=>{const t=e.getAttribute("value")||"",n=e.innerHTML||"";return{value:t,innerHTML:n}}),this.options.forEach(e=>{const t=document.createElement("div");t.classList.add("option"),t.innerHTML=e.innerHTML,t.addEventListener("click",()=>{this.value=e.value,this.optionsContainer.classList.remove("open"),this.dispatchEvent(new CustomEvent("change",{detail:e.value}))}),this.optionsContainer.appendChild(t)}),this.updateDisplay(),this.updateDisabledState()}updateDisplay(){const e=this.options.find(e=>e.value===this.value);this.displayElement.innerHTML="",e?this.displayElement.innerHTML=e.innerHTML:this.options.length>0&&(this.displayElement.innerHTML=this.options[0].innerHTML)}updateDisabledState(){this.disabled?this.displayElement.classList.add("disabled"):this.displayElement.classList.remove("disabled")}},Sc=class _IIIFForm{constructor(e,t,n,s=!0,o){this.buttonClass="load-url-button",this.inputFieldClass="url-input",this.entries={},this._autoLoad=!1,this.cuttingTable=e,customElements.define("icon-dropdown-select",yl),this.inputField=this.cuttingTable.container.querySelector(`.${this.inputFieldClass}`),t===0[0]?this.selectContainer=this.cuttingTable.container.querySelector(`.${H.selectContainerClass}`):this.selectContainer=t,this._urlInput=s,o!==0[0]&&(this._autoLoad=o),this.statusContainer=n,s&&(this.button=this.cuttingTable.container.querySelector(`.${this.buttonClass}`),this.button.innerText=g.t("iiifForm:loadButton")),this.setup()}setup(){const e=e=>{try{this.loadUrl(new URL(e),0[0]).then(e=>{this.createForm(e)})}catch{this.displayMessage(g.t("iiifForm:errorURL"));return}};if(this._urlInput){const t=()=>{if(this.inputField!==null){const t=this.inputField?.value;t!==0[0]&&t!==""&&this.statusContainer!==null&&(this.statusContainer.innerHTML="",this.selectContainer.innerHTML="",e(t))}};this.inputField!==null&&this.inputField.addEventListener("keyup",({key:e})=>{e==="Enter"&&t()}),this.button?.addEventListener("click",t),this._autoLoad&&this.button?.click()}else if(this.cuttingTable.url!==0[0])this.loadUrl(new URL(this.cuttingTable.url),0[0]).then(e=>{this.createForm(e)});else throw new Error("Input is disabled but no default URL given!")}set urlInput(e){this.inputField!==null&&(this.inputField.value=e.toString())}createForm(e){if(e===0[0])return;if(e.type==="Image")return;if(e.type in this.entries)this.entries[e.type]=this.addSelect(e),this.current=e.type;else if(Object.keys(this.entries).length)throw new Error("This should't happen!");else this.entries[e.type]=this.addSelect(e),this.current=e.type}updateForm(e,t){this.loadUrl(new URL(e),t).then(e=>{this.createForm(e)})}async safeLoadIIIF(e,t=""){return fetch(e,{redirect:"follow"}).then(t=>{if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return{url:e,json:t.json()}}).catch(n=>{if(console.warn(`Failed to load ${e}, it's safe to ignore CORS warnings, those are the results of checking for manifests.`),t!==""){let n=e.toString();return n.endsWith("/")?n=n+t:n=n+"/"+t,this.safeLoadIIIF(new URL(n))}return console.warn(`Network or CORS issue for ${e.toString()}:`,n),{url:e,json:0[0]}})}displayMessage(e){this.statusContainer!==null&&(this.statusContainer.innerHTML=e)}clearMessage(){this.statusContainer!==null&&(this.statusContainer.innerHTML="")}async loadUrl(e,t="Image"){let o;t===0[0]?o="":o=_IIIFForm.typeHierarchy[t];let i,a;try{const t=await this.safeLoadIIIF(e,o);i=await t.json,a=t.url}catch(e){console.warn(e)}if(i===0[0]||a===0[0]){this.displayMessage(g.t("iiifForm:errorJson"));return}const n=S0.parse(i),s=g.language.split("-")[0];if(n instanceof ho){const t={type:"Collection",entries:[],source:e};n.items.forEach(e=>{let n="";e.label!==0[0]&&(s in e.label?n=e.label[s].join(" "):n=e.label[Object.keys(e.label)[0]].join(" "));const o={id:e.uri,label:n};"thumbnail"in e&&e.thumbnail!==0[0]&&(o.thumbnail=new URL(e.thumbnail[0].id)),t.entries.push(o)}),this.current="Collection",this.entries.Collection=t}else if(n instanceof Qt){const t={type:"Manifest",entries:[],source:e};n.canvases.forEach(e=>{let o="";e.label!==0[0]&&(s in e.label?o=e.label[s].join(" "):o=e.label[Object.keys(e.label)[0]].join(" "));const n={id:e.image.uri,label:o};"width"in e&&"height"in e&&(n.height=e.height,n.width=e.width),"thumbnail"in e&&e.thumbnail!==0[0]&&(n.thumbnail=new URL(e.thumbnail[0].id)),t.entries.push(n)}),this.current="Manifest",this.entries.Manifest=t}else if(n instanceof rs){const t={type:"Image",entries:[],source:e};t.entries.push({id:n.uri,label:""}),this.current="Image",this.entries.Image=t,this.loadImageAPI(a)}return this.entries[this.current]}static createSelect(e,t,n,s,o){const i=document.createElement("icon-dropdown-select");i.classList.add("select",e.type.toLowerCase());const c="select-"+Math.random().toString(16).slice(5),r="select-"+e.type,a=document.createElement("label");if(o!==0[0]){if(s!==0[0]){const e=s.querySelector(`#${r}`);e!==null&&e.remove()}a.innerHTML=o,a.htmlFor=r,i instanceof HTMLSelectElement&&(i.name=c),i.id=r,a.id=r}return t!==0[0]&&t!==""&&i.classList.add(t),n!==0[0]&&t!==""&&(i.id=n),e.entries.forEach(e=>{const t=document.createElement("option");if(t.value=e.id,e.thumbnail!==0[0]){const n=document.createElement("img");n.src=e.thumbnail.toString(),t.innerHTML=n.outerHTML+e.label}else t.text=e.label;i.appendChild(t)}),e.type==="Image"?e.element=a:e.element=i,a!==0[0]&&(e.label=a),s!==0[0]&&s.appendChild(i),e}addSelect(e,t=!0){if(this.selectContainer!==null){const t=g.t(`iiifForm:${e.type.toLowerCase()}Choose`),n="";e=_IIIFForm.createSelect(e,n,`select-${e.type}`,this.selectContainer,t)}return t&&e.entries.length==1?("element"in e&&e.element!==0[0]&&(e.element.disabled=!0),(e.type==="Manifest"||e.type==="Image")&&(console.warn(`Autoloading ${e.entries[0].id}`),this.loadImageAPI(new URL(e.entries[0].id)))):e.element?.addEventListener("change",t=>{if(t.detail!==0[0]){const o=new URL(t.detail),n=Object.keys(_IIIFForm.typeHierarchy);let s;if(e.type!==0[0]){const t=n.indexOf(e.type);s=n[t+1]}this.updateForm(o,s)}}),e}async loadImageAPI(e){let t;try{t=await wl(e)}catch{console.warn(`Failed to get ${e}`)}return this.cuttingTable.imageService=t,this._imageAPIUrl!==0[0]&&this._imageAPIUrl!=e?this.cuttingTable.imageServiceUrl=this._imageAPIUrl:this.cuttingTable.imageServiceUrl=e,t}},Sc.typeHierarchy={Collection:"collection.json",Manifest:"manifest.json",Image:"info.json"},bl={cuttingTable:{linksJson:"Download as JSON",uploadError:"JSON could not be loaded",loadUrl:"Load URL",rulerToggle:"Show rulers"},iiifForm:{collectionChoose:"Select manifest from the collection",collectionButton:"Select",manifestChoose:"Select page as template",manifestButton:"Select",imageChoose:"Select image",imageButton:"Select",loadButton:"Load URL",errorJson:"<b>IIIF file could not be loaded</b>",errorURL:"<b>Invalid URL</b>"},renderer:{error:"Error",renderTimeout:"Render not finished after"},canvasDownloadButton:{download:"Download",downloadFailed:"Download failed."},imageResolutionSelect:{custom:"Custom resolution",confirmButton:"Confirm"},gridSizeSelector:{selectSize:"Select Size",updateSize:"Update Size"},generic:{columns:"Columns",rows:"Rows"}},vl={cuttingTable:{linksJson:"Als JSON herunterladen",uploadError:"JSON konnte nicht geladen werden",loadUrl:"URL laden",rulerToggle:"Lineale anzeigen"},iiifForm:{collectionChoose:"Manifest aus der Sammlung ausw\xE4hlen",collectionButton:"Ausw\xE4hlen",manifestChoose:"Seite als Vorlage ausw\xE4hlen",manifestButton:"Ausw\xE4hlen",imageChoose:"Bild ausw\xE4hlen",imageButton:"Ausw\xE4hlen",loadButton:"URL laden",errorJson:"<b>IIIF Datei konnte nicht geladen werden</b>",errorURL:"<b>Ung\xFCltige URL</b>"},renderer:{error:"Fehler",renderTimeout:"Erzeugung nicht abgeschlossen nach"},canvasDownloadButton:{download:"Herunterladen",downloadFailed:"Download fehlgeschlagen."},imageResolutionSelect:{custom:"Eigene Aufl\xF6sung",confirmButton:"Best\xE4tigen"},gridSizeSelector:{selectSize:"Gr\xF6\xDFe w\xE4hlen",updateSize:"Gr\xF6\xDFe aktualisieren"},generic:{columns:"Spalten",rows:"Zeilen"}},gl={en:bl,de:vl},g.use(fc).init({debug:!1,fallbackLng:"en",resources:gl,supportedLngs:["en","de"]}),H=class _CuttingTable{constructor(e,t=!0,n=!0,s=!0,o=!0,i,a=!1){if(this.download=!0,this._debug=!1,this._shifts=!0,this._columns=4,this._rows=4,e!==0[0]?this.container=e:this.container=document.querySelector(`.${_CuttingTable.defaultId}`),this.container.classList.add("lucienne"),this.container===0[0])throw new Error("Couldn't setup element");if("debug"in e.dataset&&e.dataset.debug!==0[0]&&e.dataset.debug!==""&&(this._debug=e.dataset.debug==="true"),"urlInput"in e.dataset&&e.dataset.urlInput!==0[0]&&e.dataset.urlInput!==""&&(t=e.dataset.urlInput==="true"),this._urlInput=t,"gridSelector"in e.dataset&&e.dataset.gridSelector!==0[0]&&e.dataset.gridSelector!==""&&(n=e.dataset.gridSelector==="true"),this._gridSelector=n,"download"in e.dataset&&e.dataset.download!==0[0]&&e.dataset.download!==""&&(s=e.dataset.download==="true"),this._download=s,this._autoLoad=o,this._shifts=a,"url"in e.dataset&&e.dataset.url!==0[0]&&e.dataset.url!==""?this._url=new URL(e.dataset.url):(i!==0[0]&&i instanceof URL?this._url=i:i!==0[0]&&Array.isArray(i)?this._initialUrls=i:typeof i=="string"&&(this._url=new URL(i)),this._autoLoad&&Array.isArray(this._initialUrls)&&(this._url=new URL(this._initialUrls[0].url))),"columns"in e.dataset&&e.dataset.columns!==0[0]&&e.dataset.columns!==""&&(this._columns=parseInt(e.dataset.columns)),"rows"in e.dataset&&e.dataset.rows!==0[0]&&e.dataset.rows!==""&&(this._rows=parseInt(e.dataset.rows)),this._shifts&&this.container.classList.add(_CuttingTable.shiftClass),!this._urlInput&&this._url===0[0])throw new Error("No initial URL set");customElements.define("rotating-input",Kl),customElements.define("dual-range-slider",Ul),this.setupInterface();const r=this.container.querySelector(`.${_CuttingTable.selectContainerClass}`);this.statusContainer=this.container.querySelector(`.${_CuttingTable.statusContainerClass}`),this.form=new Sc(this,r,this.statusContainer,this._urlInput,this._autoLoad);const c=this.container.querySelector(`.${_CuttingTable.rendererElementClass}`);this.renderer=new _n(c,this._columns,this._rows,this._gridSelector,this._download),this.renderer.debug=this._debug,this.renderer.statusContainer=this.statusContainer,this.viewerElement=this.container.querySelector(`.${_CuttingTable.viewerElementClass}`),this.setupOSD(this.viewerElement),this.viewerElement.parentElement!==null&&this.download&&this.addJSONLink(this.viewerElement.parentElement),this.setupControls()}setupOSD(e){(0,ql.initOSDFabricJS)();const t={zoomInButton:e.querySelector(".zoomin"),zoomOutButton:e.querySelector(".zoomout"),element:e,gestureSettingsMouse:{clickToZoom:!1},showFullPageControl:!1,showHomeControl:!1,autoHideControls:!1,drawer:"canvas",crossOriginPolicy:"Anonymous"};this.viewer=(0,_.default)(t),this.fabricOverlay=this.viewer.fabricOverlay({fabricCanvasOptions:{selection:!1}})}addJSONLink(e){this.downloadLink=document.createElement("a"),this.downloadLink.innerText=g.t("cuttingTable:linksJson"),this.downloadLink.title=g.t("cuttingTable:linksJson"),this.downloadLink.setAttribute("href","javascript:void(0)"),this.downloadLink.classList.add("link","json","disabled"),this.downloadLink.setAttribute("id","downloadJSON"),this.downloadLink.setAttribute("download","cuttingTable.json"),this.downloadLink.addEventListener("click",()=>{if(this.cuts!==0[0]){if(this.cuts.url===""&&this.imageServiceUrl===0[0])throw new Error("Couldn' set target URL!");this.cuts.url=this.imageServiceUrl;const e="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(this.cuts.toJSONLD(),null,2));this.downloadLink.setAttribute("href",e)}}),e.appendChild(this.downloadLink)}square(){this.cuts!==0[0]&&this.cuts.square()&&(this.cutY.valueMin=this.cuts.getPosition(e.Top),this.cutY.valueMax=this.cuts.getPosition(e.Bottom),this.cutX.valueMin=this.cuts.getPosition(e.Left),this.cutX.valueMax=this.cuts.getPosition(e.Right))}async loadImageAPI(e){let t;try{t=await wl(e)}catch{console.warn(`Failed to get ${e}`)}this.renderer!==0[0]&&(this.renderer.source=t),this.imageService=t,this.imageServiceUrl=e}set imageService(e){this.viewer!==0[0]?(this.viewer.world.addHandler("add-item",()=>{this.cuts!==0[0]&&(this.cuts.lastAxis=0[0],this.updateLines(e.width,e.height),this.form.clearMessage(),this.cuts.setVisibility(!0))}),this.viewer.world.getItemCount()?(this.viewer.close(),this.viewer.open(e)):this.viewer.addTiledImage({index:this.viewer.world.getItemCount(),tileSource:e}),e["@context"].startsWith("http://iiif.io/api/image/")&&this.updateLines(e.width,e.height,!1)):console.warn("Viewer not initialized"),this.renderer!==0[0]&&(this.renderer.loaded&&this.renderer.clear(),this.renderer.source=e)}set imageServiceUrl(e){this.download&&this.downloadLink.classList.remove("disabled"),this._imageAPI=e,this.cuts.url=e}get imageServiceUrl(){return this._imageAPI}set initialUrls(e){this._initialUrls=e}get url(){return this._url}get urlInput(){return this._urlInput}initCuts(){this.cuts=new Hl([e.Right,e.Bottom,e.Top,e.Left],this.fabricOverlay),this.cuts.setVisibility(!1)}dropHandler(e){if(this.dragOffHandler(),e.dataTransfer===null)return;const t=e.dataTransfer.files;if(t.length>0){const e=t[0];if(e.type==="application/json"){const t=new FileReader;t.addEventListener("load",async e=>{if(e!==0[0]&&e.target!==null&&e.target.result!==null)try{const o=e.target.result;let t;const n=JSON.parse(o);let s;"type"in n?(t=new URL(n.target.source),this.form.urlInput=t,s=()=>{this.cuts.loadJSONLD(n),this.updateControls()}):(t=new URL(n.url),this.form.urlInput=t,s=()=>{this.cuts.loadJSON(n),this.updateControls()}),await this.loadImageAPI(t),this.viewer?.addOnceHandler("tile-loaded",s.bind(this)),this.cuts.setVisibility(!0)}catch(e){console.error(e),this.form.displayMessage(g.t("cuttingTable:uploadError")+"+ "+e.message)}}),t.readAsText(e)}else{const e="File is not a JSON";throw this.form.displayMessage(g.t("cuttingTable:uploadError")+": "+e),new Error(e)}}}dragOnHandler(){this.dropZoneElement.classList.add("dropzone")}dragOffHandler(){this.dropZoneElement.classList.remove("dropzone")}updateCutLineWidth(){if(this.cuts!==0[0]&&this.viewer!==0[0]){const e=Math.ceil(5/this.viewer.viewport.getZoom()),t=Object.keys(this.cuts.shapes);t.forEach(t=>{this.cuts.setLineWidth(t,e)})}}updateControls(){if(this.updateCutLineWidth(),this.cuts!==0[0]){this.cutX.max=this.cuts.width,this.cutY.max=this.cuts.height,this.offsetX.min=String(Math.ceil(0-this.cuts.width/2)),this.offsetX.max=String(Math.floor(this.cuts.width/2)),this.offsetY.min=String(Math.ceil(0-this.cuts.height/2)),this.offsetY.max=String(Math.floor(this.cuts.height/2));const t=Object.keys(this.cuts.positions);t.forEach(t=>{t==e.Left&&this.cuts.positions[e.Left]!==0[0]&&(this.cutX.valueMin=this.cuts.positions[e.Left]),t==e.Right&&this.cuts.positions[e.Right]!==0[0]&&(this.cutX.valueMax=this.cuts.positions[e.Right]),t==e.Top&&this.cuts.positions[e.Top]!==0[0]&&(this.cutY.valueMin=this.cuts.positions[e.Top]),t==e.Bottom&&this.cuts.positions[e.Bottom]!==0[0]&&(this.cutY.valueMax=this.cuts.positions[e.Bottom])});const n=Object.keys(this.cuts.offsets);n.forEach(t=>{t==e.Left&&this.cuts.offsets[e.Left]!==0[0]&&(this.offsetX.value=String(this.cuts.offsets[e.Left]*-1)),t==e.Right&&this.cuts.offsets[e.Right]!==0[0]&&(this.offsetX.value=String(this.cuts.offsets[e.Right])),t==e.Top&&this.cuts.offsets[e.Right]!==0[0]&&(this.offsetY.value=String(this.cuts.offsets[e.Right]*-1)),t==e.Bottom&&this.cuts.offsets[e.Bottom]!==0[0]&&(this.offsetY.value=String(this.cuts.offsets[e.Bottom]))});const s=Object.keys(this.cuts.rotations);s.forEach(t=>{t==e.Right&&this.cuts.rotations[e.Right]!==0[0]&&(this.rotationX.value=this.cuts.rotations[e.Right]),t==e.Bottom&&this.cuts.rotations[e.Bottom]!==0[0]&&(this.rotationY.value=this.cuts.rotations[e.Bottom])})}}updateLines(e,t,n=!0){this.fabricOverlay.fabricCanvas().clear(),this.initCuts(),this.cuts.setSize(e,t),this.cuts.url===0[0]&&(this.cuts.url=this.imageServiceUrl),this.updateCutLineWidth(),this.cuts.setVisibility(n),this.renderer!==0[0]&&(this.cuts.callback=this.renderer.notify.bind(this.renderer)),this.cutX.setAttribute("max",String(e)),this.cutX.setAttribute("value-min","0"),this.cutX.setAttribute("value-max",String(e)),this.cutX.disabled=!1,this.rotationX.disabled=!1,this.rotationX.value=0,this.cutY.setAttribute("max",String(t)),this.cutY.setAttribute("value-min","0"),this.cutY.setAttribute("value-max",String(t)),this.cutY.disabled=!1,this._shifts&&(this.offsetY.min=String(Math.ceil(0-t/2)),this.offsetY.max=String(Math.floor(t/2)),this.offsetY.setAttribute("value","0"),this.offsetY.value="0",this.offsetY.disabled=!1,this.offsetX.min=String(Math.ceil(0-e/2)),this.offsetX.max=String(Math.floor(e/2)),this.offsetX.setAttribute("value","0"),this.offsetX.value="0",this.offsetX.disabled=!1),this.rotationY.disabled=!1,this.rotationY.value=0,this.rulerCheckbox.disabled=!1,this.rulerCheckbox.checked=!0,this.viewerElement.querySelector(".zoomin")?.classList.remove("disabled"),this.viewerElement.querySelector(".zoomout")?.classList.remove("disabled"),this.squareButton.dataset.height=String(t),this.squareButton.dataset.width=String(e),this.squareButton.classList.remove("disabled")}createJsonUploader(e){e.addEventListener("dragover",e=>{e.preventDefault(),this.dragOnHandler()}),e.addEventListener("dragenter",e=>{e.preventDefault(),this.dragOnHandler()}),e.addEventListener("dragleave",e=>{e.preventDefault(),this.dragOffHandler()}),e.addEventListener("dragend",e=>{e.preventDefault(),this.dragOffHandler()}),e.addEventListener("drop",e=>{e.preventDefault(),this.dropHandler(e)})}setupInterface(){let e="",t="";if(this._initialUrls!==0[0]&&this._initialUrls.length!=0){e="defaultURLs";const n=document.createElement("datalist");n.setAttribute("id",e),this._initialUrls.forEach(e=>{const t=document.createElement("option");t.value=e.url,t.text=e.label,n.appendChild(t)}),t=n.outerHTML}let n="",s="";this.url!==0[0]&&(n=this.url.toString()),this._urlInput&&(s=`<input class="url-input" type="url" value="${n}" name="url" id="collection-url" pattern="https://.*" list="${e}" required />
          ${t}
          <button type="button" class="load-url-button">${g.t("cuttingTable:loadUrl")}</button>`),this.container.innerHTML=`
      <div class="input-area">
        <div class="source-select">
          ${s}
          <div class="select-container"></div>
          <div class="status-container"></div>
        </div>
        <div class="cutting-table">
          <div class="${_CuttingTable.viewerElementClass}">
            <i class="controls button zoomin"></i><i class="controls button zoomout"></i>
            <i class="controls button square"></i>
          </div>
          <dual-range-slider min="0" max="1" value-min="0" value-max="1" class="control slider vertical cut-y"></dual-range-slider>
          <input type="range" min="1" max="100" value="50" class="control slider vertical offset offset-y" />
          <rotating-input step="90" display-degrees="false" radius="25" class="control rotation vertical rotation-y"></rotating-input>
          <dual-range-slider min="0" max="1" value-min="0" value-max="1" class="control slider horizontal cut-x"></dual-range-slider>
          <input type="range" min="1" max="100" value="50" class="control slider horizontal offset offset-x" />
          <rotating-input step="90" display-degrees="false" radius="25" class="control rotation horizontal rotation-x"></rotating-input>
          <input type="checkbox" class="control box rulers" checked />
        </div>
      </div>
      <div class="${_CuttingTable.rendererElementClass} output-area">
      </div>
    `}async setupControls(){this.cutX=this.container.querySelector(_CuttingTable.controlSelectors.cut.x),this.cutY=this.container.querySelector(_CuttingTable.controlSelectors.cut.y),this.cutX?.addEventListener("input",t=>{if(t.detail!==0[0]){const n=Number(t.detail.min),s=Number(t.detail.max);this.cuts.update(e.Left,n),this.cuts.update(e.Right,s)}}),this.cutY?.addEventListener("input",t=>{if(t.detail!==0[0]){const n=Number(t.detail.min),s=Number(t.detail.max);this.cuts.update(e.Top,n),this.cuts.update(e.Bottom,s)}}),this.offsetX=this.container.querySelector(_CuttingTable.controlSelectors.offset.x),this.offsetY=this.container.querySelector(_CuttingTable.controlSelectors.offset.y),this.offsetX?.addEventListener("input",e=>{const t=Number(e.target.value);this.cuts.offsetX=t}),this.offsetY?.addEventListener("input",e=>{const t=Number(e.target.value);this.cuts.offsetY=t}),this.rotationX=this.container.querySelector(_CuttingTable.controlSelectors.rotation.x),this.rotationY=this.container.querySelector(_CuttingTable.controlSelectors.rotation.y),this.rotationX?.addEventListener("degreeChange",e=>{this.cuts.rotateX=e.detail.degree}),this.rotationY?.addEventListener("degreeChange",e=>{this.cuts.rotateY=e.detail.degree}),this.rulerCheckbox=this.container.querySelector(_CuttingTable.rulerElementSelector),this.rulerCheckbox.title=g.t("cuttingTable:toggleRuler"),this.rulerCheckbox?.addEventListener("change",e=>{const t=Boolean(e.target.checked);this.cuts.setVisibility(t)}),this.viewerElement.querySelector(".zoomin")?.classList.add("disabled"),this.viewerElement.querySelector(".zoomout")?.classList.add("disabled"),this.squareButton=this.viewerElement.querySelector(_CuttingTable.squareButtonSelector),this.squareButton.addEventListener("click",()=>{this.square()}),this.squareButton.classList.add("disabled"),this.dropZoneElement=this.container.querySelector(`.${_CuttingTable.dropZoneElementClass}`),this.createJsonUploader(this.dropZoneElement),this.cuts===0[0]&&(this.cutX.disabled=!0,this.cutY.disabled=!0,this.offsetX.disabled=!0,this.offsetY.disabled=!0,this.rotationX.disabled=!0,this.rotationY.disabled=!0,this.rulerCheckbox.disabled=!0)}static patchOpenSeadragon(){_.default.TiledImage.prototype._getRotationPoint=function(e){let t=this.getBoundsNoRotate(e);const s=e?this._worldWidthCurrent:this._worldWidthTarget,n=s/this.source.dimensions.x;if(this._rotationPoint!==0[0]){const e=this._rotationPoint.times(n);return new _.default.Point(t.x+e.x,t.y+e.y)}if(this._clip){const e=this._clip.times(n);t=new _.default.Rect(t.x+e.x,t.y+e.y,e.width,e.height)}return t.getCenter()},_.default.TiledImage.prototype.setRotationPoint=function(e){this._rotationPoint=e},_.default.TiledImage.prototype.getPosition=function(e){const t=this.getBounds(e);return new _.default.Point(t.x,t.y)},Object.defineProperty(_.default.TiledImage.prototype,"clip",{get(){return this._clip},set(e){this._clip=e}}),_.default.TileSource.prototype.getTileAtPoint=function(e,t){const n=this.dimensions.x*this.getLevelScale(e),i=t.x*n,a=t.y*n;let s=Math.floor(i/this.getTileWidth(e)),o=Math.floor(a/this.getTileHeight(e));t.x>=1&&(s=this.getNumTiles(e).x-1);const r=1e-15;return t.y>=1/this.aspectRatio-r&&(o=this.getNumTiles(e).y-1),new _.default.Point(s,o)},_.default.Viewport.prototype._setContentBounds=function(e,t){if(isNaN(e.x)||isNaN(e.y)||isNaN(e.width)||isNaN(e.width))return;console.assert(e,"[Viewport._setContentBounds] bounds is required"),console.assert(e instanceof _.default.Rect,"[Viewport._setContentBounds] bounds must be an OpenSeadragon.Rect"),console.assert(e.width>0,"[Viewport._setContentBounds] bounds.width must be greater than 0"),console.assert(e.height>0,"[Viewport._setContentBounds] bounds.height must be greater than 0"),this._contentBoundsNoRotate=e.clone(),this._contentSizeNoRotate=this._contentBoundsNoRotate.getSize().times(t),this._contentBounds=e.rotate(this.getRotation()).getBoundingBox(),this._contentSize=this._contentBounds.getSize().times(t),this._contentAspectRatio=this._contentSize.x/this._contentSize.y,this.viewer&&this.viewer.raiseEvent("reset-size",{contentSize:this._contentSizeNoRotate.clone(),contentFactor:t,homeBounds:this._contentBoundsNoRotate.clone(),contentBounds:this._contentBounds.clone()})}}},(()=>{H.patchOpenSeadragon()})(),H.defaultId="generator",H.selectContainerClass="select-container",H.statusContainerClass="status-container",H.viewerElementClass="cutting-table-viewer",H.dropZoneElementClass="input-area",H.rendererElementClass="texture-container",H.shiftClass="shifts",H.rulerElementSelector=".box.rulers",H.squareButtonSelector=".square",H.controlSelectors={cut:{x:".cut-x",y:".cut-y"},offset:{x:".offset-x",y:".offset-y"},rotation:{x:".rotation-x",y:".rotation-y"}};function _2(e,t,n,s,o,i,a){let r;if(typeof i=="object")r=i;else try{r=JSON.parse(i)}catch{try{r=new URL(i)}catch{r=new URL(window.location).origin+i}}return new H(e,t,n,s,o,r,a)}window.lucienne=_2})()